<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OPS MANAGER</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;font-family:'DM Sans',sans-serif;font-size:13.5px;background:#f9ecec;color:#1C2333}
:root{
  --bg:#f9ecec;--w:#faf9f5;--s1:#f5f4ef;--s2:#ede9e0;
  --b1:#DDE1EA;--b2:#C4CAD6;
  --t1:#1C2333;--t2:#3D4560;--t3:#7A849E;--t4:#B0B8CC;
  --blue:#0073EA;--blt:#EBF4FF;
  --green:#00C875;--glt:#E6FFF5;
  --red:#E44258;--rlt:#FFECEF;
  --amber:#FF9F00;--alt:#FFF5E0;
  --purple:#A25DDC;--plt:#F5EEFF;
  --r:6px;
  --sh:0 1px 4px rgba(0,0,0,.08);
  --shm:0 4px 14px rgba(0,0,0,.11);
}

/* LAYOUT */
/* ══════════════════════════════════════════════════════════════════
   SIDEBAR — Premium dark rail, Option A
   ══════════════════════════════════════════════════════════════════ */
/* ══════════════════════════════════════════════════════════════════
   SIDEBAR v2 — Always expanded, bold, high-contrast
   ══════════════════════════════════════════════════════════════════ */
.sidebar{
  position:fixed;top:0;left:0;bottom:0;width:220px;
  background:#111827;
  display:flex;flex-direction:column;
  z-index:200;
  border-right:1px solid rgba(255,255,255,.06);
}

/* Logo */
.sb-logo{
  height:68px;display:flex;align-items:center;
  padding:0 18px;gap:12px;flex-shrink:0;
  border-bottom:1px solid rgba(255,255,255,.06);
}
.sb-icon{
  width:36px;height:36px;flex-shrink:0;
  background:#0073EA;
  border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:13px;color:#fff;
  letter-spacing:-.5px;
  flex-shrink:0;
}
.sb-wordmark{white-space:nowrap}
.sb-name{
  font-weight:700;font-size:14px;color:#fff;
  letter-spacing:-.1px;line-height:1.1;
}
.sb-tag{
  font-size:10px;color:rgba(255,255,255,.35);
  margin-top:3px;letter-spacing:.3px;
}

/* Nav */
.sb-nav{
  flex:1;padding:16px 10px 8px;
  overflow-y:auto;overflow-x:hidden;
  display:flex;flex-direction:column;gap:2px;
}
.sb-nav::-webkit-scrollbar{width:4px}
.sb-nav::-webkit-scrollbar-track{background:transparent}
.sb-nav::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}

.sb-group-lbl{
  font-size:10px;font-weight:700;letter-spacing:.8px;
  text-transform:uppercase;color:rgba(255,255,255,.28);
  padding:0 10px;margin-top:18px;margin-bottom:4px;
  white-space:nowrap;
}
.sb-group-lbl:first-child{margin-top:0}
.sb-sep{display:none}

/* Nav buttons */
.nb{
  position:relative;
  display:flex;align-items:center;gap:10px;
  padding:0 10px;height:40px;border-radius:8px;
  color:rgba(255,255,255,.5);
  cursor:pointer;font-size:13.5px;font-weight:500;
  border:none;background:none;width:100%;
  font-family:'DM Sans',sans-serif;
  transition:background .12s, color .12s;
  white-space:nowrap;
  text-align:left;
}
.nb:hover{
  background:rgba(255,255,255,.07);
  color:rgba(255,255,255,.9);
}
.nb.on{
  background:#0073EA;
  color:#fff;
  font-weight:600;
}
.nb.on svg{opacity:1}
.nb-ico{
  width:20px;min-width:20px;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;
}
.nb svg{opacity:.55;transition:opacity .12s}
.nb:hover svg{opacity:.9}
.sb-label{
  flex:1;font-size:13.5px;
  overflow:hidden;text-overflow:ellipsis;
}

/* Badges */
.nb-badge{
  min-width:18px;height:18px;padding:0 5px;
  background:rgba(255,255,255,.18);
  color:#fff;font-size:9.5px;font-weight:700;
  border-radius:9px;
  display:flex;align-items:center;justify-content:center;
  margin-left:auto;flex-shrink:0;
}
.nb.on .nb-badge{background:rgba(255,255,255,.25)}
.nb-badge.hidden{display:none}
.nb-tip{display:none}

/* Logout button */
.sb-logout{
  display:flex;align-items:center;gap:10px;
  padding:0 10px;height:40px;border-radius:8px;
  color:rgba(255,255,255,.4);
  cursor:pointer;font-size:13.5px;font-weight:500;
  border:none;background:none;width:100%;
  font-family:'DM Sans',sans-serif;
  transition:background .12s, color .12s;
  text-align:left;
  margin-top:4px;
}
.sb-logout:hover{
  background:rgba(228,66,88,.12);
  color:#ff6b7a;
}
.sb-logout svg{opacity:.5;flex-shrink:0;transition:opacity .12s}
.sb-logout:hover svg{opacity:1}

/* User footer */
.sb-foot{
  padding:10px;
  border-top:1px solid rgba(255,255,255,.06);
  flex-shrink:0;
}
.sb-user{
  display:flex;align-items:center;gap:10px;
  padding:8px 10px;border-radius:8px;
  transition:background .12s;
}
.sb-user:hover{background:rgba(255,255,255,.05)}
.sb-av{flex-shrink:0}
.sb-av-inner{
  width:32px;height:32px;border-radius:50%;
  background:linear-gradient(135deg,#0073EA,#00C875);
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;color:#fff;
}
.sb-user-info{overflow:hidden;min-width:0}
.sb-uname{
  font-size:13px;font-weight:600;color:#fff;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  line-height:1.2;
}
.sb-urole{
  font-size:10.5px;color:rgba(255,255,255,.35);
  margin-top:2px;white-space:nowrap;
}

/* ══════════════════════════════════════════════════════════════════
   MAIN LAYOUT — account for wider sidebar
   ══════════════════════════════════════════════════════════════════ */
.main{
  margin-left:220px;height:100vh;
  display:flex;flex-direction:column;
  overflow:hidden;
}
.content{flex:1;overflow:hidden;display:flex;flex-direction:column}
.page{display:none;flex:1;overflow:hidden;flex-direction:column}
.page.on{display:flex}
.topbar{
  height:54px;background:var(--w);
  border-bottom:1px solid var(--b1);
  display:flex;align-items:center;
  padding:0 20px;gap:10px;flex-shrink:0;
}
.tb-title{
  font-weight:700;font-size:15px;color:var(--t1);
  letter-spacing:-.2px;flex-shrink:0;
}

/* Topbar greeting */
.tb-greeting{
  font-size:13px;font-weight:500;color:var(--t3);
  white-space:nowrap;flex-shrink:0;
  padding:0 4px;
}
.tb-greeting strong{color:var(--t1);font-weight:700}

/* ══════════════════════════════════════════════════════════════════
   MOBILE — bottom tab bar
   ══════════════════════════════════════════════════════════════════ */
@media (max-width: 768px) {
  .sidebar{display:none!important}
  .main{margin-left:0!important;padding-bottom:64px}
  .topbar{height:52px;padding:0 14px}
  .tb-greeting{display:none}
  .content{overflow-y:auto;overflow-x:hidden}
  .page.on{overflow-y:auto}
  .vtabs{overflow-x:auto;flex-shrink:0;-webkit-overflow-scrolling:touch}
  .vtabs::-webkit-scrollbar{display:none}
  .cnav, .divider{display:none}
  .topbar .btn{font-size:12px;padding:5px 10px}
  #search-wrap{max-width:100%!important;flex:1}
  .kpi-grid{grid-template-columns:1fr 1fr!important;gap:10px!important}
  .kpi-card{padding:12px 14px!important}
  .kpi-val{font-size:22px!important}
  .fin-stats{grid-template-columns:1fr 1fr!important;gap:10px!important}
  .panel{width:100%!important;border-radius:0!important;border-left:none!important}
  .modal-box,.cfg-modal-box{width:100%!important;max-width:100%!important;margin:0!important;border-radius:16px 16px 0 0!important;position:fixed!important;bottom:0!important;max-height:90vh!important}
  .modal-backdrop,.cfg-backdrop{align-items:flex-end!important}
  .vt[onclick*="twoweek"]{display:none!important}
  .stabs{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .stabs::-webkit-scrollbar{display:none}
  .sc-table,table{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}
  .bk-layout{flex-direction:column!important}
  .bk-sidebar{width:100%!important;max-width:100%!important;border-right:none!important;border-bottom:1px solid var(--b1)!important;max-height:40vh!important}
}
/* Mobile bottom nav */
.mobile-nav{
  display:flex;position:fixed;bottom:0;left:0;right:0;
  height:64px;background:#111827;
  border-top:1px solid rgba(255,255,255,.08);
  z-index:300;padding:0 4px;
  padding-bottom:env(safe-area-inset-bottom);
}
@media (min-width:769px){.mobile-nav{display:none!important}}
.mn-btn{
  flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:4px;
  color:rgba(255,255,255,.35);
  background:none;border:none;cursor:pointer;
  font-family:'DM Sans',sans-serif;
  font-size:10px;font-weight:500;
  border-radius:10px;margin:6px 2px;
  transition:color .15s;position:relative;
}
.mn-btn.on{color:#fff}
.mn-btn.on svg{opacity:1}
.mn-btn.on::before{
  content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);
  width:28px;height:3px;background:#0073EA;border-radius:0 0 3px 3px;
}
.mn-btn svg{opacity:.4;transition:opacity .15s}
.mn-btn span{line-height:1}
.mn-badge{
  position:absolute;top:5px;right:calc(50% - 20px);
  min-width:16px;height:16px;padding:0 4px;
  background:#0073EA;color:#fff;
  font-size:8px;font-weight:700;border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  border:2px solid #111827;
}
.mn-badge.hidden{display:none}


/* TOPBAR */
.tb-title{font-weight:700;font-size:16px;letter-spacing:-.3px;white-space:nowrap}
.divider{width:1px;height:20px;background:var(--b1);flex-shrink:0}
.vtabs{display:flex;gap:1px;background:var(--s2);border:1px solid var(--b1);border-radius:5px;padding:2px}
.vt{padding:4px 10px;border-radius:3px;cursor:pointer;font-size:12px;font-weight:700;color:var(--t3);border:none;background:none;font-family:'DM Sans',sans-serif;white-space:nowrap;transition:all .1s}
.vt:hover{color:var(--t2)}
.vt.on{background:var(--w);color:var(--blue);box-shadow:var(--sh)}
.cnav{display:flex;align-items:center;gap:5px}
.cn-btn{width:26px;height:26px;border-radius:5px;border:1px solid var(--b1);background:var(--w);color:var(--t2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .1s}
.cn-btn:hover{border-color:var(--blue);color:var(--blue)}
.cn-lbl{font-weight:600;font-size:13px;min-width:160px;text-align:center;letter-spacing:-.2px;border-radius:5px;padding:3px 8px;transition:background .1s}.cn-lbl:hover{background:var(--s2)}
.today-btn{padding:4px 10px;border-radius:5px;border:1px solid var(--b1);background:var(--w);color:var(--t2);cursor:pointer;font-size:12px;font-weight:700;font-family:'DM Sans',sans-serif;transition:all .1s}
.today-btn:hover{border-color:var(--blue);color:var(--blue)}
.tb-r{margin-left:auto;display:flex;align-items:center;gap:6px}
.btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:5px;font-family:'DM Sans',sans-serif;font-size:12.5px;font-weight:700;cursor:pointer;border:1px solid transparent;transition:all .1s;white-space:nowrap}
.btn-p{background:var(--blue);color:#fff;border-color:var(--blue)}
.btn-p:hover{background:#005cc0}
.btn-s{background:var(--w);color:var(--t2);border-color:var(--b1)}
.btn-s:hover{border-color:var(--b2);color:var(--t1)}
.btn-g{background:transparent;color:var(--t3);border:none;padding:5px 7px}
.btn-g:hover{background:var(--s2);color:var(--t1)}
.btn-sm{padding:4px 9px;font-size:12px}
.btn-del{background:var(--rlt);color:var(--red);border-color:#FFCCD3}
.btn-del:hover{background:var(--red);color:#fff}

/* ── CALENDAR — Vertical date-grouped job list ──────────────────────── */
.cal-outer{flex:1;overflow-y:auto;overflow-x:hidden}

/* Date section header — sticky within scroll */
.cal-date-hdr{
  position:sticky;top:0;z-index:10;
  display:flex;align-items:center;gap:12px;
  padding:7px 18px;
  background:var(--blue);
  border-bottom:2px solid rgba(0,0,0,.12);
  border-top:1px solid rgba(0,0,0,.08);
  cursor:pointer;
  transition:background .1s;
  user-select:none;
}
.cal-date-hdr:first-child{border-top:none}
.cal-date-hdr:hover{background:#005ec0}
.cal-date-hdr.today{background:#0055b3;border-left:4px solid #fff}
.cal-date-hdr.today .cdh-num{color:#fff}
.cal-date-hdr.empty{opacity:.55}
.cdh-dow{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:rgba(255,255,255,.75);width:24px}
.cdh-num{font-size:22px;font-weight:800;color:#fff;line-height:1;letter-spacing:-1px;min-width:28px}
.cdh-mon{font-size:12px;font-weight:600;color:rgba(255,255,255,.8);min-width:28px}
.cdh-jobs{font-size:11px;font-weight:600;color:rgba(255,255,255,.75);margin-left:4px}
.cdh-today-pill{background:#fff;color:var(--blue);font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;letter-spacing:.3px}
.cdh-rev{font-size:11px;font-weight:700;color:#fff;margin-left:auto;opacity:.9}
.cdh-add{font-size:11px;font-weight:600;color:rgba(255,255,255,.8);margin-left:8px;padding:2px 7px;border:1px solid rgba(255,255,255,.4);border-radius:4px;background:rgba(255,255,255,.15)}
.cdh-add:hover{color:#fff;border-color:#fff;background:rgba(255,255,255,.25)}

/* Journey group banner */
.jrn-banner{
  margin:0 14px 0;
  background:linear-gradient(90deg,#F0E8FF,var(--s1) 80%);
  border-left:3px solid var(--purple);
  border-radius:0;
  padding:5px 12px;
  display:flex;align-items:center;gap:8px;
  font-size:10.5px;
}
.jrn-banner-lbl{font-weight:700;color:var(--purple)}
.jrn-banner-ref{color:var(--t3)}
.jrn-banner-night{color:#E07B00;font-weight:600}

/* ── JOB CARD — full-width, icon-labelled, breathing room ─────────── */
.jcard{
  margin:5px 14px;
  background:#fff;
  border:1px solid var(--b1);
  border-radius:8px;
  border-left:5px solid var(--b1);
  cursor:pointer;
  transition:box-shadow .15s, transform .1s;
  box-shadow:0 1px 4px rgba(0,0,0,.06);
  overflow:hidden;
  position:relative;
}
.jcard:hover{box-shadow:0 4px 14px rgba(0,0,0,.11);transform:translateY(-1px)}
.jcard.in-journey{border-left-color:var(--purple) !important;background:linear-gradient(90deg,#FDFAFF 0px,#fff 80px)}

/* Card header */
.jcard-head{display:flex;align-items:stretch;border-bottom:1px solid var(--b1);min-height:60px}
/* Brand zone: fixed width, hard right border, white bg */
.jcard-logo{
  flex-shrink:0;width:80px;min-width:80px;
  display:flex;align-items:center;justify-content:center;
  border-right:2px solid var(--b1);
  background:#fff;padding:8px 10px;
}
/* Client + ref zone */
.jcard-title{
  flex:1;min-width:0;
  padding:10px 14px;
  display:flex;flex-direction:column;justify-content:center;gap:5px;
}
.jcard-client{
  font-weight:800;font-size:17px;letter-spacing:-.4px;line-height:1.1;
  color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.jcard-ref{
  font-size:12px;font-weight:700;letter-spacing:.3px;
  font-family:monospace;color:var(--t3);
}
/* Icon badge strip — top-right corner of header */
.jcard-flags{
  flex-shrink:0;display:flex;flex-direction:column;
  align-items:flex-end;justify-content:center;
  gap:5px;padding:8px 10px;border-left:1px solid var(--b1);
  min-width:110px;background:#fff;
}
.jcard-flag-row{display:flex;gap:4px;flex-wrap:wrap;justify-content:flex-end}
/* Individual flag pill */
.jflag{
  display:inline-flex;align-items:center;gap:3px;
  padding:3px 8px;border-radius:12px;
  font-size:10.5px;font-weight:700;white-space:nowrap;border:1px solid;
}
.jflag-journey{background:#F0E8FF;color:var(--purple);border-color:#C9AAFF}
.jflag-seq{background:var(--purple);color:#fff;border-color:var(--purple);font-size:11px;letter-spacing:.5px}
.jflag-multiday{background:#FFF3DA;color:#9A5600;border-color:#FFD580}
.jflag-overnight{background:#FFF0E0;color:#C05000;border-color:#FFBA70}
.jflag-storage{background:#E6F9F0;color:#007048;border-color:#7DD9B0}
/* Status + edit — right edge */
.jcard-actions{
  flex-shrink:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  gap:6px;padding:8px 10px;
  border-left:1px solid var(--b1);
}

/* Card body: info grid */
.jcard-body{
  display:grid;
  grid-template-columns:1fr 1fr 1fr auto;
  gap:0;
}
/* Info cell — each piece of info in its own block */
.jci{
  padding:9px 14px;
  border-right:1px solid var(--b1);
  display:flex;flex-direction:column;gap:3px;
  min-width:0;
}
.jci:last-child{border-right:none}
.jci-lbl{
  font-size:8.5px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;
  color:var(--t4);display:flex;align-items:center;gap:4px
}
.jci-lbl svg,.jci-lbl span.ico{flex-shrink:0;opacity:.7}
.jci-val{font-size:12.5px;font-weight:600;color:var(--t2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.jci-val.big{font-size:15px;font-weight:800;color:var(--t1);letter-spacing:-.3px}
.jci-val.mono{font-family:monospace;font-size:12px}
.jci-val.route{font-size:11.5px;white-space:normal;line-height:1.4}
.jci-val.green{color:#007048;font-weight:700}
.jci-val.blue{color:var(--blue);font-weight:700}

/* Crew cell spans full width underneath on its own row */
.jcard-foot{
  padding:7px 14px;
  border-top:1px solid var(--b1);
  display:flex;align-items:center;gap:8px;
  background:#fff;
  flex-wrap:wrap;
}
.jcard-foot-lbl{font-size:8.5px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t4)}

/* Tags */
.jctag{display:inline-flex;align-items:center;gap:3px;font-size:9.5px;font-weight:600;padding:2px 7px;border-radius:4px;background:var(--s2);color:var(--t2);border:1px solid var(--b1);white-space:nowrap}
.jctag.green{background:var(--glt);color:#007048;border-color:#B3EDD8}
.jctag.amber{background:var(--alt);color:#9A5600;border-color:#FFD88A}
.jctag.purple{background:var(--plt);color:var(--purple);border-color:#D4AEFF}
.jctag.blue{background:var(--blt);color:var(--blue);border-color:#A8CFFF}

/* No jobs empty state */
.cal-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:var(--t3);text-align:center}
/* End of period */
.cal-period-end{text-align:center;padding:20px;color:var(--t3);font-size:12px;border-top:1px solid var(--b1);margin-top:4px}


/* MONTH VIEW */
.mv-wrap{flex:1;display:grid;grid-template-columns:repeat(7,1fr);grid-template-rows:30px repeat(6,1fr);overflow-y:auto}
.mv-head{background:var(--s1);border-bottom:2px solid var(--b1);border-right:1px solid var(--b1);display:flex;align-items:center;justify-content:center;font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);position:sticky;top:0;z-index:5}
.mv-cell{border-bottom:1px solid var(--b1);border-right:1px solid var(--b1);padding:5px;min-height:90px;cursor:pointer;transition:background .1s;background:var(--w);overflow:hidden}
.mv-cell:hover{background:var(--s1)}
.mv-other{background:var(--s2);opacity:.5}
.mv-today .mv-date{background:var(--blue);color:#fff;border-radius:50%}
.mv-date{width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:12px;color:var(--t2);margin-bottom:3px}
.mv-pill{padding:2px 5px;border-radius:3px;font-size:9.5px;font-weight:700;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer}
.mv-more{font-size:9.5px;color:var(--t3);font-weight:600;cursor:pointer}
.mv-more:hover{color:var(--blue)}

/* LIST VIEW */
.lv-wrap{flex:1;overflow-y:auto}
.lv-mhead{padding:10px 20px 5px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);background:var(--bg);border-bottom:1px solid var(--b1);position:sticky;top:0;z-index:5}
.lv-row{display:flex;align-items:stretch;border-bottom:1px solid var(--b1);cursor:pointer;background:var(--w);transition:background .1s}
.lv-row:hover{background:var(--s1)}
.lv-date{width:80px;flex-shrink:0;padding:10px 12px;border-right:1px solid var(--b1)}
.lv-bar{width:4px;flex-shrink:0}
.lv-body{flex:1;padding:9px 13px;min-width:0}
.lv-crew{width:140px;flex-shrink:0;padding:9px 12px;border-left:1px solid var(--b1);display:flex;flex-wrap:wrap;gap:3px;align-content:flex-start}
.lv-status{width:105px;flex-shrink:0;padding:9px 13px;border-left:1px solid var(--b1);display:flex;align-items:center}
.lv-bill{width:90px;flex-shrink:0;padding:9px 13px;border-left:1px solid var(--b1);text-align:right;font-weight:600;font-size:13px;color:var(--blue);display:flex;align-items:center;justify-content:flex-end}

/* CREW VIEW */
.crew-outer{flex:1;overflow:auto}
.crew-table{border-collapse:collapse;min-width:100%;background:var(--w)}
.crew-table th{padding:8px 12px;background:var(--s1);border-bottom:2px solid var(--b1);border-right:1px solid var(--b1);font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);white-space:nowrap;position:sticky;top:0;z-index:10}
.crew-table td{border-bottom:1px solid var(--b1);border-right:1px solid var(--b1);vertical-align:top}
.crew-nm-td{width:155px;min-width:155px;padding:9px 12px}
.crew-av{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;flex-shrink:0}
.crew-day-td{min-width:105px;width:105px;padding:5px;min-height:52px}
.cassign{border-radius:4px;padding:3px 6px;font-size:10.5px;font-weight:700;margin-bottom:2px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:filter .1s}
.cassign:hover{filter:brightness(.92)}
.c-hol{background:#FFECEF;color:var(--red);border:1px dashed #FFCCD3;border-radius:4px;padding:3px 6px;font-size:10px;font-weight:600;font-style:italic}
.c-off{color:var(--t4);font-size:10.5px;text-align:center;padding:7px 0;display:block;width:100%}
.ubar{height:3px;background:var(--s2);border-radius:2px;margin-top:4px;overflow:hidden}
.ufill{height:100%;border-radius:2px}

/* FINANCE VIEW */
.fin-outer{flex:1;overflow-y:auto;padding:18px 22px}
.fin-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
.fstat{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);padding:14px 16px;box-shadow:var(--sh);border-top:3px solid var(--b2)}
.fstat.c-b{border-top-color:var(--blue)}
.fstat.c-g{border-top-color:var(--green)}
.fstat.c-a{border-top-color:var(--amber)}
.fstat.c-p{border-top-color:var(--purple)}
.fstat-l{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);margin-bottom:4px}
.fstat-v{font-weight:700;font-size:24px;letter-spacing:-.4px}
.fstat-s{font-size:10.5px;color:var(--t3);margin-top:2px}
.fin-2col{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
.fc{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);box-shadow:var(--sh)}
.fc-head{padding:11px 15px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between}
.fc-title{font-weight:700;font-size:13.5px;letter-spacing:-.2px}
.fc-body{padding:13px 15px}
.fin-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--b1);font-size:12.5px}
.fin-row:last-child{border-bottom:none}
.fin-lbl{color:var(--t2)}
.fin-val{font-weight:700;font-size:12px}
.brr{display:flex;align-items:center;gap:9px;padding:6px 0;border-bottom:1px solid var(--b1)}
.brr:last-child{border-bottom:none}
.brr-nm{width:80px;flex-shrink:0}
.brr-bar{flex:1;height:6px;background:var(--s2);border-radius:3px;overflow:hidden}
.brr-fill{height:100%;border-radius:3px;transition:width .5s}
.brr-val{width:80px;text-align:right;font-weight:600;font-size:12px;flex-shrink:0}
.brr-pct{width:32px;text-align:right;font-size:10px;color:var(--t3);flex-shrink:0}
.ctable{width:100%;border-collapse:collapse}
.ctable th{padding:7px 12px;font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);background:var(--s1);border-bottom:2px solid var(--b1);text-align:left}
.ctable td{padding:8px 12px;border-bottom:1px solid var(--b1);font-size:12.5px;vertical-align:middle}
.ctable tfoot td{background:var(--s2);font-weight:700;font-size:13px;padding:9px 12px;border-top:2px solid var(--b1)}
.ctable tbody tr{cursor:pointer;transition:background .1s}
.ctable tbody tr:hover td{background:var(--s1)}

/* GLOBAL SENSITIVE VALUE PROTECTION */
/* All £ values wrapped in .spv are hidden until eye toggle is active */
.spv{transition:filter .2s,opacity .2s;display:inline}
body:not(.vals-visible) .spv{filter:blur(6px);opacity:.25;pointer-events:none;user-select:none}
body.vals-visible .spv{filter:none;opacity:1}

/* Eye button — sidebar footer, icon only */
.eye-btn{
  position:fixed;
  bottom:18px;left:18px;
  z-index:600;
  display:flex;align-items:center;justify-content:center;
  width:38px;height:38px;border-radius:8px;
  border:1px solid var(--b1);cursor:pointer;
  font-size:18px;background:var(--w);color:var(--t2);
  font-family:'DM Sans',sans-serif;transition:all .15s;
  box-shadow:0 2px 8px rgba(0,0,0,.12);
}
.eye-btn:hover{background:var(--blt);border-color:var(--blue)}
body.vals-visible .eye-btn{background:var(--blt);border-color:var(--blue);box-shadow:0 0 0 3px var(--blue)33,0 2px 8px rgba(0,0,0,.12)}

/* RATES VIEW (legacy, still used) */
.rates-outer{flex:1;overflow-y:auto;padding:18px 22px}

/* SETTINGS MODULE */
.settings-outer{flex:1;overflow:hidden;display:flex;flex-direction:column}
.settings-tabs{display:flex;gap:0;border-bottom:2px solid var(--b1);background:var(--w);flex-shrink:0;padding:0 20px}
.stab{padding:11px 18px;font-size:12.5px;font-weight:600;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s;border:none;background:none;font-family:'DM Sans',sans-serif}
.stab:hover{color:var(--t2)}
.stab.on{color:var(--blue);border-bottom-color:var(--blue);font-weight:700}
.settings-body{flex:1;overflow-y:auto;padding:20px 24px;background:var(--bg)}
.settings-card{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);box-shadow:var(--sh);margin-bottom:14px;overflow:hidden}
.sc-head{padding:12px 16px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;background:var(--s1)}
.sc-title{font-weight:700;font-size:13.5px;letter-spacing:-.2px}
.sc-sub{font-size:11px;color:var(--t3);margin-top:1px}
.sc-body{padding:14px 16px}
.sc-table{width:100%;border-collapse:collapse}
.sc-table th{padding:7px 10px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);background:var(--s1);border-bottom:2px solid var(--b1);text-align:left;white-space:nowrap}
.sc-table td{padding:8px 10px;border-bottom:1px solid var(--b1);font-size:12.5px;vertical-align:middle}
.sc-table tr:last-child td{border-bottom:none}
.sc-input{padding:5px 8px;border:1px solid var(--b1);border-radius:4px;font-family:'DM Sans',sans-serif;font-size:12.5px;color:var(--t1);background:var(--w);outline:none;transition:border-color .15s;width:100%}
.sc-input:focus{border-color:var(--blue);box-shadow:0 0 0 2px rgba(0,115,234,.1)}
.sc-input.narrow{width:90px;text-align:right}
.sc-input.mid{width:130px}
.veh-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:14px 16px}
.veh-card{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh)}
.veh-card-top{background:var(--s2);padding:10px 12px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between}
.veh-card-body{padding:10px 12px}
.veh-field{display:flex;flex-direction:column;gap:2px;margin-bottom:7px}
.veh-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)}
.add-row{display:flex;gap:8px;padding:10px 16px;border-top:1px solid var(--b1);background:var(--s1);flex-wrap:wrap;align-items:flex-end}

/* BOOKING RESOURCE SECTIONS */
.res-section{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);margin-bottom:10px;overflow:hidden}
.res-head{padding:9px 14px;border-bottom:1px solid var(--b1);background:var(--s1);display:flex;align-items:center;justify-content:space-between}
.res-title{font-weight:700;font-size:12.5px}
.res-body{padding:10px 14px}
.res-grid{display:grid;gap:8px}
.res-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--b1);border-radius:5px;background:var(--w);cursor:pointer;transition:all .1s;font-size:12.5px}
.res-item:hover{border-color:var(--blue);background:var(--blt)}
.res-item.sel{border-color:var(--blue);background:var(--blt)}
.res-item.sel .ri-check{background:var(--blue);border-color:var(--blue);color:#fff}
.ri-check{width:16px;height:16px;border-radius:3px;border:1.5px solid var(--b2);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;transition:all .1s}
.ri-name{flex:1;font-weight:500}
.ri-qty{width:55px;flex-shrink:0}
.ri-price{font-size:11px;color:var(--t3);flex-shrink:0;min-width:50px;text-align:right}
.cost-breakdown{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:12px 14px;margin-top:10px}
.cb-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:12.5px;border-bottom:1px solid var(--b1)}
.cb-row:last-child{border-bottom:none}
.cb-total{display:flex;justify-content:space-between;font-weight:700;font-size:13.5px;padding:9px 0 0;border-top:2px solid var(--t1);margin-top:4px}

/* BOOKING MODULE */
.bk-outer{flex:1;overflow-y:auto;background:var(--bg)}
.bk-split{display:grid;grid-template-columns:340px 1fr;height:100%;overflow:hidden}
.bk-left{border-right:1px solid var(--b1);display:flex;flex-direction:column;overflow:hidden;background:var(--w)}
.bk-right{display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}
.bk-left-head{padding:14px 16px;border-bottom:1px solid var(--b1);flex-shrink:0}
.bk-right-head{padding:14px 18px;border-bottom:1px solid var(--b1);background:var(--w);flex-shrink:0;display:flex;align-items:center;justify-content:space-between}
.bk-list{flex:1;overflow-y:auto}
.bk-item{padding:11px 16px;border-bottom:1px solid var(--b1);cursor:pointer;transition:background .1s;display:flex;align-items:flex-start;gap:10px}
.bk-item:hover{background:var(--s1)}
.bk-item.on{background:var(--blt);border-right:3px solid var(--blue)}
.bk-ref{font-size:10px;font-weight:700;letter-spacing:.4px;color:var(--t3);font-variant-numeric:tabular-nums}
.bk-client{font-size:13px;font-weight:600;color:var(--t1);margin-top:1px}
.bk-meta{font-size:11px;color:var(--t3);margin-top:2px}
.bk-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:4px}

/* BOOKING FORM */
.bf-wrap{flex:1;overflow-y:auto;padding:20px 24px}
.bf-section{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);margin-bottom:14px;overflow:hidden;box-shadow:var(--sh)}
.bf-sec-head{padding:11px 16px;border-bottom:1px solid var(--b1);display:flex;align-items:center;gap:8px;background:var(--s1)}
.bf-sec-num{width:20px;height:20px;border-radius:50%;background:var(--blue);color:#fff;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.bf-sec-title{font-weight:600;font-size:13px}
.bf-body{padding:14px 16px}
.bf-row{display:grid;gap:10px;margin-bottom:10px}
.bf-row.col2{grid-template-columns:1fr 1fr}
.bf-row.col3{grid-template-columns:1fr 1fr 1fr}
.bf-row.col1{grid-template-columns:1fr}
.bf-field{display:flex;flex-direction:column;gap:3px}
.bf-label{font-size:9.5px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)}
.bf-input{padding:7px 10px;border:1px solid var(--b1);border-radius:5px;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--t1);background:var(--w);outline:none;transition:border-color .15s,box-shadow .15s;width:100%}
.bf-input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,115,234,.1)}
.bf-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%237A849E' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}
.bf-textarea{min-height:70px;resize:vertical;line-height:1.6}

/* AI PARSE BOX */
.ai-parse-box{background:linear-gradient(135deg,#EBF4FF 0%,#F5EEFF 100%);border:1px solid #C4DAFF;border-radius:var(--r);padding:14px 16px;margin-bottom:14px}
.ai-parse-title{font-weight:700;font-size:13px;color:var(--t1);display:flex;align-items:center;gap:7px;margin-bottom:6px}
.ai-parse-sub{font-size:11.5px;color:var(--t2);margin-bottom:10px;line-height:1.5}
.ai-parse-ta{width:100%;min-height:90px;resize:vertical;padding:8px 11px;border:1px solid #C4DAFF;border-radius:5px;font-family:'DM Sans',sans-serif;font-size:12px;color:var(--t1);background:#faf9f5;outline:none;transition:border-color .15s}
.ai-parse-ta:focus{border-color:var(--blue);background:#faf9f5}
.ai-spin{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:5px}
@keyframes spin{to{transform:rotate(360deg)}}

/* REF BADGE */
.ref-badge{display:inline-flex;align-items:center;gap:6px;background:var(--t1);color:#fff;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:700;letter-spacing:.5px;font-variant-numeric:tabular-nums}

/* EMAIL PREVIEW */
.email-preview{background:#faf9f5;border:1px solid var(--b1);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh)}
.ep-bar{background:var(--s1);border-bottom:1px solid var(--b1);padding:10px 14px;display:flex;gap:8px;align-items:center}
.ep-dot{width:10px;height:10px;border-radius:50%}
.ep-header{padding:14px 18px;border-bottom:1px solid var(--b1)}
.ep-body{padding:18px;font-size:13px;line-height:1.8;color:var(--t2)}
.ep-field{display:flex;gap:10px;margin-bottom:4px;font-size:12.5px}
.ep-lbl{color:var(--t3);font-weight:600;width:80px;flex-shrink:0}
.ep-val{color:var(--t1);font-weight:500}
.ep-divider{border:none;border-top:1px solid var(--b1);margin:14px 0}

/* STATUS PILL for bookings */
.bst{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:3px;font-size:10.5px;font-weight:600}
.bst-confirmed{background:#E6FFF5;color:#007048}
.bst-sent{background:#EBF4FF;color:#0052B0}
.bst-pending{background:#FFF5E0;color:#9A5600}
.rate-in{width:80px;padding:5px 8px;border:1px solid var(--b1);border-radius:5px;font-family:'DM Sans',sans-serif;font-size:13.5px;font-weight:700;color:var(--t1);text-align:right;outline:none;transition:border-color .1s}
.rate-in:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,115,234,.1)}

/* ── JOB CONFIGURATOR PANEL ─────────────────────────────────────────── */
.cfg-backdrop{position:fixed;inset:0;background:rgba(15,20,35,.35);z-index:600;opacity:0;pointer-events:none;transition:opacity .25s}
.cfg-backdrop.on{opacity:1;pointer-events:all}
.cfg-panel{position:fixed;top:0;right:0;bottom:0;width:700px;background:#f0efe9;z-index:601;display:flex;flex-direction:column;transform:translateX(105%);transition:transform .28s cubic-bezier(.4,0,.2,1);box-shadow:-4px 0 32px rgba(0,0,0,.18)}
.cfg-panel.on{transform:translateX(0)}
.cfg-head{background:#faf9f5;border-bottom:1px solid #E3E7F0;padding:0 24px;display:flex;align-items:center;gap:0;flex-shrink:0;height:58px}
.cfg-head-title{font-size:15px;font-weight:700;color:#1A2035;flex:1;letter-spacing:-.3px}
.cfg-head-ref{font-size:11px;font-weight:700;letter-spacing:.5px;color:#fff;background:#1A2035;padding:3px 9px;border-radius:4px;margin-right:12px;font-variant-numeric:tabular-nums}
.cfg-close{width:32px;height:32px;border-radius:6px;border:1px solid #E3E7F0;background:#f0efe9;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;color:#7A849E;transition:all .12s}
.cfg-close:hover{background:#faf9f5;border-color:#0073EA;color:#0073EA}
.cfg-stages{background:#faf9f5;border-bottom:2px solid #E3E7F0;display:flex;flex-shrink:0;overflow-x:auto;padding:0 8px}
.cfg-stage{flex:1;padding:10px 4px 9px;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s;min-width:80px}
.cfg-stage:hover{background:#f0efe9}
.cfg-stage.done{border-bottom-color:#00C875}
.cfg-stage.active{border-bottom-color:#0073EA}
.cfg-stage-num{width:22px;height:22px;border-radius:50%;background:#E3E7F0;color:#7A849E;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
.cfg-stage.done .cfg-stage-num{background:#00C875;color:#fff}
.cfg-stage.active .cfg-stage-num{background:#0073EA;color:#fff}
.cfg-stage-lbl{font-size:9px;font-weight:700;color:#7A849E;text-align:center;letter-spacing:.3px;text-transform:uppercase;white-space:nowrap}
.cfg-stage.active .cfg-stage-lbl{color:#0073EA}
.cfg-stage.done .cfg-stage-lbl{color:#00C875}
.cfg-body{flex:1;overflow-y:auto;padding:20px 24px}
.cfg-foot{background:#faf9f5;border-top:1px solid #E3E7F0;padding:14px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.cs-card{background:#faf9f5;border:1px solid #E3E7F0;border-radius:10px;margin-bottom:14px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.cs-card-head{padding:11px 16px;border-bottom:1px solid #ede9e0;background:#f5f4ef;display:flex;align-items:center;gap:10px}
.cs-card-icon{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.cs-card-title{font-size:13px;font-weight:700;color:#1A2035;flex:1}
.cs-card-sub{font-size:11px;color:#7A849E}
.cs-body{padding:16px}
.ai-field-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.ai-field-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#7A849E;width:100px;flex-shrink:0}
.ai-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:4px;font-size:12px;font-weight:500;cursor:pointer;transition:all .12s;border:1px solid transparent;max-width:280px;word-break:break-word}
.ai-chip.confirmed{background:#E6FFF5;color:#007048;border-color:#B8EDD9}
.ai-chip.assumed{background:#FFF5E0;color:#9A5600;border-color:#FFE4A0;animation:pulse-amber 2s ease-in-out infinite}
.ai-chip.missing{background:#FFF0F0;color:#C0392B;border-color:#FFD0D0}
@keyframes pulse-amber{0%,100%{box-shadow:0 0 0 0 rgba(255,165,0,0)}50%{box-shadow:0 0 0 3px rgba(255,165,0,.2)}}
.ai-edit-input{padding:5px 9px;border:1.5px solid #0073EA;border-radius:5px;font-size:12px;color:#1A2035;outline:none;width:220px;font-family:'DM Sans',sans-serif}
.jcfg-card{background:#faf9f5;border:2px solid #E3E7F0;border-radius:10px;margin-bottom:12px;overflow:hidden;transition:border-color .15s}
.jcfg-card:hover{border-color:#C4DAFF}
.jcfg-head{padding:11px 14px;background:#f0efe9;border-bottom:1px solid #E3E7F0;display:flex;align-items:center;gap:10px}
.jcfg-num{width:24px;height:24px;border-radius:50%;background:#0073EA;color:#fff;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.jcfg-label{font-size:13px;font-weight:700;color:#1A2035;flex:1}
.jcfg-body{padding:14px}
.jcfg-row{display:grid;gap:10px;margin-bottom:10px}
.jcfg-row.col2{grid-template-columns:1fr 1fr}
.jcfg-row.col3{grid-template-columns:1fr 1fr 1fr}
.jtype-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:4px}
.jtype-tile{border:1.5px solid #E3E7F0;border-radius:7px;padding:8px 6px;cursor:pointer;text-align:center;transition:all .12s;background:#fff}
.jtype-tile:hover{border-color:#0073EA;background:#F0F7FF}
.jtype-tile.sel{border-color:#0073EA;background:#EBF4FF;box-shadow:0 0 0 2px rgba(0,115,234,.12)}
.jtype-icon{font-size:16px;display:block;margin-bottom:2px}
.jtype-lbl{font-size:10px;font-weight:700;color:#1A2035;line-height:1.2}
.jtype-sub{font-size:9px;color:#7A849E;margin-top:1px}
.dest-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
.dest-tile{border:1.5px solid #E3E7F0;border-radius:6px;padding:7px 10px;cursor:pointer;display:flex;align-items:center;gap:7px;transition:all .12s}
.dest-tile:hover{border-color:#0073EA;background:#F0F7FF}
.dest-tile.sel{border-color:#0073EA;background:#EBF4FF}
.dest-icon{font-size:14px;flex-shrink:0}
.dest-lbl{font-size:11px;font-weight:600;color:#1A2035}
.svc-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
.svc-toggle{border:1.5px solid #E3E7F0;border-radius:6px;padding:7px 11px;cursor:pointer;display:flex;align-items:center;gap:7px;transition:all .12s;background:#fff}
.svc-toggle:hover{border-color:#0073EA;background:#F0F7FF}
.svc-toggle.on{border-color:#0073EA;background:#EBF4FF}
.svc-check{width:16px;height:16px;border-radius:3px;border:1.5px solid #C4CBDA;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;transition:all .12s}
.svc-toggle.on .svc-check{background:#0073EA;border-color:#0073EA;color:#fff}
.acc-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
.acc-flag{border:1.5px solid #E3E7F0;border-radius:6px;padding:7px 11px;cursor:pointer;display:flex;align-items:center;gap:7px;transition:all .12s;background:#fff}
.acc-flag:hover{border-color:#FF9F1A;background:#FFF9F0}
.acc-flag.on{border-color:#FF9F1A;background:#FFF5E0}
.acc-flag.on .svc-check{background:#FF9F1A;border-color:#FF9F1A;color:#fff}
.svc-toggle-icon,.dest-icon-lbl{font-size:12px;font-weight:600;color:#1A2035;flex:1}
.vol-row{display:flex;gap:8px;align-items:center}
.vol-unit-btn{padding:5px 12px;border:1.5px solid #E3E7F0;border-radius:5px;font-size:12px;font-weight:600;cursor:pointer;color:#7A849E;background:#fff;transition:all .1s}
.vol-unit-btn.sel{border-color:#0073EA;background:#EBF4FF;color:#0073EA}
.avail-matrix{border:1px solid #E3E7F0;border-radius:8px;overflow:hidden;margin-top:10px}
.avail-head-row{display:flex;background:#f0efe9;border-bottom:1px solid #E3E7F0;padding:6px 0}
.avail-head-date{width:130px;flex-shrink:0;padding:0 12px;font-size:10px;font-weight:700;color:#7A849E;letter-spacing:.4px;text-transform:uppercase}
.avail-head-res{flex:1;text-align:center;font-size:10px;font-weight:700;color:#7A849E;letter-spacing:.3px;text-transform:uppercase;border-left:1px solid #ede9e0;padding:0 6px}
.avail-row{display:flex;border-bottom:1px solid #ede9e0;transition:background .1s;cursor:pointer}
.avail-row:last-child{border-bottom:none}
.avail-row:hover{background:#f5f4ef}
.avail-row.chosen{background:#EBF4FF}
.avail-row.chosen .avail-date-cell{color:#0073EA}
.avail-date-cell{width:130px;flex-shrink:0;padding:8px 12px;font-size:12px;font-weight:600;color:#1A2035;display:flex;flex-direction:column;gap:1px}
.avail-dow{font-size:10px;color:#7A849E;font-weight:500}
.avail-res-cell{flex:1;padding:6px 8px;border-left:1px solid #ede9e0;display:flex;align-items:center;justify-content:center}
.avail-bar{height:22px;border-radius:4px;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;width:100%;letter-spacing:.2px;transition:all .12s}
.avail-bar.free{background:#D1FAE5;color:#065F46}
.avail-bar.partial{background:#FEF3C7;color:#92400E}
.avail-bar.busy{background:#FEE2E2;color:#991B1B}
.avail-bar.wknd{background:#ede9e0;color:#9CA3AF}
.avail-legend{display:flex;gap:14px;padding:10px 12px;border-top:1px solid #E3E7F0;flex-wrap:wrap}

/* ── Storage direction panel (configurator Stage 2) ─────────────────── */
.sto-dir-tiles{display:flex;gap:10px;margin-bottom:12px}
.sto-dir-tile{flex:1;border:2px solid #E3E7F0;border-radius:8px;padding:12px 14px;cursor:pointer;transition:all .13s;background:#fff;display:flex;align-items:center;gap:10px}
.sto-dir-tile:hover{border-color:#0073EA;background:#F0F7FF}
.sto-dir-tile.sel{border-color:#0073EA;background:#EBF4FF}
.sto-dir-icon{font-size:22px;flex-shrink:0}
.sto-dir-lbl{font-size:12.5px;font-weight:700;color:#1A2035}
.sto-dir-sub{font-size:10.5px;color:#7A849E;margin-top:2px}
.sto-rec-card{border:1.5px solid #E3E7F0;border-radius:7px;padding:10px 14px;margin-bottom:8px;cursor:pointer;background:#fff;transition:all .12s}
.sto-rec-card:hover{border-color:#0073EA;background:#F0F7FF}
.sto-rec-card.sel{border-color:#0073EA;background:#EBF4FF}
.sto-rec-head{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.sto-rec-id{font-family:monospace;font-weight:700;font-size:12px;color:#0073EA}
.sto-rec-client{font-weight:700;font-size:13px;color:#1A2035;flex:1}
.sto-rec-vol{font-size:11px;color:#7A849E}
.sto-status-badge{font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px;background:#D1FAE5;color:#007048}
.sto-status-badge.pending{background:#FFF5E0;color:#9A5600}
.sto-status-badge.out{background:#F0F2F8;color:#6B7280}
.sto-container-row{display:flex;align-items:center;gap:8px;padding:7px 10px;border:1px solid #E3E7F0;border-radius:6px;margin-bottom:5px;background:#fff;font-size:12px}
.sto-container-row.sel{border-color:#0073EA;background:#EBF4FF}
.sto-container-row.sel .sto-cno{color:#0073EA}
.sto-cno{font-family:monospace;font-weight:700;color:#1A2035;min-width:54px}
.sto-loc{color:#7A849E;font-size:11px;min-width:70px}
.sto-ctype{font-size:10.5px;font-weight:600;padding:1px 6px;border-radius:3px;background:#F0F2F8;color:#3D4560;flex-shrink:0}
.sto-cvol{margin-left:auto;font-size:11.5px;font-weight:600;color:#1A2035}
.sto-remove-cb{width:16px;height:16px;cursor:pointer;flex-shrink:0;accent-color:#0073EA}
.sto-vol-calc{background:#FFF5E0;border:1px solid #FFD580;border-radius:7px;padding:10px 14px;margin-top:10px}
.sto-vol-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:12.5px}
.sto-vol-lbl{color:#3D4560;font-weight:500}
.sto-vol-val{font-weight:700;color:#1A2035}
.sto-vol-val.red{color:#E44258}
.sto-vol-val.green{color:#00C875}
.sto-new-ctr-row{display:flex;gap:6px;margin-bottom:6px;align-items:center}
.avail-leg-i{display:flex;align-items:center;gap:5px;font-size:10.5px;color:#7A849E}
.avail-leg-dot{width:10px;height:10px;border-radius:2px;flex-shrink:0}
.res-person{display:flex;align-items:center;gap:10px;padding:8px 12px;border:1.5px solid #E3E7F0;border-radius:7px;margin-bottom:7px;cursor:pointer;transition:all .12s;background:#faf9f5}
.res-person:hover{border-color:#0073EA;background:#F0F7FF}
.res-person.sel{border-color:#0073EA;background:#EBF4FF}
.res-person-av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0}
.res-person-name{font-size:13px;font-weight:600;color:#1A2035}
.res-person-role{font-size:10.5px;color:#7A849E}
.res-person-status{font-size:10px;font-weight:600;padding:2px 7px;border-radius:3px}
.rps-free{background:#D1FAE5;color:#065F46}
.rps-busy{background:#FEE2E2;color:#991B1B}
.rps-partial{background:#FEF3C7;color:#92400E}
.ops-job-card{border:2px solid #E3E7F0;border-radius:8px;margin-bottom:10px;overflow:hidden}
.ops-job-head{padding:10px 14px;background:#f0efe9;border-bottom:1px solid #E3E7F0;display:flex;align-items:center;gap:10px}
.ops-job-body{padding:12px 14px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.ops-di{display:flex;flex-direction:column;gap:2px}
.ops-dl{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#7A849E}
.ops-dv{font-size:12.5px;font-weight:600;color:#1A2035}
.obs-draft{background:#ede9e0;color:#6B7280;padding:2px 8px;border-radius:3px;font-size:10.5px;font-weight:700}
.obs-provisional{background:#FEF3C7;color:#92400E;padding:2px 8px;border-radius:3px;font-size:10.5px;font-weight:700}
.obs-confirmed{background:#D1FAE5;color:#065F46;padding:2px 8px;border-radius:3px;font-size:10.5px;font-weight:700}
.cs-sub-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:#7A849E;margin-bottom:8px;margin-top:14px}
.cs-sub-label:first-child{margin-top:0}
.cs-hint{font-size:11px;color:#7A849E;background:#f0efe9;border:1px solid #E3E7F0;border-radius:5px;padding:7px 10px;margin-top:6px;line-height:1.5}
.mday-row{display:flex;align-items:center;gap:12px;padding:10px 14px;border:1.5px solid #E3E7F0;border-radius:7px;background:#faf9f5;margin-bottom:8px}
.mday-toggle{position:relative;width:38px;height:20px;flex-shrink:0;cursor:pointer}
.mday-toggle input{opacity:0;width:0;height:0;position:absolute}
.mday-slider{position:absolute;inset:0;background:#C4CBDA;border-radius:10px;transition:background .2s}
.mday-slider:before{content:'';position:absolute;width:16px;height:16px;border-radius:50%;background:#fff;left:2px;top:2px;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.mday-toggle input:checked + .mday-slider{background:#0073EA}
.mday-toggle input:checked + .mday-slider:before{transform:translateX(18px)}
.mday-lbl{flex:1;font-size:12.5px;font-weight:600;color:#1A2035}
.mday-sub{font-size:11px;color:#7A849E}
.bline-compact{display:flex;gap:6px;align-items:center;margin-bottom:5px}
.bline-compact input{padding:6px 9px;border:1px solid #E3E7F0;border-radius:5px;font-size:12px;font-family:'DM Sans',sans-serif;color:#1A2035;outline:none}
.bline-compact input:focus{border-color:#0073EA}
.bline-rm{width:26px;height:26px;border-radius:4px;border:1px solid #E3E7F0;background:#faf9f5;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;color:#7A849E;flex-shrink:0;transition:all .1s}
.bline-rm:hover{border-color:#E44258;color:#E44258}
.cfg-field{display:flex;flex-direction:column;gap:3px;margin-bottom:10px}
.cfg-label{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#7A849E}
.cfg-input{padding:7px 10px;border:1px solid #E3E7F0;border-radius:5px;font-family:'DM Sans',sans-serif;font-size:13px;color:#1A2035;background:#faf9f5;outline:none;transition:border-color .15s;width:100%}
.cfg-input:focus{border-color:#0073EA;box-shadow:0 0 0 3px rgba(0,115,234,.1)}
.cfg-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%237A849E' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}

/* Day-slot picker (multi-day date selection) */
.dayslot-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.dayslot-num{width:22px;height:22px;border-radius:50%;background:#E3E7F0;color:#7A849E;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.dayslot-num.filled{background:#0073EA;color:#fff}
.dayslot-val{flex:1;padding:6px 10px;border:1.5px solid #E3E7F0;border-radius:6px;font-size:12px;color:#7A849E;background:#faf9f5;display:flex;align-items:center;gap:6px}
.dayslot-val.filled{border-color:#0073EA;color:#1A2035;background:#EBF4FF}
.dayslot-val.filled .ds-clear{display:flex}
.ds-clear{display:none;margin-left:auto;cursor:pointer;color:#7A849E;font-size:11px;line-height:1}
.ds-clear:hover{color:#E44258}
.dayslot-progress{background:#ede9e0;border-radius:6px;padding:8px 12px;margin-bottom:12px;display:flex;align-items:center;gap:10px}
.dp-bar-wrap{flex:1;height:6px;background:#E3E7F0;border-radius:3px;overflow:hidden}
.dp-bar{height:100%;background:#0073EA;border-radius:3px;transition:width .3s}
.dp-label{font-size:11px;font-weight:700;color:#1A2035;white-space:nowrap}
.dp-label.done{color:#00C875}
/* Matrix row highlight for selected dates */
.avail-row.chosen-multi{background:#EBF4FF}
.avail-row.chosen-multi .avail-date-cell{color:#0073EA}

/* PANEL */
.overlay{position:fixed;inset:0;background:rgba(28,35,51,.45);z-index:500;opacity:0;pointer-events:none;transition:opacity .2s}
.overlay.on{opacity:1;pointer-events:all}
.panel{position:fixed;top:0;right:0;bottom:0;width:480px;background:var(--w);z-index:501;transform:translateX(105%);transition:transform .24s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;border-left:1px solid var(--b1);box-shadow:var(--shm)}
.panel.on{transform:translateX(0)}
.ph{padding:14px 18px;border-bottom:1px solid var(--b1);display:flex;align-items:flex-start;justify-content:space-between;flex-shrink:0;background:var(--s1)}
.ph-title{font-weight:700;font-size:16px;letter-spacing:-.3px}
.ph-sub{font-size:11px;color:var(--t3);margin-top:2px}
.pb{flex:1;overflow-y:auto;padding:16px}
.pf{padding:11px 16px;border-top:1px solid var(--b1);display:flex;gap:7px;justify-content:flex-end;flex-shrink:0;background:var(--s1)}
.fsec{margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid var(--b1)}
.fsec:last-child{border-bottom:none;margin-bottom:0}
.fsec-t{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--t2);margin-bottom:9px;display:flex;align-items:center;gap:6px}
.fsec-t i{background:var(--blue);color:#fff;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8.5px;font-style:normal;font-weight:700;flex-shrink:0}
.fg{display:flex;flex-direction:column;gap:3px;margin-bottom:9px}
.fg2{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.lbl{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)}
input.fi,select.fi,textarea.fi{padding:6px 10px;background:var(--w);border:1px solid var(--b1);border-radius:5px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:400;color:var(--t1);outline:none;transition:border-color .1s;width:100%}
input.fi:focus,select.fi:focus,textarea.fi:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,115,234,.1)}
textarea.fi{resize:vertical;min-height:60px}
.cpill{display:inline-flex;align-items:center;gap:4px;cursor:pointer;font-size:12px;color:var(--t2);padding:3px 8px;background:var(--s1);border:1px solid var(--b1);border-radius:5px;transition:all .1s;font-family:'DM Sans',sans-serif;margin:2px;font-weight:600}
.di{display:flex;flex-direction:column;gap:2px}
.dlbl{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)}
.dval{font-size:12.5px;color:var(--t1);font-weight:500}
.brow{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--b1);font-size:12.5px}
.brow:last-child{border-bottom:none}
.blbl{color:var(--t2)}
.bamt{font-weight:600;font-size:13px}
.btotal{display:flex;justify-content:space-between;padding:9px 0 0;font-weight:700;font-size:14px;border-top:2px solid var(--t1);letter-spacing:-.2px}

/* TOAST */
.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%) translateY(50px);background:var(--t1);color:#fff;padding:8px 16px;border-radius:var(--r);font-size:13px;font-weight:700;box-shadow:var(--shm);z-index:999;transition:all .22s cubic-bezier(.4,0,.2,1);opacity:0;white-space:nowrap}
.toast.on{transform:translateX(-50%) translateY(0);opacity:1}

/* ═══════════════════════════════════════════════════════════════════════
   WAREHOUSE MODULE
   ═══════════════════════════════════════════════════════════════════════ */

/* ── Daily Movements ─────────────────────────────────────────────────── */
.wh-day-header{display:flex;align-items:baseline;gap:10px;margin-bottom:16px}
.wh-day-title{font-size:20px;font-weight:800;color:var(--t1);letter-spacing:-.4px}
.wh-day-sub{font-size:12px;color:var(--t3);font-weight:500}
.wh-day-stats{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:18px}
.wh-stat{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);padding:12px 14px;box-shadow:var(--sh)}
.wh-stat-num{font-size:22px;font-weight:800;color:var(--t1);letter-spacing:-.5px;line-height:1}
.wh-stat-lbl{font-size:10.5px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.4px;margin-top:4px}
.wh-stat-ico{font-size:18px;margin-bottom:6px}

/* Movements timeline */
.wh-timeline{display:flex;flex-direction:column;gap:0}
.wh-section{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);margin-bottom:12px;box-shadow:var(--sh);overflow:hidden}
.wh-section-head{display:flex;align-items:center;gap:10px;padding:11px 15px;border-bottom:1px solid var(--b1);background:var(--s1)}
.wh-section-icon{font-size:16px;flex-shrink:0}
.wh-section-title{font-size:13px;font-weight:700;color:var(--t1);flex:1}
.wh-section-count{font-size:11px;font-weight:700;padding:2px 8px;border-radius:9px;background:var(--blue);color:#fff}
.wh-section-empty{padding:12px 15px;font-size:12px;color:var(--t3);font-style:italic}

/* Movement entry row */
.wh-entry{display:flex;align-items:center;gap:12px;padding:11px 15px;border-bottom:1px solid var(--b1);cursor:pointer;transition:background .1s}
.wh-entry:last-child{border-bottom:none}
.wh-entry:hover{background:var(--s1)}
.wh-entry-dir{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.wh-entry-dir.in{background:#E6FFF5;color:#007048}
.wh-entry-dir.out{background:#FFF5E0;color:#9A5600}
.wh-entry-dir.activity{background:#EBF4FF;color:#004DA0}
.wh-entry-dir.thirdparty{background:#F5EEFF;color:#6B00B5}
.wh-entry-main{flex:1;min-width:0}
.wh-entry-client{font-size:13px;font-weight:700;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.wh-entry-detail{font-size:11.5px;color:var(--t2);margin-top:2px}
.wh-entry-meta{display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0}
.wh-entry-vol{font-size:12px;font-weight:700;color:var(--t2)}
.wh-entry-containers{font-size:10.5px;color:var(--t4);font-family:monospace}
.wh-entry-badge{font-size:10px;font-weight:700;padding:2px 7px;border-radius:9px}
.whb-job{background:#EBF4FF;color:#004DA0}
.whb-thirdparty{background:#F5EEFF;color:#6B00B5}
.whb-manual{background:var(--s2);color:var(--t2)}
.wh-entry-crew{font-size:11px;color:var(--t3);margin-top:2px}
.wh-entry-actions{display:flex;gap:5px;flex-shrink:0;opacity:0;transition:opacity .12s}
.wh-entry:hover .wh-entry-actions{opacity:1}

/* ── 3rd Party Flow Panel ────────────────────────────────────────────── */
.wh-3p-panel{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);padding:18px;box-shadow:var(--shm)}
.wh-3p-title{font-size:14px;font-weight:700;margin-bottom:14px;color:var(--t1)}

/* ── Warehouse Grid ─────────────────────────────────────────────────── */
.wh-grid-wrap{overflow:auto}
.wh-grid-legend{display:flex;align-items:center;gap:16px;margin-bottom:14px;padding:10px 14px;background:var(--w);border:1px solid var(--b1);border-radius:var(--r)}
.wh-legend-item{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600;color:var(--t2)}
.wh-legend-dot{width:12px;height:12px;border-radius:3px;flex-shrink:0}
.wh-legend-dot.client{background:#00C875}
.wh-legend-dot.nonclient{background:#FF9F00}
.wh-legend-dot.empty{background:#E44258}
.wh-legend-dot.pending{background:#B0B8CC}

.wh-grid{display:flex;flex-direction:column;gap:2px;min-width:max-content}
.wh-grid-row{display:flex;align-items:center;gap:2px}
.wh-grid-rowlbl{width:36px;font-size:9px;font-weight:700;color:var(--t3);text-align:right;padding-right:6px;flex-shrink:0;letter-spacing:.3px;text-transform:uppercase}
.wh-col-headers{display:flex;gap:2px;margin-left:36px}
.wh-col-hdr{font-size:9px;font-weight:700;color:var(--t4);text-align:center;width:52px;flex-shrink:0}

/* Container cell */
.wh-cell{width:52px;height:44px;border-radius:4px;border:1.5px solid transparent;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;transition:transform .1s,border-color .1s;position:relative;flex-shrink:0}
.wh-cell:hover{transform:scale(1.06);z-index:2;border-color:rgba(0,0,0,.25)!important}
.wh-cell.client{background:#00C87522;border-color:#00C87555}
.wh-cell.client-full{background:#00C875;border-color:#00C875}
.wh-cell.nonclient{background:#FF9F0033;border-color:#FF9F0077}
.wh-cell.empty{background:#E4425820;border-color:#E4425855}
.wh-cell.pending{background:#B0B8CC22;border-color:#B0B8CC55}
.wh-cell.runway{background:var(--s2);border:1.5px dashed var(--b2);cursor:default;font-size:8px;font-weight:700;color:var(--t4);letter-spacing:.8px;text-transform:uppercase;justify-content:center}
.wh-cell.loose-zone{background:#F0F7FF;border-color:#0073EA44}

.wh-cell-cno{font-size:8px;font-weight:800;color:inherit;letter-spacing:-.2px;font-family:monospace}
.wh-cell-loc{font-size:7.5px;color:var(--t4);letter-spacing:.2px}
.wh-cell-icon{font-size:11px;line-height:1}

/* Tooltip on cell hover */
.wh-cell-tooltip{
  display:none;
  position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);
  background:#1A2035;color:#fff;font-size:10.5px;font-weight:600;
  padding:6px 10px;border-radius:5px;white-space:nowrap;z-index:100;
  box-shadow:0 4px 12px rgba(0,0,0,.35);pointer-events:none;
}
.wh-cell-tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:#1A2035}
.wh-cell:hover .wh-cell-tooltip{display:block}

/* Runway label strip */
.wh-runway-row{display:flex;align-items:center;gap:2px;height:20px;margin:4px 0}
.wh-runway-cell{background:var(--s2);border-radius:2px;height:20px;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:var(--t4);letter-spacing:.8px;text-transform:uppercase;flex:1}

/* Loose row */
.wh-loose-row{display:flex;gap:6px;overflow-x:auto;padding-bottom:4px;margin-top:2px}
.wh-loose-cell{min-width:80px;height:50px;border-radius:4px;border:1.5px solid var(--b1);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;cursor:pointer;transition:border-color .1s;flex-shrink:0;position:relative}
.wh-loose-cell:hover{border-color:var(--blue)}
.wh-loose-cell.occupied{background:#EBF4FF;border-color:#0073EA55}
.wh-loose-cell.empty{background:#E4425810;border-color:#E4425840}
.wh-loose-cell-id{font-size:8.5px;font-weight:800;font-family:monospace;color:var(--t2)}
.wh-loose-cell-lbl{font-size:8px;color:var(--t3)}
.wh-loose-cell-icon{font-size:14px}

/* Grid side labels */
.wh-side-label{font-size:9px;font-weight:800;color:var(--t3);text-transform:uppercase;letter-spacing:1px;padding:6px 0 4px;text-align:center;display:block}

/* Zoom controls */
.wh-zoom{display:flex;align-items:center;gap:6px;margin-bottom:10px}
.wh-zoom-btn{width:26px;height:26px;border:1px solid var(--b1);border-radius:4px;background:var(--w);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;color:var(--t2)}

/* Cell detail panel */
.wh-cell-detail{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);padding:16px;margin-bottom:14px;box-shadow:var(--sh)}
.wh-cd-head{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.wh-cd-cno{font-size:18px;font-weight:800;font-family:monospace;color:var(--t1)}
.wh-cd-loc{font-size:13px;color:var(--t3);font-weight:600}
.wh-cd-status{font-size:11px;font-weight:700;padding:3px 10px;border-radius:10px}
.fade-in{animation:fi .18s ease both}
@keyframes fi{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
/* ── Storage method tiles (Goods In) ─────────────────────────────────── */
.stm-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:4px}
.stm-tile{border:2px solid var(--b1);border-radius:8px;padding:10px 6px;cursor:pointer;text-align:center;transition:all .13s;background:var(--w)}
.stm-tile:hover{border-color:var(--blue);background:#F0F7FF}
.stm-tile.sel{border-color:var(--blue);background:#EBF4FF}
.stm-tile-icon{font-size:20px;margin-bottom:4px}
.stm-tile-lbl{font-size:10.5px;font-weight:700;color:var(--t1)}
.stm-tile-sub{font-size:9.5px;color:var(--t3);margin-top:2px}
/* ── Email parse chips ────────────────────────────────────────────────── */
.wh-parse-chips{display:flex;flex-direction:column;gap:6px;margin-top:12px;border-top:1px solid var(--b1);padding-top:12px}
.wh-parse-row{display:flex;align-items:center;gap:8px;font-size:12px}
.wh-parse-lbl{font-size:10.5px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.4px;width:110px;flex-shrink:0}
.wh-chip{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:600;cursor:pointer;border:1.5px solid transparent}
.wh-chip.confirmed{background:#E6FFF5;color:#007048;border-color:#7DD9B0}
.wh-chip.assumed{background:#FFF5E0;color:#9A5600;border-color:#FFD580}
.wh-chip.missing{background:#FFECEF;color:#E44258;border-color:#F5A0AA;cursor:default}
.wh-chip-edit{font-size:10px;opacity:.6}
.wh-parse-edit-inp{display:none;background:var(--w);border:1.5px solid var(--blue);border-radius:6px;padding:3px 8px;font-size:12px;color:var(--t1);outline:none;min-width:140px}
.wh-parse-dir-btns{display:flex;gap:8px;margin-bottom:14px}
.wh-parse-dir-btn{flex:1;border:2px solid var(--b1);border-radius:7px;padding:10px 8px;cursor:pointer;text-align:center;transition:all .13s;background:var(--w);font-size:12.5px;font-weight:700;color:var(--t2)}
.wh-parse-dir-btn:hover{border-color:var(--blue)}
.wh-parse-dir-btn.sel{border-color:var(--blue);background:#EBF4FF;color:var(--blue)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--b2);border-radius:3px}

/* ══ ADDRESS LOOKUP ══════════════════════════════════════════════════ */
.addr-wrap{position:relative;display:flex;align-items:center;gap:5px}
.addr-wrap .fi{flex:1;padding-left:8px}
.addr-flag{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:15px;pointer-events:none;z-index:1;line-height:1}
.addr-wrap .fi.has-flag{padding-left:32px}
.addr-map-btn{width:28px;height:28px;border:1.5px solid var(--b1);border-radius:5px;background:var(--w);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--t3);flex-shrink:0;transition:all .1s}
.addr-map-btn:hover{border-color:var(--blue);color:var(--blue);background:#F0F7FF}
.addr-map-btn.has-addr{border-color:var(--green);color:var(--green)}
.addr-calc-btn{width:28px;height:28px;border:1.5px solid var(--b1);border-radius:5px;background:var(--w);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--t3);flex-shrink:0;transition:all .1s;font-weight:700}
.addr-calc-btn:hover{border-color:var(--blue);color:var(--blue);background:#F0F7FF}
.addr-calc-btn.calculating{animation:pulse-amber 1s infinite}

/* Autocomplete dropdown */
.addr-dropdown{position:absolute;top:calc(100% + 4px);left:0;right:36px;background:#fff;border:1.5px solid var(--blue);border-radius:7px;box-shadow:0 8px 24px rgba(0,0,0,.14);z-index:9999;overflow:hidden;max-height:220px;overflow-y:auto}
.addr-option{display:flex;align-items:flex-start;gap:8px;padding:9px 12px;cursor:pointer;border-bottom:1px solid var(--s2);transition:background .08s}
.addr-option:last-child{border-bottom:none}
.addr-option:hover{background:#F0F7FF}
.addr-option-icon{font-size:13px;margin-top:1px;flex-shrink:0}
.addr-option-main{font-size:12.5px;font-weight:600;color:var(--t1)}
.addr-option-sub{font-size:11px;color:var(--t3);margin-top:1px}

/* Mileage calc result inline */
.miles-calc-result{display:flex;align-items:center;gap:6px;font-size:11.5px;color:var(--t2);margin-top:5px;padding:5px 9px;background:#F0F7FF;border-radius:5px;border:1px solid #C4D9F5}
.miles-calc-result .leg{font-weight:600}
.miles-calc-result .total{font-weight:800;color:var(--blue)}

/* ══ MAP MODAL ══════════════════════════════════════════════════════════ */
.map-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:20000;display:flex;align-items:center;justify-content:center;animation:fi .15s ease}
.map-modal{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.4);width:min(820px,95vw);max-height:90vh;display:flex;flex-direction:column}
.map-modal-head{display:flex;align-items:center;gap:10px;padding:13px 16px;background:var(--w);border-bottom:1px solid var(--b1)}
.map-modal-title{font-size:13.5px;font-weight:700;color:var(--t1);flex:1}
.map-modal-addr{font-size:11.5px;color:var(--t3);margin-top:2px}
.map-modal-tabs{display:flex;gap:4px}
.map-modal-tab{font-size:11.5px;font-weight:700;padding:4px 12px;border-radius:5px;border:1.5px solid var(--b1);background:var(--w);cursor:pointer;color:var(--t2);transition:all .1s}
.map-modal-tab.on{background:#EBF4FF;border-color:var(--blue);color:var(--blue)}
.map-modal-body{flex:1;min-height:480px;position:relative}
.map-modal-body iframe{width:100%;height:100%;min-height:480px;border:none}
.map-modal-close{width:30px;height:30px;border-radius:7px;border:1.5px solid var(--b1);background:var(--w);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--t2)}
.map-modal-close:hover{background:var(--rlt);border-color:var(--red);color:var(--red)}

/* ══ COS SETTINGS TAB ═══════════════════════════════════════════════════ */
.cos-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.cos-field{display:flex;flex-direction:column;gap:5px}
.cos-lbl{font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.4px}
.cos-desc{font-size:11px;color:var(--t4);margin-top:2px}

/* ══ ENHANCED COST BREAKDOWN in job COS ════════════════════════════════ */
.cos-section-head{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t4);padding:6px 0 3px;border-top:1px solid var(--b1);margin-top:6px}
.cos-section-head:first-child{border-top:none;margin-top:0}

/* Status badges on job cards */
.jcard-status{font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px;white-space:nowrap;align-self:flex-start;margin-left:auto;flex-shrink:0}
.st-pending{background:#FFF5E0;color:#FF9F00}
.st-confirmed{background:#EBF4FF;color:#0073EA}
.st-inprog{background:#F5EEFF;color:#A25DDC}
.st-done{background:#E6FFF5;color:#00A86B}
.st-billed{background:#E6FFF5;color:#00A86B}
.st-cancelled{background:#FFECEF;color:#E44258}
/* Quick status context menu */
.ctx-menu{position:fixed;background:#fff;border:1px solid var(--b1);border-radius:8px;box-shadow:var(--shm);z-index:9999;min-width:160px;padding:4px 0;font-size:13px}
.ctx-item{padding:8px 14px;cursor:pointer;display:flex;align-items:center;gap:8px;color:var(--t1)}
.ctx-item:hover{background:var(--s1)}
.ctx-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

/* ══════════════════════════════════════════════════════════════════
   MOBILE LAYOUT REFINEMENTS
   ══════════════════════════════════════════════════════════════════ */
@media (max-width: 768px) {

  /* Dashboard KPI cards — 2 col grid on mobile */
  .kpi-grid{grid-template-columns:1fr 1fr!important;gap:10px!important}
  .kpi-card{padding:12px 14px!important}
  .kpi-val{font-size:22px!important}

  /* Alert cards full width */
  .alert-list{padding:0 12px!important}

  /* Finance stats — 2 col */
  .fin-stats{grid-template-columns:1fr 1fr!important;gap:10px!important}

  /* Job cards in list view — full width, larger touch targets */
  .bk-item{padding:12px 14px!important}
  .bk-item .bk-actions{gap:6px!important}
  .bk-item .bk-actions .btn{padding:7px 12px!important;font-size:12px!important}

  /* Panels full screen on mobile */
  .panel{
    width:100%!important;
    border-radius:0!important;
    border-left:none!important;
  }

  /* Modals full screen on mobile */
  .modal-box, .cfg-modal-box{
    width:100%!important;
    max-width:100%!important;
    margin:0!important;
    border-radius:16px 16px 0 0!important;
    position:fixed!important;
    bottom:0!important;
    max-height:90vh!important;
  }
  .modal-backdrop, .cfg-backdrop{
    align-items:flex-end!important;
  }

  /* Calendar — hide 2week view on mobile */
  .vt[onclick*="twoweek"]{display:none!important}

  /* Settings tabs scroll */
  .stabs{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .stabs::-webkit-scrollbar{display:none}

  /* Tables — horizontal scroll */
  .sc-table, table{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}

  /* Topbar — hide nav controls, show just title + search */
  .tb-title{font-size:15px;font-weight:700}

  /* Booking manager — stack panels */
  .bk-layout{flex-direction:column!important}
  .bk-sidebar{width:100%!important;max-width:100%!important;border-right:none!important;border-bottom:1px solid var(--b1)!important;max-height:40vh!important}

  /* Crew scheduler — full width */
  .crew-outer{padding:10px!important}

  /* Search — full width on mobile */
  .search-container{width:100%!important}
}

/* ── NEW FLOW: Route tiles ────────────────────────────────────── */
.route-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.route-tile{border:2px solid #E3E7F0;border-radius:10px;padding:14px;cursor:pointer;transition:all .15s;background:#fff;position:relative}
.route-tile:hover{border-color:var(--rt-accent,#0073EA);background:var(--rt-bg,#EBF4FF);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
.route-tile.sel{border-color:var(--rt-accent,#0073EA);background:var(--rt-bg,#EBF4FF);box-shadow:0 0 0 3px color-mix(in srgb,var(--rt-accent,#0073EA) 15%,transparent)}
.route-tile-icon{font-size:24px;margin-bottom:6px;display:block}
.route-tile-label{font-size:13px;font-weight:700;color:#1A2035;margin-bottom:3px}
.route-tile-sub{font-size:11px;color:#7A849E;line-height:1.4}
.route-tile-check{position:absolute;top:10px;right:10px;width:20px;height:20px;border-radius:50%;background:var(--rt-accent,#0073EA);color:#fff;font-size:11px;display:flex;align-items:center;justify-content:center;font-weight:700}
/* Storage picker */
.sto-pick-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1.5px solid #E3E7F0;border-radius:8px;margin-bottom:6px;cursor:pointer;transition:all .12s;background:#fff}
.sto-pick-row:hover{border-color:#0073EA;background:#F0F7FF}
.sto-pick-row.sel{border-color:#0073EA;background:#EBF4FF}
.sto-pick-main{flex:1;min-width:0}
.sto-pick-name{font-size:13px;font-weight:700;color:#1A2035}
.sto-pick-meta{font-size:11px;color:#7A849E;margin-top:2px}
.sto-pick-check{font-size:11px;font-weight:700;color:#0073EA;white-space:nowrap}
.sto-pick-brand{flex-shrink:0}

/* Date Jumper */
@keyframes dj-pop{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}
.dj-quick{padding:4px 10px;border:1.5px solid #E3E7F0;border-radius:5px;background:#fff;font-size:11.5px;font-weight:600;color:#4A5568;cursor:pointer;transition:all .1s}
.dj-quick:hover{border-color:#0073EA;color:#0073EA;background:#EBF4FF}

/* ── SHAREPOINT / DOC STATUS ─────────────────────────────── */
.doc-status-green{background:#D1FAE5;color:#065F46;border:1px solid #6EE7B7}
.doc-status-amber{background:#FEF3C7;color:#92400E;border:1px solid #FCD34D}
.doc-status-red{background:#FEE2E2;color:#991B1B;border:1px solid #FCA5A5;animation:pulse-red 2s ease-in-out infinite}
.doc-status-grey{background:#F3F4F6;color:#6B7280;border:1px solid #D1D5DB}
@keyframes pulse-red{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}50%{box-shadow:0 0 0 3px rgba(239,68,68,.25)}}
.sp-checklist-row{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--s2)}
.sp-checklist-row:last-child{border-bottom:none}
.sp-cl-icon{font-size:15px;flex-shrink:0;width:22px;text-align:center}
.sp-cl-name{flex:1;font-size:12.5px;font-weight:600;color:var(--t1)}
.sp-cl-count{font-size:11px;color:var(--t3);flex-shrink:0}
.sp-cl-status{font-size:10.5px;font-weight:700;padding:2px 8px;border-radius:4px;flex-shrink:0}
.sp-cl-status.received{background:#D1FAE5;color:#065F46}
.sp-cl-status.outstanding{background:#FEF3C7;color:#92400E}
.sp-cl-status.atrisk{background:#FEE2E2;color:#991B1B}
.sp-cl-status.na{background:#F3F4F6;color:#9CA3AF}
.sp-cl-status.after{background:#EDE9FE;color:#5B21B6}
.sp-cl-actions{display:flex;gap:5px;flex-shrink:0}
.sp-upload-zone{border:2px dashed var(--b1);border-radius:8px;padding:20px;text-align:center;cursor:pointer;transition:all .15s;margin-top:12px}
.sp-upload-zone:hover{border-color:var(--blue);background:var(--blt)}
.sp-file-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--s2);font-size:12px}
.sp-file-row:last-child{border-bottom:none}
.sp-file-icon{font-size:16px;flex-shrink:0}
.sp-file-name{flex:1;font-weight:500;color:var(--t1);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sp-file-meta{font-size:10.5px;color:var(--t3);flex-shrink:0}
</style>
<body>

<aside class="sidebar" id="sidebar">
  <!-- Logo -->
  <div class="sb-logo">
    <div class="sb-icon">OM</div>
    <div class="sb-wordmark">
      <div class="sb-name">OPS MANAGER</div>
      <div class="sb-tag">Removals Platform</div>
    </div>
  </div>

  <nav class="sb-nav">
    <div class="sb-group-lbl">Operations</div>

    <button class="nb on" id="nb-dashboard" onclick="showMod('dashboard',this)">
      <div class="nb-ico"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg></div>
      <span class="sb-label">Dashboard</span>
    </button>

    <button class="nb" id="nb-calendar" onclick="showMod('calendar',this)">
      <div class="nb-ico"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
      <span class="sb-label">Job Calendar</span>
      <span class="nb-badge hidden" id="job-badge">0</span>
    </button>

    <button class="nb" id="nb-bookings" onclick="showMod('bookings',this)">
      <div class="nb-ico"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
      <span class="sb-label">Client Records</span>
      <span class="nb-badge hidden" id="bk-badge">0</span>
    </button>

    <button class="nb" id="nb-crew" onclick="showMod('crew',this)">
      <div class="nb-ico"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="7" r="4"/><path d="M3 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/><path d="M21 21v-2a4 4 0 0 0-3-3.85"/></svg></div>
      <span class="sb-label">Crew Scheduler</span>
    </button>

    <button class="nb" id="nb-warehouse" onclick="showMod('warehouse',this)">
      <div class="nb-ico"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
      <span class="sb-label">Warehouse</span>
      <span class="nb-badge hidden" id="wh-badge">0</span>
    </button>

    <div class="sb-group-lbl">Finance</div>

    <button class="nb" id="nb-finance" onclick="showMod('finance',this)">
      <div class="nb-ico"><svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><text x="1" y="13" font-size="14" font-family="serif" font-weight="700">£</text></svg></div>
      <span class="sb-label">Finance &amp; Billing</span>
    </button>

    <button class="nb" id="nb-storage" onclick="showMod('storage',this)">
      <div class="nb-ico"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/></svg></div>
      <span class="sb-label">Storage</span>
      <span class="nb-badge hidden" id="storage-badge">0</span>
    </button>

    <div class="sb-group-lbl">System</div>

    <button class="nb" id="nb-settings" onclick="showMod('settings',this)">
      <div class="nb-ico"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M4.93 4.93a10 10 0 0 0 0 14.14"/></svg></div>
      <span class="sb-label">Settings</span>
    </button>
  </nav>

  <!-- User + Logout footer -->
  <div class="sb-foot">
    <div class="sb-user">
      <div class="sb-av"><div class="sb-av-inner" id="sb-av-initials">OM</div></div>
      <div class="sb-user-info">
        <div class="sb-uname" id="sb-uname-display">Ops Manager</div>
        <div class="sb-urole" id="sb-urole-display">Administrator</div>
      </div>
    </div>
    <button class="sb-logout" onclick="window.location.href='/.auth/logout'">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      <span>Sign Out</span>
    </button>
  </div>
</aside>



<div class="main">
  <div class="topbar">
    <div class="tb-title" id="tb-title">Job Calendar</div>
    <div class="divider"></div>
    <div class="vtabs" id="vtabs">
      <button class="vt on" onclick="setView('week',this)">Week</button>
      <button class="vt" onclick="setView('twoweek',this)">2 Week</button>
      <button class="vt" onclick="setView('month',this)">Month</button>
      <button class="vt" onclick="setView('day',this)">Day</button>
      <button class="vt" onclick="setView('list',this)">List</button>
      <button class="vt fin-only" style="display:none" onclick="setView('trends',this)">Trends</button>
      <button class="vt fin-only" style="display:none" onclick="setView('forecast',this)">Forecast</button>
      <button class="vt fin-only" style="display:none" onclick="setView('forecast',this)">Forecast</button>
    </div>
    <div class="divider"></div>
    <div class="cnav">
      <button class="cn-btn" onclick="navPrev()">&#8249;</button>
      <div class="cn-lbl" id="cn-lbl" onclick="openDateJumper('main')" title="Click to jump to a specific date" style="cursor:pointer">&mdash;</div>
      <button class="cn-btn" onclick="navNext()">&#8250;</button>
      <button class="today-btn" onclick="goToday()">Today</button>
    </div>
    <div style="position:relative;flex:1;max-width:280px">
      <input id="global-search" class="fi" placeholder="&#128269; Search jobs, clients, refs..." style="width:100%;padding:6px 10px 6px 32px;font-size:12.5px;border-radius:6px;border:1px solid var(--b1);background:var(--s1)" oninput="renderSearchResults(this.value)" onfocus="el('search-drop').style.display='block'" onblur="setTimeout(function(){el('search-drop').style.display='none'},200)">
      <svg style="position:absolute;left:9px;top:50%;transform:translateY(-50%);opacity:.4;pointer-events:none" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <div id="search-drop" style="display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border:1px solid var(--b1);border-radius:8px;box-shadow:var(--shm);z-index:500;max-height:320px;overflow-y:auto"></div>
    </div>
    <div class="tb-greeting" id="tb-greeting"></div>
    <div class="tb-r">
      <button class="btn btn-s btn-sm" onclick="doExport()">&#8595; Export</button>
      <button class="btn btn-p btn-sm" onclick="openNew(null)">+ New Job</button>
    </div>
  </div>

  <div class="content">
    <div class="page on" id="mod-dashboard">
      <div style="flex:1;overflow:auto;padding:20px" id="dashboard-body"></div>
    </div>
    <div class="page" id="mod-calendar">
      <div style="flex:1;overflow:auto;display:flex;flex-direction:column"><div class="cal-outer" id="cal-out"></div></div>
    </div>
    <div class="page" id="mod-crew"><div class="crew-outer" id="crew-out"></div></div>
    <div class="page" id="mod-finance"><div class="fin-outer" id="fin-out"></div></div>
  <!-- STORAGE MODULE -->
  <div class="page" id="mod-storage">
    <div class="topbar">
      <div class="tb-title">Storage</div>
      <div class="divider"></div>
      <div style="display:flex;gap:4px">
        <button class="vt on" id="stf-all" onclick="setStorageFilter('all',this)">All</button>
        <button class="vt" id="stf-active" onclick="setStorageFilter('active',this)">Active</button>
        <button class="vt" id="stf-inout" onclick="setStorageFilter('inout',this)">In/Out</button>
        <button class="vt" id="stf-longterm" onclick="setStorageFilter('longterm',this)">Long-term</button>
      </div>
      <div class="tb-r">
        <button class="btn btn-p btn-sm" onclick="newStorageRecord()">+ New Storage</button>
      </div>
    </div>
    <div id="storage-out" style="flex:1;overflow-y:auto;padding:18px"></div>
  </div>

  <!-- WAREHOUSE MODULE -->
  <div class="page" id="mod-warehouse">
    <div style="height:44px;background:var(--w);border-bottom:1px solid var(--b1);display:flex;align-items:center;padding:0 14px;gap:8px;flex-shrink:0">
      <div style="display:flex;gap:4px" id="wh-tabs">
        <button class="vt on" onclick="whSetTab('movements',this)">Daily Movements</button>
        <button class="vt" onclick="whSetTab('records',this)">Storage Records</button>
        <button class="vt" onclick="whSetTab('grid',this)">Warehouse Grid</button>
      </div>
      <div class="divider"></div>
      <div class="cnav" id="wh-cnav">
        <button class="cn-btn" onclick="whNavPrev()">&#8249;</button>
        <div class="cn-lbl" id="wh-cn-lbl" onclick="openDateJumper('warehouse')" title="Click to jump to a specific date" style="cursor:pointer">&mdash;</div>
        <button class="cn-btn" onclick="whNavNext()">&#8250;</button>
        <button class="today-btn" onclick="whGoToday()">Today</button>
      </div>
      <div class="tb-r" id="wh-tb-r">
        <button class="btn btn-s btn-sm" onclick="whParseEmail()">&#128233; Parse Email</button>
        <button class="btn btn-s btn-sm" onclick="wh3rdPartyIn()">&#8595; Goods In</button>
        <button class="btn btn-s btn-sm" onclick="wh3rdPartyOut()">&#8593; Goods Out</button>
        <button class="btn btn-p btn-sm" onclick="whAddActivity()">+ Activity</button>
      </div>
    </div>
    <div id="wh-out" style="flex:1;overflow:auto;padding:16px"></div>
  </div>

    <div class="page" id="mod-settings">
      <div class="settings-outer">
        <div class="settings-tabs">
          <button class="stab on" id="stab-crew" onclick="setStab('crew',this)">Crew Rates</button>
          <button class="stab" id="stab-vehicles" onclick="setStab('vehicles',this)">Vehicles</button>
          <button class="stab" id="stab-materials" onclick="setStab('materials',this)">Materials</button>
          <button class="stab" id="stab-charges" onclick="setStab('charges',this)">Charges &amp; Taxes</button>
          <button class="stab" id="stab-brands" onclick="setStab('brands',this)">Brands</button>
          <button class="stab" id="stab-mm" onclick="setStab('mm',this)">Move Managers</button>
          <button class="stab" id="stab-comms" onclick="setStab('comms',this)">Company / Comms</button>
          <button class="stab" id="stab-costing" onclick="setStab('costing',this)">Cost of Sale &amp; Maps</button>
          <button class="stab" id="stab-company" onclick="setStab('company',this)">🏢 Branding &amp; Email</button>
        </div>
        <div style="padding:10px 12px;border-top:1px solid var(--b1);font-size:10px;color:var(--t3);text-align:center" id="app-version-badge">
          <!-- version injected by JS -->
        </div>
        <div class="settings-body" id="settings-body"></div>
      </div>
    </div>

    <!-- BOOKING MODULE -->
    <div class="page" id="mod-bookings">
      <!-- Client Records split view -->
      <div style="display:flex;height:100%;overflow:hidden">

        <!-- LEFT: Client job list -->
        <div style="width:300px;min-width:300px;border-right:1px solid var(--b1);display:flex;flex-direction:column;background:var(--w)">
          <div style="padding:12px;border-bottom:1px solid var(--b1);flex-shrink:0">
            <button class="btn btn-p" style="width:100%;margin-bottom:6px" onclick="newClientRecord()">+ New Client Job</button>
            <button class="btn btn-s" style="width:100%;margin-bottom:8px;font-size:12px" onclick="openBookingParser()">🤖 Parse from Email / Doc</button>
            <div style="position:relative">
              <input class="fi" id="cj-search" placeholder="&#128269; Search clients, refs..." style="width:100%;padding:6px 10px 6px 28px;font-size:12px" oninput="renderClientJobsList()">
              <svg style="position:absolute;left:9px;top:50%;transform:translateY(-50%);opacity:.4;pointer-events:none" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            </div>
            <div style="display:flex;gap:3px;margin-top:8px">
              <button class="vt on" id="cjf-all"      onclick="setCjFilter('all',this)"      style="flex:1;font-size:10.5px">All</button>
              <button class="vt"    id="cjf-active"   onclick="setCjFilter('active',this)"   style="flex:1;font-size:10.5px">Active</button>
              <button class="vt"    id="cjf-done"     onclick="setCjFilter('done',this)"     style="flex:1;font-size:10.5px">Done</button>
              <button class="vt"    id="cjf-archived" onclick="setCjFilter('archived',this)" style="flex:1;font-size:10.5px">&#128451;</button>
            </div>
          </div>
          <div id="cj-list" style="flex:1;overflow-y:auto"></div>
        </div>

        <!-- RIGHT: Detail panel -->
        <div style="flex:1;overflow-y:auto;background:var(--s1)" id="cj-detail">
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;min-height:400px;color:var(--t3);text-align:center;padding:40px">
            <svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:16px;opacity:.25"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            <div style="font-weight:600;font-size:16px;color:var(--t2);margin-bottom:8px">No client record selected</div>
            <div style="font-size:13px">Select a client from the list, or click <strong>+ New Client Job</strong> to create one.</div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ── JOB CONFIGURATOR PANEL ─────────────────────────────────────────── -->
<div class="cfg-backdrop" id="cfg-backdrop" onclick="cfgClickBackdrop(event)"></div>
<div class="cfg-panel" id="cfg-panel">
  <div class="cfg-head">
    <div class="cfg-head-title" id="cfg-head-title">Job Configurator</div>
    <span class="cfg-head-ref" id="cfg-head-ref"></span>
    <button class="cfg-close" onclick="closeConfigurator()" title="Close">&#10005;</button>
  </div>
  <div class="cfg-stages" id="cfg-stages">
    <div class="cfg-stage active" id="cstage-0" onclick="cfgGoStage(0)">
      <div class="cfg-stage-num">1</div>
      <div class="cfg-stage-lbl">Client &amp; Jobs</div>
    </div>
    <div class="cfg-stage" id="cstage-1" onclick="cfgGoStage(1)">
      <div class="cfg-stage-num">2</div>
      <div class="cfg-stage-lbl">Movements</div>
    </div>
    <div class="cfg-stage" id="cstage-2" onclick="cfgGoStage(2)">
      <div class="cfg-stage-num">3</div>
      <div class="cfg-stage-lbl">Resources</div>
    </div>
    <div class="cfg-stage" id="cstage-3" onclick="cfgGoStage(3)">
      <div class="cfg-stage-num">4</div>
      <div class="cfg-stage-lbl">Billing</div>
    </div>
    <div class="cfg-stage" id="cstage-4" onclick="cfgGoStage(4)">
      <div class="cfg-stage-num">5</div>
      <div class="cfg-stage-lbl">Confirm</div>
    </div>
  </div>
  <div class="cfg-body" id="cfg-body"></div>
  <div class="cfg-foot">
    <div id="cfg-foot-l">
      <button class="btn btn-s btn-sm" id="cfg-btn-back" onclick="cfgBack()" style="display:none">&#8592; Back</button>
    </div>
    <div style="display:flex;gap:8px" id="cfg-foot-r">
      <button class="btn btn-s btn-sm" id="cfg-save-draft-btn" style="display:none" onclick="cfgSaveDraft()">Save Draft</button>
      <button class="btn btn-p btn-sm" id="cfg-btn-next" onclick="cfgNext()">Next &#8594;</button>
    </div>
  </div>
</div>

<!-- Eye button — fixed above all overlays and panels, always accessible -->
<button class="eye-btn" id="eye-btn" onclick="toggleVals()" title="Show/hide financial values">&#128065;</button>

<div class="overlay" id="overlay" onclick="closePanel()"></div>
<div class="panel" id="panel">
  <div class="ph">
    <div><div class="ph-title" id="p-title"></div><div class="ph-sub" id="p-sub"></div></div>
    <button class="btn btn-g" onclick="closePanel()">&#10005;</button>
  </div>
  <div class="pb" id="p-body"></div>
  <div class="pf" id="p-foot"></div>
</div>
<div class="toast" id="toast-el"></div>

<script>
// ── DATA ──────────────────────────────────────────────────────────────
// Full brand objects — configurable in Settings > Brands
// channel: 'Partner' | 'Account' | 'Domestic'
var BRAND_DATA = [
  {name:'SIRVA',          col:'#0073EA',channel:'Partner', logo:'', spFolder:'SIRVA'},
  {name:'BRITANNIA',      col:'#C8102E',channel:'Partner', logo:'', spFolder:''},
  {name:'MOVESQUAD',      col:'#00C875',channel:'Account', logo:'', spFolder:''},
  {name:'EMS',            col:'#7B2FBE',channel:'Account', logo:'', spFolder:'EMS'},
  {name:'STERLING',       col:'#E07B00',channel:'Account', logo:'', spFolder:'Sterling Lexicon'},
  {name:'DOREE BONNER',   col:'#00897B',channel:'Partner', logo:'', spFolder:'Doree Bonner'},
  {name:'DALEYSMOVE',     col:'#E91E8C',channel:'Partner', logo:'', spFolder:''},
  {name:'BTR',            col:'#FF5630',channel:'Account', logo:'', spFolder:'BTR'},
  {name:'ECKERSLEYS',     col:'#6554C0',channel:'Account', logo:'', spFolder:''},
  {name:'JOHN MASON',     col:'#0052CC',channel:'Partner', logo:'', spFolder:'John Mason'},
  {name:'BAXTERS',        col:'#36B37E',channel:'Partner', logo:'', spFolder:'Baxters'},
  {name:'SOLARIS',        col:'#FF8B00',channel:'Partner', logo:'', spFolder:'Solaris'},
  {name:'GOSSELIN',       col:'#253858',channel:'Partner', logo:'', spFolder:'Gosselin'},
  {name:'CROWN WORKSPACE',col:'#0065FF',channel:'Partner', logo:'', spFolder:'Crown Workspace'},
  {name:'ANYVAN',         col:'#57D9A3',channel:'Partner', logo:'', spFolder:''},
  {name:'CROWN',          col:'#1A56DB',channel:'Partner', logo:'', spFolder:'Crown'},
  {name:'BRADSHAW',       col:'#9333EA',channel:'Partner', logo:'', spFolder:'Bradshaw International'},
  {name:'BISHOP\'S MOVE', col:'#DC2626',channel:'Partner', logo:'', spFolder:'Bishop\'s Move'},
  {name:'WBC',            col:'#059669',channel:'Account', logo:'', spFolder:'WBC (Warrington Borough Council)'},
];

// Derived lookup dicts (rebuilt by buildBrandMaps())
var BRANDS=[]; var BC={}; var BBLT={}; var BROW={}; var BTXT={}; var BLOG={};
function hexToLight(hex) {
  // Convert brand hex colour to a light tint (~10% opacity)
  var r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  return 'rgb('+Math.round(r*.12+243)+','+Math.round(g*.12+243)+','+Math.round(b*.12+243)+')';
}
function hexToDark(hex) {
  var r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  return 'rgb('+Math.round(r*.6)+','+Math.round(g*.6)+','+Math.round(b*.6)+')';
}
function buildBrandMaps() {
  BRANDS=[]; BC={}; BBLT={}; BROW={}; BTXT={};
  for(var i=0;i<BRAND_DATA.length;i++){
    var b=BRAND_DATA[i];
    BRANDS.push(b.name);
    BC[b.name]=b.col;
    BBLT[b.name]=hexToLight(b.col);
    BROW[b.name]=hexToLight(b.col).replace('rgb(','rgba(').replace(')',', 0.5)');
    BTXT[b.name]=hexToDark(b.col);
    BLOG[b.name]=b.logo||'';
  }
}
buildBrandMaps();
function brandChannel(name){ for(var i=0;i<BRAND_DATA.length;i++) if(BRAND_DATA[i].name===name) return BRAND_DATA[i].channel||'Partner'; return 'Partner'; }
var BCLS= {SIRVA:'b-sirva',BRITANNIA:'b-britannia',MOVESQUAD:'b-movesquad',EMS:'b-ems',STERLING:'b-sterling'};
var DS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
var DF = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
var MS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

// chargeRate = day rate charged out per person per day (revenue / COS in job costing)

// ── MOVE MANAGERS ────────────────────────────────────────────────────
// One MM per brand. Used for Partner/Account job comms instead of end client.
var MOVE_MANAGERS = [
  {id:'MM001',name:'Sarah Keane',    phone:'07700 900111',email:'s.keane@sirva.com',    brand:'SIRVA'},
  {id:'MM002',name:'Tom Ballard',    phone:'07700 900222',email:'t.ballard@britannia.com',brand:'BRITANNIA'},
  {id:'MM003',name:'Claire Hughes',  phone:'07700 900333',email:'c.hughes@movesquad.com', brand:'MOVESQUAD'},
  {id:'MM004',name:'Raj Patel',      phone:'07700 900444',email:'raj.patel@ems-reloc.com',brand:'EMS'},
  {id:'MM005',name:'Donna Walsh',    phone:'07700 900555',email:'d.walsh@sterling.com',   brand:'STERLING'},
];
function mmForBrand(brandName){ for(var i=0;i<MOVE_MANAGERS.length;i++) if(MOVE_MANAGERS[i].brand===brandName) return MOVE_MANAGERS[i]; return null; }
function mmForJob(j){ if(!j.brand||brandChannel(j.brand)==='Domestic') return null; return mmForBrand(j.brand); }

// rate       = basic pay rate (used with NI/pension/holiday to derive notional cost)
// employed   = true (PAYE) | false (self-employed/contractor — notional = basic rate)
// ni         = employer's NI % (employed only, default 13.8%)
// pension    = employer pension % (employed only, default 3%)
// holiday    = holiday pay uplift % (employed only, default 12.07%)
// notional   = chargeRate * oncost multipliers — used in Finance accounting view only
var CREW = [
  {name:'ADRIAN',role:'Driver',chargeRate:220,rate:180,col:'#0073EA',employed:true, ni:13.8,pension:3,holiday:12.07,photo:'',email:''},
  {name:'MARTYN',role:'Driver',chargeRate:220,rate:180,col:'#00C875',employed:true, ni:13.8,pension:3,holiday:12.07,photo:''},
  {name:'RAY',   role:'Driver',chargeRate:215,rate:175,col:'#FF9F1A',employed:true, ni:13.8,pension:3,holiday:12.07,photo:''},
  {name:'DAYLE', role:'Driver',chargeRate:195,rate:175,col:'#A25DDC',employed:false,ni:0,   pension:0,holiday:0,   photo:''},
  {name:'DAVE',  role:'Porter',chargeRate:160,rate:130,col:'#0097C2',employed:true, ni:13.8,pension:3,holiday:12.07,photo:''},
  {name:'JOE',   role:'Porter',chargeRate:160,rate:130,col:'#E44258',employed:true, ni:13.8,pension:3,holiday:12.07,photo:''},
  {name:'ALFIE', role:'Porter',chargeRate:145,rate:125,col:'#B86800',employed:false,ni:0,   pension:0,holiday:0,   photo:''},
];
var HOL = {JOE:['2026-03-05','2026-03-06','2026-03-07']};

// journeyId: links job to a JOURNEY container (optional).
// storageId: links job to a STORAGE_RECORD (either direction).
// seqInDay: position within same-day multi-job sequence (1-based, 0 = single job).
var jobs = [
  {id:'J001',ref:'GB2600334-01',brand:'SIRVA',channel:'Partner',jobType:'Door to Door',clientRef:'',moveManager:'',client:'Kitchen (Telford)',origin:'TF2 9JZ',dest:'INT STORE',start:'2026-03-02',end:'2026-03-04',vol:1792,cbm:51.2,drivers:['ADRIAN'],porters:['DAVE'],mileage:82,veh:['PO23 YDN','PO23 YDM'],status:'Billed',billing:[{item:'Origin charge',amt:2991.21},{item:'Mileage',amt:64},{item:'Crates',amt:150},{item:'Overnights',amt:124}],notes:'Multi-day move Mon–Wed. Day 2 two vehicles.',journeyId:'',storageId:'S001',seqInDay:0},
  {id:'J002',ref:'GB2600261-01',brand:'SIRVA',channel:'Partner',jobType:'Door to Door',clientRef:'',moveManager:'',client:'GARNER',origin:'CH7 3DG',dest:'INT STORE',start:'2026-03-02',end:'2026-03-04',vol:1750,cbm:50,drivers:['MARTYN','DAYLE'],porters:['JOE'],mileage:68,veh:['PO23 YDP'],status:'Billed',billing:[{item:'Origin charge',amt:2921.10},{item:'Handling',amt:472.50},{item:'Crate',amt:122}],notes:'1 x crate. Return leg Wednesday with Dayle.',journeyId:'',storageId:'S002',seqInDay:0},
  {id:'J003',ref:'GB2502292-01',brand:'SIRVA',channel:'Partner',jobType:'Door to Door',clientRef:'',moveManager:'',client:'NAQVI',origin:'EX STORE',dest:'Customer Address',start:'2026-03-02',end:'2026-03-03',vol:411,cbm:11.74,drivers:['RAY'],porters:['ALFIE'],mileage:0,veh:[],status:'Completed',billing:[{item:'Handling',amt:110.97}],notes:'Mon 9am, Tue delivery 12:30pm.',journeyId:'',storageId:'',seqInDay:0},
  {id:'J004',ref:'WCHG-TOWNSEND',brand:'MOVESQUAD',channel:'Account',jobType:'Door to Door',clientRef:'',moveManager:'',client:'Mr Townsend',origin:'M23 1HG',dest:'M23 2TU',start:'2026-03-02',end:'2026-03-02',vol:0,cbm:0,drivers:[],porters:[],mileage:4,veh:[],status:'Completed',billing:[{item:'Door to door',amt:448.56}],notes:'Call Chelsea 07766711032 on way.',journeyId:'JRN001',storageId:'',seqInDay:1},
  {id:'J008',ref:'WCHG-PRATT',brand:'MOVESQUAD',channel:'Account',jobType:'Door to Door',clientRef:'',moveManager:'',client:'Mrs Pratt',origin:'M23 2TU',dest:'BL3 4HS',start:'2026-03-02',end:'2026-03-02',vol:0,cbm:0,drivers:[],porters:[],mileage:18,veh:[],status:'Completed',billing:[{item:'Door to door',amt:312.00}],notes:'Picks up from Townsend delivery point.',journeyId:'JRN001',storageId:'',seqInDay:2},
  {id:'J005',ref:'137006A',brand:'EMS',channel:'Account',jobType:'Air',clientRef:'',moveManager:'',client:'Farakh Osman',origin:'BD9 6LH',dest:'INT STORE',start:'2026-03-04',end:'2026-03-04',vol:95,cbm:2.71,drivers:['MARTYN'],porters:[],mileage:55,veh:[],status:'Scheduled',billing:[{item:'Origin charge',amt:0},{item:'Casing x2',amt:84}],notes:'AIR shipment. Origin charge TBC.',journeyId:'JRN002',storageId:'S001',seqInDay:1},
  {id:'J009',ref:'137090B',brand:'EMS',channel:'Account',jobType:'Door to Door',clientRef:'',moveManager:'',client:'P. Akhtar',origin:'BD11 2FA',dest:'LS9 8EQ',start:'2026-03-04',end:'2026-03-04',vol:60,cbm:1.72,drivers:['MARTYN'],porters:[],mileage:14,veh:[],status:'Scheduled',billing:[{item:'Door to door',amt:220.00}],notes:'Back-to-back with Osman. Return to depot after.',journeyId:'JRN002',storageId:'',seqInDay:2},
  {id:'J006',ref:'LDN110738',brand:'STERLING',channel:'Account',jobType:'Other',clientRef:'',moveManager:'',client:'Paul Graham',origin:'DEBRIS',dest:'YO30 7AH',start:'2026-03-04',end:'2026-03-04',vol:0,cbm:0,drivers:[],porters:[],mileage:0,veh:[],status:'Scheduled',billing:[{item:'Debris',amt:96}],notes:'Debris job only.',journeyId:'',storageId:'',seqInDay:0},
  {id:'J007',ref:'156637',brand:'BRITANNIA',channel:'Partner',jobType:'Door to Door',clientRef:'',moveManager:'',client:'Mrs Alcock',origin:'WS9 0EF',dest:'WS9 8DY',start:'2026-03-06',end:'2026-03-06',vol:725,cbm:20.71,drivers:['ADRIAN'],porters:['DAVE'],mileage:6,veh:[],status:'Billed',billing:[{item:'Door to door',amt:1082.40}],notes:'Local move. JOE on holiday this week.',journeyId:'JRN003',storageId:'',seqInDay:1},
  {id:'J010',ref:'156638',brand:'BRITANNIA',channel:'Partner',jobType:'Door to Door',clientRef:'',moveManager:'',client:'Mr Webb',origin:'WS9 8DY',dest:'WV14 0JD',start:'2026-03-06',end:'2026-03-07',vol:310,cbm:8.85,drivers:['ADRIAN'],porters:['DAVE'],mileage:22,veh:[],status:'Billed',billing:[{item:'Door to door',amt:680.00},{item:'Overnight accommodation',amt:130.00}],notes:'Overnight stay in Wolverhampton. Return to depot Fri.',journeyId:'JRN003',storageId:'',seqInDay:2},
];

// ── JOURNEYS ─────────────────────────────────────────────────────────
// Container for multi-job, multi-day runs with shared crew/vehicles.
// jobIds: ordered sequence (chained mileage — each job picks up from prev dest).
// overnights: internal cost tracking (allowance × crew × nights).
//   billingNights: number of nights billed to client (may differ from internal nights).
//   allowancePerPerson: internal cost per person per night (e.g. £65).
var JOURNEYS = [
  {id:'JRN001',ref:'WCHG-RUN-0217',label:'Townsend + Pratt — Same Day',
   jobIds:['J004','J008'],
   crew:[], veh:[],
   overnights:{nights:0,allowancePerPerson:65,billingNights:0},
   notes:'Two deliveries, crew chains from Townsend dest → Pratt origin. Returns to depot after BL3.'},
  {id:'JRN002',ref:'137-RUN-0219',label:'EMS Bradford Double — Same Day',
   jobIds:['J005','J009'],
   crew:['MARTYN'], veh:[],
   overnights:{nights:0,allowancePerPerson:65,billingNights:0},
   notes:'Martyn does Osman origin then Akhtar D2D back-to-back. No overnight needed.'},
  {id:'JRN003',ref:'BRIT-156637-38',label:'Alcock + Webb — Overnight Journey',
   jobIds:['J007','J010'],
   crew:['ADRIAN','DAVE'], veh:[],
   overnights:{nights:1,allowancePerPerson:65,billingNights:1},
   notes:'Day 1: Mrs Alcock (local WS9). Day 2: Mr Webb delivery to Wolverhampton, overnight stay, return Thu.'},
];
var journeySeq = 4;

// ── JOURNEY HELPERS ───────────────────────────────────────────────────
function journeyById(id){ for(var i=0;i<JOURNEYS.length;i++) if(JOURNEYS[i].id===id) return JOURNEYS[i]; return null; }
function jobsInJourney(jrnId){ return jobs.filter(function(j){return j.journeyId===jrnId;}).sort(function(a,b){return a.seqInDay-b.seqInDay||(a.start<b.start?-1:1);}); }

// For a given job and date, how many other jobs share the same crew on the same day?
// Used to split day-rate crew cost equally across same-day jobs.
function sameCrewSameDayCount(job, ds) {
  var crew = job.drivers.concat(job.porters).filter(function(x){return x;});
  if (!crew.length) return 1;
  // Count all jobs on this date that share at least one crew member with job
  var count = 0;
  for (var i = 0; i < jobs.length; i++) {
    var other = jobs[i];
    if (other.start !== ds && other.end !== ds) continue; // same day check
    if (!jobDates(other).some(function(d){return d===ds;})) continue;
    var otherCrew = other.drivers.concat(other.porters).filter(function(x){return x;});
    var shared = crew.some(function(c){ return otherCrew.indexOf(c) >= 0; });
    if (shared) count++;
  }
  return Math.max(1, count);
}

// Overnight internal cost for a journey (allowance × crew × nights)
function journeyOvernightCost(jrn) {
  if (!jrn || !jrn.overnights || !jrn.overnights.nights) return 0;
  var crewCount = jrn.crew.length;
  if (!crewCount) {
    // Fall back to crew on first job
    var first = jobs.filter(function(j){return j.journeyId===jrn.id;})[0];
    if (first) crewCount = first.drivers.concat(first.porters).filter(function(x){return x;}).length;
  }
  return jrn.overnights.nights * jrn.overnights.allowancePerPerson * crewCount;
}

// Chained mileage for journey: warehouse → job1.origin → job1.dest → job2.origin → … → last.dest → warehouse
// Returns array of {from, to, miles} legs
function journeyLegs(jrn) {
  // Multi-day aware route:
  // Day 1:  warehouse → job1.origin → job1.dest → [job2.origin → job2.dest …] (crew stay overnight at last dest)
  // Day N+: last_day_dest → job.origin → job.dest → … (no return to warehouse mid-journey)
  // Last day: … → last_dest → warehouse
  var jjobs = jobsInJourney(jrn.id);
  if (!jjobs.length) return [];

  var wh = APP_SETTINGS.warehouseAddress || SL_CONFIG.companyPostcode || 'WN73EQ';

  // Group jobs by day
  var byDay = {};
  var allDays = [];
  for (var i = 0; i < jjobs.length; i++) {
    var day = jjobs[i].start || '';
    if (!byDay[day]) { byDay[day] = []; allDays.push(day); }
    byDay[day].push(jjobs[i]);
  }
  allDays.sort();

  var legs = [];
  var dayStart = wh; // first day starts from warehouse

  for (var d = 0; d < allDays.length; d++) {
    var dayJobs = byDay[allDays[d]];
    var isLastDay = (d === allDays.length - 1);
    var prev = dayStart;

    for (var i = 0; i < dayJobs.length; i++) {
      var j = dayJobs[i];
      // Travel to job origin if not already there
      if (j.origin && j.origin !== prev) {
        legs.push({ from: prev, to: j.origin, miles: postcodeDistanceMiles(prev, j.origin), day: allDays[d] });
      }
      // Working leg: origin → destination
      if (j.dest && j.dest !== j.origin) {
        var jobMiles = j.mileage || postcodeDistanceMiles(j.origin, j.dest);
        legs.push({ from: j.origin, to: j.dest, miles: jobMiles, day: allDays[d], jobId: j.id });
      }
      prev = j.dest || j.origin || prev;
    }

    if (isLastDay) {
      // Return to warehouse on the final day
      if (prev && prev !== wh) {
        legs.push({ from: prev, to: wh, miles: postcodeDistanceMiles(prev, wh), isReturn: true, day: allDays[d] });
      }
    } else {
      // Crew stay overnight — next day starts from here
      dayStart = prev;
    }
  }

  return legs;
}

function totalJourneyMiles(jrn) {
  return journeyLegs(jrn).reduce(function(s,l){return s+l.miles;},0);
}


var curView = 'week';
var curMod  = 'dashboard';
var curDate = new Date(); // starts at today
var pMode   = 'view';
var eJob    = null;
var dragId  = null;
var TODAY   = d2s(new Date());

// ── HELPERS ───────────────────────────────────────────────────────────
function d2s(d){
  return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());
}
function s2d(s){
  var p=s.split('-'); return new Date(+p[0],+p[1]-1,+p[2]);
}
function pad(n){ return n<10?'0'+n:''+n; }
function addDays(d,n){ var r=new Date(d); r.setDate(r.getDate()+n); return r; }
function fmt(n){ return '£'+(+n||0).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function totalRev(j){ return j.billing.reduce(function(s,b){return s+b.amt;},0); }
function jobDur(j){ return Math.max(1,Math.round((s2d(j.end)-s2d(j.start))/(864e5))+1); }
// ── CREW COST FUNCTIONS ───────────────────────────────────────────────
// chargeRate  = day rate charged out per crew member (used in COS / job margin)
// notionalRate = true cost (basic × holiday × NI × pension) — Finance accounting only

function crewNotionalRate(c) {
  if (!c) return 0;
  if (!c.employed) return c.rate;
  var hol = 1 + (c.holiday || 0) / 100;
  var ni  = 1 + (c.ni      || 0) / 100;
  var pen = 1 + (c.pension || 0) / 100;
  return c.rate * hol * ni * pen;
}

// Breakdown of notional cost components for Finance view
function crewNotionalBreakdown(c, days) {
  if (!c) return {base:0,holAmt:0,niAmt:0,penAmt:0,total:0};
  var d = days || 1;
  if (!c.employed) return {base:c.rate*d,holAmt:0,niAmt:0,penAmt:0,total:c.rate*d,selfEmployed:true};
  var base   = c.rate * d;
  var holAmt = base * (c.holiday || 0) / 100;
  var niAmt  = (base + holAmt) * (c.ni || 0) / 100;
  var penAmt = (base + holAmt) * (c.pension || 0) / 100;
  return {base:base,holAmt:holAmt,niAmt:niAmt,penAmt:penAmt,total:base+holAmt+niAmt+penAmt};
}

// Charge-rate based COS (used in job panel, booking detail, main COS calcs)
// For same-day multi-job sequences, crew cost is split equally across all jobs they appear in that day.
function jobCrewCost(j, splitForDay) {
  var dur = jobDur(j);
  var cost = 0;
  var all = j.drivers.concat(j.porters).filter(function(x){return x;});
  for (var i = 0; i < all.length; i++) {
    var cr = crewByName(all[i]);
    if (!cr) continue;
    var dayRate = (cr.chargeRate || cr.rate);
    if (splitForDay && dur === 1) {
      // Split day rate across all jobs this crew member works on the same day
      var splitCount = sameCrewSameDayCount(j, j.start);
      cost += dayRate / splitCount;
    } else {
      cost += dayRate * dur;
    }
  }
  return cost;
}


// Fuel cost: vehicle mileage rate × job mileage (fallback to stored fuel value)
// Estimate road miles between two UK postcodes using straight-line × 1.3 factor
// Real routing requires an external API call; this gives a reasonable estimate offline
function postcodeDistanceMiles(pc1, pc2) {
  // Postcode sector lookup table (partial — major areas)
  // Returns approx lat/lng from postcode prefix
  function pcLatLng(pc) {
    var areas = {
      'WN':  [53.54, -2.64], 'M':   [53.48, -2.24], 'BL':  [53.58, -2.43],
      'SK':  [53.41, -2.16], 'OL':  [53.54, -2.12], 'PR':  [53.76, -2.70],
      'BB':  [53.75, -2.48], 'FY':  [53.82, -3.05], 'LA':  [54.04, -2.80],
      'CH':  [53.19, -2.89], 'CW':  [53.10, -2.44], 'WA':  [53.39, -2.60],
      'ST':  [52.99, -2.18], 'TF':  [52.69, -2.48], 'WV':  [52.59, -2.12],
      'WS':  [52.58, -1.98], 'DY':  [52.51, -2.09], 'B':   [52.48, -1.89],
      'CV':  [52.41, -1.50], 'NN':  [52.24, -0.89],
      'MK':  [52.04, -0.76], 'LU':  [51.88, -0.42], 'HP':  [51.76, -0.47],
      'AL':  [51.75, -0.24], 'SG':  [51.90, -0.21], 'CM':  [51.74,  0.47],
      'SS':  [51.57,  0.70], 'ME':  [51.40,  0.53], 'TN':  [51.07,  0.29],
      'BN':  [50.83, -0.14], 'PO':  [50.82, -1.08], 'SO':  [50.90, -1.40],
      'SP':  [51.07, -1.79], 'BA':  [51.38, -2.36], 'BS':  [51.45, -2.60],
      'GL':  [51.86, -2.24], 'HR':  [52.06, -2.72], 'SY':  [52.71, -2.75],
      'LD':  [52.24, -3.38], 'SA':  [51.62, -3.94], 'CF':  [51.48, -3.18],
      'NP':  [51.59, -2.99], 'LE':  [52.63, -1.13], 'DE':  [52.92, -1.48],
      'NG':  [52.95, -1.15], 'LN':  [53.23, -0.54], 'PE':  [52.57, -0.24],
      'CB':  [52.21,  0.12], 'IP':  [52.06,  1.16], 'NR':  [52.63,  1.30],
      'NE':  [54.97, -1.61], 'SR':  [54.90, -1.38], 'DH':  [54.78, -1.56],
      'TS':  [54.57, -1.23], 'DL':  [54.52, -1.55], 'HG':  [53.99, -1.54],
      'YO':  [53.96, -1.09], 'LS':  [53.80, -1.55], 'BD':  [53.79, -1.75],
      'HX':  [53.72, -1.86], 'HD':  [53.65, -1.78], 'WF':  [53.68, -1.50],
      'DN':  [53.52, -1.13], 'S':   [53.38, -1.47], 'HU':  [53.74, -0.33],
      'LN2': [53.23, -0.54], 'EX':  [50.72, -3.53], 'TQ':  [50.46, -3.53],
      'PL':  [50.37, -4.14], 'TR':  [50.26, -5.05], 'TA':  [51.02, -3.10],
      'DT':  [50.72, -2.44], 'BH':  [50.72, -1.88], 'GU':  [51.24, -0.57],
      'RG':  [51.46, -1.00], 'SL':  [51.51, -0.60], 'UB':  [51.54, -0.48],
      'HA':  [51.58, -0.34], 'EN':  [51.68, -0.08], 'WD':  [51.66, -0.41],
      'LU2': [51.88, -0.42], 'KT':  [51.37, -0.30], 'SM':  [51.37, -0.19],
      'CR':  [51.37, -0.10], 'BR':  [51.41,  0.02], 'DA':  [51.44,  0.22],
      'E':   [51.52, -0.02], 'EC':  [51.52, -0.09], 'N':   [51.57, -0.11],
      'NW':  [51.55, -0.18], 'W':   [51.51, -0.21], 'SW':  [51.47, -0.19],
      'SE':  [51.47, -0.04], 'WC':  [51.52, -0.12], 'WE':  [51.51, -0.14],
      'EH':  [55.95, -3.19], 'FK':  [56.00, -3.79], 'G':   [55.86, -4.25],
      'PA':  [55.84, -4.43], 'KA':  [55.61, -4.50], 'ML':  [55.77, -3.99],
      'KY':  [56.22, -3.15], 'DD':  [56.46, -3.00], 'PH':  [56.40, -3.44],
      'AB':  [57.14, -2.10], 'IV':  [57.48, -4.22],
    };
    var clean = (pc||'').toUpperCase().replace(/\s/g,'');
    // Try longest prefix first
    for (var len = 4; len >= 1; len--) {
      var key = clean.substr(0, len);
      if (areas[key]) return areas[key];
    }
    return null;
  }
  var ll1 = pcLatLng(pc1), ll2 = pcLatLng(pc2);
  if (!ll1 || !ll2) return null;
  // Haversine
  var R=3959, dLat=(ll2[0]-ll1[0])*Math.PI/180, dLon=(ll2[1]-ll1[1])*Math.PI/180;
  var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(ll1[0]*Math.PI/180)*Math.cos(ll2[0]*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
  var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return Math.round(R*c*1.35); // ×1.35 road factor
}

function jobFuelCost(j) {
  // Use manually stored mileage if set, otherwise fall back to postcodeDistanceMiles estimate
  // Full route for a standalone single-day job: warehouse → origin → dest → warehouse
  // Journey mileage is handled separately via journeyLegs / journeyCOS
  // If this job belongs to a journey, fuel is costed at journey level so return 0 here
  if (j.journeyId) return 0;

  var wh = APP_SETTINGS.warehouseAddress || SL_CONFIG.companyPostcode || 'WN73EQ';

  // Use stored mileage (origin→dest leg only) if set
  // Otherwise estimate all legs via postcode table
  var miles = 0;
  if (j.mileage) {
    // Stored mileage = origin→dest leg. Add warehouse outbound and return legs.
    var outLeg = postcodeDistanceMiles(wh, j.origin || '') || 0;
    var retLeg = postcodeDistanceMiles(j.dest || j.origin || '', wh) || 0;
    miles = outLeg + j.mileage + retLeg;
  } else if (j.origin) {
    var leg1 = postcodeDistanceMiles(wh, j.origin) || 0;
    var leg2 = j.dest ? (postcodeDistanceMiles(j.origin, j.dest) || 0) : 0;
    var leg3 = j.dest ? (postcodeDistanceMiles(j.dest, wh) || 0) : (postcodeDistanceMiles(j.origin, wh) || 0);
    miles = leg1 + leg2 + leg3;
  }

  if (!miles) return j.fuel || 0;

  // Get mileage rate from assigned vehicles
  var vids = j.veh || [];
  var mileRate = 0;
  for (var i = 0; i < vids.length; i++) {
    for (var v = 0; v < VEHICLES.length; v++) {
      if (VEHICLES[v].reg === vids[i] || VEHICLES[v].name === vids[i]) {
        mileRate = Math.max(mileRate, VEHICLES[v].mileRate || 0);
        break;
      }
    }
  }
  if (mileRate === 0) {
    for (var v = 0; v < VEHICLES.length; v++) {
      if (VEHICLES[v].mileRate > 0) { mileRate = VEHICLES[v].mileRate; break; }
    }
  }
  if (mileRate === 0) return j.fuel || 0;

  return Math.round(mileRate * miles * 100) / 100;
}

// Generic COS overhead: cosPerCrewPerDay × crew_count × duration
function jobCOSOverhead(j) {
  // Overhead is per CREW (team) per day — fixed regardless of crew headcount
  var hasCreward = (j.drivers||[]).concat(j.porters||[]).filter(Boolean).length > 0;
  if (!hasCreward) return 0;
  var dur = jobDur(j);
  return dur * (APP_SETTINGS.cosPerCrewPerDay || 125);
}

// Materials cost for a job (j.materials = [{id, qty}])
function jobMatCost(j) {
  if (!j.materials || !j.materials.length) return 0;
  return j.materials.reduce(function(s, bm) {
    var m = MATERIALS.filter(function(x){return x.id===bm.id;})[0];
    return s + (m ? m.unitCost * (bm.qty||0) : 0);
  }, 0);
}

// Full COS for a job: crew (charge rates) + fuel (incl. return) + vehicle day rates + materials + generic overhead
function jobCOS(j) {
  var dur = jobDur(j);
  var crewCost = jobCrewCost(j);
  var fuelCost = jobFuelCost(j);
  // Vehicle day rates for assigned vehicles
  var vehCost = 0;
  var vids = j.veh || [];
  for (var i = 0; i < vids.length; i++) {
    for (var v = 0; v < VEHICLES.length; v++) {
      if (VEHICLES[v].reg === vids[i] || VEHICLES[v].name === vids[i]) {
        vehCost += (VEHICLES[v].dayRate || 0) * dur;
        break;
      }
    }
  }
  var matCost = jobMatCost(j);
  var overhead = jobCOSOverhead(j);
  return crewCost + fuelCost + vehCost + matCost + overhead;
}

// Notional-rate COS for Finance accounting view only
function jobCOSNotional(j) {
  var dur = jobDur(j);
  var cost = 0;
  var all = j.drivers.concat(j.porters);
  for (var i = 0; i < all.length; i++) {
    var cr = crewByName(all[i]);
    if (cr) cost += crewNotionalRate(cr) * dur;
  }
  return cost + jobFuelCost(j);
}
function crewByName(n){
  for(var i=0;i<CREW.length;i++) if(CREW[i].name===n) return CREW[i];
  return null;
}

// ── GLOBAL SENSITIVE VALUE PROTECTION ────────────────────────────────
// spv(html) — wraps any sensitive £/% value; body.vals-visible shows all
function spv(val, id) {
  return '<span class="spv"' + (id ? ' id="' + id + '"' : '') + '>' + val + '</span>';
}
function toggleVals() {
  document.body.classList.toggle('vals-visible');
}
function jobDates(j){
  var ds=[]; var d=s2d(j.start); var e=s2d(j.end);
  while(d<=e){ ds.push(d2s(d)); d=addDays(d,1); }
  return ds;
}
function jobsOnDate(ds){ return jobs.filter(function(j){ return jobDates(j).indexOf(ds)>=0; }); }
function weekMon(d){
  var r=new Date(d); var wd=r.getDay();
  r.setDate(r.getDate()-(wd===0?6:wd-1)); r.setHours(0,0,0,0); return r;
}
function fmtNice(ds){ var d=s2d(ds); return DF[d.getDay()]+' '+d.getDate()+' '+MS[d.getMonth()]+' '+d.getFullYear(); }
function esc(s){ return String(s||'').replace(/&/g,'\x26amp;').replace(/</g,'\x26lt;').replace(/>/g,'\x26gt;').replace(/"/g,'\x26quot;'); }
function toTitleCase(s) {
  // Convert ALL-CAPS or all-lowercase names to Title Case. Mixed-case left alone.
  if (!s) return '';
  var str = String(s);
  var letters = str.replace(/[^A-Za-z]/g, '');
  if (!letters.length) return str;
  var isAllUpper = letters === letters.toUpperCase();
  var isAllLower = letters === letters.toLowerCase();
  if (!isAllUpper && !isAllLower) return str; // already mixed — don't touch
  return str.toLowerCase().replace(/(?:^|[\s\-\/\(])([a-z])/g, function(m, c) { return m.slice(0, -1) + c.toUpperCase(); });
}
function statusCls(s){ return 's-'+s.toLowerCase().replace(/\s+/g,''); }
function brandCls(b){ return BCLS[b]||''; }
function sbadge(s){ return '<span class="sbadge '+statusCls(s)+'">'+esc(s)+'</span>'; }
// bbadge: renders brand as logo pill (with fallback to colour text badge)
// Size: 'sm' = small (used in table cells, chips) | '' = normal
function bbadge(b, size) {
  var col  = BC[b]  || '#888';
  var blt  = BBLT[b]|| '#f0f4ff';
  var btxt = BTXT[b]|| '#333';
  var logo = BLOG[b]|| '';
  if (logo) {
    var imgH = size === 'lg' ? '28px' : size === 'sm' ? '16px' : '20px';
    return '<img src="'+logo+'" alt="'+esc(b)+'" title="'+esc(b)+'" style="height:'+imgH+';width:auto;max-width:'+(size==='lg'?'80px':'54px')+';object-fit:contain;vertical-align:middle;border-radius:3px;display:inline-block">';
  }
  // Fallback: colour text badge
  var fs = size === 'lg' ? '11px' : size === 'sm' ? '9.5px' : '10.5px';
  var pad = size === 'lg' ? '4px 10px' : size === 'sm' ? '2px 5px' : '2px 7px';
  return '<span class="bbadge" style="background:'+blt+';color:'+btxt+';border:1px solid '+col+'33;font-size:'+fs+';font-weight:700;padding:'+pad+'">'+esc(b)+'</span>';
}
function crewAvatar(c, size) {
  var sz = size || 24;
  if (c && c.photo) {
    return '<img src="'+c.photo+'" style="width:'+sz+'px;height:'+sz+'px;border-radius:50%;object-fit:cover;vertical-align:middle;border:1.5px solid rgba(255,255,255,.6)" alt="'+esc(c.name)+'">';
  }
  var col = (c && c.col) ? c.col : '#888';
  var ini = c ? c.name[0] : '?';
  return '<span style="display:inline-flex;align-items:center;justify-content:center;width:'+sz+'px;height:'+sz+'px;border-radius:50%;background:'+col+';color:#fff;font-size:'+Math.round(sz*.42)+'px;font-weight:700;vertical-align:middle;flex-shrink:0;border:1.5px solid rgba(255,255,255,.5)">'+ini+'</span>';
}
function chip(t) {
  var c = crewByName(t);
  var col = (c && c.col) ? c.col : '#888';
  return '<span class="chip" style="background:'+col+'20;color:'+col+';border:1px solid '+col+'40;display:inline-flex;align-items:center;gap:4px;padding:2px 7px 2px 3px;border-radius:20px;font-size:11px;font-weight:600">'+crewAvatar(c,18)+esc(t)+'</span>';
}
function toast(msg){ var t=document.getElementById('toast-el'); t.textContent=msg; t.classList.add('on'); setTimeout(function(){t.classList.remove('on');},2600); }
function el(id){ return document.getElementById(id); }
function setH(id,h){ el(id).innerHTML=h; }
function setBadge(id,n){ var b=el(id); if(!b)return; b.textContent=n; b.classList.toggle('hidden',!n||n<1); }

// ── MODULE NAV ────────────────────────────────────────────────────────
function showMod(mod,btn){
  curMod=mod;
  document.querySelectorAll('.page').forEach(function(p){p.classList.remove('on');});
  document.querySelectorAll('.nb').forEach(function(b){b.classList.remove('on');});
  el('mod-'+mod).classList.add('on');
  btn.classList.add('on');
  var titles={dashboard:'Dashboard',calendar:'Job Calendar',crew:'Crew Scheduler',finance:'Finance & Billing',settings:'Settings',bookings:'Client Records',storage:'Storage',warehouse:'Warehouse'};
  el('tb-title').textContent=titles[mod]||mod;
  syncMobileNav(mod);
  el('vtabs').style.display=(mod==='calendar'||mod==='crew'||mod==='finance')?'flex':'none';
  if(mod==='dashboard') renderDashboard();
  // Update vtab buttons to match module
  var vtabs = document.querySelectorAll('.vt');
  if(mod==='crew'||mod==='finance'){
    vtabs.forEach(function(t){ t.style.display='none'; });
    // Show only week/month/list for crew and finance
    ['week','month','list'].forEach(function(v){
      var btn = document.querySelector('.vt[onclick*="\''+v+'\'"]') || document.querySelector('.vt[onclick*=\'"'+v+'"\']');
      if(btn) btn.style.display='';
    });
  } else {
    vtabs.forEach(function(t){ t.style.display=''; });
  }
  // Hide top cnav for warehouse (it has its own)
  var cnav = document.querySelector('.topbar .cnav');
  if(cnav) cnav.style.display = mod==='warehouse'?'none':'flex';
  if(mod==='crew') renderCrew();
  if(mod==='finance') renderFinance();
  // Show finance-only vtabs
  document.querySelectorAll('.fin-only').forEach(function(b){
    b.style.display = mod==='finance' ? '' : 'none';
  });
  // Hide cal-only vtabs when in finance
  document.querySelectorAll('.vt:not(.fin-only)').forEach(function(b){
    b.style.display = mod==='finance' ? 'none' : '';
  });
  if(mod==='storage') renderStorage();
  if(mod==='calendar') renderCal();
  if(mod!=='finance'){
    document.querySelectorAll('.vt:not(.fin-only)').forEach(function(b){ b.style.display=''; });
    document.querySelectorAll('.fin-only').forEach(function(b){ b.style.display='none'; });
  }
  if(mod==='settings'){ curStab='crew'; renderSettingsCrew(); }
  if(mod==='bookings') initBookingMod();
}

// ── VIEW SWITCHING ────────────────────────────────────────────────────
function setView(v,btn){
  curView=v;
  document.querySelectorAll('.vt').forEach(function(t){t.classList.remove('on');});
  btn.classList.add('on');
  renderActiveMod();
}
function renderCal(){
  if(curView==='week')    renderWeek(false);
  else if(curView==='twoweek') renderWeek(true);
  else if(curView==='day')     renderDay();
  else if(curView==='month')   renderMonth();
  else if(curView==='list')    renderList();
  setBadge('job-badge',jobs.length);
}
function navPrev(){
  if(curView==='month') curDate=new Date(curDate.getFullYear(),curDate.getMonth()-1,1);
  else if(curView==='day') curDate=addDays(curDate,-1);
  else if(curView==='list') curDate=addDays(curDate,-30);
  else if(curView==='twoweek') curDate=addDays(curDate,-14);
  else curDate=addDays(curDate,-7);
  renderActiveMod();
}
function renderActiveMod(){
  if(curMod==='crew') renderCrew();
  else if(curMod==='finance'){
    if(curView==='trends')   renderTrends();
    else if(curView==='forecast') renderForecast();
    else renderFinance();
  }
  else if(curMod==='dashboard') renderDashboard();
  else renderCal();
}
function navNext(){
  if(curView==='month') curDate=new Date(curDate.getFullYear(),curDate.getMonth()+1,1);
  else if(curView==='day') curDate=addDays(curDate,1);
  else if(curView==='list') curDate=addDays(curDate,30);
  else if(curView==='twoweek') curDate=addDays(curDate,14);
  else curDate=addDays(curDate,7);
  renderActiveMod();
}
function goToday(){ curDate=new Date(); renderCal(); }
function jumpDay(ds){
  curDate=s2d(ds);
  curView='day';
  // Update view tab highlight
  var vtabs=document.querySelectorAll('.vt');
  vtabs.forEach(function(t){t.classList.remove('on');});
  // Find the Day button (index 3)
  if(vtabs[3]) vtabs[3].classList.add('on');
  renderCal();
}



// ── CALENDAR — Vertical date-grouped job list ────────────────────────
// All views (Week/2-Week/Month/Day/List) use the same renderer.
// Layout: date section headers, jobs as cards beneath each date.
// Scroll vertically to move through time.

function calRangeForMode(mode) {
  var cols = [], ws, i;
  if (mode === 'week') {
    ws = weekMon(curDate);
    for (i = 0; i < 7; i++) cols.push(addDays(ws, i));
  } else if (mode === 'twoweek') {
    ws = weekMon(curDate);
    for (i = 0; i < 14; i++) cols.push(addDays(ws, i));
  } else if (mode === 'day') {
    cols.push(new Date(curDate));
  } else if (mode === 'month') {
    var yr = curDate.getFullYear(), mo = curDate.getMonth();
    var d = new Date(yr, mo, 1), last = new Date(yr, mo + 1, 0);
    while (d <= last) { cols.push(new Date(d)); d = addDays(d, 1); }
  } else { // list — 90 days from today
    var start = new Date(curDate);
    for (i = 0; i < 90; i++) cols.push(addDays(start, i));
  }
  return cols;
}

function calNavLabel(mode) {
  if (mode === 'week') {
    var ws = weekMon(curDate), e = addDays(ws, 6);
    return MS[ws.getMonth()].substr(0,3) + ' ' + ws.getDate() + ' – ' +
      (ws.getMonth() !== e.getMonth() ? MS[e.getMonth()].substr(0,3) + ' ' : '') +
      e.getDate() + ', ' + e.getFullYear();
  }
  if (mode === 'twoweek') {
    var ws = weekMon(curDate), e = addDays(ws, 13);
    return MS[ws.getMonth()].substr(0,3) + ' ' + ws.getDate() + ' – ' +
      MS[e.getMonth()].substr(0,3) + ' ' + e.getDate() + ', ' + e.getFullYear();
  }
  if (mode === 'day') {
    return DF[curDate.getDay()] + ', ' + curDate.getDate() + ' ' +
      MS[curDate.getMonth()] + ' ' + curDate.getFullYear();
  }
  if (mode === 'month') return MS[curDate.getMonth()] + ' ' + curDate.getFullYear();
  // list
  var e = addDays(new Date(curDate), 89);
  return curDate.getDate() + ' ' + MS[curDate.getMonth()].substr(0,3) + ' – ' +
    e.getDate() + ' ' + MS[e.getMonth()].substr(0,3) + ' ' + e.getFullYear();
}

function renderCalVertical(mode) {
  el('cn-lbl').textContent = calNavLabel(mode);
  var dates = calRangeForMode(mode);

  // Build journey start-date lookup (earliest job start in journey)
  var jrnFirstDate = {};
  for (var ji = 0; ji < JOURNEYS.length; ji++) {
    var jrn = JOURNEYS[ji];
    var earliest = null;
    for (var jj = 0; jj < jrn.jobIds.length; jj++) {
      var jb = jobs.filter(function(x){return x.id === jrn.jobIds[jj];})[0];
      if (jb && (!earliest || jb.start < earliest)) earliest = jb.start;
    }
    jrnFirstDate[jrn.id] = earliest || '';
  }

  var h = '<div class="fade-in">';
  var totalJobs = 0;

  for (var di = 0; di < dates.length; di++) {
    var ds = d2s(dates[di]);
    var dow = dates[di].getDay();
    var isToday = ds === TODAY;
    var isWknd = dow === 0 || dow === 6;

    // Get jobs on this date
    var dj = jobsOnDate(ds);

    // For week/2week/month hide empty weekend days
    if (!dj.length && isWknd && mode !== 'day' && mode !== 'list') continue;

    totalJobs += dj.length;

    // Sort jobs: journeys grouped (by their earliest date + seq), standalone by start
    dj.sort(function(a, b) {
      var aKey = a.journeyId
        ? (jrnFirstDate[a.journeyId] || a.start) + '_' + a.journeyId + '_' + String(a.seqInDay || 0).padStart(3,'0')
        : a.start + '_zzz_' + a.id;
      var bKey = b.journeyId
        ? (jrnFirstDate[b.journeyId] || b.start) + '_' + b.journeyId + '_' + String(b.seqInDay || 0).padStart(3,'0')
        : b.start + '_zzz_' + b.id;
      return aKey < bKey ? -1 : aKey > bKey ? 1 : 0;
    });

    // Day revenue (jobs starting today)
    var dayRev = 0;
    for (var k = 0; k < dj.length; k++) if (dj[k].start === ds) dayRev += totalRev(dj[k]);

    // ── DATE SECTION HEADER ──────────────────────────────────────────
    h += '<div class="cal-date-hdr' + (isToday ? ' today' : '') + (isWknd ? ' weekend' : '') + (!dj.length ? ' empty' : '') + '" onclick="openNew(\'' + ds + '\')">';
    h += '<span class="cdh-dow">' + DS[dates[di].getDay()] + '</span>';
    h += '<span class="cdh-num">' + dates[di].getDate() + '</span>';
    h += '<span class="cdh-mon">' + MS[dates[di].getMonth()].substr(0, 3) + '</span>';
    if (isToday) h += '<span class="cdh-today-pill">TODAY</span>';
    if (dj.length) {
      h += '<span class="cdh-jobs">' + dj.length + ' job' + (dj.length !== 1 ? 's' : '') + '</span>';
      if (dayRev > 0) h += '<span class="cdh-rev">' + spv(fmt(dayRev)) + '</span>';
    }
    h += '<button class="cdh-add" onclick="event.stopPropagation();openNew(\'' + ds + '\')">+ Job</button>';
    h += '</div>';

    if (!dj.length) continue;

    // ── JOB CARDS ────────────────────────────────────────────────────
    var prevJrnId = '';
    for (var ji2 = 0; ji2 < dj.length; ji2++) {
      var j = dj[ji2];
      var jrn = j.journeyId ? journeyById(j.journeyId) : null;
      var color = BC[j.brand] || '#888';
      var crew = j.drivers.concat(j.porters).filter(function(x){return x;});
      var dur = jobDur(j);
      var rev = totalRev(j);
      var isStart = j.start === ds;
      var isCont = !isStart; // job started on a previous day

      // Journey banner — show once per journey per day (on first job of that journey)
      if (jrn && j.journeyId !== prevJrnId) {
        var nightStr = jrn.overnights && jrn.overnights.nights
          ? '&#127769; ' + jrn.overnights.nights + 'n overnight' : '';
        h += '<div class="jrn-banner" id="jbnr-' + jrn.id + '-' + ds + '">';
        h += '<span class="jrn-banner-lbl">&#128648; ' + esc(jrn.label) + '</span>';
        h += '<span class="jrn-banner-ref">' + esc(jrn.ref) + '</span>';
        if (nightStr) h += '<span class="jrn-banner-night">' + nightStr + '</span>';
        h += '<a href="#" style="font-size:9.5px;font-weight:700;color:var(--purple);text-decoration:none;margin-left:auto" ';
        h += 'onclick="event.preventDefault();event.stopPropagation();viewJourney(\'' + jrn.id + '\')">View &#8594;</a>';
        h += '</div>';
        prevJrnId = j.journeyId;
      } else if (!j.journeyId) {
        prevJrnId = '';
      }

      // ── CARD ─────────────────────────────────────────────────────────
      h += '<div class="jcard' + (jrn ? ' in-journey' : '') + '" style="border-left-color:' + color + '" onclick="viewJob(\'' + j.id + '\')" oncontextmenu="quickStatusMenu(event,\'' + j.id + '\')">';

      // ── HEAD ─────────────────────────────────────────────────────────
      h += '<div class="jcard-head">';

      // Zone 1 — Brand logo, hard border isolates it from client name
      h += '<div class="jcard-logo">' + bbadge(j.brand, 'lg') + '</div>';

      // Zone 2 — Client name (title-cased, large) + ref on its own line
      h += '<div class="jcard-title">';
      h += '<div class="jcard-client">' + esc(toTitleCase(j.client)) + '</div>';
      h += '<div class="jcard-ref">' + esc(j.ref) + (isCont ? ' &nbsp;<span style="font-size:10px;font-weight:500;color:var(--t4);font-family:sans-serif">&#8635; continuing</span>' : '') + '</div>';
      h += '</div>'; // jcard-title
      // Zone 3 — Status badge
      var stCls = {'Pending':'st-pending','Confirmed':'st-confirmed','In Progress':'st-inprog','Completed':'st-done','Billed':'st-billed','Cancelled':'st-cancelled'}[j.status]||'st-pending';
      h += '<div class="jcard-status ' + stCls + '">' + (j.status||'Pending') + '</div>';

      // Zone 3 — Flag badges: journey order, storage, multi-day, overnight, air/other type
      h += '<div class="jcard-flags">';
      // Journey order badge — most prominent, always first
      if (jrn && j.seqInDay) {
        h += '<span class="jflag jflag-seq">&#128648; ' + j.seqInDay + ' / ' + jrn.jobIds.length + '</span>';
      }
      // Document readiness indicator
      var cjForCard = j.clientJobId ? CLIENT_JOBS.filter(function(x){return x.id===j.clientJobId;})[0] : null;
      if (cjForCard) {
        var docStatus = spDocReadiness(cjForCard, j.start);
        h += '<span class="jflag doc-status-'+docStatus.cls+'" title="'+esc(docStatus.tip)+'">'+docStatus.icon+'</span>';
      } else {
        h += '<span class="jflag doc-status-grey" title="No client record linked — open job to connect one" style="font-size:10px">📁</span>';
      }
      h += '<div class="jcard-flag-row">';
      if (j.storageId) {
        var stoRec = null;
        for (var si2=0;si2<STORAGE_RECORDS.length;si2++) if(STORAGE_RECORDS[si2].id===j.storageId){stoRec=STORAGE_RECORDS[si2];break;}
        var stoDir = j.storageDirection || (j.dest==='INT STORE'?'in': j.origin&&j.origin.indexOf('EX STORE')===0?'out':null);
        var stoDirIcon = stoDir==='in'?'⬇️':stoDir==='out'?'⬆️':'🏭';
        var stoCtnrs = j.containersToRemove&&j.containersToRemove.length ? j.containersToRemove.join(', ') : (stoRec&&stoRec.containers&&stoRec.containers.length?stoRec.containers.map(function(c){return c.containerNo;}).join(', ').substring(0,20):'');
        h += '<span class="jflag jflag-storage" title="Storage ' + (stoRec?stoRec.id:'') + (stoCtnrs?' ['+stoCtnrs+']':'') + '">' + stoDirIcon + ' ' + (stoRec?stoRec.id:'Store') + (stoCtnrs?' <span style="font-size:9px;opacity:.7">['+esc(stoCtnrs.substring(0,12))+']</span>':'') + '</span>';
      }
      if (dur > 1)                                                  h += '<span class="jflag jflag-multiday" title="' + dur + '-day job">&#128197; ' + dur + 'd</span>';
      if (jrn && jrn.overnights && jrn.overnights.nights > 0)      h += '<span class="jflag jflag-overnight" title="Overnight stay">&#127769; ' + jrn.overnights.nights + 'n</span>';
      if (jrn && !j.seqInDay)                                       h += '<span class="jflag jflag-journey" title="Part of journey ' + esc(jrn.ref) + '">&#128648; Journey</span>';
      h += '</div>';
      h += '</div>'; // jcard-flags

      // Zone 4 — Status + edit button
      h += '<div class="jcard-actions">';
      h += sbadge(j.status);
      h += '<button class="btn btn-g btn-sm" onclick="event.stopPropagation();openEdit(\'' + j.id + '\')" title="Edit" style="padding:4px 9px;font-size:13px">&#9998;</button>';
      h += '</div>'; // jcard-actions

      h += '</div>'; // jcard-head

      // BODY: info grid — route | volume | vehicles | revenue
      h += '<div class="jcard-body">';

      // Column 1: Route
      h += '<div class="jci">';
      h += '<div class="jci-lbl"><span class="ico">&#128205;</span> Route</div>';
      // Format origin — highlight EX STORE
      var originDisplay = j.origin || '—';
      if (j.origin && j.origin.indexOf('EX STORE') === 0) {
        h += '<div class="jci-val route"><span style="color:#007048;font-weight:700">🏭 ' + esc(j.origin) + '</span></div>';
      } else {
        h += '<div class="jci-val route"><strong>' + esc(originDisplay) + '</strong></div>';
      }
      h += '<div style="font-size:10px;color:var(--t4);margin:1px 0">&#8595; to</div>';
      // Format dest — highlight INT STORE with container info if available
      if (j.dest === 'INT STORE') {
        var iRec = j.storageId ? STORAGE_RECORDS.filter(function(s){return s.id===j.storageId;})[0] : null;
        var iCtnrs = iRec && iRec.containers && iRec.containers.length ? iRec.containers.slice(0,2).map(function(c){return c.containerNo;}).join(', ') : '';
        h += '<div class="jci-val route"><span style="color:#0073EA;font-weight:700">🏭 INT STORE</span>';
        if (iCtnrs) h += ' <span style="font-size:10px;color:#7A849E">[' + esc(iCtnrs) + (iRec.containers.length>2?'…':'') + ']</span>';
        else if (iRec) h += ' <span style="font-size:10px;color:#B0B8CC">containers TBA</span>';
        h += '</div>';
      } else {
        h += '<div class="jci-val route"><strong>' + esc(j.dest || '—') + '</strong></div>';
      }
      h += '</div>';

      // Column 2: Job type + volume
      h += '<div class="jci">';
      h += '<div class="jci-lbl"><span class="ico">&#128230;</span> Type &amp; Volume</div>';
      if (j.jobType) h += '<div class="jci-val">' + esc(j.jobType) + '</div>';
      if (j.vol > 0) h += '<div class="jci-val" style="color:var(--t2);">' + j.vol.toLocaleString() + ' ft&#179;</div>';
      else if (j.cbm > 0) h += '<div class="jci-val" style="color:var(--t2);">' + j.cbm + ' CBM</div>';
      else h += '<div class="jci-val" style="color:var(--t4)">—</div>';
      h += '</div>';

      // Column 3: Vehicles
      h += '<div class="jci">';
      h += '<div class="jci-lbl"><span class="ico">&#128652;</span> Vehicle' + (j.veh && j.veh.length > 1 ? 's' : '') + '</div>';
      if (j.veh && j.veh.length) {
        for (var vk = 0; vk < j.veh.length; vk++) {
          h += '<div class="jci-val mono">' + esc(j.veh[vk]) + '</div>';
        }
      } else {
        h += '<div class="jci-val" style="color:var(--t4)">TBA</div>';
      }
      h += '</div>';

      // Column 4: Revenue (financial, hidden behind spv)
      h += '<div class="jci" style="min-width:100px;align-items:flex-end">';
      h += '<div class="jci-lbl"><span class="ico">&#163;</span> Charge</div>';
      if (rev > 0) h += '<div class="jci-val big blue">' + spv(fmt(rev)) + '</div>';
      else h += '<div class="jci-val" style="color:var(--t4)">TBC</div>';
      h += '</div>';

      h += '</div>'; // jcard-body

      // FOOTER: crew chips
      if (crew.length || true) { // always show footer for consistent height
        h += '<div class="jcard-foot">';
        h += '<span class="jcard-foot-lbl"><span class="ico">&#128100;</span> Crew</span>';
        if (crew.length) {
          for (var k = 0; k < crew.length; k++) h += chip(crew[k]);
        } else {
          h += '<span style="font-size:11px;color:var(--t4);font-style:italic">No crew assigned</span>';
        }
        h += '</div>';
      }

      // Send to Crew button — scheduled/confirmed jobs only
      if (j.status === 'Confirmed' || j.status === 'Scheduled' || j.status === 'Provisional') {
        var synced = j.appenateSynced;
        h += '<div style="padding:5px 12px 8px;border-top:1px solid var(--s2);display:flex;align-items:center;justify-content:space-between;gap:8px">';
        h += '<button class="btn btn-s btn-sm" style="font-size:11px;'+(synced?'color:var(--green);border-color:var(--green)':'color:var(--blue)')+'" onclick="event.stopPropagation();sendToCrew(\''+j.id+'\')">';
        h += (synced ? '✅ Re-send to Crew' : '📲 Send to Crew');
        h += '</button>';
        if (synced) h += '<span style="font-size:10px;color:var(--t3)">Appenate ✓</span>';
        h += '</div>';
      }

      h += '</div>'; // jcard
    }

    // Surveys for this date (from SURVEYS array)
    var daySurveys = SURVEYS.filter(function(s){ return s.surveyDate === ds; });
    if (daySurveys.length) {
      h += '<div style="margin-top:6px;border-top:1px dashed #FFD580;padding-top:6px">';
      h += '<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#B07800;margin-bottom:4px">&#128269; Surveys</div>';
      daySurveys.forEach(function(sv) {
        var stCol = sv.status==='Completed'?'#00A86B':sv.status==='No Show'||sv.status==='Cancelled'?'#E44258':'#7A5200';
        h += '<div style="background:#FFFBE6;border:1px solid #FFD580;border-radius:5px;padding:5px 9px;margin-bottom:3px;font-size:11.5px;cursor:pointer" data-svid="'+sv.id+'" onclick="openEditSurvey(this.dataset.svid)">';
        h += '<div style="font-weight:700;color:'+stCol+'">'+(sv.surveyTime?sv.surveyTime+' — ':'')+esc(sv.clientName)+'</div>';
        h += '<div style="color:#B07800;font-size:10.5px">'+esc(sv.brand)+' &middot; '+esc(sv.postcode||'')+(sv.surveyor?' &middot; '+esc(sv.surveyor):'')+'</div>';
        h += '</div>';
      });
      h += '</div>';
    }
  }

  if (!totalJobs) {
    h += '<div class="cal-empty">';
    h += '<div style="font-size:28px;margin-bottom:12px">&#128203;</div>';
    h += '<div style="font-weight:700;font-size:15px;color:var(--t2);margin-bottom:6px">No jobs in this period</div>';
    h += '<div style="font-size:12px;margin-bottom:16px">Dates are shown as section headers above — click any date to add a job.</div>';
    h += '<button class="btn btn-p" onclick="openNew(null)">+ New Job</button></div>';
  }

  h += '<div class="cal-period-end">End of period &mdash; <a href="#" style="color:var(--blue);font-weight:600;text-decoration:none" onclick="event.preventDefault();navNext()">Next &rarr;</a></div>';
  h += '</div>';
  setH('cal-out', h);
}

function renderWeek(is2w) {
  renderCalVertical(is2w ? 'twoweek' : 'week');
}
function renderDay() {
  renderCalVertical('day');
}
function renderMonth() {
  renderCalVertical('month');
}
function renderList() {
  renderCalVertical('list');
}

function calCellClick(e, jid, ds) {
  // Legacy — kept for safety
  e.stopPropagation();
  viewJob(jid);
}






// ── GLOBAL SEARCH ─────────────────────────────────────────────────────
function renderSearchResults(q) {
  var drop = el('search-drop');
  q = (q||'').trim().toLowerCase();
  if (!q || q.length < 2) { drop.innerHTML = ''; return; }

  var results = jobs.filter(function(j){
    return (j.client||'').toLowerCase().indexOf(q) >= 0
        || (j.ref||'').toLowerCase().indexOf(q) >= 0
        || (j.brand||'').toLowerCase().indexOf(q) >= 0
        || (j.origin||'').toLowerCase().indexOf(q) >= 0
        || (j.dest||'').toLowerCase().indexOf(q) >= 0
        || (j.moveManager||'').toLowerCase().indexOf(q) >= 0
        || (j.drivers||[]).some(function(d){ return d.toLowerCase().indexOf(q) >= 0; });
  }).slice(0, 12);

  if (!results.length) {
    drop.innerHTML = '<div style="padding:12px 14px;font-size:12.5px;color:var(--t3)">No results for "'+esc(q)+'"</div>';
    return;
  }

  var h = '';
  results.forEach(function(j){
    var rev = totalRev(j);
    var stCol = {'Pending':'#FF9F00','Confirmed':'#0073EA','In Progress':'#A25DDC','Completed':'#00C875','Billed':'#00C875','Cancelled':'#E44258'}[j.status]||'#ccc';
    h += '<div style="padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--s2)" onmousedown="searchGoToJob(\''+j.id+'\')">'; 
    h += '<div style="flex-shrink:0">'+bbadge(j.brand,'sm')+'</div>';
    h += '<div style="flex:1;min-width:0">';
    h += '<div style="font-size:12.5px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(j.client)+'</div>';
    h += '<div style="font-size:11px;color:var(--t3)">'+esc(j.ref)+' &middot; '+j.start+(j.end && j.end !== j.start?' → '+j.end:'')+'</div>';
    h += '</div>';
    h += '<div style="text-align:right;flex-shrink:0">';
    if (rev) h += '<div style="font-size:12px;font-weight:700;color:var(--t1)">'+fmt(rev)+'</div>';
    h += '<div style="font-size:10px;font-weight:700;color:'+stCol+'">'+j.status+'</div>';
    h += '</div>';
    h += '</div>';
  });
  if (results.length === 12) h += '<div style="padding:8px 12px;font-size:11.5px;color:var(--t3);text-align:center">Showing first 12 results</div>';
  drop.innerHTML = h;
}

function searchGoToJob(jobId) {
  var j = jobs.filter(function(x){ return x.id === jobId; })[0];
  if (!j) return;
  // Clear search
  el('global-search').value = '';
  el('search-drop').innerHTML = '';
  el('search-drop').style.display = 'none';
  // Navigate to calendar at job's date
  curDate = new Date(j.start);
  curView = 'week';
  document.querySelectorAll('.vt').forEach(function(t){ t.classList.remove('on'); });
  var weekBtn = document.querySelector('.vt[onclick*="week"]');
  if (weekBtn) weekBtn.classList.add('on');
  showMod('calendar', el('nb-calendar'));
  // Open job panel
  setTimeout(function(){ viewJob(jobId); }, 100);
}

// ── DASHBOARD ─────────────────────────────────────────────────────────
function renderDashboard() {
  var now = new Date();
  var todayStr = d2s(now);
  var thisMonStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
  var thisYearStr = String(now.getFullYear());

  // Today's jobs
  var todayJobs = jobs.filter(function(j){ return jobDates(j).indexOf(todayStr) >= 0; });

  // This week's jobs
  var wkMon = weekMon(now), wkSun = addDays(wkMon, 6);
  var wkMonStr = d2s(wkMon), wkSunStr = d2s(wkSun);
  var weekJobs = jobs.filter(function(j){
    var dates = jobDates(j);
    return dates.some(function(d){ return d >= wkMonStr && d <= wkSunStr; });
  });

  // This month revenue
  var monthJobs = jobs.filter(function(j){ return j.start.substr(0,7) === thisMonStr; });
  var monthRev = monthJobs.reduce(function(s,j){ return s + totalRev(j); }, 0);
  var monthBilled = monthJobs.filter(function(j){ return j.status === 'Billed'; }).reduce(function(s,j){ return s + totalRev(j); }, 0);

  // Unbilled jobs (completed but not billed)
  var unbilled = jobs.filter(function(j){ return j.status === 'Completed' && totalRev(j) > 0; });

  // Unconfirmed upcoming jobs (start >= today, status Pending)
  var unconfirmed = jobs.filter(function(j){ return j.start >= todayStr && j.status === 'Pending'; });

  // Jobs needing crew (start in next 7 days, no drivers assigned)
  var needCrew = jobs.filter(function(j){
    return j.start >= todayStr && j.start <= wkSunStr && (!j.drivers || !j.drivers.length);
  });

  // Crew utilisation this week
  var crewUtil = {};
  CREW.forEach(function(c){
    var days = 0;
    for(var i=0;i<7;i++){
      var ds = d2s(addDays(wkMon,i));
      if(jobs.some(function(j){ return j.drivers.concat(j.porters||[]).indexOf(c.name)>=0 && jobDates(j).indexOf(ds)>=0; })) days++;
    }
    crewUtil[c.name] = days;
  });

  // Tomorrow's jobs
  var tmrStr = d2s(addDays(now,1));
  var tmrJobs = jobs.filter(function(j){ return jobDates(j).indexOf(tmrStr) >= 0; });

  var h = '<div style="max-width:1100px;margin:0 auto">';

  // ── TOP KPI STRIP ──────────────────────────────────────────────────
  h += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px">';
  var kpis = [
    {label:"Today's Jobs",    val:todayJobs.length,         sub:'on the board today',        col:'var(--blue)'},
    {label:'This Week',       val:weekJobs.length,          sub:'jobs this week',             col:'var(--purple)'},
    {label:'Month Revenue',   val:fmt(monthRev),            sub:monthJobs.length+' jobs',     col:'var(--green)'},
    {label:'Pending Billing', val:unbilled.length,          sub:'completed, not billed',      col:unbilled.length>0?'var(--amber)':'var(--green)'},
  ];
  kpis.forEach(function(k){
    h += '<div style="background:var(--w);border-radius:10px;padding:16px 18px;border:1px solid var(--b1)">';
    h += '<div style="font-size:11px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px">'+k.label+'</div>';
    h += '<div style="font-size:26px;font-weight:800;color:'+k.col+';line-height:1">'+k.val+'</div>';
    h += '<div style="font-size:11.5px;color:var(--t3);margin-top:5px">'+k.sub+'</div>';
    h += '</div>';
  });
  h += '</div>';

  // ── TWO COL ROW ────────────────────────────────────────────────────
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px">';

  // Today's jobs list
  h += '<div style="background:var(--w);border-radius:10px;border:1px solid var(--b1);overflow:hidden">';
  h += '<div style="padding:12px 16px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between">';
  h += '<div style="font-weight:700;font-size:13.5px">Today — '+fmtDateLong(now)+'</div>';
  h += '<span style="font-size:11px;color:var(--t3)">'+todayJobs.length+' jobs</span></div>';
  if (!todayJobs.length) {
    h += '<div style="padding:24px;text-align:center;color:var(--t3);font-size:12.5px">No jobs scheduled today</div>';
  } else {
    h += '<div style="overflow:auto;max-height:240px">';
    todayJobs.forEach(function(j){
      var stCol = {'Pending':'var(--amber)','Confirmed':'var(--blue)','In Progress':'var(--purple)','Completed':'var(--green)','Billed':'var(--green)','Cancelled':'var(--red)'}[j.status]||'var(--t4)';
      h += '<div style="padding:9px 16px;border-bottom:1px solid var(--s2);display:flex;align-items:center;gap:10px;cursor:pointer" onclick="viewJob(\''+j.id+'\');showMod(\'calendar\',el(\'nb-calendar\'))">';
      h += bbadge(j.brand,'sm');
      h += '<div style="flex:1;min-width:0"><div style="font-weight:600;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(j.client)+'</div>';
      h += '<div style="font-size:11px;color:var(--t3)">'+esc(j.origin||'')+(j.dest?' → '+esc(j.dest):'')+'</div></div>';
      h += '<div style="font-size:11px;font-weight:700;color:'+stCol+'">'+j.status+'</div>';
      h += '</div>';
    });
    h += '</div>';
  }
  h += '</div>';

  // Tomorrow's jobs
  h += '<div style="background:var(--w);border-radius:10px;border:1px solid var(--b1);overflow:hidden">';
  h += '<div style="padding:12px 16px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between">';
  h += '<div style="font-weight:700;font-size:13.5px">Tomorrow — '+fmtDateLong(addDays(now,1))+'</div>';
  h += '<span style="font-size:11px;color:var(--t3)">'+tmrJobs.length+' jobs</span></div>';
  if (!tmrJobs.length) {
    h += '<div style="padding:24px;text-align:center;color:var(--t3);font-size:12.5px">No jobs scheduled tomorrow</div>';
  } else {
    h += '<div style="overflow:auto;max-height:240px">';
    tmrJobs.forEach(function(j){
      var stCol = {'Pending':'var(--amber)','Confirmed':'var(--blue)','In Progress':'var(--purple)','Completed':'var(--green)','Billed':'var(--green)','Cancelled':'var(--red)'}[j.status]||'var(--t4)';
      h += '<div style="padding:9px 16px;border-bottom:1px solid var(--s2);display:flex;align-items:center;gap:10px;cursor:pointer" onclick="viewJob(\''+j.id+'\');showMod(\'calendar\',el(\'nb-calendar\'))">';
      h += bbadge(j.brand,'sm');
      h += '<div style="flex:1;min-width:0"><div style="font-weight:600;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(j.client)+'</div>';
      h += '<div style="font-size:11px;color:var(--t3)">'+esc(j.origin||'')+(j.dest?' → '+esc(j.dest):'')+'</div></div>';
      h += '<div style="font-size:11px;font-weight:700;color:'+stCol+'">'+j.status+'</div>';
      h += '</div>';
    });
    h += '</div>';
  }
  h += '</div>';

  h += '</div>'; // two col

  // ── BOTTOM ROW ─────────────────────────────────────────────────────
  h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px">';

  // Actions needed — persistent alerts
  h += '<div style="background:var(--w);border-radius:10px;border:1px solid var(--b1);overflow:hidden">';
  h += '<div style="padding:12px 16px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between">';
  h += '<div style="font-weight:700;font-size:13.5px">Needs Attention</div>';
  h += '<button onclick="dismissedAlerts={};saveData(\'settings\');renderDashboard()" style="font-size:10.5px;color:var(--t3);background:none;border:none;cursor:pointer;padding:2px 6px">Reset all</button>';
  h += '</div>';
  h += '<div style="padding:6px 0" id="alerts-body">';
  var allAlerts = [];
  if (unbilled.length)    allAlerts.push({id:'unbilled',   col:'var(--amber)', icon:'£', text:unbilled.length+' job'+(unbilled.length>1?'s':'')+' completed but not billed', mod:'finance'});
  if (unconfirmed.length) allAlerts.push({id:'unconfirmed',col:'var(--blue)',  icon:'?', text:unconfirmed.length+' upcoming job'+(unconfirmed.length>1?'s':'')+' unconfirmed', mod:'calendar'});
  if (needCrew.length)    allAlerts.push({id:'needcrew',   col:'var(--red)',   icon:'!', text:needCrew.length+' job'+(needCrew.length>1?'s':'')+' this week with no crew', mod:'crew'});
  // Today/tomorrow surveys
  var todaySurveys = SURVEYS.filter(function(s){ return s.surveyDate === todayStr; });
  var tmrSurveys   = SURVEYS.filter(function(s){ return s.surveyDate === tmrStr; });
  if (todaySurveys.length) allAlerts.push({id:'survey-today', col:'var(--amber)', icon:'🔍', text:todaySurveys.length+' survey'+(todaySurveys.length>1?'s':'')+' today', mod:'calendar'});
  if (tmrSurveys.length)   allAlerts.push({id:'survey-tmr',   col:'var(--t3)',    icon:'🔍', text:tmrSurveys.length+' survey'+(tmrSurveys.length>1?'s':'')+' tomorrow', mod:'calendar'});

  var visibleAlerts = allAlerts.filter(function(a){ return !dismissedAlerts[a.id]; });
  if (!visibleAlerts.length) {
    h += '<div style="padding:14px 16px;text-align:center;color:var(--green);font-size:12.5px;font-weight:600">✓ Everything looks good</div>';
  } else {
    visibleAlerts.forEach(function(a){
      h += '<div style="padding:8px 14px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--s2)">';
      h += '<div style="width:22px;height:22px;border-radius:50%;background:'+a.col+';color:#fff;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0">'+a.icon+'</div>';
      h += '<div style="font-size:12.5px;color:var(--t1);flex:1;cursor:'+(a.mod?'pointer':'default')+'" '+(a.mod?'onclick="showMod(\''+a.mod+'\',el(\'nb-'+a.mod+'\'))"':'')+'>'+a.text+'</div>';
      h += '<button onclick="dismissAlert(\''+a.id+'\',this)" style="font-size:10px;color:var(--t3);background:var(--s1);border:1px solid var(--b1);border-radius:4px;padding:3px 8px;cursor:pointer;white-space:nowrap">✓ Done</button>';
      h += '</div>';
    });
  }
  h += '</div></div>';

  // Crew utilisation this week
  h += '<div style="background:var(--w);border-radius:10px;border:1px solid var(--b1);overflow:hidden">';
  h += '<div style="padding:12px 16px;border-bottom:1px solid var(--b1)"><div style="font-weight:700;font-size:13.5px">Crew This Week</div></div>';
  h += '<div style="padding:10px 0">';
  CREW.forEach(function(c){
    var days = crewUtil[c.name] || 0;
    var pct = Math.round(days/5*100);
    var col = pct>=80?'var(--green)':pct>=40?'var(--blue)':'var(--t4)';
    h += '<div style="padding:5px 16px;display:flex;align-items:center;gap:10px">';
    h += crewAvatar(c,22);
    h += '<div style="font-size:12.5px;font-weight:600;width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+c.name+'</div>';
    h += '<div style="flex:1;background:var(--s2);border-radius:4px;height:6px"><div style="width:'+pct+'%;background:'+col+';height:6px;border-radius:4px"></div></div>';
    h += '<div style="font-size:11px;color:var(--t3);width:30px;text-align:right">'+days+'/5</div>';
    h += '</div>';
  });
  h += '</div></div>';

  // Month revenue by brand
  h += '<div style="background:var(--w);border-radius:10px;border:1px solid var(--b1);overflow:hidden">';
  h += '<div style="padding:12px 16px;border-bottom:1px solid var(--b1)"><div style="font-weight:700;font-size:13.5px">Month Revenue by Brand</div></div>';
  h += '<div style="padding:10px 16px">';
  var byBrand = {};
  monthJobs.forEach(function(j){ byBrand[j.brand] = (byBrand[j.brand]||0) + totalRev(j); });
  var maxB = Math.max.apply(null, Object.values(byBrand).concat([1]));
  Object.keys(byBrand).sort(function(a,b){ return byBrand[b]-byBrand[a]; }).slice(0,6).forEach(function(b){
    var v = byBrand[b];
    h += '<div style="margin-bottom:8px">';
    h += '<div style="display:flex;justify-content:space-between;font-size:11.5px;margin-bottom:3px">';
    h += '<span>'+bbadge(b,'sm')+'</span><span style="font-weight:700">'+fmt(v)+'</span></div>';
    h += '<div style="background:var(--s2);border-radius:4px;height:5px"><div style="width:'+Math.round(v/maxB*100)+'%;background:'+(BC[b]||'#aaa')+';height:5px;border-radius:4px"></div></div>';
    h += '</div>';
  });
  h += '</div></div>';

  h += '</div>'; // bottom row
  h += '</div>'; // max-width wrapper

  el('dashboard-body').innerHTML = h;
}

function dismissAlert(id, btn) {
  dismissedAlerts[id] = true;
  // Save to APP_SETTINGS so it persists
  APP_SETTINGS.dismissedAlerts = dismissedAlerts;
  saveData('settings');
  // Remove from UI immediately
  var row = btn.closest ? btn.closest('[style*="border-bottom"]') : btn.parentNode;
  if (row) row.style.display = 'none';
  // Refresh alert count
  var body = el('alerts-body');
  if (body) {
    var visible = body.querySelectorAll('[style*="display: none"]');
    if (body.querySelectorAll('button[onclick*="dismissAlert"]').length === visible.length) {
      body.innerHTML = '<div style="padding:14px 16px;text-align:center;color:var(--green);font-size:12.5px;font-weight:600">✓ Everything looks good</div>';
    }
  }
}

function fmtDateLong(d) {
  var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  return days[d.getDay()] + ' ' + d.getDate() + ' ' + months[d.getMonth()];
}

// ── CREW VIEW ─────────────────────────────────────────────────────────
function renderCrew(){
  el('cn-lbl').textContent = calNavLabel(curView);
  var ws=weekMon(curDate);
  var cols=[];
  for(var i=0;i<7;i++) cols.push(addDays(ws,i));
  var h='<table class="crew-table fade-in"><thead><tr><th style="width:155px">Crew</th>';
  for(var ci=0;ci<cols.length;ci++) h+='<th>'+DS[cols[ci].getDay()]+' '+cols[ci].getDate()+'</th>';
  h+='</tr></thead><tbody>';
  for(var ci2=0;ci2<CREW.length;ci2++){
    var c=CREW[ci2];
    var worked=0;
    for(var i=0;i<cols.length;i++){
      var ds=d2s(cols[i]);
      var hol=(HOL[c.name]||[]).indexOf(ds)>=0;
      if(!hol && jobs.some(function(j){ return j.drivers.concat(j.porters).indexOf(c.name)>=0 && jobDates(j).indexOf(ds)>=0; })) worked++;
    }
    var util=Math.round(worked/7*100);
    var ucol=util>80?'var(--red)':util>50?'var(--amber)':'var(--blue)';
    h+='<tr>';
    h+='<td class="crew-nm-td"><div style="display:flex;align-items:center;gap:8px">';
    h+=crewAvatar(c,28);
    h+='<div><div style="font-weight:600;font-size:13px">'+c.name+'</div>';
    h+='<div style="font-size:10px;color:var(--t3)">'+c.role+'</div>';
    // rate hidden from main scheduler view
    h+='<div class="ubar"><div class="ufill" style="width:'+util+'%;background:'+ucol+'"></div></div>';
    h+='</div></div></td>';
    for(var ci3=0;ci3<cols.length;ci3++){
      var ds=d2s(cols[ci3]);
      var isHol=(HOL[c.name]||[]).indexOf(ds)>=0;
      var cname=c.name;
      var dayJ=jobs.filter(function(j){ return j.drivers.concat(j.porters).indexOf(cname)>=0 && jobDates(j).indexOf(ds)>=0; });
      h+='<td class="crew-day-td">';
      if(isHol){ h+='<div class="c-hol">&#127958; Holiday</div>'; }
      else if(dayJ.length){
        for(var ji=0;ji<dayJ.length;ji++){
          var stDot={'Pending':'#FF9F00','Confirmed':'#0073EA','In Progress':'#A25DDC','Completed':'#00C875','Billed':'#00C875','Cancelled':'#E44258'}[dayJ[ji].status]||'#ccc';
          h+='<div class="cassign" style="background:'+BBLT[dayJ[ji].brand]+';color:'+BTXT[dayJ[ji].brand]+'" onclick="viewJob(\''+dayJ[ji].id+'\')" oncontextmenu="quickStatusMenu(event,\''+dayJ[ji].id+'\')" title="'+esc(dayJ[ji].client)+'"><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:'+stDot+';margin-right:4px;flex-shrink:0"></span>'+esc(dayJ[ji].client.length>14?dayJ[ji].client.substr(0,13)+'&hellip;':dayJ[ji].client)+'</div>';
        }
      } else { h+='<span class="c-off">&mdash;</span>'; }
      h+='</td>';
    }
    h+='</tr>';
  }
  h+='</tbody></table>';
  // Crew summary cards
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:14px 18px;background:var(--bg)">';
  h+='<div class="fc"><div class="fc-head"><div class="fc-title">Crew Summary</div></div><div class="fc-body">';
  for(var ci2=0;ci2<CREW.length;ci2++){
    var c=CREW[ci2];
    var assigned=jobs.filter(function(jj){ return jj.drivers.concat(jj.porters).indexOf(c.name)>=0; });
    h+='<div class="fin-row"><div class="fin-lbl" style="display:flex;align-items:center;gap:7px"><div class="crew-av" style="background:'+c.col+';width:20px;height:20px;font-size:9px">'+c.name[0]+'</div><span>'+c.name+'</span><span style="font-size:10px;color:var(--t3)">'+c.role+'</span></div>';
    h+='<div class="fin-val">'+assigned.length+' job'+(assigned.length!==1?'s':'')+'</div></div>';
  }
  h+='</div></div>';
  h+='<div class="fc"><div class="fc-head"><div class="fc-title">Holiday Notes</div></div><div class="fc-body">';
  h+='<div style="background:var(--rlt);border:1px solid #FFCCD3;border-radius:var(--r);padding:9px 11px;margin-bottom:10px"><div style="font-weight:600;color:var(--red);font-size:12.5px">JOE &mdash; On Holiday</div><div style="font-size:11.5px;color:var(--t2);margin-top:2px">Thu 20 &ndash; Sat 22 Feb 2025</div></div>';
  h+='<div style="font-size:12px;color:var(--t3)">No other conflicts detected this week.</div>';
  h+='</div></div></div>';
  setH('crew-out',h);
}

// ── FINANCE VIEW ──────────────────────────────────────────────────────
var finPeriod = 'month';
var dismissedAlerts = {}; // persisted in APP_SETTINGS // 'week','month','year','all'

function finJobsInPeriod() {
  var now = new Date();
  var from, to;
  if (finPeriod === 'week') {
    from = d2s(weekMon(now));
    to   = d2s(addDays(weekMon(now), 6));
  } else if (finPeriod === 'month') {
    from = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-01';
    to   = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-31';
  } else if (finPeriod === 'year') {
    from = now.getFullYear() + '-01-01';
    to   = now.getFullYear() + '-12-31';
  } else {
    return jobs;
  }
  return jobs.filter(function(j){ return j.start >= from && j.start <= to; });
}

function renderFinance(){
  el('cn-lbl').textContent = calNavLabel(curView);
  var fJobs = finJobsInPeriod();

  var gross=0,billed=0,pending=0;
  for(var i=0;i<fJobs.length;i++){
    var t=totalRev(fJobs[i]);
    gross+=t;
    if(fJobs[i].status==='Billed') billed+=t; else pending+=t;
  }
  var avg=fJobs.length?gross/fJobs.length:0;
  var totalCrew=0,totalFuel=0,totalVeh=0,totalMat=0,totalOverhead=0;
  for(var i=0;i<fJobs.length;i++){
    totalCrew+=jobCrewCost(fJobs[i]);
    totalFuel+=jobFuelCost(fJobs[i]);
    totalVeh+=0; // calculated inline below
    totalMat+=jobMatCost(fJobs[i]);
    totalOverhead+=jobCOSOverhead(fJobs[i]);
    // vehicle cost
    var jv=fJobs[i].veh||[];
    var dur3=jobDur(fJobs[i]);
    for(var vi3=0;vi3<jv.length;vi3++){
      for(var vv3=0;vv3<VEHICLES.length;vv3++){
        if(VEHICLES[vv3].reg===jv[vi3]||VEHICLES[vv3].name===jv[vi3]){ totalVeh+=(VEHICLES[vv3].dayRate||0)*dur3; break; }
      }
    }
  }
  var totalCOS=totalCrew+totalFuel+totalVeh+totalMat+totalOverhead;
  var gMargin=gross-totalCOS;
  var mPct=gross>0?gMargin/gross*100:0;
  var mCol=mPct>=30?'var(--green)':mPct>=15?'var(--amber)':'var(--red)';

  var byBrand={};
  for(var i=0;i<fJobs.length;i++){
    var t=totalRev(fJobs[i]);
    byBrand[fJobs[i].brand]=(byBrand[fJobs[i].brand]||0)+t;
  }
  var maxB=0;
  for(var b in byBrand) if(byBrand[b]>maxB) maxB=byBrand[b];
  if(!maxB) maxB=1;

  // Period selector
  var periods = [['week','This Week'],['month','This Month'],['year','This Year'],['all','All Time']];
  var h = '<div style="display:flex;gap:6px;padding:14px 16px 0;flex-shrink:0">';
  for(var pi=0;pi<periods.length;pi++){
    var pv=periods[pi][0], pl=periods[pi][1];
    h += '<button class="vt'+(finPeriod===pv?' on':'')+'" onclick="finPeriod=\''+pv+'\';renderFinance()">'+pl+'</button>';
  }
  h += '</div>';
  h+='<div class="fin-stats fade-in">';
  h+='<div class="fstat c-b"><div class="fstat-l">Gross Revenue</div><div class="fstat-v">'+fmt(gross)+'</div><div class="fstat-s">'+(fJobs.length)+' jobs</div></div>';
  h+='<div class="fstat c-g"><div class="fstat-l">Invoiced</div><div class="fstat-v">'+fmt(billed)+'</div><div class="fstat-s">Status: Billed</div></div>';
  h+='<div class="fstat c-a"><div class="fstat-l">Pending</div><div class="fstat-v">'+fmt(pending)+'</div><div class="fstat-s">Not yet billed</div></div>';
  h+='<div class="fstat c-p"><div class="fstat-l">Avg Job Value</div><div class="fstat-v">'+fmt(avg)+'</div><div class="fstat-s">Per job</div></div>';
  h+='</div>';

  h+='<div class="fin-2col">';
  // Brand revenue
  h+='<div class="fc"><div class="fc-head"><div class="fc-title">Revenue by Brand</div></div><div class="fc-body">';
  var brands=Object.keys(byBrand).sort(function(a,b){return byBrand[b]-byBrand[a];});
  for(var bi=0;bi<brands.length;bi++){
    var b=brands[bi], v=byBrand[b];
    h+='<div class="brr">';
    h+='<div class="brr-nm">'+bbadge(b)+'</div>';
    h+='<div class="brr-bar"><div class="brr-fill" style="width:'+Math.round(v/maxB*100)+'%;background:'+BC[b]+'"></div></div>';
    h+='<div class="brr-val">'+fmt(v)+'</div>';
    h+='<div class="brr-pct">'+Math.round(v/gross*100)+'%</div>';
    h+='</div>';
  }
  h+='</div></div>';
  // Margin
  h+='<div class="fc"><div class="fc-head"><div class="fc-title">Gross Margin</div><span style="font-size:11px;color:var(--t3)">All COS categories included</span></div><div class="fc-body">';
  h+='<div style="display:flex;align-items:center;gap:18px;margin-bottom:14px">';
  h+='<div><div style="font-weight:700;font-size:36px;letter-spacing:-1px;color:'+mCol+'">'+mPct.toFixed(1)+'%</div><div style="font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);margin-top:3px">Gross Margin</div></div>';
  h+='<div style="flex:1;border-left:1px solid var(--b1);padding-left:18px">';
  h+='<div class="fin-row"><span class="fin-lbl">Revenue</span><span class="fin-val" style="color:var(--green)">'+spv(fmt(gross))+'</span></div>';
  h+='<div class="fin-row"><span class="fin-lbl">Crew (charge rates)</span><span class="fin-val" style="color:var(--red)">&minus;'+spv(fmt(totalCrew),'fin-crew')+'</span></div>';
  h+='<div class="fin-row"><span class="fin-lbl">Vehicles (day rates)</span><span class="fin-val" style="color:var(--red)">&minus;'+spv(fmt(totalVeh))+'</span></div>';
  h+='<div class="fin-row"><span class="fin-lbl">Fuel / Mileage (incl. return)</span><span class="fin-val" style="color:var(--red)">&minus;'+spv(fmt(totalFuel))+'</span></div>';
  h+='<div class="fin-row"><span class="fin-lbl">Materials</span><span class="fin-val" style="color:var(--red)">&minus;'+spv(fmt(totalMat))+'</span></div>';
  h+='<div class="fin-row"><span class="fin-lbl">General Overhead (COS)</span><span class="fin-val" style="color:var(--red)">&minus;'+spv(fmt(totalOverhead))+'</span></div>';
  h+='<div class="fin-row" style="font-weight:700;border-top:2px solid var(--t1);padding-top:7px;margin-top:3px"><span>Margin</span><span style="color:'+mCol+'">'+spv(fmt(gMargin),'fin-margin')+'</span></div>';
  h+='</div></div></div></div>';
  h+='</div>';

  // Job cost breakdown
  h+='<div class="fc" style="margin-bottom:12px"><div class="fc-head"><div class="fc-title">Job Cost Breakdown</div><span style="font-size:11px;color:var(--t3)">Full COS: crew + vehicles + fuel + materials + overhead</span></div>';
  h+='<div style="overflow-x:auto"><table class="ctable"><thead><tr>';
  var ths=['Client','Brand','Days','Crew','Vehicles','Fuel','Materials','Overhead','Total COS','Revenue','Margin','%'];
  for(var ti=0;ti<ths.length;ti++) h+='<th>'+ths[ti]+'</th>';
  h+='</tr></thead><tbody>';
  var totCrew2=0, totFuel2=0, totVeh2=0, totMat2=0, totOvhd2=0, totCOS2=0, totRev2=0;
  for(var i=0;i<jobs.length;i++){
    var j=jobs[i];
    var dur=jobDur(j);
    var cc=jobCrewCost(j);
    var fu=jobFuelCost(j);
    var vc=0; var jveh=j.veh||[];
    for(var vi4=0;vi4<jveh.length;vi4++){
      for(var vv4=0;vv4<VEHICLES.length;vv4++){
        if(VEHICLES[vv4].reg===jveh[vi4]||VEHICLES[vv4].name===jveh[vi4]){ vc+=(VEHICLES[vv4].dayRate||0)*dur; break; }
      }
    }
    var mc2=jobMatCost(j);
    var oh=jobCOSOverhead(j);
    var cos=jobCOS(j);
    var rv=totalRev(j);
    var m=rv>0?(rv-cos)/rv*100:null;
    var mcl=m===null?'color:var(--t3)':m>=30?'color:var(--green)':m>=15?'color:var(--amber)':'color:var(--red)';
    var crew=j.drivers.concat(j.porters).filter(function(x){return x;});
    totCrew2+=cc; totFuel2+=fu; totVeh2+=vc; totMat2+=mc2; totOvhd2+=oh; totCOS2+=cos; totRev2+=rv;
    h+='<tr onclick="viewJob(\''+j.id+'\')">';
    h+='<td style="font-weight:600">'+esc(j.client)+'</td>';
    h+='<td>'+bbadge(j.brand)+'</td>';
    h+='<td style="font-weight:700">'+dur+'d</td>';
    h+='<td>';
    for(var k=0;k<crew.length;k++) h+=chip(crew[k]);
    if(!crew.length) h+='&mdash;';
    h+='</td>';
    h+='<td style="font-weight:600;color:var(--red)">'+spv(fmt(cc),'ft-cc-'+j.id)+'</td>';
    h+='<td style="color:var(--red)">'+(vc>0?spv(fmt(vc)):'&mdash;')+'</td>';
    h+='<td>'+spv(fmt(fu),'ft-fu-'+j.id)+'</td>';
    h+='<td>'+(mc2>0?spv(fmt(mc2)):'&mdash;')+'</td>';
    h+='<td>'+spv(fmt(oh))+'</td>';
    h+='<td style="font-weight:700;color:var(--red)">'+spv(fmt(cos),'ft-cos-'+j.id)+'</td>';
    h+='<td style="font-weight:600;color:var(--blue)">'+(rv>0?fmt(rv):'TBC')+'</td>';
    h+='<td style="font-weight:700;'+mcl+'">'+(m!==null?spv(fmt(rv-cos),'ft-mg-'+j.id):'&mdash;')+'</td>';
    h+='<td style="font-weight:700;'+mcl+'">'+(m!==null?m.toFixed(1)+'%':'&mdash;')+'</td>';
    h+='</tr>';
  }
  h+='</tbody><tfoot><tr>';
  h+='<td colspan="4">TOTALS</td>';
  h+='<td style="color:var(--red)">'+spv(fmt(totCrew2))+'</td>';
  h+='<td style="color:var(--red)">'+(totVeh2>0?spv(fmt(totVeh2)):'&mdash;')+'</td>';
  h+='<td>'+spv(fmt(totFuel2))+'</td>';
  h+='<td>'+(totMat2>0?spv(fmt(totMat2)):'&mdash;')+'</td>';
  h+='<td>'+spv(fmt(totOvhd2))+'</td>';
  h+='<td style="color:var(--red);font-weight:700">'+spv(fmt(totCOS2))+'</td>';
  h+='<td style="color:var(--blue)">'+spv(fmt(totRev2))+'</td>';
  var tm=totRev2>0?(totRev2-totCOS2)/totRev2*100:0;
  var tmc=tm>=30?'color:var(--green)':tm>=15?'color:var(--amber)':'color:var(--red)';
  h+='<td style="'+tmc+'">'+spv(fmt(totRev2-totCOS2))+'</td><td style="'+tmc+'">'+spv(tm.toFixed(1)+'%')+'</td>';
  h+='</tr></tfoot></table></div></div>';

  // Invoice tracker
  h+='<div class="fc"><div class="fc-head"><div class="fc-title">Invoice Tracker</div><span style="font-size:11px;color:var(--t3)">'+jobs.length+' jobs</span></div>';
  h+='<div style="overflow-x:auto"><table class="ctable"><thead><tr><th>Client</th><th>Ref</th><th>Brand</th><th>Start</th><th>Revenue</th><th>Status</th></tr></thead><tbody>';
  for(var i=0;i<jobs.length;i++){
    var j=jobs[i], t=totalRev(j);
    h+='<tr onclick="viewJob(\''+j.id+'\')">';
    h+='<td style="font-weight:600">'+esc(j.client)+'</td>';
    h+='<td style="font-size:10px;color:var(--t3)">'+esc(j.ref)+'</td>';
    h+='<td>'+bbadge(j.brand)+'</td>';
    h+='<td style="font-size:11.5px;color:var(--t2)">'+j.start+'</td>';
    h+='<td style="font-weight:600;color:var(--blue)">'+(t>0?fmt(t):'TBC')+'</td>';
    h+='<td>'+sbadge(j.status)+'</td>';
    h+='</tr>';
  }
  h+='</tbody></table></div></div>';
  setH('fin-out',h);
}

// ── SETTINGS MODULE ───────────────────────────────────────────────────
var curStab = 'crew';

function setStab(tab, btn) {
  curStab = tab;
  document.querySelectorAll('.stab').forEach(function(t) { t.classList.remove('on'); });
  btn.classList.add('on');
  renderSettings();
}

function renderSettings() {
  if (curStab === 'crew')           renderSettingsCrew();
  else if (curStab === 'vehicles')  renderSettingsVehicles();
  else if (curStab === 'materials') renderSettingsMaterials();
  else if (curStab === 'charges')   renderSettingsCharges();
  else if (curStab === 'brands')    renderSettingsBrands();
  else if (curStab === 'mm')        renderSettingsMM();
  else if (curStab === 'comms')     renderSettingsComms();
  else if (curStab === 'costing')   renderSettingsCosting();
  else if (curStab === 'company')   renderSettingsCompany();
}

function renderSettingsCompany() {
  var s = APP_SETTINGS;
  var h = '<div style="max-width:680px">';
  h += '<div class="settings-card">';
  h += '<div class="sc-head"><div><div class="sc-title">🏢 Company Branding &amp; Email</div>';
  h += '<div class="sc-sub">Used in all outgoing emails, documents and share messages. Update here when you rebrand — changes apply everywhere instantly.</div></div>';
  h += '<button class="btn btn-p btn-sm" onclick="saveCompanySettings()">Save changes</button></div>';

  var fields = [
    { key:'companyName',      label:'Company Name',         placeholder:'e.g. Onwards',                    hint:'Appears in email headers and signatures' },
    { key:'companyTagline',   label:'Tagline',              placeholder:'e.g. Professional Moving Services',hint:'Shown under company name in emails' },
    { key:'companyEmail',     label:'From Email Address',   placeholder:'updates@onwards.network',          hint:'Must be a verified sender mailbox in Microsoft 365' },
    { key:'emailReplyTo',     label:'Reply-To Address',     placeholder:'updates@onwards.network',          hint:'Where replies land — can be a group or shared mailbox' },
    { key:'companyPhone',     label:'Phone Number',         placeholder:'e.g. 01234 567890',               hint:'Shown in email footer' },
    { key:'companyWebsite',   label:'Website',              placeholder:'onwards.network',                  hint:'Shown in email footer' },
    { key:'companyAddress',   label:'Registered Address',   placeholder:'e.g. 1 The Street, Wigan, WN1 1AA',hint:'Shown in email footer' },
    { key:'emailFooter',      label:'Email Footer Text',    placeholder:'e.g. Registered in England & Wales',hint:'Legal / company registration line' },
    { key:'emailAccentColor', label:'Email Accent Colour',  placeholder:'#0073EA',                         hint:'Header bar colour in HTML emails', type:'color' },
  ];

  fields.forEach(function(f) {
    h += '<div style="display:grid;grid-template-columns:180px 1fr;gap:12px;align-items:start;padding:12px 0;border-bottom:1px solid var(--s2)">';
    h += '<div><div style="font-size:12.5px;font-weight:700;color:var(--t1)">' + f.label + '</div>';
    h += '<div style="font-size:11px;color:var(--t3);margin-top:2px">' + f.hint + '</div></div>';
    if (f.type === 'color') {
      h += '<div style="display:flex;align-items:center;gap:8px"><input type="color" id="cs-'+f.key+'" value="'+(s[f.key]||'#0073EA')+'" style="width:40px;height:32px;border:1px solid var(--b1);border-radius:6px;cursor:pointer;padding:2px">';
      h += '<input class="sc-input" id="cs-'+f.key+'-txt" value="'+esc(s[f.key]||'')+'" placeholder="'+f.placeholder+'" style="max-width:120px" oninput="document.getElementById(\'cs-'+f.key+'\').value=this.value"></div>';
    } else {
      h += '<input class="sc-input" id="cs-'+f.key+'" value="'+esc(s[f.key]||'')+'" placeholder="'+f.placeholder+'">';
    }
    h += '</div>';
  });

  h += '<div style="padding-top:16px">';
  h += '<button class="btn btn-s btn-sm" onclick="sendTestEmail()">📧 Send test email to myself</button>';
  h += '<span style="font-size:11px;color:var(--t3);margin-left:10px">Sends a sample branded email to your logged-in account</span>';
  h += '</div>';
  h += '</div></div>';
  setH('settings-body', h);
}

function saveCompanySettings() {
  var keys = ['companyName','companyTagline','companyEmail','emailReplyTo','companyPhone','companyWebsite','companyAddress','emailFooter','emailAccentColor'];
  keys.forEach(function(k) {
    var el2 = el('cs-'+k);
    if (el2) APP_SETTINGS[k] = el2.value.trim();
  });
  toast('Branding & email settings saved');
  saveData('settings');
}

async function sendTestEmail() {
  var userEmail = window._authEmail || '';
  if (!userEmail) { toast('No logged-in user email found — sign in with Microsoft first'); return; }
  toast('Sending test email…');
  var html = buildEmailHtml({
    subject: 'Test Email — ' + (APP_SETTINGS.companyName||'Onwards'),
    preheader: 'This is a test of your branded email template.',
    bodyHtml: '<p>Hi,</p><p>This is a test email from the Ops Manager application confirming your email settings are working correctly.</p><p>From address: <strong>' + esc(APP_SETTINGS.companyEmail||'updates@onwards.network') + '</strong></p><p>If you received this, everything is configured correctly! 🎉</p>',
    ctaUrl: '',
    ctaLabel: ''
  });
  var res = await sendEmail({ to: userEmail, subject: 'Test Email — ' + (APP_SETTINGS.companyName||'Onwards'), html });
  if (res.ok) toast('✅ Test email sent to ' + userEmail);
  else toast('❌ Failed: ' + (res.error||'Unknown error'));
}

function renderSettingsCrew() {
  var h = '<div style="max-width:1100px">';
  h += '<div class="settings-card">';
  h += '<div class="sc-head"><div>';
  h += '<div class="sc-title">Crew Rates &amp; Employment Costs</div>';
  h += '<div class="sc-sub">Charge Rate = day rate billed/charged per person (used in job COS + margin). Basic Rate + oncosts = Notional Rate (true cost for Finance accounting only). Margin = profit per crew member per day.</div>';
  h += '</div><button class="btn btn-p btn-sm" onclick="saveCrewRates()">Save All</button></div>';
  h += '<div style="overflow-x:auto"><table class="sc-table"><thead><tr>';
  h += '<th>Name</th><th>Type</th><th>Charge Rate</th><th>Basic Pay</th><th>NI %</th><th>Pension %</th><th>Holiday %</th><th>Notional Rate</th><th>Crew Margin</th><th>Jobs</th><th>Appenate Email</th>';
  h += '</tr></thead><tbody>';
  for (var i = 0; i < CREW.length; i++) {
    var c = CREW[i];
    var cname = c.name;
    var jc = jobs.filter(function(j) { return j.drivers.concat(j.porters).indexOf(cname) >= 0; }).length;
    var notional = crewNotionalRate(c);
    var charge = c.chargeRate || c.rate;
    var marginPct = charge > 0 ? (charge - notional) / charge * 100 : 0;
    var mCol = marginPct >= 30 ? 'var(--green)' : marginPct >= 15 ? 'var(--amber)' : 'var(--red)';
    var emp = c.employed;
    h += '<tr>';
    // Name
    h += '<td><div style="display:flex;align-items:center;gap:7px"><div class="crew-av" style="background:' + c.col + ';width:22px;height:22px;font-size:9px">' + c.name[0] + '</div><strong>' + c.name + '</strong></div></td>';
    // Microsoft Email
    h += '<td><input class="fi" style="min-width:180px;font-size:11.5px" data-ci="'+i+'" data-field="email" value="'+esc(c.email||'')+'" placeholder="name@movesquad.co.uk" onchange="CREW[this.dataset.ci].email=this.value.trim().toLowerCase()"></td>';
    // Employment type
    h += '<td><div style="display:flex;gap:4px">';
    h += '<button class="btn btn-sm ' + (emp ? 'btn-p' : 'btn-s') + '" style="font-size:10px;padding:3px 7px" onclick="setEmpType(' + i + ',true)">Employed</button>';
    h += '<button class="btn btn-sm ' + (!emp ? 'btn-p' : 'btn-s') + '" style="font-size:10px;padding:3px 7px" onclick="setEmpType(' + i + ',false)">Self-Emp</button>';
    h += '</div></td>';
    // Charge rate (revenue per person per day)
    h += '<td style="background:rgba(0,115,234,.04)"><div style="display:flex;align-items:center;gap:4px"><span style="color:var(--t3)">&pound;</span>';
    h += '<input type="number" id="ccr' + i + '" class="sc-input narrow" value="' + charge + '" min="0" step="5" oninput="updateCrewRow(' + i + ')"></div></td>';
    // Basic pay rate
    h += '<td><div style="display:flex;align-items:center;gap:4px"><span style="color:var(--t3)">&pound;</span>';
    h += '<input type="number" id="crt' + i + '" class="sc-input narrow" value="' + c.rate + '" min="0" step="5" oninput="updateCrewRow(' + i + ')"></div></td>';
    // NI %
    h += '<td>' + (emp ? '<div style="display:flex;align-items:center;gap:3px"><input type="number" id="cni' + i + '" class="sc-input narrow" value="' + (c.ni||13.8) + '" min="0" max="30" step="0.1" oninput="updateCrewRow(' + i + ')"><span style="color:var(--t3);font-size:11px">%</span></div>' : '<span style="color:var(--t3)">—</span>') + '</td>';
    // Pension %
    h += '<td>' + (emp ? '<div style="display:flex;align-items:center;gap:3px"><input type="number" id="cpen' + i + '" class="sc-input narrow" value="' + (c.pension||3) + '" min="0" max="20" step="0.1" oninput="updateCrewRow(' + i + ')"><span style="color:var(--t3);font-size:11px">%</span></div>' : '<span style="color:var(--t3)">—</span>') + '</td>';
    // Holiday %
    h += '<td>' + (emp ? '<div style="display:flex;align-items:center;gap:3px"><input type="number" id="chol' + i + '" class="sc-input narrow" value="' + (c.holiday||12.07) + '" min="0" max="30" step="0.01" oninput="updateCrewRow(' + i + ')"><span style="color:var(--t3);font-size:11px">%</span></div>' : '<span style="color:var(--t3)">—</span>') + '</td>';
    // Notional rate (true cost)
    h += '<td id="cnotional' + i + '" style="font-weight:700;color:var(--t2)">' + spv('&pound;' + notional.toFixed(2) + '/day') + '</td>';
    // Crew margin %
    h += '<td id="cmargin' + i + '" style="font-weight:700;color:' + mCol + '">' + spv(marginPct.toFixed(1) + '%') + '</td>';
    // Jobs
    h += '<td style="color:var(--t2)">' + jc + ' job' + (jc!==1?'s':'') + '</td>';
    h += '<td><input class="sc-input" style="font-size:11px;min-width:180px" id="cemail-'+i+'" value="'+esc(c.email||'')+'" placeholder="crew@movesquad.co.uk" type="email"></td>';
    h += '</tr>';
  }
  h += '</tbody></table></div>';

  // Per-crew breakdown cards showing notional cost components
  h += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;padding:14px 16px;background:var(--bg);border-top:1px solid var(--b1)">';
  for (var i = 0; i < CREW.length; i++) {
    var c = CREW[i];
    var bd = crewNotionalBreakdown(c, 1);
    var charge = c.chargeRate || c.rate;
    var notional = crewNotionalRate(c);
    var mPct = charge > 0 ? (charge - notional) / charge * 100 : 0;
    var mCol2 = mPct >= 30 ? 'var(--green)' : mPct >= 15 ? 'var(--amber)' : 'var(--red)';
    h += '<div class="settings-card" style="margin:0"><div style="padding:8px 12px;border-bottom:1px solid var(--b1);display:flex;align-items:center;gap:6px">';
    h += '<div class="crew-av" style="background:' + c.col + ';width:18px;height:18px;font-size:8px">' + c.name[0] + '</div>';
    h += '<strong style="font-size:12px">' + c.name + '</strong>';
    if (!c.employed) h += '<span style="font-size:9px;color:var(--t3);margin-left:auto;font-weight:700">SELF-EMP</span>';
    h += '</div><div style="padding:8px 12px;font-size:11.5px">';
    h += '<div class="cb-row" style="font-size:11px"><span style="color:var(--t3)">Charge Rate</span><span style="color:var(--blue);font-weight:700">' + spv('&pound;' + charge.toFixed(2)) + '</span></div>';
    h += '<div class="cb-row" style="font-size:11px"><span style="color:var(--t3)">Basic Pay</span><span>&pound;' + c.rate.toFixed(2) + '</span></div>';
    if (c.employed) {
      h += '<div class="cb-row" style="font-size:11px"><span style="color:var(--t3)">Holiday (' + (c.holiday||0) + '%)</span><span>' + spv('+&pound;'+bd.holAmt.toFixed(2)) + '</span></div>';
      h += '<div class="cb-row" style="font-size:11px"><span style="color:var(--t3)">NI (' + (c.ni||0) + '%)</span><span>' + spv('+&pound;'+bd.niAmt.toFixed(2)) + '</span></div>';
      h += '<div class="cb-row" style="font-size:11px"><span style="color:var(--t3)">Pension (' + (c.pension||0) + '%)</span><span>' + spv('+&pound;'+bd.penAmt.toFixed(2)) + '</span></div>';
    }
    h += '<div class="cb-row" style="font-size:11px;border-top:1px solid var(--b1);margin-top:4px;padding-top:6px"><span style="color:var(--t3)">Notional</span><span>' + spv('&pound;'+bd.total.toFixed(2)) + '</span></div>';
    h += '<div class="cb-total" style="font-size:12px;color:' + mCol2 + '"><span>Crew Margin</span><span>' + spv(mPct.toFixed(1)+'%') + '</span></div>';
    h += '</div></div>';
  }
  h += '</div>';
  // ── Crew Photos ───────────────────────────────────────────────────
  h += '<div class="settings-card" style="margin-top:14px"><div class="sc-head"><div>';
  h += '<div class="sc-title">Crew Photos</div>';
  h += '<div class="sc-sub">Upload a photo for each crew member. Used as their icon across the app. Click a photo or the upload area to change.</div>';
  h += '</div></div>';
  h += '<div style="display:flex;flex-wrap:wrap;gap:14px;padding:14px 16px">';
  for (var i = 0; i < CREW.length; i++) {
    var c = CREW[i];
    h += '<div style="text-align:center;width:90px">';
    h += '<label style="cursor:pointer;display:block" title="Click to upload photo">';
    h += '<input type="file" accept="image/*" style="display:none" onchange="uploadCrewPhoto('+i+',this)">';
    if (c.photo) {
      h += '<img src="'+c.photo+'" style="width:64px;height:64px;border-radius:50%;object-fit:cover;border:3px solid '+c.col+';display:block;margin:0 auto 5px">';
    } else {
      h += '<div style="width:64px;height:64px;border-radius:50%;background:'+c.col+';display:flex;align-items:center;justify-content:center;color:#fff;font-size:22px;font-weight:700;margin:0 auto 5px;border:3px dashed rgba(255,255,255,.5)">';
      h += c.name[0]+'</div>';
    }
    h += '</label>';
    h += '<div style="font-size:11px;font-weight:600;color:var(--t2)">'+c.name+'</div>';
    if(c.photo) h += '<button class="btn btn-del btn-sm" style="margin-top:4px;font-size:9px;padding:2px 6px" onclick="removeCrewPhoto('+i+')">Remove</button>';
    h += '</div>';
  }
  h += '</div></div>';
  h += '</div>';
  setH('settings-body', h);
}

function uploadCrewPhoto(idx, input) {
  if (!input.files || !input.files[0]) return;
  var file = input.files[0];
  var reader = new FileReader();
  reader.onload = function(e) {
    var dataUrl = e.target.result;
    CREW[idx].photo = dataUrl;
    var crewKey = (CREW[idx].id || CREW[idx].name).toUpperCase().replace(/[^A-Z0-9]/g,'_');
    saveData('media', 'CREW_PHOTO_'+crewKey, {
      id: 'CREW_PHOTO_'+crewKey,
      type: 'crew_photo',
      key: CREW[idx].id || CREW[idx].name,
      data: dataUrl,
      updatedAt: new Date().toISOString()
    });
    toast(CREW[idx].name + ' photo saved');
    renderSettingsCrew();
  };
  reader.readAsDataURL(file);
}

function removeCrewPhoto(idx) {
  CREW[idx].photo = '';
  renderSettingsCrew();
}

function updateCrewRow(i) {
  var charge = parseFloat((el('ccr'+i)||{}).value) || (CREW[i].chargeRate||CREW[i].rate);
  var rate = parseFloat((el('crt'+i)||{}).value) || CREW[i].rate;
  var ni   = parseFloat((el('cni'+i)||{}).value) || 0;
  var pen  = parseFloat((el('cpen'+i)||{}).value) || 0;
  var hol  = parseFloat((el('chol'+i)||{}).value) || 0;
  var emp  = CREW[i].employed;
  var notional = emp ? rate*(1+hol/100)*(1+ni/100)*(1+pen/100) : rate;
  var mPct = charge > 0 ? (charge - notional) / charge * 100 : 0;
  var mCol = mPct >= 30 ? 'var(--green)' : mPct >= 15 ? 'var(--amber)' : 'var(--red)';
  var nEl = el('cnotional'+i);
  if (nEl) { var sv = nEl.querySelector('.spv'); if(sv) sv.innerHTML = '&pound;'+notional.toFixed(2)+'/day'; }
  var mEl = el('cmargin'+i);
  if (mEl) { var sv = mEl.querySelector('.spv'); if(sv) sv.innerHTML = mPct.toFixed(1)+'%'; mEl.style.color = mCol; }
}

function setEmpType(i, emp) {
  CREW[i].employed = emp;
  if (!emp) { CREW[i].ni=0; CREW[i].pension=0; CREW[i].holiday=0; }
  else { if(!CREW[i].ni) CREW[i].ni=13.8; if(!CREW[i].pension) CREW[i].pension=3; if(!CREW[i].holiday) CREW[i].holiday=12.07; }
  saveCrewRates();
  renderSettingsCrew();
}

function saveCrewRates() {
  for (var i = 0; i < CREW.length; i++) {
    var em = el('cemail-'+i); if(em) CREW[i].email = em.value.trim();
    var rc=el('ccr'+i); if(rc) {var v=parseFloat(rc.value); if(!isNaN(v)) CREW[i].chargeRate=v;}
    var rt=el('crt'+i); if(rt) {var v=parseFloat(rt.value); if(!isNaN(v)) CREW[i].rate=v;}
    var rn=el('cni'+i); if(rn) {var v=parseFloat(rn.value); if(!isNaN(v)) CREW[i].ni=v;}
    var rp=el('cpen'+i);if(rp) {var v=parseFloat(rp.value); if(!isNaN(v)) CREW[i].pension=v;}
    var rh=el('chol'+i);if(rh) {var v=parseFloat(rh.value); if(!isNaN(v)) CREW[i].holiday=v;}
  }
  toast('Crew rates saved'); saveData('settings');
  if(curMod==='finance') renderFinance();
}


function renderSettingsVehicles() {
  var VTYPES = ['Luton','7.5T','3.5T','Long Wheel Base','Sprinter','Other'];
  var COLOURS = ['White','Silver','Grey','Black','Blue','Red','Yellow','Orange'];
  var h = '<div>';
  h += '<div class="settings-card"><div class="sc-head"><div><div class="sc-title">Fleet Vehicles</div>';
  h += '<div class="sc-sub">Available for assignment on bookings</div></div></div>';
  if (VEHICLES.length) {
    h += '<table class="sc-table"><thead><tr><th>Name</th><th>Reg</th><th>Type</th><th>Colour</th>';
    h += '<th>Vol ft&sup3;</th><th>L&times;W&times;H (m)</th><th>£/mile</th><th>Day Rate</th><th></th></tr></thead><tbody>';
    for (var i = 0; i < VEHICLES.length; i++) {
      var v = VEHICLES[i];
      h += '<tr>';
      h += '<td><input class="sc-input mid" id="vn' + i + '" value="' + esc(v.name) + '"></td>';
      h += '<td><input class="sc-input mid" id="vr' + i + '" value="' + esc(v.reg) + '"></td>';
      h += '<td><select class="sc-input" style="width:110px" id="vt' + i + '">';
      for (var k = 0; k < VTYPES.length; k++) h += '<option' + (v.type === VTYPES[k] ? ' selected' : '') + '>' + VTYPES[k] + '</option>';
      h += '</select></td>';
      h += '<td><select class="sc-input" style="width:85px" id="vc' + i + '">';
      for (var k = 0; k < COLOURS.length; k++) h += '<option' + (v.colour === COLOURS[k] ? ' selected' : '') + '>' + COLOURS[k] + '</option>';
      h += '</select></td>';
      h += '<td><input class="sc-input narrow" type="number" id="vv' + i + '" value="' + v.volCapFt + '" min="0"></td>';
      h += '<td><div style="display:flex;gap:3px">';
      h += '<input class="sc-input" style="width:48px" type="number" id="vl' + i + '" value="' + v.length + '" step="0.1">';
      h += '<input class="sc-input" style="width:48px" type="number" id="vw' + i + '" value="' + v.width + '" step="0.1">';
      h += '<input class="sc-input" style="width:48px" type="number" id="vh' + i + '" value="' + v.height + '" step="0.1">';
      h += '</div></td>';
      h += '<td><input class="sc-input narrow" type="number" id="vm' + i + '" value="' + v.mileRate + '" step="0.01"></td>';
      h += '<td><div style="display:flex;align-items:center;gap:3px"><span style="color:var(--t3);font-size:12px">&pound;</span>';
      h += '<input class="sc-input narrow" type="number" id="vd' + i + '" value="' + v.dayRate + '" step="5"></div></td>';
      h += '<td><button class="btn btn-del btn-sm" onclick="delVehicle(\'" + v.id + "\')">&#10005;</button></td>';
      h += '</tr>';
    }
    h += '</tbody></table>';
    h += '<div style="padding:10px 16px;border-top:1px solid var(--b1);display:flex;justify-content:flex-end">';
    h += '<button class="btn btn-p btn-sm" onclick="saveVehicles()">Save Vehicles</button></div>';
  } else {
    h += '<div style="padding:30px;text-align:center;color:var(--t3)">No vehicles added yet.</div>';
  }
  h += '</div>';
  h += '<div class="settings-card"><div class="sc-head"><div class="sc-title">Add New Vehicle</div></div>';
  h += '<div class="sc-body"><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:10px">';
  h += '<div class="veh-field"><div class="veh-lbl">Name</div><input class="sc-input" id="nv-name" placeholder="e.g. Luton 3"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Registration</div><input class="sc-input" id="nv-reg" placeholder="AB12 CDE"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Type</div><select class="sc-input" id="nv-type">';
  for (var k = 0; k < VTYPES.length; k++) h += '<option>' + VTYPES[k] + '</option>';
  h += '</select></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Colour</div><select class="sc-input" id="nv-colour">';
  for (var k = 0; k < COLOURS.length; k++) h += '<option>' + COLOURS[k] + '</option>';
  h += '</select></div></div>';
  h += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:10px">';
  h += '<div class="veh-field"><div class="veh-lbl">Volume ft&sup3;</div><input class="sc-input" id="nv-vol" type="number" placeholder="850" min="0"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Length (m)</div><input class="sc-input" id="nv-len" type="number" step="0.1" placeholder="4.2"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Width (m)</div><input class="sc-input" id="nv-wid" type="number" step="0.1" placeholder="2.1"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Height (m)</div><input class="sc-input" id="nv-hei" type="number" step="0.1" placeholder="2.2"></div>';
  h += '</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;align-items:flex-end">';
  h += '<div class="veh-field"><div class="veh-lbl">Mileage (£/mile)</div><input class="sc-input" id="nv-mile" type="number" step="0.01" placeholder="0.35"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Day Rate (£)</div><input class="sc-input" id="nv-day" type="number" placeholder="120" step="5"></div>';
  h += '<div></div><button class="btn btn-p" onclick="addVehicle()">+ Add Vehicle</button>';
  h += '</div></div></div></div>';
  setH('settings-body', h);
}

function saveVehicles() {
  for (var i = 0; i < VEHICLES.length; i++) {
    VEHICLES[i].name     = el('vn'+i).value;
    VEHICLES[i].reg      = el('vr'+i).value;
    VEHICLES[i].type     = el('vt'+i).value;
    VEHICLES[i].colour   = el('vc'+i).value;
    VEHICLES[i].volCapFt = parseFloat(el('vv'+i).value) || 0;
    VEHICLES[i].length   = parseFloat(el('vl'+i).value) || 0;
    VEHICLES[i].width    = parseFloat(el('vw'+i).value) || 0;
    VEHICLES[i].height   = parseFloat(el('vh'+i).value) || 0;
    VEHICLES[i].mileRate = parseFloat(el('vm'+i).value) || 0;
    VEHICLES[i].dayRate  = parseFloat(el('vd'+i).value) || 0;
  }
  toast('Vehicles saved'); saveData('settings');
}

function addVehicle() {
  var name = (el('nv-name').value||'').trim();
  if (!name) { toast('Vehicle name required'); return; }
  VEHICLES.push({
    id:'V'+Date.now(), name:name,
    reg:el('nv-reg').value.trim().toUpperCase(),
    type:el('nv-type').value, colour:el('nv-colour').value,
    volCapFt:parseFloat(el('nv-vol').value)||0,
    length:parseFloat(el('nv-len').value)||0,
    width:parseFloat(el('nv-wid').value)||0,
    height:parseFloat(el('nv-hei').value)||0,
    mileRate:parseFloat(el('nv-mile').value)||0,
    dayRate:parseFloat(el('nv-day').value)||0,
  });
  toast('Vehicle added');
  renderSettingsVehicles();
}

function delVehicle(id) {
  if (!confirm('Remove this vehicle?')) return;
  VEHICLES = VEHICLES.filter(function(v) { return v.id !== id; });
  renderSettingsVehicles();
}

function renderSettingsMaterials() {
  var h = '<div style="max-width:600px">';
  h += '<div class="settings-card"><div class="sc-head"><div><div class="sc-title">Packing Materials</div>';
  h += '<div class="sc-sub">Unit costs, selectable per booking</div></div>';
  h += '<button class="btn btn-p btn-sm" onclick="saveMaterials()">Save</button></div>';
  h += '<table class="sc-table"><thead><tr><th>Name</th><th>Type</th><th>Unit Cost</th><th></th></tr></thead><tbody>';
  for (var i = 0; i < MATERIALS.length; i++) {
    var m = MATERIALS[i];
    h += '<tr>';
    h += '<td><input class="sc-input" id="mn'+i+'" value="'+esc(m.name)+'"></td>';
    h += '<td><input class="sc-input mid" id="mt'+i+'" value="'+esc(m.type)+'"></td>';
    h += '<td><div style="display:flex;align-items:center;gap:4px"><span style="color:var(--t3)">&pound;</span>';
    h += '<input class="sc-input narrow" type="number" id="mc'+i+'" value="'+m.unitCost+'" step="0.01" min="0"></div></td>';
    h += '<td><button class="btn btn-del btn-sm" onclick="delMaterial(\'"++m.id++"\')">&#10005;</button></td>';
    h += '</tr>';
  }
  h += '</tbody></table>';
  h += '<div class="add-row">';
  h += '<div class="veh-field"><div class="veh-lbl">Name</div><input class="sc-input" id="nm-name" placeholder="e.g. Bubble Wrap Roll" style="width:190px"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Type</div><input class="sc-input mid" id="nm-type" placeholder="e.g. Wrap"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Unit Cost</div><div style="display:flex;align-items:center;gap:4px"><span style="color:var(--t3)">&pound;</span><input class="sc-input narrow" type="number" id="nm-cost" step="0.01" placeholder="0.00"></div></div>';
  h += '<button class="btn btn-p btn-sm" onclick="addMaterial()" style="align-self:flex-end">+ Add</button>';
  h += '</div></div></div>';
  setH('settings-body', h);
}

function saveMaterials() {
  for (var i = 0; i < MATERIALS.length; i++) {
    var nn=el('mn'+i),nt=el('mt'+i),nc=el('mc'+i);
    if(nn) MATERIALS[i].name=nn.value;
    if(nt) MATERIALS[i].type=nt.value;
    if(nc) MATERIALS[i].unitCost=parseFloat(nc.value)||0;
  }
  toast('Materials saved'); saveData('settings');
}

function addMaterial() {
  var name=(el('nm-name').value||'').trim();
  if(!name){toast('Name required');return;}
  MATERIALS.push({id:'M'+Date.now(),name:name,type:el('nm-type').value.trim(),unitCost:parseFloat(el('nm-cost').value)||0});
  toast('Material added'); renderSettingsMaterials();
}

function delMaterial(id) {
  if(!confirm('Remove this material?'))return;
  MATERIALS=MATERIALS.filter(function(m){return m.id!==id;}); renderSettingsMaterials();
}

function renderSettingsCharges() {
  var h = '<div style="max-width:560px">';
  h += '<div class="settings-card"><div class="sc-head"><div><div class="sc-title">Charges &amp; Taxes</div>';
  h += '<div class="sc-sub">Added to booking costs when selected — can be applied multiple times</div></div>';
  h += '<button class="btn btn-p btn-sm" onclick="saveCharges()">Save</button></div>';
  h += '<table class="sc-table"><thead><tr><th>Charge Name</th><th>Default Amount</th><th></th></tr></thead><tbody>';
  for (var i = 0; i < CHARGES.length; i++) {
    var c = CHARGES[i];
    h += '<tr>';
    h += '<td><input class="sc-input" id="cgn'+i+'" value="'+esc(c.name)+'"></td>';
    h += '<td><div style="display:flex;align-items:center;gap:4px"><span style="color:var(--t3)">&pound;</span>';
    h += '<input class="sc-input narrow" type="number" id="cga'+i+'" value="'+c.defaultAmt+'" step="0.01" min="0"></div></td>';
    h += '<td><button class="btn btn-del btn-sm" onclick="delCharge(\'"++c.id++"\')">&#10005;</button></td>';
    h += '</tr>';
  }
  h += '</tbody></table>';
  h += '<div class="add-row">';
  h += '<div class="veh-field"><div class="veh-lbl">Name</div><input class="sc-input" id="nc-name" placeholder="e.g. Ferry Crossing" style="width:200px"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Default Amount</div><div style="display:flex;align-items:center;gap:4px"><span style="color:var(--t3)">&pound;</span><input class="sc-input narrow" type="number" id="nc-amt" step="0.01" placeholder="0.00"></div></div>';
  h += '<button class="btn btn-p btn-sm" onclick="addCharge()" style="align-self:flex-end">+ Add</button>';
  h += '</div></div></div>';
  setH('settings-body', h);
}

function saveCharges() {
  for (var i = 0; i < CHARGES.length; i++) {
    var nn=el('cgn'+i),na=el('cga'+i);
    if(nn) CHARGES[i].name=nn.value;
    if(na) CHARGES[i].defaultAmt=parseFloat(na.value)||0;
  }
  toast('Charges saved'); saveData('settings');
}

function addCharge() {
  var name=(el('nc-name').value||'').trim();
  if(!name){toast('Name required');return;}
  CHARGES.push({id:'C'+Date.now(),name:name,defaultAmt:parseFloat(el('nc-amt').value)||0});
  toast('Charge added'); renderSettingsCharges();
}

function delCharge(id) {
  if(!confirm('Remove this charge?'))return;
  CHARGES=CHARGES.filter(function(c){return c.id!==id;}); renderSettingsCharges();
}

function renderSettingsBrands() {
  var CHANNELS = ['Partner','Account','Domestic'];
  var h = '<div style="max-width:860px">';
  h += '<div class="settings-card"><div class="sc-head"><div><div class="sc-title">Brands</div>';
  h += '<div class="sc-sub">Upload a JPG or PNG logo for each brand. It will appear everywhere the brand is shown.</div></div>';
  h += '<button class="btn btn-p btn-sm" onclick="saveBrands()">Save changes</button><button class="btn btn-s btn-sm" onclick="spTestConnection()" style="margin-left:8px">🔗 Test SharePoint</button></div>';
  h += '<table class="sc-table"><thead><tr><th style="width:80px">Logo</th><th>Brand Name</th><th style="width:110px">Colour</th><th style="width:120px">Channel</th><th>Default MM</th><th style="min-width:180px">SharePoint Folder</th><th style="width:32px"></th></tr></thead><tbody>';
  for (var i = 0; i < BRAND_DATA.length; i++) {
    var b = BRAND_DATA[i];
    var mm = mmForBrand(b.name);
    h += '<tr>';
    // Logo cell: shows current logo or colour swatch, with upload button
    h += '<td style="text-align:center;padding:8px 6px">';
    h += '<div style="display:flex;flex-direction:column;align-items:center;gap:4px">';
    if (b.logo) {
      h += '<img id="blogo-prev-'+i+'" src="'+b.logo+'" alt="'+esc(b.name)+'" style="height:28px;width:auto;max-width:60px;object-fit:contain;border-radius:3px;border:1px solid var(--b1);background:#fff;padding:2px">';
    } else {
      h += '<div id="blogo-prev-'+i+'" style="width:44px;height:28px;border-radius:3px;background:'+b.col+';display:flex;align-items:center;justify-content:center;font-size:8.5px;font-weight:700;color:#fff;letter-spacing:.3px">'+esc(b.name.substring(0,4))+'</div>';
    }
    h += '<label style="font-size:9.5px;font-weight:600;color:var(--blue);cursor:pointer;padding:2px 5px;border:1px solid var(--blue);border-radius:3px;background:var(--blt);white-space:nowrap">Upload';
    h += '<input type="file" accept="image/png,image/jpeg,image/gif,image/svg+xml,image/webp" style="display:none" onchange="brandLogoUpload('+i+',this)">';
    h += '</label>';
    if (b.logo) h += '<span style="font-size:9px;color:var(--red);cursor:pointer;font-weight:600" onclick="brandLogoClear('+i+')">Remove</span>';
    h += '</div></td>';
    h += '<td><input class="sc-input" id="bn-'+i+'" value="'+esc(b.name)+'"></td>';
    h += '<td><div style="display:flex;align-items:center;gap:6px"><input type="color" id="bc-'+i+'" value="'+b.col+'" style="width:36px;height:28px;border:1px solid var(--b1);border-radius:4px;cursor:pointer;padding:2px"><span id="bch-'+i+'" style="font-size:11px;color:var(--t3)">'+b.col+'</span></div></td>';
    h += '<td><select class="sc-input" id="bch2-'+i+'">'+CHANNELS.map(function(c){return '<option'+(c===b.channel?' selected':'')+'>'+c+'</option>';}).join('')+'</select></td>';
    h += '<td style="font-size:11.5px;color:var(--t2)">'+(mm?esc(mm.name):'<span style="color:var(--t3)">None</span>')+'</td>';
    h += '<td><input class="sc-input" id="bsp-'+i+'" value="'+esc(b.spFolder||'')+'" placeholder="e.g. SIRVA" title="SharePoint Partners sub-folder name — must match exactly"></td>';
    h += '<td><button class="btn btn-del btn-sm" onclick="delBrand('+i+')" title="Delete">&#10005;</button></td>';
    h += '</tr>';
  }
  h += '</tbody></table>';
  h += '<div class="add-row"><input class="sc-input mid" id="nb-name" placeholder="Brand name"><input type="color" id="nb-col" value="#0073EA" style="width:36px;height:30px;border:1px solid var(--b1);border-radius:4px;cursor:pointer;padding:2px"><select class="sc-input" id="nb-ch">'+CHANNELS.map(function(c){return '<option>'+c+'</option>';}).join('')+'</select>';
  h += '<button class="btn btn-p btn-sm" onclick="addBrand()">+ Add Brand</button></div>';
  h += '</div></div>';
  setH('settings-body', h);
}

function brandLogoUpload(idx, input) {
  var file = input.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    var dataUrl = e.target.result;
    BRAND_DATA[idx].logo = dataUrl;
    buildBrandMaps();
    // Save as separate OpsMedia row — avoids Azure 64KB property limit
    var brandKey = BRAND_DATA[idx].name.toUpperCase().replace(/[^A-Z0-9]/g,'_');
    saveData('media', 'BRAND_LOGO_'+brandKey, {
      id: 'BRAND_LOGO_'+brandKey,
      type: 'brand_logo',
      key: BRAND_DATA[idx].name,
      data: dataUrl,
      updatedAt: new Date().toISOString()
    });
    var prev = document.getElementById('blogo-prev-'+idx);
    if (prev) {
      var img = document.createElement('img');
      img.id = 'blogo-prev-'+idx;
      img.src = dataUrl;
      img.alt = BRAND_DATA[idx].name;
      img.style.cssText = 'height:28px;width:auto;max-width:60px;object-fit:contain;border-radius:3px;border:1px solid var(--b1);background:#fff;padding:2px';
      prev.parentNode.replaceChild(img, prev);
    }
    if (curMod === 'calendar') renderCal();
    toast(BRAND_DATA[idx].name + ' logo saved');
  };
  reader.readAsDataURL(file);
}

function brandLogoClear(idx) {
  BRAND_DATA[idx].logo = '';
  buildBrandMaps();
  renderSettingsBrands();
  if (curMod === 'calendar') renderCal();
  toast('Logo removed'); saveData('settings');
}

function saveBrands() {
  for (var i = 0; i < BRAND_DATA.length; i++) {
    var n=el('bn-'+i); if(n) BRAND_DATA[i].name=n.value.trim();
    var c=el('bc-'+i); if(c) BRAND_DATA[i].col=c.value;
    var ch=el('bch2-'+i); if(ch) BRAND_DATA[i].channel=ch.value;
    var sp=el('bsp-'+i); if(sp) BRAND_DATA[i].spFolder=sp.value.trim();
    // logo is already stored live on upload — no input field to read
  }
  buildBrandMaps();
  toast('Brands saved'); saveData('settings');
  renderSettingsBrands();
}

function addBrand() {
  var name=(el('nb-name')||{}).value||''; name=name.trim();
  if(!name){toast('Enter a brand name');return;}
  var col=(el('nb-col')||{}).value||'#888888';
  var ch=(el('nb-ch')||{}).value||'Partner';
  BRAND_DATA.push({name:name,col:col,channel:ch,logo:''});
  buildBrandMaps();
  saveBrands();
  renderSettingsBrands();
  toast('Brand added');
}

function delBrand(i) {
  if(!confirm('Delete brand '+BRAND_DATA[i].name+'?')) return;
  BRAND_DATA.splice(i,1);
  buildBrandMaps();
  renderSettingsBrands();
}

function renderSettingsMM() {
  var h = '<div style="max-width:800px">';
  h += '<div class="settings-card"><div class="sc-head"><div><div class="sc-title">Move Managers</div>';
  h += '<div class="sc-sub">One Move Manager per brand. For Partner &amp; Account jobs, comms are sent to the Move Manager instead of the end client.</div></div>';
  h += '<button class="btn btn-p btn-sm" onclick="saveMMs()">Save</button></div>';
  h += '<table class="sc-table"><thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Brand</th><th></th></tr></thead><tbody>';
  for (var i = 0; i < MOVE_MANAGERS.length; i++) {
    var m = MOVE_MANAGERS[i];
    h += '<tr>';
    h += '<td><input class="sc-input mid" id="mmn-'+i+'" value="'+esc(m.name)+'"></td>';
    h += '<td><input class="sc-input mid" id="mmp-'+i+'" value="'+esc(m.phone)+'" placeholder="07700..."></td>';
    h += '<td><input class="sc-input mid" id="mme-'+i+'" value="'+esc(m.email)+'" placeholder="name@company.com"></td>';
    h += '<td><select class="sc-input" id="mmb-'+i+'">'+BRANDS.map(function(b){return '<option'+(b===m.brand?' selected':'')+'>'+b+'</option>';}).join('')+'</select></td>';
    h += '<td><button class="btn btn-del btn-sm" onclick="delMM('+i+')" title="Delete">&#10005;</button></td>';
    h += '</tr>';
  }
  h += '</tbody></table>';
  h += '<div class="add-row"><input class="sc-input mid" id="nmm-name" placeholder="Full name"><input class="sc-input mid" id="nmm-phone" placeholder="Phone"><input class="sc-input mid" id="nmm-email" placeholder="Email">';
  h += '<select class="sc-input" id="nmm-brand">'+BRANDS.map(function(b){return '<option>'+b+'</option>';}).join('')+'</select>';
  h += '<button class="btn btn-p btn-sm" onclick="addMM()">+ Add</button></div>';
  h += '</div></div>';
  setH('settings-body', h);
}

function saveMMs() {
  for (var i = 0; i < MOVE_MANAGERS.length; i++) {
    var n=el('mmn-'+i); if(n) MOVE_MANAGERS[i].name=n.value;
    var p=el('mmp-'+i); if(p) MOVE_MANAGERS[i].phone=p.value;
    var e=el('mme-'+i); if(e) MOVE_MANAGERS[i].email=e.value;
    var b=el('mmb-'+i); if(b) MOVE_MANAGERS[i].brand=b.value;
  }
  toast('Move Managers saved'); saveData('settings');
}

function addMM() {
  var name=(el('nmm-name')||{}).value||''; name=name.trim();
  if(!name){toast('Name required');return;}
  var id='MM'+String(Date.now()).slice(-5);
  MOVE_MANAGERS.push({id:id,name:name,phone:(el('nmm-phone')||{}).value||'',email:(el('nmm-email')||{}).value||'',brand:(el('nmm-brand')||{}).value||BRANDS[0]||''});
  renderSettingsMM();
}

function delMM(i) {
  if(!confirm('Delete '+MOVE_MANAGERS[i].name+'?')) return;
  MOVE_MANAGERS.splice(i,1);
  renderSettingsMM();
}

function renderSettingsComms() {
  var h = '<div style="max-width:680px">';

  // Twilio SMS & Voice
  h += '<div class="settings-card">';
  h += '<div class="sc-head"><div><div class="sc-title">📱 Twilio — SMS & Voice</div>';
  h += '<div class="sc-sub">Send SMS confirmations, doc reminders and appointment notifications. Supports SMS, WhatsApp and SIP calling.</div></div>';
  h += '<button class="btn btn-p btn-sm" onclick="saveTwilioSettings()">Save</button></div>';

  var twilioFields = [
    { key:'accountSid',  label:'Account SID',       placeholder:'ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx', hint:'From twilio.com/console' },
    { key:'authToken',   label:'Auth Token',         placeholder:'your auth token',                   hint:'Keep this secret', type:'password' },
    { key:'fromNumber',  label:'From Number (SMS)',  placeholder:'+441234567890',                     hint:'Your Twilio phone number in E.164 format' },
    { key:'fromWhatsApp',label:'WhatsApp Number',    placeholder:'whatsapp:+14155238886',              hint:'Only if WhatsApp Business is enabled on your Twilio account' },
  ];
  twilioFields.forEach(function(f) {
    h += '<div style="display:grid;grid-template-columns:180px 1fr;gap:12px;align-items:start;padding:10px 0;border-bottom:1px solid var(--s2)">';
    h += '<div><div style="font-size:12.5px;font-weight:700;color:var(--t1)">' + f.label + '</div>';
    h += '<div style="font-size:11px;color:var(--t3);margin-top:2px">' + f.hint + '</div></div>';
    h += '<input class="sc-input" id="tw-'+f.key+'" type="'+(f.type||'text')+'" value="'+esc(TWILIO_CONFIG[f.key]||'')+'" placeholder="'+f.placeholder+'">';
    h += '</div>';
  });
  h += '<div style="padding-top:12px;display:flex;gap:8px">';
  h += '<button class="btn btn-s btn-sm" onclick="sendTestSms()">📱 Send test SMS</button>';
  h += '<span style="font-size:11px;color:var(--t3);margin-left:4px;align-self:center">Sends a test SMS to your mobile number</span>';
  h += '</div></div>';

  // Warehouse / mileage postcode
  h += '<div class="settings-card">';
  h += '<div class="sc-head"><div class="sc-title">🏭 Warehouse & Mileage</div></div>';
  h += '<div style="display:grid;grid-template-columns:180px 1fr;gap:12px;align-items:center;padding:10px 0">';
  h += '<div><div style="font-size:12.5px;font-weight:700;color:var(--t1)">Company Postcode</div>';
  h += '<div style="font-size:11px;color:var(--t3);margin-top:2px">Used for mileage calculations</div></div>';
  h += '<input class="sc-input" id="sl-postcode" value="'+esc(SL_CONFIG.companyPostcode||'WN73EQ')+'" placeholder="WN7 3EQ">';
  h += '</div>';
  h += '<button class="btn btn-p btn-sm" style="margin-top:10px" onclick="saveCommsSettings()">Save</button>';
  h += '</div>';

  h += '</div>';
  setH('settings-body', h);
}

function saveTwilioSettings() {
  var keys = ['accountSid','authToken','fromNumber','fromWhatsApp'];
  keys.forEach(function(k) {
    var e = el('tw-'+k);
    if (e) TWILIO_CONFIG[k] = e.value.trim();
  });
  toast('Twilio settings saved');
  saveData('settings');
}

async function sendTestSms() {
  if (!TWILIO_CONFIG.accountSid || !TWILIO_CONFIG.fromNumber) {
    toast('Please enter your Twilio Account SID and From Number first');
    return;
  }
  var to = prompt('Enter your mobile number for the test SMS (e.g. +447700000000):');
  if (!to) return;
  toast('Sending test SMS…');
  var res = await sendSms({ to, body: 'Test message from ' + (APP_SETTINGS.companyName||'Onwards') + ' Ops Manager. If you received this, Twilio is configured correctly!' });
  if (res.ok) toast('✅ Test SMS sent to ' + to);
  else toast('❌ SMS failed: ' + (res.error||'Unknown'));
}


function saveCommsSettings() {
  SL_CONFIG.companyName=el('sl-cname').value; SL_CONFIG.companyPostcode=(el('sl-postcode')||{}).value||SL_CONFIG.companyPostcode; SL_CONFIG.fromEmail=el('sl-from').value;
  SL_CONFIG.fromName=el('sl-fname').value; SL_CONFIG.companyPhone=el('sl-phone').value;
  SL_CONFIG.companyEmail=el('sl-reply').value; SL_CONFIG.serverId=el('sl-sid').value;
  SL_CONFIG.apiKey=el('sl-key').value;
  toast('Settings saved'); saveData('settings');
}

function renderSettingsCosting() {
  var h = '<div style="max-width:700px">';

  // Google Maps API section
  h += '<div class="settings-card"><div class="sc-head"><div>';
  h += '<div class="sc-title">Google Maps &amp; Address Lookup</div>';
  h += '<div class="sc-sub">Enter your Google Maps Platform API key to enable address autocomplete, satellite imagery, and automatic distance/mileage calculation. The key needs Maps JavaScript API, Places API, Distance Matrix API, and Embed API enabled in Google Cloud Console.</div>';
  h += '</div></div><div class="sc-body">';
  h += '<div class="cos-grid">';
  h += '<div class="cos-field" style="grid-column:span 2"><div class="cos-lbl">Google Maps API Key</div>';
  h += '<input class="sc-input" id="cos-maps-key" type="password" value="'+esc(APP_SETTINGS.googleMapsKey)+'" placeholder="AIzaSy…">';
  h += '<div class="cos-desc">Required for address autocomplete, map views, and mileage calculation. Get your key at console.cloud.google.com</div></div>';
  // Warehouse locations manager
  h += '<div class="cos-field">';
  h += '<div class="cos-lbl">Warehouse &amp; Depot Locations</div>';
  h += '<div class="cos-desc" style="margin-bottom:10px">Define all warehouse locations. The default is used for mileage calculations and auto-fill on storage jobs.</div>';
  h += '<div id="wh-list" style="margin-bottom:8px">';
  for (var _wi = 0; _wi < WAREHOUSES.length; _wi++) {
    var _wh = WAREHOUSES[_wi];
    h += '<div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;padding:8px 10px;background:var(--s1);border-radius:7px;border:1px solid var(--b1)">';
    h += '<div style="flex:1;min-width:0">';
    h += '<input class="sc-input" id="wh-name-'+_wi+'" value="'+esc(_wh.name)+'" placeholder="Location name (e.g. Main Warehouse)" style="margin-bottom:4px">';
    h += '<input class="sc-input addr-input" id="wh-addr-'+_wi+'" value="'+esc(_wh.address)+'" placeholder="Full address or postcode">';
    h += '</div>';
    h += '<div style="display:flex;flex-direction:column;gap:4px;align-items:center;flex-shrink:0">';
    h += '<label style="font-size:10px;color:var(--t3);white-space:nowrap">Default</label>';
    h += '<input type="radio" name="wh-default" value="'+_wi+'"'+(_wh.isDefault?' checked':'')+' onchange="whSetDefault('+_wi+')" style="width:16px;height:16px;cursor:pointer">';
    h += '</div>';
    if (WAREHOUSES.length > 1) {
      h += '<button class="btn btn-g btn-sm" onclick="whRemove('+_wi+')" style="flex-shrink:0;color:var(--red)">&#10005;</button>';
    }
    h += '</div>';
  }
  h += '</div>';
  h += '<button class="btn btn-s btn-sm" onclick="whAdd()">+ Add Location</button>';
  h += '<button class="btn btn-p btn-sm" onclick="whSave()" style="margin-left:8px">Save Locations</button>';
  h += '</div>';
  h += '<div class="cos-field"><div class="cos-lbl">Auto-add Return Leg</div>';
  h += '<select class="sc-input" id="cos-return-leg">';
  h += '<option value="1"'+(APP_SETTINGS.returnMileage?' selected':'')+'>Yes — add return to depot mileage</option>';
  h += '<option value="0"'+(!APP_SETTINGS.returnMileage?' selected':'')+'>No — point-to-point only</option>';
  h += '</select>';
  h += '<div class="cos-desc">Non-overnight jobs: crew returns to depot. Add return mileage to fuel cost.</div></div>';
  h += '</div>';

  // Maps API status
  h += '<div style="margin-top:12px;padding:10px 12px;border-radius:6px;border:1px solid var(--b1);background:var(--s1);font-size:12px;display:flex;align-items:center;gap:8px">';
  var mapsStatus = mapsApiLoaded();
  h += mapsStatus
    ? '<span style="color:var(--green);font-weight:700">✓ Google Maps API loaded</span><span style="color:var(--t3)">— Address lookup, mapping, and distance calculation are active</span>'
    : '<span style="color:var(--amber);font-weight:700">⚠ Google Maps not loaded</span><span style="color:var(--t3)">— Enter an API key and save to activate</span>';
  h += '</div>';
  h += '</div></div>';

  // COS per crew section
  h += '<div class="settings-card" style="margin-top:16px"><div class="sc-head"><div>';
  h += '<div class="sc-title">Cost of Sale — Generic Daily Overhead</div>';
  h += '<div class="sc-sub">A configurable overhead applied per crew member per working day. Covers general business costs not captured by specific line items (insurance, admin, overheads, etc.). Applied to each job day per crew member, or proportionally split across journey jobs.</div>';
  h += '</div></div><div class="sc-body">';
  h += '<div class="cos-grid">';
  h += '<div class="cos-field"><div class="cos-lbl">Overhead per Crew per Day <span style="font-weight:400;color:var(--t4)">(£)</span></div>';
  h += '<input class="sc-input" id="cos-per-crew" type="number" min="0" step="1" value="'+APP_SETTINGS.cosPerCrewPerDay+'">';
  h += '<div class="cos-desc">Fixed overhead per crew (team) per day — charged once regardless of how many people are on the crew. E.g. £125 × 2 days = £250 for a 2-day job with any size crew.</div></div>';
  h += '<div class="cos-field"><div class="cos-lbl">Fuel Price per Litre <span style="font-weight:400;color:var(--t4)">(£ — reference only)</span></div>';
  h += '<input class="sc-input" id="cos-fuel-price" type="number" min="0" step="0.01" value="'+APP_SETTINGS.fuelPricePerLitre+'">';
  h += '<div class="cos-desc">Used for display reference. Actual fuel cost uses vehicle mileage rates.</div></div>';
  h += '</div>';
  h += '<div style="margin-top:14px;padding:10px 12px;border-radius:6px;background:#EBF4FF;border:1px solid #C4D9F5;font-size:12px">';
  h += '<strong>How it applies:</strong> Single job = crew count × days × rate. Journey (multi-job day) = total crew on all jobs × days × rate, split proportionally. Multi-day jobs = rate applied per calendar day independently.';
  h += '</div>';
  h += '</div></div>';

  h += '<div style="display:flex;justify-content:flex-end;margin-top:14px"><button class="btn btn-p" onclick="saveCosting()">Save Settings</button></div>';
  h += '</div>';
  setH('settings-body', h);
}

function saveCosting() {
  APP_SETTINGS.googleMapsKey    = (el('cos-maps-key')||{}).value||'';
  APP_SETTINGS.returnMileage    = (el('cos-return-leg')||{}).value === '1';
  APP_SETTINGS.cosPerCrewPerDay = parseFloat((el('cos-per-crew')||{}).value)||125;
  APP_SETTINGS.fuelPricePerLitre= parseFloat((el('cos-fuel-price')||{}).value)||1.49;
  // Sync legacy single address with default warehouse
  var _defWh = getDefaultWarehouse();
  if (_defWh) APP_SETTINGS.warehouseAddress = _defWh.address;
  if (APP_SETTINGS.googleMapsKey) loadGoogleMapsAPI();
  toast('Cost of Sale & Maps settings saved');
  saveData('settings');
  renderSettings();
}

function bkVehicleCost(bk) {
  var dur=Math.max(1,Math.round((s2d(bk.endDate)-s2d(bk.startDate))/864e5)+1);
  return (bk.vehicles||[]).reduce(function(s,bv){
    var v=VEHICLES.filter(function(x){return x.id===bv.id;})[0];
    return s+(v?v.dayRate*dur:0);
  },0);
}

function bkMaterialCost(bk) {
  return (bk.materials||[]).reduce(function(s,bm){
    var m=MATERIALS.filter(function(x){return x.id===bm.id;})[0];
    return s+(m?m.unitCost*(bm.qty||0):0);
  },0);
}

function bkChargeCost(bk) {
  return (bk.charges||[]).reduce(function(s,bc){return s+(bc.amt||0);},0);
}

function bkCrewCost(bk) {
  var j=jobs.filter(function(x){return x.id===bk.id;})[0];
  return j?jobCrewCost(j):0;
}

function bkFuelCost(bk) {
  var j=jobs.filter(function(x){return x.id===bk.id;})[0];
  return j?(jobFuelCost(j)||0):0;
}

function bkTotalCOS(bk) {
  return bkCrewCost(bk)+bkFuelCost(bk)+bkVehicleCost(bk)+bkMaterialCost(bk)+bkChargeCost(bk);
}

function bkTotalRevenue(bk) {
  return (bk.billing||[]).reduce(function(s,x){return s+(x.amt||0);},0);
}

// renderRates kept as alias so showMod('rates') still works briefly — now routes to settings
function renderRates(){ renderSettings(); }

// ── DRAG AND DROP ─────────────────────────────────────────────────────
function dragStart(e,jid){
  dragId=jid;
  e.dataTransfer.effectAllowed='move';
  setTimeout(function(){e.target.style.opacity='.3';},0);
}
function dragEnd(e){
  dragId=null;
  e.target.style.opacity='1';
  document.querySelectorAll('[style*="outline"]').forEach(function(el){el.style.outline='';});
}
function doDrop(e,jid,newDs){
  e.preventDefault(); e.stopPropagation();
  e.currentTarget.style.outline='';
  var j=jobs.filter(function(x){return x.id===jid;})[0];
  if(!j) return;
  var dur=Math.round((s2d(j.end)-s2d(j.start))/864e5);
  j.start=newDs;
  j.end=d2s(addDays(s2d(newDs),dur));
  toast(j.client+' moved to '+newDs); saveData('job', j.id, j);
  renderCal();
}

// ── VIEW JOB PANEL ────────────────────────────────────────────────────
function viewJob(id){
  var j=jobs.filter(function(x){return x.id===id;})[0];
  if(!j) return;
  pMode='view';
  el('p-title').textContent=j.client;
  el('p-sub').textContent=j.brand+' \u00b7 '+j.ref;
  var t=totalRev(j);
  var dur=jobDur(j);
  var cc=jobCrewCost(j);
  var cos=jobCOS(j);
  var mar=t>0?(t-cos)/t*100:null;
  var mCol=mar===null?'var(--t3)':mar>=30?'var(--green)':mar>=15?'var(--amber)':'var(--red)';
  var isMulti=j.start!==j.end;
  var crew=j.drivers.concat(j.porters).filter(function(x){return x;});

  var h='<div class="fsec">';
  h+='<div class="fsec-t"><i>1</i>Details</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:11px">';
  h+='<div class="di"><div class="dlbl">Brand</div><div class="dval">'+bbadge(j.brand)+'</div></div>';
  h+='<div class="di"><div class="dlbl">Status</div><div class="dval">'+sbadge(j.status)+'</div></div>';
  if(j.channel) h+='<div class="di"><div class="dlbl">Channel</div><div class="dval"><span style="font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;padding:2px 7px;border-radius:3px;background:var(--s1);border:1px solid var(--b1)">'+esc(j.channel)+'</span></div></div>';
  if(j.jobType) h+='<div class="di"><div class="dlbl">Job Type</div><div class="dval">'+esc(j.jobType)+'</div></div>';
  if(j.clientRef) h+='<div class="di"><div class="dlbl">Client Ref</div><div class="dval" style="font-weight:700;font-family:monospace;font-size:11.5px">'+esc(j.clientRef)+'</div></div>';
  if(j.moveManager){ var mm=MOVE_MANAGERS.filter(function(m){return m.id===j.moveManager;})[0]; if(mm) h+='<div class="di" style="grid-column:1/-1"><div class="dlbl">Move Manager</div><div class="dval"><div style="display:flex;align-items:center;gap:8px"><div style="width:28px;height:28px;border-radius:50%;background:var(--blue);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700">'+mm.name[0]+'</div><div><div style="font-weight:600">'+esc(mm.name)+'</div><div style="font-size:11px;color:var(--t3)">'+esc(mm.phone)+' &bull; '+esc(mm.email)+'</div></div></div></div></div>'; }
  h+='<div class="di"><div class="dlbl">Origin</div><div class="dval" style="display:flex;align-items:center;gap:6px">'+esc(j.origin)+(j.origin?'<button class="addr-map-btn has-addr" onclick="openMapModal(this.dataset.a)" data-a="'+esc(j.origin)+'" title="View map">🗺</button>':'')+'</div></div>';
  h+='<div class="di"><div class="dlbl">Destination</div><div class="dval" style="display:flex;align-items:center;gap:6px">'+esc(j.dest)+(j.dest && j.dest!=='INT STORE' && j.dest!=='EX STORE'?'<button class="addr-map-btn has-addr" onclick="openMapModal(this.dataset.a)" data-a="'+esc(j.dest)+'" title="View map">🗺</button>':'')+'</div></div>';
  h+='<div class="di"><div class="dlbl">Start</div><div class="dval" style="color:var(--blue);font-weight:700">'+fmtNice(j.start)+'</div></div>';
  h+='<div class="di"><div class="dlbl">End</div><div class="dval" style="color:var(--blue);font-weight:700">'+fmtNice(j.end)+(isMulti?' <span style="color:var(--t3);font-size:10px;font-weight:400">('+dur+'d)</span>':'')+'</div></div>';
  if(j.vol>0) h+='<div class="di"><div class="dlbl">Volume</div><div class="dval">'+j.vol.toLocaleString()+' ft\u00b3</div></div>';
  if(j.cbm>0) h+='<div class="di"><div class="dlbl">CBM</div><div class="dval">'+j.cbm+'</div></div>';
  h+='</div></div>';

  h+='<div class="fsec"><div class="fsec-t"><i>2</i>Crew &amp Vehicles</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:11px">';
  h+='<div class="di"><div class="dlbl">Drivers</div><div class="dval" style="display:flex;flex-wrap:wrap;gap:3px;margin-top:3px">';
  if(j.drivers.length){ for(var k=0;k<j.drivers.length;k++) h+=chip(j.drivers[k]); }
  else h+='<span style="color:var(--t3)">None</span>';
  h+='</div></div>';
  h+='<div class="di"><div class="dlbl">Porters</div><div class="dval" style="display:flex;flex-wrap:wrap;gap:3px;margin-top:3px">';
  if(j.porters.length){ for(var k=0;k<j.porters.length;k++) h+=chip(j.porters[k]); }
  else h+='<span style="color:var(--t3)">None</span>';
  h+='</div></div>';
  if(j.veh.length) h+='<div class="di" style="grid-column:1/-1"><div class="dlbl">Vehicles</div><div class="dval" style="margin-top:3px">'+j.veh.map(function(v){return chip('\uD83D\uDE9B '+v);}).join(' ')+'</div></div>';
  h+='<div class="di"><div class="dlbl">Fuel Cost</div><div class="dval">'+spv(fmt(jobFuelCost(j)),'jfuel-'+j.id)+'</div></div>';
  h+='</div></div>';

  h+='<div class="fsec"><div class="fsec-t"><i>3</i>Billing</div>';
  for(var k=0;k<j.billing.length;k++){
    h+='<div class="brow"><span class="blbl">'+esc(j.billing[k].item)+'</span><span class="bamt">'+(j.billing[k].amt>0?spv(fmt(j.billing[k].amt)):'TBC')+'</span></div>';
  }
  h+='<div class="btotal"><span>Total Revenue</span><span style="color:var(--blue)">'+spv(fmt(t))+'</span></div></div>';

  h+='<div class="fsec"><div class="fsec-t"><i>4</i>Cost &amp; Margin</div>';
  // --- HUMAN RESOURCES ---
  h+='<div class="cos-section-head">Human Resources</div>';
  for(var k=0;k<crew.length;k++){
    var cr=crewByName(crew[k]);
    if(cr){
      var cr_charge=(cr.chargeRate||cr.rate);
      h+='<div class="brow"><span class="blbl">'+crew[k]+' ('+cr.role+') &times; '+dur+'d @ &pound;'+cr_charge+'/day</span><span class="bamt">'+spv(fmt(cr_charge*dur))+'</span></div>';
    }
  }
  if(!crew.length) h+='<div class="brow"><span class="blbl" style="color:var(--t3)">No crew assigned</span><span class="bamt">—</span></div>';
  // --- VEHICLES ---
  h+='<div class="cos-section-head">Vehicles</div>';
  var vCostTotal=0;
  for(var vi=0;vi<j.veh.length;vi++){
    var vn=j.veh[vi];
    for(var vv=0;vv<VEHICLES.length;vv++){
      if(VEHICLES[vv].reg===vn||VEHICLES[vv].name===vn){
        var vdr=VEHICLES[vv].dayRate||0;
        vCostTotal+=vdr*dur;
        h+='<div class="brow"><span class="blbl">'+esc(vn)+' ('+VEHICLES[vv].type+') &times; '+dur+'d @ &pound;'+vdr+'/day</span><span class="bamt">'+spv(fmt(vdr*dur))+'</span></div>';
        break;
      }
    }
  }
  if(!j.veh.length) h+='<div class="brow"><span class="blbl" style="color:var(--t3)">No vehicles assigned</span><span class="bamt">—</span></div>';
  // --- FUEL / MILEAGE ---
  h+='<div class="cos-section-head">Mileage &amp; Fuel</div>';
  var fCost=jobFuelCost(j);
  var miles=j.mileage||0;
  var wh2=APP_SETTINGS.warehouseAddress||SL_CONFIG.companyPostcode||'WN73EQ';
  var fLabel, fNote='';
  if(j.journeyId){
    fLabel='Costed at journey level';
    fNote='';
  } else if(miles){
    // Show full route: wh→origin + origin→dest + dest→wh
    var outLeg=postcodeDistanceMiles(wh2,j.origin||'')||0;
    var retLeg=postcodeDistanceMiles(j.dest||j.origin||'',wh2)||0;
    var totalRoute=Math.round(outLeg)+miles+Math.round(retLeg);
    fLabel=Math.round(outLeg)+'mi to site + '+miles+'mi job + '+Math.round(retLeg)+'mi return = '+totalRoute+'mi total';
  } else {
    fLabel='Mileage not set — estimated';
    fNote='<div style="font-size:10.5px;color:var(--amber);padding:2px 0 4px;margin-left:2px">⚠ No mileage set — <a href="#" onclick="autoCalcMileageAndRefresh(\''+j.id+'\');return false;" style="color:var(--blue);text-decoration:underline">Calculate via Google Maps</a></div>';
  }
  h+='<div class="brow"><span class="blbl">Fuel / Mileage ('+fLabel+')</span><span class="bamt">'+spv(fmt(fCost))+'</span></div>';
  if(fNote) h+=fNote;
  // --- MATERIALS ---
  h+='<div class="cos-section-head">Materials</div>';
  var matCost=jobMatCost(j); var mats=j.materials||[];
  if(mats.length){
    for(var mi2=0;mi2<mats.length;mi2++){
      var matRec=MATERIALS.filter(function(x){return x.id===mats[mi2].id;})[0];
      if(matRec){
        var matLine=matRec.unitCost*(mats[mi2].qty||0);
        h+='<div class="brow"><span class="blbl">'+esc(matRec.name)+' &times; '+(mats[mi2].qty||0)+' @ &pound;'+matRec.unitCost+'</span><span class="bamt">'+spv(fmt(matLine))+'</span></div>';
      }
    }
  } else {
    h+='<div class="brow"><span class="blbl" style="color:var(--t3)">No materials assigned</span><span class="bamt">—</span></div>';
  }
  // --- GENERIC OVERHEAD ---
  var overhead=jobCOSOverhead(j); var crewCount=crew.length;
  h+='<div class="cos-section-head">General Overhead (COS)</div>';
  h+='<div class="brow"><span class="blbl">&pound;'+APP_SETTINGS.cosPerCrewPerDay+' per crew &times; '+dur+'d ('+crewCount+' people)</span><span class="bamt">'+spv(fmt(overhead))+'</span></div>';
  // --- TOTAL ---
  var totalCOS2=jobCOS(j);
  h+='<div class="brow" style="font-weight:700;border-top:2px solid var(--t1);padding-top:8px;margin-top:6px"><span class="blbl">Total COS</span><span class="bamt" style="color:var(--red)">'+spv(fmt(totalCOS2))+'</span></div>';
  h+='<div style="margin-top:11px;padding:11px;border-radius:var(--r);background:var(--s1);border:1px solid var(--b1);display:grid;grid-template-columns:1fr 1fr;gap:8px">';
  h+='<div class="di"><div class="dlbl">Revenue</div><div class="dval" style="color:var(--blue);font-weight:600">'+(t>0?spv(fmt(t)):'TBC')+'</div></div>';
  var mar2=t>0?(t-totalCOS2)/t*100:null;
  var mCol2=mar2===null?'var(--t3)':mar2>=30?'var(--green)':mar2>=15?'var(--amber)':'var(--red)';
  h+='<div class="di"><div class="dlbl">Gross Margin</div><div class="dval" style="font-weight:700;color:'+mCol2+'">'+spv(mar2!==null?fmt(t-totalCOS2):'TBC')+'</div></div>';
  h+='<div class="di"><div class="dlbl">Margin %</div><div class="dval" style="font-weight:700;font-size:20px;color:'+mCol2+'">'+spv(mar2!==null?mar2.toFixed(1)+'%':'&mdash;')+'</div></div>';
  h+='<div class="di"><div class="dlbl">Duration</div><div class="dval">'+dur+' day'+(dur!==1?'s':'')+'</div></div>';
  h+='</div>';
  if(mar2!==null&&mar2<15) h+='<div style="margin-top:8px;padding:7px 10px;background:#FFFBEB;border:1px solid #FFE97A;border-radius:var(--r);font-size:11.5px;color:#7A5200;font-weight:600">&#9888; Margin below 15% &mdash; review billing or crew</div>';
  h+='</div>';
  h+='</div>';
  if(mar!==null&&mar<15) h+='<div style="margin-top:8px;padding:7px 10px;background:#FFFBEB;border:1px solid #FFE97A;border-radius:var(--r);font-size:11.5px;color:#7A5200;font-weight:600">&#9888; Margin below 15% &mdash; review billing or crew</div>';
  h+='</div>';
  // Journey context
  if(j.journeyId){
    var jrn=journeyById(j.journeyId);
    if(jrn){
      var jjobs=jobsInJourney(jrn.id);
      var jrnIdx=jrn.jobIds.indexOf(j.id);
      var totalJMiles=Math.round(totalJourneyMiles(jrn));
      var legs=journeyLegs(jrn);
      var ovCost=journeyOvernightCost(jrn);
      h+='<div class="fsec"><div class="fsec-t"><i>5</i>&#128648; Journey</div>';
      h+='<div class="brow"><span class="blbl">Journey Ref</span><span style="font-family:monospace;font-weight:700;font-size:11.5px">'+esc(jrn.ref)+'</span></div>';
      h+='<div class="brow"><span class="blbl">This job</span><span style="font-size:12px">Job '+(jrnIdx+1)+' of '+jjobs.length+'</span></div>';
      h+='<div style="margin:8px 0;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--t3)">Journey Route</div>';
      for(var li=0;li<legs.length;li++){
        var leg=legs[li];
        var isReturnLeg=leg.isReturn;
        h+='<div class="brow" style="'+(isReturnLeg?'opacity:.6':'')+'"><span class="blbl" style="font-family:monospace;font-size:11px">'+esc(leg.from)+' &rarr; '+esc(leg.to)+(isReturnLeg?' <em style=\'font-style:italic;color:var(--t3);font-weight:400\'>return to depot</em>':'')+'</span><span style="font-size:11.5px;color:var(--t3)">~'+Math.round(leg.miles)+'mi</span></div>';
      }
      h+='<div class="brow" style="font-weight:700;margin-top:4px"><span class="blbl">Total journey distance</span><span>'+spv('~'+totalJMiles+' mi')+'</span></div>';
      if(jrn.overnights&&jrn.overnights.nights){
        h+='<div style="margin-top:8px;padding:8px 10px;background:var(--alt);border:1px solid var(--amber);border-radius:var(--r)">';
        h+='<div style="font-size:11px;font-weight:700;color:var(--amber);margin-bottom:4px">&#127769; Overnight: '+jrn.overnights.nights+' night'+(jrn.overnights.nights!==1?'s':'')+'</div>';
        h+='<div class="brow"><span class="blbl">Allowance per person</span><span>'+spv('£'+jrn.overnights.allowancePerPerson+'/night')+'</span></div>';
        h+='<div class="brow"><span class="blbl">Internal cost ('+jrn.crew.length+' crew)</span><span>'+spv(fmt(ovCost))+'</span></div>';
        h+='<div class="brow"><span class="blbl">Nights billed to client</span><span>'+jrn.overnights.billingNights+'</span></div>';
        h+='</div>';
      }
      h+='<div style="margin-top:8px"><button class="btn btn-sm btn-s" id="btn-view-journey">View Full Journey</button></div>';
      h+='</div>';
    }
  }

  // Storage link
  if(j.storageId){
    var linkedS=null;
    for(var ssi=0;ssi<STORAGE_RECORDS.length;ssi++) if(STORAGE_RECORDS[ssi].id===j.storageId){linkedS=STORAGE_RECORDS[ssi];break;}
    if(linkedS){
      h+='<div class="fsec"><div class="fsec-t"><i>6</i>&#127970; Linked Storage</div>';
      h+='<div class="brow"><span class="blbl">Record</span><span style="font-family:monospace;font-weight:700">'+esc(linkedS.id)+'</span></div>';
      h+='<div class="brow"><span class="blbl">Bay</span><span>'+esc(linkedS.bay||'—')+'</span></div>';
      h+='<div class="brow"><span class="blbl">Volume</span><span>'+spv((linkedS.cbm||0).toFixed(1)+' CBM')+'</span></div>';
      h+='<div class="brow"><span class="blbl">Status</span><span style="font-weight:700;text-transform:uppercase;font-size:10.5px;color:'+(linkedS.status==='active'?'var(--green)':'var(--t3)')+'">'+linkedS.status+'</span></div>';
      h+='<div style="margin-top:6px"><button class="btn btn-sm btn-s" id="btn-view-storage-link">View Storage</button></div>';
      h+='</div>';
    }
  }

  if(j.notes) h+='<div class="fsec"><div class="fsec-t"><i>'+(j.journeyId?7:j.storageId?6:5)+'</i>Notes</div><div style="background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:10px;font-size:12.5px;color:var(--t2);line-height:1.7">'+esc(j.notes)+'</div></div>';

  setH('p-body',h);
  setH('p-foot','<button class="btn btn-del btn-sm" id="btn-del-job">Delete</button><button class="btn btn-s" onclick="closePanel()">Close</button><button class="btn btn-p" id="btn-edit-job">Edit</button>');
  openPanel();

  // Attach events post-render
  var delBtn=document.getElementById('btn-del-job');
  if(delBtn) delBtn.addEventListener('click',function(){delJob(id);});
  var editBtn=document.getElementById('btn-edit-job');
  if(editBtn) editBtn.addEventListener('click',function(){openEdit(id);});
  var jrnBtn=document.getElementById('btn-view-journey');
  if(jrnBtn) jrnBtn.addEventListener('click',function(){viewJourney(j.journeyId);});
  var stoLinkBtn=document.getElementById('btn-view-storage-link');
  if(stoLinkBtn) stoLinkBtn.addEventListener('click',function(){viewStorage(j.storageId);});
}

// ── JOURNEY PANEL ─────────────────────────────────────────────────────
function viewJourney(id){
  var jrn=journeyById(id);
  if(!jrn) return;
  var jjobs=jobsInJourney(id);
  var legs=journeyLegs(jrn);
  var totalMiles=Math.round(totalJourneyMiles(jrn));
  var ovCost=journeyOvernightCost(jrn);
  var totalRev2=jjobs.reduce(function(s,j){return s+totalRev(j);},0);
  var totalCOS2=jjobs.reduce(function(s,j){return s+jobCOS(j);},0)+ovCost;
  var margin=totalRev2>0?(totalRev2-totalCOS2)/totalRev2*100:null;
  var mCol=margin===null?'var(--t3)':margin>=30?'var(--green)':margin>=15?'var(--amber)':'var(--red)';

  el('p-title').textContent=jrn.label;
  el('p-sub').textContent='Journey \u00b7 '+jrn.ref;

  var h='<div class="fsec"><div class="fsec-t"><i>1</i>Journey Overview</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px">';
  h+='<div class="di"><div class="dlbl">Jobs in Journey</div><div class="dval" style="font-size:18px;font-weight:700">'+jjobs.length+'</div></div>';
  h+='<div class="di"><div class="dlbl">Total Distance</div><div class="dval" style="font-size:18px;font-weight:700">'+spv('~'+totalMiles+' mi')+'</div></div>';
  h+='<div class="di"><div class="dlbl">Total Revenue</div><div class="dval" style="color:var(--blue);font-weight:700">'+spv(fmt(totalRev2))+'</div></div>';
  h+='<div class="di"><div class="dlbl">Gross Margin</div><div class="dval" style="color:'+mCol+';font-weight:700">'+spv(margin!==null?margin.toFixed(1)+'%':'—')+'</div></div>';
  h+='</div>';
  if(jrn.overnights&&jrn.overnights.nights){
    h+='<div style="padding:8px 10px;background:var(--alt);border:1px solid var(--amber);border-radius:var(--r);margin-bottom:8px">';
    h+='<span style="font-size:11px;font-weight:700;color:var(--amber)">&#127769; '+jrn.overnights.nights+' overnight'+(jrn.overnights.nights!==1?'s':'')+'</span>';
    h+=' <span style="font-size:11px;color:var(--t3);margin-left:8px">Internal cost: '+spv(fmt(ovCost))+'</span>';
    h+=' <span style="font-size:11px;color:var(--t3);margin-left:8px">Billed to client: '+jrn.overnights.billingNights+'n</span>';
    h+='</div>';
  }
  h+='</div>';

  // Journey route map (textual chain)
  h+='<div class="fsec"><div class="fsec-t"><i>2</i>Route Chain</div>';
  h+='<div style="font-size:11.5px">';
  var wh=SL_CONFIG.companyPostcode||'DEPOT';
  h+='<div style="display:flex;align-items:center;gap:6px;margin:4px 0"><div style="width:8px;height:8px;border-radius:50%;background:var(--blue);flex-shrink:0"></div><span style="font-weight:700;font-family:monospace">'+esc(wh)+'</span><span style="color:var(--t3);margin-left:2px">(Depot)</span></div>';
  for(var li=0;li<legs.length;li++){
    var leg=legs[li];
    var isReturn=leg.isReturn;
    var lineCol=isReturn?'var(--t4)':'var(--blue)';
    h+='<div style="display:flex;align-items:stretch;gap:6px;margin:0">';
    h+='<div style="display:flex;flex-direction:column;align-items:center;width:8px;flex-shrink:0"><div style="width:1px;flex:1;background:'+lineCol+'"></div></div>';
    h+='<div style="padding:2px 0;font-size:10.5px;color:'+(isReturn?'var(--t3)':'var(--t2)');h+=';font-style:'+(isReturn?'italic':'normal')+'">';
    h+=Math.round(leg.miles)+'mi &darr;';
    if(isReturn) h+=' <em>return to depot</em>';
    h+='</div></div>';
    h+='<div style="display:flex;align-items:center;gap:6px;margin:4px 0"><div style="width:8px;height:8px;border-radius:50%;background:'+(isReturn?'var(--t3)':'var(--green)')+';flex-shrink:0"></div><span style="font-weight:700;font-family:monospace">'+esc(leg.to)+'</span></div>';
  }
  h+='</div></div>';

  // Jobs list
  h+='<div class="fsec"><div class="fsec-t"><i>3</i>Jobs</div>';
  for(var ji=0;ji<jjobs.length;ji++){
    var jb=jjobs[ji];
    var jbRev=totalRev(jb);
    var jbCOS=jobCOS(jb);
    var jbMar=jbRev>0?(jbRev-jbCOS)/jbRev*100:null;
    var jbMCol=jbMar===null?'var(--t3)':jbMar>=30?'var(--green)':jbMar>=15?'var(--amber)':'var(--red)';
    var jbCrew=jb.drivers.concat(jb.porters).filter(function(x){return x;});
    h+='<div style="border:1px solid var(--b1);border-radius:var(--r);padding:10px;margin-bottom:8px;cursor:pointer;transition:box-shadow .15s" id="jrnjob-'+jb.id+'">';
    h+='<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px">';
    h+='<div><div style="font-weight:700;font-size:12.5px">Job '+(ji+1)+': '+esc(jb.client)+'</div>';
    h+='<div style="font-size:11px;color:var(--t3);font-family:monospace">'+esc(jb.ref)+'</div></div>';
    h+=bbadge(jb.brand)+'</div>';
    h+='<div style="font-size:11.5px;color:var(--t2);margin-bottom:4px">'+esc(jb.origin)+' &rarr; '+esc(jb.dest)+'</div>';
    h+='<div style="display:flex;gap:10px;font-size:11px">';
    h+='<span style="color:var(--blue);font-weight:600">'+spv(fmt(jbRev))+'</span>';
    h+='<span style="color:var(--red)">COS: '+spv(fmt(jbCOS))+'</span>';
    if(jbMar!==null) h+='<span style="font-weight:700;color:'+jbMCol+'">'+spv(jbMar.toFixed(1)+'%')+'</span>';
    h+='</div>';
    if(jbCrew.length){h+='<div style="margin-top:4px;display:flex;gap:3px;flex-wrap:wrap">';for(var ki=0;ki<jbCrew.length;ki++) h+=chip(jbCrew[ki]);h+='</div>';}
    if(jrn.overnights&&jrn.overnights.nights&&ji<jjobs.length-1){
      h+='<div style="margin-top:5px;font-size:10.5px;color:var(--amber);font-weight:600">&#127769; Overnight after this job</div>';
    }
    h+='</div>';
  }
  h+='</div>';

  // Totals
  h+='<div class="fsec"><div class="fsec-t"><i>4</i>Journey Totals</div>';
  h+='<div class="brow"><span class="blbl">Total Revenue</span><span class="bamt" style="color:var(--blue)">'+spv(fmt(totalRev2))+'</span></div>';
  if(ovCost) h+='<div class="brow"><span class="blbl">Overnight allowances (internal)</span><span class="bamt" style="color:var(--amber)">'+spv(fmt(ovCost))+'</span></div>';
  h+='<div class="brow"><span class="blbl">Total COS (incl. overnights)</span><span class="bamt" style="color:var(--red)">'+spv(fmt(totalCOS2))+'</span></div>';
  h+='<div class="btotal"><span>Journey Gross Margin</span><span style="color:'+mCol+'">'+spv(margin!==null?margin.toFixed(1)+'%':'—')+'</span></div>';
  h+='</div>';

  if(jrn.notes) h+='<div class="fsec"><div class="fsec-t">Notes</div><div style="background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:10px;font-size:12.5px;color:var(--t2);line-height:1.7">'+esc(jrn.notes)+'</div></div>';

  setH('p-body',h);
  setH('p-foot','<button class="btn btn-s" onclick="closePanel()">Close</button><button class="btn btn-p" id="btn-edit-journey">Edit Journey</button>');
  openPanel();

  // Attach job row click events
  for(var ji2=0;ji2<jjobs.length;ji2++){
    (function(jbId){
      var el2=document.getElementById('jrnjob-'+jbId);
      if(el2) el2.addEventListener('click',function(){viewJob(jbId);});
    })(jjobs[ji2].id);
  }
  var editJrnBtn=document.getElementById('btn-edit-journey');
  if(editJrnBtn) editJrnBtn.addEventListener('click',function(){editJourney(id);});
}

function editJourney(id){
  var jrn=journeyById(id);
  if(!jrn) return;
  var h='<div class="fsec"><div class="fsec-t">Journey Details</div>';
  h+='<div class="fg"><label class="lbl">Journey Label</label><input class="fi" id="jrn-lbl" value="'+esc(jrn.label)+'"></div>';
  h+='<div class="fg"><label class="lbl">Reference</label><input class="fi" id="jrn-ref" value="'+esc(jrn.ref)+'"></div>';
  h+='</div>';
  h+='<div class="fsec"><div class="fsec-t">Overnights</div>';
  h+='<div class="fg2">';
  h+='<div class="fg"><label class="lbl">Nights (internal cost)</label><input class="fi" type="number" id="jrn-nights" value="'+(jrn.overnights?jrn.overnights.nights:0)+'"></div>';
  h+='<div class="fg"><label class="lbl">Nights billed to client</label><input class="fi" type="number" id="jrn-bnights" value="'+(jrn.overnights?jrn.overnights.billingNights:0)+'"></div>';
  h+='</div>';
  h+='<div class="fg"><label class="lbl">Allowance per person per night £</label><input class="fi" type="number" id="jrn-allow" value="'+(jrn.overnights?jrn.overnights.allowancePerPerson:65)+'" step="0.01"></div>';
  h+='</div>';
  h+='<div class="fsec"><div class="fsec-t">Notes</div>';
  h+='<div class="fg"><textarea class="fi" id="jrn-notes" style="height:80px;resize:vertical">'+esc(jrn.notes||'')+'</textarea></div>';
  h+='</div>';

  el('p-title').textContent='Edit Journey';
  el('p-sub').textContent=jrn.ref;
  setH('p-body',h);
  setH('p-foot','<button class="btn btn-s" onclick="closePanel()">Cancel</button><button class="btn btn-p" id="btn-save-journey">Save</button>');
  openPanel();

  var saveBtn=document.getElementById('btn-save-journey');
  if(saveBtn) saveBtn.addEventListener('click',function(){
    jrn.label=(el('jrn-lbl')||{value:jrn.label}).value||jrn.label;
    jrn.ref=(el('jrn-ref')||{value:jrn.ref}).value||jrn.ref;
    if(!jrn.overnights) jrn.overnights={nights:0,allowancePerPerson:65,billingNights:0};
    jrn.overnights.nights=parseInt((el('jrn-nights')||{value:0}).value)||0;
    jrn.overnights.billingNights=parseInt((el('jrn-bnights')||{value:0}).value)||0;
    jrn.overnights.allowancePerPerson=parseFloat((el('jrn-allow')||{value:65}).value)||65;
    jrn.notes=(el('jrn-notes')||{value:''}).value||'';
    toast('Journey saved'); saveData('journey', jrn.id, jrn);
    viewJourney(id);
  });
}

// ── NEW / EDIT FORM ───────────────────────────────────────────────────
function openNew(ds){
  // Route through booking configurator for proper data capture
  if (ds) {
    CFG = cfgEmpty();
    CFG.startDate = ds;
    CFG.selectedDates = [ds];
    cfgStage = 0;
    el('cfg-head-ref').textContent = CFG.ref;
    el('cfg-head-title').textContent = 'New Job';
    el('cfg-backdrop').classList.add('on');
    el('cfg-panel').classList.add('on');
    cfgRenderStage();
    cfgUpdateNav();
  } else {
    openConfigurator(null);
  }
}
function openEdit(id){
  var j=jobs.filter(function(x){return x.id===id;})[0];
  if(!j) return;
  pMode='edit';
  eJob=JSON.parse(JSON.stringify(j));
  el('p-title').textContent='Edit Job';
  el('p-sub').textContent=j.client+' \u00b7 '+j.ref;
  renderForm(); openPanel();
}
function renderForm(){
  var j=eJob;
  var h='<div class="fsec"><div class="fsec-t"><i>1</i>Details</div>';
  h+='<div class="fg2">';
  h+='<div class="fg"><label class="lbl">Brand</label><select class="fi" id="fb" onchange="onJobBrandChange()">';
  for(var i=0;i<BRANDS.length;i++) h+='<option'+(j.brand===BRANDS[i]?' selected':'')+'>'+BRANDS[i]+'</option>';
  h+='</select></div>';
  h+='<div class="fg"><label class="lbl">Channel</label><select class="fi" id="fch" onchange="onJobChannelChange()">'+
    ['Partner','Account','Domestic'].map(function(ch){return '<option'+(ch===(j.channel||brandChannel(j.brand))?' selected':'')+'>'+ch+'</option>';}).join('')+
  '</select></div>';
  h+='<div class="fg"><label class="lbl">Job Type</label><select class="fi" id="fjt">'+
    ['Door to Door','Domestic','European','Sea','Air','Storage','Other'].map(function(t){return '<option'+(t===(j.jobType||'Door to Door')?' selected':'')+'>'+t+'</option>';}).join('')+
  '</select></div>';
  h+='<div class="fg"><label class="lbl">Internal Ref</label><input class="fi" id="fref" value="'+esc(j.ref)+'" placeholder="e.g. GB2600334-01"></div>';
  h+='<div class="fg" id="fg-cr"><label class="lbl">Client/Partner Ref</label><input class="fi" id="fcr" value="'+esc(j.clientRef||'')+'"></div>';
  h+='</div>';
  h+='<div class="fg" id="fg-mm" style="'+((['Partner','Account'].indexOf(j.channel||brandChannel(j.brand))>=0)?'':'display:none')+'"><label class="lbl">Move Manager</label><select class="fi" id="fmm">';
  h+='<option value="">— None —</option>';
  for(var mi=0;mi<MOVE_MANAGERS.length;mi++) h+='<option value="'+MOVE_MANAGERS[mi].id+'"'+(j.moveManager===MOVE_MANAGERS[mi].id?' selected':'')+'>'+esc(MOVE_MANAGERS[mi].name)+' ('+esc(MOVE_MANAGERS[mi].brand)+')</option>';
  h+='</select></div>';
  h+='<div class="fg"><label class="lbl">Client Name *</label><input class="fi" id="fcl" value="'+esc(j.client)+'" placeholder="Client name"></div>';
  h+='<div class="fg2">';
  h+='<div class="fg"><label class="lbl">Origin <span style="font-size:10px;color:var(--t3);font-weight:400">— type to lookup address</span></label><input class="fi" id="for" value="'+esc(j.origin)+'" placeholder="Start typing address or postcode…" autocomplete="off"></div>';
  h+='<div class="fg"><label class="lbl">Destination <span style="font-size:10px;color:var(--t3);font-weight:400">— type to lookup address</span></label><input class="fi" id="fde" value="'+esc(j.dest)+'" placeholder="Start typing address or postcode…" autocomplete="off"></div>';
  h+='<div class="fg"><label class="lbl">Start Date</label><input class="fi" type="date" id="fsd" value="'+j.start+'"></div>';
  h+='<div class="fg"><label class="lbl">End Date</label><input class="fi" type="date" id="fed" value="'+j.end+'"></div>';
  h+='<div class="fg"><label class="lbl">Volume ft&#179;</label><input class="fi" type="number" id="fvo" value="'+j.vol+'" min="0"></div>';
  h+='<div class="fg"><label class="lbl">CBM</label><input class="fi" type="number" id="fcb" value="'+j.cbm+'" step="0.01" min="0"></div>';
  h+='<div class="fg"><label class="lbl">Status</label><select class="fi" id="fst">';
  var statuses=['Scheduled','In Progress','Completed','Billed'];
  for(var i=0;i<statuses.length;i++) h+='<option'+(j.status===statuses[i]?' selected':'')+'>'+statuses[i]+'</option>';
  h+='</select></div>';
  h+='<div class="fg"><label class="lbl">Mileage (mi)</label><input class="fi" type="number" id="fmi" value="'+(j.mileage||0)+'" min="0" placeholder="0" title="Used to calculate fuel cost via vehicle rate"></div>';
  h+='<div class="fg"><label class="lbl">Fuel override &pound;</label><input class="fi" type="number" id="ffu" value="'+(j.fuel||0)+'" min="0" placeholder="Auto-calc" title="Leave 0 to auto-calculate from mileage &times; vehicle rate"></div>';
  h+='</div></div>';
  h+='<div class="fsec"><div class="fsec-t"><i>2</i>Crew</div>';
  h+='<div class="fg2">';
  h+='<div class="fg"><label class="lbl">Drivers</label><div style="display:flex;flex-wrap:wrap">';
  for(var i=0;i<CREW.length;i++) h+='<label class="cpill"><input type="checkbox" id="dr'+i+'"'+(j.drivers.indexOf(CREW[i].name)>=0?' checked':'')+'> <span>'+CREW[i].name+'</span></label>';
  h+='</div></div>';
  h+='<div class="fg"><label class="lbl">Porters</label><div style="display:flex;flex-wrap:wrap">';
  for(var i=0;i<CREW.length;i++) h+='<label class="cpill"><input type="checkbox" id="po'+i+'"'+(j.porters.indexOf(CREW[i].name)>=0?' checked':'')+'> <span>'+CREW[i].name+'</span></label>';
  h+='</div></div>';
  h+='</div>';
  h+='<div class="fg"><label class="lbl">Vehicles (comma separated)</label><input class="fi" id="fve" value="'+esc(j.veh.join(', '))+'"></div>';
  h+='</div>';
  h+='<div class="fsec"><div class="fsec-t"><i>3</i>Billing</div>';
  h+='<div id="blines">';
  for(var i=0;i<j.billing.length;i++) h+=bline(j.billing[i].item,j.billing[i].amt,i);
  h+='</div>';
  h+='<button class="btn btn-s btn-sm" style="margin-top:6px" onclick="addBline()">+ Add line</button>';
  h+='</div>';
  // Materials section
  h+='<div class="fsec"><div class="fsec-t"><i>4</i>Materials <span style="font-weight:400;font-size:11px;color:var(--t3)">(included in COS)</span></div>';
  h+='<div id="fmat-rows">';
  var jmats=j.materials||[];
  for(var mi3=0;mi3<jmats.length;mi3++) h+=matLine(jmats[mi3].id,jmats[mi3].qty,mi3);
  h+='</div>';
  h+='<button class="btn btn-s btn-sm" style="margin-top:6px" onclick="addMatLine()">+ Add material</button>';
  h+='</div>';
  h+='<div class="fsec"><div class="fsec-t"><i>5</i>Notes</div>';
  h+='<textarea class="fi" id="fno" placeholder="Instructions, contacts, access info&hellip;">'+esc(j.notes)+'</textarea>';
  h+='</div>';
  // Journey assignment
  h+='<div class="fsec"><div class="fsec-t"><i>6</i>Journey &amp; Sequence</div>';
  h+='<div class="fg2">';
  h+='<div class="fg"><label class="lbl">Journey (optional)</label><select class="fi" id="fjrn">';
  h+='<option value="">— Standalone job —</option>';
  for(var ji=0;ji<JOURNEYS.length;ji++) h+='<option value="'+JOURNEYS[ji].id+'"'+(j.journeyId===JOURNEYS[ji].id?' selected':'')+'>'+esc(JOURNEYS[ji].ref)+' — '+esc(JOURNEYS[ji].label)+'</option>';
  h+='</select></div>';
  h+='<div class="fg"><label class="lbl">Seq. in day (1=first)</label><input class="fi" type="number" id="fseq" value="'+(j.seqInDay||0)+'" min="0" placeholder="0 = n/a"></div>';
  h+='</div>';
  h+='<div class="fg2">';
  h+='<div class="fg"><label class="lbl">Linked Storage Record</label><select class="fi" id="fsto">';
  h+='<option value="">— None —</option>';
  for(var sti=0;sti<STORAGE_RECORDS.length;sti++) h+='<option value="'+STORAGE_RECORDS[sti].id+'"'+(j.storageId===STORAGE_RECORDS[sti].id?' selected':'')+'>'+esc(STORAGE_RECORDS[sti].id)+' — '+esc(STORAGE_RECORDS[sti].client)+'</option>';
  h+='</select></div>';
  h+='</div>';
  h+='</div>';
  setH('p-body',h);
  setH('p-foot','<button class="btn btn-s" onclick="closePanel()">Cancel</button><button class="btn btn-p" onclick="saveJob()">'+( pMode==='new'?'Create Job':'Save Changes')+'</button>');
}
function bline(item,amt,i){
  return '<div style="display:flex;gap:5px;margin-bottom:4px"><input class="fi" style="flex:2" placeholder="Item" value="'+esc(item)+'" id="bi'+i+'"><input class="fi" style="flex:1" type="number" placeholder="&pound;" value="'+amt+'" id="ba'+i+'" min="0" step="0.01"><button class="btn btn-g btn-sm" onclick="rmBline('+i+')">&#10005;</button></div>';
}
function addBline(){
  eJob.billing.push({item:'',amt:0});
  var bl=el('blines');
  var i=eJob.billing.length-1;
  bl.insertAdjacentHTML('beforeend',bline('',0,i));
}
function rmBline(i){ eJob.billing.splice(i,1); renderForm(); }

function matLine(matId,qty,i){
  var opts=MATERIALS.map(function(m){return '<option value="'+m.id+'"'+(m.id===matId?' selected':'')+'>'+esc(m.name)+' (&pound;'+m.unitCost+')</option>';}).join('');
  return '<div style="display:flex;gap:5px;margin-bottom:4px;align-items:center">'
    +'<select class="fi" style="flex:2" id="maid'+i+'"><option value="">— select —</option>'+opts+'</select>'
    +'<input class="fi" style="flex:1;max-width:70px" type="number" placeholder="Qty" min="0" step="1" value="'+(qty||0)+'" id="maqt'+i+'">'
    +'<button class="btn btn-g btn-sm" onclick="rmMatLine('+i+')">&#10005;</button></div>';
}
function addMatLine(){
  if(!eJob.materials) eJob.materials=[];
  eJob.materials.push({id:'',qty:1});
  var ml=el('fmat-rows');
  var i=eJob.materials.length-1;
  ml.insertAdjacentHTML('beforeend',matLine('',1,i));
}
function rmMatLine(i){ if(!eJob.materials) return; eJob.materials.splice(i,1); renderForm(); }

function onJobBrandChange() {
  var brand = (el('fb')||{}).value||'';
  var ch = brandChannel(brand);
  if(el('fch')) el('fch').value = ch;
  onJobChannelChange();
  // Auto-select MM for this brand
  var mm = mmForBrand(brand);
  if(el('fmm') && mm) el('fmm').value = mm.id;
}
function onJobChannelChange() {
  var ch = (el('fch')||{}).value||'';
  var isPartnerOrAccount = ch==='Partner'||ch==='Account';
  var mmDiv = el('fg-mm');
  if(mmDiv) mmDiv.style.display = isPartnerOrAccount ? '' : 'none';
}
function saveJob(){
  eJob.brand=el('fb').value;
  eJob.channel=el('fch').value;
  eJob.jobType=el('fjt').value;
  eJob.clientRef=el('fcr').value||'';
  eJob.moveManager=el('fmm').value||'';
  eJob.ref=el('fref').value;
  eJob.client=el('fcl').value;
  eJob.origin=el('for').value;
  eJob.dest=el('fde').value;
  eJob.start=el('fsd').value;
  eJob.end=el('fed').value||eJob.start;
  eJob.vol=parseFloat(el('fvo').value)||0;
  eJob.cbm=parseFloat(el('fcb').value)||0;
  eJob.status=el('fst').value;
  eJob.mileage=parseFloat(el('fmi').value)||0;
  eJob.fuel=parseFloat(el('ffu').value)||0;
  eJob.notes=el('fno').value;
  eJob.journeyId=(el('fjrn')||{value:''}).value||'';
  eJob.seqInDay=parseInt((el('fseq')||{value:0}).value)||0;
  eJob.storageId=(el('fsto')||{value:''}).value||'';
  eJob.veh=el('fve').value.split(',').map(function(s){return s.trim();}).filter(function(s){return s;});
  eJob.drivers=[];
  eJob.porters=[];
  for(var i=0;i<CREW.length;i++){
    if(el('dr'+i)&&el('dr'+i).checked) eJob.drivers.push(CREW[i].name);
    if(el('po'+i)&&el('po'+i).checked) eJob.porters.push(CREW[i].name);
  }
  eJob.billing=[];
  var i=0;
  while(el('bi'+i)){
    var item=el('bi'+i).value, amt=parseFloat(el('ba'+i).value)||0;
    if(item) eJob.billing.push({item:item,amt:amt});
    i++;
  }
  // Save materials
  eJob.materials=[];
  var mi3=0;
  while(el('maid'+mi3)){
    var matId=(el('maid'+mi3)||{}).value||'';
    var matQty=parseFloat((el('maqt'+mi3)||{}).value)||0;
    if(matId && matQty>0) eJob.materials.push({id:matId,qty:matQty});
    mi3++;
  }
  if(!eJob.client){ toast('Client name required'); return; }
  // Bidirectional storage link
  if(eJob.storageId){
    for(var si=0;si<STORAGE_RECORDS.length;si++){
      if(STORAGE_RECORDS[si].id===eJob.storageId && !STORAGE_RECORDS[si].jobId){
        STORAGE_RECORDS[si].jobId=eJob.id;
      }
    }
  }
  if(pMode==='new'){
    jobs.push(eJob);
    toast('Job created');
  } else {
    for(var k=0;k<jobs.length;k++) if(jobs[k].id===eJob.id){ jobs[k]=eJob; break; }
    toast('Saved');
  }
  closePanel(); renderCal();
  if(curMod==='crew') renderCrew();
  if(curMod==='finance') renderFinance();
  setBadge('job-badge',jobs.length);
  saveData('job', eJob.id, eJob);
}
function delJob(id){
  if(!confirm('Delete this job?')) return;
  jobs=jobs.filter(function(j){return j.id!==id;});
  closePanel(); renderCal(); toast('Deleted');
  setBadge('job-badge',jobs.length);
  deleteData('job', id);
}

// ── PANEL ─────────────────────────────────────────────────────────────
function openPanel(){ el('overlay').classList.add('on'); el('panel').classList.add('on'); }
function closePanel(){ el('overlay').classList.remove('on'); el('panel').classList.remove('on'); }

// ── EXPORT ────────────────────────────────────────────────────────────
function doExport(){
  var rows=[['ID','Ref','Brand','Client','Origin','Dest','Start','End','Vol','CBM','Drivers','Porters','Status','Revenue','COS','Margin%']];
  for(var i=0;i<jobs.length;i++){
    var j=jobs[i], t=totalRev(j), cos=jobCOS(j), m=t>0?((t-cos)/t*100):0;
    rows.push([j.id,j.ref,j.brand,j.client,j.origin,j.dest,j.start,j.end,j.vol,j.cbm,j.drivers.join('|'),j.porters.join('|'),j.status,t.toFixed(2),cos.toFixed(2),m.toFixed(1)+'%']);
  }
  var csv=rows.map(function(r){return r.map(function(c){return '"'+String(c).replace(/"/g,'""')+'"';}).join(',');}).join('\n');
  var a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download='ops_export.csv'; a.click();
  toast('Exported');
}


// ── STORAGE MODULE ────────────────────────────────────────────────────
// type: 'inout' = simple in/out job | 'longterm' = ongoing recurring billing
// billingUnit: 'cbm' = rate x CBM | 'flat' = flat rate per period
// Container types: standard (max 250ft³), small (max 150ft³), loose, pallet, lcl
var CONTAINER_TYPES = [
  {key:'standard', lbl:'Wooden Container (Standard)', maxFt:250, icon:'📦'},
  {key:'small',    lbl:'Wooden Container (Small)',    maxFt:150, icon:'📦'},
  {key:'loose',    lbl:'Loose Storage',               maxFt:null, icon:'🛋'},
  {key:'pallet',   lbl:'Pallet',                      maxFt:null, icon:'🪵'},
  {key:'lcl',      lbl:'LCL Case',                    maxFt:null, icon:'✈️'},
];

var STORAGE_RECORDS = [
  {id:'S001', type:'longterm', client:'Kitchen (Telford)', brand:'SIRVA',
   volFt:1792, cbm:51.2, volRemaining:1792,
   dateIn:'2026-03-04', dateOut:'', status:'active',
   billingType:'monthly', billingRate:85, billingUnit:'cbm',
   inboundJobId:'J001', outboundJobId:'',
   containers:[
     {containerNo:'C042', locNo:'W03-B2', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C043', locNo:'W03-B3', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C044', locNo:'W03-B4', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C045', locNo:'W03-B5', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C046', locNo:'W03-B6', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C047', locNo:'W03-B7', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C048', locNo:'W03-B8', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'L012', locNo:'W04-A1', type:'loose',    volFt:292, maxFt:null, dateIn:'2026-03-04', desc:'Large sofa — does not fit container'},
   ],
   notes:'Post-origin storage. Awaiting destination confirm.',
   billingHistory:[{date:'2026-03-02', amt:4352, desc:'Monthly storage (51.2 CBM @ £85)'}],
   accessLog:[]},
  {id:'S002', type:'inout', client:'GARNER', brand:'SIRVA',
   volFt:1750, cbm:50, volRemaining:1750,
   dateIn:'2026-03-04', dateOut:'2026-03-30', status:'out',
   billingType:'weekly', billingRate:120, billingUnit:'flat',
   inboundJobId:'J002', outboundJobId:'',
   containers:[
     {containerNo:'C021', locNo:'W02-A1', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C022', locNo:'W02-A2', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C023', locNo:'W02-A3', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C024', locNo:'W02-A4', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C025', locNo:'W02-A5', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C026', locNo:'W02-A6', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C027', locNo:'W02-A7', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
   ],
   notes:'3-week storage between moves.',
   billingHistory:[{date:'2026-03-30', amt:360, desc:'3 weeks flat @ £120/week'}],
   accessLog:[{ts:'2026-03-09T10:22:00', date:'2026-03-09', type:'access', note:'Partial access — 2 boxes removed', volChange:0}]},
];
var storageFilter = 'all';
var storageSeq = 3;
var curStorageId = null;

function calcStorageMonthly(s) {
  if (!s || s.status !== 'active') return 0;
  if (s.billingUnit === 'cbm') return s.billingRate * (s.cbm || 0);
  if (s.billingType === 'weekly') return s.billingRate * 4.33;
  return s.billingRate;
}

function renderStorage() {
  var all = STORAGE_RECORDS;
  var shown = all.filter(function(s) {
    if (storageFilter === 'active')   return s.status === 'active';
    if (storageFilter === 'inout')    return s.type === 'inout';
    if (storageFilter === 'longterm') return s.type === 'longterm';
    return true;
  });

  var active    = all.filter(function(s){return s.status==='active';});
  var totalCBM  = active.reduce(function(a,s){return a+(s.cbm||0);},0);
  var monthlyRev= active.reduce(function(a,s){return a+calcStorageMonthly(s);},0);

  var h = '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:18px">';
  h += '<div class="fc"><div class="fc-body" style="padding:14px"><div class="fs-lbl">Active Records</div><div class="fs-num">'+active.length+'</div></div></div>';
  h += '<div class="fc"><div class="fc-body" style="padding:14px"><div class="fs-lbl">Total CBM In</div><div class="fs-num">'+totalCBM.toFixed(1)+'</div></div></div>';
  h += '<div class="fc"><div class="fc-body" style="padding:14px"><div class="fs-lbl">Est. Monthly Revenue</div><div class="fs-num">'+spv(fmt(monthlyRev))+'</div></div></div>';
  h += '<div class="fc"><div class="fc-body" style="padding:14px"><div class="fs-lbl">In/Out Jobs</div><div class="fs-num">'+all.filter(function(s){return s.type==='inout';}).length+'</div></div></div>';
  h += '</div>';

  if (!shown.length) {
    h += '<div style="text-align:center;padding:60px;color:var(--t3);font-size:14px">No storage records match this filter</div>';
    setH('storage-out', h);
    setBadge('storage-badge',active.length);
    return;
  }

  h += '<div class="fc"><div class="fc-head"><div class="fc-title">Storage Records</div></div>';
  h += '<div style="overflow-x:auto"><table class="sc-table"><thead><tr>';
  h += '<th>Ref</th><th>Client</th><th>Brand</th><th>Type</th><th>Containers</th><th>Vol In</th><th>Remaining</th><th>In</th><th>Out</th><th>Billing/period</th><th>Status</th><th></th>';
  h += '</tr></thead><tbody>';

  for (var i = 0; i < shown.length; i++) {
    var s = shown[i];
    var stCol = s.status==='active' ? 'var(--green)' : s.status==='out' ? 'var(--t3)' : 'var(--amber)';
    var effRate = s.billingUnit==='cbm' ? s.billingRate*(s.cbm||0) : s.billingRate;
    var bDesc = spv(fmt(effRate)) + '/' + s.billingType.replace('ly','');
    var sid = s.id;
    var ctrs = s.containers || [];
    var firstLocs = ctrs.slice(0,2).map(function(c){return c.containerNo;}).join(', ');
    var volRem = s.volRemaining !== undefined ? s.volRemaining : (s.volFt || 0);
    h += '<tr class="sr-row" data-sid="'+sid+'" style="cursor:pointer">';
    h += '<td style="font-weight:700;font-family:monospace">'+esc(sid)+'</td>';
    h += '<td style="font-weight:600">'+esc(s.client)+'</td>';
    h += '<td>'+bbadge(s.brand)+'</td>';
    h += '<td><span style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;padding:2px 6px;border-radius:3px;background:var(--s1);border:1px solid var(--b1)">'+(s.type==='inout'?'In/Out':'Long-term')+'</span></td>';
    h += '<td style="font-size:12px">'+(ctrs.length ? '<span style="font-family:monospace;font-weight:600">'+esc(firstLocs)+(ctrs.length>2?' +'+( ctrs.length-2)+'…':'')+'</span>' : '<span style="color:var(--t4)">TBA</span>')+'</td>';
    h += '<td>'+spv((s.volFt||0).toLocaleString()+' ft³')+'</td>';
    h += '<td style="font-weight:600;color:'+(volRem===0?'var(--t3)':'var(--green)')+'">'+volRem.toLocaleString()+' ft³</td>';
    h += '<td>'+fmtNice(s.dateIn)+'</td>';
    h += '<td>'+(s.dateOut ? fmtNice(s.dateOut) : '<span style="color:var(--green);font-size:11px;font-weight:600">In storage</span>')+'</td>';
    h += '<td style="font-size:12px">'+s.billingType+' &bull; '+bDesc+'</td>';
    h += '<td><span style="font-size:10.5px;font-weight:700;color:'+stCol+'">'+s.status.toUpperCase()+'</span></td>';
    h += '<td class="sr-edit-btn" data-sid="'+sid+'"><button class="btn btn-s btn-sm">Edit</button></td>';
    h += '</tr>';
  }
  h += '</tbody></table></div></div>';
  setH('storage-out', h);
  setBadge('storage-badge',active.length);

  // Attach row click events
  var rows = document.querySelectorAll('.sr-row');
  rows.forEach(function(row) {
    row.addEventListener('click', function(e) {
      if (e.target.closest && e.target.closest('.sr-edit-btn')) return;
      viewStorage(row.getAttribute('data-sid'));
    });
  });
  var editBtns = document.querySelectorAll('.sr-edit-btn');
  editBtns.forEach(function(cell) {
    cell.addEventListener('click', function(e) {
      e.stopPropagation();
      editStorage(cell.getAttribute('data-sid'));
    });
  });
}

function setStorageFilter(f, btn) {
  storageFilter = f;
  var tabs = document.querySelectorAll('#mod-storage .vt');
  tabs.forEach(function(t){ t.classList.remove('on'); });
  if (btn) btn.classList.add('on');
  renderStorage();
}

function viewStorage(id) {
  curStorageId = id;
  var s = null;
  for (var i=0;i<STORAGE_RECORDS.length;i++) if(STORAGE_RECORDS[i].id===id){s=STORAGE_RECORDS[i];break;}
  if (!s) return;

  var stCol = s.status==='active'?'var(--green)':s.status==='out'?'var(--t3)':'var(--amber)';
  var h = '<div class="fsec"><div class="fsec-t"><i>1</i>Details</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:11px">';
  h += '<div class="di"><div class="dlbl">Client</div><div class="dval" style="font-weight:600">'+esc(s.client)+'</div></div>';
  h += '<div class="di"><div class="dlbl">Brand</div><div class="dval">'+bbadge(s.brand)+'</div></div>';
  h += '<div class="di"><div class="dlbl">Type</div><div class="dval">'+(s.type==='inout'?'In/Out Job':'Long-term Storage')+'</div></div>';
  h += '<div class="di"><div class="dlbl">Status</div><div class="dval"><span style="font-weight:700;text-transform:uppercase;font-size:11px;color:'+stCol+'">'+s.status+'</span></div></div>';
  h += '<div class="di"><div class="dlbl">Volume In</div><div class="dval">'+spv((s.volFt||0).toLocaleString()+' ft³ / '+(s.cbm||0).toFixed(1)+' CBM')+'</div></div>';
  h += '<div class="di"><div class="dlbl">Volume Remaining</div><div class="dval" style="color:var(--green);font-weight:700">'+(s.volRemaining!==undefined?s.volRemaining:(s.volFt||0))+' ft³</div></div>';
  h += '<div class="di"><div class="dlbl">Date In</div><div class="dval" style="color:var(--blue);font-weight:700">'+fmtNice(s.dateIn)+'</div></div>';
  h += '<div class="di"><div class="dlbl">Date Out</div><div class="dval">'+(s.dateOut?('<span style="font-weight:700">'+fmtNice(s.dateOut)+'</span>'):'<span style="color:var(--green);font-weight:600">Still in storage</span>')+'</div></div>';
  if (s.eventualDest) h += '<div class="di" style="grid-column:span 2"><div class="dlbl">Eventual Destination</div><div class="dval" style="color:var(--blue);font-weight:600">📍 '+esc(s.eventualDest)+'</div></div>';
  h += '</div></div>';

  // Containers
  var containers = s.containers || [];
  h += '<div class="fsec"><div class="fsec-t"><i>2</i>Containers &amp; Locations</div>';
  if (containers.length) {
    h += '<div style="overflow-x:auto"><table class="sc-table" style="font-size:12px"><thead><tr><th>Container No.</th><th>Location</th><th>Type</th><th>Volume ft³</th><th>Date In</th></tr></thead><tbody>';
    for (var ci2=0;ci2<containers.length;ci2++) {
      var ct2 = containers[ci2];
      var ctDef = CONTAINER_TYPES.filter(function(x){return x.key===ct2.type;})[0];
      var ctLbl = ctDef ? ctDef.lbl : ct2.type;
      var overFill = ctDef && ctDef.maxFt && ct2.volFt > ctDef.maxFt;
      h += '<tr>';
      h += '<td style="font-family:monospace;font-weight:700">'+esc(ct2.containerNo)+'</td>';
      h += '<td style="font-family:monospace">'+esc(ct2.locNo)+'</td>';
      h += '<td>'+esc(ctLbl)+'</td>';
      h += '<td style="font-weight:600'+(overFill?';color:#E44258':'')+'">'+ct2.volFt+(overFill?' ⚠ over max ('+ctDef.maxFt+')':'')+'</td>';
      h += '<td>'+fmtNice(ct2.dateIn)+'</td>';
      h += '</tr>';
    }
    h += '</tbody></table></div>';
    h += '<button class="btn btn-s btn-sm" style="margin-top:8px" id="btn-add-container">+ Add Container</button>';
  } else {
    h += '<div style="color:#7A849E;font-size:12px;padding:8px 0">No containers assigned yet — will be assigned when goods arrive at warehouse.</div>';
    h += '<button class="btn btn-s btn-sm" id="btn-add-container">+ Add Container</button>';
  }
  h += '</div>';

  var effRate = s.billingUnit==='cbm' ? s.billingRate*(s.cbm||0) : s.billingRate;
  h += '<div class="fsec"><div class="fsec-t"><i>3</i>Billing</div>';
  h += '<div class="brow"><span class="blbl">Rate model</span><span class="bamt" style="font-size:12px">'+esc(s.billingType)+' &times; '+(s.billingUnit==='cbm'?'CBM':'flat')+'</span></div>';
  h += '<div class="brow"><span class="blbl">Unit rate</span><span class="bamt">'+spv('£'+s.billingRate+' per '+(s.billingUnit==='cbm'?'CBM/'+s.billingType:s.billingType))+'</span></div>';
  if (s.billingUnit==='cbm') h += '<div class="brow"><span class="blbl">Effective '+s.billingType+' charge</span><span class="bamt">'+spv(fmt(effRate))+'</span></div>';
  if (s.billingHistory && s.billingHistory.length) {
    h += '<div style="margin-top:10px"><div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--t3);margin-bottom:6px">Billing History</div>';
    for (var k=0;k<s.billingHistory.length;k++) {
      var bh = s.billingHistory[k];
      h += '<div class="brow"><span class="blbl">'+esc(bh.date)+' — '+esc(bh.desc)+'</span><span class="bamt">'+spv(fmt(bh.amt))+'</span></div>';
    }
    h += '</div>';
  }
  h += '</div>';

  // Access log — now with types and timestamps
  h += '<div class="fsec"><div class="fsec-t"><i>4</i>Movement &amp; Access Log</div>';
  if (s.accessLog && s.accessLog.length) {
    for (var k2=0;k2<s.accessLog.length;k2++) {
      var al = s.accessLog[k2];
      var alIcon = al.type==='inbound'?'⬇️':al.type==='outbound'?'⬆️':'📋';
      var alTime = al.ts ? ' <span style="font-size:10px;color:var(--t4)">'+al.ts.replace('T',' ').slice(0,16)+'</span>' : '';
      h += '<div class="brow" style="align-items:flex-start">';
      h += '<span class="blbl" style="font-size:11px">'+alIcon+' '+esc(al.date)+alTime+'</span>';
      h += '<span style="font-size:11.5px;color:var(--t2);max-width:55%;text-align:right">'+esc(al.note)+'</span>';
      h += '</div>';
    }
  } else {
    h += '<div style="color:var(--t3);font-size:12px;padding:6px 0">No movements recorded yet</div>';
  }
  h += '<div style="margin-top:8px"><button class="btn btn-s btn-sm" id="btn-access-log">+ Log Manual Entry</button></div>';
  h += '</div>';

  if (s.notes) h += '<div class="fsec"><div class="fsec-t">Notes</div><div style="background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:10px;font-size:12.5px;color:var(--t2);line-height:1.7">'+esc(s.notes)+'</div></div>';

  el('p-title').textContent = s.client;
  el('p-sub').textContent = s.brand + ' · ' + s.id;
  setH('p-body', h);

  var footHtml = '<button class="btn btn-s" onclick="closePanel()">Close</button>';
  if (s.status === 'active') {
    footHtml += '<button class="btn btn-p" id="btn-book-delivery" style="background:var(--green);border-color:var(--green)">📦 Book Delivery</button>';
  }
  footHtml += '<button class="btn btn-s" id="btn-edit-storage">Edit</button>';
  setH('p-foot', footHtml);
  openPanel();

  // Attach events after render
  var editBtn = document.getElementById('btn-edit-storage');
  if (editBtn) editBtn.addEventListener('click', function(){ editStorage(id); });
  var bookBtn = document.getElementById('btn-book-delivery');
  if (bookBtn) bookBtn.addEventListener('click', function(){ whBookDelivery(id); });
  var accessBtn = document.getElementById('btn-access-log');
  if (accessBtn) accessBtn.addEventListener('click', function(){ addStorageAccess(id); });
  var addCtnrBtn = document.getElementById('btn-add-container');
  if (addCtnrBtn) addCtnrBtn.addEventListener('click', function(){ addStorageContainer(id); });
}

function addStorageAccess(id) {
  var note = prompt('Manual access/note (e.g. "Client collected 3 boxes — approx 45ft³"):');
  if (!note) return;
  var rec = null;
  for (var i=0;i<STORAGE_RECORDS.length;i++) if(STORAGE_RECORDS[i].id===id){rec=STORAGE_RECORDS[i];break;}
  if (!rec) return;
  if (!rec.accessLog) rec.accessLog = [];
  var ts = new Date().toISOString();
  rec.accessLog.push({ts:ts, date:ts.slice(0,10), type:'manual', note:note, volChange:0});
  toast('Access entry logged');
  viewStorage(id);
}

function addStorageContainer(id) {
  var rec = null;
  for (var i=0;i<STORAGE_RECORDS.length;i++) if(STORAGE_RECORDS[i].id===id){rec=STORAGE_RECORDS[i];break;}
  if (!rec) return;
  if (!rec.containers) rec.containers = [];

  // Build a small inline form in the panel
  var ctTypeOpts = CONTAINER_TYPES.map(function(ct){
    return '<option value="'+ct.key+'">'+ct.lbl+'</option>';
  }).join('');
  var fh = '<div class="fsec"><div class="fsec-t">Add Container / Unit</div>';
  fh += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
  fh += '<div class="fg"><label class="lbl">Container No.</label><input class="fi" id="nctr-no" placeholder="e.g. C049"></div>';
  fh += '<div class="fg"><label class="lbl">Location No.</label><input class="fi" id="nctr-loc" placeholder="e.g. W03-B9"></div>';
  fh += '<div class="fg"><label class="lbl">Type</label><select class="fi" id="nctr-type">'+ctTypeOpts+'</select></div>';
  fh += '<div class="fg"><label class="lbl">Volume ft³</label><input class="fi" type="number" id="nctr-vol" placeholder="0" min="0"></div>';
  fh += '</div></div>';

  el('p-title').textContent = 'Add Container — ' + id;
  el('p-sub').textContent = rec.client;
  setH('p-body', fh);
  setH('p-foot', '<button class="btn btn-s" onclick="viewStorage(\''+id+'\')">Cancel</button><button class="btn btn-p" id="btn-save-container">Add Container</button>');
  var saveBtn = document.getElementById('btn-save-container');
  if (saveBtn) saveBtn.addEventListener('click', function(){
    var cno   = (el('nctr-no')||{}).value||'';
    var loc   = (el('nctr-loc')||{}).value||'';
    var ctype = (el('nctr-type')||{}).value||'standard';
    var vol   = parseFloat((el('nctr-vol')||{}).value)||0;
    if (!cno) { toast('Container number required'); return; }
    var ctDef = CONTAINER_TYPES.filter(function(x){return x.key===ctype;})[0];
    var maxFt = ctDef ? ctDef.maxFt : null;
    if (maxFt && vol > maxFt) {
      if (!confirm('Warning: ' + vol + ' ft³ exceeds max capacity of ' + maxFt + ' ft³ for a ' + ctDef.lbl + '. Add anyway?')) return;
    }
    rec.containers.push({containerNo:cno, locNo:loc, type:ctype, volFt:vol, maxFt:maxFt, dateIn:d2s(new Date())});
    // Log it
    var ts2 = new Date().toISOString();
    if (!rec.accessLog) rec.accessLog = [];
    rec.accessLog.push({ts:ts2, date:ts2.slice(0,10), type:'container-add',
      note:'Container '+cno+' added — Location '+loc+' ('+ctype+', '+vol+' ft³).',
      volChange:vol});
    // Update volRemaining if it was undefined
    if (rec.volRemaining === undefined) rec.volRemaining = rec.volFt || 0;
    toast('Container ' + cno + ' added'); saveData('storage', s.id, s);
    viewStorage(id);
  });
}

function newStorageRecord() {
  var id = 'S' + String(100+storageSeq++).slice(-3);
  STORAGE_RECORDS.push({
    id:id, type:'longterm', client:'', brand:BRANDS[0]||'',
    volFt:0, cbm:0, volRemaining:0,
    dateIn:d2s(new Date()), dateOut:'', status:'active',
    billingType:'monthly', billingRate:85, billingUnit:'cbm',
    inboundJobId:'', outboundJobId:'',
    containers:[], notes:'', billingHistory:[], accessLog:[]
  });
  editStorage(id);
}

function editStorage(id) {
  var s = null;
  for (var i=0;i<STORAGE_RECORDS.length;i++) if(STORAGE_RECORDS[i].id===id){s=STORAGE_RECORDS[i];break;}
  if (!s) return;

  var h = '<div class="fsec"><div class="fsec-t">Storage Details</div>';
  h += '<div class="fg2">';
  h += '<div class="fg"><label class="lbl">Client</label><input class="fi" id="st-cl" value="'+esc(s.client)+'"></div>';
  h += '<div class="fg"><label class="lbl">Brand</label><select class="fi" id="st-br">'+BRANDS.map(function(b){return '<option'+(b===s.brand?' selected':'')+'>'+b+'</option>';}).join('')+'</select></div>';
  h += '</div><div class="fg2">';
  h += '<div class="fg"><label class="lbl">Type</label><select class="fi" id="st-ty"><option value="longterm"'+(s.type==='longterm'?' selected':'')+'>Long-term</option><option value="inout"'+(s.type==='inout'?' selected':'')+'>In/Out</option></select></div>';
  h += '<div class="fg"><label class="lbl">Bay / Unit</label><input class="fi" id="st-bay" value="'+esc(s.bay||'')+'"></div>';
  h += '</div><div class="fg2">';
  h += '<div class="fg"><label class="lbl">Volume ft³</label><input class="fi" type="number" id="st-vft" value="'+(s.volFt||0)+'"></div>';
  h += '<div class="fg"><label class="lbl">CBM</label><input class="fi" type="number" id="st-cbm" value="'+(s.cbm||0)+'" step="0.01"></div>';
  h += '</div><div class="fg2">';
  h += '<div class="fg"><label class="lbl">Date In</label><input class="fi" type="date" id="st-in" value="'+esc(s.dateIn)+'"></div>';
  h += '<div class="fg"><label class="lbl">Date Out</label><input class="fi" type="date" id="st-out" value="'+esc(s.dateOut||'')+'"></div>';
  h += '</div><div class="fg2">';
  h += '<div class="fg"><label class="lbl">Billing Period</label><select class="fi" id="st-bty"><option'+(s.billingType==='monthly'?' selected':'')+'>monthly</option><option'+(s.billingType==='weekly'?' selected':'')+'>weekly</option><option'+(s.billingType==='flat'?' selected':'')+'>flat</option></select></div>';
  h += '<div class="fg"><label class="lbl">Rate Unit</label><select class="fi" id="st-bu"><option value="cbm"'+(s.billingUnit==='cbm'?' selected':'')+'>Rate × CBM</option><option value="flat"'+(s.billingUnit==='flat'?' selected':'')+'>Flat rate</option></select></div>';
  h += '</div><div class="fg2">';
  h += '<div class="fg"><label class="lbl">Rate £</label><input class="fi" type="number" id="st-rate" value="'+(s.billingRate||0)+'" step="0.01"></div>';
  h += '<div class="fg"><label class="lbl">Status</label><select class="fi" id="st-st"><option'+(s.status==='active'?' selected':'')+'>active</option><option'+(s.status==='pending'?' selected':'')+'>pending</option><option'+(s.status==='out'?' selected':'')+'>out</option></select></div>';
  h += '</div>';
  h += '<div class="fg"><label class="lbl">Notes</label><textarea class="fi" id="st-no" style="height:70px;resize:vertical">'+esc(s.notes||'')+'</textarea></div>';
  h += '</div>';

  el('p-title').textContent = id;
  el('p-sub').textContent = 'Storage Record';
  setH('p-body', h);
  setH('p-foot', '<button class="btn btn-del btn-sm" id="btn-del-storage">Delete</button><button class="btn btn-s" onclick="closePanel()">Cancel</button><button class="btn btn-p" id="btn-save-storage">Save</button>');
  openPanel();

  var saveBtn = document.getElementById('btn-save-storage');
  if (saveBtn) saveBtn.addEventListener('click', function(){ saveStorage(id); });
  var delBtn = document.getElementById('btn-del-storage');
  if (delBtn) delBtn.addEventListener('click', function(){ delStorage(id); });
}

function saveStorage(id) {
  for (var i=0;i<STORAGE_RECORDS.length;i++) {
    if (STORAGE_RECORDS[i].id !== id) continue;
    var s = STORAGE_RECORDS[i];
    s.client   = (el('st-cl')||{value:s.client}).value || s.client;
    s.brand    = (el('st-br')||{value:s.brand}).value || s.brand;
    s.type     = (el('st-ty')||{value:s.type}).value || s.type;
    s.bay      = (el('st-bay')||{value:''}).value || '';
    s.volFt    = parseFloat((el('st-vft')||{value:0}).value) || 0;
    s.cbm      = parseFloat((el('st-cbm')||{value:0}).value) || 0;
    s.dateIn   = (el('st-in')||{value:s.dateIn}).value || s.dateIn;
    s.dateOut  = (el('st-out')||{value:''}).value || '';
    s.billingType = (el('st-bty')||{value:s.billingType}).value || s.billingType;
    s.billingUnit = (el('st-bu')||{value:s.billingUnit}).value || s.billingUnit;
    s.billingRate = parseFloat((el('st-rate')||{value:0}).value) || 0;
    s.status   = (el('st-st')||{value:s.status}).value || s.status;
    s.notes    = (el('st-no')||{value:''}).value || '';
    break;
  }
  closePanel();
  renderStorage();
  toast('Storage saved'); saveData('storage', s.id, s);
}

function delStorage(id) {
  if (!confirm('Delete storage record ' + id + '?')) return;
  STORAGE_RECORDS = STORAGE_RECORDS.filter(function(r){ return r.id !== id; });
  closePanel();
  renderStorage();
  deleteData('storage', id);
}



// ── BOOKING MODULE ────────────────────────────────────────────────────
var bookings = [];
var CLIENT_JOBS = [];   // master client job records
var SURVEYS  = [];   // standalone survey records
var bkSeq = 142; // next sequential number (legacy)
var JOB_COUNTER = 4000; // next job number base (7-digit)
var curBkId = null;
var curClientJobId = null;
var cjFilter = 'all'; // filter for client records list
var bkMode = 'none'; // 'new' | 'edit' | 'view'

// SocketLabs config — user fills these in Settings
var SL_CONFIG = {
  // Legacy SocketLabs config — kept for mileage calculation compatibility only
  companyPostcode: 'WN73EQ',  // Origin postcode for mileage calculations
};

var TWILIO_CONFIG = {
  // Twilio SMS & Voice — configure in Settings → Branding & Email
  accountSid:  '',   // Twilio Account SID (from twilio.com/console)
  authToken:   '',   // Twilio Auth Token
  fromNumber:  '',   // Your Twilio phone number (e.g. +441234567890)
  fromWhatsApp:'',   // WhatsApp-enabled number (e.g. whatsapp:+14155238886)
};

// ── App-wide cost of sale + maps settings ─────────────────────────────
var APP_VERSION = 'v40 — 1 Mar 2026';

var APP_SETTINGS = {
  googleMapsKey:    '',            // Google Maps Platform API key
  warehouseAddress: 'WN7 3EQ',    // Legacy single warehouse address (kept for compatibility)
  cosPerCrewPerDay: 125,           // £ overhead per crew (team) per day — flat regardless of headcount
  returnMileage:    true,          // Auto-add return-to-warehouse leg
  fuelPricePerLitre:1.49,         // Pence per litre (for reference / display)
  // ── Company / Branding (rebrand-ready) ──────────────────────────────
  companyName:      'MoveSquad',
  companyTagline:   'Professional Moving Services',
  companyEmail:     'updates@onwards.network',
  companyPhone:     '',
  companyWebsite:   'onwards.network',
  companyAddress:   '',
  emailReplyTo:     'updates@onwards.network',
  emailFooter:      'MoveSquad Group, Registered in England & Wales',
  emailAccentColor: '#0073EA',
};
var WAREHOUSES = [
  { id: 'WH1', name: 'Main Warehouse', address: 'WN7 3EQ', isDefault: true }
];

// ── VEHICLES ──────────────────────────────────────────────────────────
var VEHICLES = [
  {id:'V001',name:'Luton 1',reg:'PO23 YDN',colour:'White',type:'Luton',length:4.2,width:2.1,height:2.2,volCapFt:850,mileRate:0.35,dayRate:120},
  {id:'V002',name:'Luton 2',reg:'PO23 YDM',colour:'White',type:'Luton',length:4.2,width:2.1,height:2.2,volCapFt:850,mileRate:0.35,dayRate:120},
  {id:'V003',name:'7.5T Lorry',reg:'PO23 YDP',colour:'White',type:'7.5T',length:6.5,width:2.4,height:2.6,volCapFt:1750,mileRate:0.52,dayRate:185},
];

// ── MATERIALS ─────────────────────────────────────────────────────────
var MATERIALS = [
  {id:'M001',name:'2 cu.ft Carton',type:'Carton',unitCost:0.95},
  {id:'M002',name:'4 cu.ft Carton',type:'Carton',unitCost:1.20},
  {id:'M003',name:'6 cu.ft Carton',type:'Carton',unitCost:1.95},
  {id:'M004',name:'Layflat Carton',type:'Carton',unitCost:2.20},
  {id:'M005',name:'Wardrobe Carton',type:'Carton',unitCost:6.00},
];

// ── CHARGES ───────────────────────────────────────────────────────────
var CHARGES = [
  {id:'C001',name:'Toll Road',defaultAmt:12,perUnit:false},
  {id:'C002',name:'Clean Air Zone',defaultAmt:150,perUnit:false},
  {id:'C003',name:'Permit Charge',defaultAmt:20,perUnit:false},
  {id:'C004',name:'Parking Charge',defaultAmt:6,perUnit:false},
];

function genRef() {
  var n = bkSeq++;
  return 'BOK-' + (n < 10 ? '0000' : n < 100 ? '000' : n < 1000 ? '00' : n < 10000 ? '0' : '') + n;
}

function bkStatusCls(s) {
  if (s === 'Confirmed') return 'bst-confirmed';
  if (s === 'Email Sent') return 'bst-sent';
  return 'bst-pending';
}


// ══════════════════════════════════════════════════════════════════════
// SURVEY MODULE
// ══════════════════════════════════════════════════════════════════════
var curSurveyId = null;

function openNewSurvey(prefill) {
  curSurveyId = null;
  el('survey-modal-title').textContent = 'New Survey';
  el('survey-modal-ref').textContent = '';
  renderSurveyForm(prefill || {});
  el('survey-backdrop').style.display = 'flex';
}

function openEditSurvey(id) {
  var sv = SURVEYS.filter(function(s){ return s.id === id; })[0];
  if (!sv) return;
  curSurveyId = id;
  el('survey-modal-title').textContent = 'Edit Survey';
  el('survey-modal-ref').textContent = sv.ref || '';
  renderSurveyForm(sv);
  el('survey-backdrop').style.display = 'flex';
  // Show resend button if survey has client email
  var resendBtn = el('sv-resend-btn');
  if (resendBtn) resendBtn.style.display = sv.clientEmail ? 'inline-flex' : 'none';
}

function closeSurveyModal() {
  el('survey-backdrop').style.display = 'none';
}

function renderSurveyForm(sv) {
  sv = sv || {};
  var h = '';

  // Brand + channel
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">';
  h += '<div><label class="lbl">Brand / Partner</label><select class="fi" id="sv-brand">';
  BRANDS.forEach(function(b){ h += '<option'+(b===(sv.brand||BRANDS[0])?' selected':'')+'>'+b+'</option>'; });
  h += '</select></div>';
  h += '<div><label class="lbl">Job Type</label><select class="fi" id="sv-jobtype">';
  ['Door to Door','Domestic','European','Sea','Air','Storage','Other'].forEach(function(t){
    h += '<option'+(t===(sv.jobType||'Door to Door')?' selected':'')+'>'+t+'</option>';
  });
  h += '</select></div>';
  h += '</div>';

  // Client name
  h += '<div style="margin-bottom:12px"><label class="lbl">Client Name</label>';
  h += '<input class="fi" id="sv-client" value="'+esc(sv.clientName||'')+'" placeholder="Full name"></div>';

  // Contact details
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">';
  h += '<div><label class="lbl">Client Email</label><input class="fi" id="sv-email" type="email" value="'+esc(sv.clientEmail||'')+'" placeholder="client@example.com"></div>';
  h += '<div><label class="lbl">Client Phone</label><input class="fi" id="sv-phone" value="'+esc(sv.clientPhone||'')+'" placeholder="07700 000000"></div>';
  h += '</div>';

  // Address/postcode
  h += '<div style="margin-bottom:12px"><label class="lbl">Survey Address / Postcode</label>';
  h += '<input class="fi" id="sv-postcode" value="'+esc(sv.postcode||'')+'" placeholder="e.g. SW1A 1AA or full address" autocomplete="off"></div>';

  // Date + time
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">';
  h += '<div><label class="lbl">Survey Date</label><input type="date" class="fi" id="sv-date" value="'+esc(sv.surveyDate||'')+'"></div>';
  h += '<div><label class="lbl">Time</label><input type="time" class="fi" id="sv-time" value="'+esc(sv.surveyTime||'')+'"></div>';
  h += '</div>';

  // Surveyor (from crew list, or free text)
  h += '<div style="margin-bottom:12px"><label class="lbl">Surveyor</label><select class="fi" id="sv-surveyor">';
  h += '<option value="">— Unassigned —</option>';
  CREW.forEach(function(c){ h += '<option'+(c.name===(sv.surveyor||'')?' selected':'')+'>'+c.name+'</option>'; });
  h += '</select></div>';

  // Status
  h += '<div style="margin-bottom:12px"><label class="lbl">Status</label><select class="fi" id="sv-status">';
  ['Scheduled','Completed','No Show','Cancelled'].forEach(function(s){
    h += '<option'+(s===(sv.status||'Scheduled')?' selected':'')+'>'+s+'</option>';
  });
  h += '</select></div>';

  // Notes
  h += '<div><label class="lbl">Notes (access, contact, special instructions)</label>';
  h += '<textarea class="fi" id="sv-notes" rows="3" style="resize:vertical">'+esc(sv.notes||'')+'</textarea></div>';

  el('survey-form-body').innerHTML = h;

  // Bind address autocomplete to postcode field
  setTimeout(function(){
    var pcEl = document.getElementById('sv-postcode');
    if (pcEl && !pcEl._addrBound) bindAddressField(pcEl);
  }, 60);
}

function saveSurvey() {
  var client = (el('sv-client')||{}).value.trim();
  var date   = (el('sv-date')||{}).value;
  if (!client) { toast('Client name is required'); return; }
  if (!date)   { toast('Survey date is required'); return; }

  var sv = {
    id:         curSurveyId || ('SV' + Date.now()),
    ref:        'SV-' + String(SURVEYS.length + 1).padStart(4,'0'),
    brand:      (el('sv-brand')||{}).value || BRANDS[0],
    jobType:    (el('sv-jobtype')||{}).value || 'Door to Door',
    clientName:  client,
    clientEmail: (el('sv-email')||{}).value.trim(),
    clientPhone: (el('sv-phone')||{}).value.trim(),
    postcode:    (el('sv-postcode')||{}).value.trim(),
    surveyDate: date,
    surveyTime: (el('sv-time')||{}).value,
    surveyor:   (el('sv-surveyor')||{}).value,
    status:     (el('sv-status')||{}).value || 'Scheduled',
    notes:      (el('sv-notes')||{}).value.trim(),
    createdAt:  curSurveyId
                  ? (SURVEYS.filter(function(s){return s.id===curSurveyId;})[0]||{}).createdAt || new Date().toISOString()
                  : new Date().toISOString(),
    updatedAt:  new Date().toISOString(),
  };

  if (curSurveyId) {
    var idx = SURVEYS.findIndex ? SURVEYS.findIndex(function(s){return s.id===curSurveyId;})
                                : (function(){ for(var i=0;i<SURVEYS.length;i++) if(SURVEYS[i].id===curSurveyId) return i; return -1; })();
    if (idx >= 0) SURVEYS[idx] = sv; else SURVEYS.push(sv);
  } else {
    SURVEYS.push(sv);
  }

  saveData('survey', sv.id, sv);
  closeSurveyModal();
  toast('Survey saved — ' + sv.clientName + ' on ' + fmtNice(sv.surveyDate));
  // Auto-send confirmation email if client email present
  if (sv.clientEmail) {
    setTimeout(function() { sendSurveyConfirmationEmail(sv.id, { resend: false }); }, 1000);
  }
  renderBkSurveyList();
  // Refresh calendar if open
  if (curMod === 'calendar') renderActiveMod();
  if (curMod === 'dashboard') renderDashboard();
}

function deleteSurvey(id) {
  if (!confirm('Delete this survey?')) return;
  SURVEYS = SURVEYS.filter(function(s){ return s.id !== id; });
  // Note: no delete API yet, but save empty replacement
  saveData('settings'); // trigger save cycle
  renderBkSurveyList();
  toast('Survey deleted');
}

function renderBkSurveyList() {
  var container = el('bk-survey-list');
  if (!container) return;

  var sorted = SURVEYS.slice().sort(function(a,b){ return a.surveyDate < b.surveyDate ? -1 : 1; });
  var now = d2s(new Date());
  var upcoming = sorted.filter(function(s){ return s.surveyDate >= now; });
  var past     = sorted.filter(function(s){ return s.surveyDate < now; });

  var h = '';
  if (!sorted.length) {
    h = '<div style="padding:20px;text-align:center;color:var(--t3);font-size:12px">No surveys yet.<br>Click + New Survey to add one.</div>';
    container.innerHTML = h;
    return;
  }

  function renderSurveyRow(sv) {
    var stCol = {'Scheduled':'var(--blue)','Completed':'var(--green)','No Show':'var(--red)','Cancelled':'var(--t3)'}[sv.status]||'var(--t3)';
    var out = '<div style="padding:9px 12px;border-bottom:1px solid var(--s2);display:flex;gap:10px;align-items:flex-start;cursor:pointer" data-svid="'+sv.id+'" onclick="openEditSurvey(this.dataset.svid)">';
    out += '<div style="flex:1;min-width:0">';
    out += '<div style="font-weight:700;font-size:12.5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(sv.clientName)+'</div>';
    out += '<div style="font-size:11px;color:var(--t3);margin-top:1px">'+esc(sv.brand)+' &middot; '+esc(sv.jobType)+'</div>';
    out += '<div style="font-size:11px;color:var(--t2);margin-top:2px">'+esc(sv.postcode||'')+(sv.surveyor?' &middot; '+esc(sv.surveyor):'')+'</div>';
    out += '</div>';
    out += '<div style="text-align:right;flex-shrink:0">';
    out += '<div style="font-size:11.5px;font-weight:700;color:var(--t1)">'+fmtNice(sv.surveyDate)+'</div>';
    out += '<div style="font-size:10px;margin-top:2px">'+(sv.surveyTime||'')+'</div>';
    out += '<div style="font-size:10px;font-weight:700;color:'+stCol+';margin-top:3px">'+sv.status+'</div>';
    out += '</div>';
    out += '</div>';
    return out;
  }

  if (upcoming.length) {
    h += '<div style="padding:6px 12px 4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)">Upcoming</div>';
    upcoming.forEach(function(sv){ h += renderSurveyRow(sv); });
  }
  if (past.length) {
    h += '<div style="padding:6px 12px 4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)">Past</div>';
    past.slice(0, 20).forEach(function(sv){ h += renderSurveyRow(sv); });
  }
  container.innerHTML = h;
}


function initBookingMod() {
  renderBkList();
  renderBkSurveyList();
}

function renderBkList() {
  var h = '';
  if (!bookings.length) {
    h = '<div style="padding:30px 16px;text-align:center;color:var(--t3);font-size:12px">No bookings yet.<br>Click + New Booking to start.</div>';
  } else {
    for (var i = bookings.length - 1; i >= 0; i--) {
      var b = bookings[i];
      var color = BC[b.brand] || '#888';
      h += '<div class="bk-item' + (b.id === curBkId ? ' on' : '') + '" onclick="viewBooking(\'' + b.id + '\')">';
      h += '<div class="bk-dot" style="background:' + color + '"></div>';
      h += '<div style="flex:1;min-width:0">';
      h += '<div class="bk-ref">' + b.ref + '</div>';
      h += '<div class="bk-client">' + esc(b.clientName) + '</div>';
      h += '<div class="bk-meta">' + b.startDate + ' &bull; ' + esc(b.origin) + '</div>';
      h += '<div style="margin-top:4px"><span class="bst ' + bkStatusCls(b.status) + '">' + b.status + '</span></div>';
      h += '</div></div>';
    }
  }
  setH('bk-list', h);
  setBadge('bk-badge',bookings.length);
}

function newBooking() {
  openConfigurator(null);
}

function viewBooking(id) {
  var b = bookings.filter(function(x) { return x.id === id; })[0];
  if (!b) return;
  curBkId = id;
  bkMode = 'view';
  renderBkList();
  el('bk-right-title').innerHTML = '<span class="ref-badge">' + b.ref + '</span> &nbsp;' + esc(b.clientName);
  setH('bk-right-actions',
    '<button class="btn btn-s btn-sm" onclick="editBooking(\'' + id + '\')">&#9998; Edit</button>' +
    '<button class="btn btn-p btn-sm" onclick="showEmailPreview(\'' + id + '\')">&#9993; Send Confirmation</button>'
  );
  renderBookingDetail(b);
}

function editBooking(id) {
  openConfigurator(id);
}

function renderBookingDetail(b) {
  var color = BC[b.brand] || '#888';
  var h = '<div class="fade-in">';

  // Header card
  h += '<div class="bf-section" style="border-left:4px solid ' + color + '">';
  h += '<div class="bf-body" style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px">';
  h += '<div class="di"><div class="dlbl">Brand</div><div class="dval">' + bbadge(b.brand) + '</div></div>';
  h += '<div class="di"><div class="dlbl">Status</div><div class="dval"><span class="bst ' + bkStatusCls(b.status) + '">' + b.status + '</span></div></div>';
  h += '<div class="di"><div class="dlbl">Ref</div><div class="dval"><span class="ref-badge">' + b.ref + '</span></div></div>';
  h += '<div class="di"><div class="dlbl">Client</div><div class="dval" style="font-weight:600">' + esc(b.clientName) + '</div></div>';
  h += '<div class="di"><div class="dlbl">Client Email</div><div class="dval" style="color:var(--blue)">' + esc(b.clientEmail) + '</div></div>';
  h += '<div class="di"><div class="dlbl">Client Phone</div><div class="dval">' + esc(b.clientPhone) + '</div></div>';
  h += '</div></div>';

  // Move details
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">2</div><div class="bf-sec-title">Move Details</div></div>';
  h += '<div class="bf-body" style="display:grid;grid-template-columns:1fr 1fr;gap:14px">';
  h += '<div class="di"><div class="dlbl">Start Date</div><div class="dval" style="color:var(--blue);font-weight:600">' + fmtNice(b.startDate) + '</div></div>';
  h += '<div class="di"><div class="dlbl">End Date</div><div class="dval" style="color:var(--blue);font-weight:600">' + (b.endDate !== b.startDate ? fmtNice(b.endDate) : 'Same day') + '</div></div>';
  h += '<div class="di"><div class="dlbl">Origin</div><div class="dval">' + esc(b.origin) + '</div></div>';
  h += '<div class="di"><div class="dlbl">Destination</div><div class="dval">' + esc(b.dest) + '</div></div>';
  h += '<div class="di"><div class="dlbl">Volume</div><div class="dval">' + (b.volume ? b.volume + ' ft³' : '&mdash;') + '</div></div>';
  h += '<div class="di"><div class="dlbl">CBM</div><div class="dval">' + (b.cbm ? b.cbm : '&mdash;') + '</div></div>';
  h += '</div></div>';

  // Billing
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">3</div><div class="bf-sec-title">Billing</div></div>';
  h += '<div class="bf-body">';
  if (b.billing && b.billing.length) {
    for (var k = 0; k < b.billing.length; k++) {
      h += '<div class="brow"><span class="blbl">' + esc(b.billing[k].item) + '</span><span class="bamt">' + (b.billing[k].amt > 0 ? fmt(b.billing[k].amt) : 'TBC') + '</span></div>';
    }
    var bTot = b.billing.reduce(function(s, x) { return s + x.amt; }, 0);
    h += '<div class="btotal"><span>Total Revenue</span><span style="color:var(--blue)">' + fmt(bTot) + '</span></div>';
  } else {
    h += '<span style="color:var(--t3);font-size:12px">No billing lines added</span>';
  }
  h += '</div></div>';

  // Cost & Margin
  var bkRev  = bkTotalRevenue(b);
  var bkCrew = bkCrewCost(b);
  var bkFuel = bkFuelCost(b);
  var bkRetF = bkReturnFuelCost(b);
  var bkVeh  = bkVehicleCost(b);
  var bkMat  = bkMaterialCost(b);
  var bkChg  = bkChargeCost(b);
  var bkOvhd = bkCosOverhead(b);
  var bkCOS  = bkCrew + bkFuel + bkRetF + bkVeh + bkMat + bkChg + bkOvhd;
  var bkMgn  = bkRev > 0 ? bkRev - bkCOS : null;
  var bkMpct = bkRev > 0 ? (bkMgn / bkRev) * 100 : null;
  var bkMcol = bkMpct === null ? 'var(--t3)' : bkMpct >= 30 ? 'var(--green)' : bkMpct >= 15 ? 'var(--amber)' : 'var(--red)';
  var bkDurD = Math.max(1, Math.round((s2d(b.endDate) - s2d(b.startDate)) / 864e5) + 1);
  var bkIsOvernight = bkDurD > 1;

  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">4</div>';
  h += '<div class="bf-sec-title">Cost &amp; Margin</div>';
  if (bkMpct !== null) h += '<span style="font-size:22px;font-weight:700;color:' + bkMcol + '">' + bkMpct.toFixed(1) + '%</span>';
  h += '</div><div class="bf-body">';
  h += '<div style="display:grid;grid-template-columns:1fr 190px;gap:16px">';

  // Left: itemised COS
  h += '<div>';
  var j2 = jobs.filter(function(x) { return x.id === b.id; })[0];
  var detCrew = j2 ? j2.drivers.concat(j2.porters).filter(function(x){return x;}) : [];

  // ── Human Resources ──
  if (detCrew.length) {
    h += '<div class="cos-section-head">👷 Human Resources</div>';
    for (var k = 0; k < detCrew.length; k++) {
      var cr2 = crewByName(detCrew[k]);
      if (cr2) {
        var bd2 = crewNotionalBreakdown(cr2, bkDurD);
        var pid2 = 'bk-'+b.id+'-cr-'+k;
        h += '<div class="cb-row"><span style="color:var(--t2)">' + esc(detCrew[k]) + ' &times; ' + bkDurD + 'd @ ' + spv('&pound;'+crewNotionalRate(cr2).toFixed(2)+'/day', 'bkrate-'+pid2) + '</span><span style="color:var(--red)">' + spv(fmt(bd2.total), 'bkcc-'+pid2) + '</span></div>';
        if (cr2.employed) {
          if (bd2.holAmt>0) h += '<div class="cb-row" style="padding-left:14px"><span style="color:var(--t3);font-size:11px">Holiday ('+cr2.holiday+'%)</span><span style="color:var(--t3);font-size:11px">' + spv(fmt(bd2.holAmt), 'bkhl-'+pid2) + '</span></div>';
          if (bd2.niAmt>0)  h += '<div class="cb-row" style="padding-left:14px"><span style="color:var(--t3);font-size:11px">Employer NI ('+cr2.ni+'%)</span><span style="color:var(--t3);font-size:11px">' + spv(fmt(bd2.niAmt), 'bkni-'+pid2) + '</span></div>';
          if (bd2.penAmt>0) h += '<div class="cb-row" style="padding-left:14px"><span style="color:var(--t3);font-size:11px">Pension ('+cr2.pension+'%)</span><span style="color:var(--t3);font-size:11px">' + spv(fmt(bd2.penAmt), 'bkpen-'+pid2) + '</span></div>';
        }
      }
    }
  }

  // ── Vehicles ──
  var detVehs = b.vehicles || (j2 ? (j2.veh||[]).map(function(r){var v=VEHICLES.filter(function(x){return x.reg===r||x.name===r;})[0]; return v?{id:v.id}:null;}).filter(Boolean) : []);
  if (detVehs.length) {
    h += '<div class="cos-section-head">🚛 Vehicles</div>';
    for (var k = 0; k < detVehs.length; k++) {
      var dv = VEHICLES.filter(function(x){return x.id===detVehs[k].id;})[0];
      if (dv) h += '<div class="cb-row"><span style="color:var(--t2)">' + esc(dv.name) + ' (' + esc(dv.reg) + ') &times; ' + bkDurD + 'd @ &pound;' + dv.dayRate + '/day</span><span style="color:var(--red)">' + spv(fmt(dv.dayRate * bkDurD)) + '</span></div>';
    }
  }

  // ── Mileage / Fuel ──
  if (bkFuel > 0 || bkRetF > 0) {
    h += '<div class="cos-section-head">⛽ Mileage &amp; Fuel</div>';
    var jobMiles = j2 ? (j2.mileage||0) : 0;
    if (bkFuel > 0) {
      h += '<div class="cb-row"><span style="color:var(--t2)">Outward journey' + (jobMiles ? ' ('+jobMiles+' mi)' : '') + '</span><span style="color:var(--red)">' + spv('&pound;' + bkFuel) + '</span></div>';
    }
    if (bkRetF > 0) {
      h += '<div class="cb-row"><span style="color:var(--t2)">Return to depot' + (jobMiles ? ' (~'+jobMiles+' mi)' : '') + ' <span style="font-size:10px;color:var(--t4)">(same-day)</span></span><span style="color:var(--red)">' + spv('&pound;' + bkRetF) + '</span></div>';
    }
    if (bkIsOvernight) {
      h += '<div style="font-size:10.5px;color:var(--t3);padding:2px 0">↳ Overnight job — no return leg</div>';
    }
  }

  // ── Materials ──
  var detMats = b.materials || [];
  if (detMats.length) {
    h += '<div class="cos-section-head">📦 Materials</div>';
    for (var k = 0; k < detMats.length; k++) {
      var dm = MATERIALS.filter(function(x){return x.id===detMats[k].id;})[0];
      if (dm) h += '<div class="cb-row"><span style="color:var(--t2)">' + esc(dm.name) + ' &times; ' + detMats[k].qty + ' @ &pound;' + dm.unitCost + ' each</span><span style="color:var(--red)">' + spv(fmt(dm.unitCost * detMats[k].qty)) + '</span></div>';
    }
  }

  // ── Other Charges ──
  var detChgs = b.charges || [];
  if (detChgs.length) {
    h += '<div class="cos-section-head">🏷 Charges</div>';
    for (var k = 0; k < detChgs.length; k++) {
      h += '<div class="cb-row"><span style="color:var(--t2)">' + esc(detChgs[k].name) + '</span><span style="color:var(--red)">' + spv(fmt(detChgs[k].amt)) + '</span></div>';
    }
  }

  // ── COS Overhead ──
  if (bkOvhd > 0) {
    h += '<div class="cos-section-head">📊 Daily Overhead (COS)</div>';
    var ovRate = APP_SETTINGS.cosPerCrewPerDay || 125;
    h += '<div class="cb-row"><span style="color:var(--t2)">Overhead &pound;'+ovRate+'/day &times; '+bkDurD+'d ('+detCrew.length+' people)</span><span style="color:var(--red)">' + spv(fmt(bkOvhd)) + '</span></div>';
    h += '<div style="font-size:10.5px;color:var(--t4);padding:1px 0">Configurable in Settings → Cost of Sale &amp; Maps</div>';
  }

  h += '<div class="cb-row" style="font-weight:700;border-top:2px solid var(--b1);margin-top:6px;padding-top:7px"><span>Total COS</span><span style="color:var(--red)">' + spv(fmt(bkCOS)) + '</span></div>';
  h += '</div>';

  // Right: summary panel
  h += '<div class="cost-breakdown">';
  h += '<div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);margin-bottom:8px">Summary</div>';
  h += '<div class="cb-row" style="font-size:12px"><span>Revenue</span><span style="color:var(--blue)">' + fmt(bkRev) + '</span></div>';
  h += '<div class="cb-row" style="font-size:12px"><span>Total COS</span><span style="color:var(--red)">' + spv(fmt(bkCOS), 'bksum-cos-'+b.id) + '</span></div>';
  if (bkCrew>0)  h += '<div class="cb-row" style="font-size:11px;padding:1px 0"><span style="color:var(--t3);padding-left:8px">Crew</span><span style="color:var(--t3)">' + spv(fmt(bkCrew), 'bksum-crew-'+b.id) + '</span></div>';
  if (bkFuel>0)  h += '<div class="cb-row" style="font-size:11px;padding:1px 0"><span style="color:var(--t3);padding-left:8px">Fuel (out)</span><span style="color:var(--t3)">' + spv('&pound;'+bkFuel) + '</span></div>';
  if (bkRetF>0)  h += '<div class="cb-row" style="font-size:11px;padding:1px 0"><span style="color:var(--t3);padding-left:8px">Fuel (return)</span><span style="color:var(--t3)">' + spv('&pound;'+bkRetF) + '</span></div>';
  if (bkVeh>0)   h += '<div class="cb-row" style="font-size:11px;padding:1px 0"><span style="color:var(--t3);padding-left:8px">Vehicles</span><span style="color:var(--t3)">' + spv(fmt(bkVeh)) + '</span></div>';
  if (bkMat>0)   h += '<div class="cb-row" style="font-size:11px;padding:1px 0"><span style="color:var(--t3);padding-left:8px">Materials</span><span style="color:var(--t3)">' + spv(fmt(bkMat)) + '</span></div>';
  if (bkChg>0)   h += '<div class="cb-row" style="font-size:11px;padding:1px 0"><span style="color:var(--t3);padding-left:8px">Charges</span><span style="color:var(--t3)">' + spv(fmt(bkChg)) + '</span></div>';
  if (bkOvhd>0)  h += '<div class="cb-row" style="font-size:11px;padding:1px 0"><span style="color:var(--t3);padding-left:8px">Overhead</span><span style="color:var(--t3)">' + spv(fmt(bkOvhd)) + '</span></div>';
  h += '<div class="cb-total" style="color:' + bkMcol + '"><span>Margin</span><span>' + spv((bkMgn !== null ? fmt(bkMgn) : 'TBC'), 'bksum-mgn-'+b.id) + '</span></div>';
  if (bkMpct !== null) h += '<div style="font-size:30px;font-weight:700;color:' + bkMcol + ';text-align:center;padding:6px 0;letter-spacing:-1px">' + bkMpct.toFixed(1) + '%</div>';
  if (bkMpct !== null && bkMpct < 15) h += '<div style="font-size:11px;background:#FFFBEB;border:1px solid #FFE97A;border-radius:4px;padding:5px 7px;color:#7A5200;">&#9888; Below 15% &mdash; review billing</div>';
  h += '</div></div></div></div>';

  // Notes
  if (b.notes) {
    h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">5</div><div class="bf-sec-title">Notes / Instructions</div></div>';
    h += '<div class="bf-body" style="font-size:12.5px;color:var(--t2);line-height:1.7;white-space:pre-wrap">' + esc(b.notes) + '</div></div>';
  }

  // Email log
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">&#9993;</div><div class="bf-sec-title">Communication Log</div></div>';
  h += '<div class="bf-body">';
  if (b.emailLog && b.emailLog.length) {
    for (var k = 0; k < b.emailLog.length; k++) {
      var log = b.emailLog[k];
      h += '<div class="fin-row"><div class="fin-lbl" style="display:flex;align-items:center;gap:7px">';
      h += '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,12 2,6"/></svg>';
      h += esc(log.subject) + '</div>';
      h += '<div class="fin-val" style="color:var(--t3);font-size:10.5px">' + log.sentAt + '</div></div>';
    }
  } else {
    h += '<span style="color:var(--t3);font-size:12px">No emails sent yet.</span>&nbsp;';
    h += '<button class="btn btn-p btn-sm" onclick="showEmailPreview(\'' + b.id + '\')">Send Confirmation</button>';
  }
  h += '</div></div>';

  h += '</div>';
  setH('bk-right-body', h);
}

function renderBookingForm(b, ref) {
  var j = b || {};
  var BRAND_LIST = ['SIRVA', 'BRITANNIA', 'MOVESQUAD', 'EMS', 'STERLING'];
  var STATUS_LIST = ['Scheduled', 'In Progress', 'Completed', 'Billed'];

  var h = '<div class="fade-in">';

  // AI email parser
  h += '<div class="ai-parse-box">';
  h += '<div class="ai-parse-title">';
  h += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>';
  h += 'AI Email Parser</div>';
  h += '<div class="ai-parse-sub">Paste a booking confirmation email, instruction sheet, or any message below. Claude will extract all the details and pre-fill the form instantly.</div>';
  h += '<textarea class="ai-parse-ta" id="email-paste" placeholder="Paste email text here...&#10;&#10;e.g. Dear team, please confirm the following move:&#10;Client: John Smith&#10;Move date: 20th March 2025&#10;Origin: 14 High Street, Manchester, M1 2AB&#10;Destination: 7 Oak Avenue, Leeds, LS1 3CD&#10;Volume: approx 1,200 cubic feet&#10;..."></textarea>';
  h += '<div style="display:flex;gap:7px;margin-top:8px">';
  h += '<button class="btn btn-p btn-sm" id="parse-btn" onclick="parseEmail()">&#10003; Extract Details</button>';
  h += '<button class="btn btn-s btn-sm" onclick="el(\'email-paste\').value=\'\'">Clear</button>';
  h += '</div></div>';

  // Section 1: Client
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">1</div><div class="bf-sec-title">Client Details</div></div>';
  h += '<div class="bf-body">';
  h += '<div class="bf-row col2"><div class="bf-field"><label class="bf-label">Client Name *</label><input class="bf-input" id="bk-client" value="' + esc(j.clientName || '') + '" placeholder="Full name or company"></div>';
  h += '<div class="bf-field"><label class="bf-label">Brand *</label><select class="bf-input bf-select" id="bk-brand">';
  for (var i = 0; i < BRAND_LIST.length; i++) h += '<option' + (j.brand === BRAND_LIST[i] ? ' selected' : '') + '>' + BRAND_LIST[i] + '</option>';
  h += '</select></div></div>';
  h += '<div class="bf-row col2"><div class="bf-field"><label class="bf-label">Client Email</label><input class="bf-input" id="bk-email" type="email" value="' + esc(j.clientEmail || '') + '" placeholder="client@example.com"></div>';
  h += '<div class="bf-field"><label class="bf-label">Client Phone</label><input class="bf-input" id="bk-phone" value="' + esc(j.clientPhone || '') + '" placeholder="07700 000000"></div></div>';
  h += '</div></div>';

  // Section 2: Move
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">2</div><div class="bf-sec-title">Move Details</div></div>';
  h += '<div class="bf-body">';
  h += '<div class="bf-row col2"><div class="bf-field"><label class="bf-label">Start Date *</label><input class="bf-input" id="bk-start" type="date" value="' + (j.startDate || '') + '"></div>';
  h += '<div class="bf-field"><label class="bf-label">End Date</label><input class="bf-input" id="bk-end" type="date" value="' + (j.endDate || '') + '"></div></div>';
  h += '<div class="bf-row col1"><div class="bf-field"><label class="bf-label">Origin Address *</label><input class="bf-input" id="bk-origin" value="' + esc(j.origin || '') + '" placeholder="Full address incl. postcode"></div></div>';
  h += '<div class="bf-row col1"><div class="bf-field"><label class="bf-label">Destination Address *</label><input class="bf-input" id="bk-dest" value="' + esc(j.dest || '') + '" placeholder="Full address incl. postcode"></div></div>';
  h += '<div class="bf-row col3"><div class="bf-field"><label class="bf-label">Volume ft³</label><input class="bf-input" id="bk-vol" type="number" value="' + (j.volume || '') + '" min="0" placeholder="0"></div>';
  h += '<div class="bf-field"><label class="bf-label">CBM</label><input class="bf-input" id="bk-cbm" type="number" step="0.01" value="' + (j.cbm || '') + '" min="0" placeholder="0.00"></div>';
  h += '<div class="bf-field"><label class="bf-label">Status</label><select class="bf-input bf-select" id="bk-status">';
  for (var i = 0; i < STATUS_LIST.length; i++) h += '<option' + (j.status === STATUS_LIST[i] ? ' selected' : '') + '>' + STATUS_LIST[i] + '</option>';
  h += '</select></div></div>';
  h += '</div></div>';

  // Section 3: Billing
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">3</div><div class="bf-sec-title">Billing Lines</div></div>';
  h += '<div class="bf-body"><div id="bk-blines">';
  var blines = j.billing || [];
  for (var i = 0; i < blines.length; i++) h += bkBline(blines[i].item, blines[i].amt, i);
  h += '</div>';
  h += '<button class="btn btn-s btn-sm" style="margin-top:6px" onclick="addBkBline()">+ Add line</button>';
  h += '</div></div>';

  // Section 4: Vehicles
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">4</div><div class="bf-sec-title">Vehicles</div>';
  h += '<span style="font-size:11px;color:var(--t3)">Day rate &times; booking duration added to COS</span></div>';
  h += '<div class="bf-body"><div class="res-grid" id="bk-vehs">';
  var selVehs = j.vehicles || [];
  var bkDur = j.startDate && j.endDate ? Math.max(1,Math.round((s2d(j.endDate)-s2d(j.startDate))/864e5)+1) : 1;
  if (!VEHICLES.length) {
    h += '<div style="color:var(--t3);font-size:12px">No vehicles configured. Add them in <strong>Settings &rarr; Vehicles</strong>.</div>';
  } else {
    for (var vi = 0; vi < VEHICLES.length; vi++) {
      var veh = VEHICLES[vi];
      var isSel = selVehs.some(function(sv){ return sv.id === veh.id; });
      h += '<div class="res-item' + (isSel?' sel':'') + '" onclick="toggleVeh(this,\''+veh.id+'\',\'bk-vehs\')">';
      h += '<div class="ri-check">'+(isSel?'&#10003;':'')+'</div>';
      h += '<div class="ri-name"><strong>'+esc(veh.name)+'</strong> <span style="color:var(--t3);font-size:10.5px">'+esc(veh.reg)+'</span>';
      h += ' &mdash; '+esc(veh.type)+', '+veh.volCapFt+'ft&sup3;</div>';
      h += '<div class="ri-price">&pound;'+veh.dayRate+'/day<br><span style="font-size:10px;color:var(--blue)">&pound;'+(veh.dayRate*bkDur).toFixed(2)+' total</span></div>';
      h += '</div>';
    }
  }
  h += '</div></div></div>';

  // Section 5: Materials
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">5</div><div class="bf-sec-title">Packing Materials</div>';
  h += '<span style="font-size:11px;color:var(--t3)">Select items &amp; set quantities</span></div>';
  h += '<div class="bf-body"><div id="bk-mats">';
  var selMats = j.materials || [];
  if (!MATERIALS.length) {
    h += '<div style="color:var(--t3);font-size:12px">No materials configured. Add them in <strong>Settings &rarr; Materials</strong>.</div>';
  } else {
    for (var mi = 0; mi < MATERIALS.length; mi++) {
      var mat = MATERIALS[mi];
      var selMat = selMats.filter(function(sm){ return sm.id === mat.id; })[0];
      var isSel = !!selMat;
      var qty = isSel ? (selMat.qty||1) : 0;
      h += '<div class="res-item' + (isSel?' sel':'') + '" id="matrow-'+mat.id+'">';
      h += '<div class="ri-check">'+(isSel?'&#10003;':'')+'</div>';
      h += '<div class="ri-name" onclick="toggleMat(this,\''+mat.id+'\')" style="cursor:pointer">'+esc(mat.name)+'</div>';
      h += '<div style="display:flex;align-items:center;gap:5px">';
      h += '<input type="number" class="bf-input ri-qty" id="mq-'+mat.id+'" value="'+qty+'" min="0" step="1" placeholder="Qty"';
      h += ' oninput="updateMatRow(\''+mat.id+'\','+mat.unitCost+',this.value)">';
      h += '<div class="ri-price" id="mp-'+mat.id+'">&pound;'+mat.unitCost+'ea<br><span style="font-size:10px;color:var(--blue)" id="mpt-'+mat.id+'">'+(isSel?'&pound;'+(mat.unitCost*qty).toFixed(2):'')+'</span></div>';
      h += '</div></div>';
    }
  }
  h += '</div></div></div>';

  // Section 6: Charges & Taxes
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">6</div><div class="bf-sec-title">Charges &amp; Taxes</div>';
  h += '<span style="font-size:11px;color:var(--t3)">Applied to this booking only — amounts editable</span></div>';
  h += '<div class="bf-body">';
  var selChgs = j.charges || [];
  h += '<div id="bk-chgs-list">';
  if (selChgs.length) {
    for (var ci = 0; ci < selChgs.length; ci++) {
      h += chgRow(selChgs[ci].name, selChgs[ci].amt, ci);
    }
  }
  h += '</div>';
  h += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">';
  for (var ci = 0; ci < CHARGES.length; ci++) {
    h += '<button class="btn btn-s btn-sm" onclick="addChgToBooking(\''+esc(CHARGES[ci].name)+'\','+CHARGES[ci].defaultAmt+')">+ '+esc(CHARGES[ci].name)+'</button>';
  }
  h += '</div></div></div>';

  // Section 7: Notes
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">7</div><div class="bf-sec-title">Special Instructions / Notes</div></div>';
  h += '<div class="bf-body"><div class="bf-field"><textarea class="bf-input bf-textarea" id="bk-notes" placeholder="Parking restrictions, access notes, fragile items, crew instructions...">' + esc(j.notes || '') + '</textarea></div></div></div>';

  // Actions
  h += '<div style="display:flex;justify-content:flex-end;gap:8px;padding:4px 0 20px">';
  h += '<button class="btn btn-s" onclick="cancelBkForm()">Cancel</button>';
  h += '<button class="btn btn-p" onclick="saveBooking(\'' + ref + '\')">&#10003; Confirm Booking &mdash; ' + ref + '</button>';
  h += '</div>';
  h += '</div>';

  setH('bk-right-body', h);
}

// ── RESOURCE SELECTORS IN BOOKING FORM ────────────────────────────────
function toggleVeh(el_ref, vid, containerId) {
  el_ref.classList.toggle('sel');
  var isSel = el_ref.classList.contains('sel');
  var chk = el_ref.querySelector('.ri-check');
  if (chk) chk.innerHTML = isSel ? '&#10003;' : '';
}

function toggleMat(nameEl, mid) {
  var row = document.getElementById('matrow-' + mid);
  if (!row) return;
  row.classList.toggle('sel');
  var isSel = row.classList.contains('sel');
  var chk = row.querySelector('.ri-check');
  if (chk) chk.innerHTML = isSel ? '&#10003;' : '';
  var qtyEl = el('mq-' + mid);
  if (qtyEl && isSel && (!qtyEl.value || qtyEl.value === '0')) qtyEl.value = '1';
  var mat = MATERIALS.filter(function(m) { return m.id === mid; })[0];
  if (mat) updateMatRow(mid, mat.unitCost, qtyEl ? qtyEl.value : 0);
}

function updateMatRow(mid, unitCost, qty) {
  var row = document.getElementById('matrow-' + mid);
  if (!row) return;
  var q = parseInt(qty) || 0;
  var chk = row.querySelector('.ri-check');
  if (q > 0) {
    row.classList.add('sel');
    if (chk) chk.innerHTML = '&#10003;';
  } else {
    row.classList.remove('sel');
    if (chk) chk.innerHTML = '';
  }
  var tot = el('mpt-' + mid);
  if (tot) tot.innerHTML = q > 0 ? '&pound;' + (unitCost * q).toFixed(2) : '';
}

var chgRowCount = 0;
function chgRow(name, amt, idx) {
  return '<div style="display:flex;gap:6px;margin-bottom:5px;align-items:center">' +
    '<div style="flex:1;font-size:12.5px;font-weight:500">' + esc(name) + '</div>' +
    '<div style="display:flex;align-items:center;gap:3px"><span style="color:var(--t3)">£</span>' +
    '<input class="bf-input" style="width:90px;text-align:right" type="number" id="chga' + idx + '" value="' + amt + '" step="0.01" min="0"></div>' +
    '<button class="btn btn-g btn-sm" onclick="this.parentNode.remove()">&#10005;</button>' +
    '</div>';
}

function addChgToBooking(name, defaultAmt) {
  var list = el('bk-chgs-list');
  if (!list) return;
  chgRowCount++;
  list.insertAdjacentHTML('beforeend', chgRow(name, defaultAmt, chgRowCount));
}

function getSelectedVehicles() {
  var vehs = [];
  var rows = document.querySelectorAll('#bk-vehs .res-item.sel');
  rows.forEach(function(row) {
    var onclick = row.getAttribute('onclick') || '';
    var match = onclick.match(/toggleVeh\(this,'([^']+)'/);
    if (match) vehs.push({ id: match[1] });
  });
  return vehs;
}

function getSelectedMaterials() {
  var mats = [];
  for (var mi = 0; mi < MATERIALS.length; mi++) {
    var mat = MATERIALS[mi];
    var row = document.getElementById('matrow-' + mat.id);
    if (row && row.classList.contains('sel')) {
      var qtyEl = el('mq-' + mat.id);
      var qty = parseInt((qtyEl || {}).value) || 0;
      if (qty > 0) mats.push({ id: mat.id, qty: qty });
    }
  }
  return mats;
}

function getSelectedCharges() {
  var chgs = [];
  var list = el('bk-chgs-list');
  if (!list) return chgs;
  var rows = list.children;
  for (var i = 0; i < rows.length; i++) {
    var inputs = rows[i].querySelectorAll('input[type="number"]');
    var nameEl = rows[i].querySelector('div[style*="flex:1"]') || rows[i].querySelector('div');
    if (inputs.length && nameEl) {
      chgs.push({ name: nameEl.textContent.trim(), amt: parseFloat(inputs[0].value) || 0 });
    }
  }
  return chgs;
}

function bkBline(item, amt, i) {
  return '<div style="display:flex;gap:6px;margin-bottom:5px"><input class="bf-input" style="flex:2" placeholder="Item description" value="' + esc(item) + '" id="bkbi' + i + '"><input class="bf-input" style="flex:1;max-width:120px" type="number" placeholder="Amount" value="' + (amt || '') + '" id="bkba' + i + '" step="0.01" min="0"><button class="btn btn-g btn-sm" onclick="rmBkBline(' + i + ')">&#10005;</button></div>';
}

var bkBlineCount = 0;
function addBkBline() {
  var bl = el('bk-blines');
  bkBlineCount++;
  bl.insertAdjacentHTML('beforeend', bkBline('', '', bkBlineCount));
}
function rmBkBline(i) {
  var row = el('bkbi' + i);
  if (row) row.parentNode.remove();
}

function getBkBilling() {
  var lines = [];
  var i = 0;
  while (true) {
    var ii = el('bkbi' + i);
    if (!ii) { if (i > bkBlineCount + 20) break; i++; continue; }
    var item = ii.value.trim();
    var amt = parseFloat(el('bkba' + i).value) || 0;
    if (item) lines.push({ item: item, amt: amt });
    i++;
  }
  return lines;
}

function saveBooking(ref) {
  var client = el('bk-client').value.trim();
  var startDate = el('bk-start').value;
  var origin = el('bk-origin').value.trim();
  var dest = el('bk-dest').value.trim();
  if (!client) { toast('Client name is required'); return; }
  if (!startDate) { toast('Start date is required'); return; }
  if (!origin) { toast('Origin address is required'); return; }

  var bk = {
    id: bkMode === 'edit' ? curBkId : ('BK' + Date.now()),
    ref: ref,
    brand: el('bk-brand').value,
    clientName: client,
    clientEmail: el('bk-email').value.trim(),
    clientPhone: el('bk-phone').value.trim(),
    startDate: startDate,
    endDate: el('bk-end').value || startDate,
    origin: origin,
    dest: dest,
    volume: parseFloat(el('bk-vol').value) || 0,
    cbm: parseFloat(el('bk-cbm').value) || 0,
    status: el('bk-status').value,
    notes: el('bk-notes').value.trim(),
    billing: getBkBilling(),
    vehicles: getSelectedVehicles(),
    materials: getSelectedMaterials(),
    charges: getSelectedCharges(),
    emailLog: bkMode === 'edit' ? (bookings.filter(function(x){return x.id===curBkId;})[0]||{}).emailLog||[] : [],
    createdAt: bkMode === 'edit' ? (bookings.filter(function(x){return x.id===curBkId;})[0]||{}).createdAt||new Date().toISOString() : new Date().toISOString(),
  };

  // Also create/update a Job entry so it appears in the calendar
  var jb = {
    id: bk.id,
    ref: bk.ref,
    brand: bk.brand,
    client: bk.clientName,
    origin: bk.origin,
    dest: bk.dest,
    start: bk.startDate,
    end: bk.endDate,
    vol: bk.volume,
    cbm: bk.cbm,
    drivers: [],
    porters: [],
    fuel: 0,
    veh: [],
    status: bk.status,
    billing: bk.billing,
    notes: bk.notes,
  };

  if (bkMode === 'edit') {
    for (var i = 0; i < bookings.length; i++) if (bookings[i].id === curBkId) { bookings[i] = bk; break; }
    for (var i = 0; i < jobs.length; i++) if (jobs[i].id === curBkId) { jobs[i] = jb; break; }
    toast('Booking updated'); saveData('booking', bk.id, bk);
  } else {
    bookings.push(bk);
    jobs.push(jb);
    toast('Booking confirmed — ' + ref); saveData('booking', bk.id, bk);
  }

  curBkId = bk.id;
  bkMode = 'view';
  renderBkList();
  el('bk-right-title').innerHTML = '<span class="ref-badge">' + bk.ref + '</span> &nbsp;' + esc(bk.clientName);
  setH('bk-right-actions',
    '<button class="btn btn-s btn-sm" onclick="editBooking(\'' + bk.id + '\')">&#9998; Edit</button>' +
    '<button class="btn btn-p btn-sm" onclick="showEmailPreview(\'' + bk.id + '\')">&#9993; Send Confirmation</button>'
  );
  renderBookingDetail(bk);
  setBadge('job-badge',jobs.length);
}

function cancelBkForm() {
  if (curBkId) {
    viewBooking(curBkId);
  } else {
    curBkId = null;
    bkMode = 'none';
    el('bk-right-title').textContent = 'Select or create a booking';
    setH('bk-right-actions', '');
    setH('bk-right-body', '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--t3);text-align:center;padding:40px"><div style="font-weight:600;font-size:15px;color:var(--t2);margin-bottom:6px">No booking selected</div><div style="font-size:12.5px">Click + New Booking to start.</div></div>');
  }
}

// ── AI EMAIL PARSER ────────────────────────────────────────────────────
function parseEmail() {
  var text = el('email-paste').value.trim();
  if (!text) { toast('Paste an email first'); return; }
  var btn = el('parse-btn');
  btn.innerHTML = '<span class="ai-spin"></span> Parsing...';
  btn.disabled = true;

  var prompt = 'Extract the following fields from this booking/move email. Return ONLY valid JSON with these exact keys. Use null for missing fields.\n\n' +
    '{"clientName":string,"clientEmail":string,"clientPhone":string,"startDate":"YYYY-MM-DD or null","endDate":"YYYY-MM-DD or null","origin":string,"dest":string,"volume":number_or_null,"cbm":number_or_null,"notes":string,"billing":[{"item":string,"amt":number}]}\n\n' +
    'EMAIL:\n' + text;

  fetch('/api/claude', {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1000,
      messages: [{ role: 'user', content: prompt }]
    })
  })
  .then(function(r) {
    return r.text().then(function(txt){ return {ok:r.ok, status:r.status, txt:txt}; });
  })
  .then(function(res) {
    btn.innerHTML = '&#10003; Extract Details';
    btn.disabled = false;
    if(!res.ok){ toast('Parser error '+res.status+': '+res.txt.slice(0,120)); return; }
    var data; try{ data=JSON.parse(res.txt); }catch(e){ toast('Bad response: '+res.txt.slice(0,120)); return; }
    var raw = (data.content && data.content[0] && data.content[0].text) || '';
    raw = raw.replace(/```json|```/g, '').trim();
    var parsed;
    try { parsed = JSON.parse(raw); } catch(e) { toast('Could not parse response — check email text'); return; }
    // Fill form fields
    if (parsed.clientName) el('bk-client').value = parsed.clientName;
    if (parsed.clientEmail) el('bk-email').value = parsed.clientEmail;
    if (parsed.clientPhone) el('bk-phone').value = parsed.clientPhone;
    if (parsed.startDate) el('bk-start').value = parsed.startDate;
    if (parsed.endDate) el('bk-end').value = parsed.endDate;
    if (parsed.origin) el('bk-origin').value = parsed.origin;
    if (parsed.dest) el('bk-dest').value = parsed.dest;
    if (parsed.volume) el('bk-vol').value = parsed.volume;
    if (parsed.cbm) el('bk-cbm').value = parsed.cbm;
    if (parsed.notes) el('bk-notes').value = parsed.notes;
    if (parsed.billing && parsed.billing.length) {
      var bl = el('bk-blines');
      bl.innerHTML = '';
      bkBlineCount = parsed.billing.length - 1;
      for (var i = 0; i < parsed.billing.length; i++) {
        bl.insertAdjacentHTML('beforeend', bkBline(parsed.billing[i].item, parsed.billing[i].amt, i));
      }
    }
    el('email-paste').value = '';
    toast('Details extracted — review and confirm');
  })
  .catch(function(e) {
    btn.innerHTML = '&#10003; Extract Details';
    btn.disabled = false;
    toast('Error: ' + (e && e.message ? e.message : String(e)));
    console.error('parseEmail error:', e);
  });
}

// ── EMAIL PREVIEW + SEND ───────────────────────────────────────────────
function showEmailPreview(id) {
  var b = bookings.filter(function(x) { return x.id === id; })[0];
  if (!b) return;
  if (!b.clientEmail) { toast('No client email address on this booking'); return; }

  var body = buildEmailBody(b);
  var subject = 'Booking Confirmation — ' + b.ref;

  var h = '<div class="fade-in">';
  h += '<div style="margin-bottom:14px;display:flex;align-items:center;gap:10px">';
  h += '<button class="btn btn-s btn-sm" onclick="viewBooking(\'' + id + '\')">&#8592; Back</button>';
  h += '<span style="font-weight:700;font-size:14px">Email Preview</span>';
  h += '</div>';

  h += '<div class="email-preview">';
  h += '<div class="ep-bar">';
  h += '<div class="ep-dot" style="background:#FF5F56"></div>';
  h += '<div class="ep-dot" style="background:#FFBD2E"></div>';
  h += '<div class="ep-dot" style="background:#27C93F"></div>';
  h += '<span style="font-size:11px;color:var(--t3);margin-left:8px">Booking Confirmation Email</span>';
  h += '</div>';
  h += '<div class="ep-header">';
  h += '<div class="ep-field"><span class="ep-lbl">From:</span><span class="ep-val">' + esc(SL_CONFIG.fromName) + ' <' + esc(SL_CONFIG.fromEmail) + '></span></div>';
  h += '<div class="ep-field"><span class="ep-lbl">To:</span><span class="ep-val">' + esc(b.clientName) + ' <' + esc(b.clientEmail) + '></span></div>';
  h += '<div class="ep-field"><span class="ep-lbl">Subject:</span><span class="ep-val" style="font-weight:700">' + esc(subject) + '</span></div>';
  h += '</div>';
  h += '<div class="ep-body" style="white-space:pre-wrap;font-size:13px;line-height:1.8">' + esc(body) + '</div>';
  h += '</div>';

  // SocketLabs config check
  if (!SL_CONFIG.serverId || !SL_CONFIG.apiKey) {
    h += '<div style="margin-top:12px;background:#FFF5E0;border:1px solid #FFD580;border-radius:var(--r);padding:11px 14px;font-size:12.5px">';
    h += '<strong>SocketLabs not configured.</strong> Add your Server ID and API Key below to enable sending.';
    h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px">';
    h += '<div class="bf-field"><label class="bf-label">Server ID</label><input class="bf-input" id="sl-sid" placeholder="e.g. 10000" value="' + esc(SL_CONFIG.serverId) + '"></div>';
    h += '<div class="bf-field"><label class="bf-label">Injection API Key</label><input class="bf-input" id="sl-key" placeholder="Paste key" value="' + esc(SL_CONFIG.apiKey) + '"></div>';
    h += '<div class="bf-field"><label class="bf-label">From Email</label><input class="bf-input" id="sl-from" value="' + esc(SL_CONFIG.fromEmail) + '"></div>';
    h += '<div class="bf-field"><label class="bf-label">From Name</label><input class="bf-input" id="sl-fname" value="' + esc(SL_CONFIG.fromName) + '"></div>';
    h += '</div>';
    h += '<button class="btn btn-s btn-sm" style="margin-top:8px" onclick="saveSLConfig()">Save Config</button>';
    h += '</div>';
  }

  h += '<div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">';
  h += '<button class="btn btn-s" onclick="viewBooking(\'' + id + '\')">Cancel</button>';
  h += '<button class="btn btn-p" id="send-btn" onclick="sendEmail(\'' + id + '\',\'' + esc(subject).replace(/'/g,"\\'") + '\')">&#9993; Send Email</button>';
  h += '</div>';
  h += '</div>';

  setH('bk-right-body', h);
  el('bk-right-title').textContent = 'Send Confirmation';
  setH('bk-right-actions', '');
}

function buildEmailBody(b) {
  var vol = b.volume ? b.volume + ' ft\u00B3' : (b.cbm ? b.cbm + ' CBM' : 'TBC');
  var billing = '';
  if (b.billing && b.billing.length) {
    var tot = 0;
    for (var k = 0; k < b.billing.length; k++) {
      billing += '\n  ' + b.billing[k].item + ': ' + (b.billing[k].amt > 0 ? '\u00A3' + b.billing[k].amt.toFixed(2) : 'TBC');
      tot += b.billing[k].amt;
    }
    if (tot > 0) billing += '\n  Total: \u00A3' + tot.toFixed(2);
  }

  return 'Dear ' + b.clientName + ',\n\n' +
    'Thank you for choosing ' + SL_CONFIG.companyName + '. We are pleased to confirm your booking.\n\n' +
    '━━━ BOOKING CONFIRMATION ━━━\n\n' +
    'Booking Reference: ' + b.ref + '\n' +
    'Move Date:         ' + fmtNice(b.startDate) + (b.endDate && b.endDate !== b.startDate ? ' \u2013 ' + fmtNice(b.endDate) : '') + '\n' +
    'Origin:            ' + b.origin + '\n' +
    'Destination:       ' + b.dest + '\n' +
    'Volume:            ' + vol + '\n' +
    (billing ? '\nBilling Summary:' + billing + '\n' : '') +
    (b.notes ? '\nSpecial Instructions:\n' + b.notes + '\n' : '') +
    '\n━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n' +
    'If you have any questions or need to make changes, please contact us:\n' +
    SL_CONFIG.companyName + '\n' +
    'Phone: ' + SL_CONFIG.companyPhone + '\n' +
    'Email: ' + SL_CONFIG.companyEmail + '\n\n' +
    'Kind regards,\n' +
    SL_CONFIG.fromName;
}

function saveSLConfig() {
  SL_CONFIG.serverId = (el('sl-sid') || {}).value || SL_CONFIG.serverId;
  SL_CONFIG.apiKey = (el('sl-key') || {}).value || SL_CONFIG.apiKey;
  SL_CONFIG.fromEmail = (el('sl-from') || {}).value || SL_CONFIG.fromEmail;
  SL_CONFIG.fromName = (el('sl-fname') || {}).value || SL_CONFIG.fromName;
  toast('SocketLabs config saved'); saveData('settings');
}

function sendEmail(id, subject) {
  var b = bookings.filter(function(x) { return x.id === id; })[0];
  if (!b) return;
  if (!SL_CONFIG.serverId || !SL_CONFIG.apiKey) { toast('Configure SocketLabs first'); return; }

  var btn = el('send-btn');
  btn.innerHTML = '<span class="ai-spin"></span> Sending...';
  btn.disabled = true;

  var body = buildEmailBody(b);

  fetch('https://inject.socketlabs.com/api/v1/email', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      ServerId: parseInt(SL_CONFIG.serverId),
      APIKey: SL_CONFIG.apiKey,
      Messages: [{
        To: [{ emailAddress: b.clientEmail, friendlyName: b.clientName }],
        From: { emailAddress: SL_CONFIG.fromEmail, friendlyName: SL_CONFIG.fromName },
        Subject: subject,
        TextBody: body,
        MessageType: 'Bulk'
      }]
    })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.ErrorCode === '0' || data.ErrorCode === 0) {
      // Log it
      var now = new Date();
      var ts = now.toLocaleDateString('en-GB') + ' ' + now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
      b.emailLog = b.emailLog || [];
      b.emailLog.push({ subject: subject, sentAt: ts, to: b.clientEmail });
      b.status = 'Email Sent';
      // Update in bookings
      for (var i = 0; i < bookings.length; i++) if (bookings[i].id === id) { bookings[i] = b; break; }
      renderBkList();
      toast('Email sent to ' + b.clientEmail);
      viewBooking(id);
    } else {
      toast('Send failed: ' + (data.ErrorCode || 'Unknown error'));
      btn.innerHTML = '&#9993; Send Email';
      btn.disabled = false;
    }
  })
  .catch(function(e) {
    toast('Network error — check SocketLabs config');
    btn.innerHTML = '&#9993; Send Email';
    btn.disabled = false;
  });
}

// ── JOB CONFIGURATOR ─────────────────────────────────────────────────
// State object for the active configurator session
var CFG = null;
var cfgStage = 0;
var cfgMatrixOffset = 0; // weeks offset for availability calendar
var CFG_STAGES = 4;

// ═══════════════════════════════════════════════════════════════════════════
// BOOKING CONFIGURATOR v2 — 5-STAGE FLOW
// Stage 0: Client & Jobs  (who, what type, how many linked jobs)
// Stage 1: Movements      (each job gets movement cards with mode/date/addresses)
// Stage 2: Resources      (vehicles booked out, crew headcount)
// Stage 3: Billing        (revenue lines, extras, services, materials, charges)
// Stage 4: Confirm        (full summary, save as Provisional or Confirmed)
// ═══════════════════════════════════════════════════════════════════════════

// ── CONSTANTS ──────────────────────────────────────────────────────────────

var JOB_TYPES_V2 = [
  { code:'D2D', label:'Door to Door',  icon:'🏠', sub:'UK internal A→B move',        color:'#F5EEFF', accent:'#9B59B6' },
  { code:'SEA', label:'Sea Freight',   icon:'🚢', sub:'Origin pack or destination',   color:'#EBF4FF', accent:'#0073EA' },
  { code:'AIR', label:'Air Freight',   icon:'✈️', sub:'Origin pack or destination',   color:'#E6FFF5', accent:'#00C875' },
  { code:'DOM', label:'Domestic',      icon:'🏡', sub:'Residential UK move',          color:'#FFF5E0', accent:'#FF9F1A' },
  { code:'COM', label:'Commercial',    icon:'🏢', sub:'Business to business',         color:'#F0F0F0', accent:'#555'    },
  { code:'HAN', label:'Handling',      icon:'🤲', sub:'Load/unload, no packing',      color:'#FFF0F0', accent:'#E53E3E' },
  { code:'WHS', label:'Warehouse',     icon:'🏭', sub:'Storage in or out',            color:'#FFFAEB', accent:'#D69E2E' },
];

var MOVEMENT_MODES = [
  { key:'collection',     label:'Collection',          icon:'📦', sub:'Collect from client address' },
  { key:'delivery',       label:'Delivery',            icon:'🏠', sub:'Deliver to client address' },
  { key:'container-site', label:'Container on Site',   icon:'📫', sub:'Pack into container at property' },
  { key:'warehouse-in',   label:'Into Warehouse',      icon:'⬇️', sub:'Goods into our storage' },
  { key:'warehouse-out',  label:'From Warehouse',      icon:'⬆️', sub:'Goods out of our storage' },
  { key:'3rd-party',      label:'3rd Party Handoff',   icon:'🤝', sub:'Hand off / collect from partner' },
  { key:'transfer',       label:'Internal Transfer',   icon:'🔄', sub:'Warehouse to warehouse' },
  { key:'disposal',       label:'Disposal Run',        icon:'🗑️', sub:'Collect and dispose of goods' },
];

var BILLING_TEMPLATES = {
  'D2D': [{ desc:'Door to Door Service', unit:'job', qty:1, rate:0 }],
  'SEA': [{ desc:'Origin Pack — Sea', unit:'ft³', qty:0, rate:0 }, { desc:'Port/Container Charge', unit:'job', qty:1, rate:0 }],
  'AIR': [{ desc:'Origin Pack — Air', unit:'ft³', qty:0, rate:0 }, { desc:'Airport Charge', unit:'job', qty:1, rate:0 }],
  'DOM': [{ desc:'Domestic Move', unit:'job', qty:1, rate:0 }],
  'COM': [{ desc:'Commercial Service', unit:'job', qty:1, rate:0 }],
  'HAN': [{ desc:'Handling Charge', unit:'hrs', qty:0, rate:0 }],
  'WHS': [{ desc:'Storage Handling', unit:'ft³', qty:0, rate:0 }],
};

// ── DATA MODELS ────────────────────────────────────────────────────────────

function cfgEmpty() {
  return {
    id: null,
    clientNum: null,
    jobDefs: [ cfgEmptyJobDef() ],
    // Client details
    clientName: '', clientEmail: '', clientPhone: '',
    partnerRef: '', brand: BRANDS[0] || '', channel: 'Partner',
    moveManager: '', workCountry: 'UK',
    // Status
    status: 'Provisional',
    // Schedule
    startDate: '', endDate: '',
    selectedDates: [],
    isMultiDay: false, numDays: 1,
    hasOvernight: false, numNights: 0, overnightAllowance: 65,
    weekendWorking: false,
    linkJourney: false, journeyId: null, journeyRef: '',
    // Resources (shared across all jobDefs in booking)
    crewAssigned: [],
    vehAssigned: [],
    // Notes
    opsNotes: '', clientNotes: '',
    // AI parse
    sourceEmail: '', aiParsed: null,
    // SharePoint
    spFolderUrl: '', spFolderId: '', spFolderPath: '', spSiteId: '', spDriveId: '',
    docChecklist: {},
    changeLog: [],
    createdAt: new Date().toISOString(),
  };
}

function cfgEmptyJobDef() {
  return {
    jid: 'J' + Date.now() + Math.random().toString(36).slice(2,5),
    jobTypeCode: '',         // D2D | SEA | AIR | DOM | COM | HAN | WHS
    // Movements — one or more per job
    movements: [ cfgEmptyMovement() ],
    // Billing lines for this job
    billing: [],
    // Resources
    crewDrivers: 1,
    crewPorters: 2,
    vehicleIds: [],          // specific vehicle IDs booked out
    // Link info
    linkedToClientNum: null, // if this job links to existing client record
    // Storage record links
    storageRecordId: '',
    storageDirection: null,  // 'in' | 'out'
    storageIsNew: false,
    newStorageBillingRate: 85,
    newStorageBillingUnit: 'cbm',
    // Generated ref
    masterRef: '',           // e.g. UK-SEA-00004567
  };
}

function cfgEmptyMovement() {
  return {
    mid: 'M' + Date.now() + Math.random().toString(36).slice(2,5),
    mode: '',                // from MOVEMENT_MODES
    date: '',
    origin: '',
    destination: '',
    volFt: '',
    volCbm: '',
    volUnit: 'ft',
    // Access flags
    smallVehicle: false, tightAccess: false, shuttle: false,
    parkingSuspension: false, permit: false,
    // Services on this movement
    svcs: { casing:false, crating:false, handyman:false, piano:false,
            packingMaterials:false, debris:false },
    notes: '',
    storageRecordId: '',
  };
}

// ── CLIENT NUMBER GENERATION ────────────────────────────────────────────────

var CLIENT_NUM_SEQ = parseInt((APP_SETTINGS && APP_SETTINGS.clientNumSeq) || '4566', 10);

function nextClientNum() {
  CLIENT_NUM_SEQ++;
  if (APP_SETTINGS) APP_SETTINGS.clientNumSeq = CLIENT_NUM_SEQ;
  saveData('settings');
  return CLIENT_NUM_SEQ;
}

function padClientNum(n) {
  var s = String(n);
  while (s.length < 8) s = '0' + s;
  return s;
}

// Build master ref: UK-SEA-00004567
function buildMasterRef(workCountry, jobTypeCode, clientNum) {
  var cc = workCountry || 'UK';
  var jt = jobTypeCode || 'D2D';
  var num = padClientNum(clientNum || CLIENT_NUM_SEQ);
  return cc + '-' + jt + '-' + num;
}

// Build sub-ref for linked job: UK-WHS-00004567
// or iteration: UK-SEA-00004567-02
function buildSubRef(baseRef, jobTypeCode, iterNum) {
  var parts = baseRef.split('-');
  var cc = parts[0] || 'UK';
  var num = parts[parts.length - 1];
  var ref = cc + '-' + jobTypeCode + '-' + num;
  if (iterNum && iterNum > 1) ref += '-' + String(iterNum).padStart(2, '0');
  return ref;
}

// ── CORE FLOW ───────────────────────────────────────────────────────────────

var CFG = null;
var cfgStage = 0;
var CFG_STAGES = 5;

function openConfigurator(existingCjId) {
  if (existingCjId) {
    var cj = CLIENT_JOBS.filter(function(x){ return x.id === existingCjId; })[0];
    if (!cj) return;
    CFG = cj.cfgData ? JSON.parse(JSON.stringify(cj.cfgData)) : cfgEmpty();
    CFG._editingCjId = existingCjId;
  } else {
    CFG = cfgEmpty();
    CFG._editingCjId = null;
  }
  cfgStage = 0;
  // Update panel header
  el('cfg-head-ref').textContent = '';
  el('cfg-head-title').textContent = existingCjId ? 'Edit Booking' : 'New Booking';
  // Remove Save Draft button
  var sd = document.getElementById('cfg-save-draft-btn');
  if (sd) sd.style.display = 'none';
  el('cfg-backdrop').classList.add('on');
  el('cfg-panel').classList.add('on');
  cfgRenderStage();
  cfgUpdateNav();
}

function closeConfigurator() {
  el('cfg-backdrop').classList.remove('on');
  el('cfg-panel').classList.remove('on');
  CFG = null;
}

function cfgClickBackdrop(e) {
  if (e.target === el('cfg-backdrop')) closeConfigurator();
}

function cfgRenderStage() {
  var h = '';
  if (cfgStage === 0) h = cfgRenderClientJobs();
  if (cfgStage === 1) h = cfgRenderMovements();
  if (cfgStage === 2) h = cfgRenderResources();
  if (cfgStage === 3) h = cfgRenderBilling();
  if (cfgStage === 4) h = cfgRenderConfirm();
  setH('cfg-body', h);
  cfgPostRender();
  cfgUpdateStageIndicator();
}

function cfgPostRender() {
  // Build availability matrix on movements stage
  if (cfgStage === 1) {
    setTimeout(cfgBuildMatrix, 50);
  }
  // Bind address autocomplete to all unbound address fields
  setTimeout(function() {
    document.querySelectorAll('.cfg-addr:not([data-bound])').forEach(function(inp) {
      bindAddressField(inp);
    });
    // Also bind jcfg-origin/dest fields if on brief stage
    if (cfgStage === 1) {
      for (var ji = 0; ji < CFG.jobDefs.length; ji++) {
        for (var mi = 0; mi < CFG.jobDefs[ji].movements.length; mi++) {
          var origEl = document.getElementById('mv-origin-' + ji + '-' + mi);
          var destEl = document.getElementById('mv-dest-' + ji + '-' + mi);
          if (origEl && !origEl._addrBound) bindAddressField(origEl);
          if (destEl && !destEl._addrBound) {
            bindAddressField(destEl, {
              showDist: true,
              fromFn: function() {
                var o = document.getElementById('mv-origin-' + ji + '-' + mi);
                return o ? o.value.trim() : (APP_SETTINGS.warehouseAddress || '');
              }
            });
          }
        }
      }
    }
  }, 100);
}

function cfgUpdateStageIndicator() {
  var labels = ['Client & Jobs', 'Movements', 'Resources', 'Billing', 'Confirm'];
  for (var i = 0; i < CFG_STAGES; i++) {
    var el2 = document.getElementById('cstage-' + i);
    if (!el2) continue;
    el2.className = 'cfg-stage' + (i === cfgStage ? ' active' : (i < cfgStage ? ' done' : ''));
    var lbl = el2.querySelector('.cfg-stage-lbl');
    if (lbl) lbl.textContent = labels[i];
  }
}

function cfgUpdateNav() {
  var back = el('cfg-btn-back');
  var next = el('cfg-btn-next');
  if (back) back.style.display = cfgStage > 0 ? '' : 'none';
  if (next) {
    next.textContent = cfgStage === CFG_STAGES - 1 ? '✓ Save Booking' : 'Next →';
  }
  // Hide Save Draft button
  var sd = document.getElementById('cfg-save-draft-btn');
  if (sd) sd.style.display = 'none';
}

function cfgCollectStage() {
  if (cfgStage === 0) cfgCollectClientJobs();
  if (cfgStage === 1) cfgCollectMovements();
  if (cfgStage === 2) cfgCollectResources();
  if (cfgStage === 3) cfgCollectBilling();
  if (cfgStage === 4) cfgCollectConfirm();
}

function cfgGoStage(n) {
  cfgCollectStage();
  cfgStage = n;
  cfgRenderStage();
  cfgUpdateNav();
  var body = el('cfg-body');
  if (body) body.scrollTop = 0;
}

function cfgNext() {
  cfgCollectStage();
  // Validate current stage
  if (cfgStage === 0) {
    if (!CFG.clientName.trim()) { toast('Client name is required'); return; }
    if (!CFG.jobDefs[0].jobTypeCode) { toast('Select at least one job type'); return; }
  }
  if (cfgStage === 1) {
    var hasDate = CFG.jobDefs.some(function(jd) {
      return jd.movements.some(function(m){ return !!m.date; });
    });
    if (!hasDate) { toast('Add at least one movement with a date'); return; }
  }
  if (cfgStage < CFG_STAGES - 1) {
    cfgGoStage(cfgStage + 1);
  } else {
    cfgCommit();
  }
}

function cfgBack() {
  cfgCollectStage();
  if (cfgStage > 0) cfgGoStage(cfgStage - 1);
}

// ── STAGE 0: CLIENT & JOBS ─────────────────────────────────────────────────

function cfgRenderClientJobs() {
  var h = '';

  // AI Parser
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">🤖</div>';
  h += '<div><div class="cs-card-title">AI Email Parser</div>';
  h += '<div class="cs-card-sub">Paste any email or booking instruction — Claude extracts all details</div></div></div>';
  h += '<div class="cs-body">';
  h += '<textarea class="cfg-input" id="cfg-email-paste" rows="3" placeholder="Paste booking email or instruction here..." style="resize:vertical">' + esc(CFG.sourceEmail || '') + '</textarea>';
  h += '<div style="display:flex;gap:7px;margin-top:8px">';
  h += '<button class="btn btn-p btn-sm" onclick="cfgParseEmail()">✓ Extract Details</button>';
  h += '<button class="btn btn-s btn-sm" onclick="el(\'cfg-email-paste\').value=\'\'">Clear</button>';
  h += '</div></div></div>';

  // Client details
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#E6FFF5">👤</div>';
  h += '<div class="cs-card-title">Client Details</div></div>';
  h += '<div class="cs-body">';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  h += cfgField('Client Name *', 'cfg-client', CFG.clientName, 'text', 'Full name');
  h += cfgField('Client Email', 'cfg-cemail', CFG.clientEmail, 'email', 'email@example.com');
  h += cfgField('Client Phone', 'cfg-cphone', CFG.clientPhone, 'tel', '07700 000000');
  h += cfgField('Partner Reference', 'cfg-partnerref', CFG.partnerRef, 'text', 'e.g. GBH-78432');
  h += '</div></div></div>';

  // Admin
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#F5EEFF">🏢</div>';
  h += '<div class="cs-card-title">Brand &amp; Admin</div></div>';
  h += '<div class="cs-body">';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  h += '<div class="cfg-field"><label class="cfg-label">Brand</label><select class="cfg-input cfg-select" id="cfg-brand">';
  for (var bi = 0; bi < BRANDS.length; bi++) h += '<option' + (CFG.brand === BRANDS[bi] ? ' selected' : '') + '>' + esc(BRANDS[bi]) + '</option>';
  h += '</select></div>';
  h += '<div class="cfg-field"><label class="cfg-label">Channel</label><select class="cfg-input cfg-select" id="cfg-channel">';
  ['Partner','Account','Domestic','Commercial'].forEach(function(c){ h += '<option' + (CFG.channel === c ? ' selected' : '') + '>' + c + '</option>'; });
  h += '</select></div>';
  h += '<div class="cfg-field"><label class="cfg-label">Move Manager</label><select class="cfg-input cfg-select" id="cfg-mm">';
  h += '<option value="">— None —</option>';
  MOVE_MANAGERS.forEach(function(m){ h += '<option value="' + esc(m.name) + '"' + (CFG.moveManager === m.name ? ' selected' : '') + '>' + esc(m.name) + ' (' + esc(m.brand) + ')</option>'; });
  h += '</select></div>';
  h += '<div class="cfg-field"><label class="cfg-label">Work Country</label>';
  h += '<input class="cfg-input" id="cfg-workcountry" value="' + esc(CFG.workCountry || 'UK') + '" placeholder="UK" style="text-transform:uppercase" oninput="cfgUpdateRefPreview()">';
  h += '</div>';
  h += '</div></div></div>';

  // Job Types — multi-select tiles
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">📋</div>';
  h += '<div><div class="cs-card-title">Job Types</div>';
  h += '<div class="cs-card-sub">Select all that apply — each gets its own reference and movements. Linked by the same client number.</div></div></div>';
  h += '<div class="cs-body">';
  h += '<div class="route-grid" style="grid-template-columns:repeat(auto-fill,minmax(140px,1fr))">';
  for (var ti = 0; ti < JOB_TYPES_V2.length; ti++) {
    var jt = JOB_TYPES_V2[ti];
    var sel = CFG.jobDefs.some(function(jd){ return jd.jobTypeCode === jt.code; });
    h += '<div class="route-tile' + (sel ? ' sel' : '') + '" onclick="cfgToggleJobType(\'' + jt.code + '\',this)" style="--rt-accent:' + jt.accent + ';--rt-bg:' + jt.color + '">';
    h += '<div class="route-tile-icon">' + jt.icon + '</div>';
    h += '<div class="route-tile-label">' + jt.label + '</div>';
    h += '<div class="route-tile-sub">' + jt.sub + '</div>';
    if (sel) h += '<div class="route-tile-check">✓</div>';
    h += '</div>';
  }
  h += '</div>';

  // Status
  h += '<div style="margin-top:14px;display:flex;gap:10px;align-items:center">';
  h += '<span style="font-size:12px;font-weight:600;color:var(--t2)">Status:</span>';
  ['Provisional','Confirmed'].forEach(function(s){
    var active = CFG.status === s;
    var col = s === 'Confirmed' ? 'var(--green)' : 'var(--amber)';
    h += '<button onclick="cfgSetStatus(\'' + s + '\',this)" style="padding:5px 14px;border-radius:20px;border:2px solid ' + (active ? col : 'var(--b1)') + ';background:' + (active ? col + '22' : 'transparent') + ';color:' + (active ? col : 'var(--t2)') + ';font-weight:700;font-size:12px;cursor:pointer">' + s + '</button>';
  });
  h += '</div>';

  // Ref preview
  var firstCode = (CFG.jobDefs[0] && CFG.jobDefs[0].jobTypeCode) || '???';
  var previewNum = CFG.clientNum ? padClientNum(CFG.clientNum) : padClientNum(CLIENT_NUM_SEQ + 1);
  var previewCC = CFG.workCountry || 'UK';
  h += '<div style="margin-top:12px;padding:8px 12px;background:var(--blt);border-radius:6px;font-family:monospace;font-size:12px;font-weight:700;color:var(--blue)" id="cfg-ref-preview">';
  h += esc(previewCC) + '-' + esc(firstCode) + '-' + previewNum;
  if (CFG.jobDefs.length > 1) {
    for (var di = 1; di < CFG.jobDefs.length; di++) {
      h += ' + ' + esc(previewCC) + '-' + esc(CFG.jobDefs[di].jobTypeCode || '???') + '-' + previewNum;
    }
  }
  h += '</div>';
  h += '</div></div>';

  return h;
}

function cfgCollectClientJobs() {
  CFG.clientName  = (el('cfg-client')     || {}).value || CFG.clientName;
  CFG.clientEmail = (el('cfg-cemail')     || {}).value || CFG.clientEmail;
  CFG.clientPhone = (el('cfg-cphone')     || {}).value || CFG.clientPhone;
  CFG.partnerRef  = (el('cfg-partnerref') || {}).value || CFG.partnerRef;
  CFG.brand       = (el('cfg-brand')      || {}).value || CFG.brand;
  CFG.channel     = (el('cfg-channel')    || {}).value || CFG.channel;
  CFG.moveManager = (el('cfg-mm')         || {}).value || CFG.moveManager;
  CFG.workCountry = ((el('cfg-workcountry') || {}).value || CFG.workCountry || 'UK').toUpperCase();
  CFG.sourceEmail = (el('cfg-email-paste')|| {}).value || CFG.sourceEmail;
}

function cfgToggleJobType(code, tile) {
  var existing = CFG.jobDefs.filter(function(jd){ return jd.jobTypeCode === code; });
  if (existing.length > 0) {
    // Remove it (but keep at least one)
    if (CFG.jobDefs.length > 1) {
      CFG.jobDefs = CFG.jobDefs.filter(function(jd){ return jd.jobTypeCode !== code; });
    }
  } else {
    var jd = cfgEmptyJobDef();
    jd.jobTypeCode = code;
    // Auto-populate billing template
    jd.billing = (BILLING_TEMPLATES[code] || []).map(function(t){ return Object.assign({}, t, {id:'bl'+Date.now()+Math.random().toString(36).slice(2,4), amt:0}); });
    CFG.jobDefs.push(jd);
    // Ensure first jobDef has a type if it was empty
    if (CFG.jobDefs[0].jobTypeCode === '' && CFG.jobDefs.length > 1) {
      CFG.jobDefs.shift();
    }
  }
  cfgCollectClientJobs();
  cfgRenderStage();
}

function cfgSetStatus(s, btn) {
  CFG.status = s;
  cfgRenderStage();
}

function cfgUpdateRefPreview() {
  var cc = (el('cfg-workcountry') || {}).value || 'UK';
  var firstCode = (CFG.jobDefs[0] && CFG.jobDefs[0].jobTypeCode) || '???';
  var previewNum = CFG.clientNum ? padClientNum(CFG.clientNum) : padClientNum(CLIENT_NUM_SEQ + 1);
  var prev = el('cfg-ref-preview');
  if (prev) prev.textContent = cc.toUpperCase() + '-' + firstCode + '-' + previewNum;
}

// ── STAGE 1: MOVEMENTS ─────────────────────────────────────────────────────


// ── RESTORED SCHEDULE/RESOURCE HELPERS ─────────────────────────────────

function cfgToggleDateOption(val) {
  var sec = el('cfg-date-section');
  if (sec) sec.style.display = val === 'fix' ? '' : 'none';
}

function cfgToggleMultiday(inp) {
  cfgCollectSchedule();
  CFG.isMultiDay = inp.checked;
  // Reset selected dates when toggling
  CFG.selectedDates = [];
  CFG.startDate = '';
  CFG.endDate = '';
  cfgRenderStage();
}

function cfgNumDaysChange(inp) {
  var n = parseInt(inp.value) || 2;
  CFG.numDays = n;
  // Trim selectedDates if fewer days entered
  if (CFG.selectedDates && CFG.selectedDates.length > n) CFG.selectedDates = CFG.selectedDates.slice(0, n);
  cfgRenderStage();
}

function cfgToggleOvernight(inp) {
  CFG.hasOvernight = inp.checked;
  cfgRenderStage();
}

function cfgToggleLinkJourney(inp) {
  CFG.linkJourney = inp.checked;
  cfgRenderStage();
}

function cfgManualDateChange() {
  var inp = el('cfg-startdate');
  if (!inp || !inp.value) return;
  var ds = inp.value;
  if (!CFG.selectedDates) CFG.selectedDates = [];
  CFG.selectedDates[0] = ds;
  CFG.startDate = ds;
  // Re-highlight matrix without full re-render
  cfgHighlightMatrix();
  // Show date section
  var fixRadio = document.querySelector('input[name="cfg-dateoption"][value="fix"]');
  if (fixRadio) fixRadio.checked = true;
  var sec = el('cfg-date-section');
  if (sec) sec.style.display = '';
}

function cfgClearSlot(slotIdx) {
  if (!CFG.selectedDates) CFG.selectedDates = [];
  CFG.selectedDates[slotIdx] = '';
  // Compact: remove empty trailing slots
  while (CFG.selectedDates.length > 0 && !CFG.selectedDates[CFG.selectedDates.length - 1]) {
    CFG.selectedDates.pop();
  }
  CFG.startDate = CFG.selectedDates[0] || '';
  CFG.endDate   = CFG.selectedDates[CFG.selectedDates.length - 1] || '';
  cfgRenderStage();
}


function cfgHighlightMatrix() {
  // Update row highlighting without full re-render
  var rows = document.querySelectorAll('#cfg-avail-body .avail-row');
  var selectedSet = {};
  (CFG.selectedDates || []).forEach(function(d, i){ if (d) selectedSet[d] = i + 1; });

  rows.forEach(function(row) {
    var m = (row.getAttribute('onclick') || '').match(/'(\d{4}-\d{2}-\d{2})'/);
    if (!m) return;
    var ds = m[1];
    row.classList.remove('chosen', 'chosen-multi');
    if (!CFG.isMultiDay && CFG.startDate === ds) row.classList.add('chosen');
    if (CFG.isMultiDay && selectedSet[ds]) row.classList.add('chosen-multi');
  });
}

function cfgSelectDate(ds) {
  // Show the date section and activate "fix" radio
  var fixRadio = document.querySelector('input[name="cfg-dateoption"][value="fix"]');
  if (fixRadio) fixRadio.checked = true;
  var sec = el('cfg-date-section');
  if (sec) sec.style.display = '';

  if (!CFG.isMultiDay) {
    // Single-day: just set startDate
    CFG.startDate = ds;
    if (!CFG.selectedDates) CFG.selectedDates = [];
    CFG.selectedDates[0] = ds;
    var inp = el('cfg-startdate');
    if (inp) inp.value = ds;
    cfgHighlightMatrix();
    // Update the slot row without full re-render
    toast('Date set: ' + fmtNice(ds));
    return;
  }

  // Multi-day: fill next empty slot
  if (!CFG.selectedDates) CFG.selectedDates = [];
  var n = CFG.numDays || 2;

  // If already selected, deselect
  var existIdx = CFG.selectedDates.indexOf(ds);
  if (existIdx >= 0) {
    CFG.selectedDates[existIdx] = '';
    // Compact
    while (CFG.selectedDates.length > 0 && !CFG.selectedDates[CFG.selectedDates.length - 1]) CFG.selectedDates.pop();
    CFG.startDate = CFG.selectedDates[0] || '';
    CFG.endDate   = CFG.selectedDates[CFG.selectedDates.length - 1] || '';
    cfgRenderStage();
    return;
  }

  // Count filled
  var filled = CFG.selectedDates.filter(function(d){return !!d;}).length;
  if (filled >= n) {
    toast('All ' + n + ' days already selected. Clear one first.');
    return;
  }

  // Fill next empty slot
  // Ensure array is long enough
  while (CFG.selectedDates.length < n) CFG.selectedDates.push('');
  for (var si = 0; si < n; si++) {
    if (!CFG.selectedDates[si]) {
      CFG.selectedDates[si] = ds;
      break;
    }
  }

  CFG.startDate = CFG.selectedDates[0] || '';
  var lastFilled = '';
  for (var si2 = CFG.selectedDates.length - 1; si2 >= 0; si2--) { if (CFG.selectedDates[si2]) { lastFilled = CFG.selectedDates[si2]; break; } }
  CFG.endDate = lastFilled;

  var newFilled = CFG.selectedDates.filter(function(d){return !!d;}).length;
  if (newFilled >= n) {
    toast('All ' + n + ' days selected!');
  } else {
    toast('Day ' + newFilled + ' of ' + n + ' selected: ' + fmtNice(ds));
  }

  // Re-render slots area and progress without full re-render
  cfgRenderStage();
}

function cfgCrewAvailStatus(name, ds) {
  if (!ds) return {cls:'rps-free', lbl:'No date'};
  if (HOL[name] && HOL[name].indexOf(ds) >= 0) return {cls:'rps-busy', lbl:'Holiday'};
  for (var ji = 0; ji < jobs.length; ji++) {
    var jb = jobs[ji];
    if (ds < jb.start || ds > jb.end) continue;
    if ((jb.drivers||[]).indexOf(name) >= 0 || (jb.porters||[]).indexOf(name) >= 0) return {cls:'rps-busy', lbl:'Booked'};
  }
  return {cls:'rps-free', lbl:'Free'};
}

function cfgVehAvailStatus(vid, ds) {
  if (!ds) return {cls:'rps-free', lbl:'No date'};
  var veh = VEHICLES.filter(function(v){return v.id===vid;})[0];
  if (!veh) return {cls:'rps-free', lbl:'?'};
  for (var ji = 0; ji < jobs.length; ji++) {
    var jb = jobs[ji];
    if (ds < jb.start || ds > jb.end) continue;
    if ((jb.veh||[]).indexOf(veh.reg) >= 0) return {cls:'rps-busy', lbl:'Booked'};
  }
  return {cls:'rps-free', lbl:'Free'};
}

function cfgToggleCrew(elRef, name) {
  var idx = CFG.crewAssigned.indexOf(name);
  if (idx >= 0) CFG.crewAssigned.splice(idx, 1);
  else CFG.crewAssigned.push(name);
  elRef.classList.toggle('sel', CFG.crewAssigned.indexOf(name) >= 0);
}

function cfgToggleVeh(elRef, vid) {
  var idx = CFG.vehAssigned.indexOf(vid);
  if (idx >= 0) CFG.vehAssigned.splice(idx, 1);
  else CFG.vehAssigned.push(vid);
  elRef.classList.toggle('sel', CFG.vehAssigned.indexOf(vid) >= 0);
}

function cfgBindJobAddressFields(ji) {
  var origEl = document.getElementById('jcfg-origin-' + ji);
  var destEl = document.getElementById('jcfg-dest-' + ji);
  if (origEl && !origEl.readOnly && !origEl._addrBound) {
    bindAddressField(origEl);
  }
  if (destEl && !destEl.readOnly && !destEl._addrBound) {
    bindAddressField(destEl, {
      showDist: true,
      fromFn: function() { return (origEl ? origEl.value.trim() : '') || APP_SETTINGS.warehouseAddress || ''; }
    });
  }
}


function cfgRenderMovements() {
  var h = '';

  // ── 1. VOLUME per job ───────────────────────────────────────────────
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#FFF5E0">📐</div>';
  h += '<div class="cs-card-title">Volume</div></div>';
  h += '<div class="cs-body">';
  for (var di = 0; di < CFG.jobDefs.length; di++) {
    var jd = CFG.jobDefs[di];
    var jt = JOB_TYPES_V2.filter(function(x){ return x.code === jd.jobTypeCode; })[0] || {};
    var mv0 = jd.movements[0];
    h += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">';
    h += '<span style="font-size:12px;font-weight:700;min-width:80px">' + esc(jt.icon||'') + ' ' + esc(jt.label||jd.jobTypeCode) + '</span>';
    h += '<input type="number" class="cfg-input" id="jvol-' + di + '" value="' + esc(mv0.volUnit==='cbm'?(mv0.volCbm||''):(mv0.volFt||'')) + '" min="0" placeholder="0" style="width:100px">';
    h += '<button class="vol-unit-btn' + (mv0.volUnit!=='cbm'?' sel':'') + '" onclick="cfgMvSetVolUnit(' + di + ',0,\'ft\',this)">ft³</button>';
    h += '<button class="vol-unit-btn' + (mv0.volUnit==='cbm'?' sel':'') + '" onclick="cfgMvSetVolUnit(' + di + ',0,\'cbm\',this)">CBM</button>';
    h += '</div>';
  }
  h += '</div></div>';

  // ── 2. DURATION OPTIONS ─────────────────────────────────────────────
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">📅</div>';
  h += '<div class="cs-card-title">Duration &amp; Options</div></div>';
  h += '<div class="cs-body">';

  // Single/multi-day
  h += '<div class="mday-row"><label class="mday-toggle"><input type="checkbox" id="cfg-multiday"' + (CFG.isMultiDay?' checked':'') + ' onchange="cfgToggleMultiday(this)"><span class="mday-slider"></span></label>';
  h += '<div style="flex:1"><div class="mday-lbl">Multi-day job</div><div class="mday-sub">Spans more than one calendar day — select each day individually in the matrix below</div></div>';
  if (CFG.isMultiDay) {
    h += '<div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><span style="font-size:12px;color:var(--t3)">Days:</span>';
    h += '<input class="cfg-input" id="cfg-numdays" type="number" min="2" max="30" value="' + (CFG.numDays||2) + '" style="width:64px" onchange="cfgNumDaysChange(this)"></div>';
  }
  h += '</div>';

  // Multi-day slot display
  if (CFG.isMultiDay) {
    var n = CFG.numDays || 2;
    var chosen = CFG.selectedDates ? CFG.selectedDates.slice() : [];
    var filled = chosen.filter(function(d){ return !!d; }).length;
    h += '<div class="dayslot-progress" style="margin:10px 0 8px">';
    h += '<div class="dp-label' + (filled>=n?' done':'') + '">' + (filled>=n ? '✓ All '+n+' days selected' : filled+' of '+n+' days selected — click dates in matrix below') + '</div>';
    h += '<div class="dp-bar-wrap"><div class="dp-bar" style="width:' + Math.round((filled/n)*100) + '%"></div></div></div>';
    h += '<div style="margin-bottom:8px">';
    for (var si = 0; si < n; si++) {
      var slotDate = chosen[si] || '';
      h += '<div class="dayslot-row"><div class="dayslot-num' + (slotDate?' filled':'') + '">Day ' + (si+1) + '</div>';
      h += '<div class="dayslot-val' + (slotDate?' filled':'') + '" id="ds-val-' + si + '">';
      if (slotDate) {
        h += '<span>📅 ' + fmtNice(slotDate) + ' (' + ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(slotDate+'T00:00:00').getDay()] + ')</span>';
        h += '<span class="ds-clear" onclick="cfgClearSlot(' + si + ')">✕</span>';
      } else {
        h += '<span style="color:var(--t4)">Click a date in the matrix below</span>';
      }
      h += '</div></div>';
    }
    h += '</div>';
  } else {
    // Single day display
    var singleVal = (CFG.selectedDates && CFG.selectedDates[0]) ? CFG.selectedDates[0] : (CFG.startDate||'');
    h += '<div style="margin:10px 0 4px">';
    if (singleVal) {
      h += '<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--blt);border-radius:6px;border:1px solid var(--blue)">';
      h += '<span style="font-size:18px">📅</span>';
      h += '<span style="font-weight:700;color:var(--blue)">' + fmtNice(singleVal) + ' (' + ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(singleVal+'T00:00:00').getDay()] + ')</span>';
      h += '<button onclick="cfgClearSlot(0)" style="margin-left:auto;background:none;border:none;color:var(--red);cursor:pointer;font-size:12px">✕ Clear</button>';
      h += '</div>';
    } else {
      h += '<div style="padding:8px 12px;background:var(--s1);border-radius:6px;border:1px dashed var(--b2);color:var(--t3);font-size:12px">Click any date in the matrix below to select it</div>';
    }
    h += '</div>';
    // Also offer a manual date field
    h += '<div class="cfg-field" style="margin-top:8px"><label class="cfg-label">Or type date manually</label>';
    h += '<input class="cfg-input" id="cfg-startdate" type="date" value="' + esc(singleVal) + '" onchange="cfgManualDateChange()" style="max-width:180px"></div>';
  }

  // Overnight
  h += '<div class="mday-row" style="margin-top:10px"><label class="mday-toggle"><input type="checkbox" id="cfg-overnight"' + (CFG.hasOvernight?' checked':'') + ' onchange="cfgToggleOvernight(this)"><span class="mday-slider"></span></label>';
  h += '<div style="flex:1"><div class="mday-lbl">Overnight stays</div><div class="mday-sub">Crew needs accommodation</div></div>';
  if (CFG.hasOvernight) {
    h += '<div style="display:flex;align-items:center;gap:6px;flex-shrink:0">';
    h += '<input class="cfg-input" id="cfg-numnights" type="number" min="1" max="14" value="' + (CFG.numNights||1) + '" style="width:56px">';
    h += '<span style="font-size:12px;color:var(--t3)">nights @ £</span>';
    h += '<input class="cfg-input" id="cfg-nightallow" type="number" min="0" value="' + (CFG.overnightAllowance||65) + '" style="width:68px">';
    h += '<span style="font-size:12px;color:var(--t3)">/person</span></div>';
  }
  h += '</div>';

  // Weekend + Journey
  h += '<div class="mday-row"><label class="mday-toggle"><input type="checkbox" id="cfg-weekend"' + (CFG.weekendWorking?' checked':'') + '><span class="mday-slider"></span></label>';
  h += '<div><div class="mday-lbl">Weekend working</div><div class="mday-sub">Saturday or Sunday required</div></div></div>';

  h += '<div class="mday-row" style="margin-bottom:0"><label class="mday-toggle"><input type="checkbox" id="cfg-linkjourney"' + (CFG.linkJourney?' checked':'') + ' onchange="cfgToggleLinkJourney(this)"><span class="mday-slider"></span></label>';
  h += '<div style="flex:1"><div class="mday-lbl">Part of a Journey / Run</div><div class="mday-sub">Link to existing journey or create new</div></div>';
  if (CFG.linkJourney) {
    h += '<select class="cfg-input cfg-select" id="cfg-journeysel" style="width:200px;flex-shrink:0"><option value="_new">+ Create new journey</option>';
    for (var jni = 0; jni < JOURNEYS.length; jni++) {
      h += '<option value="' + JOURNEYS[jni].id + '"' + (CFG.journeyId===JOURNEYS[jni].id?' selected':'') + '>' + esc(JOURNEYS[jni].label) + '</option>';
    }
    h += '</select>';
  }
  h += '</div>';
  h += '</div></div>';

  // ── 3. AVAILABILITY MATRIX ──────────────────────────────────────────
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#E6FFF5">📊</div>';
  h += '<div style="flex:1"><div class="cs-card-title">4-Week Availability</div>';
  h += '<div class="cs-card-sub">' + (CFG.isMultiDay ? 'Click dates to fill day slots in order — can be non-consecutive' : 'Click any date to select it') + '</div></div></div>';
  h += '<div class="cs-body" id="cfg-avail-body"><div style="text-align:center;color:var(--t3);padding:20px;font-size:12px">Building matrix...</div></div>';
  h += '</div>';

  // ── 4. MOVEMENT LEGS ────────────────────────────────────────────────
  for (var di2 = 0; di2 < CFG.jobDefs.length; di2++) {
    var jd2 = CFG.jobDefs[di2];
    var jt2 = JOB_TYPES_V2.filter(function(x){ return x.code === jd2.jobTypeCode; })[0] || {};
    h += '<div class="cs-card" style="border-left:3px solid ' + (jt2.accent||'var(--b1)') + '">';
    h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:' + (jt2.color||'#f0f0f0') + '">' + (jt2.icon||'📋') + '</div>';
    h += '<div style="flex:1"><div class="cs-card-title">' + esc(jt2.label||jd2.jobTypeCode) + ' — Movements</div>';
    h += '<div class="cs-card-sub">Origin, destination and mode for each leg</div></div></div>';
    h += '<div class="cs-body" style="padding-top:6px">';
    for (var mi2 = 0; mi2 < jd2.movements.length; mi2++) {
      h += cfgRenderMovementCard(di2, mi2, jd2.movements[mi2], jd2.jobTypeCode);
    }
    h += '<button class="btn btn-s btn-sm" style="width:100%;margin-top:6px" onclick="cfgAddMovement(' + di2 + ')">+ Add Movement Leg</button>';
    h += '</div></div>';
  }

  return h;
}

// Track which movement is "active" for date assignment
var cfgActiveMv = { jdi: 0, mi: 0 };
var cfgMatrixOffset = 0;

function cfgSetActiveMv(jdi, mi) {
  cfgActiveMv = { jdi: jdi, mi: mi };
  // Update hint text
  var jd = CFG.jobDefs[jdi];
  var mv = jd.movements[mi];
  var jt = JOB_TYPES_V2.filter(function(x){ return x.code === jd.jobTypeCode; })[0] || {};
  var hint = el('cfg-active-mv-hint');
  if (hint) hint.innerHTML = '📅 Assigning to: <strong>' + esc(jt.label || jd.jobTypeCode) + ' — Movement ' + (mi + 1) + '</strong> ' + (mv.date ? '(currently: ' + mv.date + ')' : '(no date yet)') + ' · Click a date in the matrix above';
  // Highlight all movement cards
  document.querySelectorAll('.movement-card').forEach(function(c){ c.style.outline = ''; });
  var active = el('mvcrd-' + jdi + '-' + mi);
  if (active) active.style.outline = '2px solid var(--blue)';
  // Rebuild matrix with new active selection
  cfgBuildMatrix();
}

function cfgBuildMatrix() {
  var body = el('cfg-avail-body');
  if (!body) return;

  var today = new Date();
  today.setHours(0, 0, 0, 0);

  // Build resource list: crew + vehicles (up to 8 cols)
  var resources = [];
  for (var ci = 0; ci < CREW.length; ci++) {
    resources.push({ type: 'crew', name: CREW[ci].name, shortName: CREW[ci].name.split(' ')[0], col: CREW[ci].col });
  }
  for (var vi = 0; vi < VEHICLES.length; vi++) {
    resources.push({ type: 'veh', name: VEHICLES[vi].name + ' (' + VEHICLES[vi].reg + ')', shortName: VEHICLES[vi].name, col: '#7A849E' });
  }
  var numCols = Math.min(resources.length, 8);

  // Collect all already-assigned dates across all movements
  var assignedDates = {};
  CFG.jobDefs.forEach(function(jd, jdi) {
    jd.movements.forEach(function(mv, mi) {
      if (mv.date) {
        if (!assignedDates[mv.date]) assignedDates[mv.date] = [];
        var jt = JOB_TYPES_V2.filter(function(x){ return x.code === jd.jobTypeCode; })[0] || {};
        assignedDates[mv.date].push({ jdi: jdi, mi: mi, label: (jt.icon || '') + ' ' + (mi + 1), isActive: (jdi === cfgActiveMv.jdi && mi === cfgActiveMv.mi) });
      }
    });
  });

  var activeDateStr = (CFG.jobDefs[cfgActiveMv.jdi] && CFG.jobDefs[cfgActiveMv.jdi].movements[cfgActiveMv.mi]) ? CFG.jobDefs[cfgActiveMv.jdi].movements[cfgActiveMv.mi].date : '';

  var offsetDays = cfgMatrixOffset * 7;
  var fromDate = new Date(today);
  fromDate.setDate(fromDate.getDate() + offsetDays);
  var toDate = new Date(fromDate);
  toDate.setDate(toDate.getDate() + 27);

  var fromLabel = fromDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
  var toLabel   = toDate.toLocaleDateString('en-GB',   { day: 'numeric', month: 'short', year: 'numeric' });

  var h = '<div class="avail-matrix">';

  // Nav bar
  h += '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--b1)">';
  h += '<button class="btn btn-s btn-sm" onclick="cfgMatrixNav(-1)"' + (cfgMatrixOffset <= 0 ? ' disabled style="opacity:.4"' : '') + '>← Earlier</button>';
  h += '<div style="font-size:12px;font-weight:600;color:var(--blue);cursor:pointer;padding:3px 8px;border-radius:5px" onclick="openDateJumper(\'matrix\')" title="Jump to date">' + fromLabel + ' — ' + toLabel + ' ▾</div>';
  h += '<button class="btn btn-s btn-sm" onclick="cfgMatrixNav(1)">Later →</button>';
  h += '</div>';

  // Header row
  h += '<div class="avail-head-row">';
  h += '<div class="avail-head-date">Date</div>';
  for (var ri = 0; ri < numCols; ri++) {
    h += '<div class="avail-head-res">' + esc(resources[ri].shortName) + '</div>';
  }
  h += '</div>';

  var DAYS   = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  var MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  for (var di = 0; di < 28; di++) {
    var d = new Date(fromDate);
    d.setDate(d.getDate() + di);
    var ds = d.toISOString().slice(0, 10);
    var dow = d.getDay();
    var isWknd = dow === 0 || dow === 6;

    var isActive = ds === activeDateStr;
    var assigned = assignedDates[ds] || [];
    var hasAssignment = assigned.length > 0;

    var rowCls = 'avail-row' + (isActive ? ' chosen' : '');

    h += '<div class="' + rowCls + '" id="avrow-' + ds + '" onclick="cfgSelectDate(\'' + ds + '\')">';
    h += '<div class="avail-date-cell">';
    h += '<span>' + d.getDate() + ' ' + MONTHS[d.getMonth()];
    // Show assignment badges
    if (assigned.length > 0) {
      assigned.forEach(function(a) {
        h += ' <span style="display:inline-block;background:' + (a.isActive ? 'var(--blue)' : 'var(--purple)') + ';color:#fff;border-radius:10px;padding:0 5px;font-size:9px;font-weight:700">' + a.label + '</span>';
      });
    }
    h += '</span>';
    h += '<span class="avail-dow">' + DAYS[dow] + '</span>';
    h += '</div>';

    for (var ri2 = 0; ri2 < numCols; ri2++) {
      var res = resources[ri2];
      var status = cfgGetAvail(res, ds, isWknd);
      h += '<div class="avail-res-cell"><div class="avail-bar ' + status.cls + '">' + status.lbl + '</div></div>';
    }
    h += '</div>';
  }

  // Legend
  h += '<div class="avail-legend">';
  h += '<div class="avail-leg-i"><div class="avail-leg-dot" style="background:#D1FAE5"></div>Free</div>';
  h += '<div class="avail-leg-i"><div class="avail-leg-dot" style="background:#FEE2E2"></div>Busy</div>';
  h += '<div class="avail-leg-i"><div class="avail-leg-dot" style="background:#ede9e0"></div>Weekend</div>';
  h += '<div class="avail-leg-i"><div class="avail-leg-dot" style="background:var(--blue);border-radius:50%"></div>This movement</div>';
  h += '<div class="avail-leg-i"><div class="avail-leg-dot" style="background:var(--purple);border-radius:50%"></div>Other movements</div>';
  h += '</div></div>';

  body.innerHTML = h;
}

function cfgGetAvail(res, ds, isWknd) {
  if (isWknd) return { cls: 'wknd', lbl: 'Wknd' };
  for (var ji = 0; ji < jobs.length; ji++) {
    var jb = jobs[ji];
    if (ds < jb.start || ds > jb.end) continue;
    if (res.type === 'crew') {
      if ((jb.drivers || []).indexOf(res.name) >= 0 || (jb.porters || []).indexOf(res.name) >= 0) {
        return { cls: 'busy', lbl: 'Booked' };
      }
    } else {
      if ((jb.veh || []).some(function(v){ return res.name.indexOf(v) >= 0 || v.indexOf(res.shortName) >= 0; })) {
        return { cls: 'busy', lbl: 'Booked' };
      }
    }
  }
  if (res.type === 'crew' && HOL[res.name] && HOL[res.name].indexOf(ds) >= 0) return { cls: 'busy', lbl: 'Holiday' };
  return { cls: 'free', lbl: 'Free' };
}

function cfgMatrixSelectDate(ds) {
  // Assign this date to the active movement
  var jd = CFG.jobDefs[cfgActiveMv.jdi];
  if (!jd) return;
  var mv = jd.movements[cfgActiveMv.mi];
  if (!mv) return;

  // Toggle off if same date
  if (mv.date === ds) {
    mv.date = '';
  } else {
    mv.date = ds;
    // Update the date input field directly if visible
    var dateInput = el('mv-date-' + cfgActiveMv.jdi + '-' + cfgActiveMv.mi);
    if (dateInput) dateInput.value = ds;
    // Update avail summary
    var avail = el('mv-avail-' + cfgActiveMv.jdi + '-' + cfgActiveMv.mi);
    if (avail) avail.innerHTML = cfgAvailSummary(ds);
    toast('📅 ' + ds + ' assigned to movement ' + (cfgActiveMv.mi + 1));
  }

  // Update hint and rebuild matrix without full re-render
  var hint = el('cfg-active-mv-hint');
  if (hint) {
    var jt2 = JOB_TYPES_V2.filter(function(x){ return x.code === jd.jobTypeCode; })[0] || {};
    hint.innerHTML = '📅 Assigning to: <strong>' + esc(jt2.label || jd.jobTypeCode) + ' — Movement ' + (cfgActiveMv.mi + 1) + '</strong> ' + (mv.date ? '(currently: ' + mv.date + ')' : '(no date yet)') + ' · Click a date in the matrix above';
  }
  cfgBuildMatrix();
}

function cfgMatrixNav(dir) {
  cfgMatrixOffset = Math.max(0, cfgMatrixOffset + dir);
  cfgBuildMatrix();
}


function cfgRenderMovementCard(jdi, mi, mv, jobTypeCode) {
  var h = '';
  var canRemove = CFG.jobDefs[jdi].movements.length > 1;
  var isActive = (cfgActiveMv.jdi === jdi && cfgActiveMv.mi === mi);
  var mo = MOVEMENT_MODES.filter(function(x){ return x.key === mv.mode; })[0] || {};

  h += '<div class="movement-card" id="mvcrd-' + jdi + '-' + mi + '" style="background:var(--s1);border:2px solid ' + (isActive ? 'var(--blue)' : 'var(--b1)') + ';border-radius:8px;padding:12px;margin-bottom:10px;transition:border-color .2s">';

  // Header: activate button + date badge + remove
  h += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">';
  h += '<button onclick="cfgSetActiveMv(' + jdi + ',' + mi + ')" style="padding:4px 12px;border-radius:16px;font-size:11px;font-weight:700;cursor:pointer;border:2px solid ' + (isActive ? 'var(--blue)' : 'var(--b1)') + ';background:' + (isActive ? 'var(--blue)' : 'transparent') + ';color:' + (isActive ? '#fff' : 'var(--t2)') + '">' + (isActive ? '▶ Active' : 'Set Active') + '</button>';

  if (mv.date) {
    h += '<span style="padding:4px 10px;background:var(--green);color:#fff;border-radius:12px;font-size:11.5px;font-weight:700">📅 ' + mv.date + '</span>';
    h += '<button onclick="cfgClearMovementDate(' + jdi + ',' + mi + ')" style="font-size:10px;color:var(--red);background:none;border:none;cursor:pointer;padding:2px 4px">✕</button>';
  } else {
    h += '<span style="padding:4px 10px;background:var(--b1);color:var(--t3);border-radius:12px;font-size:11.5px;font-weight:600">' + (isActive ? '← click matrix above' : 'No date') + '</span>';
  }
  h += '<span style="font-size:11px;font-weight:600;color:var(--t3);margin-left:auto">Movement ' + (mi + 1) + '</span>';
  if (canRemove) h += '<button class="btn btn-s btn-sm" style="font-size:10px;padding:2px 8px;color:var(--red);border-color:var(--red)" onclick="cfgRemoveMovement(' + jdi + ',' + mi + ')">✕</button>';
  h += '</div>';

  // Mode selector
  h += '<div style="margin-bottom:10px">';
  h += '<div style="font-size:10px;font-weight:700;color:var(--t3);margin-bottom:6px;text-transform:uppercase;letter-spacing:.4px">Movement Type</div>';
  h += '<div style="display:flex;flex-wrap:wrap;gap:5px">';
  for (var moi = 0; moi < MOVEMENT_MODES.length; moi++) {
    var mode = MOVEMENT_MODES[moi];
    var sel = mv.mode === mode.key;
    h += '<button onclick="cfgSetMovementMode(' + jdi + ',' + mi + ',\'' + mode.key + '\')" ';
    h += 'style="padding:4px 10px;border-radius:14px;font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;';
    h += sel ? 'background:var(--blue);color:#fff;border:1.5px solid var(--blue)' : 'background:transparent;color:var(--t2);border:1.5px solid var(--b1)';
    h += '">' + mode.icon + ' ' + mode.label + '</button>';
  }
  h += '</div></div>';

  // Warehouse storage picker (for warehouse-in / warehouse-out)
  if (mv.mode === 'warehouse-out' || mv.mode === 'warehouse-in') {
    h += cfgRenderMovementStoragePicker(jdi, mi, mv);
  }

  // Addresses
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">';
  var originLabel = 'Origin Address';
  var destLabel   = 'Destination Address';
  if (mv.mode === 'collection')     { originLabel = 'Collection Address'; destLabel = 'Delivering To'; }
  if (mv.mode === 'delivery')       { originLabel = 'Collecting From';    destLabel = 'Delivery Address'; }
  if (mv.mode === 'warehouse-in')   { destLabel   = 'Our Warehouse'; }
  if (mv.mode === 'warehouse-out')  { originLabel = 'Our Warehouse'; }
  if (mv.mode === 'disposal')       { destLabel   = 'Disposal Site'; }
  if (mv.mode === '3rd-party')      { originLabel = 'Handoff Point'; destLabel = 'Partner Location'; }

  h += '<div class="cfg-field"><label class="cfg-label">' + originLabel + '</label>';
  if (mv.mode === 'warehouse-out') {
    h += '<input class="cfg-input" value="' + esc(APP_SETTINGS.warehouseAddress || 'Our Warehouse') + '" disabled style="background:var(--s2)">';
  } else {
    h += '<input class="cfg-input cfg-addr" id="mv-origin-' + jdi + '-' + mi + '" value="' + esc(mv.origin || '') + '" placeholder="Address or postcode">';
  }
  h += '</div>';

  h += '<div class="cfg-field"><label class="cfg-label">' + destLabel + '</label>';
  if (mv.mode === 'warehouse-in') {
    h += '<input class="cfg-input" value="' + esc(APP_SETTINGS.warehouseAddress || 'Our Warehouse') + '" disabled style="background:var(--s2)">';
  } else {
    h += '<input class="cfg-input cfg-addr" id="mv-dest-' + jdi + '-' + mi + '" value="' + esc(mv.destination || '') + '" placeholder="Address or postcode">';
  }
  h += '</div></div>';

  // Volume + availability summary on same row
  h += '<div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:8px">';
  h += '<div style="display:flex;align-items:center;gap:6px">';
  h += '<label class="cfg-label" style="margin:0;white-space:nowrap">Volume</label>';
  h += '<input type="number" class="cfg-input" id="mv-vol-' + jdi + '-' + mi + '" value="' + esc(mv.volUnit === 'cbm' ? (mv.volCbm || '') : (mv.volFt || '')) + '" min="0" placeholder="0" style="width:90px">';
  h += '<button class="vol-unit-btn' + (mv.volUnit !== 'cbm' ? ' sel' : '') + '" onclick="cfgMvSetVolUnit(' + jdi + ',' + mi + ',\'ft\',this)">ft³</button>';
  h += '<button class="vol-unit-btn' + (mv.volUnit === 'cbm' ? ' sel' : '') + '" onclick="cfgMvSetVolUnit(' + jdi + ',' + mi + ',\'cbm\',this)">CBM</button>';
  h += '</div>';

  // Availability for this date inline
  if (mv.date) {
    h += '<div id="mv-avail-' + jdi + '-' + mi + '" style="font-size:11.5px;padding:4px 10px;background:var(--bg);border:1px solid var(--b1);border-radius:6px;flex:1;min-width:150px">';
    h += cfgAvailSummary(mv.date);
    h += '</div>';
  }
  h += '</div>';

  // Services & notes toggle
  var svcsOn = mv.svcs ? Object.keys(mv.svcs).filter(function(k){ return mv.svcs[k]; }).length : 0;
  var flagsOn = ['smallVehicle','tightAccess','shuttle','parkingSuspension','permit'].filter(function(f){ return mv[f]; }).length;
  var extraCount = svcsOn + flagsOn;

  h += '<button class="btn btn-s btn-sm" onclick="cfgToggleMvDetails(\'' + jdi + '-' + mi + '\')" style="font-size:11px">';
  h += '⚙ Services & Notes' + (extraCount > 0 ? ' <span style="background:var(--blue);color:#fff;border-radius:10px;padding:1px 6px;font-size:10px">' + extraCount + '</span>' : '');
  h += '</button>';

  h += '<div id="mv-details-' + jdi + '-' + mi + '" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--b1)">';
  var svcs = [['casing','Casing'],['crating','Crating'],['handyman','Handyman'],['piano','Piano'],['packingMaterials','Packing Materials'],['debris','Debris Removal']];
  h += '<div style="font-size:10px;font-weight:700;color:var(--t3);margin-bottom:5px;text-transform:uppercase;letter-spacing:.4px">Services</div>';
  h += '<div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px">';
  svcs.forEach(function(s){
    var on = mv.svcs && mv.svcs[s[0]];
    h += '<button onclick="cfgToggleMvSvc(' + jdi + ',' + mi + ',\'' + s[0] + '\',this)" style="padding:3px 10px;border-radius:14px;font-size:11px;cursor:pointer;';
    h += on ? 'background:var(--blue);color:#fff;border:1px solid var(--blue)' : 'background:transparent;color:var(--t2);border:1px solid var(--b1)';
    h += '">' + s[1] + '</button>';
  });
  h += '</div>';
  var flags = [['smallVehicle','Small Vehicle'],['tightAccess','Tight Access'],['shuttle','Shuttle'],['parkingSuspension','Parking Suspension'],['permit','Permit Required']];
  h += '<div style="font-size:10px;font-weight:700;color:var(--t3);margin-bottom:5px;text-transform:uppercase;letter-spacing:.4px">Access</div>';
  h += '<div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px">';
  flags.forEach(function(f){
    var on = mv[f[0]];
    h += '<button onclick="cfgToggleMvFlag(' + jdi + ',' + mi + ',\'' + f[0] + '\',this)" style="padding:3px 10px;border-radius:14px;font-size:11px;cursor:pointer;';
    h += on ? 'background:var(--amber);color:#fff;border:1px solid var(--amber)' : 'background:transparent;color:var(--t2);border:1px solid var(--b1)';
    h += '">' + f[1] + '</button>';
  });
  h += '</div>';
  h += '<textarea class="cfg-input" id="mv-notes-' + jdi + '-' + mi + '" rows="2" placeholder="Movement notes..." style="resize:vertical">' + esc(mv.notes || '') + '</textarea>';
  h += '</div>';

  h += '</div>'; // movement-card
  return h;
}

function cfgClearMovementDate(jdi, mi) {
  CFG.jobDefs[jdi].movements[mi].date = '';
  cfgBuildMatrix();
  // Update date badge area by re-rendering just this card
  var card = el('mvcrd-' + jdi + '-' + mi);
  if (card) {
    var mv = CFG.jobDefs[jdi].movements[mi];
    var newHtml = cfgRenderMovementCard(jdi, mi, mv, CFG.jobDefs[jdi].jobTypeCode);
    var tmp = document.createElement('div');
    tmp.innerHTML = newHtml;
    card.parentNode.replaceChild(tmp.firstChild, card);
    cfgPostRender();
  }
}


function cfgRenderMovementStoragePicker(jdi, mi, mv) {
  var h = '<div style="margin-bottom:10px;padding:10px;background:#FFFAEB;border:1px solid #D69E2E33;border-radius:6px">';
  h += '<div style="font-size:11px;font-weight:700;color:#D69E2E;margin-bottom:8px">🏭 Storage Record</div>';
  if (mv.storageRecordId) {
    var sr = STORAGE_RECORDS.filter(function(x){ return x.id === mv.storageRecordId; })[0];
    if (sr) {
      h += '<div style="font-size:12px;font-weight:600">' + esc(sr.id) + ' — ' + esc(sr.client) + '</div>';
      h += '<div style="font-size:11px;color:var(--t2)">' + sr.volFt + ' ft³ in storage</div>';
      h += '<button class="btn btn-s btn-sm" style="margin-top:6px;font-size:10px" onclick="cfgClearMvStorage(' + jdi + ',' + mi + ')">✕ Change</button>';
    }
  } else if (mv.mode === 'warehouse-in') {
    h += '<label style="display:flex;gap:8px;align-items:center;font-size:12px;cursor:pointer">';
    h += '<input type="checkbox" id="mv-sto-new-' + jdi + '-' + mi + '" ' + (mv.storageIsNew ? 'checked' : '') + ' onchange="cfgMvStorageNewToggle(' + jdi + ',' + mi + ',this.checked)">';
    h += 'Create new storage record</label>';
    if (!mv.storageIsNew) {
      var activeStores = STORAGE_RECORDS.filter(function(s){ return s.status === 'active' || s.status === 'pending'; });
      if (activeStores.length) {
        h += '<select class="cfg-input cfg-select" style="margin-top:6px;font-size:12px" id="mv-sto-sel-' + jdi + '-' + mi + '" onchange="cfgMvSelectStorage(' + jdi + ',' + mi + ',this.value)">';
        h += '<option value="">— Link to existing record —</option>';
        activeStores.forEach(function(s){ h += '<option value="' + s.id + '">' + esc(s.id + ' — ' + s.client + ' (' + s.volFt + 'ft³)') + '</option>'; });
        h += '</select>';
      }
    }
  } else {
    // warehouse-out: must pick existing
    var activeStores2 = STORAGE_RECORDS.filter(function(s){ return s.status === 'active'; });
    h += '<select class="cfg-input cfg-select" style="font-size:12px" id="mv-sto-sel-' + jdi + '-' + mi + '" onchange="cfgMvSelectStorage(' + jdi + ',' + mi + ',this.value)">';
    h += '<option value="">— Select storage record to deliver from —</option>';
    activeStores2.forEach(function(s){
      h += '<option value="' + s.id + '"' + (mv.storageRecordId === s.id ? ' selected' : '') + '>' + esc(s.id + ' — ' + s.client + ' (' + s.volFt + 'ft³ in store)') + '</option>';
    });
    h += '</select>';
  }
  h += '</div>';
  return h;
}

function cfgRenderStorageSection(jdi, jd) {
  return ''; // Storage handled inline per movement for WHS jobs
}

function cfgAvailSummary(date) {
  if (!date) return '<span style="color:var(--t3)">—</span>';
  var jobsOnDay = jobs.filter(function(j){ return j.start <= date && j.end >= date; });
  var vehUsed = [];
  jobsOnDay.forEach(function(j){ (j.veh || []).forEach(function(v){ if (vehUsed.indexOf(v) < 0) vehUsed.push(v); }); });
  var totalVeh = VEHICLES.length;
  var freeVeh = totalVeh - vehUsed.length;
  var driversUsed = 0, portersUsed = 0;
  jobsOnDay.forEach(function(j){
    driversUsed += (j.drivers || []).length;
    portersUsed += (j.porters || []).length;
  });
  var totalDrivers = CREW.filter(function(c){ return c.role === 'Driver'; }).length;
  var totalPorters  = CREW.filter(function(c){ return c.role !== 'Driver'; }).length;
  var col = (freeVeh === 0 || (totalDrivers - driversUsed) <= 0) ? 'var(--red)' : (freeVeh <= 1 ? 'var(--amber)' : 'var(--green)');
  return '<span style="color:' + col + ';font-weight:700">' +
    freeVeh + '/' + totalVeh + ' veh</span> · ' +
    (totalDrivers - driversUsed) + ' drivers · ' +
    (totalPorters - portersUsed) + ' porters free';
}

function cfgCollectMovements() {
  // Collect duration/scheduling options (also on this stage)
  var mdEl = el('cfg-multiday');   if (mdEl) CFG.isMultiDay = mdEl.checked;
  var ndEl = el('cfg-numdays');    if (ndEl) CFG.numDays = parseInt(ndEl.value) || 2;
  var onEl = el('cfg-overnight');  if (onEl) CFG.hasOvernight = onEl.checked;
  var nnEl = el('cfg-numnights');  if (nnEl) CFG.numNights = parseInt(nnEl.value) || 1;
  var naEl = el('cfg-nightallow'); if (naEl) CFG.overnightAllowance = parseFloat(naEl.value) || 65;
  var wkEl = el('cfg-weekend');    if (wkEl) CFG.weekendWorking = wkEl.checked;
  var ljEl = el('cfg-linkjourney'); if (ljEl) CFG.linkJourney = ljEl.checked;
  var jsEl = el('cfg-journeysel'); if (jsEl && jsEl.value) CFG.journeyId = jsEl.value === '_new' ? null : jsEl.value;
  // Manual date input (single day)
  if (!CFG.isMultiDay) {
    var sdEl = el('cfg-startdate');
    if (sdEl && sdEl.value) { CFG.startDate = sdEl.value; if (!CFG.selectedDates) CFG.selectedDates = []; CFG.selectedDates[0] = sdEl.value; }
  }

  // Collect volume from per-job inputs (jvol-N)
  for (var di = 0; di < CFG.jobDefs.length; di++) {
    var jd = CFG.jobDefs[di];
    var volEl0 = el('jvol-' + di);
    if (volEl0 && jd.movements.length > 0) {
      var mv0 = jd.movements[0];
      if (mv0.volUnit === 'cbm') mv0.volCbm = volEl0.value;
      else mv0.volFt = volEl0.value;
    }
    // Collect movement-level fields
    for (var mi = 0; mi < jd.movements.length; mi++) {
      var mv = jd.movements[mi];
      mv.origin      = (el('mv-origin-' + di + '-' + mi) || {}).value || mv.origin;
      mv.destination = (el('mv-dest-'   + di + '-' + mi) || {}).value || mv.destination;
      var notesEl = el('mv-notes-' + di + '-' + mi);
      if (notesEl) mv.notes = notesEl.value;
      if (mv.mode === 'warehouse-in')  mv.destination = APP_SETTINGS.warehouseAddress || 'Our Warehouse';
      if (mv.mode === 'warehouse-out') mv.origin      = APP_SETTINGS.warehouseAddress || 'Our Warehouse';
    }
  }
}

function cfgAddMovement(jdi) {
  cfgCollectMovements();
  CFG.jobDefs[jdi].movements.push(cfgEmptyMovement());
  cfgRenderStage();
  setTimeout(function(){
    var cards = document.querySelectorAll('#mvcrd-' + jdi + '-' + (CFG.jobDefs[jdi].movements.length - 1));
    if (cards.length) cards[0].scrollIntoView({ behavior:'smooth', block:'nearest' });
  }, 100);
}

function cfgRemoveMovement(jdi, mi) {
  cfgCollectMovements();
  CFG.jobDefs[jdi].movements.splice(mi, 1);
  cfgRenderStage();
}

function cfgSetMovementMode(jdi, mi, mode) {
  cfgCollectMovements();
  CFG.jobDefs[jdi].movements[mi].mode = mode;
  cfgRenderStage();
}

function cfgMovementDateChange(jdi, mi, val) {
  CFG.jobDefs[jdi].movements[mi].date = val;
  var avail = el('mv-avail-' + jdi + '-' + mi);
  if (avail) avail.innerHTML = cfgAvailSummary(val);
}

function cfgMvSetVolUnit(jdi, mi, unit, btn) {
  CFG.jobDefs[jdi].movements[mi].volUnit = unit;
  var volEl = el('mv-vol-' + jdi + '-' + mi);
  if (volEl) {
    var mv = CFG.jobDefs[jdi].movements[mi];
    volEl.value = unit === 'cbm' ? (mv.volCbm || '') : (mv.volFt || '');
  }
  btn.closest('.movement-card').querySelectorAll('.vol-unit-btn').forEach(function(b){ b.classList.remove('sel'); });
  btn.classList.add('sel');
}

function cfgToggleMvDetails(key) {
  var d = el('mv-details-' + key);
  if (d) d.style.display = d.style.display === 'none' ? '' : 'none';
}

function cfgToggleMvSvc(jdi, mi, key, btn) {
  var mv = CFG.jobDefs[jdi].movements[mi];
  if (!mv.svcs) mv.svcs = {};
  mv.svcs[key] = !mv.svcs[key];
  var on = mv.svcs[key];
  btn.style.background = on ? 'var(--blue)' : 'transparent';
  btn.style.color = on ? '#fff' : 'var(--t2)';
  btn.style.borderColor = on ? 'var(--blue)' : 'var(--b1)';
}

function cfgToggleMvFlag(jdi, mi, key, btn) {
  var mv = CFG.jobDefs[jdi].movements[mi];
  mv[key] = !mv[key];
  var on = mv[key];
  btn.style.background = on ? 'var(--amber)' : 'transparent';
  btn.style.color = on ? '#fff' : 'var(--t2)';
  btn.style.borderColor = on ? 'var(--amber)' : 'var(--b1)';
}

function cfgMvSelectStorage(jdi, mi, storageId) {
  CFG.jobDefs[jdi].movements[mi].storageRecordId = storageId;
}

function cfgMvStorageNewToggle(jdi, mi, checked) {
  CFG.jobDefs[jdi].movements[mi].storageIsNew = checked;
  cfgRenderStage();
}

function cfgClearMvStorage(jdi, mi) {
  CFG.jobDefs[jdi].movements[mi].storageRecordId = '';
  cfgRenderStage();
}

// ── STAGE 2: RESOURCES ─────────────────────────────────────────────────────

function cfgRenderResources() {
  var h = '';

  // Vehicle availability summary header
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">🚚</div>';
  h += '<div><div class="cs-card-title">Vehicles</div>';
  h += '<div class="cs-card-sub">Select specific vehicles to book out — they will be removed from availability on their dates</div></div></div>';
  h += '<div class="cs-body">';

  // All dates across all movements
  var allDates = [];
  CFG.jobDefs.forEach(function(jd){
    jd.movements.forEach(function(mv){ if (mv.date && allDates.indexOf(mv.date) < 0) allDates.push(mv.date); });
  });
  allDates.sort();

  if (VEHICLES.length === 0) {
    h += '<div style="color:var(--t3);font-size:12px">No vehicles in system — add vehicles in Settings → Vehicles</div>';
  } else {
    h += '<div style="display:flex;flex-direction:column;gap:8px">';
    for (var vi = 0; vi < VEHICLES.length; vi++) {
      var v = VEHICLES[vi];
      // Check if booked on any of our dates
      var booked = allDates.some(function(d){
        return jobs.some(function(j){
          return j.start <= d && j.end >= d && (j.veh||[]).indexOf(v.reg||v.name) >= 0;
        });
      });
      // Check if selected in CFG
      var allSelected = CFG.jobDefs.some(function(jd){ return (jd.vehicleIds||[]).indexOf(v.id||v.reg) >= 0; });

      h += '<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;border:1px solid ' + (allSelected ? 'var(--blue)' : 'var(--b1)') + ';background:' + (allSelected ? 'var(--blt)' : 'var(--bg)') + '">';
      h += '<input type="checkbox" id="veh-sel-' + vi + '" ' + (allSelected ? 'checked' : '') + (booked ? ' disabled' : '') + ' onchange="cfgToggleVehicle(\'' + esc(v.id||v.reg) + '\',this.checked)">';
      h += '<div style="flex:1">';
      h += '<div style="font-weight:700;font-size:13px">' + esc(v.name || v.reg) + '</div>';
      h += '<div style="font-size:11px;color:var(--t3)">' + esc(v.type || '') + (v.reg ? ' · ' + esc(v.reg) : '') + '</div>';
      h += '</div>';
      if (booked) {
        h += '<span style="font-size:11px;color:var(--red);font-weight:700">BOOKED</span>';
      } else if (allSelected) {
        h += '<span style="font-size:11px;color:var(--blue);font-weight:700">SELECTED</span>';
      }
      h += '</div>';
    }
    h += '</div>';
  }
  h += '</div></div>';

  // Crew requirements — generic headcount per job
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#E6FFF5">👷</div>';
  h += '<div><div class="cs-card-title">Crew Requirements</div>';
  h += '<div class="cs-card-sub">Set headcount needed — names assigned closer to job date</div></div></div>';
  h += '<div class="cs-body">';

  // Crew availability for all dates
  if (allDates.length > 0) {
    h += '<div style="margin-bottom:14px;padding:8px 12px;background:var(--s1);border-radius:6px;border:1px solid var(--b1)">';
    h += '<div style="font-size:11px;font-weight:700;color:var(--t3);margin-bottom:6px;text-transform:uppercase;letter-spacing:.4px">Availability on job dates</div>';
    allDates.forEach(function(d){
      h += '<div style="font-size:12px;padding:3px 0">';
      h += '<span style="font-weight:600;color:var(--t1)">' + d + '</span> — ';
      h += cfgAvailSummary(d);
      h += '</div>';
    });
    h += '</div>';
  }

  for (var di = 0; di < CFG.jobDefs.length; di++) {
    var jd = CFG.jobDefs[di];
    var jt = JOB_TYPES_V2.filter(function(x){ return x.code === jd.jobTypeCode; })[0] || {};
    h += '<div style="margin-bottom:14px;padding:10px;border-radius:8px;border:1px solid var(--b1);background:var(--s1)">';
    h += '<div style="font-weight:700;font-size:12.5px;margin-bottom:10px">' + esc(jt.icon || '') + ' ' + esc(jt.label || jd.jobTypeCode) + '</div>';
    h += '<div style="display:flex;gap:20px;align-items:center">';
    // Drivers
    h += '<div><label style="font-size:11px;font-weight:600;color:var(--t3);display:block;margin-bottom:4px">DRIVERS</label>';
    h += '<div style="display:flex;align-items:center;gap:6px">';
    h += '<button onclick="cfgCrewAdj(' + di + ',\'drivers\',-1)" style="width:24px;height:24px;border-radius:50%;border:1px solid var(--b1);background:var(--bg);cursor:pointer;font-weight:700">−</button>';
    h += '<span style="font-size:18px;font-weight:700;min-width:20px;text-align:center" id="crew-drv-' + di + '">' + (jd.crewDrivers || 1) + '</span>';
    h += '<button onclick="cfgCrewAdj(' + di + ',\'drivers\',1)" style="width:24px;height:24px;border-radius:50%;border:1px solid var(--b1);background:var(--bg);cursor:pointer;font-weight:700">+</button>';
    h += '</div></div>';
    // Porters
    h += '<div><label style="font-size:11px;font-weight:600;color:var(--t3);display:block;margin-bottom:4px">PORTERS</label>';
    h += '<div style="display:flex;align-items:center;gap:6px">';
    h += '<button onclick="cfgCrewAdj(' + di + ',\'porters\',-1)" style="width:24px;height:24px;border-radius:50%;border:1px solid var(--b1);background:var(--bg);cursor:pointer;font-weight:700">−</button>';
    h += '<span style="font-size:18px;font-weight:700;min-width:20px;text-align:center" id="crew-prt-' + di + '">' + (jd.crewPorters || 2) + '</span>';
    h += '<button onclick="cfgCrewAdj(' + di + ',\'porters\',1)" style="width:24px;height:24px;border-radius:50%;border:1px solid var(--b1);background:var(--bg);cursor:pointer;font-weight:700">+</button>';
    h += '</div></div>';
    // COS preview
    var days = Math.max(1, jd.movements.length);
    var overhead = days * (APP_SETTINGS.cosPerCrewPerDay || 125);
    h += '<div style="margin-left:auto;text-align:right"><div style="font-size:10px;color:var(--t3)">Est. overhead</div>';
    h += '<div style="font-size:15px;font-weight:700;color:var(--red)">' + fmt(overhead) + '</div></div>';
    h += '</div></div>';
  }
  h += '</div></div>';

  return h;
}

function cfgCollectResources() {
  // Vehicles are toggled directly via cfgToggleVehicle
  // Crew counts are adjusted directly via cfgCrewAdj
}

function cfgToggleVehicle(vid, checked) {
  // Apply to all job defs (shared resource across the booking)
  CFG.jobDefs.forEach(function(jd){
    if (!jd.vehicleIds) jd.vehicleIds = [];
    if (checked) {
      if (jd.vehicleIds.indexOf(vid) < 0) jd.vehicleIds.push(vid);
    } else {
      jd.vehicleIds = jd.vehicleIds.filter(function(v){ return v !== vid; });
    }
  });
}

function cfgCrewAdj(jdi, type, delta) {
  var jd = CFG.jobDefs[jdi];
  if (type === 'drivers') {
    jd.crewDrivers = Math.max(0, (jd.crewDrivers || 1) + delta);
    var el2 = el('crew-drv-' + jdi); if (el2) el2.textContent = jd.crewDrivers;
  } else {
    jd.crewPorters = Math.max(0, (jd.crewPorters || 0) + delta);
    var el3 = el('crew-prt-' + jdi); if (el3) el3.textContent = jd.crewPorters;
  }
}

// ── STAGE 3: BILLING ───────────────────────────────────────────────────────

function cfgRenderBilling() {
  var h = '';

  for (var di = 0; di < CFG.jobDefs.length; di++) {
    var jd = CFG.jobDefs[di];
    var jt = JOB_TYPES_V2.filter(function(x){ return x.code === jd.jobTypeCode; })[0] || {};
    var jobTotal = (jd.billing || []).reduce(function(s,b){ return s + (parseFloat(b.amt)||0); }, 0);

    h += '<div class="cs-card" style="border-left:3px solid ' + (jt.accent||'var(--b1)') + '">';
    h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:' + (jt.color||'#f0f0f0') + '">' + (jt.icon||'📋') + '</div>';
    h += '<div style="flex:1"><div class="cs-card-title">' + esc(jt.label||jd.jobTypeCode) + ' — Billing</div>';
    h += '<div class="cs-card-sub">Add revenue lines for this job</div></div>';
    h += '<div style="font-size:18px;font-weight:800;color:var(--blue)">' + spv(fmt(jobTotal)) + '</div>';
    h += '</div>';
    h += '<div class="cs-body">';

    // Billing lines
    var blines = jd.billing || [];
    if (blines.length === 0) {
      h += '<div style="color:var(--t3);font-size:12px;margin-bottom:10px">No billing lines — add below</div>';
    }
    for (var bi = 0; bi < blines.length; bi++) {
      var bl = blines[bi];
      h += '<div style="display:flex;gap:6px;align-items:center;margin-bottom:8px">';
      h += '<input class="cfg-input" id="bl-desc-' + di + '-' + bi + '" value="' + esc(bl.desc||'') + '" placeholder="Description" style="flex:2">';
      h += '<input type="number" class="cfg-input" id="bl-amt-' + di + '-' + bi + '" value="' + esc(bl.amt||'') + '" placeholder="£0.00" min="0" step="0.01" style="flex:1" oninput="cfgUpdateBillingTotal(' + di + ')">';
      h += '<button onclick="cfgRemoveBline(' + di + ',' + bi + ')" style="padding:4px 8px;border:none;background:none;color:var(--red);cursor:pointer;font-size:16px">×</button>';
      h += '</div>';
    }
    h += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">';
    h += '<button class="btn btn-s btn-sm" onclick="cfgAddBline(' + di + ')">+ Add Line</button>';
    // Quick-add buttons for common extras
    var quickLines = [['Packing Materials','materials'],['Crating','crating'],['Shuttle','shuttle'],['Parking Suspension','parking'],['Piano Move','piano'],['Debris Removal','debris'],['Overnight','overnight'],['Fuel Surcharge','fuel']];
    quickLines.forEach(function(ql){
      h += '<button class="btn btn-s btn-sm" style="font-size:10.5px" onclick="cfgAddQuickLine(' + di + ',\'' + ql[0] + '\')">+ ' + ql[0] + '</button>';
    });
    h += '</div>';
    h += '<div id="bl-total-' + di + '" style="margin-top:10px;text-align:right;font-size:13px;font-weight:700;color:var(--blue)">' + spv(fmt(jobTotal)) + '</div>';
    h += '</div></div>';
  }

  // Grand total
  var grandTotal = CFG.jobDefs.reduce(function(s,jd){
    return s + (jd.billing||[]).reduce(function(s2,b){ return s2 + (parseFloat(b.amt)||0); }, 0);
  }, 0);
  h += '<div style="padding:12px 16px;border-radius:8px;background:var(--blt);border:1px solid var(--blue);display:flex;justify-content:space-between;align-items:center">';
  h += '<span style="font-weight:700">Total Revenue (all jobs)</span>';
  h += '<span style="font-size:20px;font-weight:800;color:var(--blue)">' + spv(fmt(grandTotal)) + '</span>';
  h += '</div>';

  return h;
}

function cfgCollectBilling() {
  for (var di = 0; di < CFG.jobDefs.length; di++) {
    var jd = CFG.jobDefs[di];
    for (var bi = 0; bi < (jd.billing||[]).length; bi++) {
      jd.billing[bi].desc = (el('bl-desc-' + di + '-' + bi)||{}).value || jd.billing[bi].desc;
      jd.billing[bi].amt  = parseFloat((el('bl-amt-' + di + '-' + bi)||{}).value) || 0;
    }
  }
}

function cfgAddBline(jdi) {
  cfgCollectBilling();
  CFG.jobDefs[jdi].billing.push({ id:'bl'+Date.now(), desc:'', amt:0, unit:'job', qty:1 });
  cfgRenderStage();
  setTimeout(function(){
    var inputs = document.querySelectorAll('[id^="bl-desc-' + jdi + '-"]');
    if (inputs.length) inputs[inputs.length-1].focus();
  }, 50);
}

function cfgAddQuickLine(jdi, desc) {
  cfgCollectBilling();
  CFG.jobDefs[jdi].billing.push({ id:'bl'+Date.now(), desc:desc, amt:0, unit:'job', qty:1 });
  cfgRenderStage();
}

function cfgRemoveBline(jdi, bi) {
  cfgCollectBilling();
  CFG.jobDefs[jdi].billing.splice(bi, 1);
  cfgRenderStage();
}

function cfgUpdateBillingTotal(jdi) {
  var jd = CFG.jobDefs[jdi];
  var total = 0;
  for (var bi = 0; bi < (jd.billing||[]).length; bi++) {
    var amtEl = el('bl-amt-' + jdi + '-' + bi);
    if (amtEl) total += parseFloat(amtEl.value)||0;
  }
  var totEl = el('bl-total-' + jdi);
  if (totEl) totEl.innerHTML = spv(fmt(total));
}

// ── STAGE 4: CONFIRM ───────────────────────────────────────────────────────

function cfgRenderConfirm() {
  var h = '';

  // Status banner
  var statusCol = CFG.status === 'Confirmed' ? 'var(--green)' : 'var(--amber)';
  h += '<div style="padding:10px 16px;border-radius:8px;border:2px solid ' + statusCol + ';background:' + statusCol + '22;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between">';
  h += '<span style="font-weight:700;color:' + statusCol + '">Status: ' + esc(CFG.status) + '</span>';
  h += '<div style="display:flex;gap:8px">';
  ['Provisional','Confirmed'].forEach(function(s){
    var active = CFG.status === s;
    h += '<button onclick="cfgSetStatus(\'' + s + '\',this);cfgRenderStage()" style="padding:4px 12px;border-radius:16px;font-size:12px;font-weight:700;cursor:pointer;border:2px solid ' + (active ? statusCol : 'var(--b1)') + ';background:' + (active ? statusCol+'22' : 'transparent') + ';color:' + (active ? statusCol : 'var(--t2)') + '">' + s + '</button>';
  });
  h += '</div></div>';

  // Client + refs
  var clientNum = CFG.clientNum || (CLIENT_NUM_SEQ + 1);
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#E6FFF5">👤</div>';
  h += '<div class="cs-card-title">Client &amp; References</div></div>';
  h += '<div class="cs-body">';
  h += '<div style="font-size:18px;font-weight:800;margin-bottom:6px">' + esc(CFG.clientName) + '</div>';
  if (CFG.clientEmail) h += '<div style="font-size:12px;color:var(--t2)">' + esc(CFG.clientEmail) + '</div>';
  if (CFG.partnerRef) h += '<div style="font-size:12px;color:var(--t2)">Partner ref: ' + esc(CFG.partnerRef) + '</div>';
  h += '<div style="margin-top:10px;display:flex;flex-direction:column;gap:6px">';
  CFG.jobDefs.forEach(function(jd){
    var ref = buildMasterRef(CFG.workCountry, jd.jobTypeCode, clientNum);
    var jt = JOB_TYPES_V2.filter(function(x){ return x.code === jd.jobTypeCode; })[0] || {};
    h += '<div style="font-family:monospace;font-size:13px;font-weight:700;color:var(--blue);padding:5px 10px;background:var(--blt);border-radius:6px;display:inline-block">';
    h += (jt.icon||'') + ' ' + esc(ref);
    h += '</div>';
  });
  h += '</div></div></div>';

  // Jobs summary
  for (var di = 0; di < CFG.jobDefs.length; di++) {
    var jd = CFG.jobDefs[di];
    var jt = JOB_TYPES_V2.filter(function(x){ return x.code === jd.jobTypeCode; })[0] || {};
    var jobRev = (jd.billing||[]).reduce(function(s,b){ return s + (parseFloat(b.amt)||0); }, 0);
    var days = Math.max(1, jd.movements.filter(function(m){ return !!m.date; }).length);
    var overhead = days * (APP_SETTINGS.cosPerCrewPerDay || 125);

    h += '<div class="cs-card" style="border-left:3px solid ' + (jt.accent||'var(--b1)') + '">';
    h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:' + (jt.color||'#f0f0f0') + '">' + (jt.icon||'📋') + '</div>';
    h += '<div style="flex:1"><div class="cs-card-title">' + esc(jt.label||jd.jobTypeCode) + '</div>';
    h += '<div class="cs-card-sub">' + jd.movements.length + ' movement' + (jd.movements.length!==1?'s':'') + ' · ' + (jd.crewDrivers||0) + ' drivers · ' + (jd.crewPorters||0) + ' porters</div></div>';
    h += '<div style="text-align:right"><div style="font-size:16px;font-weight:800;color:var(--blue)">' + spv(fmt(jobRev)) + '</div>';
    h += '<div style="font-size:10px;color:var(--t3)">COS overhead ' + fmt(overhead) + '</div></div>';
    h += '</div>';
    h += '<div class="cs-body" style="padding-top:0">';
    jd.movements.forEach(function(mv, mi){
      var mo = MOVEMENT_MODES.filter(function(x){ return x.key === mv.mode; })[0] || {};
      h += '<div style="display:flex;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid var(--b1);font-size:12px">';
      h += '<span>' + (mo.icon||'📍') + '</span>';
      h += '<span style="font-weight:600">' + esc(mo.label || mv.mode || '—') + '</span>';
      if (mv.date) h += '<span style="color:var(--t2)">' + mv.date + '</span>';
      if (mv.origin) h += '<span style="color:var(--t3)">' + esc(mv.origin.substring(0,30)) + '</span>';
      if (mv.destination) h += '<span style="color:var(--t3)">→ ' + esc(mv.destination.substring(0,30)) + '</span>';
      if (mv.volFt || mv.volCbm) h += '<span style="margin-left:auto;color:var(--t2)">' + esc((mv.volFt||mv.volCbm)+' '+(mv.volUnit==='cbm'?'CBM':'ft³')) + '</span>';
      h += '</div>';
    });
    if (jd.billing && jd.billing.length) {
      h += '<div style="padding-top:8px">';
      jd.billing.forEach(function(bl){
        h += '<div style="display:flex;justify-content:space-between;font-size:12px;padding:2px 0">';
        h += '<span style="color:var(--t2)">' + esc(bl.desc||'—') + '</span>';
        h += '<span style="font-weight:600">' + spv(fmt(parseFloat(bl.amt)||0)) + '</span>';
        h += '</div>';
      });
      h += '</div>';
    }
    h += '</div></div>';
  }

  // Grand totals
  var totalRev = CFG.jobDefs.reduce(function(s,jd){ return s + (jd.billing||[]).reduce(function(s2,b){ return s2+(parseFloat(b.amt)||0); },0); }, 0);
  var totalDays = CFG.jobDefs.reduce(function(s,jd){ return s + Math.max(1, jd.movements.filter(function(m){return !!m.date;}).length); }, 0);
  var totalOverhead = totalDays * (APP_SETTINGS.cosPerCrewPerDay || 125);

  h += '<div style="padding:14px 16px;border-radius:8px;background:var(--s1);border:1px solid var(--b1)">';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">';
  h += '<div><div style="font-size:10px;color:var(--t3);margin-bottom:3px">TOTAL REVENUE</div><div style="font-size:20px;font-weight:800;color:var(--blue)">' + spv(fmt(totalRev)) + '</div></div>';
  h += '<div><div style="font-size:10px;color:var(--t3);margin-bottom:3px">OVERHEAD COS</div><div style="font-size:20px;font-weight:800;color:var(--red)">' + spv(fmt(totalOverhead)) + '</div></div>';
  var margin = totalRev > 0 ? ((totalRev - totalOverhead) / totalRev * 100) : 0;
  h += '<div><div style="font-size:10px;color:var(--t3);margin-bottom:3px">MARGIN (overhead only)</div><div style="font-size:20px;font-weight:800;color:var(--green)">' + spv(margin.toFixed(1) + '%') + '</div></div>';
  h += '</div></div>';

  h += '<div style="margin-top:12px;font-size:11px;color:var(--t3);text-align:center">Saving will publish all jobs to the calendar · Full COS (crew wages, fuel, vehicles) shown in job detail</div>';

  return h;
}

function cfgCollectConfirm() {
  // Status already set via cfgSetStatus
}

// ── COMMIT ─────────────────────────────────────────────────────────────────

function cfgCommit() {
  cfgCollectStage();
  if (!CFG.clientName.trim()) { toast('Client name is required'); cfgGoStage(0); return; }
  if (!CFG.jobDefs[0].jobTypeCode) { toast('Select at least one job type'); cfgGoStage(0); return; }
  if (!CFG.status || CFG.status === 'Draft') CFG.status = 'Provisional';

  // Assign client number if new
  if (!CFG.clientNum) CFG.clientNum = nextClientNum();
  var clientNum = CFG.clientNum;

  // Create or update CLIENT_JOB master record (one per booking session)
  var cj;
  var isEdit = !!CFG._editingCjId;
  if (isEdit) {
    cj = CLIENT_JOBS.filter(function(x){ return x.id === CFG._editingCjId; })[0];
  }
  if (!cj) {
    cj = {
      id: 'CJ-' + Date.now(),
      clientNum: clientNum,
      brand: CFG.brand,
      channel: CFG.channel,
      moveManager: CFG.moveManager || '',
      clientName: CFG.clientName,
      clientEmail: CFG.clientEmail,
      clientPhone: CFG.clientPhone,
      partnerRef: CFG.partnerRef || '',
      workCountry: CFG.workCountry || 'UK',
      status: 'Active',
      notes: CFG.opsNotes || '',
      changeLog: [],
      createdAt: new Date().toISOString(),
      createdBy: window._authUser || 'Unknown',
      linkedCjIds: [],
      jobRefs: [],
      cfgData: null,
      spFolderUrl: '', spFolderId: '', spFolderPath: '', spSiteId: '', spDriveId: '',
      docChecklist: {},
    };
    CLIENT_JOBS.push(cj);
  } else {
    cj.clientName   = CFG.clientName;
    cj.clientEmail  = CFG.clientEmail;
    cj.clientPhone  = CFG.clientPhone;
    cj.partnerRef   = CFG.partnerRef;
    cj.brand        = CFG.brand;
    cj.channel      = CFG.channel;
    cj.moveManager  = CFG.moveManager;
    cj.workCountry  = CFG.workCountry || 'UK';
    cj.updatedAt    = new Date().toISOString();
  }
  cj.cfgData = CFG;

  // Build calendar jobs — one per movement per job def
  var createdJobIds = [];
  cj.jobRefs = [];

  for (var di = 0; di < CFG.jobDefs.length; di++) {
    var jd = CFG.jobDefs[di];
    var masterRef = buildMasterRef(CFG.workCountry, jd.jobTypeCode, clientNum);
    jd.masterRef = masterRef;
    cj.jobRefs.push(masterRef);

    // Resolve vehicle regs from IDs
    var vehRegs = (jd.vehicleIds || []).map(function(vid){
      var v = VEHICLES.filter(function(x){ return (x.id||x.reg) === vid; })[0];
      return v ? (v.reg || v.name) : vid;
    }).filter(Boolean);

    for (var mi = 0; mi < jd.movements.length; mi++) {
      var mv = jd.movements[mi];
      if (!mv.date && !mv.mode) continue; // skip empty movements

      var jobId = 'BK' + Date.now() + '_' + di + '_' + mi;
      var movRef = masterRef + '-' + String(mi + 1).padStart(2, '0');

      var vol = parseFloat(mv.volFt) || 0;
      var cbm = parseFloat(mv.volCbm) || (vol ? parseFloat((vol/35.315).toFixed(2)) : 0);

      var newJob = {
        id: jobId,
        ref: movRef,
        masterRef: masterRef,
        clientJobId: cj.id,
        brand: CFG.brand,
        channel: CFG.channel,
        jobType: jd.jobTypeCode,
        moveManager: CFG.moveManager || '',
        client: CFG.clientName,
        origin: mv.mode === 'warehouse-out' ? ('EX STORE' + (mv.storageRecordId ? ' [' + mv.storageRecordId + ']' : '')) : (mv.origin || ''),
        dest: mv.mode === 'warehouse-in' ? (APP_SETTINGS.warehouseAddress || 'INT STORE') : (mv.destination || ''),
        start: mv.date || '',
        end: mv.date || '',
        vol: vol,
        cbm: cbm,
        drivers: [],   // names assigned later
        porters: [],
        crewDriversNeeded: jd.crewDrivers || 1,
        crewPortersNeeded: jd.crewPorters || 2,
        mileage: 0,
        veh: vehRegs,
        status: CFG.status === 'Confirmed' ? 'Scheduled' : 'Provisional',
        billing: di === 0 && mi === 0 ? (jd.billing || []) : [],
        notes: mv.notes || '',
        movementMode: mv.mode || '',
        svcs: mv.svcs || {},
        access: {
          smallVehicle: mv.smallVehicle || false,
          tightAccess: mv.tightAccess || false,
          shuttle: mv.shuttle || false,
          parkingSuspension: mv.parkingSuspension || false,
          permit: mv.permit || false,
        },
        storageId: mv.storageRecordId || '',
        journeyId: '',
        seqInDay: mi + 1,
      };

      // Storage handling
      if (mv.storageRecordId) {
        if (mv.mode === 'warehouse-in') {
          var ts = new Date().toISOString();
          if (mv.storageIsNew) {
            var newStoId = 'S' + String(100 + storageSeq++).slice(-3);
            STORAGE_RECORDS.push({
              id: newStoId, type: 'longterm', client: CFG.clientName, brand: CFG.brand,
              volFt: vol, cbm: cbm, volRemaining: vol,
              dateIn: mv.date || ts.slice(0,10), dateOut: '',
              status: CFG.status === 'Confirmed' ? 'active' : 'pending',
              billingType: 'monthly', billingRate: 85, billingUnit: 'cbm',
              inboundJobId: jobId, outboundJobId: '', containers: [], notes: 'Created from booking ' + masterRef,
              billingHistory: [], accessLog: [{ ts:ts, date:mv.date, type:'inbound', note:'Inbound — job ' + movRef, volChange:vol }]
            });
            newJob.storageId = newStoId;
          } else if (mv.storageRecordId) {
            newJob.storageId = mv.storageRecordId;
          }
        }
        if (mv.mode === 'warehouse-out' && mv.storageRecordId) {
          var outRec = STORAGE_RECORDS.filter(function(s){ return s.id === mv.storageRecordId; })[0];
          if (outRec && CFG.status !== 'Provisional') {
            outRec.accessLog = outRec.accessLog || [];
            outRec.accessLog.push({ ts:new Date().toISOString(), date:mv.date, type:'outbound', note:'Outbound — job ' + movRef, volChange:-vol });
          }
          newJob.storageId = mv.storageRecordId;
        }
      }

      // Always push — no Draft filtering
      jobs = jobs.filter(function(j){ return j.id !== jobId; });
      jobs.push(newJob);
      createdJobIds.push(jobId);
    }
  }

  // Save client job
  cj.updatedAt = new Date().toISOString();
  saveData('clientjob', cj.id, cj);

  // Save all jobs
  for (var ci = 0; ci < jobs.length; ci++) {
    if (createdJobIds.indexOf(jobs[ci].id) >= 0) {
      saveData('job', jobs[ci].id, jobs[ci]);
    }
  }

  // Close and refresh
  var refs = cj.jobRefs.join(', ');
  CFG._editingCjId = CFG._editingCjId || cj.id;
  closeConfigurator();
  renderCal();
  if (curMod === 'bookings') renderClientJobsList();
  renderBkList();
  toast('✅ ' + createdJobIds.length + ' movement' + (createdJobIds.length!==1?'s':'') + ' saved — ' + refs);

  // Auto-send confirmation + sync contacts
  setTimeout(function(){
    sendJobConfirmationEmail(cj.id, { resend: false });
    syncJobContacts(cj);
  }, 1500);

  // Auto mileage
  setTimeout(function(){
    for (var _mi = 0; _mi < createdJobIds.length; _mi++) {
      var _mj = jobs.filter(function(j){ return j.id === createdJobIds[_mi]; })[0];
      if (_mj && _mj.origin && _mj.dest && !_mj.mileage) {
        autoCalcMileage(_mj, function(miles){ if (miles) console.log('Mileage auto-set:', miles, 'mi'); });
      }
    }
  }, 2000);
}

// ── HELPERS ────────────────────────────────────────────────────────────────

function newClientRecord() {
  openConfigurator(null);
}

function cfgSaveDraft() {
  // Draft removed — save as Provisional instead
  cfgCollectStage();
  CFG.status = 'Provisional';
  cfgCommit();
}

function cfgField(label, id, val, type, placeholder) {
  var h = '<div class="cfg-field">';
  h += '<label class="cfg-label">' + label + '</label>';
  h += '<input class="cfg-input" id="' + id + '" type="' + (type||'text') + '" value="' + esc(val||'') + '" placeholder="' + esc(placeholder||'') + '">';
  h += '</div>';
  return h;
}

function cfgParseEmail() {
  cfgCollectStage();
  var text = (el('cfg-email-paste')||{}).value || '';
  if (!text.trim()) { toast('Paste some text first'); return; }
  var btn = el('cfg-parse-btn');
  if (btn) btn.textContent = '⏳ Extracting…';

  var prompt = 'Extract booking details from the following text. Return ONLY a JSON object with these keys: clientName, clientEmail, clientPhone, partnerRef, brand, moveManager, jobType (one of: D2D,SEA,AIR,DOM,COM,HAN,WHS), startDate (YYYY-MM-DD), origin, destination, volFt, notes. Use null for missing fields.\n\nText:\n' + text.substring(0, 3000);

  fetch('/api/claude', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ model:'claude-sonnet-4-6', max_tokens:800, messages:[{role:'user',content:prompt}] })
  }).then(function(r){ return r.json(); }).then(function(data){
    try {
      var raw = ((data.content||[])[0]||{}).text || '';
      var clean = raw.replace(/```json|```/g,'').trim();
      var parsed = JSON.parse(clean);
      if (parsed.clientName) CFG.clientName = parsed.clientName;
      if (parsed.clientEmail) CFG.clientEmail = parsed.clientEmail;
      if (parsed.clientPhone) CFG.clientPhone = parsed.clientPhone;
      if (parsed.partnerRef) CFG.partnerRef = parsed.partnerRef;
      if (parsed.startDate && CFG.jobDefs[0].movements[0]) CFG.jobDefs[0].movements[0].date = parsed.startDate;
      if (parsed.origin && CFG.jobDefs[0].movements[0]) CFG.jobDefs[0].movements[0].origin = parsed.origin;
      if (parsed.destination && CFG.jobDefs[0].movements[0]) CFG.jobDefs[0].movements[0].destination = parsed.destination;
      if (parsed.volFt && CFG.jobDefs[0].movements[0]) CFG.jobDefs[0].movements[0].volFt = parsed.volFt;
      if (parsed.jobType) {
        var code = parsed.jobType.toUpperCase();
        if (JOB_TYPES_V2.some(function(j){ return j.code === code; })) {
          CFG.jobDefs[0].jobTypeCode = code;
        }
      }
      CFG.aiParsed = parsed;
      toast('✅ Details extracted — review and continue');
      cfgRenderStage();
    } catch(e) { toast('Could not parse response — fill in manually'); }
  }).catch(function(){ toast('AI parsing failed — fill in manually'); })
  .finally(function(){ if (btn) btn.textContent = '✓ Extract Details'; });
}


// ══════════════════════════════════════════════════════════════════════════
// AZURE TABLE STORAGE DATA LAYER
// All data persisted via /api/data Azure Function → Azure Table Storage
// ══════════════════════════════════════════════════════════════════════════

var API_BASE   = '/api/data';
var DB_READY   = false;
var DB_OFFLINE = false;

// ── LOCAL STORAGE FALLBACK ───────────────────────────────────────────────
var STORAGE_KEY = 'opsmanager_v1';

function lsSave() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      jobs:jobs, JOURNEYS:JOURNEYS, STORAGE_RECORDS:STORAGE_RECORDS,
      WH_ACTIVITIES:WH_ACTIVITIES, bookings:bookings,
      CLIENT_JOBS:CLIENT_JOBS,
      CREW:CREW, HOL:HOL, VEHICLES:VEHICLES, MATERIALS:MATERIALS,
      CHARGES:CHARGES, MOVE_MANAGERS:MOVE_MANAGERS, BRAND_DATA:BRAND_DATA,
      SL_CONFIG:SL_CONFIG, APP_SETTINGS:APP_SETTINGS, WAREHOUSES:WAREHOUSES,
      _saved: new Date().toISOString()
    }));
  } catch(e) {}
}

function lsLoad() {
  try {
    var raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    var d = JSON.parse(raw);
    if (d.jobs)            jobs            = d.jobs;
    if (d.JOURNEYS)        JOURNEYS        = d.JOURNEYS;
    if (d.STORAGE_RECORDS) STORAGE_RECORDS = d.STORAGE_RECORDS;
    if (d.WH_ACTIVITIES)   WH_ACTIVITIES   = d.WH_ACTIVITIES;
    if (d.bookings)        bookings        = d.bookings;
    if (d.CLIENT_JOBS)     CLIENT_JOBS     = d.CLIENT_JOBS;
    if (d.WAREHOUSES)      WAREHOUSES      = d.WAREHOUSES;
    if (d.CREW)            CREW            = d.CREW;
    if (d.HOL)             HOL             = d.HOL;
    if (d.VEHICLES)        VEHICLES        = d.VEHICLES;
    if (d.MATERIALS)       MATERIALS       = d.MATERIALS;
    if (d.CHARGES)         CHARGES         = d.CHARGES;
    if (d.MOVE_MANAGERS)   MOVE_MANAGERS   = d.MOVE_MANAGERS;
    if (d.BRAND_DATA)      { BRAND_DATA = d.BRAND_DATA; BC = {}; BRAND_DATA.forEach(function(b){ BC[b.name]=b.color; }); }
    if (d.SL_CONFIG)       SL_CONFIG       = d.SL_CONFIG;
    if (d.APP_SETTINGS)    APP_SETTINGS    = d.APP_SETTINGS;
    return true;
  } catch(e) { return false; }
}

// ── AZURE TABLE STORAGE API HELPERS ─────────────────────────────────────

function apiGet(table, cb) {
  fetch(API_BASE + '?table=' + table, {
    credentials: 'include'
  })
  .then(function(r) {
    if (!r.ok) throw new Error('API error: ' + r.status);
    return r.json();
  })
  .then(function(items) { cb(null, items); })
  .catch(function(e) { cb(e, []); });
}

function apiPost(table, item, cb) {
  fetch(API_BASE + '?table=' + table, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify(item)
  })
  .then(function(r) {
    if (!r.ok) throw new Error('API error: ' + r.status);
    return r.json();
  })
  .then(function(d) { if(cb) cb(null, d); })
  .catch(function(e) { if(cb) cb(e); });
}

function apiDelete(table, id, cb) {
  fetch(API_BASE + '?table=' + table + '&id=' + encodeURIComponent(id), {
    method: 'DELETE',
    credentials: 'include'
  })
  .then(function(r) {
    if (!r.ok) throw new Error('API error: ' + r.status);
    return r.json();
  })
  .then(function(d) { if(cb) cb(null, d); })
  .catch(function(e) { if(cb) cb(e); });
}

// ── TABLE NAME MAP ───────────────────────────────────────────────────────
var TABLE_MAP = {
  job:        'OpsJobs',
  journey:    'OpsJourneys',
  storage:    'OpsStorage',
  booking:    'OpsBookings',
  survey:     'OpsSurveys',
  wh:         'OpsWHActivities',
  settings:   'OpsSettings',
  clientjob:  'OpsClientJobs',
  media:      'OpsMedia'
};

// ── LOAD ALL DATA FROM AZURE ─────────────────────────────────────────────
function dbInit(cb) {
  // Identify logged-in user via Azure SWA built-in auth
  fetch('/.auth/me', { credentials: 'include' })
    .then(function(r){ return r.ok ? r.json() : null; })
    .then(function(data) {
      var principal = data && data.clientPrincipal;
      if (principal) {
        window._authUser     = principal.userDetails || principal.userId || 'Unknown';
        window._authEmail    = (principal.userDetails||'').toLowerCase();
        window._authName     = principal.userDetails || 'User';
        // Update sidebar display
        updateSidebarUser(window._authName, principal.identityProvider || 'Microsoft');
        // Check if driver/porter — lock to driver view
        checkDriverLock();
      }
    })
    .catch(function(){}) // auth endpoint may not exist in dev
    .finally(function() {
      _doDbInit(cb);
    });
}

function _doDbInit(cb) {
  // Check API is reachable
  fetch(API_BASE + '?table=OpsJobs', { credentials: 'include' })
  .then(function(r) {
    if (!r.ok) throw new Error('API unreachable: ' + r.status);
    return r.json();
  })
  .then(function(items) {
    DB_READY = true;

    // Parse items helper
    function parse(items) {
      return items.map(function(item) {
        try { return JSON.parse(item.data); } catch(e) { return null; }
      }).filter(Boolean);
    }

    // Load all tables in parallel
    var loaded = 0;
    var total  = 9;

    function done() {
      if (++loaded < total) return;
      lsSave(); // mirror to localStorage as offline backup
      if(cb) cb(null);
    }

    // Jobs
    if (items.length) jobs = parse(items);
    done(); // jobs already loaded from first check

    apiGet('OpsJourneys', function(err, r) {
      if (!err && r.length) JOURNEYS = parse(r);
      done();
    });
    apiGet('OpsStorage', function(err, r) {
      if (!err && r.length) STORAGE_RECORDS = parse(r);
      done();
    });
    apiGet('OpsBookings', function(err, r) {
      if (!err && r.length) bookings = parse(r);
      done();
    });
    apiGet('OpsWHActivities', function(err, r) {
      if (!err && r.length) WH_ACTIVITIES = parse(r);
      done();
    });
    apiGet('OpsSurveys', function(err, r) {
      if (!err && r.length) SURVEYS = parse(r);
      done();
    });
    apiGet('OpsClientJobs', function(err, r) {
      if (!err && r.length) {
      CLIENT_JOBS = parse(r);
      // Patch missing fields on legacy records
      CLIENT_JOBS.forEach(function(cj) {
        if (!cj.partnerRef)      cj.partnerRef      = cj.clientRef || '';
        if (!cj.spFolderUrl)     cj.spFolderUrl     = '';
        if (!cj.spFolderId)      cj.spFolderId      = '';
        if (!cj.spFolderPath)    cj.spFolderPath    = '';
        if (!cj.spSiteId)        cj.spSiteId        = '';
        if (!cj.spDriveId)       cj.spDriveId       = '';
        if (!cj.docChecklist)    cj.docChecklist    = {};
        if (!cj.appenateTaskIds) cj.appenateTaskIds = [];
      });
    }
      done();
    });
    apiGet('OpsMedia', function(err, r) {
      if (!err && r.length) {
        parse(r).forEach(function(m) {
          if (m.type === 'brand_logo') {
            for (var bi2 = 0; bi2 < BRAND_DATA.length; bi2++) {
              if (BRAND_DATA[bi2].name === m.key) { BRAND_DATA[bi2].logo = m.data; break; }
            }
          } else if (m.type === 'crew_photo') {
            for (var ci2 = 0; ci2 < CREW.length; ci2++) {
              if (CREW[ci2].id === m.key || CREW[ci2].name === m.key) { CREW[ci2].photo = m.data; break; }
            }
          }
        });
        buildBrandMaps();
      }
      done();
    });
    apiGet('OpsSettings', function(err, r) {
      if (!err && r.length) {
        var s = parse(r)[0];
        if (s) {
          if (s.CREW)         CREW         = s.CREW;
          if (s.HOL)          HOL          = s.HOL;
          if (s.VEHICLES)     VEHICLES     = s.VEHICLES;
          if (s.MATERIALS)    MATERIALS    = s.MATERIALS;
          if (s.CHARGES)      CHARGES      = s.CHARGES;
          if (s.MOVE_MANAGERS) MOVE_MANAGERS = s.MOVE_MANAGERS;
          if (s.BRAND_DATA)   {
            BRAND_DATA = s.BRAND_DATA;
            // Patch: merge in spFolder defaults from hardcoded list for any brand missing it
            var SP_FOLDER_DEFAULTS = {
              'SIRVA':'SIRVA','EMS':'EMS','STERLING':'Sterling Lexicon',
              'DOREE BONNER':'Doree Bonner','BTR':'BTR','JOHN MASON':'John Mason',
              'BAXTERS':'Baxters','SOLARIS':'Solaris','GOSSELIN':'Gosselin',
              'CROWN WORKSPACE':'Crown Workspace','CROWN':'Crown',
              'BRADSHAW':'Bradshaw International',"BISHOP'S MOVE":"Bishop's Move",
              'WBC':'WBC (Warrington Borough Council)'
            };
            BRAND_DATA.forEach(function(b) {
              if (!b.spFolder && SP_FOLDER_DEFAULTS[b.name]) b.spFolder = SP_FOLDER_DEFAULTS[b.name];
              // Fix legacy b.color → b.col
              if (!b.col && b.color) b.col = b.color;
            });
            buildBrandMaps();
          }
          if (s.SL_CONFIG)    SL_CONFIG    = s.SL_CONFIG;
          if (s.APP_SETTINGS) {
            APP_SETTINGS = s.APP_SETTINGS;
            if (APP_SETTINGS.dismissedAlerts) dismissedAlerts = APP_SETTINGS.dismissedAlerts;
            if (APP_SETTINGS.googleMapsKey) loadGoogleMapsAPI();
            if (APP_SETTINGS.jobCounter) JOB_COUNTER = APP_SETTINGS.jobCounter;
          }
          if (s.WAREHOUSES && s.WAREHOUSES.length) WAREHOUSES = s.WAREHOUSES;
        }
      }
      done();
    });
  })
  .catch(function(e) {
    DB_OFFLINE = true;
    console.warn('Azure API unreachable, using localStorage:', e.message);
    lsLoad();
    if(cb) cb(null);
  });
}

// ── UNIFIED SAVE ─────────────────────────────────────────────────────────
function saveData(type, id, obj) {
  lsSave(); // always mirror to localStorage instantly

  if (DB_OFFLINE || !DB_READY) return;
  if (!type) return;

  if (type === 'clientjob') {
    if (!id || !obj) return;
    apiPost(TABLE_MAP.clientjob, obj);
    return;
  }
  if (type === 'media') {
    if (!id || !obj) return;
    apiPost(TABLE_MAP.media, obj);
    return;
  }

  if (type === 'settings') {
    var settings = {
      id: 'APP_SETTINGS_V1',
      CREW:CREW, HOL:HOL, VEHICLES:VEHICLES, MATERIALS:MATERIALS,
      CHARGES:CHARGES, MOVE_MANAGERS:MOVE_MANAGERS, BRAND_DATA:BRAND_DATA,
      SL_CONFIG:SL_CONFIG, APP_SETTINGS:APP_SETTINGS,
      WAREHOUSES:WAREHOUSES
    };
    apiPost(TABLE_MAP.settings, settings);
    return;
  }

  var table = TABLE_MAP[type];
  if (!table || !id || !obj) return;
  apiPost(table, obj);
}

function deleteData(type, id) {
  lsSave();
  if (DB_OFFLINE || !DB_READY || !type || !id) return;
  var table = TABLE_MAP[type];
  if (!table) return;
  apiDelete(table, id);
}

// ── EXPORT / IMPORT BACKUP ───────────────────────────────────────────────
function exportDataBackup() {
  try {
    var payload = {
      jobs:jobs, JOURNEYS:JOURNEYS, STORAGE_RECORDS:STORAGE_RECORDS,
      WH_ACTIVITIES:WH_ACTIVITIES, bookings:bookings, CREW:CREW, HOL:HOL,
      VEHICLES:VEHICLES, MATERIALS:MATERIALS, CHARGES:CHARGES,
      MOVE_MANAGERS:MOVE_MANAGERS, BRAND_DATA:BRAND_DATA,
      SL_CONFIG:SL_CONFIG, APP_SETTINGS:APP_SETTINGS,
      _exported: new Date().toISOString(), _version: 'v1'
    };
    var blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'opsmanager-backup-' + new Date().toISOString().substring(0,10) + '.json';
    a.click();
    toast('Backup exported');
  } catch(e) { toast('Export failed: ' + e.message); }
}

function importDataBackup() {
  var inp = document.createElement('input');
  inp.type = 'file'; inp.accept = '.json,application/json';
  inp.onchange = function() {
    var file = inp.files[0]; if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
      try {
        var d = JSON.parse(ev.target.result);
        if (!d.jobs) { toast('Invalid backup file'); return; }
        if (!confirm('Import will replace ALL current data. Continue?')) return;
        if (d.jobs)            jobs            = d.jobs;
        if (d.JOURNEYS)        JOURNEYS        = d.JOURNEYS;
        if (d.STORAGE_RECORDS) STORAGE_RECORDS = d.STORAGE_RECORDS;
        if (d.WH_ACTIVITIES)   WH_ACTIVITIES   = d.WH_ACTIVITIES;
        if (d.bookings)        bookings        = d.bookings;
    if (d.CLIENT_JOBS)     CLIENT_JOBS     = d.CLIENT_JOBS;
    if (d.WAREHOUSES)      WAREHOUSES      = d.WAREHOUSES;
        if (d.CREW)            CREW            = d.CREW;
        if (d.HOL)             HOL             = d.HOL;
        if (d.VEHICLES)        VEHICLES        = d.VEHICLES;
        if (d.MATERIALS)       MATERIALS       = d.MATERIALS;
        if (d.CHARGES)         CHARGES         = d.CHARGES;
        if (d.MOVE_MANAGERS)   MOVE_MANAGERS   = d.MOVE_MANAGERS;
        if (d.BRAND_DATA)      { BRAND_DATA = d.BRAND_DATA; BC = {}; BRAND_DATA.forEach(function(b){ BC[b.name]=b.color; }); }
        if (d.SL_CONFIG)       SL_CONFIG       = d.SL_CONFIG;
        if (d.APP_SETTINGS)    APP_SETTINGS    = d.APP_SETTINGS;
        lsSave();
        if (DB_READY && !DB_OFFLINE) {
          toast('Importing to Azure...');
          var all = jobs.concat(JOURNEYS).concat(STORAGE_RECORDS).concat(bookings).concat(WH_ACTIVITIES);
          var typeMap = {};
          jobs.forEach(function(x){ typeMap[x.id]='job'; });
          JOURNEYS.forEach(function(x){ typeMap[x.id]='journey'; });
          STORAGE_RECORDS.forEach(function(x){ typeMap[x.id]='storage'; });
          bookings.forEach(function(x){ typeMap[x.id]='booking'; });
          WH_ACTIVITIES.forEach(function(x){ typeMap[x.id]='wh'; });
          all.forEach(function(item){ saveData(typeMap[item.id], item.id, item); });
          saveData('settings');
          setTimeout(function(){ toast('Import complete ✓'); renderCal(); }, 1500);
        } else {
          toast('Import complete ✓ (offline mode)');
          renderCal();
        }
      } catch(e) { toast('Import failed: ' + e.message); }
    };
    reader.readAsText(file);
  };
  inp.click();
}

function importOPSPlan() {
  var inp = document.createElement('input');
  inp.type = 'file'; inp.accept = '.csv,text/csv';
  inp.onchange = function() {
    var file = inp.files[0]; if (!file) return;
    var status = document.getElementById('csv-import-status');
    if (status) status.textContent = 'Reading file...';
    var reader = new FileReader();
    reader.onload = function(ev) {
      try {
        var text = ev.target.result;
        var parsed = parseOPSPlanCSV(text);
        if (!parsed.length) { toast('No jobs found in file'); if(status) status.textContent = 'No jobs found.'; return; }
        if (!confirm('Import ' + parsed.length + ' jobs from OPS Plan?\n\nExisting jobs with matching refs will be skipped.')) return;

        // Check for duplicates
        var existingRefs = {};
        for (var i = 0; i < jobs.length; i++) existingRefs[jobs[i].ref] = true;

        var added = 0, skipped = 0;
        for (var j = 0; j < parsed.length; j++) {
          var job = parsed[j];
          if (existingRefs[job.ref]) { skipped++; continue; }
          // Generate unique ID
          job.id = 'IMP' + Date.now() + '_' + j;
          jobs.push(job);
          saveData('job', job.id, job);
          added++;
        }

        setBadge('job-badge', jobs.length);
        renderCal();
        var msg = added + ' jobs imported' + (skipped ? ', ' + skipped + ' skipped (duplicate refs)' : '') + ' ✓';
        toast(msg);
        if (status) status.textContent = msg;
      } catch(e) {
        toast('Import failed: ' + e.message);
        if (status) status.textContent = 'Error: ' + e.message;
      }
    };
    reader.readAsText(file, 'latin1');
  };
  inp.click();
}

function parseOPSPlanCSV(text) {
  // Parse the weekly OPS Plan CSV format
  var lines = text.split('\n');
  var jobs = [];
  var currentDate = null;
  var seqOnDay = {};

  function cleanMoney(v) {
    if (!v) return 0;
    v = String(v).replace(/[£,"]/g,'').trim();
    return parseFloat(v) || 0;
  }

  function parseDate(header) {
    var months = {JANUARY:'01',FEBRUARY:'02',MARCH:'03',APRIL:'04',MAY:'05',JUNE:'06',
                  JULY:'07',AUGUST:'08',SEPTEMBER:'09',OCTOBER:'10',NOVEMBER:'11',DECEMBER:'12'};
    var m = header.toUpperCase().match(/(\d+)(?:ST|ND|RD|TH)?\s+(\w+)(?:\s+(\d{4}))?/);
    if (!m) return null;
    var day = m[1].padStart(2,'0');
    var mon = months[m[2]] || '01';
    var yr  = m[3] || '2025';
    return yr + '-' + mon + '-' + day;
  }

  function parseCSVLine(line) {
    var result = [], current = '', inQuotes = false;
    for (var i = 0; i < line.length; i++) {
      var c = line[i];
      if (c === '"') { inQuotes = !inQuotes; }
      else if (c === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
      else { current += c; }
    }
    result.push(current.trim());
    return result;
  }

  function parseCrew(s) {
    if (!s) return [];
    return s.split(/[,\/&]/).map(function(x){ return x.replace(/£\d+/,'').trim().toUpperCase(); }).filter(Boolean);
  }

  for (var li = 0; li < lines.length; li++) {
    var row = parseCSVLine(lines[li]);
    while (row.length < 65) row.push('');

    // Day header
    if (row[1] && row[1].toUpperCase().indexOf('OPS PLAN') >= 0) {
      currentDate = parseDate(row[1]);
      continue;
    }
    // Skip header/summary/empty rows
    if (!row[1] || !row[2]) continue;
    if (row[0] === 'SERVICE' || row[0] === 'TOTALS') continue;

    var brand  = row[1].trim();
    var client = row[2].trim();
    if (!brand || !client) continue;

    // Skip non-job rows
    var skip = ['WAREHOUSE','DAYLE OFF','MARTYN 2PM','SKYPE','OCVS DROP','ANYVAN','DAYLE OFF'];
    var isSkip = false;
    for (var si = 0; si < skip.length; si++) {
      if (client.toUpperCase().indexOf(skip[si]) >= 0) { isSkip = true; break; }
    }
    if (isSkip) continue;

    var origin   = row[3].trim();
    var dest     = row[4].trim();
    var volCbft  = parseFloat(row[5]) || 0;
    var vehicles = row[9].trim();
    var drivers  = parseCrew(row[10]);
    var porters  = parseCrew(row[11]);
    var ref      = row[14].trim();
    var cbm      = parseFloat(row[15]) || Math.round(volCbft * 0.02832 * 100) / 100;
    var moveMgr  = row[16].trim();
    var miles    = parseFloat(row[17]) || 0;

    // Billing pairs cols 29-50
    var billing = [];
    for (var bc = 29; bc <= 49; bc += 2) {
      var item = row[bc] ? row[bc].trim() : '';
      var amt  = cleanMoney(row[bc+1]);
      if (item && amt > 0) billing.push({ item: item, amt: amt });
    }

    var total  = cleanMoney(row[52]) || cleanMoney(row[62]) || billing.reduce(function(s,b){ return s+b.amt; }, 0);
    var margin = row[63] ? row[63].replace('%','').trim() : '';

    var status = 'Completed';
    if (total > 0 && margin === '100') status = 'Billed';
    else if (total > 0) status = 'Billed';

    var channel  = (brand==='MOVESQUAD'||brand==='BTR'||brand==='ECKERSLEYS') ? 'Account' : 'Partner';
    var jobType  = 'Door to Door';
    if (origin.toUpperCase().indexOf('STORE') >= 0 && dest.toUpperCase().indexOf('STORE') < 0) jobType = 'Delivery';
    else if (dest.toUpperCase().indexOf('STORE') >= 0) jobType = 'Collection';
    if (origin.toUpperCase().indexOf('CONTAINER') >= 0 || origin.toUpperCase().indexOf('ACCESSING') >= 0) jobType = 'Other';

    var ds = currentDate || '2025-01-01';
    seqOnDay[ds] = (seqOnDay[ds] || 0) + 1;

    jobs.push({
      id:          '', // set on import
      ref:         ref || ('IMP-' + brand + '-' + client.substring(0,10)).replace(/\s+/g,'-'),
      brand:       brand,
      channel:     channel,
      jobType:     jobType,
      clientRef:   '',
      moveManager: moveMgr,
      client:      client,
      origin:      origin,
      dest:        dest,
      start:       ds,
      end:         ds,
      vol:         volCbft,
      cbm:         cbm,
      drivers:     drivers,
      porters:     porters,
      mileage:     miles,
      veh:         vehicles ? vehicles.split(',').map(function(v){ return v.trim(); }).filter(Boolean) : [],
      status:      status,
      billing:     billing,
      notes:       '',
      journeyId:   '',
      storageId:   '',
      seqInDay:    seqOnDay[ds],
      materials:   []
    });
  }
  return jobs;
}

function quickStatusMenu(e, jobId) {
  e.preventDefault();
  e.stopPropagation();
  // Remove any existing menu
  var ex = document.getElementById('ctx-menu');
  if (ex) ex.parentNode.removeChild(ex);

  var statuses = [
    {label:'Pending',     col:'#FF9F00'},
    {label:'Confirmed',   col:'#0073EA'},
    {label:'In Progress', col:'#A25DDC'},
    {label:'Completed',   col:'#00C875'},
    {label:'Billed',      col:'#00C875'},
    {label:'Cancelled',   col:'#E44258'},
  ];

  var menu = document.createElement('div');
  menu.id = 'ctx-menu';
  menu.className = 'ctx-menu';
  menu.style.left = Math.min(e.clientX, window.innerWidth - 180) + 'px';
  menu.style.top  = Math.min(e.clientY, window.innerHeight - 220) + 'px';

  var j = jobs.filter(function(x){ return x.id === jobId; })[0];
  if (!j) return;

  // Header
  var hdr = document.createElement('div');
  hdr.style.cssText = 'padding:6px 14px 4px;font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--b1);margin-bottom:4px';
  hdr.textContent = 'Set Status';
  menu.appendChild(hdr);

  statuses.forEach(function(s) {
    var item = document.createElement('div');
    item.className = 'ctx-item';
    if (j.status === s.label) item.style.fontWeight = '700';
    item.innerHTML = '<div class="ctx-dot" style="background:'+s.col+'"></div>' + s.label +
      (j.status === s.label ? ' <span style="margin-left:auto;color:var(--green)">✓</span>' : '');
    item.onclick = function() {
      j.status = s.label;
      saveData('job', j.id, j);
      closeCtxMenu();
      renderActiveMod();
      toast(j.client + ' → ' + s.label);
    };
    menu.appendChild(item);
  });

  document.body.appendChild(menu);
  setTimeout(function(){ document.addEventListener('click', closeCtxMenu, {once:true}); }, 10);
}

function closeCtxMenu() {
  var m = document.getElementById('ctx-menu');
  if (m) m.parentNode.removeChild(m);
}

function clearData() {
  if (!confirm('Reset ALL data to factory defaults?\n\nThis will clear local storage AND Azure database. Cannot be undone.')) return;
  localStorage.removeItem(STORAGE_KEY);
  if (DB_READY && !DB_OFFLINE) {
    toast('Clearing database...');
    var tables = ['OpsJobs','OpsJourneys','OpsStorage','OpsBookings','OpsWHActivities','OpsSettings'];
    tables.forEach(function(table) {
      apiGet(table, function(err, items) {
        if (err || !items.length) return;
        items.forEach(function(item) { apiDelete(table, item.rowKey || item.id); });
      });
    });
    setTimeout(function(){ location.reload(); }, 2000);
  } else {
    location.reload();
  }
}

// ── STARTUP ──────────────────────────────────────────────────────────────
(function() {
  var overlay = document.createElement('div');
  overlay.id = 'db-loading';
  overlay.innerHTML = '<div style="text-align:center"><div style="font-size:32px;margin-bottom:12px">📦</div><div style="font-weight:700;font-size:15px;color:#1C2333;margin-bottom:6px">Loading OPS Manager</div><div style="font-size:12px;color:#7A849E">Connecting to database...</div></div>';
  overlay.style.cssText = 'position:fixed;inset:0;background:#f9ecec;display:flex;align-items:center;justify-content:center;z-index:99999;font-family:Inter,sans-serif';
  document.body.appendChild(overlay);

  dbInit(function() {
    var el2 = document.getElementById('db-loading');
    if (el2) el2.parentNode.removeChild(el2);

    // Inject version badge into settings sidebar
    var vb = document.getElementById('app-version-badge');
    if (vb) vb.textContent = APP_VERSION;

    renderDashboard();
    renderBkList();
    setBadge('job-badge', jobs.length);
    // Re-check driver lock now that CREW data is loaded
    if (window._authEmail) checkDriverLock();
    // Set greeting even if no auth (dev/fallback)
    if (!window._authName) updateGreeting('');

    if (DB_READY && !DB_OFFLINE) {
      setTimeout(function(){ toast('Connected ✓'); }, 400);
    } else {
      setTimeout(function(){ toast('Offline mode — local data only'); }, 400);
    }
  });
})();

// Belt-and-suspenders: save to localStorage on unload
window.addEventListener('beforeunload', lsSave);




// DRIVER VIEW
var _isDriverView = false;

function checkDriverLock() {
  var email = (window._authEmail || '').toLowerCase().trim();
  if (!email) return;
  var crewMember = null;
  for (var i = 0; i < CREW.length; i++) {
    if ((CREW[i].email || '').toLowerCase().trim() === email) { crewMember = CREW[i]; break; }
  }
  if (!crewMember) return;
  var role = (crewMember.role || '').toLowerCase();
  if (role.indexOf('driver') >= 0 || role.indexOf('porter') >= 0) {
    _isDriverView = true;
    window._driverName = crewMember.name;
    activateDriverView();
  }
}

function activateDriverView() {
  var sb = document.querySelector('.sidebar');
  var mn = document.querySelector('.main');
  if (sb) sb.style.display = 'none';
  if (mn) mn.style.display = 'none';
  el('driver-view').style.display = 'block';
  document.addEventListener('keydown', function(e) {
    if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) e.preventDefault();
  });
  renderDriverView();
}

function renderDriverView() {
  var name  = window._driverName || 'Driver';
  var today = d2s(new Date());
  var days  = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  var months= ['January','February','March','April','May','June','July','August','September','October','November','December'];
  var now   = new Date();
  el('dv-name').textContent = name;
  el('dv-date').textContent = days[now.getDay()] + ' ' + now.getDate() + ' ' + months[now.getMonth()] + ' ' + now.getFullYear();

  var myJobs = jobs.filter(function(j) {
    var crew = (j.drivers||[]).concat(j.porters||[]);
    return crew.indexOf(name) >= 0 && jobDates(j).indexOf(today) >= 0;
  });
  el('dv-job-count').textContent = myJobs.length + ' job' + (myJobs.length !== 1 ? 's' : '') + ' today';

  if (!myJobs.length) { el('dv-jobs').innerHTML = ''; el('dv-empty').style.display = 'block'; return; }
  el('dv-empty').style.display = 'none';

  var h = '';
  myJobs.forEach(function(j) {
    var brandCol = BC[j.brand] || '#0073EA';
    var isDone   = j.status === 'Completed' || j.status === 'Billed';
    var vol      = j.vol ? j.vol + ' ft³' : (j.cbm ? j.cbm + ' cbm' : '');
    h += '<div style="background:#fff;border-radius:12px;margin-bottom:14px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.08)">';
    h += '<div style="height:5px;background:'+brandCol+'"></div>';
    h += '<div style="padding:14px 16px 10px;border-bottom:1px solid #EDE9E0">';
    h += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">';
    h += '<div style="font-size:11px;font-weight:700;text-transform:uppercase;color:'+brandCol+'">'+esc(j.brand)+'</div>';
    h += '<div style="font-size:11px;font-weight:700;padding:3px 9px;border-radius:10px;background:'+(isDone?'#E6FFF5':'#EBF4FF')+';color:'+(isDone?'#00A86B':'#0073EA')+'">'+j.status+'</div>';
    h += '</div>';
    h += '<div style="font-size:18px;font-weight:800;color:#1C2333">'+esc(j.client)+'</div>';
    if (j.ref) h += '<div style="font-size:11.5px;color:#7A849E;margin-top:3px">Ref: '+esc(j.ref)+'</div>';
    h += '</div>';
    h += '<div style="padding:12px 16px;border-bottom:1px solid #EDE9E0">';
    if (j.origin) {
      h += '<div style="margin-bottom:10px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:#7A849E;margin-bottom:3px">FROM</div>';
      h += '<div style="font-size:14px;font-weight:600;color:#1C2333">'+esc(j.origin)+'</div>';
      h += '<a href="https://maps.google.com/?q='+encodeURIComponent(j.origin)+'" target="_blank" style="font-size:11.5px;color:#0073EA;font-weight:600;text-decoration:none">Open in Maps</a></div>';
    }
    if (j.dest) {
      h += '<div><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:#7A849E;margin-bottom:3px">TO</div>';
      h += '<div style="font-size:14px;font-weight:600;color:#1C2333">'+esc(j.dest)+'</div>';
      h += '<a href="https://maps.google.com/?q='+encodeURIComponent(j.dest)+'" target="_blank" style="font-size:11.5px;color:#0073EA;font-weight:600;text-decoration:none">Open in Maps</a></div>';
    }
    h += '</div>';
    h += '<div style="padding:10px 16px;border-bottom:1px solid #EDE9E0;display:flex;gap:16px">';
    if (vol) h += '<div><div style="font-size:10px;font-weight:700;color:#7A849E;text-transform:uppercase">Volume</div><div style="font-size:14px;font-weight:700;color:#1C2333;margin-top:2px">'+vol+'</div></div>';
    var crew = (j.drivers||[]).concat(j.porters||[]);
    if (crew.length) h += '<div><div style="font-size:10px;font-weight:700;color:#7A849E;text-transform:uppercase">Crew</div><div style="font-size:13px;font-weight:600;color:#1C2333;margin-top:2px">'+crew.join(', ')+'</div></div>';
    h += '</div>';
    if (j.notes) h += '<div style="padding:10px 16px;background:#FFFBE6;border-bottom:1px solid #EDE9E0"><div style="font-size:10px;font-weight:700;color:#B07800;text-transform:uppercase;margin-bottom:3px">Notes</div><div style="font-size:13px;color:#7A5200;line-height:1.5">'+esc(j.notes)+'</div></div>';
    h += '<div style="padding:12px 16px">';
    if (!isDone) {
      h += '<button data-jid="'+j.id+'" onclick="driverMarkComplete(this.dataset.jid)" style="width:100%;background:#00C875;color:#fff;border:none;border-radius:8px;padding:13px;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit">Mark as Complete</button>';
    } else {
      h += '<div style="text-align:center;font-size:13px;font-weight:700;color:#00A86B;padding:6px 0">Completed</div>';
    }
    h += '</div></div>';
  });
  el('dv-jobs').innerHTML = h;
}

function driverMarkComplete(jobId) {
  var j = jobs.filter(function(x){ return x.id === jobId; })[0];
  if (!j) return;
  if (!confirm('Mark "' + j.client + '" as Complete?')) return;
  j.status = 'Completed';
  saveData('job', j.id, j);
  renderDriverView();
  toast('Job marked as Complete');
}


// ── API DIAGNOSTIC ──────────────────────────────────────────────────
function testClaudeApi() {
  toast('Testing /api/claude...');
  fetch('/api/claude', {
    method: 'POST',
    credentials: 'include',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 20,
      messages: [{role: 'user', content: 'Say OK'}]
    })
  })
  .then(function(r) {
    var status = r.status;
    return r.text().then(function(txt) {
      alert('Status: ' + status + '\n\nResponse:\n' + txt.slice(0, 400));
    });
  })
  .catch(function(err) {
    alert('FETCH FAILED: ' + err.message + '\n\nThis usually means the /api/claude function does not exist or returned a network error.');
  });
}

// ── MOBILE NAV SYNC ──────────────────────────────────────────────────
function mobileNavActive(btn) {
  document.querySelectorAll('.mn-btn').forEach(function(b){ b.classList.remove('on'); });
  btn.classList.add('on');
}

function syncMobileNav(mod) {
  var map = {
    dashboard:'mn-dashboard', calendar:'mn-calendar',
    bookings:'mn-bookings', finance:'mn-finance', crew:'mn-crew'
  };
  document.querySelectorAll('.mn-btn').forEach(function(b){ b.classList.remove('on'); });
  if (map[mod]) {
    var el2 = document.getElementById(map[mod]);
    if (el2) el2.classList.add('on');
  }
}

// Update sidebar user display with auth info
function updateSidebarUser(name, role) {
  var nameEl = document.getElementById('sb-uname-display');
  var roleEl = document.getElementById('sb-urole-display');
  var avEl   = document.getElementById('sb-av-initials');
  if (nameEl) nameEl.textContent = name || 'Ops Manager';
  if (roleEl) roleEl.textContent = role || 'Administrator';
  if (avEl && name) {
    var parts = name.split(' ');
    avEl.textContent = parts.length > 1
      ? parts[0][0] + parts[parts.length-1][0]
      : name.slice(0,2).toUpperCase();
  }
  updateGreeting(name);
}


// ── TOPBAR GREETING ──────────────────────────────────────────────────
function updateGreeting(name) {
  var el2 = document.getElementById('tb-greeting');
  if (!el2) return;
  var h = new Date().getHours();
  var salutation = h < 12 ? 'Good morning' : h < 17 ? 'Good afternoon' : 'Good evening';
  var firstName = (name || '').split(' ')[0] || '';
  // Strip email domain if it's an email address
  if (firstName.indexOf('@') >= 0) firstName = firstName.split('@')[0];
  // Capitalise first letter
  firstName = firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase();
  el2.innerHTML = firstName
    ? salutation + ', <strong>' + firstName + '</strong>'
    : salutation;
}

// ── JOB ID SYSTEM ────────────────────────────────────────────────────────
var JOB_TYPE_CODES = {
  'Door to Door':        'D2D',
  'Domestic':            'DM',
  'Origin Sea Pack':     'S',
  'Origin Air Pack':     'A',
  'Sea':                 'S',
  'Air':                 'A',
  'Storage':             'WH',
  'Int Store Handling':  'WH',
  'Ex Store Delivery':   'WH',
  'European':            'E',
  'Origin Road Pack':    'E',
  'Debris Removal':      'DM',
  'Blanket Wrap':        'DM',
  'Handling Only':       'DM',
  'Consolidation':       'DM',
  'Destination Services':'D2D',
  'Other':               'DM'
};

function countryToCode(country) {
  if (!country) return 'XX';
  var c = country.trim().toUpperCase();
  var nameMap = {
    'UNITED KINGDOM':'UK','UK':'UK','GB':'UK','ENGLAND':'UK','SCOTLAND':'UK','WALES':'UK',
    'UNITED STATES':'US','USA':'US','US':'US','AMERICA':'US',
    'FRANCE':'FR','GERMANY':'DE','SPAIN':'ES','ITALY':'IT',
    'AUSTRALIA':'AU','NEW ZEALAND':'NZ','CANADA':'CA',
    'UAE':'AE','UNITED ARAB EMIRATES':'AE','DUBAI':'AE','ABU DHABI':'AE',
    'SINGAPORE':'SG','HONG KONG':'HK','CHINA':'CN','JAPAN':'JP',
    'SOUTH AFRICA':'ZA','NIGERIA':'NG','KENYA':'KE',
    'INDIA':'IN','PAKISTAN':'PK','BRAZIL':'BR','MEXICO':'MX',
    'NETHERLANDS':'NL','BELGIUM':'BE','SWITZERLAND':'CH','SWEDEN':'SE',
    'NORWAY':'NO','DENMARK':'DK','FINLAND':'FI','AUSTRIA':'AT',
    'PORTUGAL':'PT','IRELAND':'IE','POLAND':'PL','CZECH REPUBLIC':'CZ',
    'HUNGARY':'HU','ROMANIA':'RO','GREECE':'GR','TURKEY':'TR',
    'RUSSIA':'RU','UKRAINE':'UA','ISRAEL':'IL','SAUDI ARABIA':'SA',
    'QATAR':'QA','KUWAIT':'KW','BAHRAIN':'BH','OMAN':'OM',
    'THAILAND':'TH','MALAYSIA':'MY','INDONESIA':'ID','PHILIPPINES':'PH',
    'SOUTH KOREA':'KR','TAIWAN':'TW','VIETNAM':'VN',
    'ARGENTINA':'AR','CHILE':'CL','COLOMBIA':'CO','PERU':'PE',
    'EGYPT':'EG','MOROCCO':'MA','GHANA':'GH','TANZANIA':'TZ',
    'NEW ZEALAND':'NZ','ZIMBABWE':'ZW','ZAMBIA':'ZM','ETHIOPIA':'ET'
  };
  if (nameMap[c]) return nameMap[c];
  for (var name in nameMap) {
    if (c.indexOf(name) >= 0) return nameMap[name];
  }
  if (/^[A-Z]{2}$/.test(c)) return c === 'GB' ? 'UK' : c;
  return 'XX';
}

function jobTypeCode(jobType) {
  return JOB_TYPE_CODES[jobType] || 'DM';
}

function padJobNum(n) {
  var s = String(n);
  while (s.length < 7) s = '0' + s;
  return s;
}

function genClientJobId(originCountry, jobType, counter) {
  return countryToCode(originCountry) + '-' + jobTypeCode(jobType) + '-' + padJobNum(counter);
}

function nextJobCounter() {
  JOB_COUNTER++;
  if (!APP_SETTINGS) APP_SETTINGS = {};
  APP_SETTINGS.jobCounter = JOB_COUNTER;
  saveData('settings');
  return JOB_COUNTER;
}

function movementRef(masterJobId, movementNum) {
  var seq = String(movementNum);
  while (seq.length < 3) seq = '0' + seq;
  return masterJobId + '-' + seq;
}


// ── CLIENT RECORDS MODULE ────────────────────────────────────────────────

var cjFilter = 'all';

function setCjFilter(f, btn) {
  cjFilter = f;
  document.querySelectorAll('#cjf-all,#cjf-active,#cjf-done,#cjf-archived').forEach(function(b){ b.classList.remove('on'); });
  if (btn) btn.classList.add('on');
  renderClientJobsList();
}

function renderClientJobsList() {
  var search = (el('cj-search')||{}).value || '';
  var q = search.toLowerCase();
  var list = CLIENT_JOBS.slice().sort(function(a,b){ return b.createdAt > a.createdAt ? 1 : -1; });

  if (cjFilter === 'active')   list = list.filter(function(cj){ return cj.status === 'Active'; });
  if (cjFilter === 'done')     list = list.filter(function(cj){ return cj.status === 'Completed'; });
  if (cjFilter === 'archived') list = list.filter(function(cj){ return cj.status === 'Archived'; });
  // Default 'all' view hides archived to keep it clean — archived only visible in their own tab
  if (cjFilter === 'all')      list = list.filter(function(cj){ return cj.status !== 'Archived'; });
  if (q) list = list.filter(function(cj){
    return (cj.clientName||'').toLowerCase().indexOf(q)>=0
        || (cj.masterJobId||'').toLowerCase().indexOf(q)>=0
        || (cj.clientRef||'').toLowerCase().indexOf(q)>=0
        || (cj.clientEmail||'').toLowerCase().indexOf(q)>=0;
  });

  // Update badge
  var badge = el('cj-count-badge');
  if (badge) badge.textContent = CLIENT_JOBS.length;
  setBadge('bk-badge', CLIENT_JOBS.length);

  if (!list.length) {
    setH('cj-list', '<div style="padding:24px 16px;text-align:center;color:var(--t3);font-size:12px">' +
      (CLIENT_JOBS.length ? 'No records match your filter.' : 'No client jobs yet.<br>Click <strong>+ New Client Job</strong> to start.') + '</div>');
    return;
  }

  var h = '';
  list.forEach(function(cj) {
    var col = BC[cj.brand] || '#0073EA';
    // Count from jobs array (real source of truth — jobs saved to OpsJobs)
    var linkedJobs = jobs.filter(function(j){ return j.clientJobId === cj.id; });
    // Build movement type icon summary
    var typeIcons = {
      'Origin Sea Pack':'🚢','Sea':'🚢',
      'Origin Air Pack':'✈️','Air':'✈️',
      'Origin Road Pack':'🚛','European':'🚛',
      'Int Store Handling':'🏭','Ex Store Delivery':'🏭','Storage':'🏭',
      'Door to Door':'📦','Destination Services':'📦',
      'Domestic':'🏠','Debris Removal':'🗑️',
      'Blanket Wrap':'🛋️','Handling Only':'🤲','Consolidation':'📫'
    };
    var typeCounts = {};
    linkedJobs.forEach(function(j) {
      var icon = typeIcons[j.jobType] || '📋';
      typeCounts[icon] = (typeCounts[icon] || 0) + 1;
    });
    var typeChips = Object.keys(typeCounts).map(function(icon) {
      return '<span style="font-size:11px;white-space:nowrap">' + icon + ' ×' + typeCounts[icon] + '</span>';
    }).join('');

    var statusCls = cj.status === 'Active' ? 'bst-conf' : cj.status === 'Completed' ? 'bst-comp' : 'bst-canc';
    var isActive = curClientJobId === cj.id;
    h += '<div class="bk-item' + (isActive?' on':'') + '" onclick="viewClientJob(\'' + cj.id + '\')" style="border-left:3px solid '+col+'">';
    h += '<div style="flex:1;min-width:0">';
    h += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">';
    h += '<span style="font-family:monospace;font-size:11px;font-weight:700;color:var(--blue);letter-spacing:.3px">' + esc(cj.masterJobId) + '</span>';
    h += '<span class="bst ' + statusCls + '" style="font-size:9px">' + cj.status + '</span>';
    h += '</div>';
    h += '<div style="font-weight:600;font-size:13px;color:var(--t1);margin-bottom:4px">' + esc(cj.clientName) + '</div>';
    h += '<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">';
    h += bbadge(cj.brand,'sm');
    if (linkedJobs.length) {
      h += typeChips;
    } else {
      h += '<span style="font-size:11px;color:var(--t3)">No movements yet</span>';
    }
    h += '</div>';
    h += '</div>';
    h += '</div>';
  });
  setH('cj-list', h);
}

function viewClientJob(id) {
  curClientJobId = id;
  var cj = CLIENT_JOBS.filter(function(x){ return x.id===id; })[0];
  if (!cj) return;
  renderClientJobsList(); // refresh active state
  renderClientJobDetail(cj);
}

function renderClientJobDetail(cj) {
  var col = BC[cj.brand] || '#0073EA';
  var calJobs = jobs.filter(function(j){ return j.clientJobId === cj.id; })
    .sort(function(a,b){ return a.start > b.start ? 1 : -1; });
  var movs = calJobs; // movements live in jobs array, not bookings

  var h = '<div class="fade-in" style="max-width:860px;margin:0 auto;padding:24px">';

  // ── Header ──
  h += '<div style="background:var(--w);border-radius:12px;border:1px solid var(--b1);padding:20px 24px;margin-bottom:16px;border-top:4px solid '+col+'">';
  h += '<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap">';
  h += '<div>';
  h += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">';
  h += '<span style="font-family:monospace;font-size:18px;font-weight:800;color:var(--t1);letter-spacing:.5px">' + esc(cj.masterJobId) + '</span>';
  var scls = cj.status==='Active'?'bst-conf':cj.status==='Completed'?'bst-comp':'bst-canc';
  h += '<span class="bst '+scls+'">' + cj.status + '</span>';
  h += bbadge(cj.brand);
  h += '</div>';
  h += '<div style="font-size:22px;font-weight:700;color:var(--t1)">' + esc(cj.clientName) + '</div>';
  h += '<div style="font-size:12px;color:var(--t3);margin-top:4px">';
  if (cj.clientEmail) h += '<a href="mailto:'+esc(cj.clientEmail)+'" style="color:var(--blue)">'+esc(cj.clientEmail)+'</a> &nbsp;';
  if (cj.clientPhone) h += '<span>&#128222; '+esc(cj.clientPhone)+'</span>';
  h += '</div>';
  h += '</div>';
  h += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
  h += '<button class="btn btn-p btn-sm" onclick="addMovementToJob(\''+cj.id+'\')">+ Add Movement</button>';
  h += '<button class="btn btn-s btn-sm" onclick="editClientJob(\''+cj.id+'\')">&#9998; Edit</button>';
  h += '<button class="btn btn-s btn-sm" onclick="updateClientJobCountry(\''+cj.id+'\')">&#127758; Update Country</button>';
  if (cj.status !== 'Archived') {
    h += '<button class="btn btn-s btn-sm" onclick="archiveClientJob(\''+cj.id+'\')" style="color:var(--t3)" title="Archive hides this record from Active view">&#128451; Archive</button>';
  } else {
    h += '<button class="btn btn-s btn-sm" onclick="unarchiveClientJob(\''+cj.id+'\')" style="color:var(--green)">&#9099; Restore</button>';
  }
  h += '<button class="btn btn-s btn-sm" onclick="deleteClientJob(\''+cj.id+'\')" style="color:var(--red)" title="Permanently delete this record">&#128465; Delete</button>';
  h += '</div>';
  h += '</div>';

  // Meta row
  h += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:16px;padding-top:16px;border-top:1px solid var(--b1)">';
  h += '<div><div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)">Job Type</div><div style="font-size:13px;font-weight:600;color:var(--t1);margin-top:2px">'+esc(cj.jobType||'—')+'</div></div>';
  h += '<div><div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)">Origin Country</div><div style="font-size:13px;font-weight:600;color:var(--t1);margin-top:2px;font-family:monospace">'+esc(cj.originCountry||'XX')+'</div></div>';
  h += '<div><div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)">Move Manager</div><div style="font-size:13px;font-weight:600;color:var(--t1);margin-top:2px">'+esc(cj.moveManager||'—')+'</div></div>';
  h += '<div><div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)">Client Ref</div><div style="font-size:13px;font-weight:600;color:var(--t1);margin-top:2px">'+esc(cj.clientRef||'—')+'</div></div>';
  h += '</div>';
  h += '</div>';

  // ── Partner ref missing warning ──────────────────────────────────────
  if (!cj.partnerRef && !cj.clientRef) {
    h += '<div style="background:#FFF5E0;border:1.5px solid #FF9F1A;border-radius:10px;padding:12px 16px;margin-bottom:14px;display:flex;align-items:center;gap:12px">';
    h += '<span style="font-size:20px">⚠️</span>';
    h += '<div style="flex:1"><div style="font-size:13px;font-weight:700;color:#9A5600">Partner Reference Missing</div>';
    h += '<div style="font-size:11.5px;color:#9A5600;margin-top:2px">The partner\'s job reference is required to create the SharePoint folder and name documents correctly. <a onclick="editClientJob(\''+cj.id+'\')" style="color:#0073EA;cursor:pointer;font-weight:700">Add it now →</a></div>';
    h += '</div></div>';
  }

  // ── Documents tab ─────────────────────────────────────────────────────
  h += '<div style="background:var(--w);border-radius:12px;border:1px solid var(--b1);margin-bottom:16px;overflow:hidden">';
  h += '<div style="padding:16px 20px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;gap:12px">';
  h += '<div style="font-weight:700;font-size:14px;display:flex;align-items:center;gap:8px">📁 Documents';
  if (cj.spFolderUrl) {
    h += '<a href="'+esc(cj.spFolderUrl)+'" target="_blank" style="font-size:10.5px;font-weight:600;color:var(--blue);background:var(--blt);padding:2px 8px;border-radius:4px;border:1px solid rgba(0,115,234,.2)">Open in SharePoint ↗</a>';
  }
  h += '</div>';
  h += '<div style="display:flex;gap:7px">';
  if (!cj.spFolderId) {
    var canCreate = (cj.partnerRef||cj.clientRef) && cj.brand;
    h += '<button class="btn btn-p btn-sm" onclick="spCreateFolder(\''+cj.id+'\')" '+(canCreate?'':'disabled title="Add partner reference and brand first"')+'>📁 Create SharePoint Folder</button>';
  } else {
    h += '<button class="btn btn-s btn-sm" onclick="spUploadFile(\''+cj.id+'\')">⬆ Upload File</button>';
    h += '<button class="btn btn-s btn-sm" onclick="spShareFolder(\''+cj.id+'\')">🔗 Share Folder</button>';
    h += '<button class="btn btn-s btn-sm" onclick="sendJobConfirmationEmail(\''+cj.id+'\',{resend:true})" title="Resend job confirmation email">📧 Resend Confirmation</button>';
    h += '<button class="btn btn-s btn-sm" onclick="sendDocReminder(\''+cj.id+'\')" title="Request missing documents from move manager">📋 Request Docs</button>';
  }
  h += '</div></div>';

  // Document checklist
  h += '<div id="sp-docs-'+cj.id+'" style="padding:16px 20px">';
  if (!cj.spFolderId) {
    h += '<div style="text-align:center;padding:24px;color:var(--t3)">';
    h += '<div style="font-size:32px;margin-bottom:8px">📁</div>';
    h += '<div style="font-size:13px;font-weight:600;color:var(--t2)">No SharePoint folder yet</div>';
    h += '<div style="font-size:11.5px;margin-top:4px">Click "Create SharePoint Folder" to set up the document library for this job.</div>';
    h += '</div>';
  } else {
    h += spDocChecklist(cj);
  }
  h += '</div></div>';

  // ── Movements ──
  h += '<div style="background:var(--w);border-radius:12px;border:1px solid var(--b1);padding:20px 24px;margin-bottom:16px">';
  h += '<div style="font-weight:700;font-size:14px;margin-bottom:14px;display:flex;align-items:center;gap:8px">📈 Movements <span style="font-size:11px;font-weight:500;color:var(--t3)">'+calJobs.length+' movement'+(calJobs.length===1?'':'s')+'</span></div>';

  if (!calJobs.length) {
    h += '<div style="text-align:center;padding:20px;color:var(--t3);font-size:12px">No movements yet. Click <strong>+ Add Movement</strong> to schedule the first one.</div>';
  } else {
    // Show calendar jobs with movement refs
    var allMovements = calJobs.length ? calJobs : movs.map(function(b){ return b.cfgData && b.cfgData.jobs ? b : null; }).filter(Boolean);
    if (!allMovements.length) allMovements = calJobs;

    calJobs.forEach(function(j, mi) {
      var movRef = j.movementRef || (cj.masterJobId + '-' + String(mi+1).padStart(3,'0'));
      var stCls = j.status==='Completed'||j.status==='Billed' ? 'bst-comp' :
                  j.status==='Scheduled'||j.status==='Confirmed' ? 'bst-conf' :
                  j.status==='Cancelled' ? 'bst-canc' : 'bst-pend';
      h += '<div style="display:flex;align-items:flex-start;gap:12px;padding:12px;background:var(--s1);border-radius:8px;border:1px solid var(--b1);margin-bottom:8px">';
      h += '<div style="width:36px;height:36px;border-radius:8px;background:'+col+';display:flex;align-items:center;justify-content:center;font-family:monospace;font-size:11px;font-weight:700;color:#fff;flex-shrink:0">'+String(mi+1).padStart(3,'0')+'</div>';
      h += '<div style="flex:1;min-width:0">';
      h += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">';
      h += '<span style="font-family:monospace;font-size:12px;font-weight:700;color:var(--blue)">'+esc(movRef)+'</span>';
      h += '<span class="bst '+stCls+'">'+j.status+'</span>';
      h += '</div>';
      h += '<div style="font-size:13px;font-weight:600;color:var(--t1)">'+esc(j.jobType||'Movement')+'</div>';
      h += '<div style="font-size:11.5px;color:var(--t3);margin-top:3px">';
      h += fmtNice(j.start)+(j.end&&j.end!==j.start?' — '+fmtNice(j.end):'');
      if (j.origin) h += ' &bull; '+esc(j.origin.substring(0,40));
      if (j.dest) h += ' &#8594; '+esc(j.dest.substring(0,40));
      h += '</div>';
      if (j.vol) h += '<div style="font-size:11px;color:var(--t3);margin-top:2px">'+j.vol+' ft&#179;'+(j.cbm?' / '+j.cbm+' CBM':'')+'</div>';
      h += '</div>';
      h += '<button class="btn btn-s btn-sm" onclick="openEdit(\''+j.id+'\')" style="flex-shrink:0">View</button>';
      h += '</div>';
    });
  }
  h += '</div>';

  // ── Surveys ──
  var jobSurveys = SURVEYS.filter(function(s){ return s.clientJobId===cj.id || (s.clientName||'').toLowerCase()===(cj.clientName||'').toLowerCase(); });
  if (jobSurveys.length) {
    h += '<div style="background:var(--w);border-radius:12px;border:1px solid var(--b1);padding:20px 24px;margin-bottom:16px">';
    h += '<div style="font-weight:700;font-size:14px;margin-bottom:12px">&#128200; Surveys</div>';
    jobSurveys.forEach(function(s){
      h += '<div style="padding:10px 12px;background:var(--s1);border-radius:8px;border:1px solid var(--b1);margin-bottom:6px;font-size:12.5px">';
      h += '<strong>'+esc(s.ref||'Survey')+'</strong> &bull; '+fmtNice(s.date)+' at '+esc(s.time||'TBC');
      if (s.postcode) h += ' &bull; '+esc(s.postcode);
      if (s.notes) h += '<br><span style="color:var(--t3)">'+esc(s.notes)+'</span>';
      h += '</div>';
    });
    h += '</div>';
  }

  // ── Billing summary ──
  var totalBilled = 0;
  calJobs.forEach(function(j){ (j.billing||[]).forEach(function(b){ totalBilled += b.amt||0; }); });
  if (totalBilled > 0) {
    h += '<div style="background:var(--w);border-radius:12px;border:1px solid var(--b1);padding:20px 24px;margin-bottom:16px">';
    h += '<div style="font-weight:700;font-size:14px;margin-bottom:12px">&#163; Billing</div>';
    h += '<div style="display:flex;align-items:center;gap:16px">';
    h += '<div style="font-size:28px;font-weight:800;color:var(--green)">'+fmt(totalBilled)+'</div>';
    h += '<div style="font-size:12px;color:var(--t3)">Total across '+calJobs.length+' movement'+(calJobs.length===1?'':'s')+'</div>';
    h += '</div>';
    h += '</div>';
  }

  // ── Change history ──
  var log = cj.changeLog || [];
  if (log.length) {
    h += '<div style="background:var(--w);border-radius:12px;border:1px solid var(--b1);padding:20px 24px;margin-bottom:16px">';
    h += '<div style="font-weight:700;font-size:14px;margin-bottom:12px">&#128203; History</div>';
    log.slice().reverse().forEach(function(e2){
      h += '<div style="padding:8px 0;border-bottom:1px solid var(--b1);font-size:12px">';
      h += '<span style="color:var(--t3)">' + (e2.ts||'').slice(0,10) + '</span> &bull; ';
      h += esc(e2.action||'') + (e2.note ? ' — ' + esc(e2.note) : '');
      if (e2.user) h += ' <span style="color:var(--t3)">by '+esc(e2.user)+'</span>';
      h += '</div>';
    });
    h += '</div>';
  }

  h += '</div>'; // fade-in wrapper
  setH('cj-detail', h);
}

function newClientRecord() {
  // Open booking configurator with no pre-linked client job
  openConfigurator(null);
}

function addMovementToJob(clientJobId) {
  // Open configurator pre-linked to existing client job
  var cj = CLIENT_JOBS.filter(function(x){ return x.id===clientJobId; })[0];
  if (!cj) return;
  CFG = cfgEmpty();
  CFG.clientJobId   = cj.id;
  CFG.clientName    = cj.clientName;
  CFG.clientEmail   = cj.clientEmail;
  CFG.clientPhone   = cj.clientPhone;
  CFG.clientRef     = cj.clientRef;
  CFG.brand         = cj.brand;
  CFG.channel       = cj.channel;
  CFG.moveManager   = cj.moveManager;
  CFG.originCountry = cj.originCountry;
  CFG.status        = 'Provisional'; // not Draft — ensures it saves to Azure and goes on calendar
  cfgStage = 1; // skip to Brief stage — client details already filled from master record
  el('cfg-head-ref').textContent = cj.masterJobId;
  el('cfg-head-title').textContent = 'Add Movement — ' + cj.clientName;
  el('cfg-backdrop').classList.add('on');
  el('cfg-panel').classList.add('on');
  cfgRenderStage();
  cfgUpdateNav();
}

function editClientJob(id) {
  var cj = CLIENT_JOBS.filter(function(x){ return x.id===id; })[0];
  if (!cj) return;
  CFG = cfgEmpty();
  CFG.id            = cj.id;
  CFG.clientJobId   = cj.id;
  CFG.clientName    = cj.clientName;
  CFG.clientEmail   = cj.clientEmail;
  CFG.clientPhone   = cj.clientPhone;
  CFG.clientRef     = cj.clientRef;
  CFG.brand         = cj.brand;
  CFG.channel       = cj.channel;
  CFG.moveManager   = cj.moveManager;
  CFG.originCountry = cj.originCountry;
  CFG.status        = 'Provisional';
  cfgStage = 0;
  el('cfg-head-ref').textContent = cj.masterJobId;
  el('cfg-head-title').textContent = 'Edit Client Record';
  el('cfg-backdrop').classList.add('on');
  el('cfg-panel').classList.add('on');
  cfgRenderStage();
  cfgUpdateNav();
}

function updateClientJobCountry(id) {
  var cj = CLIENT_JOBS.filter(function(x){ return x.id===id; })[0];
  if (!cj) return;
  var newCountry = prompt('Enter origin country code or name (current: ' + (cj.originCountry||'XX') + '):', cj.originCountry||'XX');
  if (!newCountry) return;
  cj.originCountry = countryToCode(newCountry) || 'XX';
  cj.masterJobId   = genClientJobId(cj.originCountry, cj.jobType, cj.jobCounter);
  // Update all linked jobs
  jobs.forEach(function(j){
    if (j.clientJobId === cj.id) {
      j.masterJobId = cj.masterJobId;
      var movNum = parseInt((j.movementRef||'').split('-').pop()) || 1;
      j.movementRef = movementRef(cj.masterJobId, movNum);
      saveData('job', j.id, j);
    }
  });
  saveData('clientjob', cj.id, cj);
  toast('Job ID updated to ' + cj.masterJobId);
  renderClientJobDetail(cj);
  renderClientJobsList();
}

function cfgPreviewJobId() {
  var ocEl = el('cfg-origin-country');
  var preview = el('cfg-jobid-preview');
  if (!ocEl || !preview) return;
  var cc = countryToCode(ocEl.value) || 'XX';
  var jt = (CFG.jobs&&CFG.jobs[0]&&CFG.jobs[0].jobType) ? CFG.jobs[0].jobType : 'Door to Door';
  preview.textContent = cc + '-' + jobTypeCode(jt) + '-XXXXXXX';
}

// Show client records when switching to bookings module
function initBookingMod() {
  renderClientJobsList();
}


function archiveClientJob(id) {
  var cj = CLIENT_JOBS.filter(function(x){ return x.id===id; })[0];
  if (!cj) return;
  cj.status = 'Archived';
  cj.archivedAt = new Date().toISOString();
  cj.archivedBy = window._authUser || 'Unknown';
  saveData('clientjob', cj.id, cj);
  toast(cj.clientName + ' archived');
  renderClientJobsList();
  renderClientJobDetail(cj);
}

function unarchiveClientJob(id) {
  var cj = CLIENT_JOBS.filter(function(x){ return x.id===id; })[0];
  if (!cj) return;
  cj.status = 'Active';
  delete cj.archivedAt;
  delete cj.archivedBy;
  saveData('clientjob', cj.id, cj);
  toast(cj.clientName + ' restored to Active');
  renderClientJobsList();
  renderClientJobDetail(cj);
}

function deleteClientJob(id) {
  var cj = CLIENT_JOBS.filter(function(x){ return x.id===id; })[0];
  if (!cj) return;
  var linkedCount = jobs.filter(function(j){ return j.clientJobId===id; }).length;
  var msg = 'Permanently delete client record for ' + cj.clientName + ' (' + cj.masterJobId + ')?';
  if (linkedCount > 0) {
    msg += '\n\nThis record has ' + linkedCount + ' linked movement(s) on the calendar. Those jobs will remain on the calendar but will no longer be linked to a client record.';
  }
  msg += '\n\nThis cannot be undone.';
  if (!confirm(msg)) return;

  // Unlink any calendar jobs
  jobs.forEach(function(j) {
    if (j.clientJobId === id) {
      delete j.clientJobId;
      delete j.masterJobId;
      delete j.movementRef;
      saveData('job', j.id, j);
    }
  });

  // Remove from CLIENT_JOBS array
  CLIENT_JOBS = CLIENT_JOBS.filter(function(x){ return x.id !== id; });

  // Delete from Azure — send a delete marker
  apiPost(TABLE_MAP.clientjob, { id: id, _deleted: true, deletedAt: new Date().toISOString() });

  // Clear detail panel
  curClientJobId = null;
  setH('cj-detail', '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;min-height:400px;color:var(--t3);text-align:center;padding:40px"><div style="font-size:14px;font-weight:600;color:var(--t2);margin-bottom:8px">Record deleted</div><div style="font-size:12.5px">Select another record from the list.</div></div>');

  renderClientJobsList();
  lsSave();
  toast('Client record deleted');
}


// ── WAREHOUSE MANAGEMENT ─────────────────────────────────────────────────

function getDefaultWarehouse() {
  return WAREHOUSES.filter(function(w){ return w.isDefault; })[0] || WAREHOUSES[0] || null;
}

function getWarehouseAddress(id) {
  if (!id) return (getDefaultWarehouse() || {}).address || APP_SETTINGS.warehouseAddress || '';
  var wh = WAREHOUSES.filter(function(w){ return w.id === id; })[0];
  return wh ? wh.address : (getDefaultWarehouse() || {}).address || '';
}

function whAdd() {
  WAREHOUSES.push({
    id: 'WH' + Date.now(),
    name: '',
    address: '',
    isDefault: WAREHOUSES.length === 0
  });
  renderSettings();
}

function whRemove(idx) {
  if (WAREHOUSES.length <= 1) { toast('Must keep at least one warehouse location'); return; }
  var wasDefault = WAREHOUSES[idx].isDefault;
  WAREHOUSES.splice(idx, 1);
  if (wasDefault && WAREHOUSES.length) WAREHOUSES[0].isDefault = true;
  renderSettings();
}

function whSetDefault(idx) {
  WAREHOUSES.forEach(function(w, i){ w.isDefault = (i === idx); });
}

function whSave() {
  // Read values from form
  WAREHOUSES.forEach(function(wh, i) {
    var nameEl = el('wh-name-' + i);
    var addrEl = el('wh-addr-' + i);
    if (nameEl) wh.name    = nameEl.value.trim() || wh.name;
    if (addrEl) wh.address = addrEl.value.trim() || wh.address;
  });
  // Sync legacy warehouseAddress
  var defWh = getDefaultWarehouse();
  if (defWh) APP_SETTINGS.warehouseAddress = defWh.address;
  saveData('settings');
  toast('Warehouse locations saved');
  renderSettings();
}

// Wire address autocomplete on warehouse inputs after settings render
(function(){
  var _origRenderCosting = window.renderSettingsCosting || null;
  // We patch renderSettings to also bind warehouse address inputs
  var _origRS = renderSettings;
  renderSettings = function() {
    _origRS();
    setTimeout(function() {
      for (var _i = 0; _i < WAREHOUSES.length; _i++) {
        (function(i) {
          var addrEl = document.getElementById('wh-addr-' + i);
          if (addrEl && !addrEl._addrBound) bindAddressField(addrEl);
        })(_i);
      }
    }, 100);
  };
})();


// ── JOB TYPE ADDRESS CONFIGURATION ──────────────────────────────────────
// Defines which address fields to show, their labels, and auto-fill behaviour
// 'property' = user enters client/site address
// 'warehouse' = auto-filled from selected warehouse (read-only)
// 'both'      = user enters both
// 'port'      = user enters port/depot address
var JOB_ADDR_CONFIG = {
  'Origin Sea Pack':     { originRole:'property', destRole:'port',
                           originLabel:'Collection Address', destLabel:'Port / Depot' },
  'Origin Air Pack':     { originRole:'property', destRole:'port',
                           originLabel:'Collection Address', destLabel:'Airport / Depot' },
  'Origin Road Pack':    { originRole:'property', destRole:'port',
                           originLabel:'Collection Address', destLabel:'Groupage Hub / Port' },
  'Destination Services':{ originRole:'port',     destRole:'property',
                           originLabel:'Port / Depot or Origin', destLabel:'Delivery Address' },
  'Ex Store Delivery':   { originRole:'warehouse', destRole:'property',
                           originLabel:'Warehouse (auto-filled)', destLabel:'Delivery Address' },
  'Int Store Handling':  { originRole:'property',  destRole:'warehouse',
                           originLabel:'Collection Address', destLabel:'Warehouse (auto-filled)' },
  'Blanket Wrap':        { originRole:'property',  destRole:'property',
                           originLabel:'Property Address', destLabel:'Destination (if different)' },
  'Debris Removal':      { originRole:'property',  destRole:'warehouse',
                           originLabel:'Collection Address', destLabel:'Disposal / Warehouse' },
  'Handling Only':       { originRole:'property',  destRole:'property',
                           originLabel:'Origin Address', destLabel:'Destination Address' },
  'Consolidation':       { originRole:'property',  destRole:'port',
                           originLabel:'Collection Address', destLabel:'Consolidation Hub' },
  'Door to Door':        { originRole:'property',  destRole:'property',
                           originLabel:'Origin Address', destLabel:'Destination Address' },
  'Other':               { originRole:'property',  destRole:'property',
                           originLabel:'Origin Address', destLabel:'Destination Address' }
};

function getAddrConfig(jobType) {
  return JOB_ADDR_CONFIG[jobType] || JOB_ADDR_CONFIG['Other'];
}

// Get warehouse options as HTML for a select
function whSelectOptions(selectedId) {
  var h = '';
  WAREHOUSES.forEach(function(wh) {
    h += '<option value="' + esc(wh.id) + '"' + (wh.id === selectedId ? ' selected' : '') +
         (wh.isDefault && !selectedId ? ' selected' : '') + '>' + esc(wh.name) +
         (wh.isDefault ? ' (default)' : '') + '</option>';
  });
  return h;
}

</script>

  <!-- Survey Modal -->
  <div id="survey-backdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:600;align-items:center;justify-content:center">
    <div id="survey-modal" style="background:var(--w);border-radius:12px;width:520px;max-width:95vw;max-height:90vh;overflow:auto;box-shadow:0 8px 40px rgba(0,0,0,.22)">
      <div style="padding:18px 20px 14px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-weight:700;font-size:15px" id="survey-modal-title">New Survey</div>
          <div style="font-size:11.5px;color:var(--t3);margin-top:2px" id="survey-modal-ref"></div>
        </div>
        <button onclick="closeSurveyModal()" style="background:none;border:none;font-size:20px;color:var(--t3);cursor:pointer;line-height:1">&#10005;</button>
      </div>
      <div style="padding:18px 20px" id="survey-form-body"></div>
      <div style="padding:12px 20px 18px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--b1)">
        <button class="btn btn-s btn-sm" onclick="closeSurveyModal()">Cancel</button>
        <button class="btn btn-s btn-sm" id="sv-resend-btn" onclick="if(curSurveyId)sendSurveyConfirmationEmail(curSurveyId,{resend:true})" style="display:none">📧 Resend Confirmation</button>
        <button class="btn btn-p btn-sm" onclick="saveSurvey()">Save Survey</button>
      </div>
    </div>
  </div>

  <!-- ══ DRIVER VIEW (full-screen, locked) ══════════════════════════ -->
  <div id="driver-view" style="display:none;position:fixed;inset:0;background:#F4F3EE;z-index:9000;overflow-y:auto;font-family:'DM Sans',sans-serif">
    <div style="max-width:480px;margin:0 auto;padding:16px">
      <!-- Header -->
      <div style="background:#151c2c;border-radius:12px;padding:16px 18px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:rgba(255,255,255,.4)">OPS MANAGER</div>
          <div style="font-size:17px;font-weight:800;color:#fff;margin-top:2px" id="dv-name">Driver</div>
          <div style="font-size:12px;color:rgba(255,255,255,.5);margin-top:1px" id="dv-date"></div>
        </div>
        <div style="background:var(--blue);border-radius:8px;padding:8px 14px;font-size:12px;font-weight:700;color:#fff" id="dv-job-count">0 jobs</div>
      </div>
      <!-- Jobs list -->
      <div id="dv-jobs"></div>
      <!-- Empty state -->
      <div id="dv-empty" style="display:none;text-align:center;padding:48px 20px;color:#7A849E">
        <div style="font-size:40px;margin-bottom:12px">✅</div>
        <div style="font-size:16px;font-weight:700;color:#1C2333">No jobs today</div>
        <div style="font-size:13px;margin-top:6px">Check back tomorrow</div>
      </div>
    </div>
  </div>

  <!-- Mobile bottom navigation -->
  <nav class="mobile-nav" id="mobile-nav">
    <button class="mn-btn on" id="mn-dashboard" onclick="showMod('dashboard',this);mobileNavActive(this)">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>
      <span>Home</span>
    </button>
    <button class="mn-btn" id="mn-calendar" onclick="showMod('calendar',this);mobileNavActive(this)">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      <span>Calendar</span>
    </button>
    <button class="mn-btn" id="mn-bookings" onclick="showMod('bookings',this);mobileNavActive(this)">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      <span>Bookings</span>
      <span class="mn-badge hidden" id="mn-bk-badge">0</span>
    </button>
    <button class="mn-btn" id="mn-finance" onclick="showMod('finance',this);mobileNavActive(this)">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      <span>Finance</span>
    </button>
    <button class="mn-btn" id="mn-crew" onclick="showMod('crew',this);mobileNavActive(this)">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="7" r="4"/><path d="M3 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"/></svg>
      <span>Crew</span>
    </button>
  </nav>

<!-- Date Jumper Modal -->
<div id="dj-backdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:800;align-items:center;justify-content:center" onclick="if(event.target===this)closeDateJumper()">
  <div id="dj-modal" style="background:#fff;border-radius:14px;padding:24px;width:320px;box-shadow:0 20px 60px rgba(0,0,0,.25);animation:dj-pop .15s cubic-bezier(.34,1.56,.64,1)">
    <div style="font-size:14px;font-weight:700;color:#1A2035;margin-bottom:4px">Jump to Date</div>
    <div style="font-size:11.5px;color:#7A849E;margin-bottom:16px">Select any date to navigate directly there</div>
    <input type="date" id="dj-input" style="width:100%;padding:9px 12px;border:1.5px solid #E3E7F0;border-radius:7px;font-size:14px;font-family:inherit;color:#1A2035;box-sizing:border-box;outline:none" oninput="djPreview(this.value)">
    <div id="dj-preview" style="margin-top:10px;font-size:12px;color:#7A849E;min-height:18px;text-align:center"></div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button onclick="closeDateJumper()" style="flex:1;padding:9px;border:1.5px solid #E3E7F0;border-radius:7px;background:#fff;font-size:13px;font-weight:600;color:#7A849E;cursor:pointer">Cancel</button>
      <button id="dj-go-btn" onclick="doDateJump()" style="flex:2;padding:9px;border:none;border-radius:7px;background:#0073EA;color:#fff;font-size:13px;font-weight:700;cursor:pointer;opacity:.5" disabled>Go →</button>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:14px;padding-top:12px;border-top:1px solid #f0efe9">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#B0B8CC;width:100%;margin-bottom:2px">Quick jump</div>
      <button onclick="djQuick(0)" class="dj-quick">This week</button>
      <button onclick="djQuick(-4)" class="dj-quick">4 weeks ago</button>
      <button onclick="djQuick(-13)" class="dj-quick">3 months ago</button>
      <button onclick="djQuick(-26)" class="dj-quick">6 months ago</button>
      <button onclick="djQuick(-52)" class="dj-quick">1 year ago</button>
      <button onclick="djQuick(4)" class="dj-quick">4 weeks ahead</button>
    </div>
  </div>
</div>

<script>

// ═══════════════════════════════════════════════════════════════════════════
// EMAIL — GRAPH API SEND + BRANDED HTML TEMPLATE
// ═══════════════════════════════════════════════════════════════════════════

async function sendEmail(opts) {
  // opts: { to, cc, subject, html, text, replyTo }
  try {
    var res = await fetch('/api/email', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        to:      opts.to,
        cc:      opts.cc || null,
        subject: opts.subject,
        html:    opts.html || null,
        text:    opts.text || null,
        replyTo: opts.replyTo || APP_SETTINGS.emailReplyTo || null
      })
    });
    var data = await res.json();
    return data.ok ? { ok: true } : { ok: false, error: data.error || 'Send failed' };
  } catch(e) {
    return { ok: false, error: e.message };
  }
}

function buildEmailHtml(opts) {
  // opts: { subject, preheader, bodyHtml, ctaUrl, ctaLabel, footerExtra }
  var s        = APP_SETTINGS;
  var company  = s.companyName      || 'Onwards';
  var tagline  = s.companyTagline   || 'Professional Moving Services';
  var phone    = s.companyPhone     || '';
  var website  = s.companyWebsite   || 'onwards.network';
  var address  = s.companyAddress   || '';
  var footer   = s.emailFooter      || '';
  var accent   = s.emailAccentColor || '#0073EA';
  var preheader = opts.preheader    || '';
  var ctaBlock  = '';
  if (opts.ctaUrl && opts.ctaLabel) {
    ctaBlock = '<div style="text-align:center;margin:32px 0"><a href="' + opts.ctaUrl + '" style="display:inline-block;background:' + accent + ';color:#fff;font-family:DM Sans,Helvetica,Arial,sans-serif;font-size:15px;font-weight:600;padding:14px 32px;border-radius:8px;text-decoration:none;letter-spacing:0.2px">' + opts.ctaLabel + '</a></div>';
  }
  return '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>' + esc(opts.subject) + '</title></head>'
  + '<body style="margin:0;padding:0;background:#f4f6f9;font-family:DM Sans,Helvetica,Arial,sans-serif">'
  + (preheader ? '<div style="display:none;max-height:0;overflow:hidden;font-size:1px;line-height:1px;color:#f4f6f9">' + esc(preheader) + '</div>' : '')
  + '<table width="100%" cellpadding="0" cellspacing="0" style="background:#f4f6f9;padding:32px 16px">'
  + '<tr><td align="center">'
  + '<table width="100%" cellpadding="0" cellspacing="0" style="max-width:600px">'
  // Header
  + '<tr><td style="background:' + accent + ';border-radius:12px 12px 0 0;padding:28px 40px">'
  + '<div style="color:#fff;font-size:22px;font-weight:700;letter-spacing:-0.3px">' + esc(company) + '</div>'
  + '<div style="color:rgba(255,255,255,0.8);font-size:13px;margin-top:3px">' + esc(tagline) + '</div>'
  + '</td></tr>'
  // Body
  + '<tr><td style="background:#ffffff;padding:40px;border-left:1px solid #e8eaed;border-right:1px solid #e8eaed">'
  + '<div style="color:#1a1a2e;font-size:15px;line-height:1.7">'
  + opts.bodyHtml
  + '</div>'
  + ctaBlock
  + '</td></tr>'
  // Footer
  + '<tr><td style="background:#f8f9fb;border:1px solid #e8eaed;border-top:none;border-radius:0 0 12px 12px;padding:24px 40px">'
  + '<div style="color:#6b7280;font-size:12px;line-height:1.6">'
  + (phone ? '<span>' + esc(phone) + '</span> &nbsp;|&nbsp; ' : '')
  + (website ? '<a href="https://' + esc(website) + '" style="color:' + accent + ';text-decoration:none">' + esc(website) + '</a>' : '')
  + (address ? '<br>' + esc(address) : '')
  + (footer ? '<br><span style="color:#9ca3af">' + esc(footer) + '</span>' : '')
  + (opts.footerExtra ? '<br>' + opts.footerExtra : '')
  + '</div></td></tr>'
  + '</table></td></tr></table>';
}

// ── SHARE FOLDER EMAIL ────────────────────────────────────────────────────
async function spSendShareEmail(cjId, linkUrl, expiryStr, overrideTo, overrideSubject) {
  var cj = CLIENT_JOBS.filter(function(x){ return x.id === cjId; })[0];
  if (!cj) return;
  var mm      = MOVE_MANAGERS.filter(function(m){ return m.name === cj.moveManager; })[0];
  var mmEmail = mm ? (mm.email||'') : '';
  var toEmail = overrideTo || mmEmail;
  if (!toEmail) { toast('No email address for move manager — add one in Settings → Move Managers'); return; }

  var clientName  = cj.clientName   || '—';
  var partnerRef  = cj.partnerRef   || cj.clientRef || '—';
  var ourRef      = cj.masterJobId  || '—';
  var brand       = cj.brand        || '—';
  var mmName      = mm ? mm.name : (cj.moveManager||'Move Manager');
  var subject = overrideSubject || ('Documents: ' + partnerRef + ' / ' + ourRef + ' — ' + clientName);

  var bodyHtml = '<p>Dear ' + esc(mmName) + ',</p>'
    + '<p>Please find the documentation folder for the following move below. You can access all job documents, upload files and track progress using the link provided.</p>'
    + '<table style="width:100%;border-collapse:collapse;margin:20px 0;font-size:14px">'
    + '<tr style="background:#f8f9fb"><td style="padding:10px 14px;border:1px solid #e8eaed;font-weight:600;width:160px;color:#374151">Client</td><td style="padding:10px 14px;border:1px solid #e8eaed;color:#1a1a2e">' + esc(clientName) + '</td></tr>'
    + '<tr><td style="padding:10px 14px;border:1px solid #e8eaed;font-weight:600;color:#374151">Your Reference</td><td style="padding:10px 14px;border:1px solid #e8eaed;color:#1a1a2e">' + esc(partnerRef) + '</td></tr>'
    + '<tr style="background:#f8f9fb"><td style="padding:10px 14px;border:1px solid #e8eaed;font-weight:600;color:#374151">Our Reference</td><td style="padding:10px 14px;border:1px solid #e8eaed;color:#1a1a2e">' + esc(ourRef) + '</td></tr>'
    + '<tr><td style="padding:10px 14px;border:1px solid #e8eaed;font-weight:600;color:#374151">Brand</td><td style="padding:10px 14px;border:1px solid #e8eaed;color:#1a1a2e">' + esc(brand) + '</td></tr>'
    + '<tr style="background:#f8f9fb"><td style="padding:10px 14px;border:1px solid #e8eaed;font-weight:600;color:#374151">Move Manager</td><td style="padding:10px 14px;border:1px solid #e8eaed;color:#1a1a2e">' + esc(mmName) + '</td></tr>'
    + '</table>'
    + '<p style="color:#6b7280;font-size:13px">The folder link expires on <strong>' + esc(expiryStr) + '</strong> and is view-only. Please contact us if you need to upload documents directly.</p>'
    + '<p>If you have any questions please reply to this email.</p>'
    + '<p>Kind regards,<br><strong>' + esc(APP_SETTINGS.companyName||'Onwards') + ' Operations</strong></p>';

  var html = buildEmailHtml({
    subject,
    preheader: 'Documents available for ' + clientName + ' (' + partnerRef + ')',
    bodyHtml,
    ctaUrl:   linkUrl,
    ctaLabel: '📁 View Document Folder'
  });

  toast('Sending email…');
  var res = await sendEmail({ to: toEmail, subject, html, replyTo: APP_SETTINGS.emailReplyTo });
  if (res.ok) {
    toast('✅ Email sent to ' + toEmail);
  } else {
    toast('❌ Email failed: ' + (res.error||'Unknown error'));
  }
}


// ═══════════════════════════════════════════════════════════════════════════
// CALENDAR INVITES — GRAPH API CREATE EVENT IN MOVE MANAGER'S OUTLOOK
// ═══════════════════════════════════════════════════════════════════════════

async function createMoveManagerCalendarEvent(cj, movs) {
  if (!movs || !movs.length) return;
  var mm = MOVE_MANAGERS.filter(function(m){ return m.name === cj.moveManager; })[0];
  if (!mm || !mm.email) return;

  var firstMov     = movs[0];
  var jobType      = firstMov.jobType || firstMov.type || 'Job';
  var clientName   = cj.clientName  || '';
  var partnerRef   = cj.partnerRef  || cj.clientRef || '';
  var ourRef       = cj.masterJobId || '';
  var jobDate      = firstMov.start || cj.startDate || '';
  if (!jobDate) return;

  // Build event title and body
  var title = jobType + ' — ' + clientName + (partnerRef ? ' (' + partnerRef + ')' : '');
  var bodyText = [
    'Job confirmed by ' + (APP_SETTINGS.companyName||'Onwards') + ' Operations.',
    '',
    'Client:         ' + clientName,
    'Partner Ref:    ' + (partnerRef||'—'),
    'Our Ref:        ' + (ourRef||'—'),
    'Brand:          ' + (cj.brand||'—'),
    'Type:           ' + jobType,
    'Origin:         ' + (firstMov.origin||'—'),
    'Destination:    ' + (firstMov.dest||'—'),
    (cj.spFolderUrl ? 'Documents:      ' + cj.spFolderUrl : '')
  ].filter(Boolean).join('\n');

  // Build start/end — full day event starting at 08:00, ending at 18:00
  var startDt = jobDate + 'T08:00:00';
  var endDt   = jobDate + 'T18:00:00';

  var eventPayload = {
    subject: title,
    body: { contentType: 'Text', content: bodyText },
    start: { dateTime: startDt, timeZone: 'Europe/London' },
    end:   { dateTime: endDt,   timeZone: 'Europe/London' },
    location: { displayName: firstMov.origin || '' },
    attendees: [{
      emailAddress: { address: mm.email, name: mm.name },
      type: 'required'
    }],
    isOrganizer: true,
    showAs: 'busy'
  };

  try {
    var res = await fetch('/api/graph', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'createCalendarEvent', payload: eventPayload, userEmail: mm.email })
    });
    var data = await res.json();
    if (data.id) {
      console.log('Calendar event created for', mm.email, data.id);
      // Store event ID on client job for future updates/cancellations
      if (!cj.calendarEvents) cj.calendarEvents = [];
      cj.calendarEvents.push({ mmEmail: mm.email, eventId: data.id, jobDate });
      saveData('clientjob', cj.id, cj);
    } else {
      console.warn('Calendar event failed:', data.error || JSON.stringify(data));
    }
  } catch(e) {
    console.warn('Calendar event error:', e.message);
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// CONTACT SYNC — SYNC CLIENT + PARTNER CONTACTS TO M365
// ═══════════════════════════════════════════════════════════════════════════

async function syncContactToM365(opts) {
  // opts: { displayName, email, phone, company, notes, jobRef }
  if (!opts.email && !opts.displayName) return;
  try {
    var res = await fetch('/api/graph', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'upsertContact', payload: opts })
    });
    var data = await res.json();
    if (data.id) console.log('Contact synced:', opts.displayName, data.id);
    else console.warn('Contact sync failed:', data.error || JSON.stringify(data));
  } catch(e) {
    console.warn('Contact sync error:', e.message);
  }
}

// Called after job is saved — sync client contact and move manager to M365
function syncJobContacts(cj) {
  if (!cj) return;
  // Sync client contact
  if (cj.clientEmail || cj.clientName) {
    setTimeout(function() {
      syncContactToM365({
        displayName: cj.clientName || '',
        email:       cj.clientEmail || '',
        phone:       cj.clientPhone || '',
        company:     cj.brand || '',
        notes:       'OpsManager client — ' + (cj.masterJobId||cj.id),
        jobRef:      cj.masterJobId || ''
      });
    }, 2000);
  }
  // Sync move manager contact
  var mm = MOVE_MANAGERS.filter(function(m){ return m.name === cj.moveManager; })[0];
  if (mm && mm.email) {
    setTimeout(function() {
      syncContactToM365({
        displayName: mm.name || '',
        email:       mm.email || '',
        phone:       mm.phone || '',
        company:     mm.brand || cj.brand || '',
        notes:       'Move Manager — ' + (mm.brand||''),
        jobRef:      ''
      });
    }, 3000);
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// BOOKING PARSER — CLAUDE AI EXTRACTS BOOKING FROM EMAIL/PDF/DOC
// ═══════════════════════════════════════════════════════════════════════════

function openBookingParser() {
  var existing = document.getElementById('booking-parser-modal');
  if (existing) existing.remove();

  var modal = document.createElement('div');
  modal.id = 'booking-parser-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:950;display:flex;align-items:center;justify-content:center;padding:20px';
  modal.innerHTML = '<div style="background:#fff;border-radius:14px;padding:0;width:100%;max-width:640px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-height:92vh;overflow:hidden;display:flex;flex-direction:column">'
    // Header
    + '<div style="padding:20px 24px 16px;border-bottom:1px solid #e8eaed;display:flex;align-items:center;justify-content:space-between;flex-shrink:0">'
    + '<div><div style="font-size:16px;font-weight:800;color:#1a1a2e">🤖 Parse Booking from Email or Document</div>'
    + '<div style="font-size:12px;color:#6b7280;margin-top:3px">Paste email text, or drop a PDF/Word/Excel file — Claude will extract the booking details</div></div>'
    + '<button onclick="document.getElementById(\'booking-parser-modal\').remove()" style="width:30px;height:30px;border-radius:7px;border:1px solid #e3e7f0;background:#f5f5f5;cursor:pointer;font-size:16px;flex-shrink:0">✕</button>'
    + '</div>'
    // Drop zone + textarea
    + '<div style="padding:20px 24px;flex:1;overflow-y:auto">'
    + '<div id="bp-dropzone" style="border:2px dashed #d1d5db;border-radius:10px;padding:20px;text-align:center;cursor:pointer;margin-bottom:16px;transition:border-color .2s;background:#fafafa"'
    + ' ondragover="event.preventDefault();this.style.borderColor=&quot;#0073EA&quot;"'
    + ' ondragleave="this.style.borderColor=&quot;#d1d5db&quot;"'
    + ' ondrop="bpHandleDrop(event)" onclick="document.getElementById(&quot;bp-file-input&quot;).click()">'
    + '<div style="font-size:24px;margin-bottom:8px">📄</div>'
    + '<div style="font-size:13px;font-weight:600;color:#374151">Drop PDF, Word or Excel file here</div>'
    + '<div style="font-size:11px;color:#9ca3af;margin-top:4px">or click to browse</div>'
    + '<input type="file" id="bp-file-input" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.eml" style="display:none" onchange="bpHandleFile(this.files[0])">'
    + '</div>'
    + '<textarea id="bp-text" placeholder="Paste the email body or booking instruction text here..." rows="10" style="width:100%;padding:12px;border:1.5px solid #e3e7f0;border-radius:8px;font-size:13px;resize:vertical;box-sizing:border-box;font-family:inherit;line-height:1.6"></textarea>'
    + '<div id="bp-file-name" style="font-size:11px;color:#6b7280;margin-top:6px;display:none"></div>'
    + '</div>'
    // Footer
    + '<div style="padding:16px 24px;border-top:1px solid #e8eaed;display:flex;gap:10px;justify-content:flex-end;flex-shrink:0">'
    + '<button onclick="document.getElementById(&quot;booking-parser-modal&quot;).remove()" style="padding:10px 18px;border:1.5px solid #e3e7f0;border-radius:7px;background:#fff;font-size:13px;font-weight:600;cursor:pointer">Cancel</button>'
    + '<button id="bp-parse-btn" onclick="bpRunParse()" style="padding:10px 24px;border:none;border-radius:7px;background:#0073EA;color:#fff;font-size:13px;font-weight:700;cursor:pointer">🤖 Extract Booking Details</button>'
    + '</div></div>';

  document.body.appendChild(modal);
}

var _bpFileContent = null;
var _bpFileName    = null;

function bpHandleDrop(e) {
  e.preventDefault();
  document.getElementById('bp-dropzone').style.borderColor = '#d1d5db';
  var file = e.dataTransfer.files[0];
  if (file) bpHandleFile(file);
}

function bpHandleFile(file) {
  if (!file) return;
  _bpFileName = file.name;
  document.getElementById('bp-file-name').style.display = 'block';
  document.getElementById('bp-file-name').textContent = '📎 ' + file.name + ' (' + Math.round(file.size/1024) + ' KB)';

  var reader = new FileReader();
  reader.onload = function(e) {
    _bpFileContent = e.target.result.split(',')[1]; // base64
  };
  reader.readAsDataURL(file);
}

async function bpRunParse() {
  var textInput = (document.getElementById('bp-text')||{}).value || '';
  var btn = document.getElementById('bp-parse-btn');
  if (!textInput.trim() && !_bpFileContent) { toast('Please paste some text or attach a file'); return; }

  btn.disabled = true;
  btn.textContent = '⏳ Reading…';

  try {
    var messages = [];
    var systemPrompt = 'You are a booking extraction assistant for a removals and logistics company. '
      + 'Extract structured booking data from emails, PDFs or documents. '
      + 'Return ONLY valid JSON — no markdown, no explanation. '
      + 'If a field is not found, use null. '
      + 'Dates must be YYYY-MM-DD format. '
      + 'JSON schema: {'
      + '"clientName":string,"clientEmail":string,"clientPhone":string,'
      + '"partnerRef":string,"brand":string,"moveManager":string,'
      + '"jobType":string,"startDate":string,"endDate":string,'
      + '"origin":string,"originPostcode":string,"dest":string,"destPostcode":string,'
      + '"volumeFt":number,"volumeCbm":number,'
      + '"specialRequirements":string,"notes":string,'
      + '"confidence":"high"|"medium"|"low"'
      + '}';

    if (_bpFileContent && _bpFileName) {
      var ext = (_bpFileName||'').split('.').pop().toLowerCase();
      var mediaType = ext === 'pdf' ? 'application/pdf'
        : (ext === 'docx' ? 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
        : (ext === 'xlsx' ? 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        : 'text/plain'));

      if (ext === 'pdf') {
        messages.push({ role: 'user', content: [
          { type: 'document', source: { type: 'base64', media_type: mediaType, data: _bpFileContent } },
          { type: 'text', text: 'Extract all booking details from this document and return as JSON.' + (textInput ? '\nAdditional context:\n' + textInput : '') }
        ]});
      } else {
        // For non-PDF files, send as base64 text with filename context
        messages.push({ role: 'user', content: 'Extract booking details from this file (' + _bpFileName + '). File content (base64): ' + _bpFileContent.slice(0, 8000) + (textInput ? '\n\nAdditional email text:\n' + textInput : '') });
      }
    } else {
      messages.push({ role: 'user', content: 'Extract booking details from this email/text:\n\n' + textInput });
    }

    var res = await fetch('/api/claude', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 2000, system: systemPrompt, messages })
    });

    var data = await res.json();
    if (!res.ok || !data.content) {
      throw new Error(data.error || 'Claude API error ' + res.status);
    }

    var rawText = data.content[0].text || '';
    var cleaned = rawText.replace(/```json|```/g, '').trim();
    var parsed;
    try { parsed = JSON.parse(cleaned); } catch(e) { throw new Error('Could not parse Claude response: ' + rawText.slice(0,200)); }

    document.getElementById('booking-parser-modal').remove();
    bpApplyToBookingForm(parsed);

  } catch(err) {
    toast('❌ Parse failed: ' + err.message);
    btn.disabled = false;
    btn.textContent = '🤖 Extract Booking Details';
  }
}

function bpApplyToBookingForm(parsed) {
  if (!parsed) return;

  // Open new booking flow with pre-filled data
  // Store parsed data globally so cfgInit can pick it up
  window._bpParsed = parsed;

  // Determine route type from job type
  var jt = (parsed.jobType||'').toLowerCase();
  var routeKey = jt.includes('door') || jt.includes('d2d') || jt.includes('domestic') ? 'd2d'
    : (jt.includes('destination') || jt.includes('delivery') ? 'destination'
    : (jt.includes('storage') || jt.includes('ex store') ? 'storage' : 'origin'));

  // Open booking flow
  newClientJob();
  toast('✅ Booking details extracted — review and confirm below');

  // Apply fields after a short delay for form to render
  setTimeout(function() {
    var p = window._bpParsed;
    if (!p) return;

    function setField(id, val) { var e = document.getElementById(id); if (e && val) e.value = val; }
    function setSelect(id, val) {
      var e = document.getElementById(id);
      if (e && val) {
        for (var i = 0; i < e.options.length; i++) {
          if (e.options[i].value.toLowerCase().includes(val.toLowerCase()) || val.toLowerCase().includes(e.options[i].value.toLowerCase())) {
            e.selectedIndex = i; break;
          }
        }
      }
    }

    setField('bk-client',  p.clientName);
    setField('bk-email',   p.clientEmail);
    setField('bk-phone',   p.clientPhone);
    setField('bk-ref',     p.partnerRef);
    setField('bk-origin',  p.origin);
    setField('bk-dest',    p.dest);
    setField('bk-start',   p.startDate);
    setField('bk-end',     p.endDate);
    setField('bk-notes',   p.notes || p.specialRequirements);
    if (p.volumeFt)  setField('bk-vol-ft',  p.volumeFt);
    if (p.volumeCbm) setField('bk-vol-cbm', p.volumeCbm);
    if (p.brand)     setSelect('bk-brand',  p.brand);
    if (p.moveManager) setSelect('bk-mm',   p.moveManager);

    // Show confidence indicator
    var conf = p.confidence || 'medium';
    var confColor = conf === 'high' ? '#00C875' : conf === 'medium' ? '#FF9F1A' : '#e44258';
    var confMsg = conf === 'high' ? 'High confidence — most fields extracted cleanly'
      : conf === 'medium' ? 'Medium confidence — please review highlighted fields carefully'
      : 'Low confidence — manual review recommended for all fields';
    toast(confColor === '#00C875' ? '✅ ' + confMsg : '⚠ ' + confMsg, 5000);

    window._bpParsed = null;
  }, 800);
}


// ── TWILIO SMS / WHATSAPP / VOICE ────────────────────────────────────────
async function sendSms(opts) {
  // opts: { to, body, action ('sendSms'|'sendWhatsApp'|'makeCall'), twiml }
  try {
    var res = await fetch('/api/twilio', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: opts.action || 'sendSms',
        to:     opts.to,
        body:   opts.body || '',
        twiml:  opts.twiml || ''
      })
    });
    var data = await res.json();
    return data.ok ? { ok: true, sid: data.sid } : { ok: false, error: data.error || 'SMS failed' };
  } catch(e) {
    return { ok: false, error: e.message };
  }
}

async function saveCommsSettings() {
  var pc = el('sl-postcode');
  if (pc) SL_CONFIG.companyPostcode = pc.value.trim();
  toast('Settings saved');
  saveData('settings');
}



function autoCalcMileageAndRefresh(jobId) {
  var j = jobs.filter(function(x){ return x.id === jobId; })[0];
  if (!j) return;
  if (!mapsApiLoaded()) { toast('Google Maps not loaded — check API key in Settings'); return; }
  toast('Calculating route via Google Maps…');
  autoCalcMileage(j, function(miles) {
    if (miles) {
      toast('✅ Mileage set: ' + miles + ' mi (origin → destination)');
      renderActiveMod();
    } else {
      toast('❌ Could not calculate — check origin/destination addresses');
    }
  });
}

// ── AUTO MILEAGE CALCULATION ─────────────────────────────────────────────
// Called after job save — uses Google Maps Distance Matrix to get origin→dest miles
// Stores j.mileage (origin→dest only; warehouse legs are added dynamically in costing)
function autoCalcMileage(job, cb) {
  if (job.mileage) { if (cb) cb(job.mileage); return; } // already set
  if (!job.origin)  { if (cb) cb(0); return; }
  if (!mapsApiLoaded()) { if (cb) cb(0); return; }

  var origin = job.origin;
  var dest   = job.dest || '';
  if (!dest || dest === origin) { if (cb) cb(0); return; }

  var svc = new google.maps.DistanceMatrixService();
  svc.getDistanceMatrix({
    origins:      [origin],
    destinations: [dest],
    travelMode:   google.maps.TravelMode.DRIVING,
    unitSystem:   google.maps.UnitSystem.IMPERIAL
  }, function(resp, status) {
    if (status !== 'OK') { if (cb) cb(0); return; }
    try {
      var metres = resp.rows[0].elements[0].distance.value;
      var miles  = Math.round(metres / 1609.34);
      job.mileage = miles;
      saveData('job', job.id, job);
      console.log('Auto mileage set:', origin, '→', dest, '=', miles, 'mi');
      if (cb) cb(miles);
    } catch(e) { if (cb) cb(0); }
  });
}

// Calculate full journey mileage via Google Maps (multi-stop)
// Calls cb with total miles. Also stores individual leg mileages on jobs.
function autoCalcJourneyMileage(jrn, cb) {
  if (!mapsApiLoaded()) { if (cb) cb(0); return; }
  var jjobs = jobsInJourney(jrn.id);
  if (!jjobs.length) { if (cb) cb(0); return; }

  var wh = APP_SETTINGS.warehouseAddress || SL_CONFIG.companyPostcode || 'WN73EQ';

  // Build waypoints: warehouse → origins/dests in order → warehouse
  var waypoints = [wh];
  var byDay = {};
  var allDays = [];
  for (var i = 0; i < jjobs.length; i++) {
    var day = jjobs[i].start || '';
    if (!byDay[day]) { byDay[day] = []; allDays.push(day); }
    byDay[day].push(jjobs[i]);
  }
  allDays.sort();
  for (var d = 0; d < allDays.length; d++) {
    var dayJobs = byDay[allDays[d]];
    for (var i = 0; i < dayJobs.length; i++) {
      if (dayJobs[i].origin) waypoints.push(dayJobs[i].origin);
      if (dayJobs[i].dest)   waypoints.push(dayJobs[i].dest);
    }
  }
  waypoints.push(wh);

  // Distance Matrix: each consecutive pair
  var pairs = [];
  for (var i = 0; i < waypoints.length - 1; i++) {
    if (waypoints[i] !== waypoints[i+1]) {
      pairs.push({ from: waypoints[i], to: waypoints[i+1] });
    }
  }

  if (!pairs.length) { if (cb) cb(0); return; }

  var svc = new google.maps.DistanceMatrixService();
  var origins = pairs.map(function(p){ return p.from; });
  var dests   = pairs.map(function(p){ return p.to;   });

  svc.getDistanceMatrix({
    origins: origins, destinations: dests,
    travelMode: google.maps.TravelMode.DRIVING,
    unitSystem: google.maps.UnitSystem.IMPERIAL
  }, function(resp, status) {
    if (status !== 'OK') { if (cb) cb(0); return; }
    var total = 0;
    try {
      for (var i = 0; i < pairs.length; i++) {
        var el = resp.rows[i].elements[i]; // diagonal — each row has one dest
        if (el && el.status === 'OK') total += Math.round(el.distance.value / 1609.34);
      }
      if (cb) cb(total);
    } catch(e) { if (cb) cb(0); }
  });
}

// ═══════════════════════════════════════════════════════════════════════════
// SHAREPOINT + APPENATE — FULL INTEGRATION
// ═══════════════════════════════════════════════════════════════════════════

// ── DOCUMENT CHECKLIST DEFINITION ────────────────────────────────────────
// timing: 'before' = required before job date, 'after' = expected after job
// required: true = counts toward red/amber indicator
// jobTypes: which job types this applies to (empty = all)

var SP_CHECKLIST = [
  { slug:'survey',        label:'Survey & Quote',          folder:'01 — Survey & Quote',          icon:'📋', timing:'before', required:true,  jobTypes:['Origin Sea Pack','Origin Air Pack','Origin Road Pack','Door to Door','Destination Services','Ex Store Delivery','Blanket Wrap','Handling Only'] },
  { slug:'auth',          label:'Authorisation & Booking', folder:'02 — Authorisation & Booking', icon:'✅', timing:'before', required:true,  jobTypes:[] },
  { slug:'jobpaperwork',  label:'Job Paperwork',           folder:'03 — Job Paperwork',           icon:'📄', timing:'before', required:true,  jobTypes:[] },
  { slug:'inventory',     label:'Inventory & Packing',     folder:'04 — Inventory & Packing Lists',icon:'📦', timing:'mixed',  required:false, jobTypes:[] },
  { slug:'images',        label:'Images',                  folder:'05 — Images',                  icon:'🖼',  timing:'after',  required:false, jobTypes:[] },
  { slug:'invoices',      label:'Invoices & Finance',      folder:'06 — Invoices & Finance',      icon:'💷', timing:'after',  required:false, jobTypes:[] },
  { slug:'pod',           label:'POD & Completion',        folder:'07 — POD & Completion',        icon:'🖊',  timing:'after',  required:false, jobTypes:[] },
  { slug:'aftersales',   label:'Aftersales & Quality',    folder:'08 — Aftersales & Quality',    icon:'⭐',  timing:'after',  required:false, jobTypes:[] },
];

// Inventory timing rule: 'before' for destination/ex-store, 'after' for origin/D2D
function spInventoryTiming(jobType) {
  var destTypes = ['Destination Services','Ex Store Delivery'];
  return destTypes.indexOf(jobType) >= 0 ? 'before' : 'after';
}

// ── DOC READINESS for calendar indicator ─────────────────────────────────
function spDocReadiness(cj, jobDateStr) {
  if (!cj.spFolderId) {
    return { cls:'grey', icon:'📁', tip:'No SharePoint folder created' };
  }
  var checklist = cj.docChecklist || {};
  var jobDate = jobDateStr ? new Date(jobDateStr + 'T00:00:00') : null;
  var today = new Date(); today.setHours(0,0,0,0);
  var daysToJob = jobDate ? Math.round((jobDate - today) / 86400000) : 999;
  var jobType = cj.jobType || '';

  var missingRequired = [];
  var missingAfter = [];

  SP_CHECKLIST.forEach(function(item) {
    // Skip if N/A
    if (checklist[item.slug] === 'na') return;
    // Check job type filter
    if (item.jobTypes.length && item.jobTypes.indexOf(jobType) < 0) return;

    var timing = item.slug === 'inventory' ? spInventoryTiming(jobType) : item.timing;
    var status = checklist[item.slug];
    var fileCount = (cj.spFileCounts && cj.spFileCounts[item.slug]) || 0;
    var hasFiles = fileCount > 0 || status === 'received';

    if (timing === 'before' && !hasFiles) {
      missingRequired.push(item.label);
    }
    if (timing === 'after' && jobDate && today > jobDate && !hasFiles) {
      missingAfter.push(item.label);
    }
  });

  if (missingRequired.length > 0 && daysToJob <= 7) {
    return { cls:'red', icon:'🔴', tip:'AT RISK: Missing before job — ' + missingRequired.join(', ') };
  }
  if (missingRequired.length > 0) {
    return { cls:'amber', icon:'🟡', tip:'Outstanding: ' + missingRequired.join(', ') };
  }
  if (missingAfter.length > 0) {
    return { cls:'amber', icon:'🟡', tip:'Post-job docs outstanding: ' + missingAfter.join(', ') };
  }
  return { cls:'green', icon:'🟢', tip:'All required documents received' };
}

// ── SP CHECKLIST RENDER ───────────────────────────────────────────────────
function spDocChecklist(cj) {
  var checklist = cj.docChecklist || {};
  var jobType = cj.jobType || '';
  var today = new Date(); today.setHours(0,0,0,0);
  var h = '<div>';

  SP_CHECKLIST.forEach(function(item) {
    var timing = item.slug === 'inventory' ? spInventoryTiming(jobType) : item.timing;
    var override = checklist[item.slug];
    var fileCount = (cj.spFileCounts && cj.spFileCounts[item.slug]) || 0;
    var isNA = override === 'na';
    var isReceived = override === 'received' || fileCount > 0;

    // Status
    var statusCls, statusLbl;
    if (isNA) { statusCls = 'na'; statusLbl = 'N/A'; }
    else if (isReceived) { statusCls = 'received'; statusLbl = '✓ Received'; }
    else if (timing === 'before') { statusCls = 'outstanding'; statusLbl = 'Outstanding'; }
    else if (timing === 'after') { statusCls = 'after'; statusLbl = 'After job'; }
    else { statusCls = 'outstanding'; statusLbl = 'Awaiting'; }

    h += '<div class="sp-checklist-row' + (isNA ? '" style="opacity:.45' : '') + '">';
    h += '<div class="sp-cl-icon">' + item.icon + '</div>';
    h += '<div class="sp-cl-name">' + esc(item.label) + '</div>';
    if (fileCount) h += '<div class="sp-cl-count">' + fileCount + ' file' + (fileCount!==1?'s':'') + '</div>';
    h += '<div class="sp-cl-status ' + statusCls + '">' + statusLbl + '</div>';
    h += '<div class="sp-cl-actions">';
    if (cj.spFolderId) {
      h += '<button class="btn btn-s" style="padding:2px 7px;font-size:10.5px" onclick="spUploadToFolder(\''+cj.id+'\',\''+item.slug+'\',\''+esc(item.folder)+'\')">⬆</button>';
      h += '<button class="btn btn-s" style="padding:2px 7px;font-size:10.5px;color:'+(isNA?'var(--green)':'var(--t3)')+'" onclick="spToggleNA(\''+cj.id+'\',\''+item.slug+'\')" title="'+(isNA?'Mark as required':'Mark as not needed')+'">'+(isNA?'↩ Undo N/A':'N/A')+'</button>';
    }
    h += '</div></div>';
  });

  // Upload zone
  if (cj.spFolderId) {
    h += '<div class="sp-upload-zone" onclick="spUploadFile(\''+cj.id+'\')" ondragover="event.preventDefault()" ondrop="spHandleDrop(event,\''+cj.id+'\')">';
    h += '<div style="font-size:22px;margin-bottom:6px">⬆️</div>';
    h += '<div style="font-size:12.5px;font-weight:600;color:var(--t2)">Drop files here or click to upload</div>';
    h += '<div style="font-size:11px;color:var(--t3);margin-top:3px">Word, PDF, images, spreadsheets supported</div>';
    h += '</div>';
  }

  h += '</div>';
  return h;
}

// ── SP API HELPERS ────────────────────────────────────────────────────────
async function spCall(action, payload) {
  var res = await fetch('/api/sharepoint', {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: action, payload: payload || {} })
  });
  var text = await res.text();
  try { return JSON.parse(text); } catch(e) { return { error: text }; }
}

// Cache site/drive IDs so we don't re-fetch every time
var _spSiteId  = '';
var _spDriveId = '';

async function spTestConnection() {
  toast('Testing SharePoint connection…');
  var res = await spCall('testConnection', {});
  console.log('SharePoint test result:', res);
  if (res.siteStatus === 200) {
    toast('✅ SharePoint connected! Site: ' + (res.siteResponse && res.siteResponse.displayName || 'OK'));
  } else if (res.siteStatus === 401) {
    toast('❌ Unauthorised — check SP_CLIENT_ID and SP_CLIENT_SECRET in Azure');
  } else if (res.siteStatus === 403) {
    toast('❌ Forbidden — Sites.ReadWrite.All permission needs admin consent in Entra ID');
  } else if (res.siteStatus === 404) {
    toast('❌ Site not found — check SP_SITE_URL is correct');
  } else if (res.error) {
    toast('❌ ' + res.error);
  } else {
    toast('❌ Unexpected response (' + res.siteStatus + ') — check browser console');
  }
}

async function spGetSiteAndDrive() {
  if (_spSiteId && _spDriveId) return { siteId: _spSiteId, driveId: _spDriveId };
  // Get site ID
  var siteRes = await spCall('getSiteId', {});
  if (!siteRes.id) {
    var errDetail = (siteRes.error && siteRes.error.message) || (siteRes.error) || JSON.stringify(siteRes);
    toast('SharePoint error: ' + errDetail);
    console.error('SharePoint getSiteId response:', siteRes);
    return null;
  }
  _spSiteId = siteRes.id;
  // Get drive ID (Shared Documents = default drive)
  var drivesRes = await spCall('getDriveId', { siteId: _spSiteId });
  var drives = (drivesRes.value || []);
  var drive = drives.filter(function(d){ return d.name === 'Documents' || d.name === 'Shared Documents'; })[0] || drives[0];
  if (!drive) { toast('SharePoint: Could not find document library'); return null; }
  _spDriveId = drive.id;
  return { siteId: _spSiteId, driveId: _spDriveId };
}

function spBrandFolder(brand) {
  var bd = BRAND_DATA.filter(function(b){ return b.name === brand; })[0];
  return bd && bd.spFolder ? bd.spFolder : '';
}

function spFolderName(cj) {
  var ref = cj.partnerRef || cj.clientRef || '';
  var ourRef = cj.masterJobId || '';
  var client = cj.clientName || '';
  if (ref && ourRef) return ref + ' — ' + ourRef + ' — ' + client;
  if (ourRef) return ourRef + ' — ' + client;
  return client || 'Unknown';
}

// ── CREATE SHAREPOINT FOLDER ─────────────────────────────────────────────
async function spCreateFolder(cjId) {
  var cj = CLIENT_JOBS.filter(function(x){ return x.id === cjId; })[0];
  if (!cj) return;

  var brandFolder = spBrandFolder(cj.brand);
  if (!brandFolder) {
    toast('No SharePoint folder configured for brand "' + cj.brand + '" — set it in Settings → Brands');
    return;
  }
  if (!(cj.partnerRef || cj.clientRef)) {
    toast('Add the partner reference before creating the SharePoint folder');
    return;
  }

  var btn = event && event.target;
  if (btn) { btn.disabled = true; btn.textContent = '⏳ Creating…'; }
  toast('Creating SharePoint folder…');

  var sd = await spGetSiteAndDrive();
  if (!sd) { if(btn){btn.disabled=false;btn.textContent='📁 Create SharePoint Folder';} return; }

  var topFolderName = spFolderName(cj);
  var basePath = 'Partners/' + brandFolder;

  // Create top-level job folder
  var topRes = await spCall('createFolder', {
    siteId: sd.siteId, driveId: sd.driveId,
    parentPath: basePath,
    folderName: topFolderName
  });
  if (!topRes.id) {
    toast('Failed to create folder: ' + (topRes.error || JSON.stringify(topRes)));
    if(btn){btn.disabled=false;btn.textContent='📁 Create SharePoint Folder';}
    return;
  }

  var jobFolderPath = basePath + '/' + topFolderName;

  // Create all 8 sub-folders using parent folder ID (avoids encoding issues with special chars)
  var subFolders = SP_CHECKLIST.map(function(item){ return item.folder; });
  var parentFolderId = topRes.id;
  console.log('Creating sub-folders, parentFolderId:', parentFolderId, 'siteId:', sd.siteId, 'driveId:', sd.driveId);
  var failedFolders = [];
  for (var i = 0; i < subFolders.length; i++) {
    var sfRes = await spCall('createFolderById', {
      siteId: sd.siteId, driveId: sd.driveId,
      parentId: parentFolderId,
      folderName: subFolders[i]
    });
    console.log('Sub-folder', subFolders[i], ':', sfRes.id ? 'OK' : 'FAILED', sfRes.error || '');
    if (!sfRes.id) failedFolders.push(subFolders[i]);
  }
  if (failedFolders.length) {
    toast('⚠ Top folder created but ' + failedFolders.length + ' sub-folders failed: ' + failedFolders[0] + '... — check browser console');
  }

  // Store folder details on client record
  cj.spFolderId   = topRes.id;
  cj.spFolderUrl  = topRes.webUrl;
  cj.spFolderPath = jobFolderPath;
  cj.spSiteId     = sd.siteId;
  cj.spDriveId    = sd.driveId;
  saveData('clientjob', cj.id, cj);

  toast('✅ SharePoint folder created with 7 sub-folders');
  if (curMod === 'bookings') renderClientJobDetail(cj);
}

// ── UPLOAD FILE ───────────────────────────────────────────────────────────
function spUploadFile(cjId) {
  var input = document.createElement('input');
  input.type = 'file';
  input.multiple = true;
  input.accept = '.pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.webp,.heic';
  input.onchange = function() { spHandleFiles(cjId, input.files, null); };
  input.click();
}

function spUploadToFolder(cjId, slug, folderName) {
  var input = document.createElement('input');
  input.type = 'file';
  input.multiple = true;
  input.accept = '.pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.webp,.heic';
  input.onchange = function() { spHandleFiles(cjId, input.files, folderName); };
  input.click();
}

function spHandleDrop(event, cjId) {
  event.preventDefault();
  spHandleFiles(cjId, event.dataTransfer.files, null);
}

async function spHandleFiles(cjId, files, targetFolder) {
  var cj = CLIENT_JOBS.filter(function(x){ return x.id === cjId; })[0];
  if (!cj || !cj.spFolderId) { toast('No SharePoint folder linked to this job'); return; }
  if (!files || !files.length) return;

  // If no target folder specified, show folder picker
  if (!targetFolder) {
    targetFolder = await spPickFolder();
    if (!targetFolder) return;
  }

  var folderPath = cj.spFolderPath + '/' + targetFolder;
  toast('Uploading ' + files.length + ' file(s)…');

  for (var i = 0; i < files.length; i++) {
    var file = files[i];
    var reader = new FileReader();
    await new Promise(function(resolve) {
      reader.onload = async function(e) {
        var base64 = e.target.result.split(',')[1];
        // Find the sub-folder ID by listing the job folder children
        var subFolderId = null;
        var children = await spCall('getFolderChildren', { siteId: cj.spSiteId, driveId: cj.spDriveId, itemId: cj.spFolderId });
        if (children.value) {
          var match = children.value.filter(function(x){ return x.name === targetFolder; })[0];
          if (match) subFolderId = match.id;
        }
        var res = await spCall('uploadFile', {
          siteId:      cj.spSiteId,
          driveId:     cj.spDriveId,
          parentId:    subFolderId || cj.spFolderId,
          fileName:    file.name,
          fileContent: base64,
          contentType: file.type || 'application/octet-stream'
        });
        if (res.id) {
          // Write metadata
          var mm = MOVE_MANAGERS.filter(function(m){ return m.name === cj.moveManager; })[0];
          await spCall('updateMetadata', {
            siteId:  cj.spSiteId,
            driveId: cj.spDriveId,
            itemId:  res.id,
            metadata: {
              OpsJobRef:        cj.masterJobId || '',
              PartnerRef:       cj.partnerRef || cj.clientRef || '',
              ClientName:       cj.clientName || '',
              Brand:            cj.brand || '',
              MoveManager:      cj.moveManager || '',
              MoveManagerEmail: mm ? (mm.email || '') : '',
              DocumentType:     targetFolder,
              UploadedBy:       (APP_SETTINGS.userName || 'Ops Team')
            }
          });
          // Mark checklist item as received
          var matchItem = SP_CHECKLIST.filter(function(it){ return it.folder === targetFolder; })[0];
          if (matchItem) {
            if (!cj.docChecklist) cj.docChecklist = {};
            cj.docChecklist[matchItem.slug] = 'received';
            if (!cj.spFileCounts) cj.spFileCounts = {};
            cj.spFileCounts[matchItem.slug] = (cj.spFileCounts[matchItem.slug] || 0) + 1;
            saveData('clientjob', cj.id, cj);
          }
        }
        resolve();
      };
      reader.readAsDataURL(file);
    });
  }

  toast('✅ ' + files.length + ' file(s) uploaded to SharePoint');
  if (curMod === 'bookings') renderClientJobDetail(cj);
}

function spPickFolder() {
  return new Promise(function(resolve) {
    var opts = SP_CHECKLIST.map(function(item, i) {
      return '<option value="'+esc(item.folder)+'">'+esc(item.label)+'</option>';
    }).join('');
    var modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:900;display:flex;align-items:center;justify-content:center';
    modal.innerHTML = '<div style="background:#fff;border-radius:12px;padding:24px;width:320px;box-shadow:0 20px 60px rgba(0,0,0,.2)">'
      + '<div style="font-size:14px;font-weight:700;margin-bottom:12px">Select document type</div>'
      + '<select id="_sp_folder_pick" style="width:100%;padding:9px;border:1.5px solid #E3E7F0;border-radius:7px;font-size:13px;margin-bottom:16px">'+opts+'</select>'
      + '<div style="display:flex;gap:8px">'
      + '<button onclick="this.closest(\'div\').parentNode.parentNode._resolve(null);this.closest(\'div\').parentNode.remove()" style="flex:1;padding:9px;border:1.5px solid #E3E7F0;border-radius:7px;background:#fff;font-size:13px;cursor:pointer">Cancel</button>'
      + '<button onclick="this.closest(\'div\').parentNode.parentNode._resolve(document.getElementById(\'_sp_folder_pick\').value);this.closest(\'div\').parentNode.remove()" style="flex:2;padding:9px;border:none;border-radius:7px;background:#0073EA;color:#fff;font-size:13px;font-weight:700;cursor:pointer">Upload →</button>'
      + '</div></div>';
    modal._resolve = resolve;
    document.body.appendChild(modal);
  });
}

// ── TOGGLE N/A on checklist item ─────────────────────────────────────────
function spToggleNA(cjId, slug) {
  var cj = CLIENT_JOBS.filter(function(x){ return x.id === cjId; })[0];
  if (!cj) return;
  if (!cj.docChecklist) cj.docChecklist = {};
  cj.docChecklist[slug] = cj.docChecklist[slug] === 'na' ? '' : 'na';
  saveData('clientjob', cj.id, cj);
  if (curMod === 'bookings') renderClientJobDetail(cj);
}

// ── SHARE FOLDER ─────────────────────────────────────────────────────────
async function spShareFolder(cjId) {
  var cj = CLIENT_JOBS.filter(function(x){ return x.id === cjId; })[0];
  if (!cj || !cj.spFolderId) { toast('No SharePoint folder linked'); return; }

  toast('Generating share link…');
  var res = await spCall('createShareLink', {
    siteId:  cj.spSiteId,
    driveId: cj.spDriveId,
    itemId:  cj.spFolderId
  });

  console.log('Share link response:', res);
  var linkUrl = res.link && res.link.webUrl ? res.link.webUrl : '';
  if (!linkUrl) {
    var errDetail = res.error || JSON.stringify(res);
    toast('Could not generate share link: ' + errDetail);
    return;
  }

  // Calculate expiry
  var expiry = new Date();
  expiry.setDate(expiry.getDate() + 90);
  var expiryStr = expiry.getDate() + ' ' + ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][expiry.getMonth()] + ' ' + expiry.getFullYear();

  // Find move manager details
  var mm = MOVE_MANAGERS.filter(function(m){ return m.name === cj.moveManager; })[0];
  var mmName  = mm ? mm.name  : (cj.moveManager || 'Move Manager');
  var mmEmail = mm ? (mm.email || '') : '';

  // Build share message
  var subject = 'Documents — ' + (cj.partnerRef||cj.clientRef||'') + ' / ' + (cj.masterJobId||'') + ' — ' + (cj.clientName||'');
  var body = 'Hi ' + mmName + ',\n\n'
    + 'Please find the documentation folder for the above move below.\n\n'
    + 'Client:           ' + (cj.clientName||'—') + '\n'
    + 'Your Reference:   ' + (cj.partnerRef||cj.clientRef||'—') + '\n'
    + 'Our Reference:    ' + (cj.masterJobId||'—') + '\n'
    + 'Brand:            ' + (cj.brand||'—') + '\n'
    + 'Move Manager:     ' + mmName + (mmEmail ? ' (' + mmEmail + ')' : '') + '\n\n'
    + 'Documents:\n→ View folder: ' + linkUrl + '\n  (Valid until ' + expiryStr + ' — view only)\n\n'
    + 'If you have any questions please reply to this email.\n\n'
    + 'Kind regards\nMoveSquad Operations';

  spShowShareModal(cjId, subject, body, linkUrl, mmEmail, expiryStr);
}

function spShowShareModal(cjId, subject, body, linkUrl, toEmail, expiryStr) {
  var existing = document.getElementById('sp-share-modal');
  if (existing) existing.remove();

  var modal = document.createElement('div');
  modal.id = 'sp-share-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:900;display:flex;align-items:center;justify-content:center;padding:20px';
  modal.innerHTML = '<div style="background:#fff;border-radius:14px;padding:24px;width:100%;max-width:560px;box-shadow:0 20px 60px rgba(0,0,0,.25);max-height:90vh;overflow-y:auto">'
    + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">'
    + '<div style="font-size:15px;font-weight:700;color:#1A2035">🔗 Share Document Folder</div>'
    + '<button onclick="document.getElementById(\'sp-share-modal\').remove()" style="width:28px;height:28px;border-radius:6px;border:1px solid #E3E7F0;background:#f5f5f5;cursor:pointer;font-size:16px">✕</button>'
    + '</div>'
    + '<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#7A849E;margin-bottom:4px">To</div>'
    + '<input id="sp-sh-to" value="'+esc(toEmail||'')+'" placeholder="recipient@email.com" style="width:100%;padding:8px 10px;border:1.5px solid #E3E7F0;border-radius:7px;font-size:13px;margin-bottom:12px;box-sizing:border-box;font-family:inherit">'
    + '<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#7A849E;margin-bottom:4px">Subject</div>'
    + '<input id="sp-sh-subj" value="'+esc(subject)+'" style="width:100%;padding:8px 10px;border:1.5px solid #E3E7F0;border-radius:7px;font-size:13px;margin-bottom:12px;box-sizing:border-box;font-family:inherit">'
    + '<div style="font-size:10.5px;color:#7A849E;margin-bottom:12px">📧 A fully branded HTML email will be sent from <strong>' + esc(APP_SETTINGS.companyEmail||'updates@onwards.network') + '</strong></div>'
    + '<div style="font-size:10.5px;color:#7A849E;margin-top:6px">⏰ Link expires '+esc(expiryStr)+' — view only, no sign-in required</div>'
    + '<div style="display:flex;gap:8px;margin-top:16px">'
    + '<button onclick="navigator.clipboard.writeText(\''+linkUrl.replace(/'/g,"\\'")+'\'  );toast(\'Link copied to clipboard\')" style="flex:1;padding:10px;border:1.5px solid #E3E7F0;border-radius:7px;background:#fff;font-size:13px;font-weight:600;cursor:pointer">📋 Copy Link</button>'
    + '<button onclick="spSendShareEmailFromModal(\''+cjId+'\',\''+linkUrl.replace(/'/g,"\\'")+'\'  ,\''+expiryStr.replace(/'/g,"\\'")+'\'  )" style="flex:2;padding:10px;border:none;border-radius:7px;background:#0073EA;color:#fff;font-size:13px;font-weight:700;cursor:pointer">📧 Send Branded Email</button>'
    + '</div></div>';
  document.body.appendChild(modal);
}

async function spSendShareEmailFromModal(cjId, linkUrl, expiryStr) {
  var toEmail   = (document.getElementById('sp-sh-to')   || {}).value || '';
  var subject   = (document.getElementById('sp-sh-subj') || {}).value || '';
  if (!toEmail) { toast('Please enter a recipient email address'); return; }
  document.getElementById('sp-share-modal').remove();
  await spSendShareEmail(cjId, linkUrl, expiryStr, toEmail, subject);
}


// ═══════════════════════════════════════════════════════════════════════════
// ICS CALENDAR FILE GENERATOR
// ═══════════════════════════════════════════════════════════════════════════

function generateIcs(opts) {
  // opts: { summary, description, location, startDate (YYYY-MM-DD), startTime (HH:MM), durationHours, uid, organiserEmail, organiserName }
  var start = opts.startDate.replace(/-/g,'');
  var timeStr = (opts.startTime || '09:00').replace(':','');
  var startDt = start + 'T' + timeStr + '00';

  // Calculate end time
  var durationH = opts.durationHours || 2;
  var startH = parseInt(timeStr.slice(0,2));
  var startM = parseInt(timeStr.slice(2,4));
  var endTotalM = (startH * 60 + startM) + (durationH * 60);
  var endH = String(Math.floor(endTotalM / 60) % 24).padStart(2,'0');
  var endM = String(endTotalM % 60).padStart(2,'0');
  var endDt = start + 'T' + endH + endM + '00';

  var uid = opts.uid || ('ops-' + Date.now() + '@onwards.network');
  var now = new Date().toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
  var company = APP_SETTINGS.companyName || 'Onwards';
  var orgEmail = opts.organiserEmail || APP_SETTINGS.companyEmail || 'updates@onwards.network';
  var orgName  = opts.organiserName  || company + ' Operations';

  var desc = (opts.description || '').split('\n').join('\\n').split(',').join('\\,');
  var loc  = (opts.location    || '').replace(/,/g,'\,');
  var summ = (opts.summary     || '').replace(/,/g,'\,');

  return [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//' + company + '//OpsManager//EN',
    'CALSCALE:GREGORIAN',
    'METHOD:REQUEST',
    'BEGIN:VEVENT',
    'UID:' + uid,
    'DTSTAMP:' + now,
    'DTSTART:' + startDt,
    'DTEND:' + endDt,
    'SUMMARY:' + summ,
    'DESCRIPTION:' + desc,
    (loc ? 'LOCATION:' + loc : ''),
    'ORGANIZER;CN=' + orgName + ':mailto:' + orgEmail,
    'STATUS:CONFIRMED',
    'SEQUENCE:0',
    'END:VEVENT',
    'END:VCALENDAR'
  ].filter(Boolean).join('\r\n');
}

function icsDataUrl(icsContent) {
  // Returns a data URL the email can link to for one-click calendar add
  return 'data:text/calendar;charset=utf8,' + encodeURIComponent(icsContent);
}

function icsCalendarBlock(icsContent, summary, dateStr) {
  // Returns the HTML block to include in emails for one-click calendar add
  var dataUrl = icsDataUrl(icsContent);
  return '<div style="margin:24px 0;padding:16px 20px;background:#f0f7ff;border:1px solid #bfdbfe;border-radius:8px;display:flex;align-items:center;gap:16px">'
    + '<div style="font-size:28px">📅</div>'
    + '<div style="flex:1">'
    + '<div style="font-weight:700;color:#1e40af;font-size:14px">Save to your calendar</div>'
    + '<div style="color:#374151;font-size:13px;margin-top:2px">' + esc(summary) + ' — ' + esc(dateStr) + '</div>'
    + '</div>'
    + '<a href="' + dataUrl + '" download="event.ics" style="background:#1e40af;color:#fff;font-size:13px;font-weight:600;padding:10px 18px;border-radius:6px;text-decoration:none;white-space:nowrap">📅 Add to Calendar</a>'
    + '</div>'
    + '<p style="font-size:11px;color:#9ca3af;margin-top:-12px">Works with Apple Calendar, Google Calendar and Outlook. Click the button above to save this appointment to your calendar.</p>';
}

// ── SURVEY CONFIRMATION EMAIL ────────────────────────────────────────────
async function sendSurveyConfirmationEmail(svId, opts) {
  var sv = SURVEYS.filter(function(x){ return x.id === svId; })[0];
  if (!sv) return;
  if (!sv.clientEmail) {
    if (opts && opts.resend) toast('No client email on this survey record');
    return;
  }

  var company   = APP_SETTINGS.companyName || 'Onwards';
  var surveyor  = sv.surveyor  || 'our surveyor';
  var dateNice  = sv.surveyDate ? (new Date(sv.surveyDate+'T12:00:00')).toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'}) : 'TBC';
  var timeNice  = sv.surveyTime || 'TBC';
  var subject   = 'Survey Appointment: ' + sv.ref + ' — ' + (sv.clientName||'');

  // Generate .ics
  var icsContent = generateIcs({
    summary:        company + ' Survey — ' + (sv.clientName||''),
    description:    'Survey appointment with ' + surveyor + '\nRef: ' + sv.ref + '\nAddress: ' + (sv.postcode||''),
    location:       sv.postcode || '',
    startDate:      sv.surveyDate,
    startTime:      sv.surveyTime || '09:00',
    durationHours:  1,
    uid:            sv.id + '@onwards.network',
    organiserEmail: APP_SETTINGS.companyEmail || 'updates@onwards.network',
    organiserName:  company + ' Operations'
  });

  var bodyHtml = '<p>Dear ' + esc(sv.clientName||'') + ',</p>'
    + '<p>Thank you for choosing ' + esc(company) + '. We are pleased to confirm your survey appointment:</p>'
    + '<table style="width:100%;border-collapse:collapse;margin:20px 0">'
    + '<tr><td style="padding:10px 14px;border:1px solid #e8eaed;font-weight:600;font-size:13px;color:#374151;background:#f8f9fb;width:140px">Date</td><td style="padding:10px 14px;border:1px solid #e8eaed;font-size:13px;color:#1a1a2e">' + esc(dateNice) + '</td></tr>'
    + '<tr><td style="padding:10px 14px;border:1px solid #e8eaed;font-weight:600;font-size:13px;color:#374151;background:#f8f9fb">Time</td><td style="padding:10px 14px;border:1px solid #e8eaed;font-size:13px;color:#1a1a2e">' + esc(timeNice) + '</td></tr>'
    + '<tr><td style="padding:10px 14px;border:1px solid #e8eaed;font-weight:600;font-size:13px;color:#374151;background:#f8f9fb">Surveyor</td><td style="padding:10px 14px;border:1px solid #e8eaed;font-size:13px;color:#1a1a2e">' + esc(surveyor) + '</td></tr>'
    + '<tr><td style="padding:10px 14px;border:1px solid #e8eaed;font-weight:600;font-size:13px;color:#374151;background:#f8f9fb">Address</td><td style="padding:10px 14px;border:1px solid #e8eaed;font-size:13px;color:#1a1a2e">' + esc(sv.postcode||'TBC') + '</td></tr>'
    + (sv.notes ? '<tr><td style="padding:10px 14px;border:1px solid #e8eaed;font-weight:600;font-size:13px;color:#374151;background:#f8f9fb">Notes</td><td style="padding:10px 14px;border:1px solid #e8eaed;font-size:13px;color:#1a1a2e">' + esc(sv.notes) + '</td></tr>' : '')
    + '</table>'
    + icsCalendarBlock(icsContent, company + ' Survey', dateNice)
    + '<p>If you need to reschedule or have any questions, please reply to this email.</p>'
    + '<p>Kind regards,<br><strong>' + esc(company) + ' Operations</strong></p>';

  var html = buildEmailHtml({ subject, preheader: 'Your survey is confirmed for ' + dateNice, bodyHtml });

  var res = await sendEmail({ to: sv.clientEmail, subject, html });
  if (res.ok) {
    sv.confirmationSent = new Date().toISOString();
    saveData('survey', sv.id, sv);
    if (opts && opts.resend) toast('✅ Survey confirmation sent to ' + sv.clientEmail);
  } else {
    if (opts && opts.resend) toast('❌ Email failed: ' + (res.error||'Unknown error'));
    console.error('Survey confirmation failed:', res.error);
  }
}

// ── JOB CONFIRMATION EMAIL ───────────────────────────────────────────────────
async function sendJobConfirmationEmail(cjId, opts) {
  // opts: { resend: bool } — if resend, skip auto-check
  var cj = CLIENT_JOBS.filter(function(x){ return x.id === cjId; })[0];
  if (!cj) { console.warn('sendJobConfirmationEmail: client job not found', cjId); return; }

  // Determine channel from brand
  var bd       = BRAND_DATA.filter(function(b){ return b.name === cj.brand; })[0];
  var channel  = bd ? bd.channel : 'Partner';
  var isDomestic = channel === 'Domestic';

  // Determine recipient
  var toEmail  = '';
  var toName   = '';
  if (isDomestic) {
    toEmail = cj.clientEmail || '';
    toName  = cj.clientName  || 'Customer';
    if (!toEmail) { console.warn('No client email for domestic job', cjId); return; }
  } else {
    var mm = MOVE_MANAGERS.filter(function(m){ return m.name === cj.moveManager; })[0];
    toEmail = mm ? (mm.email || '') : '';
    toName  = mm ? mm.name : (cj.moveManager || 'Move Manager');
    if (!toEmail) {
      if (opts && opts.resend) toast('No email set for move manager — add one in Settings → Move Managers');
      return;
    }
  }

  // Get all movements for this client job
  var movs = jobs.filter(function(j){ return j.clientJobId === cjId; });

  // Subject line
  var partnerRef = cj.partnerRef || cj.clientRef || '';
  var ourRef     = cj.masterJobId || '';

  // Extract surname — handle both "Surname, First" and "First Surname" formats
  var fullName = cj.clientName || '';
  var surname  = fullName.indexOf(',') >= 0
    ? fullName.split(',')[0].trim()
    : (fullName.split(' ').pop() || fullName);

  // Get primary job type from first movement
  var primaryJobType = movs.length ? (movs[0].jobType || movs[0].type || '') : '';

  var subject = isDomestic
    ? 'Booking Confirmation: ' + ourRef + ' — ' + surname + (primaryJobType ? ' — ' + primaryJobType : '')
    : 'Booking Confirmation: ' + (partnerRef ? partnerRef + ' / ' : '') + ourRef + ' — ' + surname + (primaryJobType ? ' — ' + primaryJobType : '');

  // Build movements table rows
  var movRows = '';
  movs.forEach(function(j) {
    var jobType = j.jobType || j.type || '';
    var isWarehouseIn  = jobType === 'Int Store Handling' || (j.dest   && j.dest.indexOf('INT STORE') >= 0);
    var isWarehouseOut = jobType === 'Ex Store Delivery'  || (j.origin && j.origin.indexOf('EX STORE') >= 0);
    var isDTD = jobType === 'Door to Door' || jobType === 'Domestic' || (j.origin && j.dest && !isWarehouseIn && !isWarehouseOut);

    // Address display logic
    var addrHtml = '';
    if (isWarehouseIn) {
      addrHtml = '<strong>Origin:</strong> ' + esc(j.origin||'TBC') + '<br><strong>To:</strong> MoveSquad Warehouse';
    } else if (isWarehouseOut) {
      addrHtml = '<strong>From:</strong> MoveSquad Warehouse<br><strong>Destination:</strong> ' + esc(j.dest||'TBC');
    } else if (isDTD) {
      addrHtml = '<strong>Origin:</strong> ' + esc(j.origin||'TBC') + '<br><strong>Destination:</strong> ' + esc(j.dest||'TBC');
    } else if (jobType && jobType.indexOf('Destination') >= 0) {
      addrHtml = '<strong>Destination:</strong> ' + esc(j.dest||'TBC');
    } else {
      addrHtml = '<strong>Origin:</strong> ' + esc(j.origin||'TBC');
    }

    // Access notes
    var accessNotes = [];
    if (j.access) {
      if (j.access.lift)       accessNotes.push('Lift available');
      if (j.access.noLift)     accessNotes.push('No lift — stairs only');
      if (j.access.parking)    accessNotes.push('Parking available');
      if (j.access.noParking)  accessNotes.push('No parking — permits required');
      if (j.access.longCarry)  accessNotes.push('Long carry');
      if (j.access.narrowAccess) accessNotes.push('Narrow access');
    }

    var dateStr = j.start ? (new Date(j.start+'T12:00:00')).toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'}) : 'TBC';
    var volStr  = j.volFt ? j.volFt + ' ft³' + (j.volCbm ? ' / ' + j.volCbm + ' m³' : '') : 'TBC';

    movRows += '<tr style="border-bottom:1px solid #e8eaed">'
      + '<td style="padding:12px 14px;vertical-align:top;min-width:140px"><strong style="color:#1a1a2e">' + esc(jobType) + '</strong><br><span style="font-size:12px;color:#6b7280">' + esc(j.ref||j.movementRef||'') + '</span></td>'
      + '<td style="padding:12px 14px;vertical-align:top"><span style="background:#f0f4ff;color:#2563eb;font-size:12px;font-weight:600;padding:3px 8px;border-radius:4px">' + esc(dateStr) + '</span></td>'
      + '<td style="padding:12px 14px;vertical-align:top;font-size:13px;color:#374151">' + addrHtml + '</td>'
      + '<td style="padding:12px 14px;vertical-align:top;font-size:13px">' + esc(volStr) + '</td>'
      + (accessNotes.length ? '<td style="padding:12px 14px;vertical-align:top;font-size:12px;color:#b45309">' + accessNotes.join('<br>') + '</td>' : '<td style="padding:12px 14px"></td>')
      + '</tr>';
  });

  // Ref table
  var refRows = '';
  if (!isDomestic && partnerRef) refRows += '<tr><td style="padding:8px 14px;border:1px solid #e8eaed;font-weight:600;font-size:13px;color:#374151;background:#f8f9fb;width:160px">Your Reference</td><td style="padding:8px 14px;border:1px solid #e8eaed;font-size:13px;color:#1a1a2e">' + esc(partnerRef) + '</td></tr>';
  if (ourRef) refRows += '<tr><td style="padding:8px 14px;border:1px solid #e8eaed;font-weight:600;font-size:13px;color:#374151;background:#f8f9fb">Our Reference</td><td style="padding:8px 14px;border:1px solid #e8eaed;font-size:13px;color:#1a1a2e">' + esc(ourRef) + '</td></tr>';
  refRows += '<tr><td style="padding:8px 14px;border:1px solid #e8eaed;font-weight:600;font-size:13px;color:#374151;background:#f8f9fb">Client</td><td style="padding:8px 14px;border:1px solid #e8eaed;font-size:13px;color:#1a1a2e">' + esc(cj.clientName||'—') + '</td></tr>';
  if (cj.brand) refRows += '<tr><td style="padding:8px 14px;border:1px solid #e8eaed;font-weight:600;font-size:13px;color:#374151;background:#f8f9fb">Service</td><td style="padding:8px 14px;border:1px solid #e8eaed;font-size:13px;color:#1a1a2e">' + esc(cj.brand) + '</td></tr>';
  if (!isDomestic && cj.moveManager) refRows += '<tr><td style="padding:8px 14px;border:1px solid #e8eaed;font-weight:600;font-size:13px;color:#374151;background:#f8f9fb">Move Manager</td><td style="padding:8px 14px;border:1px solid #e8eaed;font-size:13px;color:#1a1a2e">' + esc(cj.moveManager) + '</td></tr>';

  // SP folder link
  var docsLink = '';
  if (cj.spFolderUrl) {
    docsLink = '<p style="margin-top:24px"><strong>📁 Document Folder</strong><br><a href="' + esc(cj.spFolderUrl) + '" style="color:' + (APP_SETTINGS.emailAccentColor||'#0073EA') + '">' + esc(cj.spFolderUrl) + '</a></p>';
  }

  // Generate .ics for first movement date
  var icsBlock = '';
  if (movs.length && movs[0].start) {
    var firstMov = movs[0];
    var jobDateNice = (new Date(firstMov.start+'T12:00:00')).toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
    var icsDesc = ['Ref: ' + ourRef, (partnerRef ? 'Partner Ref: ' + partnerRef : ''), 'Client: ' + (cj.clientName||''), (cj.moveManager ? 'Move Manager: ' + cj.moveManager : '')].filter(Boolean).join('\n');
    var icsContent = generateIcs({
      summary:       (firstMov.jobType||firstMov.type||'Job') + ' — ' + (cj.clientName||''),
      description:   icsDesc,
      location:      firstMov.origin || firstMov.dest || '',
      startDate:     firstMov.start,
      startTime:     '08:00',
      durationHours: 8,
      uid:           cj.id + '-' + firstMov.id + '@onwards.network',
      organiserEmail: APP_SETTINGS.companyEmail || 'updates@onwards.network',
      organiserName:  (APP_SETTINGS.companyName||'Onwards') + ' Operations'
    });
    icsBlock = icsCalendarBlock(icsContent, (firstMov.jobType||'Job') + ' — ' + (cj.clientName||''), jobDateNice);
  }

  var greeting = isDomestic ? ('Dear ' + esc(cj.clientName||'') + ',') : ('Dear ' + esc(toName) + ',');
  var intro    = isDomestic
    ? '<p>Thank you for choosing ' + esc(APP_SETTINGS.companyName||'Onwards') + '. We are pleased to confirm the following job booking:</p>'
    : '<p>Please find below the confirmed job details for the above booking:</p>';

  var bodyHtml = '<p>' + greeting + '</p>'
    + intro
    + '<table style="width:100%;border-collapse:collapse;margin:16px 0">' + refRows + '</table>'
    + '<p style="margin-top:24px"><strong>Job Details</strong></p>'
    + '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:13px">'
    + '<thead><tr style="background:#f8f9fb;border-bottom:2px solid #e8eaed">'
    + '<th style="padding:10px 14px;text-align:left;color:#374151">Type</th>'
    + '<th style="padding:10px 14px;text-align:left;color:#374151">Date</th>'
    + '<th style="padding:10px 14px;text-align:left;color:#374151">Address</th>'
    + '<th style="padding:10px 14px;text-align:left;color:#374151">Volume</th>'
    + '<th style="padding:10px 14px;text-align:left;color:#374151">Access Notes</th>'
    + '</tr></thead><tbody>' + movRows + '</tbody></table></div>'
    + docsLink
    + icsBlock
    + '<p style="margin-top:24px">If you have any questions please reply to this email.</p>'
    + '<p>Kind regards,<br><strong>' + esc(APP_SETTINGS.companyName||'Onwards') + ' Operations</strong></p>';

  var html = buildEmailHtml({
    subject,
    preheader: 'Job confirmation for ' + (cj.clientName||'') + (partnerRef ? ' (' + partnerRef + ')' : ''),
    bodyHtml,
    ctaUrl:   cj.spFolderUrl || '',
    ctaLabel: cj.spFolderUrl ? '📁 View Documents' : ''
  });

  var res = await sendEmail({ to: toEmail, subject, html, replyTo: APP_SETTINGS.emailReplyTo });
  if (res.ok) {
    // Log the send on the client job
    if (!cj.emailLog) cj.emailLog = [];
    cj.emailLog.push({ type: 'confirmation', sentAt: new Date().toISOString(), to: toEmail, subject });
    saveData('clientjob', cj.id, cj);
    if (opts && opts.resend) toast('✅ Confirmation email sent to ' + toEmail);
    console.log('Job confirmation sent to', toEmail);
    // Also create Outlook calendar event for move manager (partner/account jobs only)
    if (!isDomestic && movs.length) {
      setTimeout(function() { createMoveManagerCalendarEvent(cj, movs); }, 500);
    }
  } else {
    console.error('Job confirmation email failed:', res.error);
    if (opts && opts.resend) toast('❌ Email failed: ' + (res.error||'Unknown error'));
  }
}

// ── MANUAL DOC REMINDER ──────────────────────────────────────────────────────
async function sendDocReminder(cjId) {
  var cj = CLIENT_JOBS.filter(function(x){ return x.id === cjId; })[0];
  if (!cj) return;

  var REQUIRED_SLUGS = ['packing-list','insurance','survey-report','delivery-order'];
  var slugLabels = {
    'packing-list':'Packing List / Inventory','insurance':'Insurance Certificate',
    'survey-report':'Survey Report','delivery-order':'Delivery Order / Instructions'
  };
  var checklist   = cj.docChecklist || {};
  var missingDocs = REQUIRED_SLUGS.filter(function(s){ return !checklist[s] || checklist[s] === 'missing'; });

  if (!missingDocs.length) { toast('No missing required documents for this job'); return; }

  var mm = MOVE_MANAGERS.filter(function(m){ return m.name === cj.moveManager; })[0];
  if (!mm || !mm.email) { toast('No email set for move manager — add one in Settings → Move Managers'); return; }

  if (!confirm('Send document request to ' + mm.name + ' (' + mm.email + ')?')) return;

  var partnerRef   = cj.partnerRef || cj.clientRef || '—';
  var ourRef       = cj.masterJobId || '—';
  var clientName   = cj.clientName  || '—';
  var jobDateNice  = cj.startDate ? (new Date(cj.startDate+'T12:00:00')).toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'}) : 'TBC';
  var missingList  = missingDocs.map(function(s){ return slugLabels[s]||s; }).join(', ');
  var docsUrl      = cj.spFolderUrl || '';
  var company      = APP_SETTINGS.companyName || 'Onwards';

  var subject = 'Action Required — Missing Documents: ' + partnerRef + ' / ' + ourRef + ' — ' + clientName;

  var bodyHtml = '<p>Dear ' + esc(mm.name) + ',</p>'
    + '<p>We are writing to request the outstanding documents for the following job. Please provide these as soon as possible:</p>'
    + '<table style="width:100%;border-collapse:collapse;margin:16px 0">'
    + '<tr><td style="padding:8px 14px;border:1px solid #e8eaed;font-weight:600;font-size:13px;background:#f8f9fb;width:150px">Client</td><td style="padding:8px 14px;border:1px solid #e8eaed;font-size:13px">' + esc(clientName) + '</td></tr>'
    + '<tr><td style="padding:8px 14px;border:1px solid #e8eaed;font-weight:600;font-size:13px;background:#f8f9fb">Your Reference</td><td style="padding:8px 14px;border:1px solid #e8eaed;font-size:13px">' + esc(partnerRef) + '</td></tr>'
    + '<tr><td style="padding:8px 14px;border:1px solid #e8eaed;font-weight:600;font-size:13px;background:#f8f9fb">Our Reference</td><td style="padding:8px 14px;border:1px solid #e8eaed;font-size:13px">' + esc(ourRef) + '</td></tr>'
    + '<tr><td style="padding:8px 14px;border:1px solid #e8eaed;font-weight:600;font-size:13px;background:#f8f9fb">Job Date</td><td style="padding:8px 14px;border:1px solid #e8eaed;font-size:13px">' + esc(jobDateNice) + '</td></tr>'
    + '</table>'
    + '<div style="background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:16px;margin:20px 0">'
    + '<div style="font-weight:700;color:#856404;margin-bottom:8px">⚠ Missing Documents</div>'
    + '<div style="color:#533f03;font-size:13px">' + esc(missingList) + '</div>'
    + '</div>'
    + (docsUrl ? '<p>Please upload to the job folder: <a href="'+esc(docsUrl)+'" style="color:#0073EA">'+esc(docsUrl)+'</a></p>' : '')
    + '<p>If you have any questions please reply to this email.</p>'
    + '<p>Kind regards,<br><strong>' + esc(company) + ' Operations</strong></p>';

  var html = buildEmailHtml({ subject: subject, preheader: 'Missing documents required for ' + clientName, bodyHtml: bodyHtml });

  toast('Sending document request…');
  var res = await sendEmail({ to: mm.email, subject: subject, html: html });
  if (res.ok) {
    toast('✅ Document request sent to ' + mm.email);
  } else {
    toast('❌ Failed: ' + (res.error || 'Unknown error'));
  }
}

// ── SEND TO CREW (Appenate) ───────────────────────────────────────────────
async function sendToCrew(jobId) {
  var job = jobs.filter(function(j){ return j.id === jobId; })[0];
  if (!job) { toast('Job not found'); return; }

  var crew = (job.drivers || []).concat(job.porters || []).filter(function(x){ return x; });
  if (!crew.length) { toast('No crew assigned to this job'); return; }

  // Find linked client job for partner ref, docs link etc.
  var cj = job.clientJobId ? CLIENT_JOBS.filter(function(x){ return x.id === job.clientJobId; })[0] : null;
  var partnerRef = cj ? (cj.partnerRef || cj.clientRef || '') : '';
  var mm = cj && cj.moveManager ? MOVE_MANAGERS.filter(function(m){ return m.name === cj.moveManager; })[0] : null;

  // CompleteBy = job date at 17:00 UTC
  var completeBy = (job.start || d2s(new Date())) + 'T17:00:00Z';

  // Build AdditionalInfo
  var info = [
    'JOB: ' + (job.type || job.jobType || ''),
    'CLIENT: ' + (job.client || ''),
    'PARTNER REF: ' + (partnerRef || 'TBC'),
    'OUR REF: ' + (job.ref || ''),
    'BRAND: ' + (job.brand || ''),
    'ORIGIN: ' + (job.origin || '—'),
    'DESTINATION: ' + (job.dest || '—'),
    'VOLUME: ' + (job.volFt ? job.volFt + ' ft³' : 'TBC'),
  ];
  if (mm) info.push('MOVE MANAGER: ' + mm.name + (mm.email ? ' (' + mm.email + ')' : ''));
  if (job.access) {
    var flags = Object.keys(job.access).filter(function(k){ return job.access[k]; });
    if (flags.length) info.push('ACCESS: ' + flags.join(', '));
  }
  if (job.opsNotes) info.push('OPS NOTES: ' + job.opsNotes);
  if (cj && cj.spFolderUrl) info.push('DOCUMENTS: ' + cj.spFolderUrl);
  var additionalInfo = info.join('\n');

  var taskName = (job.type || job.jobType || 'Job') + ' — ' + (job.client || '') + ' — ' + (job.start ? job.start : '');

  toast('Sending to crew (' + crew.length + ' member' + (crew.length!==1?'s':'') + ')…');

  var successCount = 0;
  var taskIds = [];

  for (var ci = 0; ci < crew.length; ci++) {
    var crewName = crew[ci];
    var crewMember = CREW.filter(function(c){ return c.name === crewName; })[0];
    var crewEmail = crewMember ? (crewMember.email || '') : '';
    if (!crewEmail) {
      toast('⚠ No email set for ' + crewName + ' — skipped. Add email in Settings → Crew.');
      continue;
    }

    var taskPayload = {
      Name:            taskName,
      UserEmail:       crewEmail,
      CompleteBy:      completeBy,
      CompleteAtText:  job.origin || '',
      CompleteAtLat:   job.originLat || 0,
      CompleteAtLon:   job.originLon || 0,
      AdditionalInfo:  additionalInfo,
      ExternalId:      (job.ref || job.id) + '-' + crewEmail,
      UserCanReject:   true,
      STaskActivities: [
        { Instruction: 'Review job brief and confirm details are correct for: ' + taskName }
      ]
    };

    var res = await fetch('/api/appenate', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'createTask', payload: taskPayload })
    });
    var data = await res.json().catch(function(){ return {}; });
    var parsed = typeof data === 'string' ? {} : data;

    // Log full response for debugging
    console.log('Appenate response for', crewName, ':', res.status, JSON.stringify(parsed));

    if (!res.ok) {
      var errMsg = parsed.error || parsed.Message || parsed.message || ('HTTP ' + res.status);
      toast('❌ Appenate error for ' + crewName + ': ' + errMsg);
      continue;
    }

    var taskId = (parsed.STask && parsed.STask.Id) || (parsed.Id) || (parsed.TaskId) || '';

    if (taskId) {
      successCount++;
      taskIds.push({ crew: crewName, taskId: taskId });
    }
  }

  if (successCount > 0) {
    // Store task IDs on the job
    if (!job.appenateTaskIds) job.appenateTaskIds = [];
    job.appenateTaskIds = job.appenateTaskIds.concat(taskIds);
    job.appenateSynced = true;
    saveData('job', job.id, job);
    toast('✅ Sent to ' + successCount + ' crew member' + (successCount!==1?'s':'') + ' via Appenate');
    renderActiveMod();
  } else {
    toast('❌ Appenate send failed — check browser console (F12) for the full error response from Appenate');
  }
}

// Crew email field is handled inline in renderSettingsCrew

</script>

<div class="page" id="mod-dashboard">
      <div style="flex:1;overflow:auto;padding:20px" id="dashboard-body"></div>
    </div>
    
<script>
// ═══════════════════════════════════════════════════════════════════════════
// NEW 4-STAGE BOOKING FLOW — STAGE RENDER FUNCTIONS
// ═══════════════════════════════════════════════════════════════════════════

// ── ROUTE TYPES ──────────────────────────────────────────────────────────
var ROUTE_TYPES = [
  {
    key: 'origin',
    icon: '📦',
    label: 'Origin Job',
    sub: 'Packing & collection at client property — sea, air, road or storage in',
    color: '#EBF4FF',
    accent: '#0073EA',
    jobTypes: ['Origin Sea Pack','Origin Air Pack','Origin Road Pack','Int Store Handling','Blanket Wrap','Debris Removal','Handling Only','Consolidation','Other']
  },
  {
    key: 'destination',
    icon: '🏠',
    label: 'Destination Job',
    sub: 'Delivery & unpack at client property — from port, airport or third party',
    color: '#E6FFF5',
    accent: '#00C875',
    jobTypes: ['Destination Services','Blanket Wrap','Debris Removal','Handling Only','Other']
  },
  {
    key: 'd2d',
    icon: '🔄',
    label: 'Door to Door',
    sub: 'Full service origin to destination — domestic, commercial or international',
    color: '#F5EEFF',
    accent: '#9B59B6',
    jobTypes: ['Door to Door','Domestic','Other']
  },
  {
    key: 'storage',
    icon: '🏭',
    label: 'From Storage',
    sub: 'Delivery out of our warehouse — select a client currently in storage',
    color: '#FFF5E0',
    accent: '#FF9F1A',
    jobTypes: ['Ex Store Delivery','Destination Services','Other']
  }
];

// ── STAGE 1: ROUTE ────────────────────────────────────────────────────────
function cfgRenderRoute() {
  var h = '';

  // Route selector card
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">🧭</div>';
  h += '<div><div class="cs-card-title">What kind of job is this?</div>';
  h += '<div class="cs-card-sub">Select a route — this determines which fields and options appear on the next stage</div></div></div>';
  h += '<div class="cs-body">';
  h += '<div class="route-grid">';
  for (var ri = 0; ri < ROUTE_TYPES.length; ri++) {
    var rt = ROUTE_TYPES[ri];
    var sel = CFG.route === rt.key;
    h += '<div class="route-tile' + (sel ? ' sel' : '') + '" onclick="cfgSetRoute(\'' + rt.key + '\',this)" style="--rt-accent:' + rt.accent + ';--rt-bg:' + rt.color + '">';
    h += '<div class="route-tile-icon">' + rt.icon + '</div>';
    h += '<div class="route-tile-label">' + rt.label + '</div>';
    h += '<div class="route-tile-sub">' + rt.sub + '</div>';
    if (sel) h += '<div class="route-tile-check">✓</div>';
    h += '</div>';
  }
  h += '</div>';
  h += '</div></div>';

  // AI Parser card — always visible on Stage 1
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">🤖</div>';
  h += '<div><div class="cs-card-title">AI Email Parser</div>';
  h += '<div class="cs-card-sub">Paste any email or instruction — Claude extracts all details instantly</div></div></div>';
  h += '<div class="cs-body">';
  h += '<textarea class="cfg-input" id="cfg-email-paste" rows="4" placeholder="Paste booking email, instruction sheet, or any message here...\n\ne.g. Please confirm the following move:\nClient: John Smith\nOrigin: 14 High Street, Leeds, LS1 3CD..." style="resize:vertical;min-height:80px">' + esc(CFG.sourceEmail || '') + '</textarea>';
  h += '<div style="display:flex;gap:7px;margin-top:8px">';
  h += '<button class="btn btn-p btn-sm" id="cfg-parse-btn" onclick="cfgParseEmail()"><span id="cfg-parse-spin"></span>✓ Extract Details</button>';
  h += '<button class="btn btn-s btn-sm" onclick="el(\'cfg-email-paste\').value=\'\'">Clear</button>';
  h += '</div>';
  // AI parse results chips
  if (CFG.aiParsed) {
    h += '<div style="margin-top:14px;border-top:1px solid #ede9e0;padding-top:12px">';
    h += '<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#7A849E;margin-bottom:10px">✓ Extracted — Review & confirm (amber = assumed)</div>';
    var ap = CFG.aiParsed;
    var fields = [['Client Name','clientName'],['Email','clientEmail'],['Phone','clientPhone'],['Start Date','startDate'],['Origin','origin'],['Destination','dest'],['Volume','volume'],['Notes','notes']];
    for (var fi = 0; fi < fields.length; fi++) {
      var lbl = fields[fi][0], key = fields[fi][1];
      var val = ap[key];
      var conf = ap._conf && ap._conf[key] ? ap._conf[key] : (val ? 'assumed' : 'missing');
      h += '<div class="ai-field-row">';
      h += '<div class="ai-field-lbl">' + lbl + '</div>';
      if (val) {
        h += '<span class="ai-chip ' + conf + '" onclick="cfgChipEdit(this,\'' + key + '\')" title="Click to edit">' + esc(String(val).substring(0,40)) + ' <span style="opacity:.6;font-size:10px">✎</span></span>';
        h += '<input class="ai-edit-input" id="aied-' + key + '" style="display:none" value="' + esc(String(val)) + '" onblur="cfgChipConfirm(this,\'' + key + '\')" onkeydown="if(event.key===\'Enter\')cfgChipConfirm(this,\'' + key + '\')">';
      } else {
        h += '<span class="ai-chip missing">✗ Not found</span>';
        h += '<input class="ai-edit-input" id="aied-' + key + '" placeholder="Enter manually..." style="display:none" onblur="cfgChipConfirm(this,\'' + key + '\')" onkeydown="if(event.key===\'Enter\')cfgChipConfirm(this,\'' + key + '\')">';
      }
      h += '</div>';
    }
    h += '</div>';
  }
  h += '</div></div>';

  return h;
}

function cfgSetRoute(key, tileEl) {
  CFG.route = key;
  var rt = ROUTE_TYPES.filter(function(r){ return r.key === key; })[0];
  // Auto-set job type if route only has one real option
  if (rt && rt.jobTypes.length === 1) {
    CFG.jobs[0].jobType = rt.jobTypes[0];
  }
  // Storage route: auto-set storage direction on job
  if (key === 'storage') {
    CFG.jobs[0].storageRequired = true;
    CFG.jobs[0].storageDirection = 'out';
    CFG.jobs[0].jobType = CFG.jobs[0].jobType || 'Ex Store Delivery';
  }
  // D2D: default to Door to Door
  if (key === 'd2d') {
    CFG.jobs[0].jobType = CFG.jobs[0].jobType || 'Door to Door';
  }
  document.querySelectorAll('.route-tile').forEach(function(t){ t.classList.remove('sel'); t.querySelector('.route-tile-check') && t.querySelector('.route-tile-check').remove(); });
  if (tileEl) {
    tileEl.classList.add('sel');
    if (!tileEl.querySelector('.route-tile-check')) {
      var chk = document.createElement('div');
      chk.className = 'route-tile-check';
      chk.textContent = '✓';
      tileEl.appendChild(chk);
    }
  }
  CFG.route = key;
}

function cfgCollectRoute() {
  // Route is set directly by cfgSetRoute — nothing to collect from DOM
  // But save email parser text
  CFG.sourceEmail = (el('cfg-email-paste') || {}).value || CFG.sourceEmail;
}

// ── STAGE 2: BRIEF ────────────────────────────────────────────────────────
function cfgRenderBrief() {
  var h = '';
  var rt = ROUTE_TYPES.filter(function(r){ return r.key === CFG.route; })[0];
  var routeJobTypes = rt ? rt.jobTypes : JOB_TYPES.map(function(j){ return j.type; });

  // Storage route — show live storage records to pick from
  if (CFG.route === 'storage') {
    h += cfgRenderStoragePicker();
  }

  // Job type card — filtered to route
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:' + (rt ? rt.color : '#EBF4FF') + '">' + (rt ? rt.icon : '📋') + '</div>';
  h += '<div><div class="cs-card-title">Job Type</div>';
  h += '<div class="cs-card-sub">' + (rt ? rt.label + ' — ' + rt.sub : 'Select type') + '</div></div></div>';
  h += '<div class="cs-body">';
  h += '<div class="jtype-grid">';
  for (var ti = 0; ti < JOB_TYPES.length; ti++) {
    var jt = JOB_TYPES[ti];
    if (routeJobTypes.indexOf(jt.type) < 0) continue;
    h += '<div class="jtype-tile' + (CFG.jobs[0].jobType === jt.type ? ' sel' : '') + '" onclick="cfgSetJobType(0,this,\'' + jt.type.replace(/'/g,"\\'") + '\')">';
    h += '<span class="jtype-icon">' + jt.icon + '</span>';
    h += '<div class="jtype-lbl">' + jt.type + '</div>';
    h += '<div class="jtype-sub">' + jt.sub + '</div>';
    h += '</div>';
  }
  h += '</div></div></div>';

  // Addresses card — smart based on job type + route
  if (CFG.route !== 'storage') {
    h += cfgRenderBriefAddresses();
  }

  // Volume card
  var jb = CFG.jobs[0];
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#FFF5E0">📐</div>';
  h += '<div class="cs-card-title">Volume</div></div>';
  h += '<div class="cs-body">';
  h += '<div class="vol-row">';
  h += '<input class="cfg-input" id="jcfg-vol-0" type="number" value="' + esc(jb.volFt || '') + '" min="0" placeholder="0" style="width:140px">';
  h += '<button class="vol-unit-btn' + (jb.volUnit !== 'cbm' ? ' sel' : '') + '" onclick="cfgSetVolUnit(0,\'ft\',this)">ft³</button>';
  h += '<button class="vol-unit-btn' + (jb.volUnit === 'cbm' ? ' sel' : '') + '" onclick="cfgSetVolUnit(0,\'cbm\',this)">CBM</button>';
  h += '</div></div></div>';

  // Client details card
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#E6FFF5">👤</div>';
  h += '<div class="cs-card-title">Client Details</div></div>';
  h += '<div class="cs-body">';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  h += cfgField('Client Name *', 'cfg-client', CFG.clientName, 'text', 'Full name or company');
  h += cfgField('Client Email', 'cfg-cemail', CFG.clientEmail, 'email', 'client@example.com');
  h += cfgField('Client Phone', 'cfg-cphone', CFG.clientPhone, 'text', '07700 000 000');
  h += cfgField('Partner Reference', 'cfg-cref', CFG.clientRef, 'text', 'e.g. GBH-78432 (partner\'s job ref)');
  h += '</div></div></div>';

  // Brand & admin card
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#F5EEFF">🏢</div>';
  h += '<div class="cs-card-title">Brand &amp; Admin</div></div>';
  h += '<div class="cs-body">';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  h += '<div class="cfg-field"><label class="cfg-label">Brand</label><select class="cfg-input cfg-select" id="cfg-brand">';
  for (var bi = 0; bi < BRANDS.length; bi++) h += '<option' + (CFG.brand === BRANDS[bi] ? ' selected' : '') + '>' + BRANDS[bi] + '</option>';
  h += '</select></div>';
  h += '<div class="cfg-field"><label class="cfg-label">Channel</label><select class="cfg-input cfg-select" id="cfg-channel">';
  ['Partner','Account','Domestic'].forEach(function(c){ h += '<option' + (CFG.channel === c ? ' selected' : '') + '>' + c + '</option>'; });
  h += '</select></div>';
  h += '<div class="cfg-field"><label class="cfg-label">Move Manager</label><select class="cfg-input cfg-select" id="cfg-mm">';
  h += '<option value="">— None —</option>';
  for (var mi = 0; mi < MOVE_MANAGERS.length; mi++) h += '<option value="' + esc(MOVE_MANAGERS[mi].name) + '"' + (CFG.moveManager === MOVE_MANAGERS[mi].name ? ' selected' : '') + '>' + esc(MOVE_MANAGERS[mi].name) + ' (' + esc(MOVE_MANAGERS[mi].brand) + ')</option>';
  h += '</select></div>';
  // Origin country
  h += '<div class="cfg-field"><label class="cfg-label">Origin Country</label>';
  h += '<input class="cfg-input" id="cfg-origin-country" value="' + esc(CFG.originCountry || 'XX') + '" placeholder="UK, US, FR or full name" style="text-transform:uppercase" oninput="cfgPreviewJobId()">';
  h += '</div>';
  h += '</div>';
  // Job ID preview
  var _previewType = CFG.jobs[0].jobType || 'Door to Door';
  var _previewCC   = CFG.originCountry || 'XX';
  h += '<div style="margin-top:10px;padding:8px 12px;background:var(--blt);border-radius:6px;border:1px solid rgba(0,115,234,.2);font-family:monospace;font-size:12px;font-weight:700;color:var(--blue)" id="cfg-jobid-preview">';
  h += esc(countryToCode(_previewCC)) + '-' + esc(jobTypeCode(_previewType)) + '-XXXXXXX';
  h += '</div>';
  h += '</div></div>';

  // Multi-job option (if not storage)
  if (CFG.route !== 'storage') {
    h += '<div class="cs-card">';
    h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#f0efe9">➕</div>';
    h += '<div><div class="cs-card-title">Additional Job Components</div>';
    h += '<div class="cs-card-sub">e.g. a sea pack AND an air pack on the same move</div></div></div>';
    h += '<div class="cs-body">';
    if (CFG.jobs.length > 1) {
      for (var ji = 1; ji < CFG.jobs.length; ji++) {
        h += cfgRenderJobCard(ji, CFG.jobs[ji]);
      }
    }
    h += '<button class="btn btn-s btn-sm" style="width:100%" onclick="cfgAddJob()">+ Add Another Job Component</button>';
    h += '</div></div>';
  }

  return h;
}

function cfgRenderBriefAddresses() {
  var jb = CFG.jobs[0];
  var _ac = getAddrConfig(jb.jobType);
  var _defWh = getDefaultWarehouse();
  var _defWhAddr = _defWh ? _defWh.address : (APP_SETTINGS.warehouseAddress || '');
  var _defWhName = _defWh ? _defWh.name : 'Warehouse';
  var _whId = jb.warehouseId || '';

  var h = '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">📍</div>';
  h += '<div class="cs-card-title">Route Addresses</div>';
  if (!jb.jobType) {
    h += '<div class="cs-card-sub" style="color:var(--amber)">Select a job type above first</div>';
  }
  h += '</div>';
  h += '<div class="cs-body">';

  if (!jb.jobType) {
    h += '<div style="text-align:center;padding:20px;color:var(--t3);font-size:12.5px">👆 Select a job type to configure address fields</div>';
    h += '</div></div>';
    return h;
  }

  h += '<div class="jcfg-row col2 jcfg-route-section">';

  // Origin
  if (_ac && _ac.originRole === 'warehouse') {
    h += '<div class="cfg-field">';
    h += '<label class="cfg-label">' + esc(_ac.originLabel || 'Origin') + '</label>';
    if (WAREHOUSES.length > 1) {
      h += '<select class="cfg-input" onchange="cfgSetWarehouse(0,\'orig\',this.value)">' + whSelectOptions(_whId) + '</select>';
    }
    h += '<input class="cfg-input" id="jcfg-origin-0" value="' + esc(jb.origin || _defWhAddr) + '" readonly style="background:var(--s2);color:var(--t3);cursor:default;margin-top:4px">';
    h += '<div style="font-size:10px;color:var(--blue);margin-top:3px">✓ Auto-filled from ' + esc(_defWhName) + '</div>';
    h += '</div>';
  } else {
    h += '<div class="cfg-field"><label class="cfg-label">' + esc((_ac && _ac.originLabel) || 'Origin Address') + '</label>';
    h += '<input class="cfg-input" id="jcfg-origin-0" value="' + esc(jb.origin || '') + '" placeholder="' + (_ac && _ac.originRole === 'port' ? 'Port, airport or depot' : 'Full address or postcode') + '">';
    h += '</div>';
  }

  // Destination
  if (_ac && _ac.destRole === 'warehouse') {
    h += '<div class="cfg-field">';
    h += '<label class="cfg-label">' + esc(_ac.destLabel || 'Destination') + '</label>';
    if (WAREHOUSES.length > 1) {
      h += '<select class="cfg-input" onchange="cfgSetWarehouse(0,\'dest\',this.value)">' + whSelectOptions(_whId) + '</select>';
    }
    h += '<input class="cfg-input" id="jcfg-dest-0" value="' + esc(jb.dest || _defWhAddr) + '" readonly style="background:var(--s2);color:var(--t3);cursor:default;margin-top:4px">';
    h += '<div style="font-size:10px;color:var(--blue);margin-top:3px">✓ Auto-filled from ' + esc(_defWhName) + '</div>';
    h += '</div>';
  } else {
    h += '<div class="cfg-field"><label class="cfg-label">' + esc((_ac && _ac.destLabel) || 'Destination Address') + '</label>';
    h += '<input class="cfg-input" id="jcfg-dest-0" value="' + esc(jb.dest || '') + '" placeholder="' + (_ac && _ac.destRole === 'port' ? 'Port, airport or depot' : 'Full address or postcode') + '">';
    h += '</div>';
  }

  h += '</div>';
  h += '</div></div>';
  return h;
}

// Storage picker for 'From Storage' route
function cfgRenderStoragePicker() {
  var h = '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#FFF5E0">🏭</div>';
  h += '<div><div class="cs-card-title">Client in Storage</div>';
  h += '<div class="cs-card-sub">Select the storage record — addresses and volume will auto-fill</div></div></div>';
  h += '<div class="cs-body">';

  var activeRecords = STORAGE_RECORDS.filter(function(s){ return s.status === 'active'; });

  if (!activeRecords.length) {
    h += '<div style="text-align:center;padding:20px;color:var(--t3);font-size:12.5px">No active storage records found. <a onclick="cfgSetRoute(\'origin\',null);cfgRenderStage()" style="color:var(--blue);cursor:pointer">Switch to Origin job</a></div>';
    h += '</div></div>';
    return h;
  }

  h += '<div style="margin-bottom:10px"><input class="cfg-input" id="sto-quick-search" placeholder="Search by client name..." oninput="cfgFilterStoragePicker(this.value)" style="max-width:280px"></div>';
  h += '<div id="sto-picker-list">';
  for (var si = 0; si < activeRecords.length; si++) {
    var rec = activeRecords[si];
    var isSel = CFG.jobs[0].storageId === rec.id;
    h += '<div class="sto-pick-row' + (isSel ? ' sel' : '') + '" onclick="cfgPickStorage(\'' + rec.id + '\')">';
    h += '<div class="sto-pick-main">';
    h += '<div class="sto-pick-name">' + esc(rec.client || 'Unnamed') + '</div>';
    h += '<div class="sto-pick-meta">' + esc(rec.id) + ' &bull; ' + (rec.volRemaining || rec.volFt || 0) + ' ft³ remaining &bull; ' + (rec.containers ? rec.containers.length : 0) + ' containers</div>';
    h += '</div>';
    h += '<div class="sto-pick-brand">' + bbadge(rec.brand, 'sm') + '</div>';
    if (isSel) h += '<div class="sto-pick-check">✓ Selected</div>';
    h += '</div>';
  }
  h += '</div>';

  // If selected, show container picker inline
  if (CFG.jobs[0].storageId) {
    h += cfgRenderStorageOut(0, CFG.jobs[0]);
    // Also auto-fill delivery address field
    h += '<div class="cfg-field" style="margin-top:12px"><label class="cfg-label">Delivery Address</label>';
    h += '<input class="cfg-input" id="jcfg-dest-0" value="' + esc(CFG.jobs[0].dest || '') + '" placeholder="Full address or postcode">';
    h += '</div>';
  }

  h += '</div></div>';
  return h;
}

function cfgPickStorage(id) {
  var rec = STORAGE_RECORDS.filter(function(s){ return s.id === id; })[0];
  if (!rec) return;
  CFG.jobs[0].storageId = id;
  CFG.jobs[0].storageRequired = true;
  CFG.jobs[0].storageDirection = 'out';
  // Auto-fill client name and volume from storage record
  if (!CFG.clientName) CFG.clientName = rec.client || '';
  if (!CFG.brand && rec.brand) CFG.brand = rec.brand;
  var defWh = getDefaultWarehouse();
  CFG.jobs[0].origin = defWh ? defWh.address : (APP_SETTINGS.warehouseAddress || '');
  CFG.jobs[0].volFt = rec.volRemaining || rec.volFt || 0;
  cfgRenderStage();
}

function cfgFilterStoragePicker(q) {
  var rows = document.querySelectorAll('.sto-pick-row');
  rows.forEach(function(row) {
    var name = row.querySelector('.sto-pick-name');
    var match = !q || (name && name.textContent.toLowerCase().indexOf(q.toLowerCase()) >= 0);
    row.style.display = match ? '' : 'none';
  });
}

function cfgCollectBrief() {
  // Client
  CFG.clientName  = (el('cfg-client')  || {}).value || CFG.clientName;
  CFG.clientEmail = (el('cfg-cemail')  || {}).value || CFG.clientEmail;
  CFG.clientPhone = (el('cfg-cphone')  || {}).value || CFG.clientPhone;
  CFG.clientRef   = (el('cfg-cref')    || {}).value || CFG.clientRef;
  CFG.brand       = (el('cfg-brand')   || {}).value || CFG.brand;
  CFG.channel     = (el('cfg-channel') || {}).value || CFG.channel;
  CFG.moveManager = (el('cfg-mm')      || {}).value || CFG.moveManager;
  CFG.status      = CFG.status || 'Provisional';
  var ocEl = el('cfg-origin-country');
  if (ocEl && ocEl.value) CFG.originCountry = countryToCode(ocEl.value) || 'XX';
  // Jobs
  var jb = CFG.jobs[0];
  jb.origin = (el('jcfg-origin-0') || {}).value || jb.origin;
  jb.dest   = (el('jcfg-dest-0')   || {}).value || jb.dest;
  var volEl = el('jcfg-vol-0');
  if (volEl) { if (jb.volUnit === 'cbm') jb.volCbm = volEl.value; else jb.volFt = volEl.value; }
  // Collect all additional job cards
  for (var ji = 1; ji < CFG.jobs.length; ji++) {
    var jbi = CFG.jobs[ji];
    jbi.origin = (el('jcfg-origin-' + ji) || {}).value || jbi.origin;
    jbi.dest   = (el('jcfg-dest-' + ji)   || {}).value || jbi.dest;
    var vEl = el('jcfg-vol-' + ji);
    if (vEl) { if (jbi.volUnit === 'cbm') jbi.volCbm = vEl.value; else jbi.volFt = vEl.value; }
  }
  // Storage out: vol to remove
  var vrEl = el('sto-volremove-0'); if (vrEl) jb.volToRemove = parseFloat(vrEl.value) || 0;
}

// ── STAGE 3: SCHEDULE & TEAM ─────────────────────────────────────────────
function cfgRenderScheduleAndTeam() {
  var h = '';

  // Date selection card
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">📅</div>';
  h += '<div class="cs-card-title">Date Selection</div></div>';
  h += '<div class="cs-body">';

  h += '<div style="display:flex;gap:14px;margin-bottom:16px">';
  h += '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12.5px;font-weight:600">';
  h += '<input type="radio" name="cfg-dateoption" value="fix" ' + ((CFG.selectedDates && CFG.selectedDates.length) || CFG.startDate ? 'checked' : '') + ' onchange="cfgToggleDateOption(\'fix\')">Assign dates now</label>';
  h += '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12.5px;font-weight:600">';
  h += '<input type="radio" name="cfg-dateoption" value="nodate" ' + ((!CFG.selectedDates || !CFG.selectedDates.length) && !CFG.startDate ? 'checked' : '') + ' onchange="cfgToggleDateOption(\'nodate\')">No date yet — save as enquiry</label>';
  h += '</div>';

  h += '<div id="cfg-date-section" style="' + ((CFG.selectedDates && CFG.selectedDates.length) || CFG.startDate ? '' : 'display:none') + '">';
  if (!CFG.isMultiDay) {
    var singleVal = (CFG.selectedDates && CFG.selectedDates[0]) ? CFG.selectedDates[0] : (CFG.startDate || '');
    if (!CFG.id) singleVal = '';
    h += '<div class="cfg-field"><label class="cfg-label">Select from matrix below, or type manually</label>';
    h += '<input class="cfg-input" id="cfg-startdate" type="date" value="' + singleVal + '" onchange="cfgManualDateChange()" style="max-width:200px"></div>';
  } else {
    var n = CFG.numDays || 2;
    var chosen = CFG.selectedDates ? CFG.selectedDates.slice() : [];
    var filled = chosen.filter(function(d){ return !!d; }).length;
    h += '<div class="dayslot-progress"><div class="dp-label' + (filled >= n ? ' done' : '') + '">' + (filled >= n ? '✓ All ' + n + ' days selected' : filled + ' of ' + n + ' days selected') + '</div>';
    h += '<div class="dp-bar-wrap"><div class="dp-bar" style="width:' + Math.round((filled / n) * 100) + '%"></div></div></div>';
    h += '<div style="margin-bottom:12px">';
    for (var si = 0; si < n; si++) {
      var slotDate = chosen[si] || '';
      h += '<div class="dayslot-row">';
      h += '<div class="dayslot-num' + (slotDate ? ' filled' : '') + '">Day ' + (si + 1) + '</div>';
      h += '<div class="dayslot-val' + (slotDate ? ' filled' : '') + '" id="ds-val-' + si + '">';
      if (slotDate) { h += '<span>📅 ' + fmtNice(slotDate) + ' (' + ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(slotDate).getDay()] + ')</span><span class="ds-clear" onclick="cfgClearSlot(' + si + ')">✕</span>'; }
      else { h += '<span style="color:#B0B8CC">Click a date below</span>'; }
      h += '</div></div>';
    }
    h += '</div>';
  }
  h += '</div>';
  h += '</div></div>';

  // Duration & options card
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#FFF5E0">🌙</div>';
  h += '<div class="cs-card-title">Duration &amp; Options</div></div>';
  h += '<div class="cs-body">';
  h += '<div class="mday-row"><label class="mday-toggle"><input type="checkbox" id="cfg-multiday"' + (CFG.isMultiDay ? ' checked' : '') + ' onchange="cfgToggleMultiday(this)"><span class="mday-slider"></span></label>';
  h += '<div style="flex:1"><div class="mday-lbl">Multi-day job</div><div class="mday-sub">Spans more than one calendar day</div></div>';
  if (CFG.isMultiDay) { h += '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:var(--t3)">Days:</span><input class="cfg-input" id="cfg-numdays" type="number" min="2" max="30" value="' + (CFG.numDays || 2) + '" style="width:64px" onchange="cfgNumDaysChange(this)"></div>'; }
  h += '</div>';
  h += '<div class="mday-row"><label class="mday-toggle"><input type="checkbox" id="cfg-overnight"' + (CFG.hasOvernight ? ' checked' : '') + ' onchange="cfgToggleOvernight(this)"><span class="mday-slider"></span></label>';
  h += '<div style="flex:1"><div class="mday-lbl">Overnight stays</div><div class="mday-sub">Crew needs accommodation</div></div>';
  if (CFG.hasOvernight) { h += '<div style="display:flex;align-items:center;gap:6px;flex-shrink:0"><input class="cfg-input" id="cfg-numnights" type="number" min="1" max="14" value="' + (CFG.numNights || 1) + '" style="width:56px"><span style="font-size:12px;color:var(--t3)">nights @ £</span><input class="cfg-input" id="cfg-nightallow" type="number" min="0" value="' + (CFG.overnightAllowance || 65) + '" style="width:68px"><span style="font-size:12px;color:var(--t3)">/person</span></div>'; }
  h += '</div>';
  h += '<div class="mday-row"><label class="mday-toggle"><input type="checkbox" id="cfg-weekend"' + (CFG.weekendWorking ? ' checked' : '') + '><span class="mday-slider"></span></label>';
  h += '<div><div class="mday-lbl">Weekend working</div><div class="mday-sub">Saturday or Sunday required</div></div></div>';
  h += '<div class="mday-row" style="margin-bottom:0"><label class="mday-toggle"><input type="checkbox" id="cfg-linkjourney"' + (CFG.linkJourney ? ' checked' : '') + ' onchange="cfgToggleLinkJourney(this)"><span class="mday-slider"></span></label>';
  h += '<div style="flex:1"><div class="mday-lbl">Part of a Journey / Run</div><div class="mday-sub">Link to existing journey or create new</div></div>';
  if (CFG.linkJourney) { h += '<select class="cfg-input cfg-select" id="cfg-journeysel" style="width:200px;flex-shrink:0"><option value="_new">+ Create new journey</option>'; for (var jni = 0; jni < JOURNEYS.length; jni++) { h += '<option value="' + JOURNEYS[jni].id + '"' + (CFG.journeyId === JOURNEYS[jni].id ? ' selected' : '') + '>' + esc(JOURNEYS[jni].label) + '</option>'; } h += '</select>'; }
  h += '</div>';
  h += '</div></div>';

  // Availability matrix card
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#E6FFF5">📊</div>';
  h += '<div class="cs-card-title">Availability</div>';
  h += CFG.isMultiDay ? '<div class="cs-card-sub">Click to fill day slots — can be non-consecutive</div>' : '<div class="cs-card-sub">Click any date to select it</div>';
  h += '</div>';
  h += '<div class="cs-body" id="cfg-avail-body"><div style="text-align:center;color:var(--t3);padding:20px;font-size:12px">Building availability...</div></div>';
  h += '</div>';

  // Crew assignment card — shown filtered to selected date
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">👷</div>';
  h += '<div class="cs-card-title">Crew Assignment</div>';
  var ds = CFG.startDate || '';
  if (ds) h += '<div class="cs-card-sub">' + fmtNice(ds) + '</div>';
  h += '</div><div class="cs-body">';
  for (var ci = 0; ci < CREW.length; ci++) {
    var cr = CREW[ci];
    var isSel = CFG.crewAssigned.indexOf(cr.name) >= 0;
    var avail = cfgCrewAvailStatus(cr.name, CFG.startDate);
    h += '<div class="res-person' + (isSel ? ' sel' : '') + '" onclick="cfgToggleCrew(this,\'' + cr.name + '\')">';
    h += '<div class="res-person-av" style="background:' + cr.col + '">' + cr.name.slice(0,2) + '</div>';
    h += '<div style="flex:1"><div class="res-person-name">' + esc(cr.name) + '</div><div class="res-person-role">' + esc(cr.role) + ' — £' + cr.chargeRate + '/day</div></div>';
    h += '<span class="res-person-status ' + avail.cls + '">' + avail.lbl + '</span>';
    h += '</div>';
  }
  h += '</div></div>';

  // Vehicles card
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#FFF5E0">🚐</div>';
  h += '<div class="cs-card-title">Vehicle Assignment</div></div>';
  h += '<div class="cs-body">';
  var needsSmall = CFG.jobs.some(function(jb){ return jb.access && (jb.access.smallVehicle || jb.access.tightAccess || jb.access.rdRestriction); });
  if (needsSmall) h += '<div class="cs-hint" style="margin-bottom:10px">⚠ Access flags suggest a small vehicle may be required</div>';
  for (var vi = 0; vi < VEHICLES.length; vi++) {
    var veh = VEHICLES[vi];
    var isSelV = CFG.vehAssigned.indexOf(veh.id) >= 0;
    var vAvail = cfgVehAvailStatus(veh.id, CFG.startDate);
    h += '<div class="res-person' + (isSelV ? ' sel' : '') + '" onclick="cfgToggleVeh(this,\'' + veh.id + '\')">';
    h += '<div class="res-person-av" style="background:#4A5568;font-size:9px">🚐</div>';
    h += '<div style="flex:1"><div class="res-person-name">' + esc(veh.name) + ' <span style="font-size:10.5px;color:#7A849E">' + esc(veh.reg) + '</span></div>';
    h += '<div class="res-person-role">' + esc(veh.type) + ' — ' + veh.volCapFt + 'ft³ — £' + veh.dayRate + '/day</div></div>';
    h += '<span class="res-person-status ' + vAvail.cls + '">' + vAvail.lbl + '</span>';
    h += '</div>';
  }
  h += '</div></div>';

  return h;
}

function cfgCollectScheduleAndTeam() {
  // Date
  var fixRadio = document.querySelector('input[name="cfg-dateoption"][value="fix"]');
  var nodate = !fixRadio || !fixRadio.checked;
  if (nodate) { CFG.startDate = ''; CFG.endDate = ''; CFG.selectedDates = []; }
  else {
    if (!CFG.isMultiDay) { var sdEl = el('cfg-startdate'); if (sdEl && sdEl.value) { CFG.startDate = sdEl.value; CFG.selectedDates = [sdEl.value]; } }
  }
  var mdEl = el('cfg-multiday'); if (mdEl) CFG.isMultiDay = mdEl.checked;
  var ndEl = el('cfg-numdays'); if (ndEl) CFG.numDays = parseInt(ndEl.value) || 2;
  var onEl = el('cfg-overnight'); if (onEl) CFG.hasOvernight = onEl.checked;
  var nnEl = el('cfg-numnights'); if (nnEl) CFG.numNights = parseInt(nnEl.value) || 1;
  var naEl = el('cfg-nightallow'); if (naEl) CFG.overnightAllowance = parseFloat(naEl.value) || 65;
  var wkEl = el('cfg-weekend'); if (wkEl) CFG.weekendWorking = wkEl.checked;
  var ljEl = el('cfg-linkjourney'); if (ljEl) CFG.linkJourney = ljEl.checked;
  var jsEl = el('cfg-journeysel'); if (jsEl) CFG.journeyId = (jsEl.value === '_new' ? null : jsEl.value);
}

// ── STAGE 4: CONFIRM ─────────────────────────────────────────────────────
function cfgRenderConfirm() {
  var h = '';
  var totalVol = CFG.jobs.reduce(function(s, jb){ return s + (parseFloat(jb.volFt) || 0); }, 0);
  var totalRev = CFG.jobs.reduce(function(s, jb){ return s + jb.billing.reduce(function(bs, bl){ return bs + (bl.amt || 0); }, 0); }, 0);

  // Summary bar
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#E6FFF5">✅</div>';
  h += '<div class="cs-card-title">Job Summary</div>';
  var statusCls = CFG.status === 'Confirmed' ? 'obs-confirmed' : CFG.status === 'Provisional' ? 'obs-provisional' : 'obs-draft';
  h += '<span class="' + statusCls + '">' + CFG.status + '</span>';
  h += '</div><div class="cs-body">';
  h += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">';
  h += '<div class="ops-di"><div class="ops-dl">Client</div><div class="ops-dv">' + esc(CFG.clientName || '—') + '</div></div>';
  h += '<div class="ops-di"><div class="ops-dl">Route</div><div class="ops-dv">' + esc(CFG.jobs[0].jobType || CFG.route || '—') + '</div></div>';
  h += '<div class="ops-di"><div class="ops-dl">Date</div><div class="ops-dv" style="color:var(--blue)">' + (CFG.startDate ? fmtNice(CFG.startDate) : 'Enquiry') + '</div></div>';
  h += '<div class="ops-di"><div class="ops-dl">Volume</div><div class="ops-dv">' + (totalVol ? totalVol + 'ft³' : 'TBC') + '</div></div>';
  h += '<div class="ops-di"><div class="ops-dl">Brand</div><div class="ops-dv">' + bbadge(CFG.brand) + '</div></div>';
  h += '<div class="ops-di"><div class="ops-dl">Revenue</div><div class="ops-dv" style="color:var(--blue)">' + (totalRev ? spv(fmt(totalRev)) : 'TBC') + '</div></div>';
  h += '</div></div></div>';

  // Services & access card
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#E6FFF5">🛠</div>';
  h += '<div class="cs-card-title">Additional Services</div></div>';
  h += '<div class="cs-body">';
  var jb0 = CFG.jobs[0];
  h += '<div class="svc-grid">';
  for (var si = 0; si < SERVICES.length; si++) {
    var sv = SERVICES[si];
    h += '<div class="svc-toggle' + (jb0.svcs[sv.key] ? ' on' : '') + '" onclick="cfgToggleSvc(0,this,\'' + sv.key + '\')">';
    h += '<span style="font-size:14px">' + sv.icon + '</span><span style="font-size:11.5px;font-weight:600;color:#1A2035;flex:1">' + sv.lbl + '</span>';
    h += '<div class="svc-check">' + (jb0.svcs[sv.key] ? '✓' : '') + '</div></div>';
  }
  h += '</div>';
  h += '<div style="margin-top:12px"><div class="cs-sub-label">Access &amp; Logistics</div>';
  h += '<div class="acc-grid">';
  for (var ai = 0; ai < ACCESS_FLAGS.length; ai++) {
    var af = ACCESS_FLAGS[ai];
    h += '<div class="acc-flag svc-toggle' + (jb0.access[af.key] ? ' on' : '') + '" onclick="cfgToggleAccess(0,this,\'' + af.key + '\')">';
    h += '<span style="font-size:14px">' + af.icon + '</span><span style="font-size:11.5px;font-weight:600;flex:1">' + af.lbl + '</span>';
    h += '<div class="svc-check">' + (jb0.access[af.key] ? '✓' : '') + '</div></div>';
  }
  h += '</div></div></div></div>';

  // Materials & charges card
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">📦</div>';
  h += '<div class="cs-card-title">Materials &amp; Charges</div></div>';
  h += '<div class="cs-body">';
  for (var mi = 0; mi < MATERIALS.length; mi++) {
    var mat = MATERIALS[mi];
    var selMat = (CFG.materials || []).filter(function(m){ return m.id === mat.id; })[0];
    var qty = selMat ? (selMat.qty || 0) : 0;
    h += '<div class="res-person" style="cursor:default">';
    h += '<div style="flex:1;font-size:12.5px;font-weight:500">' + esc(mat.name) + '</div>';
    h += '<div style="display:flex;align-items:center;gap:6px"><input type="number" class="cfg-input" id="cfgmat-' + mat.id + '" value="' + qty + '" min="0" style="width:70px;text-align:right" placeholder="Qty"><span style="font-size:11px;color:var(--t3)">@ £' + mat.unitCost + ' ea</span></div>';
    h += '</div>';
  }
  h += '<div style="margin-top:12px"><div class="cs-sub-label">Charges &amp; Taxes</div>';
  h += '<div id="cfg-charges-list">';
  var selChgs = CFG.charges || [];
  for (var chgi = 0; chgi < selChgs.length; chgi++) h += cfgChgRow(chgi, selChgs[chgi].name, selChgs[chgi].amt);
  h += '</div>';
  h += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">';
  for (var chgi2 = 0; chgi2 < CHARGES.length; chgi2++) h += '<button class="btn btn-s btn-sm" onclick="cfgAddCharge(\'' + esc(CHARGES[chgi2].name) + '\',' + CHARGES[chgi2].defaultAmt + ')">+ ' + esc(CHARGES[chgi2].name) + '</button>';
  h += '</div></div></div></div>';

  // Billing card
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#FFF0F0">💷</div>';
  h += '<div class="cs-card-title">Billing Lines</div></div>';
  h += '<div class="cs-body">';
  h += '<div id="jcfg-blines-0">';
  var jblines = jb0.billing || [];
  for (var bi = 0; bi < jblines.length; bi++) h += cfgBline(0, bi, jblines[bi].item, jblines[bi].amt);
  if (!jblines.length) h += cfgBline(0, 0, '', '');
  h += '</div>';
  h += '<button class="btn btn-s btn-sm" style="margin-top:4px" onclick="cfgAddBline(0)">+ Add billing line</button>';
  h += '</div></div>';

  // Notes card
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#F5EEFF">📝</div>';
  h += '<div class="cs-card-title">Notes</div></div>';
  h += '<div class="cs-body">';
  h += '<div class="cfg-field"><label class="cfg-label">Ops Notes (crew instructions, access details)</label>';
  h += '<textarea class="cfg-input" id="cfg-opsnotes" rows="3" style="resize:vertical">' + esc(CFG.opsNotes || '') + '</textarea></div>';
  h += '<div class="cfg-field" style="margin-top:10px"><label class="cfg-label">Client-Facing Notes (for confirmation email)</label>';
  h += '<textarea class="cfg-input" id="cfg-clientnotes" rows="2" style="resize:vertical">' + esc(CFG.clientNotes || '') + '</textarea></div>';
  h += '</div></div>';

  // Cancellation (edit mode only)
  if (CFG.id) {
    h += '<div class="cs-card">';
    h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#FFECEF">❌</div><div class="cs-card-title">Cancellation</div></div>';
    h += '<div class="cs-body">';
    h += '<div style="display:flex;gap:8px;margin-bottom:10px">';
    ['Date Changed','Date Postponed','Job Cancelled'].forEach(function(r) {
      var sel = CFG.cancelReason === r;
      h += '<div onclick="CFG.cancelReason=\'' + r + '\';cfgRenderStage()" style="flex:1;border:2px solid ' + (sel ? 'var(--red)' : 'var(--b1)') + ';border-radius:7px;padding:8px;text-align:center;cursor:pointer;background:' + (sel ? '#FFECEF' : 'var(--w)') + ';font-size:12px;font-weight:600;color:' + (sel ? 'var(--red)' : 'var(--t2)') + '">' + r + '</div>';
    });
    h += '</div>';
    h += '<div class="cfg-field"><label class="cfg-label">Cancellation Notes</label>';
    h += '<textarea class="cfg-input" id="cfg-cancel-notes" rows="2" style="resize:vertical">' + esc(CFG.cancelNotes || '') + '</textarea></div>';
    h += '</div></div>';
  }

  // Change log
  if (CFG.changeLog && CFG.changeLog.length) {
    h += '<div class="cs-card">';
    h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">📋</div><div class="cs-card-title">Change History</div></div>';
    h += '<div class="cs-body" style="padding:0">';
    CFG.changeLog.slice().reverse().forEach(function(entry) {
      var d = new Date(entry.ts);
      var when = d.getDate() + '/' + (d.getMonth() + 1) + '/' + d.getFullYear() + ' ' + String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
      var actionCol = entry.action === 'Created' ? 'var(--green)' : entry.action === 'Cancelled' ? 'var(--red)' : 'var(--blue)';
      h += '<div style="padding:9px 16px;border-bottom:1px solid var(--s2);display:flex;gap:10px;align-items:flex-start">';
      h += '<div style="font-size:10px;font-weight:700;color:' + actionCol + ';min-width:64px;padding-top:1px">' + entry.action + '</div>';
      h += '<div style="flex:1">';
      if (entry.changes && entry.changes.length) h += '<div style="font-size:11.5px;color:var(--t2)">' + entry.changes.map(function(c){ return esc(c); }).join(' · ') + '</div>';
      if (entry.note) h += '<div style="font-size:11px;color:var(--t3);margin-top:2px">' + esc(entry.note) + '</div>';
      h += '</div>';
      h += '<div style="font-size:10.5px;color:var(--t4);white-space:nowrap">' + when + '<br>' + esc(entry.user || '') + '</div>';
      h += '</div>';
    });
    h += '</div></div>';
  }

  // Status & publish
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#D1FAE5">🚀</div>';
  h += '<div class="cs-card-title">Status &amp; Publish</div></div>';
  h += '<div class="cs-body">';
  h += '<div style="display:flex;gap:10px">';
  ['Provisional','Confirmed'].forEach(function(s) {
    h += '<div onclick="cfgSetStatus(this,\'' + s + '\')" style="flex:1;border:2px solid ' + (CFG.status === s ? '#0073EA' : '#E3E7F0') + ';border-radius:8px;padding:10px;text-align:center;cursor:pointer;background:' + (CFG.status === s ? '#EBF4FF' : '#fff') + '" class="cfg-status-opt">';
    h += '<div style="font-size:16px">' + (s === 'Provisional' ? '🕐' : '✅') + '</div>';
    h += '<div style="font-size:12px;font-weight:700;margin-top:4px">' + s + '</div>';
    h += '<div style="font-size:10px;color:var(--t3);margin-top:2px">' + (s === 'Provisional' ? 'Hold on calendar' : 'Fully confirmed') + '</div>';
    h += '</div>';
  });
  h += '</div>';
  
  h += '</div></div>';

  return h;
}

function cfgCollectConfirm() {
  // Services, access, materials, charges, billing, notes — exact same logic as old cfgCollectResources + cfgCollectOps
  // Materials
  var mats = [];
  for (var mi = 0; mi < MATERIALS.length; mi++) {
    var qEl = el('cfgmat-' + MATERIALS[mi].id);
    var qty = parseInt((qEl || {}).value) || 0;
    if (qty > 0) mats.push({ id: MATERIALS[mi].id, qty: qty });
  }
  CFG.materials = mats;
  // Charges
  var chgs = [];
  var list = el('cfg-charges-list');
  if (list) {
    var rows = list.children;
    for (var ci = 0; ci < rows.length; ci++) {
      var nameEl = rows[ci].querySelector('div[style*="flex:1"]');
      var amtEl = rows[ci].querySelector('input[type="number"]');
      if (nameEl && amtEl) chgs.push({ name: nameEl.textContent.trim(), amt: parseFloat(amtEl.value) || 0 });
    }
  }
  CFG.charges = chgs;
  // Billing lines
  var blines = [];
  var cont = el('jcfg-blines-0');
  if (cont) {
    var brows = cont.querySelectorAll('[id^="jbl-0-"]');
    brows.forEach(function(row) {
      var itemEl = row.querySelector('[id^="jbli"]'), amtEl2 = row.querySelector('[id^="jbla"]');
      var item = (itemEl || {}).value || ''; var amt = parseFloat((amtEl2 || {}).value) || 0;
      if (item) blines.push({ item: item, amt: amt });
    });
  }
  CFG.jobs[0].billing = blines;
  // Notes
  CFG.opsNotes    = (el('cfg-opsnotes')     || {}).value || CFG.opsNotes;
  CFG.clientNotes = (el('cfg-clientnotes')  || {}).value || CFG.clientNotes;
  CFG.cancelNotes = (el('cfg-cancel-notes') || {}).value || CFG.cancelNotes;
}


// ── DATE JUMPER ──────────────────────────────────────────────────────────
var _djTarget = 'main'; // 'main' | 'warehouse' | 'matrix'

function openDateJumper(target) {
  _djTarget = target || 'main';
  var backdrop = el('dj-backdrop');
  backdrop.style.display = 'flex';
  var input = el('dj-input');
  // Pre-fill with current date for that target
  var today = new Date();
  if (target === 'warehouse') {
    input.value = d2s(whDate || today);
  } else {
    input.value = d2s(curDate || today);
  }
  djPreview(input.value);
  setTimeout(function(){ input.focus(); }, 50);
}

function closeDateJumper() {
  el('dj-backdrop').style.display = 'none';
}

function djPreview(val) {
  var btn = el('dj-go-btn');
  var preview = el('dj-preview');
  if (!val) {
    preview.textContent = '';
    btn.disabled = true;
    btn.style.opacity = '.5';
    return;
  }
  var d = new Date(val + 'T00:00:00');
  if (isNaN(d)) {
    preview.textContent = '';
    btn.disabled = true;
    btn.style.opacity = '.5';
    return;
  }
  var ws = weekMon(d);
  var we = addDays(ws, 6);
  preview.textContent = 'Week of ' + MS[ws.getMonth()].substr(0,3) + ' ' + ws.getDate() + ' – ' + MS[we.getMonth()].substr(0,3) + ' ' + we.getDate() + ', ' + we.getFullYear();
  preview.style.color = '#0073EA';
  btn.disabled = false;
  btn.style.opacity = '1';
}

function doDateJump() {
  var val = (el('dj-input') || {}).value;
  if (!val) return;
  var d = new Date(val + 'T00:00:00');
  if (isNaN(d)) return;
  closeDateJumper();
  if (_djTarget === 'warehouse') {
    whDate = d;
    renderWarehouse();
  } else if (_djTarget === 'matrix') {
    // For the availability matrix in the booking configurator
    // Calculate how many weeks offset from today
    var today = new Date();
    today.setHours(0,0,0,0);
    var diffDays = Math.round((weekMon(d) - weekMon(today)) / 86400000);
    var diffWeeks = Math.round(diffDays / 7);
    cfgMatrixOffset = Math.max(0, diffWeeks);
    if (el('cfg-avail-body')) cfgBuildMatrix();
  } else {
    curDate = d;
    renderActiveMod();
  }
}

function djQuick(weeksOffset) {
  var d = addDays(weekMon(new Date()), weeksOffset * 7);
  el('dj-input').value = d2s(d);
  djPreview(d2s(d));
}

// Allow Enter key to confirm
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && el('dj-backdrop') && el('dj-backdrop').style.display !== 'none') {
    closeDateJumper();
  }
  if (e.key === 'Enter' && el('dj-backdrop') && el('dj-backdrop').style.display !== 'none') {
    if (!el('dj-go-btn').disabled) doDateJump();
  }
});



function openDateJumper(target) {
  _djTarget = target || 'main';
  var backdrop = el('dj-backdrop');
  backdrop.style.display = 'flex';
  var input = el('dj-input');
  // Pre-fill with current date for that target
  var today = new Date();
  if (target === 'warehouse') {
    input.value = d2s(whDate || today);
  } else {
    input.value = d2s(curDate || today);
  }
  djPreview(input.value);
  setTimeout(function(){ input.focus(); }, 50);
}

function closeDateJumper() {
  el('dj-backdrop').style.display = 'none';
}

function djPreview(val) {
  var btn = el('dj-go-btn');
  var preview = el('dj-preview');
  if (!val) {
    preview.textContent = '';
    btn.disabled = true;
    btn.style.opacity = '.5';
    return;
  }
  var d = new Date(val + 'T00:00:00');
  if (isNaN(d)) {
    preview.textContent = '';
    btn.disabled = true;
    btn.style.opacity = '.5';
    return;
  }
  var ws = weekMon(d);
  var we = addDays(ws, 6);
  preview.textContent = 'Week of ' + MS[ws.getMonth()].substr(0,3) + ' ' + ws.getDate() + ' – ' + MS[we.getMonth()].substr(0,3) + ' ' + we.getDate() + ', ' + we.getFullYear();
  preview.style.color = '#0073EA';
  btn.disabled = false;
  btn.style.opacity = '1';
}

function doDateJump() {
  var val = (el('dj-input') || {}).value;
  if (!val) return;
  var d = new Date(val + 'T00:00:00');
  if (isNaN(d)) return;
  closeDateJumper();
  if (_djTarget === 'warehouse') {
    whDate = d;
    renderWarehouse();
  } else if (_djTarget === 'matrix') {
    // For the availability matrix in the booking configurator
    // Calculate how many weeks offset from today
    var today = new Date();
    today.setHours(0,0,0,0);
    var diffDays = Math.round((weekMon(d) - weekMon(today)) / 86400000);
    var diffWeeks = Math.round(diffDays / 7);
    cfgMatrixOffset = Math.max(0, diffWeeks);
    if (el('cfg-avail-body')) cfgBuildMatrix();
  } else {
    curDate = d;
    renderActiveMod();
  }
}

function djQuick(weeksOffset) {
  var d = addDays(weekMon(new Date()), weeksOffset * 7);
  el('dj-input').value = d2s(d);
  djPreview(d2s(d));
}

// Allow Enter key to confirm
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && el('dj-backdrop') && el('dj-backdrop').style.display !== 'none') {
    closeDateJumper();
  }
  if (e.key === 'Enter' && el('dj-backdrop') && el('dj-backdrop').style.display !== 'none') {
    if (!el('dj-go-btn').disabled) doDateJump();
  }
});

</script>
</body>
</html>