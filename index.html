<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OPS MANAGER</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;font-family:'Inter',sans-serif;font-size:13.5px;background:#f9ecec;color:#1C2333}
:root{
  --bg:#f9ecec;--w:#faf9f5;--s1:#f5f4ef;--s2:#ede9e0;
  --b1:#DDE1EA;--b2:#C4CAD6;
  --t1:#1C2333;--t2:#3D4560;--t3:#7A849E;--t4:#B0B8CC;
  --blue:#0073EA;--blt:#EBF4FF;
  --green:#00C875;--glt:#E6FFF5;
  --red:#E44258;--rlt:#FFECEF;
  --amber:#FF9F00;--alt:#FFF5E0;
  --purple:#A25DDC;--plt:#F5EEFF;
  --r:6px;
  --sh:0 1px 4px rgba(0,0,0,.08);
  --shm:0 4px 14px rgba(0,0,0,.11);
}

/* LAYOUT */
.sidebar{position:fixed;top:0;left:0;bottom:0;width:60px;background:#151c2c;display:flex;flex-direction:column;z-index:200;transition:width .22s cubic-bezier(.4,0,.2,1);overflow:hidden}
.sidebar:hover{width:232px}
.sidebar:hover .sb-label{opacity:1;transform:translateX(0);pointer-events:auto}
.sidebar:hover .sb-wordmark{opacity:1}
.sidebar:hover .nb-badge{right:10px}
.main{margin-left:60px;height:100vh;display:flex;flex-direction:column;overflow:hidden;transition:margin-left .22s cubic-bezier(.4,0,.2,1)}
.topbar{height:52px;background:var(--w);border-bottom:1px solid var(--b1);display:flex;align-items:center;padding:0 16px;gap:10px;flex-shrink:0;box-shadow:var(--sh)}
.content{flex:1;overflow:hidden;display:flex;flex-direction:column}
.page{display:none;flex:1;overflow:hidden;flex-direction:column}
.page.on{display:flex}

/* ── ICON RAIL ────────────────────────────────────────────────────────── */
/* Logo badge */
.sb-logo{height:60px;display:flex;align-items:center;padding:0 14px;gap:12px;flex-shrink:0;border-bottom:1px solid rgba(255,255,255,.06)}
.sb-icon{width:32px;height:32px;background:var(--blue);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;color:#fff;flex-shrink:0;letter-spacing:-.5px;box-shadow:0 0 0 3px rgba(0,115,234,.25)}
.sb-wordmark{opacity:0;transition:opacity .18s .04s;white-space:nowrap}
.sb-name{font-weight:700;font-size:13.5px;color:#fff;letter-spacing:-.2px}
.sb-tag{font-size:9px;color:rgba(255,255,255,.38);letter-spacing:.3px;margin-top:1px}

/* Nav area */
.sb-nav{flex:1;padding:10px 8px;overflow:hidden;display:flex;flex-direction:column;gap:2px}
.sb-group{margin-top:8px}
.sb-group:first-child{margin-top:0}

/* Section divider line */
.sb-sep{height:1px;background:rgba(255,255,255,.07);margin:8px 0}

/* Nav button */
.nb{
  position:relative;
  display:flex;align-items:center;gap:0;
  padding:0;height:40px;
  border-radius:8px;
  color:rgba(255,255,255,.45);
  cursor:pointer;font-size:13px;font-weight:600;
  border:none;background:none;width:100%;
  font-family:'Inter',sans-serif;
  transition:background .12s, color .12s;
  white-space:nowrap;overflow:hidden;
}
.nb:hover{background:rgba(255,255,255,.07);color:rgba(255,255,255,.85)}
.nb.on{background:rgba(0,115,234,.22);color:#fff}
.nb.on::before{
  content:'';position:absolute;left:0;top:8px;bottom:8px;
  width:3px;background:var(--blue);border-radius:0 2px 2px 0;
}

/* Icon slot — always 44px wide, centred */
.nb-ico{
  width:44px;min-width:44px;height:40px;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;
}
.nb svg{transition:opacity .12s}
.nb svg{opacity:.5}
.nb:hover svg,.nb.on svg{opacity:1}

/* Label — hidden until rail expands */
.sb-label{
  flex:1;font-size:13px;font-weight:600;
  opacity:0;transform:translateX(-6px);
  transition:opacity .15s .05s, transform .15s .05s;
  pointer-events:none;
}

/* Badge dot */
.nb-badge{
  position:absolute;right:-4px;top:7px;
  min-width:18px;height:18px;padding:0 5px;
  background:var(--blue);color:#fff;
  font-size:9px;font-weight:800;
  border-radius:9px;
  display:flex;align-items:center;justify-content:center;
  transition:right .22s cubic-bezier(.4,0,.2,1);
  line-height:1;
  border:2px solid #151c2c;
}
.nb-badge.hidden{display:none}

/* Tooltip — shown only when rail is collapsed */
.nb-tip{
  position:absolute;left:58px;top:50%;transform:translateY(-50%);
  background:#1e2840;color:#fff;font-size:11.5px;font-weight:600;
  padding:5px 10px;border-radius:6px;white-space:nowrap;
  pointer-events:none;opacity:0;z-index:9999;
  box-shadow:0 4px 12px rgba(0,0,0,.35);
  transition:opacity .1s;
}
.nb-tip::before{
  content:'';position:absolute;right:100%;top:50%;transform:translateY(-50%);
  border:5px solid transparent;border-right-color:#1e2840;
}
.nb:hover .nb-tip{opacity:1}
.sidebar:hover .nb-tip{opacity:0!important}

/* Footer user block */
.sb-foot{padding:10px 8px;border-top:1px solid rgba(255,255,255,.06);flex-shrink:0}
.sb-user{
  display:flex;align-items:center;gap:0;
  height:44px;border-radius:8px;padding:0;
  cursor:default;overflow:hidden;
  transition:background .12s;
}
.sb-user:hover{background:rgba(255,255,255,.06)}
.sb-av{
  width:44px;min-width:44px;height:44px;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.sb-av-inner{
  width:30px;height:30px;border-radius:50%;
  background:linear-gradient(135deg,#0073EA,#00C875);
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:800;color:#fff;
}
.sb-user-info{
  opacity:0;transform:translateX(-6px);
  transition:opacity .15s .05s, transform .15s .05s;
  white-space:nowrap;
}
.sidebar:hover .sb-user-info{opacity:1;transform:translateX(0)}
.sb-uname{font-size:12px;font-weight:700;color:#fff}
.sb-urole{font-size:10px;color:rgba(255,255,255,.38)}

/* TOPBAR */
.tb-title{font-weight:700;font-size:16px;letter-spacing:-.3px;white-space:nowrap}
.divider{width:1px;height:20px;background:var(--b1);flex-shrink:0}
.vtabs{display:flex;gap:1px;background:var(--s2);border:1px solid var(--b1);border-radius:5px;padding:2px}
.vt{padding:4px 10px;border-radius:3px;cursor:pointer;font-size:12px;font-weight:700;color:var(--t3);border:none;background:none;font-family:'Inter',sans-serif;white-space:nowrap;transition:all .1s}
.vt:hover{color:var(--t2)}
.vt.on{background:var(--w);color:var(--blue);box-shadow:var(--sh)}
.cnav{display:flex;align-items:center;gap:5px}
.cn-btn{width:26px;height:26px;border-radius:5px;border:1px solid var(--b1);background:var(--w);color:var(--t2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .1s}
.cn-btn:hover{border-color:var(--blue);color:var(--blue)}
.cn-lbl{font-weight:600;font-size:13px;min-width:160px;text-align:center;letter-spacing:-.2px}
.today-btn{padding:4px 10px;border-radius:5px;border:1px solid var(--b1);background:var(--w);color:var(--t2);cursor:pointer;font-size:12px;font-weight:700;font-family:'Inter',sans-serif;transition:all .1s}
.today-btn:hover{border-color:var(--blue);color:var(--blue)}
.tb-r{margin-left:auto;display:flex;align-items:center;gap:6px}
.btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:5px;font-family:'Inter',sans-serif;font-size:12.5px;font-weight:700;cursor:pointer;border:1px solid transparent;transition:all .1s;white-space:nowrap}
.btn-p{background:var(--blue);color:#fff;border-color:var(--blue)}
.btn-p:hover{background:#005cc0}
.btn-s{background:var(--w);color:var(--t2);border-color:var(--b1)}
.btn-s:hover{border-color:var(--b2);color:var(--t1)}
.btn-g{background:transparent;color:var(--t3);border:none;padding:5px 7px}
.btn-g:hover{background:var(--s2);color:var(--t1)}
.btn-sm{padding:4px 9px;font-size:12px}
.btn-del{background:var(--rlt);color:var(--red);border-color:#FFCCD3}
.btn-del:hover{background:var(--red);color:#fff}

/* ── CALENDAR — Vertical date-grouped job list ──────────────────────── */
.cal-outer{flex:1;overflow-y:auto;overflow-x:hidden}

/* Date section header — sticky within scroll */
.cal-date-hdr{
  position:sticky;top:0;z-index:10;
  display:flex;align-items:center;gap:12px;
  padding:7px 18px;
  background:var(--s1);
  border-bottom:2px solid var(--b1);
  border-top:1px solid var(--b1);
  cursor:pointer;
  transition:background .1s;
  user-select:none;
}
.cal-date-hdr:first-child{border-top:none}
.cal-date-hdr:hover{background:var(--blt)}
.cal-date-hdr.today{background:#EBF4FF;border-left:4px solid var(--blue)}
.cal-date-hdr.today .cdh-num{color:var(--blue)}
.cal-date-hdr.empty{opacity:.45}
.cdh-dow{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);width:24px}
.cdh-num{font-size:22px;font-weight:800;color:var(--t2);line-height:1;letter-spacing:-1px;min-width:28px}
.cdh-mon{font-size:12px;font-weight:600;color:var(--t3);min-width:28px}
.cdh-jobs{font-size:11px;font-weight:600;color:var(--t3);margin-left:4px}
.cdh-today-pill{background:var(--blue);color:#fff;font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;letter-spacing:.3px}
.cdh-rev{font-size:11px;font-weight:700;color:var(--blue);margin-left:auto}
.cdh-add{font-size:11px;font-weight:600;color:var(--t4);margin-left:8px;padding:2px 7px;border:1px solid var(--b1);border-radius:4px;background:var(--w)}
.cdh-add:hover{color:var(--blue);border-color:var(--blue)}

/* Journey group banner */
.jrn-banner{
  margin:0 14px 0;
  background:linear-gradient(90deg,#F0E8FF,var(--s1) 80%);
  border-left:3px solid var(--purple);
  border-radius:0;
  padding:5px 12px;
  display:flex;align-items:center;gap:8px;
  font-size:10.5px;
}
.jrn-banner-lbl{font-weight:700;color:var(--purple)}
.jrn-banner-ref{color:var(--t3)}
.jrn-banner-night{color:#E07B00;font-weight:600}

/* ── JOB CARD — full-width, icon-labelled, breathing room ─────────── */
.jcard{
  margin:5px 14px;
  background:#fff;
  border:1px solid var(--b1);
  border-radius:8px;
  border-left:5px solid var(--b1);
  cursor:pointer;
  transition:box-shadow .15s, transform .1s;
  box-shadow:0 1px 4px rgba(0,0,0,.06);
  overflow:hidden;
  position:relative;
}
.jcard:hover{box-shadow:0 4px 14px rgba(0,0,0,.11);transform:translateY(-1px)}
.jcard.in-journey{border-left-color:var(--purple) !important;background:linear-gradient(90deg,#FDFAFF 0px,#fff 80px)}

/* Card header */
.jcard-head{display:flex;align-items:stretch;border-bottom:1px solid var(--b1);min-height:60px}
/* Brand zone: fixed width, hard right border, white bg */
.jcard-logo{
  flex-shrink:0;width:80px;min-width:80px;
  display:flex;align-items:center;justify-content:center;
  border-right:2px solid var(--b1);
  background:#fff;padding:8px 10px;
}
/* Client + ref zone */
.jcard-title{
  flex:1;min-width:0;
  padding:10px 14px;
  display:flex;flex-direction:column;justify-content:center;gap:5px;
}
.jcard-client{
  font-weight:800;font-size:17px;letter-spacing:-.4px;line-height:1.1;
  color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.jcard-ref{
  font-size:12px;font-weight:700;letter-spacing:.3px;
  font-family:monospace;color:var(--t3);
}
/* Icon badge strip — top-right corner of header */
.jcard-flags{
  flex-shrink:0;display:flex;flex-direction:column;
  align-items:flex-end;justify-content:center;
  gap:5px;padding:8px 10px;border-left:1px solid var(--b1);
  min-width:110px;background:#fff;
}
.jcard-flag-row{display:flex;gap:4px;flex-wrap:wrap;justify-content:flex-end}
/* Individual flag pill */
.jflag{
  display:inline-flex;align-items:center;gap:3px;
  padding:3px 8px;border-radius:12px;
  font-size:10.5px;font-weight:700;white-space:nowrap;border:1px solid;
}
.jflag-journey{background:#F0E8FF;color:var(--purple);border-color:#C9AAFF}
.jflag-seq{background:var(--purple);color:#fff;border-color:var(--purple);font-size:11px;letter-spacing:.5px}
.jflag-multiday{background:#FFF3DA;color:#9A5600;border-color:#FFD580}
.jflag-overnight{background:#FFF0E0;color:#C05000;border-color:#FFBA70}
.jflag-storage{background:#E6F9F0;color:#007048;border-color:#7DD9B0}
/* Status + edit — right edge */
.jcard-actions{
  flex-shrink:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  gap:6px;padding:8px 10px;
  border-left:1px solid var(--b1);
}

/* Card body: info grid */
.jcard-body{
  display:grid;
  grid-template-columns:1fr 1fr 1fr auto;
  gap:0;
}
/* Info cell — each piece of info in its own block */
.jci{
  padding:9px 14px;
  border-right:1px solid var(--b1);
  display:flex;flex-direction:column;gap:3px;
  min-width:0;
}
.jci:last-child{border-right:none}
.jci-lbl{
  font-size:8.5px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;
  color:var(--t4);display:flex;align-items:center;gap:4px
}
.jci-lbl svg,.jci-lbl span.ico{flex-shrink:0;opacity:.7}
.jci-val{font-size:12.5px;font-weight:600;color:var(--t2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.jci-val.big{font-size:15px;font-weight:800;color:var(--t1);letter-spacing:-.3px}
.jci-val.mono{font-family:monospace;font-size:12px}
.jci-val.route{font-size:11.5px;white-space:normal;line-height:1.4}
.jci-val.green{color:#007048;font-weight:700}
.jci-val.blue{color:var(--blue);font-weight:700}

/* Crew cell spans full width underneath on its own row */
.jcard-foot{
  padding:7px 14px;
  border-top:1px solid var(--b1);
  display:flex;align-items:center;gap:8px;
  background:#fff;
  flex-wrap:wrap;
}
.jcard-foot-lbl{font-size:8.5px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t4)}

/* Tags */
.jctag{display:inline-flex;align-items:center;gap:3px;font-size:9.5px;font-weight:600;padding:2px 7px;border-radius:4px;background:var(--s2);color:var(--t2);border:1px solid var(--b1);white-space:nowrap}
.jctag.green{background:var(--glt);color:#007048;border-color:#B3EDD8}
.jctag.amber{background:var(--alt);color:#9A5600;border-color:#FFD88A}
.jctag.purple{background:var(--plt);color:var(--purple);border-color:#D4AEFF}
.jctag.blue{background:var(--blt);color:var(--blue);border-color:#A8CFFF}

/* No jobs empty state */
.cal-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:var(--t3);text-align:center}
/* End of period */
.cal-period-end{text-align:center;padding:20px;color:var(--t3);font-size:12px;border-top:1px solid var(--b1);margin-top:4px}


/* MONTH VIEW */
.mv-wrap{flex:1;display:grid;grid-template-columns:repeat(7,1fr);grid-template-rows:30px repeat(6,1fr);overflow-y:auto}
.mv-head{background:var(--s1);border-bottom:2px solid var(--b1);border-right:1px solid var(--b1);display:flex;align-items:center;justify-content:center;font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);position:sticky;top:0;z-index:5}
.mv-cell{border-bottom:1px solid var(--b1);border-right:1px solid var(--b1);padding:5px;min-height:90px;cursor:pointer;transition:background .1s;background:var(--w);overflow:hidden}
.mv-cell:hover{background:var(--s1)}
.mv-other{background:var(--s2);opacity:.5}
.mv-today .mv-date{background:var(--blue);color:#fff;border-radius:50%}
.mv-date{width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:12px;color:var(--t2);margin-bottom:3px}
.mv-pill{padding:2px 5px;border-radius:3px;font-size:9.5px;font-weight:700;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer}
.mv-more{font-size:9.5px;color:var(--t3);font-weight:600;cursor:pointer}
.mv-more:hover{color:var(--blue)}

/* LIST VIEW */
.lv-wrap{flex:1;overflow-y:auto}
.lv-mhead{padding:10px 20px 5px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);background:var(--bg);border-bottom:1px solid var(--b1);position:sticky;top:0;z-index:5}
.lv-row{display:flex;align-items:stretch;border-bottom:1px solid var(--b1);cursor:pointer;background:var(--w);transition:background .1s}
.lv-row:hover{background:var(--s1)}
.lv-date{width:80px;flex-shrink:0;padding:10px 12px;border-right:1px solid var(--b1)}
.lv-bar{width:4px;flex-shrink:0}
.lv-body{flex:1;padding:9px 13px;min-width:0}
.lv-crew{width:140px;flex-shrink:0;padding:9px 12px;border-left:1px solid var(--b1);display:flex;flex-wrap:wrap;gap:3px;align-content:flex-start}
.lv-status{width:105px;flex-shrink:0;padding:9px 13px;border-left:1px solid var(--b1);display:flex;align-items:center}
.lv-bill{width:90px;flex-shrink:0;padding:9px 13px;border-left:1px solid var(--b1);text-align:right;font-weight:600;font-size:13px;color:var(--blue);display:flex;align-items:center;justify-content:flex-end}

/* CREW VIEW */
.crew-outer{flex:1;overflow:auto}
.crew-table{border-collapse:collapse;min-width:100%;background:var(--w)}
.crew-table th{padding:8px 12px;background:var(--s1);border-bottom:2px solid var(--b1);border-right:1px solid var(--b1);font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);white-space:nowrap;position:sticky;top:0;z-index:10}
.crew-table td{border-bottom:1px solid var(--b1);border-right:1px solid var(--b1);vertical-align:top}
.crew-nm-td{width:155px;min-width:155px;padding:9px 12px}
.crew-av{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;flex-shrink:0}
.crew-day-td{min-width:105px;width:105px;padding:5px;min-height:52px}
.cassign{border-radius:4px;padding:3px 6px;font-size:10.5px;font-weight:700;margin-bottom:2px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:filter .1s}
.cassign:hover{filter:brightness(.92)}
.c-hol{background:#FFECEF;color:var(--red);border:1px dashed #FFCCD3;border-radius:4px;padding:3px 6px;font-size:10px;font-weight:600;font-style:italic}
.c-off{color:var(--t4);font-size:10.5px;text-align:center;padding:7px 0;display:block;width:100%}
.ubar{height:3px;background:var(--s2);border-radius:2px;margin-top:4px;overflow:hidden}
.ufill{height:100%;border-radius:2px}

/* FINANCE VIEW */
.fin-outer{flex:1;overflow-y:auto;padding:18px 22px}
.fin-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
.fstat{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);padding:14px 16px;box-shadow:var(--sh);border-top:3px solid var(--b2)}
.fstat.c-b{border-top-color:var(--blue)}
.fstat.c-g{border-top-color:var(--green)}
.fstat.c-a{border-top-color:var(--amber)}
.fstat.c-p{border-top-color:var(--purple)}
.fstat-l{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);margin-bottom:4px}
.fstat-v{font-weight:700;font-size:24px;letter-spacing:-.4px}
.fstat-s{font-size:10.5px;color:var(--t3);margin-top:2px}
.fin-2col{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
.fc{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);box-shadow:var(--sh)}
.fc-head{padding:11px 15px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between}
.fc-title{font-weight:700;font-size:13.5px;letter-spacing:-.2px}
.fc-body{padding:13px 15px}
.fin-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--b1);font-size:12.5px}
.fin-row:last-child{border-bottom:none}
.fin-lbl{color:var(--t2)}
.fin-val{font-weight:700;font-size:12px}
.brr{display:flex;align-items:center;gap:9px;padding:6px 0;border-bottom:1px solid var(--b1)}
.brr:last-child{border-bottom:none}
.brr-nm{width:80px;flex-shrink:0}
.brr-bar{flex:1;height:6px;background:var(--s2);border-radius:3px;overflow:hidden}
.brr-fill{height:100%;border-radius:3px;transition:width .5s}
.brr-val{width:80px;text-align:right;font-weight:600;font-size:12px;flex-shrink:0}
.brr-pct{width:32px;text-align:right;font-size:10px;color:var(--t3);flex-shrink:0}
.ctable{width:100%;border-collapse:collapse}
.ctable th{padding:7px 12px;font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);background:var(--s1);border-bottom:2px solid var(--b1);text-align:left}
.ctable td{padding:8px 12px;border-bottom:1px solid var(--b1);font-size:12.5px;vertical-align:middle}
.ctable tfoot td{background:var(--s2);font-weight:700;font-size:13px;padding:9px 12px;border-top:2px solid var(--b1)}
.ctable tbody tr{cursor:pointer;transition:background .1s}
.ctable tbody tr:hover td{background:var(--s1)}

/* GLOBAL SENSITIVE VALUE PROTECTION */
/* All £ values wrapped in .spv are hidden until eye toggle is active */
.spv{transition:filter .2s,opacity .2s;display:inline}
body:not(.vals-visible) .spv{filter:blur(6px);opacity:.25;pointer-events:none;user-select:none}
body.vals-visible .spv{filter:none;opacity:1}

/* Eye button — sidebar footer, icon only */
.eye-btn{
  position:fixed;
  bottom:18px;left:18px;
  z-index:600;
  display:flex;align-items:center;justify-content:center;
  width:38px;height:38px;border-radius:8px;
  border:1px solid var(--b1);cursor:pointer;
  font-size:18px;background:var(--w);color:var(--t2);
  font-family:'Inter',sans-serif;transition:all .15s;
  box-shadow:0 2px 8px rgba(0,0,0,.12);
}
.eye-btn:hover{background:var(--blt);border-color:var(--blue)}
body.vals-visible .eye-btn{background:var(--blt);border-color:var(--blue);box-shadow:0 0 0 3px var(--blue)33,0 2px 8px rgba(0,0,0,.12)}

/* RATES VIEW (legacy, still used) */
.rates-outer{flex:1;overflow-y:auto;padding:18px 22px}

/* SETTINGS MODULE */
.settings-outer{flex:1;overflow:hidden;display:flex;flex-direction:column}
.settings-tabs{display:flex;gap:0;border-bottom:2px solid var(--b1);background:var(--w);flex-shrink:0;padding:0 20px}
.stab{padding:11px 18px;font-size:12.5px;font-weight:600;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s;border:none;background:none;font-family:'Inter',sans-serif}
.stab:hover{color:var(--t2)}
.stab.on{color:var(--blue);border-bottom-color:var(--blue);font-weight:700}
.settings-body{flex:1;overflow-y:auto;padding:20px 24px;background:var(--bg)}
.settings-card{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);box-shadow:var(--sh);margin-bottom:14px;overflow:hidden}
.sc-head{padding:12px 16px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;background:var(--s1)}
.sc-title{font-weight:700;font-size:13.5px;letter-spacing:-.2px}
.sc-sub{font-size:11px;color:var(--t3);margin-top:1px}
.sc-body{padding:14px 16px}
.sc-table{width:100%;border-collapse:collapse}
.sc-table th{padding:7px 10px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);background:var(--s1);border-bottom:2px solid var(--b1);text-align:left;white-space:nowrap}
.sc-table td{padding:8px 10px;border-bottom:1px solid var(--b1);font-size:12.5px;vertical-align:middle}
.sc-table tr:last-child td{border-bottom:none}
.sc-input{padding:5px 8px;border:1px solid var(--b1);border-radius:4px;font-family:'Inter',sans-serif;font-size:12.5px;color:var(--t1);background:var(--w);outline:none;transition:border-color .15s;width:100%}
.sc-input:focus{border-color:var(--blue);box-shadow:0 0 0 2px rgba(0,115,234,.1)}
.sc-input.narrow{width:90px;text-align:right}
.sc-input.mid{width:130px}
.veh-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:14px 16px}
.veh-card{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh)}
.veh-card-top{background:var(--s2);padding:10px 12px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between}
.veh-card-body{padding:10px 12px}
.veh-field{display:flex;flex-direction:column;gap:2px;margin-bottom:7px}
.veh-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)}
.add-row{display:flex;gap:8px;padding:10px 16px;border-top:1px solid var(--b1);background:var(--s1);flex-wrap:wrap;align-items:flex-end}

/* BOOKING RESOURCE SECTIONS */
.res-section{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);margin-bottom:10px;overflow:hidden}
.res-head{padding:9px 14px;border-bottom:1px solid var(--b1);background:var(--s1);display:flex;align-items:center;justify-content:space-between}
.res-title{font-weight:700;font-size:12.5px}
.res-body{padding:10px 14px}
.res-grid{display:grid;gap:8px}
.res-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--b1);border-radius:5px;background:var(--w);cursor:pointer;transition:all .1s;font-size:12.5px}
.res-item:hover{border-color:var(--blue);background:var(--blt)}
.res-item.sel{border-color:var(--blue);background:var(--blt)}
.res-item.sel .ri-check{background:var(--blue);border-color:var(--blue);color:#fff}
.ri-check{width:16px;height:16px;border-radius:3px;border:1.5px solid var(--b2);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;transition:all .1s}
.ri-name{flex:1;font-weight:500}
.ri-qty{width:55px;flex-shrink:0}
.ri-price{font-size:11px;color:var(--t3);flex-shrink:0;min-width:50px;text-align:right}
.cost-breakdown{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:12px 14px;margin-top:10px}
.cb-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:12.5px;border-bottom:1px solid var(--b1)}
.cb-row:last-child{border-bottom:none}
.cb-total{display:flex;justify-content:space-between;font-weight:700;font-size:13.5px;padding:9px 0 0;border-top:2px solid var(--t1);margin-top:4px}

/* BOOKING MODULE */
.bk-outer{flex:1;overflow-y:auto;background:var(--bg)}
.bk-split{display:grid;grid-template-columns:340px 1fr;height:100%;overflow:hidden}
.bk-left{border-right:1px solid var(--b1);display:flex;flex-direction:column;overflow:hidden;background:var(--w)}
.bk-right{display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}
.bk-left-head{padding:14px 16px;border-bottom:1px solid var(--b1);flex-shrink:0}
.bk-right-head{padding:14px 18px;border-bottom:1px solid var(--b1);background:var(--w);flex-shrink:0;display:flex;align-items:center;justify-content:space-between}
.bk-list{flex:1;overflow-y:auto}
.bk-item{padding:11px 16px;border-bottom:1px solid var(--b1);cursor:pointer;transition:background .1s;display:flex;align-items:flex-start;gap:10px}
.bk-item:hover{background:var(--s1)}
.bk-item.on{background:var(--blt);border-right:3px solid var(--blue)}
.bk-ref{font-size:10px;font-weight:700;letter-spacing:.4px;color:var(--t3);font-variant-numeric:tabular-nums}
.bk-client{font-size:13px;font-weight:600;color:var(--t1);margin-top:1px}
.bk-meta{font-size:11px;color:var(--t3);margin-top:2px}
.bk-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:4px}

/* BOOKING FORM */
.bf-wrap{flex:1;overflow-y:auto;padding:20px 24px}
.bf-section{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);margin-bottom:14px;overflow:hidden;box-shadow:var(--sh)}
.bf-sec-head{padding:11px 16px;border-bottom:1px solid var(--b1);display:flex;align-items:center;gap:8px;background:var(--s1)}
.bf-sec-num{width:20px;height:20px;border-radius:50%;background:var(--blue);color:#fff;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.bf-sec-title{font-weight:600;font-size:13px}
.bf-body{padding:14px 16px}
.bf-row{display:grid;gap:10px;margin-bottom:10px}
.bf-row.col2{grid-template-columns:1fr 1fr}
.bf-row.col3{grid-template-columns:1fr 1fr 1fr}
.bf-row.col1{grid-template-columns:1fr}
.bf-field{display:flex;flex-direction:column;gap:3px}
.bf-label{font-size:9.5px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)}
.bf-input{padding:7px 10px;border:1px solid var(--b1);border-radius:5px;font-family:'Inter',sans-serif;font-size:13px;color:var(--t1);background:var(--w);outline:none;transition:border-color .15s,box-shadow .15s;width:100%}
.bf-input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,115,234,.1)}
.bf-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%237A849E' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}
.bf-textarea{min-height:70px;resize:vertical;line-height:1.6}

/* AI PARSE BOX */
.ai-parse-box{background:linear-gradient(135deg,#EBF4FF 0%,#F5EEFF 100%);border:1px solid #C4DAFF;border-radius:var(--r);padding:14px 16px;margin-bottom:14px}
.ai-parse-title{font-weight:700;font-size:13px;color:var(--t1);display:flex;align-items:center;gap:7px;margin-bottom:6px}
.ai-parse-sub{font-size:11.5px;color:var(--t2);margin-bottom:10px;line-height:1.5}
.ai-parse-ta{width:100%;min-height:90px;resize:vertical;padding:8px 11px;border:1px solid #C4DAFF;border-radius:5px;font-family:'Inter',sans-serif;font-size:12px;color:var(--t1);background:#faf9f5;outline:none;transition:border-color .15s}
.ai-parse-ta:focus{border-color:var(--blue);background:#faf9f5}
.ai-spin{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:5px}
@keyframes spin{to{transform:rotate(360deg)}}

/* REF BADGE */
.ref-badge{display:inline-flex;align-items:center;gap:6px;background:var(--t1);color:#fff;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:700;letter-spacing:.5px;font-variant-numeric:tabular-nums}

/* EMAIL PREVIEW */
.email-preview{background:#faf9f5;border:1px solid var(--b1);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh)}
.ep-bar{background:var(--s1);border-bottom:1px solid var(--b1);padding:10px 14px;display:flex;gap:8px;align-items:center}
.ep-dot{width:10px;height:10px;border-radius:50%}
.ep-header{padding:14px 18px;border-bottom:1px solid var(--b1)}
.ep-body{padding:18px;font-size:13px;line-height:1.8;color:var(--t2)}
.ep-field{display:flex;gap:10px;margin-bottom:4px;font-size:12.5px}
.ep-lbl{color:var(--t3);font-weight:600;width:80px;flex-shrink:0}
.ep-val{color:var(--t1);font-weight:500}
.ep-divider{border:none;border-top:1px solid var(--b1);margin:14px 0}

/* STATUS PILL for bookings */
.bst{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:3px;font-size:10.5px;font-weight:600}
.bst-confirmed{background:#E6FFF5;color:#007048}
.bst-sent{background:#EBF4FF;color:#0052B0}
.bst-pending{background:#FFF5E0;color:#9A5600}
.rate-in{width:80px;padding:5px 8px;border:1px solid var(--b1);border-radius:5px;font-family:'Inter',sans-serif;font-size:13.5px;font-weight:700;color:var(--t1);text-align:right;outline:none;transition:border-color .1s}
.rate-in:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,115,234,.1)}

/* ── JOB CONFIGURATOR PANEL ─────────────────────────────────────────── */
.cfg-backdrop{position:fixed;inset:0;background:rgba(15,20,35,.35);z-index:600;opacity:0;pointer-events:none;transition:opacity .25s}
.cfg-backdrop.on{opacity:1;pointer-events:all}
.cfg-panel{position:fixed;top:0;right:0;bottom:0;width:700px;background:#f0efe9;z-index:601;display:flex;flex-direction:column;transform:translateX(105%);transition:transform .28s cubic-bezier(.4,0,.2,1);box-shadow:-4px 0 32px rgba(0,0,0,.18)}
.cfg-panel.on{transform:translateX(0)}
.cfg-head{background:#faf9f5;border-bottom:1px solid #E3E7F0;padding:0 24px;display:flex;align-items:center;gap:0;flex-shrink:0;height:58px}
.cfg-head-title{font-size:15px;font-weight:700;color:#1A2035;flex:1;letter-spacing:-.3px}
.cfg-head-ref{font-size:11px;font-weight:700;letter-spacing:.5px;color:#fff;background:#1A2035;padding:3px 9px;border-radius:4px;margin-right:12px;font-variant-numeric:tabular-nums}
.cfg-close{width:32px;height:32px;border-radius:6px;border:1px solid #E3E7F0;background:#f0efe9;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;color:#7A849E;transition:all .12s}
.cfg-close:hover{background:#faf9f5;border-color:#0073EA;color:#0073EA}
.cfg-stages{background:#faf9f5;border-bottom:2px solid #E3E7F0;display:flex;flex-shrink:0;overflow-x:auto;padding:0 8px}
.cfg-stage{flex:1;padding:10px 4px 9px;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s;min-width:80px}
.cfg-stage:hover{background:#f0efe9}
.cfg-stage.done{border-bottom-color:#00C875}
.cfg-stage.active{border-bottom-color:#0073EA}
.cfg-stage-num{width:22px;height:22px;border-radius:50%;background:#E3E7F0;color:#7A849E;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
.cfg-stage.done .cfg-stage-num{background:#00C875;color:#fff}
.cfg-stage.active .cfg-stage-num{background:#0073EA;color:#fff}
.cfg-stage-lbl{font-size:9px;font-weight:700;color:#7A849E;text-align:center;letter-spacing:.3px;text-transform:uppercase;white-space:nowrap}
.cfg-stage.active .cfg-stage-lbl{color:#0073EA}
.cfg-stage.done .cfg-stage-lbl{color:#00C875}
.cfg-body{flex:1;overflow-y:auto;padding:20px 24px}
.cfg-foot{background:#faf9f5;border-top:1px solid #E3E7F0;padding:14px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.cs-card{background:#faf9f5;border:1px solid #E3E7F0;border-radius:10px;margin-bottom:14px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.cs-card-head{padding:11px 16px;border-bottom:1px solid #ede9e0;background:#f5f4ef;display:flex;align-items:center;gap:10px}
.cs-card-icon{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.cs-card-title{font-size:13px;font-weight:700;color:#1A2035;flex:1}
.cs-card-sub{font-size:11px;color:#7A849E}
.cs-body{padding:16px}
.ai-field-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.ai-field-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#7A849E;width:100px;flex-shrink:0}
.ai-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:4px;font-size:12px;font-weight:500;cursor:pointer;transition:all .12s;border:1px solid transparent;max-width:280px;word-break:break-word}
.ai-chip.confirmed{background:#E6FFF5;color:#007048;border-color:#B8EDD9}
.ai-chip.assumed{background:#FFF5E0;color:#9A5600;border-color:#FFE4A0;animation:pulse-amber 2s ease-in-out infinite}
.ai-chip.missing{background:#FFF0F0;color:#C0392B;border-color:#FFD0D0}
@keyframes pulse-amber{0%,100%{box-shadow:0 0 0 0 rgba(255,165,0,0)}50%{box-shadow:0 0 0 3px rgba(255,165,0,.2)}}
.ai-edit-input{padding:5px 9px;border:1.5px solid #0073EA;border-radius:5px;font-size:12px;color:#1A2035;outline:none;width:220px;font-family:'Inter',sans-serif}
.jcfg-card{background:#faf9f5;border:2px solid #E3E7F0;border-radius:10px;margin-bottom:12px;overflow:hidden;transition:border-color .15s}
.jcfg-card:hover{border-color:#C4DAFF}
.jcfg-head{padding:11px 14px;background:#f0efe9;border-bottom:1px solid #E3E7F0;display:flex;align-items:center;gap:10px}
.jcfg-num{width:24px;height:24px;border-radius:50%;background:#0073EA;color:#fff;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.jcfg-label{font-size:13px;font-weight:700;color:#1A2035;flex:1}
.jcfg-body{padding:14px}
.jcfg-row{display:grid;gap:10px;margin-bottom:10px}
.jcfg-row.col2{grid-template-columns:1fr 1fr}
.jcfg-row.col3{grid-template-columns:1fr 1fr 1fr}
.jtype-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:4px}
.jtype-tile{border:1.5px solid #E3E7F0;border-radius:7px;padding:8px 6px;cursor:pointer;text-align:center;transition:all .12s;background:#fff}
.jtype-tile:hover{border-color:#0073EA;background:#F0F7FF}
.jtype-tile.sel{border-color:#0073EA;background:#EBF4FF;box-shadow:0 0 0 2px rgba(0,115,234,.12)}
.jtype-icon{font-size:16px;display:block;margin-bottom:2px}
.jtype-lbl{font-size:10px;font-weight:700;color:#1A2035;line-height:1.2}
.jtype-sub{font-size:9px;color:#7A849E;margin-top:1px}
.dest-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
.dest-tile{border:1.5px solid #E3E7F0;border-radius:6px;padding:7px 10px;cursor:pointer;display:flex;align-items:center;gap:7px;transition:all .12s}
.dest-tile:hover{border-color:#0073EA;background:#F0F7FF}
.dest-tile.sel{border-color:#0073EA;background:#EBF4FF}
.dest-icon{font-size:14px;flex-shrink:0}
.dest-lbl{font-size:11px;font-weight:600;color:#1A2035}
.svc-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
.svc-toggle{border:1.5px solid #E3E7F0;border-radius:6px;padding:7px 11px;cursor:pointer;display:flex;align-items:center;gap:7px;transition:all .12s;background:#fff}
.svc-toggle:hover{border-color:#0073EA;background:#F0F7FF}
.svc-toggle.on{border-color:#0073EA;background:#EBF4FF}
.svc-check{width:16px;height:16px;border-radius:3px;border:1.5px solid #C4CBDA;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;transition:all .12s}
.svc-toggle.on .svc-check{background:#0073EA;border-color:#0073EA;color:#fff}
.acc-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
.acc-flag{border:1.5px solid #E3E7F0;border-radius:6px;padding:7px 11px;cursor:pointer;display:flex;align-items:center;gap:7px;transition:all .12s;background:#fff}
.acc-flag:hover{border-color:#FF9F1A;background:#FFF9F0}
.acc-flag.on{border-color:#FF9F1A;background:#FFF5E0}
.acc-flag.on .svc-check{background:#FF9F1A;border-color:#FF9F1A;color:#fff}
.svc-toggle-icon,.dest-icon-lbl{font-size:12px;font-weight:600;color:#1A2035;flex:1}
.vol-row{display:flex;gap:8px;align-items:center}
.vol-unit-btn{padding:5px 12px;border:1.5px solid #E3E7F0;border-radius:5px;font-size:12px;font-weight:600;cursor:pointer;color:#7A849E;background:#fff;transition:all .1s}
.vol-unit-btn.sel{border-color:#0073EA;background:#EBF4FF;color:#0073EA}
.avail-matrix{border:1px solid #E3E7F0;border-radius:8px;overflow:hidden;margin-top:10px}
.avail-head-row{display:flex;background:#f0efe9;border-bottom:1px solid #E3E7F0;padding:6px 0}
.avail-head-date{width:130px;flex-shrink:0;padding:0 12px;font-size:10px;font-weight:700;color:#7A849E;letter-spacing:.4px;text-transform:uppercase}
.avail-head-res{flex:1;text-align:center;font-size:10px;font-weight:700;color:#7A849E;letter-spacing:.3px;text-transform:uppercase;border-left:1px solid #ede9e0;padding:0 6px}
.avail-row{display:flex;border-bottom:1px solid #ede9e0;transition:background .1s;cursor:pointer}
.avail-row:last-child{border-bottom:none}
.avail-row:hover{background:#f5f4ef}
.avail-row.chosen{background:#EBF4FF}
.avail-row.chosen .avail-date-cell{color:#0073EA}
.avail-date-cell{width:130px;flex-shrink:0;padding:8px 12px;font-size:12px;font-weight:600;color:#1A2035;display:flex;flex-direction:column;gap:1px}
.avail-dow{font-size:10px;color:#7A849E;font-weight:500}
.avail-res-cell{flex:1;padding:6px 8px;border-left:1px solid #ede9e0;display:flex;align-items:center;justify-content:center}
.avail-bar{height:22px;border-radius:4px;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;width:100%;letter-spacing:.2px;transition:all .12s}
.avail-bar.free{background:#D1FAE5;color:#065F46}
.avail-bar.partial{background:#FEF3C7;color:#92400E}
.avail-bar.busy{background:#FEE2E2;color:#991B1B}
.avail-bar.wknd{background:#ede9e0;color:#9CA3AF}
.avail-legend{display:flex;gap:14px;padding:10px 12px;border-top:1px solid #E3E7F0;flex-wrap:wrap}

/* ── Storage direction panel (configurator Stage 2) ─────────────────── */
.sto-dir-tiles{display:flex;gap:10px;margin-bottom:12px}
.sto-dir-tile{flex:1;border:2px solid #E3E7F0;border-radius:8px;padding:12px 14px;cursor:pointer;transition:all .13s;background:#fff;display:flex;align-items:center;gap:10px}
.sto-dir-tile:hover{border-color:#0073EA;background:#F0F7FF}
.sto-dir-tile.sel{border-color:#0073EA;background:#EBF4FF}
.sto-dir-icon{font-size:22px;flex-shrink:0}
.sto-dir-lbl{font-size:12.5px;font-weight:700;color:#1A2035}
.sto-dir-sub{font-size:10.5px;color:#7A849E;margin-top:2px}
.sto-rec-card{border:1.5px solid #E3E7F0;border-radius:7px;padding:10px 14px;margin-bottom:8px;cursor:pointer;background:#fff;transition:all .12s}
.sto-rec-card:hover{border-color:#0073EA;background:#F0F7FF}
.sto-rec-card.sel{border-color:#0073EA;background:#EBF4FF}
.sto-rec-head{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.sto-rec-id{font-family:monospace;font-weight:700;font-size:12px;color:#0073EA}
.sto-rec-client{font-weight:700;font-size:13px;color:#1A2035;flex:1}
.sto-rec-vol{font-size:11px;color:#7A849E}
.sto-status-badge{font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px;background:#D1FAE5;color:#007048}
.sto-status-badge.pending{background:#FFF5E0;color:#9A5600}
.sto-status-badge.out{background:#F0F2F8;color:#6B7280}
.sto-container-row{display:flex;align-items:center;gap:8px;padding:7px 10px;border:1px solid #E3E7F0;border-radius:6px;margin-bottom:5px;background:#fff;font-size:12px}
.sto-container-row.sel{border-color:#0073EA;background:#EBF4FF}
.sto-container-row.sel .sto-cno{color:#0073EA}
.sto-cno{font-family:monospace;font-weight:700;color:#1A2035;min-width:54px}
.sto-loc{color:#7A849E;font-size:11px;min-width:70px}
.sto-ctype{font-size:10.5px;font-weight:600;padding:1px 6px;border-radius:3px;background:#F0F2F8;color:#3D4560;flex-shrink:0}
.sto-cvol{margin-left:auto;font-size:11.5px;font-weight:600;color:#1A2035}
.sto-remove-cb{width:16px;height:16px;cursor:pointer;flex-shrink:0;accent-color:#0073EA}
.sto-vol-calc{background:#FFF5E0;border:1px solid #FFD580;border-radius:7px;padding:10px 14px;margin-top:10px}
.sto-vol-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:12.5px}
.sto-vol-lbl{color:#3D4560;font-weight:500}
.sto-vol-val{font-weight:700;color:#1A2035}
.sto-vol-val.red{color:#E44258}
.sto-vol-val.green{color:#00C875}
.sto-new-ctr-row{display:flex;gap:6px;margin-bottom:6px;align-items:center}
.avail-leg-i{display:flex;align-items:center;gap:5px;font-size:10.5px;color:#7A849E}
.avail-leg-dot{width:10px;height:10px;border-radius:2px;flex-shrink:0}
.res-person{display:flex;align-items:center;gap:10px;padding:8px 12px;border:1.5px solid #E3E7F0;border-radius:7px;margin-bottom:7px;cursor:pointer;transition:all .12s;background:#faf9f5}
.res-person:hover{border-color:#0073EA;background:#F0F7FF}
.res-person.sel{border-color:#0073EA;background:#EBF4FF}
.res-person-av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0}
.res-person-name{font-size:13px;font-weight:600;color:#1A2035}
.res-person-role{font-size:10.5px;color:#7A849E}
.res-person-status{font-size:10px;font-weight:600;padding:2px 7px;border-radius:3px}
.rps-free{background:#D1FAE5;color:#065F46}
.rps-busy{background:#FEE2E2;color:#991B1B}
.rps-partial{background:#FEF3C7;color:#92400E}
.ops-job-card{border:2px solid #E3E7F0;border-radius:8px;margin-bottom:10px;overflow:hidden}
.ops-job-head{padding:10px 14px;background:#f0efe9;border-bottom:1px solid #E3E7F0;display:flex;align-items:center;gap:10px}
.ops-job-body{padding:12px 14px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.ops-di{display:flex;flex-direction:column;gap:2px}
.ops-dl{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#7A849E}
.ops-dv{font-size:12.5px;font-weight:600;color:#1A2035}
.obs-draft{background:#ede9e0;color:#6B7280;padding:2px 8px;border-radius:3px;font-size:10.5px;font-weight:700}
.obs-provisional{background:#FEF3C7;color:#92400E;padding:2px 8px;border-radius:3px;font-size:10.5px;font-weight:700}
.obs-confirmed{background:#D1FAE5;color:#065F46;padding:2px 8px;border-radius:3px;font-size:10.5px;font-weight:700}
.cs-sub-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:#7A849E;margin-bottom:8px;margin-top:14px}
.cs-sub-label:first-child{margin-top:0}
.cs-hint{font-size:11px;color:#7A849E;background:#f0efe9;border:1px solid #E3E7F0;border-radius:5px;padding:7px 10px;margin-top:6px;line-height:1.5}
.mday-row{display:flex;align-items:center;gap:12px;padding:10px 14px;border:1.5px solid #E3E7F0;border-radius:7px;background:#faf9f5;margin-bottom:8px}
.mday-toggle{position:relative;width:38px;height:20px;flex-shrink:0;cursor:pointer}
.mday-toggle input{opacity:0;width:0;height:0;position:absolute}
.mday-slider{position:absolute;inset:0;background:#C4CBDA;border-radius:10px;transition:background .2s}
.mday-slider:before{content:'';position:absolute;width:16px;height:16px;border-radius:50%;background:#fff;left:2px;top:2px;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.mday-toggle input:checked + .mday-slider{background:#0073EA}
.mday-toggle input:checked + .mday-slider:before{transform:translateX(18px)}
.mday-lbl{flex:1;font-size:12.5px;font-weight:600;color:#1A2035}
.mday-sub{font-size:11px;color:#7A849E}
.bline-compact{display:flex;gap:6px;align-items:center;margin-bottom:5px}
.bline-compact input{padding:6px 9px;border:1px solid #E3E7F0;border-radius:5px;font-size:12px;font-family:'Inter',sans-serif;color:#1A2035;outline:none}
.bline-compact input:focus{border-color:#0073EA}
.bline-rm{width:26px;height:26px;border-radius:4px;border:1px solid #E3E7F0;background:#faf9f5;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;color:#7A849E;flex-shrink:0;transition:all .1s}
.bline-rm:hover{border-color:#E44258;color:#E44258}
.cfg-field{display:flex;flex-direction:column;gap:3px;margin-bottom:10px}
.cfg-label{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#7A849E}
.cfg-input{padding:7px 10px;border:1px solid #E3E7F0;border-radius:5px;font-family:'Inter',sans-serif;font-size:13px;color:#1A2035;background:#faf9f5;outline:none;transition:border-color .15s;width:100%}
.cfg-input:focus{border-color:#0073EA;box-shadow:0 0 0 3px rgba(0,115,234,.1)}
.cfg-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%237A849E' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}

/* Day-slot picker (multi-day date selection) */
.dayslot-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.dayslot-num{width:22px;height:22px;border-radius:50%;background:#E3E7F0;color:#7A849E;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.dayslot-num.filled{background:#0073EA;color:#fff}
.dayslot-val{flex:1;padding:6px 10px;border:1.5px solid #E3E7F0;border-radius:6px;font-size:12px;color:#7A849E;background:#faf9f5;display:flex;align-items:center;gap:6px}
.dayslot-val.filled{border-color:#0073EA;color:#1A2035;background:#EBF4FF}
.dayslot-val.filled .ds-clear{display:flex}
.ds-clear{display:none;margin-left:auto;cursor:pointer;color:#7A849E;font-size:11px;line-height:1}
.ds-clear:hover{color:#E44258}
.dayslot-progress{background:#ede9e0;border-radius:6px;padding:8px 12px;margin-bottom:12px;display:flex;align-items:center;gap:10px}
.dp-bar-wrap{flex:1;height:6px;background:#E3E7F0;border-radius:3px;overflow:hidden}
.dp-bar{height:100%;background:#0073EA;border-radius:3px;transition:width .3s}
.dp-label{font-size:11px;font-weight:700;color:#1A2035;white-space:nowrap}
.dp-label.done{color:#00C875}
/* Matrix row highlight for selected dates */
.avail-row.chosen-multi{background:#EBF4FF}
.avail-row.chosen-multi .avail-date-cell{color:#0073EA}

/* PANEL */
.overlay{position:fixed;inset:0;background:rgba(28,35,51,.45);z-index:500;opacity:0;pointer-events:none;transition:opacity .2s}
.overlay.on{opacity:1;pointer-events:all}
.panel{position:fixed;top:0;right:0;bottom:0;width:480px;background:var(--w);z-index:501;transform:translateX(105%);transition:transform .24s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;border-left:1px solid var(--b1);box-shadow:var(--shm)}
.panel.on{transform:translateX(0)}
.ph{padding:14px 18px;border-bottom:1px solid var(--b1);display:flex;align-items:flex-start;justify-content:space-between;flex-shrink:0;background:var(--s1)}
.ph-title{font-weight:700;font-size:16px;letter-spacing:-.3px}
.ph-sub{font-size:11px;color:var(--t3);margin-top:2px}
.pb{flex:1;overflow-y:auto;padding:16px}
.pf{padding:11px 16px;border-top:1px solid var(--b1);display:flex;gap:7px;justify-content:flex-end;flex-shrink:0;background:var(--s1)}
.fsec{margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid var(--b1)}
.fsec:last-child{border-bottom:none;margin-bottom:0}
.fsec-t{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--t2);margin-bottom:9px;display:flex;align-items:center;gap:6px}
.fsec-t i{background:var(--blue);color:#fff;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8.5px;font-style:normal;font-weight:700;flex-shrink:0}
.fg{display:flex;flex-direction:column;gap:3px;margin-bottom:9px}
.fg2{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.lbl{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)}
input.fi,select.fi,textarea.fi{padding:6px 10px;background:var(--w);border:1px solid var(--b1);border-radius:5px;font-family:'Inter',sans-serif;font-size:13px;font-weight:400;color:var(--t1);outline:none;transition:border-color .1s;width:100%}
input.fi:focus,select.fi:focus,textarea.fi:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,115,234,.1)}
textarea.fi{resize:vertical;min-height:60px}
.cpill{display:inline-flex;align-items:center;gap:4px;cursor:pointer;font-size:12px;color:var(--t2);padding:3px 8px;background:var(--s1);border:1px solid var(--b1);border-radius:5px;transition:all .1s;font-family:'Inter',sans-serif;margin:2px;font-weight:600}
.di{display:flex;flex-direction:column;gap:2px}
.dlbl{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)}
.dval{font-size:12.5px;color:var(--t1);font-weight:500}
.brow{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--b1);font-size:12.5px}
.brow:last-child{border-bottom:none}
.blbl{color:var(--t2)}
.bamt{font-weight:600;font-size:13px}
.btotal{display:flex;justify-content:space-between;padding:9px 0 0;font-weight:700;font-size:14px;border-top:2px solid var(--t1);letter-spacing:-.2px}

/* TOAST */
.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%) translateY(50px);background:var(--t1);color:#fff;padding:8px 16px;border-radius:var(--r);font-size:13px;font-weight:700;box-shadow:var(--shm);z-index:999;transition:all .22s cubic-bezier(.4,0,.2,1);opacity:0;white-space:nowrap}
.toast.on{transform:translateX(-50%) translateY(0);opacity:1}

/* ═══════════════════════════════════════════════════════════════════════
   WAREHOUSE MODULE
   ═══════════════════════════════════════════════════════════════════════ */

/* ── Daily Movements ─────────────────────────────────────────────────── */
.wh-day-header{display:flex;align-items:baseline;gap:10px;margin-bottom:16px}
.wh-day-title{font-size:20px;font-weight:800;color:var(--t1);letter-spacing:-.4px}
.wh-day-sub{font-size:12px;color:var(--t3);font-weight:500}
.wh-day-stats{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:18px}
.wh-stat{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);padding:12px 14px;box-shadow:var(--sh)}
.wh-stat-num{font-size:22px;font-weight:800;color:var(--t1);letter-spacing:-.5px;line-height:1}
.wh-stat-lbl{font-size:10.5px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.4px;margin-top:4px}
.wh-stat-ico{font-size:18px;margin-bottom:6px}

/* Movements timeline */
.wh-timeline{display:flex;flex-direction:column;gap:0}
.wh-section{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);margin-bottom:12px;box-shadow:var(--sh);overflow:hidden}
.wh-section-head{display:flex;align-items:center;gap:10px;padding:11px 15px;border-bottom:1px solid var(--b1);background:var(--s1)}
.wh-section-icon{font-size:16px;flex-shrink:0}
.wh-section-title{font-size:13px;font-weight:700;color:var(--t1);flex:1}
.wh-section-count{font-size:11px;font-weight:700;padding:2px 8px;border-radius:9px;background:var(--blue);color:#fff}
.wh-section-empty{padding:12px 15px;font-size:12px;color:var(--t3);font-style:italic}

/* Movement entry row */
.wh-entry{display:flex;align-items:center;gap:12px;padding:11px 15px;border-bottom:1px solid var(--b1);cursor:pointer;transition:background .1s}
.wh-entry:last-child{border-bottom:none}
.wh-entry:hover{background:var(--s1)}
.wh-entry-dir{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.wh-entry-dir.in{background:#E6FFF5;color:#007048}
.wh-entry-dir.out{background:#FFF5E0;color:#9A5600}
.wh-entry-dir.activity{background:#EBF4FF;color:#004DA0}
.wh-entry-dir.thirdparty{background:#F5EEFF;color:#6B00B5}
.wh-entry-main{flex:1;min-width:0}
.wh-entry-client{font-size:13px;font-weight:700;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.wh-entry-detail{font-size:11.5px;color:var(--t2);margin-top:2px}
.wh-entry-meta{display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0}
.wh-entry-vol{font-size:12px;font-weight:700;color:var(--t2)}
.wh-entry-containers{font-size:10.5px;color:var(--t4);font-family:monospace}
.wh-entry-badge{font-size:10px;font-weight:700;padding:2px 7px;border-radius:9px}
.whb-job{background:#EBF4FF;color:#004DA0}
.whb-thirdparty{background:#F5EEFF;color:#6B00B5}
.whb-manual{background:var(--s2);color:var(--t2)}
.wh-entry-crew{font-size:11px;color:var(--t3);margin-top:2px}
.wh-entry-actions{display:flex;gap:5px;flex-shrink:0;opacity:0;transition:opacity .12s}
.wh-entry:hover .wh-entry-actions{opacity:1}

/* ── 3rd Party Flow Panel ────────────────────────────────────────────── */
.wh-3p-panel{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);padding:18px;box-shadow:var(--shm)}
.wh-3p-title{font-size:14px;font-weight:700;margin-bottom:14px;color:var(--t1)}

/* ── Warehouse Grid ─────────────────────────────────────────────────── */
.wh-grid-wrap{overflow:auto}
.wh-grid-legend{display:flex;align-items:center;gap:16px;margin-bottom:14px;padding:10px 14px;background:var(--w);border:1px solid var(--b1);border-radius:var(--r)}
.wh-legend-item{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600;color:var(--t2)}
.wh-legend-dot{width:12px;height:12px;border-radius:3px;flex-shrink:0}
.wh-legend-dot.client{background:#00C875}
.wh-legend-dot.nonclient{background:#FF9F00}
.wh-legend-dot.empty{background:#E44258}
.wh-legend-dot.pending{background:#B0B8CC}

.wh-grid{display:flex;flex-direction:column;gap:2px;min-width:max-content}
.wh-grid-row{display:flex;align-items:center;gap:2px}
.wh-grid-rowlbl{width:36px;font-size:9px;font-weight:700;color:var(--t3);text-align:right;padding-right:6px;flex-shrink:0;letter-spacing:.3px;text-transform:uppercase}
.wh-col-headers{display:flex;gap:2px;margin-left:36px}
.wh-col-hdr{font-size:9px;font-weight:700;color:var(--t4);text-align:center;width:52px;flex-shrink:0}

/* Container cell */
.wh-cell{width:52px;height:44px;border-radius:4px;border:1.5px solid transparent;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;transition:transform .1s,border-color .1s;position:relative;flex-shrink:0}
.wh-cell:hover{transform:scale(1.06);z-index:2;border-color:rgba(0,0,0,.25)!important}
.wh-cell.client{background:#00C87522;border-color:#00C87555}
.wh-cell.client-full{background:#00C875;border-color:#00C875}
.wh-cell.nonclient{background:#FF9F0033;border-color:#FF9F0077}
.wh-cell.empty{background:#E4425820;border-color:#E4425855}
.wh-cell.pending{background:#B0B8CC22;border-color:#B0B8CC55}
.wh-cell.runway{background:var(--s2);border:1.5px dashed var(--b2);cursor:default;font-size:8px;font-weight:700;color:var(--t4);letter-spacing:.8px;text-transform:uppercase;justify-content:center}
.wh-cell.loose-zone{background:#F0F7FF;border-color:#0073EA44}

.wh-cell-cno{font-size:8px;font-weight:800;color:inherit;letter-spacing:-.2px;font-family:monospace}
.wh-cell-loc{font-size:7.5px;color:var(--t4);letter-spacing:.2px}
.wh-cell-icon{font-size:11px;line-height:1}

/* Tooltip on cell hover */
.wh-cell-tooltip{
  display:none;
  position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);
  background:#1A2035;color:#fff;font-size:10.5px;font-weight:600;
  padding:6px 10px;border-radius:5px;white-space:nowrap;z-index:100;
  box-shadow:0 4px 12px rgba(0,0,0,.35);pointer-events:none;
}
.wh-cell-tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:#1A2035}
.wh-cell:hover .wh-cell-tooltip{display:block}

/* Runway label strip */
.wh-runway-row{display:flex;align-items:center;gap:2px;height:20px;margin:4px 0}
.wh-runway-cell{background:var(--s2);border-radius:2px;height:20px;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:var(--t4);letter-spacing:.8px;text-transform:uppercase;flex:1}

/* Loose row */
.wh-loose-row{display:flex;gap:6px;overflow-x:auto;padding-bottom:4px;margin-top:2px}
.wh-loose-cell{min-width:80px;height:50px;border-radius:4px;border:1.5px solid var(--b1);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;cursor:pointer;transition:border-color .1s;flex-shrink:0;position:relative}
.wh-loose-cell:hover{border-color:var(--blue)}
.wh-loose-cell.occupied{background:#EBF4FF;border-color:#0073EA55}
.wh-loose-cell.empty{background:#E4425810;border-color:#E4425840}
.wh-loose-cell-id{font-size:8.5px;font-weight:800;font-family:monospace;color:var(--t2)}
.wh-loose-cell-lbl{font-size:8px;color:var(--t3)}
.wh-loose-cell-icon{font-size:14px}

/* Grid side labels */
.wh-side-label{font-size:9px;font-weight:800;color:var(--t3);text-transform:uppercase;letter-spacing:1px;padding:6px 0 4px;text-align:center;display:block}

/* Zoom controls */
.wh-zoom{display:flex;align-items:center;gap:6px;margin-bottom:10px}
.wh-zoom-btn{width:26px;height:26px;border:1px solid var(--b1);border-radius:4px;background:var(--w);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;color:var(--t2)}

/* Cell detail panel */
.wh-cell-detail{background:var(--w);border:1px solid var(--b1);border-radius:var(--r);padding:16px;margin-bottom:14px;box-shadow:var(--sh)}
.wh-cd-head{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.wh-cd-cno{font-size:18px;font-weight:800;font-family:monospace;color:var(--t1)}
.wh-cd-loc{font-size:13px;color:var(--t3);font-weight:600}
.wh-cd-status{font-size:11px;font-weight:700;padding:3px 10px;border-radius:10px}
.fade-in{animation:fi .18s ease both}
@keyframes fi{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
/* ── Storage method tiles (Goods In) ─────────────────────────────────── */
.stm-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:4px}
.stm-tile{border:2px solid var(--b1);border-radius:8px;padding:10px 6px;cursor:pointer;text-align:center;transition:all .13s;background:var(--w)}
.stm-tile:hover{border-color:var(--blue);background:#F0F7FF}
.stm-tile.sel{border-color:var(--blue);background:#EBF4FF}
.stm-tile-icon{font-size:20px;margin-bottom:4px}
.stm-tile-lbl{font-size:10.5px;font-weight:700;color:var(--t1)}
.stm-tile-sub{font-size:9.5px;color:var(--t3);margin-top:2px}
/* ── Email parse chips ────────────────────────────────────────────────── */
.wh-parse-chips{display:flex;flex-direction:column;gap:6px;margin-top:12px;border-top:1px solid var(--b1);padding-top:12px}
.wh-parse-row{display:flex;align-items:center;gap:8px;font-size:12px}
.wh-parse-lbl{font-size:10.5px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.4px;width:110px;flex-shrink:0}
.wh-chip{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:600;cursor:pointer;border:1.5px solid transparent}
.wh-chip.confirmed{background:#E6FFF5;color:#007048;border-color:#7DD9B0}
.wh-chip.assumed{background:#FFF5E0;color:#9A5600;border-color:#FFD580}
.wh-chip.missing{background:#FFECEF;color:#E44258;border-color:#F5A0AA;cursor:default}
.wh-chip-edit{font-size:10px;opacity:.6}
.wh-parse-edit-inp{display:none;background:var(--w);border:1.5px solid var(--blue);border-radius:6px;padding:3px 8px;font-size:12px;color:var(--t1);outline:none;min-width:140px}
.wh-parse-dir-btns{display:flex;gap:8px;margin-bottom:14px}
.wh-parse-dir-btn{flex:1;border:2px solid var(--b1);border-radius:7px;padding:10px 8px;cursor:pointer;text-align:center;transition:all .13s;background:var(--w);font-size:12.5px;font-weight:700;color:var(--t2)}
.wh-parse-dir-btn:hover{border-color:var(--blue)}
.wh-parse-dir-btn.sel{border-color:var(--blue);background:#EBF4FF;color:var(--blue)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--b2);border-radius:3px}

/* ══ ADDRESS LOOKUP ══════════════════════════════════════════════════ */
.addr-wrap{position:relative;display:flex;align-items:center;gap:5px}
.addr-wrap .fi{flex:1;padding-left:8px}
.addr-flag{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:15px;pointer-events:none;z-index:1;line-height:1}
.addr-wrap .fi.has-flag{padding-left:32px}
.addr-map-btn{width:28px;height:28px;border:1.5px solid var(--b1);border-radius:5px;background:var(--w);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--t3);flex-shrink:0;transition:all .1s}
.addr-map-btn:hover{border-color:var(--blue);color:var(--blue);background:#F0F7FF}
.addr-map-btn.has-addr{border-color:var(--green);color:var(--green)}
.addr-calc-btn{width:28px;height:28px;border:1.5px solid var(--b1);border-radius:5px;background:var(--w);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--t3);flex-shrink:0;transition:all .1s;font-weight:700}
.addr-calc-btn:hover{border-color:var(--blue);color:var(--blue);background:#F0F7FF}
.addr-calc-btn.calculating{animation:pulse-amber 1s infinite}

/* Autocomplete dropdown */
.addr-dropdown{position:absolute;top:calc(100% + 4px);left:0;right:36px;background:#fff;border:1.5px solid var(--blue);border-radius:7px;box-shadow:0 8px 24px rgba(0,0,0,.14);z-index:9999;overflow:hidden;max-height:220px;overflow-y:auto}
.addr-option{display:flex;align-items:flex-start;gap:8px;padding:9px 12px;cursor:pointer;border-bottom:1px solid var(--s2);transition:background .08s}
.addr-option:last-child{border-bottom:none}
.addr-option:hover{background:#F0F7FF}
.addr-option-icon{font-size:13px;margin-top:1px;flex-shrink:0}
.addr-option-main{font-size:12.5px;font-weight:600;color:var(--t1)}
.addr-option-sub{font-size:11px;color:var(--t3);margin-top:1px}

/* Mileage calc result inline */
.miles-calc-result{display:flex;align-items:center;gap:6px;font-size:11.5px;color:var(--t2);margin-top:5px;padding:5px 9px;background:#F0F7FF;border-radius:5px;border:1px solid #C4D9F5}
.miles-calc-result .leg{font-weight:600}
.miles-calc-result .total{font-weight:800;color:var(--blue)}

/* ══ MAP MODAL ══════════════════════════════════════════════════════════ */
.map-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:20000;display:flex;align-items:center;justify-content:center;animation:fi .15s ease}
.map-modal{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.4);width:min(820px,95vw);max-height:90vh;display:flex;flex-direction:column}
.map-modal-head{display:flex;align-items:center;gap:10px;padding:13px 16px;background:var(--w);border-bottom:1px solid var(--b1)}
.map-modal-title{font-size:13.5px;font-weight:700;color:var(--t1);flex:1}
.map-modal-addr{font-size:11.5px;color:var(--t3);margin-top:2px}
.map-modal-tabs{display:flex;gap:4px}
.map-modal-tab{font-size:11.5px;font-weight:700;padding:4px 12px;border-radius:5px;border:1.5px solid var(--b1);background:var(--w);cursor:pointer;color:var(--t2);transition:all .1s}
.map-modal-tab.on{background:#EBF4FF;border-color:var(--blue);color:var(--blue)}
.map-modal-body{flex:1;min-height:480px;position:relative}
.map-modal-body iframe{width:100%;height:100%;min-height:480px;border:none}
.map-modal-close{width:30px;height:30px;border-radius:7px;border:1.5px solid var(--b1);background:var(--w);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--t2)}
.map-modal-close:hover{background:var(--rlt);border-color:var(--red);color:var(--red)}

/* ══ COS SETTINGS TAB ═══════════════════════════════════════════════════ */
.cos-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.cos-field{display:flex;flex-direction:column;gap:5px}
.cos-lbl{font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.4px}
.cos-desc{font-size:11px;color:var(--t4);margin-top:2px}

/* ══ ENHANCED COST BREAKDOWN in job COS ════════════════════════════════ */
.cos-section-head{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t4);padding:6px 0 3px;border-top:1px solid var(--b1);margin-top:6px}
.cos-section-head:first-child{border-top:none;margin-top:0}

/* Status badges on job cards */
.jcard-status{font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px;white-space:nowrap;align-self:flex-start;margin-left:auto;flex-shrink:0}
.st-pending{background:#FFF5E0;color:#FF9F00}
.st-confirmed{background:#EBF4FF;color:#0073EA}
.st-inprog{background:#F5EEFF;color:#A25DDC}
.st-done{background:#E6FFF5;color:#00A86B}
.st-billed{background:#E6FFF5;color:#00A86B}
.st-cancelled{background:#FFECEF;color:#E44258}
/* Quick status context menu */
.ctx-menu{position:fixed;background:#fff;border:1px solid var(--b1);border-radius:8px;box-shadow:var(--shm);z-index:9999;min-width:160px;padding:4px 0;font-size:13px}
.ctx-item{padding:8px 14px;cursor:pointer;display:flex;align-items:center;gap:8px;color:var(--t1)}
.ctx-item:hover{background:var(--s1)}
.ctx-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
</style>
<body>

<aside class="sidebar" id="sidebar">
  <!-- Logo -->
  <div class="sb-logo">
    <div class="sb-icon">OM</div>
    <div class="sb-wordmark">
      <div class="sb-name">OPS MANAGER</div>
      <div class="sb-tag">Removals Platform</div>
    </div>
  </div>

  <nav class="sb-nav">
    <!-- Workspace -->
    <button class="nb on" id="nb-dashboard" onclick="showMod('dashboard',this)">
      <div class="nb-ico">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      </div>
      <span class="sb-label">Dashboard</span>
      <span class="nb-tip">Dashboard</span>
    </button>
    <button class="nb" id="nb-calendar" onclick="showMod('calendar',this)">
      <div class="nb-ico">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      </div>
      <span class="sb-label">Job Calendar</span>
      <span class="nb-badge hidden" id="job-badge">7</span>
      <span class="nb-tip">Job Calendar</span>
    </button>

    <button class="nb" id="nb-bookings" onclick="showMod('bookings',this)">
      <div class="nb-ico">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      </div>
      <span class="sb-label">Booking Manager</span>
      <span class="nb-badge hidden" id="bk-badge">0</span>
      <span class="nb-tip">Bookings</span>
    </button>

    <button class="nb" id="nb-crew" onclick="showMod('crew',this)">
      <div class="nb-ico">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="7" r="4"/><path d="M3 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/><path d="M21 21v-2a4 4 0 0 0-3-3.85"/></svg>
      </div>
      <span class="sb-label">Crew Scheduler</span>
      <span class="nb-tip">Crew</span>
    </button>

    <button class="nb" id="nb-warehouse" onclick="showMod('warehouse',this)">
      <div class="nb-ico">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </div>
      <span class="sb-label">Warehouse</span>
      <span class="nb-badge hidden" id="wh-badge">0</span>
      <span class="nb-tip">Warehouse</span>
    </button>

    <div class="sb-sep"></div>

    <button class="nb" id="nb-finance" onclick="showMod('finance',this)">
      <div class="nb-ico">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><text x="4" y="17" font-size="16" font-family="Arial" fill="currentColor" stroke="none">£</text></svg>
      </div>
      <span class="sb-label">Finance &amp; Billing</span>
      <span class="nb-tip">Finance</span>
    </button>

    <button class="nb" id="nb-storage" onclick="showMod('storage',this)">
      <div class="nb-ico">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/></svg>
      </div>
      <span class="sb-label">Storage</span>
      <span class="nb-badge hidden" id="storage-badge">0</span>
      <span class="nb-tip">Storage</span>
    </button>

    <div class="sb-sep"></div>

    <button class="nb" id="nb-settings" onclick="showMod('settings',this)">
      <div class="nb-ico">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M4.93 4.93a10 10 0 0 0 0 14.14"/></svg>
      </div>
      <span class="sb-label">Settings</span>
      <span class="nb-tip">Settings</span>
    </button>
  </nav>

  <!-- User footer -->
  <div class="sb-foot">
    <div class="sb-user">
      <div class="sb-av"><div class="sb-av-inner">OM</div></div>
      <div class="sb-user-info">
        <div class="sb-uname">Ops Manager</div>
        <div class="sb-urole">Administrator</div>
      </div>
    </div>
  </div>
</aside>

<div class="main">
  <div class="topbar">
    <div class="tb-title" id="tb-title">Job Calendar</div>
    <div class="divider"></div>
    <div class="vtabs" id="vtabs">
      <button class="vt on" onclick="setView('week',this)">Week</button>
      <button class="vt" onclick="setView('twoweek',this)">2 Week</button>
      <button class="vt" onclick="setView('month',this)">Month</button>
      <button class="vt" onclick="setView('day',this)">Day</button>
      <button class="vt" onclick="setView('list',this)">List</button>
    </div>
    <div class="divider"></div>
    <div class="cnav">
      <button class="cn-btn" onclick="navPrev()">&#8249;</button>
      <div class="cn-lbl" id="cn-lbl">&mdash;</div>
      <button class="cn-btn" onclick="navNext()">&#8250;</button>
      <button class="today-btn" onclick="goToday()">Today</button>
    </div>
    <div style="position:relative;flex:1;max-width:280px">
      <input id="global-search" class="fi" placeholder="&#128269; Search jobs, clients, refs..." style="width:100%;padding:6px 10px 6px 32px;font-size:12.5px;border-radius:6px;border:1px solid var(--b1);background:var(--s1)" oninput="renderSearchResults(this.value)" onfocus="el('search-drop').style.display='block'" onblur="setTimeout(function(){el('search-drop').style.display='none'},200)">
      <svg style="position:absolute;left:9px;top:50%;transform:translateY(-50%);opacity:.4;pointer-events:none" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <div id="search-drop" style="display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border:1px solid var(--b1);border-radius:8px;box-shadow:var(--shm);z-index:500;max-height:320px;overflow-y:auto"></div>
    </div>
    <div class="tb-r">
      <button class="btn btn-s btn-sm" onclick="doExport()">&#8595; Export</button>
      <button class="btn btn-p btn-sm" onclick="openNew(null)">+ New Job</button>
    </div>
  </div>

  <div class="content">
    <div class="page on" id="mod-dashboard">
      <div style="flex:1;overflow:auto;padding:20px" id="dashboard-body"></div>
    </div>
    <div class="page" id="mod-calendar">
      <div style="flex:1;overflow:auto;display:flex;flex-direction:column"><div class="cal-outer" id="cal-out"></div></div>
    </div>
    <div class="page" id="mod-crew"><div class="crew-outer" id="crew-out"></div></div>
    <div class="page" id="mod-finance"><div class="fin-outer" id="fin-out"></div></div>
  <!-- STORAGE MODULE -->
  <div class="page" id="mod-storage">
    <div class="topbar">
      <div class="tb-title">Storage</div>
      <div class="divider"></div>
      <div style="display:flex;gap:4px">
        <button class="vt on" id="stf-all" onclick="setStorageFilter('all',this)">All</button>
        <button class="vt" id="stf-active" onclick="setStorageFilter('active',this)">Active</button>
        <button class="vt" id="stf-inout" onclick="setStorageFilter('inout',this)">In/Out</button>
        <button class="vt" id="stf-longterm" onclick="setStorageFilter('longterm',this)">Long-term</button>
      </div>
      <div class="tb-r">
        <button class="btn btn-p btn-sm" onclick="newStorageRecord()">+ New Storage</button>
      </div>
    </div>
    <div id="storage-out" style="flex:1;overflow-y:auto;padding:18px"></div>
  </div>

  <!-- WAREHOUSE MODULE -->
  <div class="page" id="mod-warehouse">
    <div style="height:44px;background:var(--w);border-bottom:1px solid var(--b1);display:flex;align-items:center;padding:0 14px;gap:8px;flex-shrink:0">
      <div style="display:flex;gap:4px" id="wh-tabs">
        <button class="vt on" onclick="whSetTab('movements',this)">Daily Movements</button>
        <button class="vt" onclick="whSetTab('records',this)">Storage Records</button>
        <button class="vt" onclick="whSetTab('grid',this)">Warehouse Grid</button>
      </div>
      <div class="divider"></div>
      <div class="cnav" id="wh-cnav">
        <button class="cn-btn" onclick="whNavPrev()">&#8249;</button>
        <div class="cn-lbl" id="wh-cn-lbl">&mdash;</div>
        <button class="cn-btn" onclick="whNavNext()">&#8250;</button>
        <button class="today-btn" onclick="whGoToday()">Today</button>
      </div>
      <div class="tb-r" id="wh-tb-r">
        <button class="btn btn-s btn-sm" onclick="whParseEmail()">&#128233; Parse Email</button>
        <button class="btn btn-s btn-sm" onclick="wh3rdPartyIn()">&#8595; Goods In</button>
        <button class="btn btn-s btn-sm" onclick="wh3rdPartyOut()">&#8593; Goods Out</button>
        <button class="btn btn-p btn-sm" onclick="whAddActivity()">+ Activity</button>
      </div>
    </div>
    <div id="wh-out" style="flex:1;overflow:auto;padding:16px"></div>
  </div>

    <div class="page" id="mod-settings">
      <div class="settings-outer">
        <div class="settings-tabs">
          <button class="stab on" id="stab-crew" onclick="setStab('crew',this)">Crew Rates</button>
          <button class="stab" id="stab-vehicles" onclick="setStab('vehicles',this)">Vehicles</button>
          <button class="stab" id="stab-materials" onclick="setStab('materials',this)">Materials</button>
          <button class="stab" id="stab-charges" onclick="setStab('charges',this)">Charges &amp; Taxes</button>
          <button class="stab" id="stab-brands" onclick="setStab('brands',this)">Brands</button>
          <button class="stab" id="stab-mm" onclick="setStab('mm',this)">Move Managers</button>
          <button class="stab" id="stab-comms" onclick="setStab('comms',this)">Company / Comms</button>
          <button class="stab" id="stab-costing" onclick="setStab('costing',this)">Cost of Sale &amp; Maps</button>
        </div>
        <div class="settings-body" id="settings-body"></div>
      </div>
    </div>

    <!-- BOOKING MODULE -->
    <div class="page" id="mod-bookings">
      <div class="bk-split">
        <!-- LEFT: booking list -->
        <div class="bk-left">
          <div class="bk-left-head">
            <div style="font-weight:700;font-size:13px;margin-bottom:8px">All Bookings</div>
            <button class="btn btn-p" style="width:100%" onclick="newBooking()">+ New Booking</button>
            <button class="btn btn-s" style="width:100%;margin-top:6px" onclick="openNewSurvey()">+ New Survey</button>
          </div>
          <div class="bk-list" id="bk-list"></div>
          <!-- Survey list -->
          <div style="border-top:2px solid var(--b1);padding:10px 12px 6px;margin-top:4px">
            <div style="font-weight:700;font-size:12px;color:var(--t3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px">&#128269; Surveys</div>
          </div>
          <div id="bk-survey-list" style="overflow-y:auto;max-height:300px"></div>
        </div>
        <!-- RIGHT: form or detail -->
        <div class="bk-right">
          <div class="bk-right-head">
            <div id="bk-right-title" style="font-weight:700;font-size:14px;color:var(--t2)">Select or create a booking</div>
            <div id="bk-right-actions" style="display:flex;gap:7px"></div>
          </div>
          <div class="bf-wrap" id="bk-right-body">
            <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--t3);text-align:center;padding:40px">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:14px;opacity:.3"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              <div style="font-weight:600;font-size:15px;color:var(--t2);margin-bottom:6px">No booking selected</div>
              <div style="font-size:12.5px">Click <strong>+ New Booking</strong> to capture a confirmed booking,<br>or select one from the list to view or edit it.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ── JOB CONFIGURATOR PANEL ─────────────────────────────────────────── -->
<div class="cfg-backdrop" id="cfg-backdrop" onclick="cfgClickBackdrop(event)"></div>
<div class="cfg-panel" id="cfg-panel">
  <div class="cfg-head">
    <div class="cfg-head-title" id="cfg-head-title">Job Configurator</div>
    <span class="cfg-head-ref" id="cfg-head-ref"></span>
    <button class="cfg-close" onclick="closeConfigurator()" title="Close">&#10005;</button>
  </div>
  <div class="cfg-stages" id="cfg-stages">
    <div class="cfg-stage active" id="cstage-0" onclick="cfgGoStage(0)">
      <div class="cfg-stage-num">1</div>
      <div class="cfg-stage-lbl">Client</div>
    </div>
    <div class="cfg-stage" id="cstage-1" onclick="cfgGoStage(1)">
      <div class="cfg-stage-num">2</div>
      <div class="cfg-stage-lbl">Jobs</div>
    </div>
    <div class="cfg-stage" id="cstage-2" onclick="cfgGoStage(2)">
      <div class="cfg-stage-num">3</div>
      <div class="cfg-stage-lbl">Schedule</div>
    </div>
    <div class="cfg-stage" id="cstage-3" onclick="cfgGoStage(3)">
      <div class="cfg-stage-num">4</div>
      <div class="cfg-stage-lbl">Resources</div>
    </div>
    <div class="cfg-stage" id="cstage-4" onclick="cfgGoStage(4)">
      <div class="cfg-stage-num">5</div>
      <div class="cfg-stage-lbl">Ops Plan</div>
    </div>
  </div>
  <div class="cfg-body" id="cfg-body"></div>
  <div class="cfg-foot">
    <div id="cfg-foot-l">
      <button class="btn btn-s btn-sm" id="cfg-btn-back" onclick="cfgBack()" style="display:none">&#8592; Back</button>
    </div>
    <div style="display:flex;gap:8px" id="cfg-foot-r">
      <button class="btn btn-s btn-sm" onclick="cfgSaveDraft()">Save Draft</button>
      <button class="btn btn-p btn-sm" id="cfg-btn-next" onclick="cfgNext()">Next &#8594;</button>
    </div>
  </div>
</div>

<!-- Eye button — fixed above all overlays and panels, always accessible -->
<button class="eye-btn" id="eye-btn" onclick="toggleVals()" title="Show/hide financial values">&#128065;</button>

<div class="overlay" id="overlay" onclick="closePanel()"></div>
<div class="panel" id="panel">
  <div class="ph">
    <div><div class="ph-title" id="p-title"></div><div class="ph-sub" id="p-sub"></div></div>
    <button class="btn btn-g" onclick="closePanel()">&#10005;</button>
  </div>
  <div class="pb" id="p-body"></div>
  <div class="pf" id="p-foot"></div>
</div>
<div class="toast" id="toast-el"></div>

<script>
// ── DATA ──────────────────────────────────────────────────────────────
// Full brand objects — configurable in Settings > Brands
// channel: 'Partner' | 'Account' | 'Domestic'
var BRAND_DATA = [
  {name:'SIRVA',          col:'#0073EA',channel:'Partner', logo:''},
  {name:'BRITANNIA',      col:'#C8102E',channel:'Partner', logo:''},
  {name:'MOVESQUAD',      col:'#00C875',channel:'Account', logo:''},
  {name:'EMS',            col:'#7B2FBE',channel:'Account', logo:''},
  {name:'STERLING',       col:'#E07B00',channel:'Account', logo:''},
  {name:'DOREE BONNER',   col:'#00897B',channel:'Partner', logo:''},
  {name:'DALEYSMOVE',     col:'#E91E8C',channel:'Partner', logo:''},
  {name:'BTR',            col:'#FF5630',channel:'Account', logo:''},
  {name:'ECKERSLEYS',     col:'#6554C0',channel:'Account', logo:''},
  {name:'JOHN MASON',     col:'#0052CC',channel:'Partner', logo:''},
  {name:'BAXTERS',        col:'#36B37E',channel:'Partner', logo:''},
  {name:'SOLARIS',        col:'#FF8B00',channel:'Partner', logo:''},
  {name:'GOSSELIN',       col:'#253858',channel:'Partner', logo:''},
  {name:'CROWN WORKSPACE',col:'#0065FF',channel:'Partner', logo:''},
  {name:'ANYVAN',         col:'#57D9A3',channel:'Partner', logo:''},
];

// Derived lookup dicts (rebuilt by buildBrandMaps())
var BRANDS=[]; var BC={}; var BBLT={}; var BROW={}; var BTXT={}; var BLOG={};
function hexToLight(hex) {
  // Convert brand hex colour to a light tint (~10% opacity)
  var r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  return 'rgb('+Math.round(r*.12+243)+','+Math.round(g*.12+243)+','+Math.round(b*.12+243)+')';
}
function hexToDark(hex) {
  var r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  return 'rgb('+Math.round(r*.6)+','+Math.round(g*.6)+','+Math.round(b*.6)+')';
}
function buildBrandMaps() {
  BRANDS=[]; BC={}; BBLT={}; BROW={}; BTXT={};
  for(var i=0;i<BRAND_DATA.length;i++){
    var b=BRAND_DATA[i];
    BRANDS.push(b.name);
    BC[b.name]=b.col;
    BBLT[b.name]=hexToLight(b.col);
    BROW[b.name]=hexToLight(b.col).replace('rgb(','rgba(').replace(')',', 0.5)');
    BTXT[b.name]=hexToDark(b.col);
    BLOG[b.name]=b.logo||'';
  }
}
buildBrandMaps();
function brandChannel(name){ for(var i=0;i<BRAND_DATA.length;i++) if(BRAND_DATA[i].name===name) return BRAND_DATA[i].channel||'Partner'; return 'Partner'; }
var BCLS= {SIRVA:'b-sirva',BRITANNIA:'b-britannia',MOVESQUAD:'b-movesquad',EMS:'b-ems',STERLING:'b-sterling'};
var DS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
var DF = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
var MS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

// chargeRate = day rate charged out per person per day (revenue / COS in job costing)

// ── MOVE MANAGERS ────────────────────────────────────────────────────
// One MM per brand. Used for Partner/Account job comms instead of end client.
var MOVE_MANAGERS = [
  {id:'MM001',name:'Sarah Keane',    phone:'07700 900111',email:'s.keane@sirva.com',    brand:'SIRVA'},
  {id:'MM002',name:'Tom Ballard',    phone:'07700 900222',email:'t.ballard@britannia.com',brand:'BRITANNIA'},
  {id:'MM003',name:'Claire Hughes',  phone:'07700 900333',email:'c.hughes@movesquad.com', brand:'MOVESQUAD'},
  {id:'MM004',name:'Raj Patel',      phone:'07700 900444',email:'raj.patel@ems-reloc.com',brand:'EMS'},
  {id:'MM005',name:'Donna Walsh',    phone:'07700 900555',email:'d.walsh@sterling.com',   brand:'STERLING'},
];
function mmForBrand(brandName){ for(var i=0;i<MOVE_MANAGERS.length;i++) if(MOVE_MANAGERS[i].brand===brandName) return MOVE_MANAGERS[i]; return null; }
function mmForJob(j){ if(!j.brand||brandChannel(j.brand)==='Domestic') return null; return mmForBrand(j.brand); }

// rate       = basic pay rate (used with NI/pension/holiday to derive notional cost)
// employed   = true (PAYE) | false (self-employed/contractor — notional = basic rate)
// ni         = employer's NI % (employed only, default 13.8%)
// pension    = employer pension % (employed only, default 3%)
// holiday    = holiday pay uplift % (employed only, default 12.07%)
// notional   = chargeRate * oncost multipliers — used in Finance accounting view only
var CREW = [
  {name:'ADRIAN',role:'Driver',chargeRate:220,rate:180,col:'#0073EA',employed:true, ni:13.8,pension:3,holiday:12.07,photo:''},
  {name:'MARTYN',role:'Driver',chargeRate:220,rate:180,col:'#00C875',employed:true, ni:13.8,pension:3,holiday:12.07,photo:''},
  {name:'RAY',   role:'Driver',chargeRate:215,rate:175,col:'#FF9F1A',employed:true, ni:13.8,pension:3,holiday:12.07,photo:''},
  {name:'DAYLE', role:'Driver',chargeRate:195,rate:175,col:'#A25DDC',employed:false,ni:0,   pension:0,holiday:0,   photo:''},
  {name:'DAVE',  role:'Porter',chargeRate:160,rate:130,col:'#0097C2',employed:true, ni:13.8,pension:3,holiday:12.07,photo:''},
  {name:'JOE',   role:'Porter',chargeRate:160,rate:130,col:'#E44258',employed:true, ni:13.8,pension:3,holiday:12.07,photo:''},
  {name:'ALFIE', role:'Porter',chargeRate:145,rate:125,col:'#B86800',employed:false,ni:0,   pension:0,holiday:0,   photo:''},
];
var HOL = {JOE:['2026-03-05','2026-03-06','2026-03-07']};

// journeyId: links job to a JOURNEY container (optional).
// storageId: links job to a STORAGE_RECORD (either direction).
// seqInDay: position within same-day multi-job sequence (1-based, 0 = single job).
var jobs = [
  {id:'J001',ref:'GB2600334-01',brand:'SIRVA',channel:'Partner',jobType:'Door to Door',clientRef:'',moveManager:'',client:'Kitchen (Telford)',origin:'TF2 9JZ',dest:'INT STORE',start:'2026-03-02',end:'2026-03-04',vol:1792,cbm:51.2,drivers:['ADRIAN'],porters:['DAVE'],mileage:82,veh:['PO23 YDN','PO23 YDM'],status:'Billed',billing:[{item:'Origin charge',amt:2991.21},{item:'Mileage',amt:64},{item:'Crates',amt:150},{item:'Overnights',amt:124}],notes:'Multi-day move Mon–Wed. Day 2 two vehicles.',journeyId:'',storageId:'S001',seqInDay:0},
  {id:'J002',ref:'GB2600261-01',brand:'SIRVA',channel:'Partner',jobType:'Door to Door',clientRef:'',moveManager:'',client:'GARNER',origin:'CH7 3DG',dest:'INT STORE',start:'2026-03-02',end:'2026-03-04',vol:1750,cbm:50,drivers:['MARTYN','DAYLE'],porters:['JOE'],mileage:68,veh:['PO23 YDP'],status:'Billed',billing:[{item:'Origin charge',amt:2921.10},{item:'Handling',amt:472.50},{item:'Crate',amt:122}],notes:'1 x crate. Return leg Wednesday with Dayle.',journeyId:'',storageId:'S002',seqInDay:0},
  {id:'J003',ref:'GB2502292-01',brand:'SIRVA',channel:'Partner',jobType:'Door to Door',clientRef:'',moveManager:'',client:'NAQVI',origin:'EX STORE',dest:'Customer Address',start:'2026-03-02',end:'2026-03-03',vol:411,cbm:11.74,drivers:['RAY'],porters:['ALFIE'],mileage:0,veh:[],status:'Completed',billing:[{item:'Handling',amt:110.97}],notes:'Mon 9am, Tue delivery 12:30pm.',journeyId:'',storageId:'',seqInDay:0},
  {id:'J004',ref:'WCHG-TOWNSEND',brand:'MOVESQUAD',channel:'Account',jobType:'Door to Door',clientRef:'',moveManager:'',client:'Mr Townsend',origin:'M23 1HG',dest:'M23 2TU',start:'2026-03-02',end:'2026-03-02',vol:0,cbm:0,drivers:[],porters:[],mileage:4,veh:[],status:'Completed',billing:[{item:'Door to door',amt:448.56}],notes:'Call Chelsea 07766711032 on way.',journeyId:'JRN001',storageId:'',seqInDay:1},
  {id:'J008',ref:'WCHG-PRATT',brand:'MOVESQUAD',channel:'Account',jobType:'Door to Door',clientRef:'',moveManager:'',client:'Mrs Pratt',origin:'M23 2TU',dest:'BL3 4HS',start:'2026-03-02',end:'2026-03-02',vol:0,cbm:0,drivers:[],porters:[],mileage:18,veh:[],status:'Completed',billing:[{item:'Door to door',amt:312.00}],notes:'Picks up from Townsend delivery point.',journeyId:'JRN001',storageId:'',seqInDay:2},
  {id:'J005',ref:'137006A',brand:'EMS',channel:'Account',jobType:'Air',clientRef:'',moveManager:'',client:'Farakh Osman',origin:'BD9 6LH',dest:'INT STORE',start:'2026-03-04',end:'2026-03-04',vol:95,cbm:2.71,drivers:['MARTYN'],porters:[],mileage:55,veh:[],status:'Scheduled',billing:[{item:'Origin charge',amt:0},{item:'Casing x2',amt:84}],notes:'AIR shipment. Origin charge TBC.',journeyId:'JRN002',storageId:'S001',seqInDay:1},
  {id:'J009',ref:'137090B',brand:'EMS',channel:'Account',jobType:'Door to Door',clientRef:'',moveManager:'',client:'P. Akhtar',origin:'BD11 2FA',dest:'LS9 8EQ',start:'2026-03-04',end:'2026-03-04',vol:60,cbm:1.72,drivers:['MARTYN'],porters:[],mileage:14,veh:[],status:'Scheduled',billing:[{item:'Door to door',amt:220.00}],notes:'Back-to-back with Osman. Return to depot after.',journeyId:'JRN002',storageId:'',seqInDay:2},
  {id:'J006',ref:'LDN110738',brand:'STERLING',channel:'Account',jobType:'Other',clientRef:'',moveManager:'',client:'Paul Graham',origin:'DEBRIS',dest:'YO30 7AH',start:'2026-03-04',end:'2026-03-04',vol:0,cbm:0,drivers:[],porters:[],mileage:0,veh:[],status:'Scheduled',billing:[{item:'Debris',amt:96}],notes:'Debris job only.',journeyId:'',storageId:'',seqInDay:0},
  {id:'J007',ref:'156637',brand:'BRITANNIA',channel:'Partner',jobType:'Door to Door',clientRef:'',moveManager:'',client:'Mrs Alcock',origin:'WS9 0EF',dest:'WS9 8DY',start:'2026-03-06',end:'2026-03-06',vol:725,cbm:20.71,drivers:['ADRIAN'],porters:['DAVE'],mileage:6,veh:[],status:'Billed',billing:[{item:'Door to door',amt:1082.40}],notes:'Local move. JOE on holiday this week.',journeyId:'JRN003',storageId:'',seqInDay:1},
  {id:'J010',ref:'156638',brand:'BRITANNIA',channel:'Partner',jobType:'Door to Door',clientRef:'',moveManager:'',client:'Mr Webb',origin:'WS9 8DY',dest:'WV14 0JD',start:'2026-03-06',end:'2026-03-07',vol:310,cbm:8.85,drivers:['ADRIAN'],porters:['DAVE'],mileage:22,veh:[],status:'Billed',billing:[{item:'Door to door',amt:680.00},{item:'Overnight accommodation',amt:130.00}],notes:'Overnight stay in Wolverhampton. Return to depot Fri.',journeyId:'JRN003',storageId:'',seqInDay:2},
];

// ── JOURNEYS ─────────────────────────────────────────────────────────
// Container for multi-job, multi-day runs with shared crew/vehicles.
// jobIds: ordered sequence (chained mileage — each job picks up from prev dest).
// overnights: internal cost tracking (allowance × crew × nights).
//   billingNights: number of nights billed to client (may differ from internal nights).
//   allowancePerPerson: internal cost per person per night (e.g. £65).
var JOURNEYS = [
  {id:'JRN001',ref:'WCHG-RUN-0217',label:'Townsend + Pratt — Same Day',
   jobIds:['J004','J008'],
   crew:[], veh:[],
   overnights:{nights:0,allowancePerPerson:65,billingNights:0},
   notes:'Two deliveries, crew chains from Townsend dest → Pratt origin. Returns to depot after BL3.'},
  {id:'JRN002',ref:'137-RUN-0219',label:'EMS Bradford Double — Same Day',
   jobIds:['J005','J009'],
   crew:['MARTYN'], veh:[],
   overnights:{nights:0,allowancePerPerson:65,billingNights:0},
   notes:'Martyn does Osman origin then Akhtar D2D back-to-back. No overnight needed.'},
  {id:'JRN003',ref:'BRIT-156637-38',label:'Alcock + Webb — Overnight Journey',
   jobIds:['J007','J010'],
   crew:['ADRIAN','DAVE'], veh:[],
   overnights:{nights:1,allowancePerPerson:65,billingNights:1},
   notes:'Day 1: Mrs Alcock (local WS9). Day 2: Mr Webb delivery to Wolverhampton, overnight stay, return Thu.'},
];
var journeySeq = 4;

// ── JOURNEY HELPERS ───────────────────────────────────────────────────
function journeyById(id){ for(var i=0;i<JOURNEYS.length;i++) if(JOURNEYS[i].id===id) return JOURNEYS[i]; return null; }
function jobsInJourney(jrnId){ return jobs.filter(function(j){return j.journeyId===jrnId;}).sort(function(a,b){return a.seqInDay-b.seqInDay||(a.start<b.start?-1:1);}); }

// For a given job and date, how many other jobs share the same crew on the same day?
// Used to split day-rate crew cost equally across same-day jobs.
function sameCrewSameDayCount(job, ds) {
  var crew = job.drivers.concat(job.porters).filter(function(x){return x;});
  if (!crew.length) return 1;
  // Count all jobs on this date that share at least one crew member with job
  var count = 0;
  for (var i = 0; i < jobs.length; i++) {
    var other = jobs[i];
    if (other.start !== ds && other.end !== ds) continue; // same day check
    if (!jobDates(other).some(function(d){return d===ds;})) continue;
    var otherCrew = other.drivers.concat(other.porters).filter(function(x){return x;});
    var shared = crew.some(function(c){ return otherCrew.indexOf(c) >= 0; });
    if (shared) count++;
  }
  return Math.max(1, count);
}

// Overnight internal cost for a journey (allowance × crew × nights)
function journeyOvernightCost(jrn) {
  if (!jrn || !jrn.overnights || !jrn.overnights.nights) return 0;
  var crewCount = jrn.crew.length;
  if (!crewCount) {
    // Fall back to crew on first job
    var first = jobs.filter(function(j){return j.journeyId===jrn.id;})[0];
    if (first) crewCount = first.drivers.concat(first.porters).filter(function(x){return x;}).length;
  }
  return jrn.overnights.nights * jrn.overnights.allowancePerPerson * crewCount;
}

// Chained mileage for journey: warehouse → job1.origin → job1.dest → job2.origin → … → last.dest → warehouse
// Returns array of {from, to, miles} legs
function journeyLegs(jrn) {
  var jjobs = jobsInJourney(jrn.id);
  var legs = [];
  var wh = SL_CONFIG.companyPostcode || 'WN73EQ';
  var prev = wh;
  for (var i = 0; i < jjobs.length; i++) {
    var j = jjobs[i];
    // Leg: prev → job origin
    if (j.origin && j.origin !== prev) {
      legs.push({from: prev, to: j.origin, miles: postcodeDistanceMiles(prev, j.origin)});
    }
    // Leg: job origin → job dest
    if (j.dest && j.dest !== j.origin) {
      var jobMiles = j.mileage || postcodeDistanceMiles(j.origin, j.dest);
      legs.push({from: j.origin, to: j.dest, miles: jobMiles});
    }
    prev = j.dest || prev;
  }
  // Return leg: last dest → warehouse (only on last job)
  if (prev && prev !== wh) {
    legs.push({from: prev, to: wh, miles: postcodeDistanceMiles(prev, wh), isReturn: true});
  }
  return legs;
}

function totalJourneyMiles(jrn) {
  return journeyLegs(jrn).reduce(function(s,l){return s+l.miles;},0);
}


var curView = 'week';
var curMod  = 'dashboard';
var curDate = new Date(); // starts at today
var pMode   = 'view';
var eJob    = null;
var dragId  = null;
var TODAY   = d2s(new Date());

// ── HELPERS ───────────────────────────────────────────────────────────
function d2s(d){
  return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());
}
function s2d(s){
  var p=s.split('-'); return new Date(+p[0],+p[1]-1,+p[2]);
}
function pad(n){ return n<10?'0'+n:''+n; }
function addDays(d,n){ var r=new Date(d); r.setDate(r.getDate()+n); return r; }
function fmt(n){ return '£'+(+n||0).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function totalRev(j){ return j.billing.reduce(function(s,b){return s+b.amt;},0); }
function jobDur(j){ return Math.max(1,Math.round((s2d(j.end)-s2d(j.start))/(864e5))+1); }
// ── CREW COST FUNCTIONS ───────────────────────────────────────────────
// chargeRate  = day rate charged out per crew member (used in COS / job margin)
// notionalRate = true cost (basic × holiday × NI × pension) — Finance accounting only

function crewNotionalRate(c) {
  if (!c) return 0;
  if (!c.employed) return c.rate;
  var hol = 1 + (c.holiday || 0) / 100;
  var ni  = 1 + (c.ni      || 0) / 100;
  var pen = 1 + (c.pension || 0) / 100;
  return c.rate * hol * ni * pen;
}

// Breakdown of notional cost components for Finance view
function crewNotionalBreakdown(c, days) {
  if (!c) return {base:0,holAmt:0,niAmt:0,penAmt:0,total:0};
  var d = days || 1;
  if (!c.employed) return {base:c.rate*d,holAmt:0,niAmt:0,penAmt:0,total:c.rate*d,selfEmployed:true};
  var base   = c.rate * d;
  var holAmt = base * (c.holiday || 0) / 100;
  var niAmt  = (base + holAmt) * (c.ni || 0) / 100;
  var penAmt = (base + holAmt) * (c.pension || 0) / 100;
  return {base:base,holAmt:holAmt,niAmt:niAmt,penAmt:penAmt,total:base+holAmt+niAmt+penAmt};
}

// Charge-rate based COS (used in job panel, booking detail, main COS calcs)
// For same-day multi-job sequences, crew cost is split equally across all jobs they appear in that day.
function jobCrewCost(j, splitForDay) {
  var dur = jobDur(j);
  var cost = 0;
  var all = j.drivers.concat(j.porters).filter(function(x){return x;});
  for (var i = 0; i < all.length; i++) {
    var cr = crewByName(all[i]);
    if (!cr) continue;
    var dayRate = (cr.chargeRate || cr.rate);
    if (splitForDay && dur === 1) {
      // Split day rate across all jobs this crew member works on the same day
      var splitCount = sameCrewSameDayCount(j, j.start);
      cost += dayRate / splitCount;
    } else {
      cost += dayRate * dur;
    }
  }
  return cost;
}


// Fuel cost: vehicle mileage rate × job mileage (fallback to stored fuel value)
// Estimate road miles between two UK postcodes using straight-line × 1.3 factor
// Real routing requires an external API call; this gives a reasonable estimate offline
function postcodeDistanceMiles(pc1, pc2) {
  // Postcode sector lookup table (partial — major areas)
  // Returns approx lat/lng from postcode prefix
  function pcLatLng(pc) {
    var areas = {
      'WN':  [53.54, -2.64], 'M':   [53.48, -2.24], 'BL':  [53.58, -2.43],
      'SK':  [53.41, -2.16], 'OL':  [53.54, -2.12], 'PR':  [53.76, -2.70],
      'BB':  [53.75, -2.48], 'FY':  [53.82, -3.05], 'LA':  [54.04, -2.80],
      'CH':  [53.19, -2.89], 'CW':  [53.10, -2.44], 'WA':  [53.39, -2.60],
      'ST':  [52.99, -2.18], 'TF':  [52.69, -2.48], 'WV':  [52.59, -2.12],
      'WS':  [52.58, -1.98], 'DY':  [52.51, -2.09], 'B':   [52.48, -1.89],
      'CV':  [52.41, -1.50], 'NN':  [52.24, -0.89],
      'MK':  [52.04, -0.76], 'LU':  [51.88, -0.42], 'HP':  [51.76, -0.47],
      'AL':  [51.75, -0.24], 'SG':  [51.90, -0.21], 'CM':  [51.74,  0.47],
      'SS':  [51.57,  0.70], 'ME':  [51.40,  0.53], 'TN':  [51.07,  0.29],
      'BN':  [50.83, -0.14], 'PO':  [50.82, -1.08], 'SO':  [50.90, -1.40],
      'SP':  [51.07, -1.79], 'BA':  [51.38, -2.36], 'BS':  [51.45, -2.60],
      'GL':  [51.86, -2.24], 'HR':  [52.06, -2.72], 'SY':  [52.71, -2.75],
      'LD':  [52.24, -3.38], 'SA':  [51.62, -3.94], 'CF':  [51.48, -3.18],
      'NP':  [51.59, -2.99], 'LE':  [52.63, -1.13], 'DE':  [52.92, -1.48],
      'NG':  [52.95, -1.15], 'LN':  [53.23, -0.54], 'PE':  [52.57, -0.24],
      'CB':  [52.21,  0.12], 'IP':  [52.06,  1.16], 'NR':  [52.63,  1.30],
      'NE':  [54.97, -1.61], 'SR':  [54.90, -1.38], 'DH':  [54.78, -1.56],
      'TS':  [54.57, -1.23], 'DL':  [54.52, -1.55], 'HG':  [53.99, -1.54],
      'YO':  [53.96, -1.09], 'LS':  [53.80, -1.55], 'BD':  [53.79, -1.75],
      'HX':  [53.72, -1.86], 'HD':  [53.65, -1.78], 'WF':  [53.68, -1.50],
      'DN':  [53.52, -1.13], 'S':   [53.38, -1.47], 'HU':  [53.74, -0.33],
      'LN2': [53.23, -0.54], 'EX':  [50.72, -3.53], 'TQ':  [50.46, -3.53],
      'PL':  [50.37, -4.14], 'TR':  [50.26, -5.05], 'TA':  [51.02, -3.10],
      'DT':  [50.72, -2.44], 'BH':  [50.72, -1.88], 'GU':  [51.24, -0.57],
      'RG':  [51.46, -1.00], 'SL':  [51.51, -0.60], 'UB':  [51.54, -0.48],
      'HA':  [51.58, -0.34], 'EN':  [51.68, -0.08], 'WD':  [51.66, -0.41],
      'LU2': [51.88, -0.42], 'KT':  [51.37, -0.30], 'SM':  [51.37, -0.19],
      'CR':  [51.37, -0.10], 'BR':  [51.41,  0.02], 'DA':  [51.44,  0.22],
      'E':   [51.52, -0.02], 'EC':  [51.52, -0.09], 'N':   [51.57, -0.11],
      'NW':  [51.55, -0.18], 'W':   [51.51, -0.21], 'SW':  [51.47, -0.19],
      'SE':  [51.47, -0.04], 'WC':  [51.52, -0.12], 'WE':  [51.51, -0.14],
      'EH':  [55.95, -3.19], 'FK':  [56.00, -3.79], 'G':   [55.86, -4.25],
      'PA':  [55.84, -4.43], 'KA':  [55.61, -4.50], 'ML':  [55.77, -3.99],
      'KY':  [56.22, -3.15], 'DD':  [56.46, -3.00], 'PH':  [56.40, -3.44],
      'AB':  [57.14, -2.10], 'IV':  [57.48, -4.22],
    };
    var clean = (pc||'').toUpperCase().replace(/\s/g,'');
    // Try longest prefix first
    for (var len = 4; len >= 1; len--) {
      var key = clean.substr(0, len);
      if (areas[key]) return areas[key];
    }
    return null;
  }
  var ll1 = pcLatLng(pc1), ll2 = pcLatLng(pc2);
  if (!ll1 || !ll2) return null;
  // Haversine
  var R=3959, dLat=(ll2[0]-ll1[0])*Math.PI/180, dLon=(ll2[1]-ll1[1])*Math.PI/180;
  var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(ll1[0]*Math.PI/180)*Math.cos(ll2[0]*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
  var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return Math.round(R*c*1.35); // ×1.35 road factor
}

function jobFuelCost(j) {
  // Determine mileage: use stored mileage, or estimate from postcodes
  var miles = j.mileage || 0;
  if (!miles && j.origin && SL_CONFIG.companyPostcode) {
    var est = postcodeDistanceMiles(SL_CONFIG.companyPostcode, j.origin);
    if (est) miles = est;
  }
  if (!miles) return j.fuel || 0;

  // Find best mileage rate from assigned vehicles
  var vids = j.veh || [];
  var mileRate = 0;
  for (var i = 0; i < vids.length; i++) {
    for (var v = 0; v < VEHICLES.length; v++) {
      if (VEHICLES[v].reg === vids[i] || VEHICLES[v].name === vids[i]) {
        mileRate = Math.max(mileRate, VEHICLES[v].mileRate || 0);
        break;
      }
    }
  }
  if (mileRate === 0) {
    // Use cheapest vehicle as default
    for (var v = 0; v < VEHICLES.length; v++) {
      if (VEHICLES[v].mileRate > 0) { mileRate = VEHICLES[v].mileRate; break; }
    }
  }
  if (mileRate === 0) return j.fuel || 0;

  // Add return leg for non-overnight single-day jobs
  var dur = jobDur(j);
  var totalMiles = miles;
  if (APP_SETTINGS.returnMileage && dur === 1) {
    // Estimate return from dest back to warehouse
    var dest = j.dest || '';
    var wh = APP_SETTINGS.warehouseAddress || SL_CONFIG.companyPostcode || '';
    var retMiles = (dest && wh && dest !== wh) ? (postcodeDistanceMiles(dest, wh) || miles) : miles;
    totalMiles += retMiles;
  }

  return Math.round(mileRate * totalMiles * 100) / 100;
}

// Generic COS overhead: cosPerCrewPerDay × crew_count × duration
function jobCOSOverhead(j) {
  var crewCount = (j.drivers||[]).concat(j.porters||[]).filter(Boolean).length;
  if (!crewCount) return 0;
  var dur = jobDur(j);
  return crewCount * dur * (APP_SETTINGS.cosPerCrewPerDay || 125);
}

// Materials cost for a job (j.materials = [{id, qty}])
function jobMatCost(j) {
  if (!j.materials || !j.materials.length) return 0;
  return j.materials.reduce(function(s, bm) {
    var m = MATERIALS.filter(function(x){return x.id===bm.id;})[0];
    return s + (m ? m.unitCost * (bm.qty||0) : 0);
  }, 0);
}

// Full COS for a job: crew (charge rates) + fuel (incl. return) + vehicle day rates + materials + generic overhead
function jobCOS(j) {
  var dur = jobDur(j);
  var crewCost = jobCrewCost(j);
  var fuelCost = jobFuelCost(j);
  // Vehicle day rates for assigned vehicles
  var vehCost = 0;
  var vids = j.veh || [];
  for (var i = 0; i < vids.length; i++) {
    for (var v = 0; v < VEHICLES.length; v++) {
      if (VEHICLES[v].reg === vids[i] || VEHICLES[v].name === vids[i]) {
        vehCost += (VEHICLES[v].dayRate || 0) * dur;
        break;
      }
    }
  }
  var matCost = jobMatCost(j);
  var overhead = jobCOSOverhead(j);
  return crewCost + fuelCost + vehCost + matCost + overhead;
}

// Notional-rate COS for Finance accounting view only
function jobCOSNotional(j) {
  var dur = jobDur(j);
  var cost = 0;
  var all = j.drivers.concat(j.porters);
  for (var i = 0; i < all.length; i++) {
    var cr = crewByName(all[i]);
    if (cr) cost += crewNotionalRate(cr) * dur;
  }
  return cost + jobFuelCost(j);
}
function crewByName(n){
  for(var i=0;i<CREW.length;i++) if(CREW[i].name===n) return CREW[i];
  return null;
}

// ── GLOBAL SENSITIVE VALUE PROTECTION ────────────────────────────────
// spv(html) — wraps any sensitive £/% value; body.vals-visible shows all
function spv(val, id) {
  return '<span class="spv"' + (id ? ' id="' + id + '"' : '') + '>' + val + '</span>';
}
function toggleVals() {
  document.body.classList.toggle('vals-visible');
}
function jobDates(j){
  var ds=[]; var d=s2d(j.start); var e=s2d(j.end);
  while(d<=e){ ds.push(d2s(d)); d=addDays(d,1); }
  return ds;
}
function jobsOnDate(ds){ return jobs.filter(function(j){ return jobDates(j).indexOf(ds)>=0; }); }
function weekMon(d){
  var r=new Date(d); var wd=r.getDay();
  r.setDate(r.getDate()-(wd===0?6:wd-1)); r.setHours(0,0,0,0); return r;
}
function fmtNice(ds){ var d=s2d(ds); return DF[d.getDay()]+' '+d.getDate()+' '+MS[d.getMonth()]+' '+d.getFullYear(); }
function esc(s){ return String(s||'').replace(/&/g,'\x26amp;').replace(/</g,'\x26lt;').replace(/>/g,'\x26gt;').replace(/"/g,'\x26quot;'); }
function toTitleCase(s) {
  // Convert ALL-CAPS or all-lowercase names to Title Case. Mixed-case left alone.
  if (!s) return '';
  var str = String(s);
  var letters = str.replace(/[^A-Za-z]/g, '');
  if (!letters.length) return str;
  var isAllUpper = letters === letters.toUpperCase();
  var isAllLower = letters === letters.toLowerCase();
  if (!isAllUpper && !isAllLower) return str; // already mixed — don't touch
  return str.toLowerCase().replace(/(?:^|[\s\-\/\(])([a-z])/g, function(m, c) { return m.slice(0, -1) + c.toUpperCase(); });
}
function statusCls(s){ return 's-'+s.toLowerCase().replace(/\s+/g,''); }
function brandCls(b){ return BCLS[b]||''; }
function sbadge(s){ return '<span class="sbadge '+statusCls(s)+'">'+esc(s)+'</span>'; }
// bbadge: renders brand as logo pill (with fallback to colour text badge)
// Size: 'sm' = small (used in table cells, chips) | '' = normal
function bbadge(b, size) {
  var col  = BC[b]  || '#888';
  var blt  = BBLT[b]|| '#f0f4ff';
  var btxt = BTXT[b]|| '#333';
  var logo = BLOG[b]|| '';
  if (logo) {
    var imgH = size === 'lg' ? '28px' : size === 'sm' ? '16px' : '20px';
    return '<img src="'+logo+'" alt="'+esc(b)+'" title="'+esc(b)+'" style="height:'+imgH+';width:auto;max-width:'+(size==='lg'?'80px':'54px')+';object-fit:contain;vertical-align:middle;border-radius:3px;display:inline-block">';
  }
  // Fallback: colour text badge
  var fs = size === 'lg' ? '11px' : size === 'sm' ? '9.5px' : '10.5px';
  var pad = size === 'lg' ? '4px 10px' : size === 'sm' ? '2px 5px' : '2px 7px';
  return '<span class="bbadge" style="background:'+blt+';color:'+btxt+';border:1px solid '+col+'33;font-size:'+fs+';font-weight:700;padding:'+pad+'">'+esc(b)+'</span>';
}
function crewAvatar(c, size) {
  var sz = size || 24;
  if (c && c.photo) {
    return '<img src="'+c.photo+'" style="width:'+sz+'px;height:'+sz+'px;border-radius:50%;object-fit:cover;vertical-align:middle;border:1.5px solid rgba(255,255,255,.6)" alt="'+esc(c.name)+'">';
  }
  var col = (c && c.col) ? c.col : '#888';
  var ini = c ? c.name[0] : '?';
  return '<span style="display:inline-flex;align-items:center;justify-content:center;width:'+sz+'px;height:'+sz+'px;border-radius:50%;background:'+col+';color:#fff;font-size:'+Math.round(sz*.42)+'px;font-weight:700;vertical-align:middle;flex-shrink:0;border:1.5px solid rgba(255,255,255,.5)">'+ini+'</span>';
}
function chip(t) {
  var c = crewByName(t);
  var col = (c && c.col) ? c.col : '#888';
  return '<span class="chip" style="background:'+col+'20;color:'+col+';border:1px solid '+col+'40;display:inline-flex;align-items:center;gap:4px;padding:2px 7px 2px 3px;border-radius:20px;font-size:11px;font-weight:600">'+crewAvatar(c,18)+esc(t)+'</span>';
}
function toast(msg){ var t=document.getElementById('toast-el'); t.textContent=msg; t.classList.add('on'); setTimeout(function(){t.classList.remove('on');},2600); }
function el(id){ return document.getElementById(id); }
function setH(id,h){ el(id).innerHTML=h; }
function setBadge(id,n){ var b=el(id); if(!b)return; b.textContent=n; b.classList.toggle('hidden',!n||n<1); }

// ── MODULE NAV ────────────────────────────────────────────────────────
function showMod(mod,btn){
  curMod=mod;
  document.querySelectorAll('.page').forEach(function(p){p.classList.remove('on');});
  document.querySelectorAll('.nb').forEach(function(b){b.classList.remove('on');});
  el('mod-'+mod).classList.add('on');
  btn.classList.add('on');
  var titles={dashboard:'Dashboard',calendar:'Job Calendar',crew:'Crew Scheduler',finance:'Finance & Billing',settings:'Settings',bookings:'Booking Manager',storage:'Storage',warehouse:'Warehouse'};
  el('tb-title').textContent=titles[mod]||mod;
  el('vtabs').style.display=(mod==='calendar'||mod==='crew'||mod==='finance')?'flex':'none';
  if(mod==='dashboard') renderDashboard();
  // Update vtab buttons to match module
  var vtabs = document.querySelectorAll('.vt');
  if(mod==='crew'||mod==='finance'){
    vtabs.forEach(function(t){ t.style.display='none'; });
    // Show only week/month/list for crew and finance
    ['week','month','list'].forEach(function(v){
      var btn = document.querySelector('.vt[onclick*="\''+v+'\'"]') || document.querySelector('.vt[onclick*=\'"'+v+'"\']');
      if(btn) btn.style.display='';
    });
  } else {
    vtabs.forEach(function(t){ t.style.display=''; });
  }
  // Hide top cnav for warehouse (it has its own)
  var cnav = document.querySelector('.topbar .cnav');
  if(cnav) cnav.style.display = mod==='warehouse'?'none':'flex';
  if(mod==='crew') renderCrew();
  if(mod==='finance') renderFinance();
  if(mod==='storage') renderStorage();
  if(mod==='calendar') renderCal();
  if(mod==='settings'){ curStab='crew'; renderSettingsCrew(); }
  if(mod==='bookings') initBookingMod();
}

// ── VIEW SWITCHING ────────────────────────────────────────────────────
function setView(v,btn){
  curView=v;
  document.querySelectorAll('.vt').forEach(function(t){t.classList.remove('on');});
  btn.classList.add('on');
  renderActiveMod();
}
function renderCal(){
  if(curView==='week')    renderWeek(false);
  else if(curView==='twoweek') renderWeek(true);
  else if(curView==='day')     renderDay();
  else if(curView==='month')   renderMonth();
  else if(curView==='list')    renderList();
  setBadge('job-badge',jobs.length);
}
function navPrev(){
  if(curView==='month') curDate=new Date(curDate.getFullYear(),curDate.getMonth()-1,1);
  else if(curView==='day') curDate=addDays(curDate,-1);
  else if(curView==='list') curDate=addDays(curDate,-30);
  else if(curView==='twoweek') curDate=addDays(curDate,-14);
  else curDate=addDays(curDate,-7);
  renderActiveMod();
}
function renderActiveMod(){
  if(curMod==='crew') renderCrew();
  else if(curMod==='finance') renderFinance();
  else renderCal();
}
function navNext(){
  if(curView==='month') curDate=new Date(curDate.getFullYear(),curDate.getMonth()+1,1);
  else if(curView==='day') curDate=addDays(curDate,1);
  else if(curView==='list') curDate=addDays(curDate,30);
  else if(curView==='twoweek') curDate=addDays(curDate,14);
  else curDate=addDays(curDate,7);
  renderActiveMod();
}
function goToday(){ curDate=new Date(); renderCal(); }
function jumpDay(ds){
  curDate=s2d(ds);
  curView='day';
  // Update view tab highlight
  var vtabs=document.querySelectorAll('.vt');
  vtabs.forEach(function(t){t.classList.remove('on');});
  // Find the Day button (index 3)
  if(vtabs[3]) vtabs[3].classList.add('on');
  renderCal();
}



// ── CALENDAR — Vertical date-grouped job list ────────────────────────
// All views (Week/2-Week/Month/Day/List) use the same renderer.
// Layout: date section headers, jobs as cards beneath each date.
// Scroll vertically to move through time.

function calRangeForMode(mode) {
  var cols = [], ws, i;
  if (mode === 'week') {
    ws = weekMon(curDate);
    for (i = 0; i < 7; i++) cols.push(addDays(ws, i));
  } else if (mode === 'twoweek') {
    ws = weekMon(curDate);
    for (i = 0; i < 14; i++) cols.push(addDays(ws, i));
  } else if (mode === 'day') {
    cols.push(new Date(curDate));
  } else if (mode === 'month') {
    var yr = curDate.getFullYear(), mo = curDate.getMonth();
    var d = new Date(yr, mo, 1), last = new Date(yr, mo + 1, 0);
    while (d <= last) { cols.push(new Date(d)); d = addDays(d, 1); }
  } else { // list — 90 days from today
    var start = new Date(curDate);
    for (i = 0; i < 90; i++) cols.push(addDays(start, i));
  }
  return cols;
}

function calNavLabel(mode) {
  if (mode === 'week') {
    var ws = weekMon(curDate), e = addDays(ws, 6);
    return MS[ws.getMonth()].substr(0,3) + ' ' + ws.getDate() + ' – ' +
      (ws.getMonth() !== e.getMonth() ? MS[e.getMonth()].substr(0,3) + ' ' : '') +
      e.getDate() + ', ' + e.getFullYear();
  }
  if (mode === 'twoweek') {
    var ws = weekMon(curDate), e = addDays(ws, 13);
    return MS[ws.getMonth()].substr(0,3) + ' ' + ws.getDate() + ' – ' +
      MS[e.getMonth()].substr(0,3) + ' ' + e.getDate() + ', ' + e.getFullYear();
  }
  if (mode === 'day') {
    return DF[curDate.getDay()] + ', ' + curDate.getDate() + ' ' +
      MS[curDate.getMonth()] + ' ' + curDate.getFullYear();
  }
  if (mode === 'month') return MS[curDate.getMonth()] + ' ' + curDate.getFullYear();
  // list
  var e = addDays(new Date(curDate), 89);
  return curDate.getDate() + ' ' + MS[curDate.getMonth()].substr(0,3) + ' – ' +
    e.getDate() + ' ' + MS[e.getMonth()].substr(0,3) + ' ' + e.getFullYear();
}

function renderCalVertical(mode) {
  el('cn-lbl').textContent = calNavLabel(mode);
  var dates = calRangeForMode(mode);

  // Build journey start-date lookup (earliest job start in journey)
  var jrnFirstDate = {};
  for (var ji = 0; ji < JOURNEYS.length; ji++) {
    var jrn = JOURNEYS[ji];
    var earliest = null;
    for (var jj = 0; jj < jrn.jobIds.length; jj++) {
      var jb = jobs.filter(function(x){return x.id === jrn.jobIds[jj];})[0];
      if (jb && (!earliest || jb.start < earliest)) earliest = jb.start;
    }
    jrnFirstDate[jrn.id] = earliest || '';
  }

  var h = '<div class="fade-in">';
  var totalJobs = 0;

  for (var di = 0; di < dates.length; di++) {
    var ds = d2s(dates[di]);
    var dow = dates[di].getDay();
    var isToday = ds === TODAY;
    var isWknd = dow === 0 || dow === 6;

    // Get jobs on this date
    var dj = jobsOnDate(ds);

    // For week/2week/month hide empty weekend days
    if (!dj.length && isWknd && mode !== 'day' && mode !== 'list') continue;

    totalJobs += dj.length;

    // Sort jobs: journeys grouped (by their earliest date + seq), standalone by start
    dj.sort(function(a, b) {
      var aKey = a.journeyId
        ? (jrnFirstDate[a.journeyId] || a.start) + '_' + a.journeyId + '_' + String(a.seqInDay || 0).padStart(3,'0')
        : a.start + '_zzz_' + a.id;
      var bKey = b.journeyId
        ? (jrnFirstDate[b.journeyId] || b.start) + '_' + b.journeyId + '_' + String(b.seqInDay || 0).padStart(3,'0')
        : b.start + '_zzz_' + b.id;
      return aKey < bKey ? -1 : aKey > bKey ? 1 : 0;
    });

    // Day revenue (jobs starting today)
    var dayRev = 0;
    for (var k = 0; k < dj.length; k++) if (dj[k].start === ds) dayRev += totalRev(dj[k]);

    // ── DATE SECTION HEADER ──────────────────────────────────────────
    h += '<div class="cal-date-hdr' + (isToday ? ' today' : '') + (isWknd ? ' weekend' : '') + (!dj.length ? ' empty' : '') + '" onclick="openNew(\'' + ds + '\')">';
    h += '<span class="cdh-dow">' + DS[dates[di].getDay()] + '</span>';
    h += '<span class="cdh-num">' + dates[di].getDate() + '</span>';
    h += '<span class="cdh-mon">' + MS[dates[di].getMonth()].substr(0, 3) + '</span>';
    if (isToday) h += '<span class="cdh-today-pill">TODAY</span>';
    if (dj.length) {
      h += '<span class="cdh-jobs">' + dj.length + ' job' + (dj.length !== 1 ? 's' : '') + '</span>';
      if (dayRev > 0) h += '<span class="cdh-rev">' + spv(fmt(dayRev)) + '</span>';
    }
    h += '<button class="cdh-add" onclick="event.stopPropagation();openNew(\'' + ds + '\')">+ Job</button>';
    h += '</div>';

    if (!dj.length) continue;

    // ── JOB CARDS ────────────────────────────────────────────────────
    var prevJrnId = '';
    for (var ji2 = 0; ji2 < dj.length; ji2++) {
      var j = dj[ji2];
      var jrn = j.journeyId ? journeyById(j.journeyId) : null;
      var color = BC[j.brand] || '#888';
      var crew = j.drivers.concat(j.porters).filter(function(x){return x;});
      var dur = jobDur(j);
      var rev = totalRev(j);
      var isStart = j.start === ds;
      var isCont = !isStart; // job started on a previous day

      // Journey banner — show once per journey per day (on first job of that journey)
      if (jrn && j.journeyId !== prevJrnId) {
        var nightStr = jrn.overnights && jrn.overnights.nights
          ? '&#127769; ' + jrn.overnights.nights + 'n overnight' : '';
        h += '<div class="jrn-banner" id="jbnr-' + jrn.id + '-' + ds + '">';
        h += '<span class="jrn-banner-lbl">&#128648; ' + esc(jrn.label) + '</span>';
        h += '<span class="jrn-banner-ref">' + esc(jrn.ref) + '</span>';
        if (nightStr) h += '<span class="jrn-banner-night">' + nightStr + '</span>';
        h += '<a href="#" style="font-size:9.5px;font-weight:700;color:var(--purple);text-decoration:none;margin-left:auto" ';
        h += 'onclick="event.preventDefault();event.stopPropagation();viewJourney(\'' + jrn.id + '\')">View &#8594;</a>';
        h += '</div>';
        prevJrnId = j.journeyId;
      } else if (!j.journeyId) {
        prevJrnId = '';
      }

      // ── CARD ─────────────────────────────────────────────────────────
      h += '<div class="jcard' + (jrn ? ' in-journey' : '') + '" style="border-left-color:' + color + '" onclick="viewJob(\'' + j.id + '\')" oncontextmenu="quickStatusMenu(event,\'' + j.id + '\')">';

      // ── HEAD ─────────────────────────────────────────────────────────
      h += '<div class="jcard-head">';

      // Zone 1 — Brand logo, hard border isolates it from client name
      h += '<div class="jcard-logo">' + bbadge(j.brand, 'lg') + '</div>';

      // Zone 2 — Client name (title-cased, large) + ref on its own line
      h += '<div class="jcard-title">';
      h += '<div class="jcard-client">' + esc(toTitleCase(j.client)) + '</div>';
      h += '<div class="jcard-ref">' + esc(j.ref) + (isCont ? ' &nbsp;<span style="font-size:10px;font-weight:500;color:var(--t4);font-family:sans-serif">&#8635; continuing</span>' : '') + '</div>';
      h += '</div>'; // jcard-title
      // Zone 3 — Status badge
      var stCls = {'Pending':'st-pending','Confirmed':'st-confirmed','In Progress':'st-inprog','Completed':'st-done','Billed':'st-billed','Cancelled':'st-cancelled'}[j.status]||'st-pending';
      h += '<div class="jcard-status ' + stCls + '">' + (j.status||'Pending') + '</div>';

      // Zone 3 — Flag badges: journey order, storage, multi-day, overnight, air/other type
      h += '<div class="jcard-flags">';
      // Journey order badge — most prominent, always first
      if (jrn && j.seqInDay) {
        h += '<span class="jflag jflag-seq">&#128648; ' + j.seqInDay + ' / ' + jrn.jobIds.length + '</span>';
      }
      h += '<div class="jcard-flag-row">';
      if (j.storageId) {
        var stoRec = null;
        for (var si2=0;si2<STORAGE_RECORDS.length;si2++) if(STORAGE_RECORDS[si2].id===j.storageId){stoRec=STORAGE_RECORDS[si2];break;}
        var stoDir = j.storageDirection || (j.dest==='INT STORE'?'in': j.origin&&j.origin.indexOf('EX STORE')===0?'out':null);
        var stoDirIcon = stoDir==='in'?'⬇️':stoDir==='out'?'⬆️':'🏭';
        var stoCtnrs = j.containersToRemove&&j.containersToRemove.length ? j.containersToRemove.join(', ') : (stoRec&&stoRec.containers&&stoRec.containers.length?stoRec.containers.map(function(c){return c.containerNo;}).join(', ').substring(0,20):'');
        h += '<span class="jflag jflag-storage" title="Storage ' + (stoRec?stoRec.id:'') + (stoCtnrs?' ['+stoCtnrs+']':'') + '">' + stoDirIcon + ' ' + (stoRec?stoRec.id:'Store') + (stoCtnrs?' <span style="font-size:9px;opacity:.7">['+esc(stoCtnrs.substring(0,12))+']</span>':'') + '</span>';
      }
      if (dur > 1)                                                  h += '<span class="jflag jflag-multiday" title="' + dur + '-day job">&#128197; ' + dur + 'd</span>';
      if (jrn && jrn.overnights && jrn.overnights.nights > 0)      h += '<span class="jflag jflag-overnight" title="Overnight stay">&#127769; ' + jrn.overnights.nights + 'n</span>';
      if (jrn && !j.seqInDay)                                       h += '<span class="jflag jflag-journey" title="Part of journey ' + esc(jrn.ref) + '">&#128648; Journey</span>';
      h += '</div>';
      h += '</div>'; // jcard-flags

      // Zone 4 — Status + edit button
      h += '<div class="jcard-actions">';
      h += sbadge(j.status);
      h += '<button class="btn btn-g btn-sm" onclick="event.stopPropagation();openEdit(\'' + j.id + '\')" title="Edit" style="padding:4px 9px;font-size:13px">&#9998;</button>';
      h += '</div>'; // jcard-actions

      h += '</div>'; // jcard-head

      // BODY: info grid — route | volume | vehicles | revenue
      h += '<div class="jcard-body">';

      // Column 1: Route
      h += '<div class="jci">';
      h += '<div class="jci-lbl"><span class="ico">&#128205;</span> Route</div>';
      // Format origin — highlight EX STORE
      var originDisplay = j.origin || '—';
      if (j.origin && j.origin.indexOf('EX STORE') === 0) {
        h += '<div class="jci-val route"><span style="color:#007048;font-weight:700">🏭 ' + esc(j.origin) + '</span></div>';
      } else {
        h += '<div class="jci-val route"><strong>' + esc(originDisplay) + '</strong></div>';
      }
      h += '<div style="font-size:10px;color:var(--t4);margin:1px 0">&#8595; to</div>';
      // Format dest — highlight INT STORE with container info if available
      if (j.dest === 'INT STORE') {
        var iRec = j.storageId ? STORAGE_RECORDS.filter(function(s){return s.id===j.storageId;})[0] : null;
        var iCtnrs = iRec && iRec.containers && iRec.containers.length ? iRec.containers.slice(0,2).map(function(c){return c.containerNo;}).join(', ') : '';
        h += '<div class="jci-val route"><span style="color:#0073EA;font-weight:700">🏭 INT STORE</span>';
        if (iCtnrs) h += ' <span style="font-size:10px;color:#7A849E">[' + esc(iCtnrs) + (iRec.containers.length>2?'…':'') + ']</span>';
        else if (iRec) h += ' <span style="font-size:10px;color:#B0B8CC">containers TBA</span>';
        h += '</div>';
      } else {
        h += '<div class="jci-val route"><strong>' + esc(j.dest || '—') + '</strong></div>';
      }
      h += '</div>';

      // Column 2: Job type + volume
      h += '<div class="jci">';
      h += '<div class="jci-lbl"><span class="ico">&#128230;</span> Type &amp; Volume</div>';
      if (j.jobType) h += '<div class="jci-val">' + esc(j.jobType) + '</div>';
      if (j.vol > 0) h += '<div class="jci-val" style="color:var(--t2);">' + j.vol.toLocaleString() + ' ft&#179;</div>';
      else if (j.cbm > 0) h += '<div class="jci-val" style="color:var(--t2);">' + j.cbm + ' CBM</div>';
      else h += '<div class="jci-val" style="color:var(--t4)">—</div>';
      h += '</div>';

      // Column 3: Vehicles
      h += '<div class="jci">';
      h += '<div class="jci-lbl"><span class="ico">&#128652;</span> Vehicle' + (j.veh && j.veh.length > 1 ? 's' : '') + '</div>';
      if (j.veh && j.veh.length) {
        for (var vk = 0; vk < j.veh.length; vk++) {
          h += '<div class="jci-val mono">' + esc(j.veh[vk]) + '</div>';
        }
      } else {
        h += '<div class="jci-val" style="color:var(--t4)">TBA</div>';
      }
      h += '</div>';

      // Column 4: Revenue (financial, hidden behind spv)
      h += '<div class="jci" style="min-width:100px;align-items:flex-end">';
      h += '<div class="jci-lbl"><span class="ico">&#163;</span> Charge</div>';
      if (rev > 0) h += '<div class="jci-val big blue">' + spv(fmt(rev)) + '</div>';
      else h += '<div class="jci-val" style="color:var(--t4)">TBC</div>';
      h += '</div>';

      h += '</div>'; // jcard-body

      // FOOTER: crew chips
      if (crew.length || true) { // always show footer for consistent height
        h += '<div class="jcard-foot">';
        h += '<span class="jcard-foot-lbl"><span class="ico">&#128100;</span> Crew</span>';
        if (crew.length) {
          for (var k = 0; k < crew.length; k++) h += chip(crew[k]);
        } else {
          h += '<span style="font-size:11px;color:var(--t4);font-style:italic">No crew assigned</span>';
        }
        h += '</div>';
      }

      h += '</div>'; // jcard
    }

    // Surveys for this date (from SURVEYS array)
    var daySurveys = SURVEYS.filter(function(s){ return s.surveyDate === ds; });
    if (daySurveys.length) {
      h += '<div style="margin-top:6px;border-top:1px dashed #FFD580;padding-top:6px">';
      h += '<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#B07800;margin-bottom:4px">&#128269; Surveys</div>';
      daySurveys.forEach(function(sv) {
        var stCol = sv.status==='Completed'?'#00A86B':sv.status==='No Show'||sv.status==='Cancelled'?'#E44258':'#7A5200';
        h += '<div style="background:#FFFBE6;border:1px solid #FFD580;border-radius:5px;padding:5px 9px;margin-bottom:3px;font-size:11.5px;cursor:pointer" data-svid="'+sv.id+'" onclick="openEditSurvey(this.dataset.svid)">';
        h += '<div style="font-weight:700;color:'+stCol+'">'+(sv.surveyTime?sv.surveyTime+' — ':'')+esc(sv.clientName)+'</div>';
        h += '<div style="color:#B07800;font-size:10.5px">'+esc(sv.brand)+' &middot; '+esc(sv.postcode||'')+(sv.surveyor?' &middot; '+esc(sv.surveyor):'')+'</div>';
        h += '</div>';
      });
      h += '</div>';
    }
  }

  if (!totalJobs) {
    h += '<div class="cal-empty">';
    h += '<div style="font-size:28px;margin-bottom:12px">&#128203;</div>';
    h += '<div style="font-weight:700;font-size:15px;color:var(--t2);margin-bottom:6px">No jobs in this period</div>';
    h += '<div style="font-size:12px;margin-bottom:16px">Dates are shown as section headers above — click any date to add a job.</div>';
    h += '<button class="btn btn-p" onclick="openNew(null)">+ New Job</button></div>';
  }

  h += '<div class="cal-period-end">End of period &mdash; <a href="#" style="color:var(--blue);font-weight:600;text-decoration:none" onclick="event.preventDefault();navNext()">Next &rarr;</a></div>';
  h += '</div>';
  setH('cal-out', h);
}

function renderWeek(is2w) {
  renderCalVertical(is2w ? 'twoweek' : 'week');
}
function renderDay() {
  renderCalVertical('day');
}
function renderMonth() {
  renderCalVertical('month');
}
function renderList() {
  renderCalVertical('list');
}

function calCellClick(e, jid, ds) {
  // Legacy — kept for safety
  e.stopPropagation();
  viewJob(jid);
}






// ── GLOBAL SEARCH ─────────────────────────────────────────────────────
function renderSearchResults(q) {
  var drop = el('search-drop');
  q = (q||'').trim().toLowerCase();
  if (!q || q.length < 2) { drop.innerHTML = ''; return; }

  var results = jobs.filter(function(j){
    return (j.client||'').toLowerCase().indexOf(q) >= 0
        || (j.ref||'').toLowerCase().indexOf(q) >= 0
        || (j.brand||'').toLowerCase().indexOf(q) >= 0
        || (j.origin||'').toLowerCase().indexOf(q) >= 0
        || (j.dest||'').toLowerCase().indexOf(q) >= 0
        || (j.moveManager||'').toLowerCase().indexOf(q) >= 0
        || (j.drivers||[]).some(function(d){ return d.toLowerCase().indexOf(q) >= 0; });
  }).slice(0, 12);

  if (!results.length) {
    drop.innerHTML = '<div style="padding:12px 14px;font-size:12.5px;color:var(--t3)">No results for "'+esc(q)+'"</div>';
    return;
  }

  var h = '';
  results.forEach(function(j){
    var rev = totalRev(j);
    var stCol = {'Pending':'#FF9F00','Confirmed':'#0073EA','In Progress':'#A25DDC','Completed':'#00C875','Billed':'#00C875','Cancelled':'#E44258'}[j.status]||'#ccc';
    h += '<div style="padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--s2)" onmousedown="searchGoToJob(\''+j.id+'\')">'; 
    h += '<div style="flex-shrink:0">'+bbadge(j.brand,'sm')+'</div>';
    h += '<div style="flex:1;min-width:0">';
    h += '<div style="font-size:12.5px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(j.client)+'</div>';
    h += '<div style="font-size:11px;color:var(--t3)">'+esc(j.ref)+' &middot; '+j.start+(j.end && j.end !== j.start?' → '+j.end:'')+'</div>';
    h += '</div>';
    h += '<div style="text-align:right;flex-shrink:0">';
    if (rev) h += '<div style="font-size:12px;font-weight:700;color:var(--t1)">'+fmt(rev)+'</div>';
    h += '<div style="font-size:10px;font-weight:700;color:'+stCol+'">'+j.status+'</div>';
    h += '</div>';
    h += '</div>';
  });
  if (results.length === 12) h += '<div style="padding:8px 12px;font-size:11.5px;color:var(--t3);text-align:center">Showing first 12 results</div>';
  drop.innerHTML = h;
}

function searchGoToJob(jobId) {
  var j = jobs.filter(function(x){ return x.id === jobId; })[0];
  if (!j) return;
  // Clear search
  el('global-search').value = '';
  el('search-drop').innerHTML = '';
  el('search-drop').style.display = 'none';
  // Navigate to calendar at job's date
  curDate = new Date(j.start);
  curView = 'week';
  document.querySelectorAll('.vt').forEach(function(t){ t.classList.remove('on'); });
  var weekBtn = document.querySelector('.vt[onclick*="week"]');
  if (weekBtn) weekBtn.classList.add('on');
  showMod('calendar', el('nb-calendar'));
  // Open job panel
  setTimeout(function(){ viewJob(jobId); }, 100);
}

// ── DASHBOARD ─────────────────────────────────────────────────────────
function renderDashboard() {
  var now = new Date();
  var todayStr = d2s(now);
  var thisMonStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
  var thisYearStr = String(now.getFullYear());

  // Today's jobs
  var todayJobs = jobs.filter(function(j){ return jobDates(j).indexOf(todayStr) >= 0; });

  // This week's jobs
  var wkMon = weekMon(now), wkSun = addDays(wkMon, 6);
  var wkMonStr = d2s(wkMon), wkSunStr = d2s(wkSun);
  var weekJobs = jobs.filter(function(j){
    var dates = jobDates(j);
    return dates.some(function(d){ return d >= wkMonStr && d <= wkSunStr; });
  });

  // This month revenue
  var monthJobs = jobs.filter(function(j){ return j.start.substr(0,7) === thisMonStr; });
  var monthRev = monthJobs.reduce(function(s,j){ return s + totalRev(j); }, 0);
  var monthBilled = monthJobs.filter(function(j){ return j.status === 'Billed'; }).reduce(function(s,j){ return s + totalRev(j); }, 0);

  // Unbilled jobs (completed but not billed)
  var unbilled = jobs.filter(function(j){ return j.status === 'Completed' && totalRev(j) > 0; });

  // Unconfirmed upcoming jobs (start >= today, status Pending)
  var unconfirmed = jobs.filter(function(j){ return j.start >= todayStr && j.status === 'Pending'; });

  // Jobs needing crew (start in next 7 days, no drivers assigned)
  var needCrew = jobs.filter(function(j){
    return j.start >= todayStr && j.start <= wkSunStr && (!j.drivers || !j.drivers.length);
  });

  // Crew utilisation this week
  var crewUtil = {};
  CREW.forEach(function(c){
    var days = 0;
    for(var i=0;i<7;i++){
      var ds = d2s(addDays(wkMon,i));
      if(jobs.some(function(j){ return j.drivers.concat(j.porters||[]).indexOf(c.name)>=0 && jobDates(j).indexOf(ds)>=0; })) days++;
    }
    crewUtil[c.name] = days;
  });

  // Tomorrow's jobs
  var tmrStr = d2s(addDays(now,1));
  var tmrJobs = jobs.filter(function(j){ return jobDates(j).indexOf(tmrStr) >= 0; });

  var h = '<div style="max-width:1100px;margin:0 auto">';

  // ── TOP KPI STRIP ──────────────────────────────────────────────────
  h += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px">';
  var kpis = [
    {label:"Today's Jobs",    val:todayJobs.length,         sub:'on the board today',        col:'var(--blue)'},
    {label:'This Week',       val:weekJobs.length,          sub:'jobs this week',             col:'var(--purple)'},
    {label:'Month Revenue',   val:fmt(monthRev),            sub:monthJobs.length+' jobs',     col:'var(--green)'},
    {label:'Pending Billing', val:unbilled.length,          sub:'completed, not billed',      col:unbilled.length>0?'var(--amber)':'var(--green)'},
  ];
  kpis.forEach(function(k){
    h += '<div style="background:var(--w);border-radius:10px;padding:16px 18px;border:1px solid var(--b1)">';
    h += '<div style="font-size:11px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px">'+k.label+'</div>';
    h += '<div style="font-size:26px;font-weight:800;color:'+k.col+';line-height:1">'+k.val+'</div>';
    h += '<div style="font-size:11.5px;color:var(--t3);margin-top:5px">'+k.sub+'</div>';
    h += '</div>';
  });
  h += '</div>';

  // ── TWO COL ROW ────────────────────────────────────────────────────
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px">';

  // Today's jobs list
  h += '<div style="background:var(--w);border-radius:10px;border:1px solid var(--b1);overflow:hidden">';
  h += '<div style="padding:12px 16px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between">';
  h += '<div style="font-weight:700;font-size:13.5px">Today — '+fmtDateLong(now)+'</div>';
  h += '<span style="font-size:11px;color:var(--t3)">'+todayJobs.length+' jobs</span></div>';
  if (!todayJobs.length) {
    h += '<div style="padding:24px;text-align:center;color:var(--t3);font-size:12.5px">No jobs scheduled today</div>';
  } else {
    h += '<div style="overflow:auto;max-height:240px">';
    todayJobs.forEach(function(j){
      var stCol = {'Pending':'var(--amber)','Confirmed':'var(--blue)','In Progress':'var(--purple)','Completed':'var(--green)','Billed':'var(--green)','Cancelled':'var(--red)'}[j.status]||'var(--t4)';
      h += '<div style="padding:9px 16px;border-bottom:1px solid var(--s2);display:flex;align-items:center;gap:10px;cursor:pointer" onclick="viewJob(\''+j.id+'\');showMod(\'calendar\',el(\'nb-calendar\'))">';
      h += bbadge(j.brand,'sm');
      h += '<div style="flex:1;min-width:0"><div style="font-weight:600;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(j.client)+'</div>';
      h += '<div style="font-size:11px;color:var(--t3)">'+esc(j.origin||'')+(j.dest?' → '+esc(j.dest):'')+'</div></div>';
      h += '<div style="font-size:11px;font-weight:700;color:'+stCol+'">'+j.status+'</div>';
      h += '</div>';
    });
    h += '</div>';
  }
  h += '</div>';

  // Tomorrow's jobs
  h += '<div style="background:var(--w);border-radius:10px;border:1px solid var(--b1);overflow:hidden">';
  h += '<div style="padding:12px 16px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between">';
  h += '<div style="font-weight:700;font-size:13.5px">Tomorrow — '+fmtDateLong(addDays(now,1))+'</div>';
  h += '<span style="font-size:11px;color:var(--t3)">'+tmrJobs.length+' jobs</span></div>';
  if (!tmrJobs.length) {
    h += '<div style="padding:24px;text-align:center;color:var(--t3);font-size:12.5px">No jobs scheduled tomorrow</div>';
  } else {
    h += '<div style="overflow:auto;max-height:240px">';
    tmrJobs.forEach(function(j){
      var stCol = {'Pending':'var(--amber)','Confirmed':'var(--blue)','In Progress':'var(--purple)','Completed':'var(--green)','Billed':'var(--green)','Cancelled':'var(--red)'}[j.status]||'var(--t4)';
      h += '<div style="padding:9px 16px;border-bottom:1px solid var(--s2);display:flex;align-items:center;gap:10px;cursor:pointer" onclick="viewJob(\''+j.id+'\');showMod(\'calendar\',el(\'nb-calendar\'))">';
      h += bbadge(j.brand,'sm');
      h += '<div style="flex:1;min-width:0"><div style="font-weight:600;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(j.client)+'</div>';
      h += '<div style="font-size:11px;color:var(--t3)">'+esc(j.origin||'')+(j.dest?' → '+esc(j.dest):'')+'</div></div>';
      h += '<div style="font-size:11px;font-weight:700;color:'+stCol+'">'+j.status+'</div>';
      h += '</div>';
    });
    h += '</div>';
  }
  h += '</div>';

  h += '</div>'; // two col

  // ── BOTTOM ROW ─────────────────────────────────────────────────────
  h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px">';

  // Actions needed — persistent alerts
  h += '<div style="background:var(--w);border-radius:10px;border:1px solid var(--b1);overflow:hidden">';
  h += '<div style="padding:12px 16px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between">';
  h += '<div style="font-weight:700;font-size:13.5px">Needs Attention</div>';
  h += '<button onclick="dismissedAlerts={};saveData(\'settings\');renderDashboard()" style="font-size:10.5px;color:var(--t3);background:none;border:none;cursor:pointer;padding:2px 6px">Reset all</button>';
  h += '</div>';
  h += '<div style="padding:6px 0" id="alerts-body">';
  var allAlerts = [];
  if (unbilled.length)    allAlerts.push({id:'unbilled',   col:'var(--amber)', icon:'£', text:unbilled.length+' job'+(unbilled.length>1?'s':'')+' completed but not billed', mod:'finance'});
  if (unconfirmed.length) allAlerts.push({id:'unconfirmed',col:'var(--blue)',  icon:'?', text:unconfirmed.length+' upcoming job'+(unconfirmed.length>1?'s':'')+' unconfirmed', mod:'calendar'});
  if (needCrew.length)    allAlerts.push({id:'needcrew',   col:'var(--red)',   icon:'!', text:needCrew.length+' job'+(needCrew.length>1?'s':'')+' this week with no crew', mod:'crew'});
  // Today/tomorrow surveys
  var todaySurveys = SURVEYS.filter(function(s){ return s.surveyDate === todayStr; });
  var tmrSurveys   = SURVEYS.filter(function(s){ return s.surveyDate === tmrStr; });
  if (todaySurveys.length) allAlerts.push({id:'survey-today', col:'var(--amber)', icon:'🔍', text:todaySurveys.length+' survey'+(todaySurveys.length>1?'s':'')+' today', mod:'calendar'});
  if (tmrSurveys.length)   allAlerts.push({id:'survey-tmr',   col:'var(--t3)',    icon:'🔍', text:tmrSurveys.length+' survey'+(tmrSurveys.length>1?'s':'')+' tomorrow', mod:'calendar'});

  var visibleAlerts = allAlerts.filter(function(a){ return !dismissedAlerts[a.id]; });
  if (!visibleAlerts.length) {
    h += '<div style="padding:14px 16px;text-align:center;color:var(--green);font-size:12.5px;font-weight:600">✓ Everything looks good</div>';
  } else {
    visibleAlerts.forEach(function(a){
      h += '<div style="padding:8px 14px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--s2)">';
      h += '<div style="width:22px;height:22px;border-radius:50%;background:'+a.col+';color:#fff;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0">'+a.icon+'</div>';
      h += '<div style="font-size:12.5px;color:var(--t1);flex:1;cursor:'+(a.mod?'pointer':'default')+'" '+(a.mod?'onclick="showMod(\''+a.mod+'\',el(\'nb-'+a.mod+'\'))"':'')+'>'+a.text+'</div>';
      h += '<button onclick="dismissAlert(\''+a.id+'\',this)" style="font-size:10px;color:var(--t3);background:var(--s1);border:1px solid var(--b1);border-radius:4px;padding:3px 8px;cursor:pointer;white-space:nowrap">✓ Done</button>';
      h += '</div>';
    });
  }
  h += '</div></div>';

  // Crew utilisation this week
  h += '<div style="background:var(--w);border-radius:10px;border:1px solid var(--b1);overflow:hidden">';
  h += '<div style="padding:12px 16px;border-bottom:1px solid var(--b1)"><div style="font-weight:700;font-size:13.5px">Crew This Week</div></div>';
  h += '<div style="padding:10px 0">';
  CREW.forEach(function(c){
    var days = crewUtil[c.name] || 0;
    var pct = Math.round(days/5*100);
    var col = pct>=80?'var(--green)':pct>=40?'var(--blue)':'var(--t4)';
    h += '<div style="padding:5px 16px;display:flex;align-items:center;gap:10px">';
    h += crewAvatar(c,22);
    h += '<div style="font-size:12.5px;font-weight:600;width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+c.name+'</div>';
    h += '<div style="flex:1;background:var(--s2);border-radius:4px;height:6px"><div style="width:'+pct+'%;background:'+col+';height:6px;border-radius:4px"></div></div>';
    h += '<div style="font-size:11px;color:var(--t3);width:30px;text-align:right">'+days+'/5</div>';
    h += '</div>';
  });
  h += '</div></div>';

  // Month revenue by brand
  h += '<div style="background:var(--w);border-radius:10px;border:1px solid var(--b1);overflow:hidden">';
  h += '<div style="padding:12px 16px;border-bottom:1px solid var(--b1)"><div style="font-weight:700;font-size:13.5px">Month Revenue by Brand</div></div>';
  h += '<div style="padding:10px 16px">';
  var byBrand = {};
  monthJobs.forEach(function(j){ byBrand[j.brand] = (byBrand[j.brand]||0) + totalRev(j); });
  var maxB = Math.max.apply(null, Object.values(byBrand).concat([1]));
  Object.keys(byBrand).sort(function(a,b){ return byBrand[b]-byBrand[a]; }).slice(0,6).forEach(function(b){
    var v = byBrand[b];
    h += '<div style="margin-bottom:8px">';
    h += '<div style="display:flex;justify-content:space-between;font-size:11.5px;margin-bottom:3px">';
    h += '<span>'+bbadge(b,'sm')+'</span><span style="font-weight:700">'+fmt(v)+'</span></div>';
    h += '<div style="background:var(--s2);border-radius:4px;height:5px"><div style="width:'+Math.round(v/maxB*100)+'%;background:'+(BC[b]||'#aaa')+';height:5px;border-radius:4px"></div></div>';
    h += '</div>';
  });
  h += '</div></div>';

  h += '</div>'; // bottom row
  h += '</div>'; // max-width wrapper

  el('dashboard-body').innerHTML = h;
}

function dismissAlert(id, btn) {
  dismissedAlerts[id] = true;
  // Save to APP_SETTINGS so it persists
  APP_SETTINGS.dismissedAlerts = dismissedAlerts;
  saveData('settings');
  // Remove from UI immediately
  var row = btn.closest ? btn.closest('[style*="border-bottom"]') : btn.parentNode;
  if (row) row.style.display = 'none';
  // Refresh alert count
  var body = el('alerts-body');
  if (body) {
    var visible = body.querySelectorAll('[style*="display: none"]');
    if (body.querySelectorAll('button[onclick*="dismissAlert"]').length === visible.length) {
      body.innerHTML = '<div style="padding:14px 16px;text-align:center;color:var(--green);font-size:12.5px;font-weight:600">✓ Everything looks good</div>';
    }
  }
}

function fmtDateLong(d) {
  var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  return days[d.getDay()] + ' ' + d.getDate() + ' ' + months[d.getMonth()];
}

// ── CREW VIEW ─────────────────────────────────────────────────────────
function renderCrew(){
  el('cn-lbl').textContent = calNavLabel(curView);
  var ws=weekMon(curDate);
  var cols=[];
  for(var i=0;i<7;i++) cols.push(addDays(ws,i));
  var h='<table class="crew-table fade-in"><thead><tr><th style="width:155px">Crew</th>';
  for(var ci=0;ci<cols.length;ci++) h+='<th>'+DS[cols[ci].getDay()]+' '+cols[ci].getDate()+'</th>';
  h+='</tr></thead><tbody>';
  for(var ci2=0;ci2<CREW.length;ci2++){
    var c=CREW[ci2];
    var worked=0;
    for(var i=0;i<cols.length;i++){
      var ds=d2s(cols[i]);
      var hol=(HOL[c.name]||[]).indexOf(ds)>=0;
      if(!hol && jobs.some(function(j){ return j.drivers.concat(j.porters).indexOf(c.name)>=0 && jobDates(j).indexOf(ds)>=0; })) worked++;
    }
    var util=Math.round(worked/7*100);
    var ucol=util>80?'var(--red)':util>50?'var(--amber)':'var(--blue)';
    h+='<tr>';
    h+='<td class="crew-nm-td"><div style="display:flex;align-items:center;gap:8px">';
    h+=crewAvatar(c,28);
    h+='<div><div style="font-weight:600;font-size:13px">'+c.name+'</div>';
    h+='<div style="font-size:10px;color:var(--t3)">'+c.role+'</div>';
    // rate hidden from main scheduler view
    h+='<div class="ubar"><div class="ufill" style="width:'+util+'%;background:'+ucol+'"></div></div>';
    h+='</div></div></td>';
    for(var ci3=0;ci3<cols.length;ci3++){
      var ds=d2s(cols[ci3]);
      var isHol=(HOL[c.name]||[]).indexOf(ds)>=0;
      var cname=c.name;
      var dayJ=jobs.filter(function(j){ return j.drivers.concat(j.porters).indexOf(cname)>=0 && jobDates(j).indexOf(ds)>=0; });
      h+='<td class="crew-day-td">';
      if(isHol){ h+='<div class="c-hol">&#127958; Holiday</div>'; }
      else if(dayJ.length){
        for(var ji=0;ji<dayJ.length;ji++){
          var stDot={'Pending':'#FF9F00','Confirmed':'#0073EA','In Progress':'#A25DDC','Completed':'#00C875','Billed':'#00C875','Cancelled':'#E44258'}[dayJ[ji].status]||'#ccc';
          h+='<div class="cassign" style="background:'+BBLT[dayJ[ji].brand]+';color:'+BTXT[dayJ[ji].brand]+'" onclick="viewJob(\''+dayJ[ji].id+'\')" oncontextmenu="quickStatusMenu(event,\''+dayJ[ji].id+'\')" title="'+esc(dayJ[ji].client)+'"><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:'+stDot+';margin-right:4px;flex-shrink:0"></span>'+esc(dayJ[ji].client.length>14?dayJ[ji].client.substr(0,13)+'&hellip;':dayJ[ji].client)+'</div>';
        }
      } else { h+='<span class="c-off">&mdash;</span>'; }
      h+='</td>';
    }
    h+='</tr>';
  }
  h+='</tbody></table>';
  // Crew summary cards
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:14px 18px;background:var(--bg)">';
  h+='<div class="fc"><div class="fc-head"><div class="fc-title">Crew Summary</div></div><div class="fc-body">';
  for(var ci2=0;ci2<CREW.length;ci2++){
    var c=CREW[ci2];
    var assigned=jobs.filter(function(jj){ return jj.drivers.concat(jj.porters).indexOf(c.name)>=0; });
    h+='<div class="fin-row"><div class="fin-lbl" style="display:flex;align-items:center;gap:7px"><div class="crew-av" style="background:'+c.col+';width:20px;height:20px;font-size:9px">'+c.name[0]+'</div><span>'+c.name+'</span><span style="font-size:10px;color:var(--t3)">'+c.role+'</span></div>';
    h+='<div class="fin-val">'+assigned.length+' job'+(assigned.length!==1?'s':'')+'</div></div>';
  }
  h+='</div></div>';
  h+='<div class="fc"><div class="fc-head"><div class="fc-title">Holiday Notes</div></div><div class="fc-body">';
  h+='<div style="background:var(--rlt);border:1px solid #FFCCD3;border-radius:var(--r);padding:9px 11px;margin-bottom:10px"><div style="font-weight:600;color:var(--red);font-size:12.5px">JOE &mdash; On Holiday</div><div style="font-size:11.5px;color:var(--t2);margin-top:2px">Thu 20 &ndash; Sat 22 Feb 2025</div></div>';
  h+='<div style="font-size:12px;color:var(--t3)">No other conflicts detected this week.</div>';
  h+='</div></div></div>';
  setH('crew-out',h);
}

// ── FINANCE VIEW ──────────────────────────────────────────────────────
var finPeriod = 'month';
var dismissedAlerts = {}; // persisted in APP_SETTINGS // 'week','month','year','all'

function finJobsInPeriod() {
  var now = new Date();
  var from, to;
  if (finPeriod === 'week') {
    from = d2s(weekMon(now));
    to   = d2s(addDays(weekMon(now), 6));
  } else if (finPeriod === 'month') {
    from = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-01';
    to   = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-31';
  } else if (finPeriod === 'year') {
    from = now.getFullYear() + '-01-01';
    to   = now.getFullYear() + '-12-31';
  } else {
    return jobs;
  }
  return jobs.filter(function(j){ return j.start >= from && j.start <= to; });
}

function renderFinance(){
  el('cn-lbl').textContent = calNavLabel(curView);
  var fJobs = finJobsInPeriod();

  var gross=0,billed=0,pending=0;
  for(var i=0;i<fJobs.length;i++){
    var t=totalRev(fJobs[i]);
    gross+=t;
    if(fJobs[i].status==='Billed') billed+=t; else pending+=t;
  }
  var avg=fJobs.length?gross/fJobs.length:0;
  var totalCrew=0,totalFuel=0,totalVeh=0,totalMat=0,totalOverhead=0;
  for(var i=0;i<fJobs.length;i++){
    totalCrew+=jobCrewCost(fJobs[i]);
    totalFuel+=jobFuelCost(fJobs[i]);
    totalVeh+=0; // calculated inline below
    totalMat+=jobMatCost(fJobs[i]);
    totalOverhead+=jobCOSOverhead(fJobs[i]);
    // vehicle cost
    var jv=fJobs[i].veh||[];
    var dur3=jobDur(fJobs[i]);
    for(var vi3=0;vi3<jv.length;vi3++){
      for(var vv3=0;vv3<VEHICLES.length;vv3++){
        if(VEHICLES[vv3].reg===jv[vi3]||VEHICLES[vv3].name===jv[vi3]){ totalVeh+=(VEHICLES[vv3].dayRate||0)*dur3; break; }
      }
    }
  }
  var totalCOS=totalCrew+totalFuel+totalVeh+totalMat+totalOverhead;
  var gMargin=gross-totalCOS;
  var mPct=gross>0?gMargin/gross*100:0;
  var mCol=mPct>=30?'var(--green)':mPct>=15?'var(--amber)':'var(--red)';

  var byBrand={};
  for(var i=0;i<fJobs.length;i++){
    var t=totalRev(fJobs[i]);
    byBrand[fJobs[i].brand]=(byBrand[fJobs[i].brand]||0)+t;
  }
  var maxB=0;
  for(var b in byBrand) if(byBrand[b]>maxB) maxB=byBrand[b];
  if(!maxB) maxB=1;

  // Period selector
  var periods = [['week','This Week'],['month','This Month'],['year','This Year'],['all','All Time']];
  var h = '<div style="display:flex;gap:6px;padding:14px 16px 0;flex-shrink:0">';
  for(var pi=0;pi<periods.length;pi++){
    var pv=periods[pi][0], pl=periods[pi][1];
    h += '<button class="vt'+(finPeriod===pv?' on':'')+'" onclick="finPeriod=\''+pv+'\';renderFinance()">'+pl+'</button>';
  }
  h += '</div>';
  h+='<div class="fin-stats fade-in">';
  h+='<div class="fstat c-b"><div class="fstat-l">Gross Revenue</div><div class="fstat-v">'+fmt(gross)+'</div><div class="fstat-s">'+(fJobs.length)+' jobs</div></div>';
  h+='<div class="fstat c-g"><div class="fstat-l">Invoiced</div><div class="fstat-v">'+fmt(billed)+'</div><div class="fstat-s">Status: Billed</div></div>';
  h+='<div class="fstat c-a"><div class="fstat-l">Pending</div><div class="fstat-v">'+fmt(pending)+'</div><div class="fstat-s">Not yet billed</div></div>';
  h+='<div class="fstat c-p"><div class="fstat-l">Avg Job Value</div><div class="fstat-v">'+fmt(avg)+'</div><div class="fstat-s">Per job</div></div>';
  h+='</div>';

  h+='<div class="fin-2col">';
  // Brand revenue
  h+='<div class="fc"><div class="fc-head"><div class="fc-title">Revenue by Brand</div></div><div class="fc-body">';
  var brands=Object.keys(byBrand).sort(function(a,b){return byBrand[b]-byBrand[a];});
  for(var bi=0;bi<brands.length;bi++){
    var b=brands[bi], v=byBrand[b];
    h+='<div class="brr">';
    h+='<div class="brr-nm">'+bbadge(b)+'</div>';
    h+='<div class="brr-bar"><div class="brr-fill" style="width:'+Math.round(v/maxB*100)+'%;background:'+BC[b]+'"></div></div>';
    h+='<div class="brr-val">'+fmt(v)+'</div>';
    h+='<div class="brr-pct">'+Math.round(v/gross*100)+'%</div>';
    h+='</div>';
  }
  h+='</div></div>';
  // Margin
  h+='<div class="fc"><div class="fc-head"><div class="fc-title">Gross Margin</div><span style="font-size:11px;color:var(--t3)">All COS categories included</span></div><div class="fc-body">';
  h+='<div style="display:flex;align-items:center;gap:18px;margin-bottom:14px">';
  h+='<div><div style="font-weight:700;font-size:36px;letter-spacing:-1px;color:'+mCol+'">'+mPct.toFixed(1)+'%</div><div style="font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);margin-top:3px">Gross Margin</div></div>';
  h+='<div style="flex:1;border-left:1px solid var(--b1);padding-left:18px">';
  h+='<div class="fin-row"><span class="fin-lbl">Revenue</span><span class="fin-val" style="color:var(--green)">'+spv(fmt(gross))+'</span></div>';
  h+='<div class="fin-row"><span class="fin-lbl">Crew (charge rates)</span><span class="fin-val" style="color:var(--red)">&minus;'+spv(fmt(totalCrew),'fin-crew')+'</span></div>';
  h+='<div class="fin-row"><span class="fin-lbl">Vehicles (day rates)</span><span class="fin-val" style="color:var(--red)">&minus;'+spv(fmt(totalVeh))+'</span></div>';
  h+='<div class="fin-row"><span class="fin-lbl">Fuel / Mileage (incl. return)</span><span class="fin-val" style="color:var(--red)">&minus;'+spv(fmt(totalFuel))+'</span></div>';
  h+='<div class="fin-row"><span class="fin-lbl">Materials</span><span class="fin-val" style="color:var(--red)">&minus;'+spv(fmt(totalMat))+'</span></div>';
  h+='<div class="fin-row"><span class="fin-lbl">General Overhead (COS)</span><span class="fin-val" style="color:var(--red)">&minus;'+spv(fmt(totalOverhead))+'</span></div>';
  h+='<div class="fin-row" style="font-weight:700;border-top:2px solid var(--t1);padding-top:7px;margin-top:3px"><span>Margin</span><span style="color:'+mCol+'">'+spv(fmt(gMargin),'fin-margin')+'</span></div>';
  h+='</div></div></div></div>';
  h+='</div>';

  // Job cost breakdown
  h+='<div class="fc" style="margin-bottom:12px"><div class="fc-head"><div class="fc-title">Job Cost Breakdown</div><span style="font-size:11px;color:var(--t3)">Full COS: crew + vehicles + fuel + materials + overhead</span></div>';
  h+='<div style="overflow-x:auto"><table class="ctable"><thead><tr>';
  var ths=['Client','Brand','Days','Crew','Vehicles','Fuel','Materials','Overhead','Total COS','Revenue','Margin','%'];
  for(var ti=0;ti<ths.length;ti++) h+='<th>'+ths[ti]+'</th>';
  h+='</tr></thead><tbody>';
  var totCrew2=0, totFuel2=0, totVeh2=0, totMat2=0, totOvhd2=0, totCOS2=0, totRev2=0;
  for(var i=0;i<jobs.length;i++){
    var j=jobs[i];
    var dur=jobDur(j);
    var cc=jobCrewCost(j);
    var fu=jobFuelCost(j);
    var vc=0; var jveh=j.veh||[];
    for(var vi4=0;vi4<jveh.length;vi4++){
      for(var vv4=0;vv4<VEHICLES.length;vv4++){
        if(VEHICLES[vv4].reg===jveh[vi4]||VEHICLES[vv4].name===jveh[vi4]){ vc+=(VEHICLES[vv4].dayRate||0)*dur; break; }
      }
    }
    var mc2=jobMatCost(j);
    var oh=jobCOSOverhead(j);
    var cos=jobCOS(j);
    var rv=totalRev(j);
    var m=rv>0?(rv-cos)/rv*100:null;
    var mcl=m===null?'color:var(--t3)':m>=30?'color:var(--green)':m>=15?'color:var(--amber)':'color:var(--red)';
    var crew=j.drivers.concat(j.porters).filter(function(x){return x;});
    totCrew2+=cc; totFuel2+=fu; totVeh2+=vc; totMat2+=mc2; totOvhd2+=oh; totCOS2+=cos; totRev2+=rv;
    h+='<tr onclick="viewJob(\''+j.id+'\')">';
    h+='<td style="font-weight:600">'+esc(j.client)+'</td>';
    h+='<td>'+bbadge(j.brand)+'</td>';
    h+='<td style="font-weight:700">'+dur+'d</td>';
    h+='<td>';
    for(var k=0;k<crew.length;k++) h+=chip(crew[k]);
    if(!crew.length) h+='&mdash;';
    h+='</td>';
    h+='<td style="font-weight:600;color:var(--red)">'+spv(fmt(cc),'ft-cc-'+j.id)+'</td>';
    h+='<td style="color:var(--red)">'+(vc>0?spv(fmt(vc)):'&mdash;')+'</td>';
    h+='<td>'+spv(fmt(fu),'ft-fu-'+j.id)+'</td>';
    h+='<td>'+(mc2>0?spv(fmt(mc2)):'&mdash;')+'</td>';
    h+='<td>'+spv(fmt(oh))+'</td>';
    h+='<td style="font-weight:700;color:var(--red)">'+spv(fmt(cos),'ft-cos-'+j.id)+'</td>';
    h+='<td style="font-weight:600;color:var(--blue)">'+(rv>0?fmt(rv):'TBC')+'</td>';
    h+='<td style="font-weight:700;'+mcl+'">'+(m!==null?spv(fmt(rv-cos),'ft-mg-'+j.id):'&mdash;')+'</td>';
    h+='<td style="font-weight:700;'+mcl+'">'+(m!==null?m.toFixed(1)+'%':'&mdash;')+'</td>';
    h+='</tr>';
  }
  h+='</tbody><tfoot><tr>';
  h+='<td colspan="4">TOTALS</td>';
  h+='<td style="color:var(--red)">'+spv(fmt(totCrew2))+'</td>';
  h+='<td style="color:var(--red)">'+(totVeh2>0?spv(fmt(totVeh2)):'&mdash;')+'</td>';
  h+='<td>'+spv(fmt(totFuel2))+'</td>';
  h+='<td>'+(totMat2>0?spv(fmt(totMat2)):'&mdash;')+'</td>';
  h+='<td>'+spv(fmt(totOvhd2))+'</td>';
  h+='<td style="color:var(--red);font-weight:700">'+spv(fmt(totCOS2))+'</td>';
  h+='<td style="color:var(--blue)">'+spv(fmt(totRev2))+'</td>';
  var tm=totRev2>0?(totRev2-totCOS2)/totRev2*100:0;
  var tmc=tm>=30?'color:var(--green)':tm>=15?'color:var(--amber)':'color:var(--red)';
  h+='<td style="'+tmc+'">'+spv(fmt(totRev2-totCOS2))+'</td><td style="'+tmc+'">'+spv(tm.toFixed(1)+'%')+'</td>';
  h+='</tr></tfoot></table></div></div>';

  // Invoice tracker
  h+='<div class="fc"><div class="fc-head"><div class="fc-title">Invoice Tracker</div><span style="font-size:11px;color:var(--t3)">'+jobs.length+' jobs</span></div>';
  h+='<div style="overflow-x:auto"><table class="ctable"><thead><tr><th>Client</th><th>Ref</th><th>Brand</th><th>Start</th><th>Revenue</th><th>Status</th></tr></thead><tbody>';
  for(var i=0;i<jobs.length;i++){
    var j=jobs[i], t=totalRev(j);
    h+='<tr onclick="viewJob(\''+j.id+'\')">';
    h+='<td style="font-weight:600">'+esc(j.client)+'</td>';
    h+='<td style="font-size:10px;color:var(--t3)">'+esc(j.ref)+'</td>';
    h+='<td>'+bbadge(j.brand)+'</td>';
    h+='<td style="font-size:11.5px;color:var(--t2)">'+j.start+'</td>';
    h+='<td style="font-weight:600;color:var(--blue)">'+(t>0?fmt(t):'TBC')+'</td>';
    h+='<td>'+sbadge(j.status)+'</td>';
    h+='</tr>';
  }
  h+='</tbody></table></div></div>';
  setH('fin-out',h);
}

// ── SETTINGS MODULE ───────────────────────────────────────────────────
var curStab = 'crew';

function setStab(tab, btn) {
  curStab = tab;
  document.querySelectorAll('.stab').forEach(function(t) { t.classList.remove('on'); });
  btn.classList.add('on');
  renderSettings();
}

function renderSettings() {
  if (curStab === 'crew')           renderSettingsCrew();
  else if (curStab === 'vehicles')  renderSettingsVehicles();
  else if (curStab === 'materials') renderSettingsMaterials();
  else if (curStab === 'charges')   renderSettingsCharges();
  else if (curStab === 'brands')    renderSettingsBrands();
  else if (curStab === 'mm')        renderSettingsMM();
  else if (curStab === 'comms')     renderSettingsComms();
  else if (curStab === 'costing')   renderSettingsCosting();
}

function renderSettingsCrew() {
  var h = '<div style="max-width:1100px">';
  h += '<div class="settings-card">';
  h += '<div class="sc-head"><div>';
  h += '<div class="sc-title">Crew Rates &amp; Employment Costs</div>';
  h += '<div class="sc-sub">Charge Rate = day rate billed/charged per person (used in job COS + margin). Basic Rate + oncosts = Notional Rate (true cost for Finance accounting only). Margin = profit per crew member per day.</div>';
  h += '</div><button class="btn btn-p btn-sm" onclick="saveCrewRates()">Save All</button></div>';
  h += '<div style="overflow-x:auto"><table class="sc-table"><thead><tr>';
  h += '<th>Name</th><th>Type</th><th>Charge Rate</th><th>Basic Pay</th><th>NI %</th><th>Pension %</th><th>Holiday %</th><th>Notional Rate</th><th>Crew Margin</th><th>Jobs</th>';
  h += '</tr></thead><tbody>';
  for (var i = 0; i < CREW.length; i++) {
    var c = CREW[i];
    var cname = c.name;
    var jc = jobs.filter(function(j) { return j.drivers.concat(j.porters).indexOf(cname) >= 0; }).length;
    var notional = crewNotionalRate(c);
    var charge = c.chargeRate || c.rate;
    var marginPct = charge > 0 ? (charge - notional) / charge * 100 : 0;
    var mCol = marginPct >= 30 ? 'var(--green)' : marginPct >= 15 ? 'var(--amber)' : 'var(--red)';
    var emp = c.employed;
    h += '<tr>';
    // Name
    h += '<td><div style="display:flex;align-items:center;gap:7px"><div class="crew-av" style="background:' + c.col + ';width:22px;height:22px;font-size:9px">' + c.name[0] + '</div><strong>' + c.name + '</strong></div></td>';
    // Employment type
    h += '<td><div style="display:flex;gap:4px">';
    h += '<button class="btn btn-sm ' + (emp ? 'btn-p' : 'btn-s') + '" style="font-size:10px;padding:3px 7px" onclick="setEmpType(' + i + ',true)">Employed</button>';
    h += '<button class="btn btn-sm ' + (!emp ? 'btn-p' : 'btn-s') + '" style="font-size:10px;padding:3px 7px" onclick="setEmpType(' + i + ',false)">Self-Emp</button>';
    h += '</div></td>';
    // Charge rate (revenue per person per day)
    h += '<td style="background:rgba(0,115,234,.04)"><div style="display:flex;align-items:center;gap:4px"><span style="color:var(--t3)">&pound;</span>';
    h += '<input type="number" id="ccr' + i + '" class="sc-input narrow" value="' + charge + '" min="0" step="5" oninput="updateCrewRow(' + i + ')"></div></td>';
    // Basic pay rate
    h += '<td><div style="display:flex;align-items:center;gap:4px"><span style="color:var(--t3)">&pound;</span>';
    h += '<input type="number" id="crt' + i + '" class="sc-input narrow" value="' + c.rate + '" min="0" step="5" oninput="updateCrewRow(' + i + ')"></div></td>';
    // NI %
    h += '<td>' + (emp ? '<div style="display:flex;align-items:center;gap:3px"><input type="number" id="cni' + i + '" class="sc-input narrow" value="' + (c.ni||13.8) + '" min="0" max="30" step="0.1" oninput="updateCrewRow(' + i + ')"><span style="color:var(--t3);font-size:11px">%</span></div>' : '<span style="color:var(--t3)">—</span>') + '</td>';
    // Pension %
    h += '<td>' + (emp ? '<div style="display:flex;align-items:center;gap:3px"><input type="number" id="cpen' + i + '" class="sc-input narrow" value="' + (c.pension||3) + '" min="0" max="20" step="0.1" oninput="updateCrewRow(' + i + ')"><span style="color:var(--t3);font-size:11px">%</span></div>' : '<span style="color:var(--t3)">—</span>') + '</td>';
    // Holiday %
    h += '<td>' + (emp ? '<div style="display:flex;align-items:center;gap:3px"><input type="number" id="chol' + i + '" class="sc-input narrow" value="' + (c.holiday||12.07) + '" min="0" max="30" step="0.01" oninput="updateCrewRow(' + i + ')"><span style="color:var(--t3);font-size:11px">%</span></div>' : '<span style="color:var(--t3)">—</span>') + '</td>';
    // Notional rate (true cost)
    h += '<td id="cnotional' + i + '" style="font-weight:700;color:var(--t2)">' + spv('&pound;' + notional.toFixed(2) + '/day') + '</td>';
    // Crew margin %
    h += '<td id="cmargin' + i + '" style="font-weight:700;color:' + mCol + '">' + spv(marginPct.toFixed(1) + '%') + '</td>';
    // Jobs
    h += '<td style="color:var(--t2)">' + jc + ' job' + (jc!==1?'s':'') + '</td>';
    h += '</tr>';
  }
  h += '</tbody></table></div>';

  // Per-crew breakdown cards showing notional cost components
  h += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;padding:14px 16px;background:var(--bg);border-top:1px solid var(--b1)">';
  for (var i = 0; i < CREW.length; i++) {
    var c = CREW[i];
    var bd = crewNotionalBreakdown(c, 1);
    var charge = c.chargeRate || c.rate;
    var notional = crewNotionalRate(c);
    var mPct = charge > 0 ? (charge - notional) / charge * 100 : 0;
    var mCol2 = mPct >= 30 ? 'var(--green)' : mPct >= 15 ? 'var(--amber)' : 'var(--red)';
    h += '<div class="settings-card" style="margin:0"><div style="padding:8px 12px;border-bottom:1px solid var(--b1);display:flex;align-items:center;gap:6px">';
    h += '<div class="crew-av" style="background:' + c.col + ';width:18px;height:18px;font-size:8px">' + c.name[0] + '</div>';
    h += '<strong style="font-size:12px">' + c.name + '</strong>';
    if (!c.employed) h += '<span style="font-size:9px;color:var(--t3);margin-left:auto;font-weight:700">SELF-EMP</span>';
    h += '</div><div style="padding:8px 12px;font-size:11.5px">';
    h += '<div class="cb-row" style="font-size:11px"><span style="color:var(--t3)">Charge Rate</span><span style="color:var(--blue);font-weight:700">' + spv('&pound;' + charge.toFixed(2)) + '</span></div>';
    h += '<div class="cb-row" style="font-size:11px"><span style="color:var(--t3)">Basic Pay</span><span>&pound;' + c.rate.toFixed(2) + '</span></div>';
    if (c.employed) {
      h += '<div class="cb-row" style="font-size:11px"><span style="color:var(--t3)">Holiday (' + (c.holiday||0) + '%)</span><span>' + spv('+&pound;'+bd.holAmt.toFixed(2)) + '</span></div>';
      h += '<div class="cb-row" style="font-size:11px"><span style="color:var(--t3)">NI (' + (c.ni||0) + '%)</span><span>' + spv('+&pound;'+bd.niAmt.toFixed(2)) + '</span></div>';
      h += '<div class="cb-row" style="font-size:11px"><span style="color:var(--t3)">Pension (' + (c.pension||0) + '%)</span><span>' + spv('+&pound;'+bd.penAmt.toFixed(2)) + '</span></div>';
    }
    h += '<div class="cb-row" style="font-size:11px;border-top:1px solid var(--b1);margin-top:4px;padding-top:6px"><span style="color:var(--t3)">Notional</span><span>' + spv('&pound;'+bd.total.toFixed(2)) + '</span></div>';
    h += '<div class="cb-total" style="font-size:12px;color:' + mCol2 + '"><span>Crew Margin</span><span>' + spv(mPct.toFixed(1)+'%') + '</span></div>';
    h += '</div></div>';
  }
  h += '</div>';
  // ── Crew Photos ───────────────────────────────────────────────────
  h += '<div class="settings-card" style="margin-top:14px"><div class="sc-head"><div>';
  h += '<div class="sc-title">Crew Photos</div>';
  h += '<div class="sc-sub">Upload a photo for each crew member. Used as their icon across the app. Click a photo or the upload area to change.</div>';
  h += '</div></div>';
  h += '<div style="display:flex;flex-wrap:wrap;gap:14px;padding:14px 16px">';
  for (var i = 0; i < CREW.length; i++) {
    var c = CREW[i];
    h += '<div style="text-align:center;width:90px">';
    h += '<label style="cursor:pointer;display:block" title="Click to upload photo">';
    h += '<input type="file" accept="image/*" style="display:none" onchange="uploadCrewPhoto('+i+',this)">';
    if (c.photo) {
      h += '<img src="'+c.photo+'" style="width:64px;height:64px;border-radius:50%;object-fit:cover;border:3px solid '+c.col+';display:block;margin:0 auto 5px">';
    } else {
      h += '<div style="width:64px;height:64px;border-radius:50%;background:'+c.col+';display:flex;align-items:center;justify-content:center;color:#fff;font-size:22px;font-weight:700;margin:0 auto 5px;border:3px dashed rgba(255,255,255,.5)">';
      h += c.name[0]+'</div>';
    }
    h += '</label>';
    h += '<div style="font-size:11px;font-weight:600;color:var(--t2)">'+c.name+'</div>';
    if(c.photo) h += '<button class="btn btn-del btn-sm" style="margin-top:4px;font-size:9px;padding:2px 6px" onclick="removeCrewPhoto('+i+')">Remove</button>';
    h += '</div>';
  }
  h += '</div></div>';
  h += '</div>';
  setH('settings-body', h);
}

function uploadCrewPhoto(idx, input) {
  if (!input.files || !input.files[0]) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    CREW[idx].photo = e.target.result;
    toast(CREW[idx].name + ' photo updated');
    renderSettingsCrew();
  };
  reader.readAsDataURL(input.files[0]);
}
function removeCrewPhoto(idx) {
  CREW[idx].photo = '';
  renderSettingsCrew();
}

function updateCrewRow(i) {
  var charge = parseFloat((el('ccr'+i)||{}).value) || (CREW[i].chargeRate||CREW[i].rate);
  var rate = parseFloat((el('crt'+i)||{}).value) || CREW[i].rate;
  var ni   = parseFloat((el('cni'+i)||{}).value) || 0;
  var pen  = parseFloat((el('cpen'+i)||{}).value) || 0;
  var hol  = parseFloat((el('chol'+i)||{}).value) || 0;
  var emp  = CREW[i].employed;
  var notional = emp ? rate*(1+hol/100)*(1+ni/100)*(1+pen/100) : rate;
  var mPct = charge > 0 ? (charge - notional) / charge * 100 : 0;
  var mCol = mPct >= 30 ? 'var(--green)' : mPct >= 15 ? 'var(--amber)' : 'var(--red)';
  var nEl = el('cnotional'+i);
  if (nEl) { var sv = nEl.querySelector('.spv'); if(sv) sv.innerHTML = '&pound;'+notional.toFixed(2)+'/day'; }
  var mEl = el('cmargin'+i);
  if (mEl) { var sv = mEl.querySelector('.spv'); if(sv) sv.innerHTML = mPct.toFixed(1)+'%'; mEl.style.color = mCol; }
}

function setEmpType(i, emp) {
  CREW[i].employed = emp;
  if (!emp) { CREW[i].ni=0; CREW[i].pension=0; CREW[i].holiday=0; }
  else { if(!CREW[i].ni) CREW[i].ni=13.8; if(!CREW[i].pension) CREW[i].pension=3; if(!CREW[i].holiday) CREW[i].holiday=12.07; }
  saveCrewRates();
  renderSettingsCrew();
}

function saveCrewRates() {
  for (var i = 0; i < CREW.length; i++) {
    var rc=el('ccr'+i); if(rc) {var v=parseFloat(rc.value); if(!isNaN(v)) CREW[i].chargeRate=v;}
    var rt=el('crt'+i); if(rt) {var v=parseFloat(rt.value); if(!isNaN(v)) CREW[i].rate=v;}
    var rn=el('cni'+i); if(rn) {var v=parseFloat(rn.value); if(!isNaN(v)) CREW[i].ni=v;}
    var rp=el('cpen'+i);if(rp) {var v=parseFloat(rp.value); if(!isNaN(v)) CREW[i].pension=v;}
    var rh=el('chol'+i);if(rh) {var v=parseFloat(rh.value); if(!isNaN(v)) CREW[i].holiday=v;}
  }
  toast('Crew rates saved'); saveData('settings');
  if(curMod==='finance') renderFinance();
}


function renderSettingsVehicles() {
  var VTYPES = ['Luton','7.5T','3.5T','Long Wheel Base','Sprinter','Other'];
  var COLOURS = ['White','Silver','Grey','Black','Blue','Red','Yellow','Orange'];
  var h = '<div>';
  h += '<div class="settings-card"><div class="sc-head"><div><div class="sc-title">Fleet Vehicles</div>';
  h += '<div class="sc-sub">Available for assignment on bookings</div></div></div>';
  if (VEHICLES.length) {
    h += '<table class="sc-table"><thead><tr><th>Name</th><th>Reg</th><th>Type</th><th>Colour</th>';
    h += '<th>Vol ft&sup3;</th><th>L&times;W&times;H (m)</th><th>£/mile</th><th>Day Rate</th><th></th></tr></thead><tbody>';
    for (var i = 0; i < VEHICLES.length; i++) {
      var v = VEHICLES[i];
      h += '<tr>';
      h += '<td><input class="sc-input mid" id="vn' + i + '" value="' + esc(v.name) + '"></td>';
      h += '<td><input class="sc-input mid" id="vr' + i + '" value="' + esc(v.reg) + '"></td>';
      h += '<td><select class="sc-input" style="width:110px" id="vt' + i + '">';
      for (var k = 0; k < VTYPES.length; k++) h += '<option' + (v.type === VTYPES[k] ? ' selected' : '') + '>' + VTYPES[k] + '</option>';
      h += '</select></td>';
      h += '<td><select class="sc-input" style="width:85px" id="vc' + i + '">';
      for (var k = 0; k < COLOURS.length; k++) h += '<option' + (v.colour === COLOURS[k] ? ' selected' : '') + '>' + COLOURS[k] + '</option>';
      h += '</select></td>';
      h += '<td><input class="sc-input narrow" type="number" id="vv' + i + '" value="' + v.volCapFt + '" min="0"></td>';
      h += '<td><div style="display:flex;gap:3px">';
      h += '<input class="sc-input" style="width:48px" type="number" id="vl' + i + '" value="' + v.length + '" step="0.1">';
      h += '<input class="sc-input" style="width:48px" type="number" id="vw' + i + '" value="' + v.width + '" step="0.1">';
      h += '<input class="sc-input" style="width:48px" type="number" id="vh' + i + '" value="' + v.height + '" step="0.1">';
      h += '</div></td>';
      h += '<td><input class="sc-input narrow" type="number" id="vm' + i + '" value="' + v.mileRate + '" step="0.01"></td>';
      h += '<td><div style="display:flex;align-items:center;gap:3px"><span style="color:var(--t3);font-size:12px">&pound;</span>';
      h += '<input class="sc-input narrow" type="number" id="vd' + i + '" value="' + v.dayRate + '" step="5"></div></td>';
      h += '<td><button class="btn btn-del btn-sm" onclick="delVehicle(\'" + v.id + "\')">&#10005;</button></td>';
      h += '</tr>';
    }
    h += '</tbody></table>';
    h += '<div style="padding:10px 16px;border-top:1px solid var(--b1);display:flex;justify-content:flex-end">';
    h += '<button class="btn btn-p btn-sm" onclick="saveVehicles()">Save Vehicles</button></div>';
  } else {
    h += '<div style="padding:30px;text-align:center;color:var(--t3)">No vehicles added yet.</div>';
  }
  h += '</div>';
  h += '<div class="settings-card"><div class="sc-head"><div class="sc-title">Add New Vehicle</div></div>';
  h += '<div class="sc-body"><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:10px">';
  h += '<div class="veh-field"><div class="veh-lbl">Name</div><input class="sc-input" id="nv-name" placeholder="e.g. Luton 3"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Registration</div><input class="sc-input" id="nv-reg" placeholder="AB12 CDE"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Type</div><select class="sc-input" id="nv-type">';
  for (var k = 0; k < VTYPES.length; k++) h += '<option>' + VTYPES[k] + '</option>';
  h += '</select></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Colour</div><select class="sc-input" id="nv-colour">';
  for (var k = 0; k < COLOURS.length; k++) h += '<option>' + COLOURS[k] + '</option>';
  h += '</select></div></div>';
  h += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:10px">';
  h += '<div class="veh-field"><div class="veh-lbl">Volume ft&sup3;</div><input class="sc-input" id="nv-vol" type="number" placeholder="850" min="0"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Length (m)</div><input class="sc-input" id="nv-len" type="number" step="0.1" placeholder="4.2"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Width (m)</div><input class="sc-input" id="nv-wid" type="number" step="0.1" placeholder="2.1"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Height (m)</div><input class="sc-input" id="nv-hei" type="number" step="0.1" placeholder="2.2"></div>';
  h += '</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;align-items:flex-end">';
  h += '<div class="veh-field"><div class="veh-lbl">Mileage (£/mile)</div><input class="sc-input" id="nv-mile" type="number" step="0.01" placeholder="0.35"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Day Rate (£)</div><input class="sc-input" id="nv-day" type="number" placeholder="120" step="5"></div>';
  h += '<div></div><button class="btn btn-p" onclick="addVehicle()">+ Add Vehicle</button>';
  h += '</div></div></div></div>';
  setH('settings-body', h);
}

function saveVehicles() {
  for (var i = 0; i < VEHICLES.length; i++) {
    VEHICLES[i].name     = el('vn'+i).value;
    VEHICLES[i].reg      = el('vr'+i).value;
    VEHICLES[i].type     = el('vt'+i).value;
    VEHICLES[i].colour   = el('vc'+i).value;
    VEHICLES[i].volCapFt = parseFloat(el('vv'+i).value) || 0;
    VEHICLES[i].length   = parseFloat(el('vl'+i).value) || 0;
    VEHICLES[i].width    = parseFloat(el('vw'+i).value) || 0;
    VEHICLES[i].height   = parseFloat(el('vh'+i).value) || 0;
    VEHICLES[i].mileRate = parseFloat(el('vm'+i).value) || 0;
    VEHICLES[i].dayRate  = parseFloat(el('vd'+i).value) || 0;
  }
  toast('Vehicles saved'); saveData('settings');
}

function addVehicle() {
  var name = (el('nv-name').value||'').trim();
  if (!name) { toast('Vehicle name required'); return; }
  VEHICLES.push({
    id:'V'+Date.now(), name:name,
    reg:el('nv-reg').value.trim().toUpperCase(),
    type:el('nv-type').value, colour:el('nv-colour').value,
    volCapFt:parseFloat(el('nv-vol').value)||0,
    length:parseFloat(el('nv-len').value)||0,
    width:parseFloat(el('nv-wid').value)||0,
    height:parseFloat(el('nv-hei').value)||0,
    mileRate:parseFloat(el('nv-mile').value)||0,
    dayRate:parseFloat(el('nv-day').value)||0,
  });
  toast('Vehicle added');
  renderSettingsVehicles();
}

function delVehicle(id) {
  if (!confirm('Remove this vehicle?')) return;
  VEHICLES = VEHICLES.filter(function(v) { return v.id !== id; });
  renderSettingsVehicles();
}

function renderSettingsMaterials() {
  var h = '<div style="max-width:600px">';
  h += '<div class="settings-card"><div class="sc-head"><div><div class="sc-title">Packing Materials</div>';
  h += '<div class="sc-sub">Unit costs, selectable per booking</div></div>';
  h += '<button class="btn btn-p btn-sm" onclick="saveMaterials()">Save</button></div>';
  h += '<table class="sc-table"><thead><tr><th>Name</th><th>Type</th><th>Unit Cost</th><th></th></tr></thead><tbody>';
  for (var i = 0; i < MATERIALS.length; i++) {
    var m = MATERIALS[i];
    h += '<tr>';
    h += '<td><input class="sc-input" id="mn'+i+'" value="'+esc(m.name)+'"></td>';
    h += '<td><input class="sc-input mid" id="mt'+i+'" value="'+esc(m.type)+'"></td>';
    h += '<td><div style="display:flex;align-items:center;gap:4px"><span style="color:var(--t3)">&pound;</span>';
    h += '<input class="sc-input narrow" type="number" id="mc'+i+'" value="'+m.unitCost+'" step="0.01" min="0"></div></td>';
    h += '<td><button class="btn btn-del btn-sm" onclick="delMaterial(\'"++m.id++"\')">&#10005;</button></td>';
    h += '</tr>';
  }
  h += '</tbody></table>';
  h += '<div class="add-row">';
  h += '<div class="veh-field"><div class="veh-lbl">Name</div><input class="sc-input" id="nm-name" placeholder="e.g. Bubble Wrap Roll" style="width:190px"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Type</div><input class="sc-input mid" id="nm-type" placeholder="e.g. Wrap"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Unit Cost</div><div style="display:flex;align-items:center;gap:4px"><span style="color:var(--t3)">&pound;</span><input class="sc-input narrow" type="number" id="nm-cost" step="0.01" placeholder="0.00"></div></div>';
  h += '<button class="btn btn-p btn-sm" onclick="addMaterial()" style="align-self:flex-end">+ Add</button>';
  h += '</div></div></div>';
  setH('settings-body', h);
}

function saveMaterials() {
  for (var i = 0; i < MATERIALS.length; i++) {
    var nn=el('mn'+i),nt=el('mt'+i),nc=el('mc'+i);
    if(nn) MATERIALS[i].name=nn.value;
    if(nt) MATERIALS[i].type=nt.value;
    if(nc) MATERIALS[i].unitCost=parseFloat(nc.value)||0;
  }
  toast('Materials saved'); saveData('settings');
}

function addMaterial() {
  var name=(el('nm-name').value||'').trim();
  if(!name){toast('Name required');return;}
  MATERIALS.push({id:'M'+Date.now(),name:name,type:el('nm-type').value.trim(),unitCost:parseFloat(el('nm-cost').value)||0});
  toast('Material added'); renderSettingsMaterials();
}

function delMaterial(id) {
  if(!confirm('Remove this material?'))return;
  MATERIALS=MATERIALS.filter(function(m){return m.id!==id;}); renderSettingsMaterials();
}

function renderSettingsCharges() {
  var h = '<div style="max-width:560px">';
  h += '<div class="settings-card"><div class="sc-head"><div><div class="sc-title">Charges &amp; Taxes</div>';
  h += '<div class="sc-sub">Added to booking costs when selected — can be applied multiple times</div></div>';
  h += '<button class="btn btn-p btn-sm" onclick="saveCharges()">Save</button></div>';
  h += '<table class="sc-table"><thead><tr><th>Charge Name</th><th>Default Amount</th><th></th></tr></thead><tbody>';
  for (var i = 0; i < CHARGES.length; i++) {
    var c = CHARGES[i];
    h += '<tr>';
    h += '<td><input class="sc-input" id="cgn'+i+'" value="'+esc(c.name)+'"></td>';
    h += '<td><div style="display:flex;align-items:center;gap:4px"><span style="color:var(--t3)">&pound;</span>';
    h += '<input class="sc-input narrow" type="number" id="cga'+i+'" value="'+c.defaultAmt+'" step="0.01" min="0"></div></td>';
    h += '<td><button class="btn btn-del btn-sm" onclick="delCharge(\'"++c.id++"\')">&#10005;</button></td>';
    h += '</tr>';
  }
  h += '</tbody></table>';
  h += '<div class="add-row">';
  h += '<div class="veh-field"><div class="veh-lbl">Name</div><input class="sc-input" id="nc-name" placeholder="e.g. Ferry Crossing" style="width:200px"></div>';
  h += '<div class="veh-field"><div class="veh-lbl">Default Amount</div><div style="display:flex;align-items:center;gap:4px"><span style="color:var(--t3)">&pound;</span><input class="sc-input narrow" type="number" id="nc-amt" step="0.01" placeholder="0.00"></div></div>';
  h += '<button class="btn btn-p btn-sm" onclick="addCharge()" style="align-self:flex-end">+ Add</button>';
  h += '</div></div></div>';
  setH('settings-body', h);
}

function saveCharges() {
  for (var i = 0; i < CHARGES.length; i++) {
    var nn=el('cgn'+i),na=el('cga'+i);
    if(nn) CHARGES[i].name=nn.value;
    if(na) CHARGES[i].defaultAmt=parseFloat(na.value)||0;
  }
  toast('Charges saved'); saveData('settings');
}

function addCharge() {
  var name=(el('nc-name').value||'').trim();
  if(!name){toast('Name required');return;}
  CHARGES.push({id:'C'+Date.now(),name:name,defaultAmt:parseFloat(el('nc-amt').value)||0});
  toast('Charge added'); renderSettingsCharges();
}

function delCharge(id) {
  if(!confirm('Remove this charge?'))return;
  CHARGES=CHARGES.filter(function(c){return c.id!==id;}); renderSettingsCharges();
}

function renderSettingsBrands() {
  var CHANNELS = ['Partner','Account','Domestic'];
  var h = '<div style="max-width:860px">';
  h += '<div class="settings-card"><div class="sc-head"><div><div class="sc-title">Brands</div>';
  h += '<div class="sc-sub">Upload a JPG or PNG logo for each brand. It will appear everywhere the brand is shown.</div></div>';
  h += '<button class="btn btn-p btn-sm" onclick="saveBrands()">Save changes</button></div>';
  h += '<table class="sc-table"><thead><tr><th style="width:80px">Logo</th><th>Brand Name</th><th style="width:110px">Colour</th><th style="width:120px">Channel</th><th>Default MM</th><th style="width:32px"></th></tr></thead><tbody>';
  for (var i = 0; i < BRAND_DATA.length; i++) {
    var b = BRAND_DATA[i];
    var mm = mmForBrand(b.name);
    h += '<tr>';
    // Logo cell: shows current logo or colour swatch, with upload button
    h += '<td style="text-align:center;padding:8px 6px">';
    h += '<div style="display:flex;flex-direction:column;align-items:center;gap:4px">';
    if (b.logo) {
      h += '<img id="blogo-prev-'+i+'" src="'+b.logo+'" alt="'+esc(b.name)+'" style="height:28px;width:auto;max-width:60px;object-fit:contain;border-radius:3px;border:1px solid var(--b1);background:#fff;padding:2px">';
    } else {
      h += '<div id="blogo-prev-'+i+'" style="width:44px;height:28px;border-radius:3px;background:'+b.col+';display:flex;align-items:center;justify-content:center;font-size:8.5px;font-weight:700;color:#fff;letter-spacing:.3px">'+esc(b.name.substring(0,4))+'</div>';
    }
    h += '<label style="font-size:9.5px;font-weight:600;color:var(--blue);cursor:pointer;padding:2px 5px;border:1px solid var(--blue);border-radius:3px;background:var(--blt);white-space:nowrap">Upload';
    h += '<input type="file" accept="image/png,image/jpeg,image/gif,image/svg+xml,image/webp" style="display:none" onchange="brandLogoUpload('+i+',this)">';
    h += '</label>';
    if (b.logo) h += '<span style="font-size:9px;color:var(--red);cursor:pointer;font-weight:600" onclick="brandLogoClear('+i+')">Remove</span>';
    h += '</div></td>';
    h += '<td><input class="sc-input" id="bn-'+i+'" value="'+esc(b.name)+'"></td>';
    h += '<td><div style="display:flex;align-items:center;gap:6px"><input type="color" id="bc-'+i+'" value="'+b.col+'" style="width:36px;height:28px;border:1px solid var(--b1);border-radius:4px;cursor:pointer;padding:2px"><span id="bch-'+i+'" style="font-size:11px;color:var(--t3)">'+b.col+'</span></div></td>';
    h += '<td><select class="sc-input" id="bch2-'+i+'">'+CHANNELS.map(function(c){return '<option'+(c===b.channel?' selected':'')+'>'+c+'</option>';}).join('')+'</select></td>';
    h += '<td style="font-size:11.5px;color:var(--t2)">'+(mm?esc(mm.name):'<span style="color:var(--t3)">None</span>')+'</td>';
    h += '<td><button class="btn btn-del btn-sm" onclick="delBrand('+i+')" title="Delete">&#10005;</button></td>';
    h += '</tr>';
  }
  h += '</tbody></table>';
  h += '<div class="add-row"><input class="sc-input mid" id="nb-name" placeholder="Brand name"><input type="color" id="nb-col" value="#0073EA" style="width:36px;height:30px;border:1px solid var(--b1);border-radius:4px;cursor:pointer;padding:2px"><select class="sc-input" id="nb-ch">'+CHANNELS.map(function(c){return '<option>'+c+'</option>';}).join('')+'</select>';
  h += '<button class="btn btn-p btn-sm" onclick="addBrand()">+ Add Brand</button></div>';
  h += '</div></div>';
  setH('settings-body', h);
}

function brandLogoUpload(idx, input) {
  var file = input.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    var dataUrl = e.target.result;
    BRAND_DATA[idx].logo = dataUrl;
    buildBrandMaps();
    // Update preview in brands table immediately
    var prev = document.getElementById('blogo-prev-'+idx);
    if (prev) {
      var img = document.createElement('img');
      img.id = 'blogo-prev-'+idx;
      img.src = dataUrl;
      img.alt = BRAND_DATA[idx].name;
      img.style.cssText = 'height:28px;width:auto;max-width:60px;object-fit:contain;border-radius:3px;border:1px solid var(--b1);background:#fff;padding:2px';
      prev.parentNode.replaceChild(img, prev);
    }
    // Re-render the current active view so logo appears everywhere immediately
    if (curMod === 'calendar') renderCal();
    toast(BRAND_DATA[idx].name + ' logo updated');
  };
  reader.readAsDataURL(file);
}

function brandLogoClear(idx) {
  BRAND_DATA[idx].logo = '';
  buildBrandMaps();
  renderSettingsBrands();
  if (curMod === 'calendar') renderCal();
  toast('Logo removed'); saveData('settings');
}

function saveBrands() {
  for (var i = 0; i < BRAND_DATA.length; i++) {
    var n=el('bn-'+i); if(n) BRAND_DATA[i].name=n.value.trim();
    var c=el('bc-'+i); if(c) BRAND_DATA[i].col=c.value;
    var ch=el('bch2-'+i); if(ch) BRAND_DATA[i].channel=ch.value;
    // logo is already stored live on upload — no input field to read
  }
  buildBrandMaps();
  toast('Brands saved'); saveData('settings');
  renderSettingsBrands();
}

function addBrand() {
  var name=(el('nb-name')||{}).value||''; name=name.trim();
  if(!name){toast('Enter a brand name');return;}
  var col=(el('nb-col')||{}).value||'#888888';
  var ch=(el('nb-ch')||{}).value||'Partner';
  BRAND_DATA.push({name:name,col:col,channel:ch,logo:''});
  buildBrandMaps();
  saveBrands();
  renderSettingsBrands();
  toast('Brand added');
}

function delBrand(i) {
  if(!confirm('Delete brand '+BRAND_DATA[i].name+'?')) return;
  BRAND_DATA.splice(i,1);
  buildBrandMaps();
  renderSettingsBrands();
}

function renderSettingsMM() {
  var h = '<div style="max-width:800px">';
  h += '<div class="settings-card"><div class="sc-head"><div><div class="sc-title">Move Managers</div>';
  h += '<div class="sc-sub">One Move Manager per brand. For Partner &amp; Account jobs, comms are sent to the Move Manager instead of the end client.</div></div>';
  h += '<button class="btn btn-p btn-sm" onclick="saveMMs()">Save</button></div>';
  h += '<table class="sc-table"><thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Brand</th><th></th></tr></thead><tbody>';
  for (var i = 0; i < MOVE_MANAGERS.length; i++) {
    var m = MOVE_MANAGERS[i];
    h += '<tr>';
    h += '<td><input class="sc-input mid" id="mmn-'+i+'" value="'+esc(m.name)+'"></td>';
    h += '<td><input class="sc-input mid" id="mmp-'+i+'" value="'+esc(m.phone)+'" placeholder="07700..."></td>';
    h += '<td><input class="sc-input mid" id="mme-'+i+'" value="'+esc(m.email)+'" placeholder="name@company.com"></td>';
    h += '<td><select class="sc-input" id="mmb-'+i+'">'+BRANDS.map(function(b){return '<option'+(b===m.brand?' selected':'')+'>'+b+'</option>';}).join('')+'</select></td>';
    h += '<td><button class="btn btn-del btn-sm" onclick="delMM('+i+')" title="Delete">&#10005;</button></td>';
    h += '</tr>';
  }
  h += '</tbody></table>';
  h += '<div class="add-row"><input class="sc-input mid" id="nmm-name" placeholder="Full name"><input class="sc-input mid" id="nmm-phone" placeholder="Phone"><input class="sc-input mid" id="nmm-email" placeholder="Email">';
  h += '<select class="sc-input" id="nmm-brand">'+BRANDS.map(function(b){return '<option>'+b+'</option>';}).join('')+'</select>';
  h += '<button class="btn btn-p btn-sm" onclick="addMM()">+ Add</button></div>';
  h += '</div></div>';
  setH('settings-body', h);
}

function saveMMs() {
  for (var i = 0; i < MOVE_MANAGERS.length; i++) {
    var n=el('mmn-'+i); if(n) MOVE_MANAGERS[i].name=n.value;
    var p=el('mmp-'+i); if(p) MOVE_MANAGERS[i].phone=p.value;
    var e=el('mme-'+i); if(e) MOVE_MANAGERS[i].email=e.value;
    var b=el('mmb-'+i); if(b) MOVE_MANAGERS[i].brand=b.value;
  }
  toast('Move Managers saved'); saveData('settings');
}

function addMM() {
  var name=(el('nmm-name')||{}).value||''; name=name.trim();
  if(!name){toast('Name required');return;}
  var id='MM'+String(Date.now()).slice(-5);
  MOVE_MANAGERS.push({id:id,name:name,phone:(el('nmm-phone')||{}).value||'',email:(el('nmm-email')||{}).value||'',brand:(el('nmm-brand')||{}).value||BRANDS[0]||''});
  renderSettingsMM();
}

function delMM(i) {
  if(!confirm('Delete '+MOVE_MANAGERS[i].name+'?')) return;
  MOVE_MANAGERS.splice(i,1);
  renderSettingsMM();
}

function renderSettingsComms() {
  var h = '<div style="max-width:580px">';
  h += '<div class="settings-card"><div class="sc-head"><div class="sc-title">Company &amp; Email Settings</div></div>';
  h += '<div class="sc-body"><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
  var fields=[['Company Name','sl-cname',SL_CONFIG.companyName],['Company Postcode','sl-postcode',SL_CONFIG.companyPostcode||'WN73EQ'],['From Email','sl-from',SL_CONFIG.fromEmail],
    ['From Name','sl-fname',SL_CONFIG.fromName],['Company Phone','sl-phone',SL_CONFIG.companyPhone],
    ['Reply-to Email','sl-reply',SL_CONFIG.companyEmail],['SocketLabs Server ID','sl-sid',SL_CONFIG.serverId]];
  for(var i=0;i<fields.length;i++){
    h+='<div class="veh-field"><div class="veh-lbl">'+fields[i][0]+'</div>';
    h+='<input class="sc-input" id="'+fields[i][1]+'" value="'+esc(fields[i][2])+'"></div>';
  }
  h+='</div>';
  h+='<div class="veh-field" style="margin-top:12px"><div class="veh-lbl">SocketLabs Injection API Key</div>';
  h+='<input class="sc-input" id="sl-key" value="'+esc(SL_CONFIG.apiKey)+'" placeholder="Paste injection API key" type="password"></div>';
  h+='<div style="display:flex;justify-content:flex-end;margin-top:14px"><button class="btn btn-p" onclick="saveCommsSettings()">Save Settings</button></div>';
  h+='</div></div>';
  // Data management section
  h+='<div class="settings-card" style="margin-top:16px"><div class="sc-head"><div class="sc-title">Data Management</div></div>';
  h+='<div class="sc-body">';
  h+='<div style="font-size:12.5px;color:var(--t2);margin-bottom:12px">All data is saved automatically to Azure and persists across all devices and users.</div>';
  h+='<div style="font-size:12.5px;font-weight:600;color:var(--t1);margin-bottom:8px">Legacy OPS Plan Import</div>';
  h+='<div style="font-size:12px;color:var(--t2);margin-bottom:10px">Import jobs from your weekly Excel OPS Plan spreadsheet. Export as CSV from Excel first, then upload here. Duplicate refs will be skipped.</div>';
  h+='<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:16px">';
  h+='<button class="btn btn-p btn-sm" onclick="importOPSPlan()">&#8593; Import OPS Plan CSV</button>';
  h+='<span id="csv-import-status" style="font-size:12px;color:var(--t2)"></span>';
  h+='</div>';
  h+='<div style="font-size:12.5px;font-weight:600;color:var(--t1);margin-bottom:8px">Backup &amp; Restore</div>';
  h+='<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">';
  h+='<button class="btn btn-s btn-sm" onclick="exportDataBackup()">&#8595; Export Backup (JSON)</button>';
  h+='<button class="btn btn-s btn-sm" onclick="importDataBackup()">&#8593; Import Backup (JSON)</button>';
  h+='<button class="btn btn-sm" style="background:#fff;border:1px solid var(--red);color:var(--red)" onclick="clearData()">&#9888; Reset All Data</button>';
  h+='</div>';
  h+='</div></div>';
  h+='</div>';
  setH('settings-body', h);
}

function saveCommsSettings() {
  SL_CONFIG.companyName=el('sl-cname').value; SL_CONFIG.companyPostcode=(el('sl-postcode')||{}).value||SL_CONFIG.companyPostcode; SL_CONFIG.fromEmail=el('sl-from').value;
  SL_CONFIG.fromName=el('sl-fname').value; SL_CONFIG.companyPhone=el('sl-phone').value;
  SL_CONFIG.companyEmail=el('sl-reply').value; SL_CONFIG.serverId=el('sl-sid').value;
  SL_CONFIG.apiKey=el('sl-key').value;
  toast('Settings saved'); saveData('settings');
}

function renderSettingsCosting() {
  var h = '<div style="max-width:700px">';

  // Google Maps API section
  h += '<div class="settings-card"><div class="sc-head"><div>';
  h += '<div class="sc-title">Google Maps &amp; Address Lookup</div>';
  h += '<div class="sc-sub">Enter your Google Maps Platform API key to enable address autocomplete, satellite imagery, and automatic distance/mileage calculation. The key needs Maps JavaScript API, Places API, Distance Matrix API, and Embed API enabled in Google Cloud Console.</div>';
  h += '</div></div><div class="sc-body">';
  h += '<div class="cos-grid">';
  h += '<div class="cos-field" style="grid-column:span 2"><div class="cos-lbl">Google Maps API Key</div>';
  h += '<input class="sc-input" id="cos-maps-key" type="password" value="'+esc(APP_SETTINGS.googleMapsKey)+'" placeholder="AIzaSy…">';
  h += '<div class="cos-desc">Required for address autocomplete, map views, and mileage calculation. Get your key at console.cloud.google.com</div></div>';
  h += '<div class="cos-field"><div class="cos-lbl">Warehouse / Depot Address</div>';
  h += '<input class="sc-input" id="cos-wh-addr" value="'+esc(APP_SETTINGS.warehouseAddress)+'" placeholder="Full address or postcode">';
  h += '<div class="cos-desc">Used as return journey end point for daily mileage calculations</div></div>';
  h += '<div class="cos-field"><div class="cos-lbl">Auto-add Return Leg</div>';
  h += '<select class="sc-input" id="cos-return-leg">';
  h += '<option value="1"'+(APP_SETTINGS.returnMileage?' selected':'')+'>Yes — add return to depot mileage</option>';
  h += '<option value="0"'+(!APP_SETTINGS.returnMileage?' selected':'')+'>No — point-to-point only</option>';
  h += '</select>';
  h += '<div class="cos-desc">Non-overnight jobs: crew returns to depot. Add return mileage to fuel cost.</div></div>';
  h += '</div>';

  // Maps API status
  h += '<div style="margin-top:12px;padding:10px 12px;border-radius:6px;border:1px solid var(--b1);background:var(--s1);font-size:12px;display:flex;align-items:center;gap:8px">';
  var mapsStatus = mapsApiLoaded();
  h += mapsStatus
    ? '<span style="color:var(--green);font-weight:700">✓ Google Maps API loaded</span><span style="color:var(--t3)">— Address lookup, mapping, and distance calculation are active</span>'
    : '<span style="color:var(--amber);font-weight:700">⚠ Google Maps not loaded</span><span style="color:var(--t3)">— Enter an API key and save to activate</span>';
  h += '</div>';
  h += '</div></div>';

  // COS per crew section
  h += '<div class="settings-card" style="margin-top:16px"><div class="sc-head"><div>';
  h += '<div class="sc-title">Cost of Sale — Generic Daily Overhead</div>';
  h += '<div class="sc-sub">A configurable overhead applied per crew member per working day. Covers general business costs not captured by specific line items (insurance, admin, overheads, etc.). Applied to each job day per crew member, or proportionally split across journey jobs.</div>';
  h += '</div></div><div class="sc-body">';
  h += '<div class="cos-grid">';
  h += '<div class="cos-field"><div class="cos-lbl">COS per Crew / per Day <span style="font-weight:400;color:var(--t4)">(£)</span></div>';
  h += '<input class="sc-input" id="cos-per-crew" type="number" min="0" step="1" value="'+APP_SETTINGS.cosPerCrewPerDay+'">';
  h += '<div class="cos-desc">Default: £125/crew/day. Appears as a separate line in cost breakdowns.</div></div>';
  h += '<div class="cos-field"><div class="cos-lbl">Fuel Price per Litre <span style="font-weight:400;color:var(--t4)">(£ — reference only)</span></div>';
  h += '<input class="sc-input" id="cos-fuel-price" type="number" min="0" step="0.01" value="'+APP_SETTINGS.fuelPricePerLitre+'">';
  h += '<div class="cos-desc">Used for display reference. Actual fuel cost uses vehicle mileage rates.</div></div>';
  h += '</div>';
  h += '<div style="margin-top:14px;padding:10px 12px;border-radius:6px;background:#EBF4FF;border:1px solid #C4D9F5;font-size:12px">';
  h += '<strong>How it applies:</strong> Single job = crew count × days × rate. Journey (multi-job day) = total crew on all jobs × days × rate, split proportionally. Multi-day jobs = rate applied per calendar day independently.';
  h += '</div>';
  h += '</div></div>';

  h += '<div style="display:flex;justify-content:flex-end;margin-top:14px"><button class="btn btn-p" onclick="saveCosting()">Save Settings</button></div>';
  h += '</div>';
  setH('settings-body', h);
}

function saveCosting() {
  APP_SETTINGS.googleMapsKey    = (el('cos-maps-key')||{}).value||'';
  APP_SETTINGS.warehouseAddress = (el('cos-wh-addr')||{}).value||APP_SETTINGS.warehouseAddress;
  APP_SETTINGS.returnMileage    = (el('cos-return-leg')||{}).value === '1';
  APP_SETTINGS.cosPerCrewPerDay = parseFloat((el('cos-per-crew')||{}).value)||125;
  APP_SETTINGS.fuelPricePerLitre= parseFloat((el('cos-fuel-price')||{}).value)||1.49;
  // Re-init maps if key changed
  if (APP_SETTINGS.googleMapsKey) loadGoogleMapsAPI();
  toast('Cost of Sale & Maps settings saved'); saveData('settings');
  renderSettings();
}

// ── RESOURCE COST HELPERS ─────────────────────────────────────────────
function bkVehicleCost(bk) {
  var dur=Math.max(1,Math.round((s2d(bk.endDate)-s2d(bk.startDate))/864e5)+1);
  return (bk.vehicles||[]).reduce(function(s,bv){
    var v=VEHICLES.filter(function(x){return x.id===bv.id;})[0];
    return s+(v?v.dayRate*dur:0);
  },0);
}

function bkMaterialCost(bk) {
  return (bk.materials||[]).reduce(function(s,bm){
    var m=MATERIALS.filter(function(x){return x.id===bm.id;})[0];
    return s+(m?m.unitCost*(bm.qty||0):0);
  },0);
}

function bkChargeCost(bk) {
  return (bk.charges||[]).reduce(function(s,bc){return s+(bc.amt||0);},0);
}

function bkCrewCost(bk) {
  var j=jobs.filter(function(x){return x.id===bk.id;})[0];
  return j?jobCrewCost(j):0;
}

function bkFuelCost(bk) {
  var j=jobs.filter(function(x){return x.id===bk.id;})[0];
  return j?(jobFuelCost(j)||0):0;
}

function bkTotalCOS(bk) {
  return bkCrewCost(bk)+bkFuelCost(bk)+bkVehicleCost(bk)+bkMaterialCost(bk)+bkChargeCost(bk);
}

function bkTotalRevenue(bk) {
  return (bk.billing||[]).reduce(function(s,x){return s+(x.amt||0);},0);
}

// renderRates kept as alias so showMod('rates') still works briefly — now routes to settings
function renderRates(){ renderSettings(); }

// ── DRAG AND DROP ─────────────────────────────────────────────────────
function dragStart(e,jid){
  dragId=jid;
  e.dataTransfer.effectAllowed='move';
  setTimeout(function(){e.target.style.opacity='.3';},0);
}
function dragEnd(e){
  dragId=null;
  e.target.style.opacity='1';
  document.querySelectorAll('[style*="outline"]').forEach(function(el){el.style.outline='';});
}
function doDrop(e,jid,newDs){
  e.preventDefault(); e.stopPropagation();
  e.currentTarget.style.outline='';
  var j=jobs.filter(function(x){return x.id===jid;})[0];
  if(!j) return;
  var dur=Math.round((s2d(j.end)-s2d(j.start))/864e5);
  j.start=newDs;
  j.end=d2s(addDays(s2d(newDs),dur));
  toast(j.client+' moved to '+newDs); saveData('job', j.id, j);
  renderCal();
}

// ── VIEW JOB PANEL ────────────────────────────────────────────────────
function viewJob(id){
  var j=jobs.filter(function(x){return x.id===id;})[0];
  if(!j) return;
  pMode='view';
  el('p-title').textContent=j.client;
  el('p-sub').textContent=j.brand+' \u00b7 '+j.ref;
  var t=totalRev(j);
  var dur=jobDur(j);
  var cc=jobCrewCost(j);
  var cos=jobCOS(j);
  var mar=t>0?(t-cos)/t*100:null;
  var mCol=mar===null?'var(--t3)':mar>=30?'var(--green)':mar>=15?'var(--amber)':'var(--red)';
  var isMulti=j.start!==j.end;
  var crew=j.drivers.concat(j.porters).filter(function(x){return x;});

  var h='<div class="fsec">';
  h+='<div class="fsec-t"><i>1</i>Details</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:11px">';
  h+='<div class="di"><div class="dlbl">Brand</div><div class="dval">'+bbadge(j.brand)+'</div></div>';
  h+='<div class="di"><div class="dlbl">Status</div><div class="dval">'+sbadge(j.status)+'</div></div>';
  if(j.channel) h+='<div class="di"><div class="dlbl">Channel</div><div class="dval"><span style="font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;padding:2px 7px;border-radius:3px;background:var(--s1);border:1px solid var(--b1)">'+esc(j.channel)+'</span></div></div>';
  if(j.jobType) h+='<div class="di"><div class="dlbl">Job Type</div><div class="dval">'+esc(j.jobType)+'</div></div>';
  if(j.clientRef) h+='<div class="di"><div class="dlbl">Client Ref</div><div class="dval" style="font-weight:700;font-family:monospace;font-size:11.5px">'+esc(j.clientRef)+'</div></div>';
  if(j.moveManager){ var mm=MOVE_MANAGERS.filter(function(m){return m.id===j.moveManager;})[0]; if(mm) h+='<div class="di" style="grid-column:1/-1"><div class="dlbl">Move Manager</div><div class="dval"><div style="display:flex;align-items:center;gap:8px"><div style="width:28px;height:28px;border-radius:50%;background:var(--blue);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700">'+mm.name[0]+'</div><div><div style="font-weight:600">'+esc(mm.name)+'</div><div style="font-size:11px;color:var(--t3)">'+esc(mm.phone)+' &bull; '+esc(mm.email)+'</div></div></div></div></div>'; }
  h+='<div class="di"><div class="dlbl">Origin</div><div class="dval" style="display:flex;align-items:center;gap:6px">'+esc(j.origin)+(j.origin?'<button class="addr-map-btn has-addr" onclick="openMapModal(this.dataset.a)" data-a="'+esc(j.origin)+'" title="View map">🗺</button>':'')+'</div></div>';
  h+='<div class="di"><div class="dlbl">Destination</div><div class="dval" style="display:flex;align-items:center;gap:6px">'+esc(j.dest)+(j.dest && j.dest!=='INT STORE' && j.dest!=='EX STORE'?'<button class="addr-map-btn has-addr" onclick="openMapModal(this.dataset.a)" data-a="'+esc(j.dest)+'" title="View map">🗺</button>':'')+'</div></div>';
  h+='<div class="di"><div class="dlbl">Start</div><div class="dval" style="color:var(--blue);font-weight:700">'+fmtNice(j.start)+'</div></div>';
  h+='<div class="di"><div class="dlbl">End</div><div class="dval" style="color:var(--blue);font-weight:700">'+fmtNice(j.end)+(isMulti?' <span style="color:var(--t3);font-size:10px;font-weight:400">('+dur+'d)</span>':'')+'</div></div>';
  if(j.vol>0) h+='<div class="di"><div class="dlbl">Volume</div><div class="dval">'+j.vol.toLocaleString()+' ft\u00b3</div></div>';
  if(j.cbm>0) h+='<div class="di"><div class="dlbl">CBM</div><div class="dval">'+j.cbm+'</div></div>';
  h+='</div></div>';

  h+='<div class="fsec"><div class="fsec-t"><i>2</i>Crew &amp Vehicles</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:11px">';
  h+='<div class="di"><div class="dlbl">Drivers</div><div class="dval" style="display:flex;flex-wrap:wrap;gap:3px;margin-top:3px">';
  if(j.drivers.length){ for(var k=0;k<j.drivers.length;k++) h+=chip(j.drivers[k]); }
  else h+='<span style="color:var(--t3)">None</span>';
  h+='</div></div>';
  h+='<div class="di"><div class="dlbl">Porters</div><div class="dval" style="display:flex;flex-wrap:wrap;gap:3px;margin-top:3px">';
  if(j.porters.length){ for(var k=0;k<j.porters.length;k++) h+=chip(j.porters[k]); }
  else h+='<span style="color:var(--t3)">None</span>';
  h+='</div></div>';
  if(j.veh.length) h+='<div class="di" style="grid-column:1/-1"><div class="dlbl">Vehicles</div><div class="dval" style="margin-top:3px">'+j.veh.map(function(v){return chip('\uD83D\uDE9B '+v);}).join(' ')+'</div></div>';
  h+='<div class="di"><div class="dlbl">Fuel Cost</div><div class="dval">'+spv(fmt(jobFuelCost(j)),'jfuel-'+j.id)+'</div></div>';
  h+='</div></div>';

  h+='<div class="fsec"><div class="fsec-t"><i>3</i>Billing</div>';
  for(var k=0;k<j.billing.length;k++){
    h+='<div class="brow"><span class="blbl">'+esc(j.billing[k].item)+'</span><span class="bamt">'+(j.billing[k].amt>0?spv(fmt(j.billing[k].amt)):'TBC')+'</span></div>';
  }
  h+='<div class="btotal"><span>Total Revenue</span><span style="color:var(--blue)">'+spv(fmt(t))+'</span></div></div>';

  h+='<div class="fsec"><div class="fsec-t"><i>4</i>Cost &amp; Margin</div>';
  // --- HUMAN RESOURCES ---
  h+='<div class="cos-section-head">Human Resources</div>';
  for(var k=0;k<crew.length;k++){
    var cr=crewByName(crew[k]);
    if(cr){
      var cr_charge=(cr.chargeRate||cr.rate);
      h+='<div class="brow"><span class="blbl">'+crew[k]+' ('+cr.role+') &times; '+dur+'d @ &pound;'+cr_charge+'/day</span><span class="bamt">'+spv(fmt(cr_charge*dur))+'</span></div>';
    }
  }
  if(!crew.length) h+='<div class="brow"><span class="blbl" style="color:var(--t3)">No crew assigned</span><span class="bamt">—</span></div>';
  // --- VEHICLES ---
  h+='<div class="cos-section-head">Vehicles</div>';
  var vCostTotal=0;
  for(var vi=0;vi<j.veh.length;vi++){
    var vn=j.veh[vi];
    for(var vv=0;vv<VEHICLES.length;vv++){
      if(VEHICLES[vv].reg===vn||VEHICLES[vv].name===vn){
        var vdr=VEHICLES[vv].dayRate||0;
        vCostTotal+=vdr*dur;
        h+='<div class="brow"><span class="blbl">'+esc(vn)+' ('+VEHICLES[vv].type+') &times; '+dur+'d @ &pound;'+vdr+'/day</span><span class="bamt">'+spv(fmt(vdr*dur))+'</span></div>';
        break;
      }
    }
  }
  if(!j.veh.length) h+='<div class="brow"><span class="blbl" style="color:var(--t3)">No vehicles assigned</span><span class="bamt">—</span></div>';
  // --- FUEL / MILEAGE ---
  h+='<div class="cos-section-head">Mileage &amp; Fuel</div>';
  var fCost=jobFuelCost(j);
  var miles=j.mileage||0;
  var retMiNote='';
  if(APP_SETTINGS.returnMileage && jobDur(j)===1 && miles){
    var dest2=j.dest||''; var wh2=APP_SETTINGS.warehouseAddress||SL_CONFIG.companyPostcode||'';
    var retMi=(dest2&&wh2&&dest2!==wh2)?(postcodeDistanceMiles(dest2,wh2)||miles):miles;
    retMiNote=' + '+retMi+'mi return';
  }
  var fLabel=miles?(miles+'mi out'+retMiNote):'Estimated';
  h+='<div class="brow"><span class="blbl">Fuel / Mileage ('+fLabel+')</span><span class="bamt">'+spv(fmt(fCost))+'</span></div>';
  if(!miles) h+='<div style="font-size:10.5px;color:var(--amber);padding:2px 0 4px;margin-left:2px">⚠ No mileage entered — add mileage for accurate fuel cost</div>';
  // --- MATERIALS ---
  h+='<div class="cos-section-head">Materials</div>';
  var matCost=jobMatCost(j); var mats=j.materials||[];
  if(mats.length){
    for(var mi2=0;mi2<mats.length;mi2++){
      var matRec=MATERIALS.filter(function(x){return x.id===mats[mi2].id;})[0];
      if(matRec){
        var matLine=matRec.unitCost*(mats[mi2].qty||0);
        h+='<div class="brow"><span class="blbl">'+esc(matRec.name)+' &times; '+(mats[mi2].qty||0)+' @ &pound;'+matRec.unitCost+'</span><span class="bamt">'+spv(fmt(matLine))+'</span></div>';
      }
    }
  } else {
    h+='<div class="brow"><span class="blbl" style="color:var(--t3)">No materials assigned</span><span class="bamt">—</span></div>';
  }
  // --- GENERIC OVERHEAD ---
  var overhead=jobCOSOverhead(j); var crewCount=crew.length;
  h+='<div class="cos-section-head">General Overhead (COS)</div>';
  h+='<div class="brow"><span class="blbl">&pound;'+APP_SETTINGS.cosPerCrewPerDay+' &times; '+crewCount+' crew &times; '+dur+'d</span><span class="bamt">'+spv(fmt(overhead))+'</span></div>';
  // --- TOTAL ---
  var totalCOS2=jobCOS(j);
  h+='<div class="brow" style="font-weight:700;border-top:2px solid var(--t1);padding-top:8px;margin-top:6px"><span class="blbl">Total COS</span><span class="bamt" style="color:var(--red)">'+spv(fmt(totalCOS2))+'</span></div>';
  h+='<div style="margin-top:11px;padding:11px;border-radius:var(--r);background:var(--s1);border:1px solid var(--b1);display:grid;grid-template-columns:1fr 1fr;gap:8px">';
  h+='<div class="di"><div class="dlbl">Revenue</div><div class="dval" style="color:var(--blue);font-weight:600">'+(t>0?spv(fmt(t)):'TBC')+'</div></div>';
  var mar2=t>0?(t-totalCOS2)/t*100:null;
  var mCol2=mar2===null?'var(--t3)':mar2>=30?'var(--green)':mar2>=15?'var(--amber)':'var(--red)';
  h+='<div class="di"><div class="dlbl">Gross Margin</div><div class="dval" style="font-weight:700;color:'+mCol2+'">'+spv(mar2!==null?fmt(t-totalCOS2):'TBC')+'</div></div>';
  h+='<div class="di"><div class="dlbl">Margin %</div><div class="dval" style="font-weight:700;font-size:20px;color:'+mCol2+'">'+spv(mar2!==null?mar2.toFixed(1)+'%':'&mdash;')+'</div></div>';
  h+='<div class="di"><div class="dlbl">Duration</div><div class="dval">'+dur+' day'+(dur!==1?'s':'')+'</div></div>';
  h+='</div>';
  if(mar2!==null&&mar2<15) h+='<div style="margin-top:8px;padding:7px 10px;background:#FFFBEB;border:1px solid #FFE97A;border-radius:var(--r);font-size:11.5px;color:#7A5200;font-weight:600">&#9888; Margin below 15% &mdash; review billing or crew</div>';
  h+='</div>';
  h+='</div>';
  if(mar!==null&&mar<15) h+='<div style="margin-top:8px;padding:7px 10px;background:#FFFBEB;border:1px solid #FFE97A;border-radius:var(--r);font-size:11.5px;color:#7A5200;font-weight:600">&#9888; Margin below 15% &mdash; review billing or crew</div>';
  h+='</div>';
  // Journey context
  if(j.journeyId){
    var jrn=journeyById(j.journeyId);
    if(jrn){
      var jjobs=jobsInJourney(jrn.id);
      var jrnIdx=jrn.jobIds.indexOf(j.id);
      var totalJMiles=Math.round(totalJourneyMiles(jrn));
      var legs=journeyLegs(jrn);
      var ovCost=journeyOvernightCost(jrn);
      h+='<div class="fsec"><div class="fsec-t"><i>5</i>&#128648; Journey</div>';
      h+='<div class="brow"><span class="blbl">Journey Ref</span><span style="font-family:monospace;font-weight:700;font-size:11.5px">'+esc(jrn.ref)+'</span></div>';
      h+='<div class="brow"><span class="blbl">This job</span><span style="font-size:12px">Job '+(jrnIdx+1)+' of '+jjobs.length+'</span></div>';
      h+='<div style="margin:8px 0;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--t3)">Journey Route</div>';
      for(var li=0;li<legs.length;li++){
        var leg=legs[li];
        var isReturnLeg=leg.isReturn;
        h+='<div class="brow" style="'+(isReturnLeg?'opacity:.6':'')+'"><span class="blbl" style="font-family:monospace;font-size:11px">'+esc(leg.from)+' &rarr; '+esc(leg.to)+(isReturnLeg?' <em style=\'font-style:italic;color:var(--t3);font-weight:400\'>return to depot</em>':'')+'</span><span style="font-size:11.5px;color:var(--t3)">~'+Math.round(leg.miles)+'mi</span></div>';
      }
      h+='<div class="brow" style="font-weight:700;margin-top:4px"><span class="blbl">Total journey distance</span><span>'+spv('~'+totalJMiles+' mi')+'</span></div>';
      if(jrn.overnights&&jrn.overnights.nights){
        h+='<div style="margin-top:8px;padding:8px 10px;background:var(--alt);border:1px solid var(--amber);border-radius:var(--r)">';
        h+='<div style="font-size:11px;font-weight:700;color:var(--amber);margin-bottom:4px">&#127769; Overnight: '+jrn.overnights.nights+' night'+(jrn.overnights.nights!==1?'s':'')+'</div>';
        h+='<div class="brow"><span class="blbl">Allowance per person</span><span>'+spv('£'+jrn.overnights.allowancePerPerson+'/night')+'</span></div>';
        h+='<div class="brow"><span class="blbl">Internal cost ('+jrn.crew.length+' crew)</span><span>'+spv(fmt(ovCost))+'</span></div>';
        h+='<div class="brow"><span class="blbl">Nights billed to client</span><span>'+jrn.overnights.billingNights+'</span></div>';
        h+='</div>';
      }
      h+='<div style="margin-top:8px"><button class="btn btn-sm btn-s" id="btn-view-journey">View Full Journey</button></div>';
      h+='</div>';
    }
  }

  // Storage link
  if(j.storageId){
    var linkedS=null;
    for(var ssi=0;ssi<STORAGE_RECORDS.length;ssi++) if(STORAGE_RECORDS[ssi].id===j.storageId){linkedS=STORAGE_RECORDS[ssi];break;}
    if(linkedS){
      h+='<div class="fsec"><div class="fsec-t"><i>6</i>&#127970; Linked Storage</div>';
      h+='<div class="brow"><span class="blbl">Record</span><span style="font-family:monospace;font-weight:700">'+esc(linkedS.id)+'</span></div>';
      h+='<div class="brow"><span class="blbl">Bay</span><span>'+esc(linkedS.bay||'—')+'</span></div>';
      h+='<div class="brow"><span class="blbl">Volume</span><span>'+spv((linkedS.cbm||0).toFixed(1)+' CBM')+'</span></div>';
      h+='<div class="brow"><span class="blbl">Status</span><span style="font-weight:700;text-transform:uppercase;font-size:10.5px;color:'+(linkedS.status==='active'?'var(--green)':'var(--t3)')+'">'+linkedS.status+'</span></div>';
      h+='<div style="margin-top:6px"><button class="btn btn-sm btn-s" id="btn-view-storage-link">View Storage</button></div>';
      h+='</div>';
    }
  }

  if(j.notes) h+='<div class="fsec"><div class="fsec-t"><i>'+(j.journeyId?7:j.storageId?6:5)+'</i>Notes</div><div style="background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:10px;font-size:12.5px;color:var(--t2);line-height:1.7">'+esc(j.notes)+'</div></div>';

  setH('p-body',h);
  setH('p-foot','<button class="btn btn-del btn-sm" id="btn-del-job">Delete</button><button class="btn btn-s" onclick="closePanel()">Close</button><button class="btn btn-p" id="btn-edit-job">Edit</button>');
  openPanel();

  // Attach events post-render
  var delBtn=document.getElementById('btn-del-job');
  if(delBtn) delBtn.addEventListener('click',function(){delJob(id);});
  var editBtn=document.getElementById('btn-edit-job');
  if(editBtn) editBtn.addEventListener('click',function(){openEdit(id);});
  var jrnBtn=document.getElementById('btn-view-journey');
  if(jrnBtn) jrnBtn.addEventListener('click',function(){viewJourney(j.journeyId);});
  var stoLinkBtn=document.getElementById('btn-view-storage-link');
  if(stoLinkBtn) stoLinkBtn.addEventListener('click',function(){viewStorage(j.storageId);});
}

// ── JOURNEY PANEL ─────────────────────────────────────────────────────
function viewJourney(id){
  var jrn=journeyById(id);
  if(!jrn) return;
  var jjobs=jobsInJourney(id);
  var legs=journeyLegs(jrn);
  var totalMiles=Math.round(totalJourneyMiles(jrn));
  var ovCost=journeyOvernightCost(jrn);
  var totalRev2=jjobs.reduce(function(s,j){return s+totalRev(j);},0);
  var totalCOS2=jjobs.reduce(function(s,j){return s+jobCOS(j);},0)+ovCost;
  var margin=totalRev2>0?(totalRev2-totalCOS2)/totalRev2*100:null;
  var mCol=margin===null?'var(--t3)':margin>=30?'var(--green)':margin>=15?'var(--amber)':'var(--red)';

  el('p-title').textContent=jrn.label;
  el('p-sub').textContent='Journey \u00b7 '+jrn.ref;

  var h='<div class="fsec"><div class="fsec-t"><i>1</i>Journey Overview</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px">';
  h+='<div class="di"><div class="dlbl">Jobs in Journey</div><div class="dval" style="font-size:18px;font-weight:700">'+jjobs.length+'</div></div>';
  h+='<div class="di"><div class="dlbl">Total Distance</div><div class="dval" style="font-size:18px;font-weight:700">'+spv('~'+totalMiles+' mi')+'</div></div>';
  h+='<div class="di"><div class="dlbl">Total Revenue</div><div class="dval" style="color:var(--blue);font-weight:700">'+spv(fmt(totalRev2))+'</div></div>';
  h+='<div class="di"><div class="dlbl">Gross Margin</div><div class="dval" style="color:'+mCol+';font-weight:700">'+spv(margin!==null?margin.toFixed(1)+'%':'—')+'</div></div>';
  h+='</div>';
  if(jrn.overnights&&jrn.overnights.nights){
    h+='<div style="padding:8px 10px;background:var(--alt);border:1px solid var(--amber);border-radius:var(--r);margin-bottom:8px">';
    h+='<span style="font-size:11px;font-weight:700;color:var(--amber)">&#127769; '+jrn.overnights.nights+' overnight'+(jrn.overnights.nights!==1?'s':'')+'</span>';
    h+=' <span style="font-size:11px;color:var(--t3);margin-left:8px">Internal cost: '+spv(fmt(ovCost))+'</span>';
    h+=' <span style="font-size:11px;color:var(--t3);margin-left:8px">Billed to client: '+jrn.overnights.billingNights+'n</span>';
    h+='</div>';
  }
  h+='</div>';

  // Journey route map (textual chain)
  h+='<div class="fsec"><div class="fsec-t"><i>2</i>Route Chain</div>';
  h+='<div style="font-size:11.5px">';
  var wh=SL_CONFIG.companyPostcode||'DEPOT';
  h+='<div style="display:flex;align-items:center;gap:6px;margin:4px 0"><div style="width:8px;height:8px;border-radius:50%;background:var(--blue);flex-shrink:0"></div><span style="font-weight:700;font-family:monospace">'+esc(wh)+'</span><span style="color:var(--t3);margin-left:2px">(Depot)</span></div>';
  for(var li=0;li<legs.length;li++){
    var leg=legs[li];
    var isReturn=leg.isReturn;
    var lineCol=isReturn?'var(--t4)':'var(--blue)';
    h+='<div style="display:flex;align-items:stretch;gap:6px;margin:0">';
    h+='<div style="display:flex;flex-direction:column;align-items:center;width:8px;flex-shrink:0"><div style="width:1px;flex:1;background:'+lineCol+'"></div></div>';
    h+='<div style="padding:2px 0;font-size:10.5px;color:'+(isReturn?'var(--t3)':'var(--t2)');h+=';font-style:'+(isReturn?'italic':'normal')+'">';
    h+=Math.round(leg.miles)+'mi &darr;';
    if(isReturn) h+=' <em>return to depot</em>';
    h+='</div></div>';
    h+='<div style="display:flex;align-items:center;gap:6px;margin:4px 0"><div style="width:8px;height:8px;border-radius:50%;background:'+(isReturn?'var(--t3)':'var(--green)')+';flex-shrink:0"></div><span style="font-weight:700;font-family:monospace">'+esc(leg.to)+'</span></div>';
  }
  h+='</div></div>';

  // Jobs list
  h+='<div class="fsec"><div class="fsec-t"><i>3</i>Jobs</div>';
  for(var ji=0;ji<jjobs.length;ji++){
    var jb=jjobs[ji];
    var jbRev=totalRev(jb);
    var jbCOS=jobCOS(jb);
    var jbMar=jbRev>0?(jbRev-jbCOS)/jbRev*100:null;
    var jbMCol=jbMar===null?'var(--t3)':jbMar>=30?'var(--green)':jbMar>=15?'var(--amber)':'var(--red)';
    var jbCrew=jb.drivers.concat(jb.porters).filter(function(x){return x;});
    h+='<div style="border:1px solid var(--b1);border-radius:var(--r);padding:10px;margin-bottom:8px;cursor:pointer;transition:box-shadow .15s" id="jrnjob-'+jb.id+'">';
    h+='<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px">';
    h+='<div><div style="font-weight:700;font-size:12.5px">Job '+(ji+1)+': '+esc(jb.client)+'</div>';
    h+='<div style="font-size:11px;color:var(--t3);font-family:monospace">'+esc(jb.ref)+'</div></div>';
    h+=bbadge(jb.brand)+'</div>';
    h+='<div style="font-size:11.5px;color:var(--t2);margin-bottom:4px">'+esc(jb.origin)+' &rarr; '+esc(jb.dest)+'</div>';
    h+='<div style="display:flex;gap:10px;font-size:11px">';
    h+='<span style="color:var(--blue);font-weight:600">'+spv(fmt(jbRev))+'</span>';
    h+='<span style="color:var(--red)">COS: '+spv(fmt(jbCOS))+'</span>';
    if(jbMar!==null) h+='<span style="font-weight:700;color:'+jbMCol+'">'+spv(jbMar.toFixed(1)+'%')+'</span>';
    h+='</div>';
    if(jbCrew.length){h+='<div style="margin-top:4px;display:flex;gap:3px;flex-wrap:wrap">';for(var ki=0;ki<jbCrew.length;ki++) h+=chip(jbCrew[ki]);h+='</div>';}
    if(jrn.overnights&&jrn.overnights.nights&&ji<jjobs.length-1){
      h+='<div style="margin-top:5px;font-size:10.5px;color:var(--amber);font-weight:600">&#127769; Overnight after this job</div>';
    }
    h+='</div>';
  }
  h+='</div>';

  // Totals
  h+='<div class="fsec"><div class="fsec-t"><i>4</i>Journey Totals</div>';
  h+='<div class="brow"><span class="blbl">Total Revenue</span><span class="bamt" style="color:var(--blue)">'+spv(fmt(totalRev2))+'</span></div>';
  if(ovCost) h+='<div class="brow"><span class="blbl">Overnight allowances (internal)</span><span class="bamt" style="color:var(--amber)">'+spv(fmt(ovCost))+'</span></div>';
  h+='<div class="brow"><span class="blbl">Total COS (incl. overnights)</span><span class="bamt" style="color:var(--red)">'+spv(fmt(totalCOS2))+'</span></div>';
  h+='<div class="btotal"><span>Journey Gross Margin</span><span style="color:'+mCol+'">'+spv(margin!==null?margin.toFixed(1)+'%':'—')+'</span></div>';
  h+='</div>';

  if(jrn.notes) h+='<div class="fsec"><div class="fsec-t">Notes</div><div style="background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:10px;font-size:12.5px;color:var(--t2);line-height:1.7">'+esc(jrn.notes)+'</div></div>';

  setH('p-body',h);
  setH('p-foot','<button class="btn btn-s" onclick="closePanel()">Close</button><button class="btn btn-p" id="btn-edit-journey">Edit Journey</button>');
  openPanel();

  // Attach job row click events
  for(var ji2=0;ji2<jjobs.length;ji2++){
    (function(jbId){
      var el2=document.getElementById('jrnjob-'+jbId);
      if(el2) el2.addEventListener('click',function(){viewJob(jbId);});
    })(jjobs[ji2].id);
  }
  var editJrnBtn=document.getElementById('btn-edit-journey');
  if(editJrnBtn) editJrnBtn.addEventListener('click',function(){editJourney(id);});
}

function editJourney(id){
  var jrn=journeyById(id);
  if(!jrn) return;
  var h='<div class="fsec"><div class="fsec-t">Journey Details</div>';
  h+='<div class="fg"><label class="lbl">Journey Label</label><input class="fi" id="jrn-lbl" value="'+esc(jrn.label)+'"></div>';
  h+='<div class="fg"><label class="lbl">Reference</label><input class="fi" id="jrn-ref" value="'+esc(jrn.ref)+'"></div>';
  h+='</div>';
  h+='<div class="fsec"><div class="fsec-t">Overnights</div>';
  h+='<div class="fg2">';
  h+='<div class="fg"><label class="lbl">Nights (internal cost)</label><input class="fi" type="number" id="jrn-nights" value="'+(jrn.overnights?jrn.overnights.nights:0)+'"></div>';
  h+='<div class="fg"><label class="lbl">Nights billed to client</label><input class="fi" type="number" id="jrn-bnights" value="'+(jrn.overnights?jrn.overnights.billingNights:0)+'"></div>';
  h+='</div>';
  h+='<div class="fg"><label class="lbl">Allowance per person per night £</label><input class="fi" type="number" id="jrn-allow" value="'+(jrn.overnights?jrn.overnights.allowancePerPerson:65)+'" step="0.01"></div>';
  h+='</div>';
  h+='<div class="fsec"><div class="fsec-t">Notes</div>';
  h+='<div class="fg"><textarea class="fi" id="jrn-notes" style="height:80px;resize:vertical">'+esc(jrn.notes||'')+'</textarea></div>';
  h+='</div>';

  el('p-title').textContent='Edit Journey';
  el('p-sub').textContent=jrn.ref;
  setH('p-body',h);
  setH('p-foot','<button class="btn btn-s" onclick="closePanel()">Cancel</button><button class="btn btn-p" id="btn-save-journey">Save</button>');
  openPanel();

  var saveBtn=document.getElementById('btn-save-journey');
  if(saveBtn) saveBtn.addEventListener('click',function(){
    jrn.label=(el('jrn-lbl')||{value:jrn.label}).value||jrn.label;
    jrn.ref=(el('jrn-ref')||{value:jrn.ref}).value||jrn.ref;
    if(!jrn.overnights) jrn.overnights={nights:0,allowancePerPerson:65,billingNights:0};
    jrn.overnights.nights=parseInt((el('jrn-nights')||{value:0}).value)||0;
    jrn.overnights.billingNights=parseInt((el('jrn-bnights')||{value:0}).value)||0;
    jrn.overnights.allowancePerPerson=parseFloat((el('jrn-allow')||{value:65}).value)||65;
    jrn.notes=(el('jrn-notes')||{value:''}).value||'';
    toast('Journey saved'); saveData('journey', jrn.id, jrn);
    viewJourney(id);
  });
}

// ── NEW / EDIT FORM ───────────────────────────────────────────────────
function openNew(ds){
  // Route through booking configurator for proper data capture
  if (ds) {
    CFG = cfgEmpty();
    CFG.startDate = ds;
    CFG.selectedDates = [ds];
    cfgStage = 0;
    el('cfg-head-ref').textContent = CFG.ref;
    el('cfg-head-title').textContent = 'New Job';
    el('cfg-backdrop').classList.add('on');
    el('cfg-panel').classList.add('on');
    cfgRenderStage();
    cfgUpdateNav();
  } else {
    openConfigurator(null);
  }
}
function openEdit(id){
  var j=jobs.filter(function(x){return x.id===id;})[0];
  if(!j) return;
  pMode='edit';
  eJob=JSON.parse(JSON.stringify(j));
  el('p-title').textContent='Edit Job';
  el('p-sub').textContent=j.client+' \u00b7 '+j.ref;
  renderForm(); openPanel();
}
function renderForm(){
  var j=eJob;
  var h='<div class="fsec"><div class="fsec-t"><i>1</i>Details</div>';
  h+='<div class="fg2">';
  h+='<div class="fg"><label class="lbl">Brand</label><select class="fi" id="fb" onchange="onJobBrandChange()">';
  for(var i=0;i<BRANDS.length;i++) h+='<option'+(j.brand===BRANDS[i]?' selected':'')+'>'+BRANDS[i]+'</option>';
  h+='</select></div>';
  h+='<div class="fg"><label class="lbl">Channel</label><select class="fi" id="fch" onchange="onJobChannelChange()">'+
    ['Partner','Account','Domestic'].map(function(ch){return '<option'+(ch===(j.channel||brandChannel(j.brand))?' selected':'')+'>'+ch+'</option>';}).join('')+
  '</select></div>';
  h+='<div class="fg"><label class="lbl">Job Type</label><select class="fi" id="fjt">'+
    ['Door to Door','Domestic','European','Sea','Air','Storage','Other'].map(function(t){return '<option'+(t===(j.jobType||'Door to Door')?' selected':'')+'>'+t+'</option>';}).join('')+
  '</select></div>';
  h+='<div class="fg"><label class="lbl">Internal Ref</label><input class="fi" id="fref" value="'+esc(j.ref)+'" placeholder="e.g. GB2600334-01"></div>';
  h+='<div class="fg" id="fg-cr"><label class="lbl">Client/Partner Ref</label><input class="fi" id="fcr" value="'+esc(j.clientRef||'')+'"></div>';
  h+='</div>';
  h+='<div class="fg" id="fg-mm" style="'+((['Partner','Account'].indexOf(j.channel||brandChannel(j.brand))>=0)?'':'display:none')+'"><label class="lbl">Move Manager</label><select class="fi" id="fmm">';
  h+='<option value="">— None —</option>';
  for(var mi=0;mi<MOVE_MANAGERS.length;mi++) h+='<option value="'+MOVE_MANAGERS[mi].id+'"'+(j.moveManager===MOVE_MANAGERS[mi].id?' selected':'')+'>'+esc(MOVE_MANAGERS[mi].name)+' ('+esc(MOVE_MANAGERS[mi].brand)+')</option>';
  h+='</select></div>';
  h+='<div class="fg"><label class="lbl">Client Name *</label><input class="fi" id="fcl" value="'+esc(j.client)+'" placeholder="Client name"></div>';
  h+='<div class="fg2">';
  h+='<div class="fg"><label class="lbl">Origin <span style="font-size:10px;color:var(--t3);font-weight:400">— type to lookup address</span></label><input class="fi" id="for" value="'+esc(j.origin)+'" placeholder="Start typing address or postcode…" autocomplete="off"></div>';
  h+='<div class="fg"><label class="lbl">Destination <span style="font-size:10px;color:var(--t3);font-weight:400">— type to lookup address</span></label><input class="fi" id="fde" value="'+esc(j.dest)+'" placeholder="Start typing address or postcode…" autocomplete="off"></div>';
  h+='<div class="fg"><label class="lbl">Start Date</label><input class="fi" type="date" id="fsd" value="'+j.start+'"></div>';
  h+='<div class="fg"><label class="lbl">End Date</label><input class="fi" type="date" id="fed" value="'+j.end+'"></div>';
  h+='<div class="fg"><label class="lbl">Volume ft&#179;</label><input class="fi" type="number" id="fvo" value="'+j.vol+'" min="0"></div>';
  h+='<div class="fg"><label class="lbl">CBM</label><input class="fi" type="number" id="fcb" value="'+j.cbm+'" step="0.01" min="0"></div>';
  h+='<div class="fg"><label class="lbl">Status</label><select class="fi" id="fst">';
  var statuses=['Scheduled','In Progress','Completed','Billed'];
  for(var i=0;i<statuses.length;i++) h+='<option'+(j.status===statuses[i]?' selected':'')+'>'+statuses[i]+'</option>';
  h+='</select></div>';
  h+='<div class="fg"><label class="lbl">Mileage (mi)</label><input class="fi" type="number" id="fmi" value="'+(j.mileage||0)+'" min="0" placeholder="0" title="Used to calculate fuel cost via vehicle rate"></div>';
  h+='<div class="fg"><label class="lbl">Fuel override &pound;</label><input class="fi" type="number" id="ffu" value="'+(j.fuel||0)+'" min="0" placeholder="Auto-calc" title="Leave 0 to auto-calculate from mileage &times; vehicle rate"></div>';
  h+='</div></div>';
  h+='<div class="fsec"><div class="fsec-t"><i>2</i>Crew</div>';
  h+='<div class="fg2">';
  h+='<div class="fg"><label class="lbl">Drivers</label><div style="display:flex;flex-wrap:wrap">';
  for(var i=0;i<CREW.length;i++) h+='<label class="cpill"><input type="checkbox" id="dr'+i+'"'+(j.drivers.indexOf(CREW[i].name)>=0?' checked':'')+'> <span>'+CREW[i].name+'</span></label>';
  h+='</div></div>';
  h+='<div class="fg"><label class="lbl">Porters</label><div style="display:flex;flex-wrap:wrap">';
  for(var i=0;i<CREW.length;i++) h+='<label class="cpill"><input type="checkbox" id="po'+i+'"'+(j.porters.indexOf(CREW[i].name)>=0?' checked':'')+'> <span>'+CREW[i].name+'</span></label>';
  h+='</div></div>';
  h+='</div>';
  h+='<div class="fg"><label class="lbl">Vehicles (comma separated)</label><input class="fi" id="fve" value="'+esc(j.veh.join(', '))+'"></div>';
  h+='</div>';
  h+='<div class="fsec"><div class="fsec-t"><i>3</i>Billing</div>';
  h+='<div id="blines">';
  for(var i=0;i<j.billing.length;i++) h+=bline(j.billing[i].item,j.billing[i].amt,i);
  h+='</div>';
  h+='<button class="btn btn-s btn-sm" style="margin-top:6px" onclick="addBline()">+ Add line</button>';
  h+='</div>';
  // Materials section
  h+='<div class="fsec"><div class="fsec-t"><i>4</i>Materials <span style="font-weight:400;font-size:11px;color:var(--t3)">(included in COS)</span></div>';
  h+='<div id="fmat-rows">';
  var jmats=j.materials||[];
  for(var mi3=0;mi3<jmats.length;mi3++) h+=matLine(jmats[mi3].id,jmats[mi3].qty,mi3);
  h+='</div>';
  h+='<button class="btn btn-s btn-sm" style="margin-top:6px" onclick="addMatLine()">+ Add material</button>';
  h+='</div>';
  h+='<div class="fsec"><div class="fsec-t"><i>5</i>Notes</div>';
  h+='<textarea class="fi" id="fno" placeholder="Instructions, contacts, access info&hellip;">'+esc(j.notes)+'</textarea>';
  h+='</div>';
  // Journey assignment
  h+='<div class="fsec"><div class="fsec-t"><i>6</i>Journey &amp; Sequence</div>';
  h+='<div class="fg2">';
  h+='<div class="fg"><label class="lbl">Journey (optional)</label><select class="fi" id="fjrn">';
  h+='<option value="">— Standalone job —</option>';
  for(var ji=0;ji<JOURNEYS.length;ji++) h+='<option value="'+JOURNEYS[ji].id+'"'+(j.journeyId===JOURNEYS[ji].id?' selected':'')+'>'+esc(JOURNEYS[ji].ref)+' — '+esc(JOURNEYS[ji].label)+'</option>';
  h+='</select></div>';
  h+='<div class="fg"><label class="lbl">Seq. in day (1=first)</label><input class="fi" type="number" id="fseq" value="'+(j.seqInDay||0)+'" min="0" placeholder="0 = n/a"></div>';
  h+='</div>';
  h+='<div class="fg2">';
  h+='<div class="fg"><label class="lbl">Linked Storage Record</label><select class="fi" id="fsto">';
  h+='<option value="">— None —</option>';
  for(var sti=0;sti<STORAGE_RECORDS.length;sti++) h+='<option value="'+STORAGE_RECORDS[sti].id+'"'+(j.storageId===STORAGE_RECORDS[sti].id?' selected':'')+'>'+esc(STORAGE_RECORDS[sti].id)+' — '+esc(STORAGE_RECORDS[sti].client)+'</option>';
  h+='</select></div>';
  h+='</div>';
  h+='</div>';
  setH('p-body',h);
  setH('p-foot','<button class="btn btn-s" onclick="closePanel()">Cancel</button><button class="btn btn-p" onclick="saveJob()">'+( pMode==='new'?'Create Job':'Save Changes')+'</button>');
}
function bline(item,amt,i){
  return '<div style="display:flex;gap:5px;margin-bottom:4px"><input class="fi" style="flex:2" placeholder="Item" value="'+esc(item)+'" id="bi'+i+'"><input class="fi" style="flex:1" type="number" placeholder="&pound;" value="'+amt+'" id="ba'+i+'" min="0" step="0.01"><button class="btn btn-g btn-sm" onclick="rmBline('+i+')">&#10005;</button></div>';
}
function addBline(){
  eJob.billing.push({item:'',amt:0});
  var bl=el('blines');
  var i=eJob.billing.length-1;
  bl.insertAdjacentHTML('beforeend',bline('',0,i));
}
function rmBline(i){ eJob.billing.splice(i,1); renderForm(); }

function matLine(matId,qty,i){
  var opts=MATERIALS.map(function(m){return '<option value="'+m.id+'"'+(m.id===matId?' selected':'')+'>'+esc(m.name)+' (&pound;'+m.unitCost+')</option>';}).join('');
  return '<div style="display:flex;gap:5px;margin-bottom:4px;align-items:center">'
    +'<select class="fi" style="flex:2" id="maid'+i+'"><option value="">— select —</option>'+opts+'</select>'
    +'<input class="fi" style="flex:1;max-width:70px" type="number" placeholder="Qty" min="0" step="1" value="'+(qty||0)+'" id="maqt'+i+'">'
    +'<button class="btn btn-g btn-sm" onclick="rmMatLine('+i+')">&#10005;</button></div>';
}
function addMatLine(){
  if(!eJob.materials) eJob.materials=[];
  eJob.materials.push({id:'',qty:1});
  var ml=el('fmat-rows');
  var i=eJob.materials.length-1;
  ml.insertAdjacentHTML('beforeend',matLine('',1,i));
}
function rmMatLine(i){ if(!eJob.materials) return; eJob.materials.splice(i,1); renderForm(); }

function onJobBrandChange() {
  var brand = (el('fb')||{}).value||'';
  var ch = brandChannel(brand);
  if(el('fch')) el('fch').value = ch;
  onJobChannelChange();
  // Auto-select MM for this brand
  var mm = mmForBrand(brand);
  if(el('fmm') && mm) el('fmm').value = mm.id;
}
function onJobChannelChange() {
  var ch = (el('fch')||{}).value||'';
  var isPartnerOrAccount = ch==='Partner'||ch==='Account';
  var mmDiv = el('fg-mm');
  if(mmDiv) mmDiv.style.display = isPartnerOrAccount ? '' : 'none';
}
function saveJob(){
  eJob.brand=el('fb').value;
  eJob.channel=el('fch').value;
  eJob.jobType=el('fjt').value;
  eJob.clientRef=el('fcr').value||'';
  eJob.moveManager=el('fmm').value||'';
  eJob.ref=el('fref').value;
  eJob.client=el('fcl').value;
  eJob.origin=el('for').value;
  eJob.dest=el('fde').value;
  eJob.start=el('fsd').value;
  eJob.end=el('fed').value||eJob.start;
  eJob.vol=parseFloat(el('fvo').value)||0;
  eJob.cbm=parseFloat(el('fcb').value)||0;
  eJob.status=el('fst').value;
  eJob.mileage=parseFloat(el('fmi').value)||0;
  eJob.fuel=parseFloat(el('ffu').value)||0;
  eJob.notes=el('fno').value;
  eJob.journeyId=(el('fjrn')||{value:''}).value||'';
  eJob.seqInDay=parseInt((el('fseq')||{value:0}).value)||0;
  eJob.storageId=(el('fsto')||{value:''}).value||'';
  eJob.veh=el('fve').value.split(',').map(function(s){return s.trim();}).filter(function(s){return s;});
  eJob.drivers=[];
  eJob.porters=[];
  for(var i=0;i<CREW.length;i++){
    if(el('dr'+i)&&el('dr'+i).checked) eJob.drivers.push(CREW[i].name);
    if(el('po'+i)&&el('po'+i).checked) eJob.porters.push(CREW[i].name);
  }
  eJob.billing=[];
  var i=0;
  while(el('bi'+i)){
    var item=el('bi'+i).value, amt=parseFloat(el('ba'+i).value)||0;
    if(item) eJob.billing.push({item:item,amt:amt});
    i++;
  }
  // Save materials
  eJob.materials=[];
  var mi3=0;
  while(el('maid'+mi3)){
    var matId=(el('maid'+mi3)||{}).value||'';
    var matQty=parseFloat((el('maqt'+mi3)||{}).value)||0;
    if(matId && matQty>0) eJob.materials.push({id:matId,qty:matQty});
    mi3++;
  }
  if(!eJob.client){ toast('Client name required'); return; }
  // Bidirectional storage link
  if(eJob.storageId){
    for(var si=0;si<STORAGE_RECORDS.length;si++){
      if(STORAGE_RECORDS[si].id===eJob.storageId && !STORAGE_RECORDS[si].jobId){
        STORAGE_RECORDS[si].jobId=eJob.id;
      }
    }
  }
  if(pMode==='new'){
    jobs.push(eJob);
    toast('Job created');
  } else {
    for(var k=0;k<jobs.length;k++) if(jobs[k].id===eJob.id){ jobs[k]=eJob; break; }
    toast('Saved');
  }
  closePanel(); renderCal();
  if(curMod==='crew') renderCrew();
  if(curMod==='finance') renderFinance();
  setBadge('job-badge',jobs.length);
  saveData('job', eJob.id, eJob);
}
function delJob(id){
  if(!confirm('Delete this job?')) return;
  jobs=jobs.filter(function(j){return j.id!==id;});
  closePanel(); renderCal(); toast('Deleted');
  setBadge('job-badge',jobs.length);
  deleteData('job', id);
}

// ── PANEL ─────────────────────────────────────────────────────────────
function openPanel(){ el('overlay').classList.add('on'); el('panel').classList.add('on'); }
function closePanel(){ el('overlay').classList.remove('on'); el('panel').classList.remove('on'); }

// ── EXPORT ────────────────────────────────────────────────────────────
function doExport(){
  var rows=[['ID','Ref','Brand','Client','Origin','Dest','Start','End','Vol','CBM','Drivers','Porters','Status','Revenue','COS','Margin%']];
  for(var i=0;i<jobs.length;i++){
    var j=jobs[i], t=totalRev(j), cos=jobCOS(j), m=t>0?((t-cos)/t*100):0;
    rows.push([j.id,j.ref,j.brand,j.client,j.origin,j.dest,j.start,j.end,j.vol,j.cbm,j.drivers.join('|'),j.porters.join('|'),j.status,t.toFixed(2),cos.toFixed(2),m.toFixed(1)+'%']);
  }
  var csv=rows.map(function(r){return r.map(function(c){return '"'+String(c).replace(/"/g,'""')+'"';}).join(',');}).join('\n');
  var a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download='ops_export.csv'; a.click();
  toast('Exported');
}


// ── STORAGE MODULE ────────────────────────────────────────────────────
// type: 'inout' = simple in/out job | 'longterm' = ongoing recurring billing
// billingUnit: 'cbm' = rate x CBM | 'flat' = flat rate per period
// Container types: standard (max 250ft³), small (max 150ft³), loose, pallet, lcl
var CONTAINER_TYPES = [
  {key:'standard', lbl:'Wooden Container (Standard)', maxFt:250, icon:'📦'},
  {key:'small',    lbl:'Wooden Container (Small)',    maxFt:150, icon:'📦'},
  {key:'loose',    lbl:'Loose Storage',               maxFt:null, icon:'🛋'},
  {key:'pallet',   lbl:'Pallet',                      maxFt:null, icon:'🪵'},
  {key:'lcl',      lbl:'LCL Case',                    maxFt:null, icon:'✈️'},
];

var STORAGE_RECORDS = [
  {id:'S001', type:'longterm', client:'Kitchen (Telford)', brand:'SIRVA',
   volFt:1792, cbm:51.2, volRemaining:1792,
   dateIn:'2026-03-04', dateOut:'', status:'active',
   billingType:'monthly', billingRate:85, billingUnit:'cbm',
   inboundJobId:'J001', outboundJobId:'',
   containers:[
     {containerNo:'C042', locNo:'W03-B2', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C043', locNo:'W03-B3', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C044', locNo:'W03-B4', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C045', locNo:'W03-B5', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C046', locNo:'W03-B6', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C047', locNo:'W03-B7', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C048', locNo:'W03-B8', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'L012', locNo:'W04-A1', type:'loose',    volFt:292, maxFt:null, dateIn:'2026-03-04', desc:'Large sofa — does not fit container'},
   ],
   notes:'Post-origin storage. Awaiting destination confirm.',
   billingHistory:[{date:'2026-03-02', amt:4352, desc:'Monthly storage (51.2 CBM @ £85)'}],
   accessLog:[]},
  {id:'S002', type:'inout', client:'GARNER', brand:'SIRVA',
   volFt:1750, cbm:50, volRemaining:1750,
   dateIn:'2026-03-04', dateOut:'2026-03-30', status:'out',
   billingType:'weekly', billingRate:120, billingUnit:'flat',
   inboundJobId:'J002', outboundJobId:'',
   containers:[
     {containerNo:'C021', locNo:'W02-A1', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C022', locNo:'W02-A2', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C023', locNo:'W02-A3', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C024', locNo:'W02-A4', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C025', locNo:'W02-A5', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C026', locNo:'W02-A6', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
     {containerNo:'C027', locNo:'W02-A7', type:'standard', volFt:250, maxFt:250, dateIn:'2026-03-04'},
   ],
   notes:'3-week storage between moves.',
   billingHistory:[{date:'2026-03-30', amt:360, desc:'3 weeks flat @ £120/week'}],
   accessLog:[{ts:'2026-03-09T10:22:00', date:'2026-03-09', type:'access', note:'Partial access — 2 boxes removed', volChange:0}]},
];
var storageFilter = 'all';
var storageSeq = 3;
var curStorageId = null;

function calcStorageMonthly(s) {
  if (!s || s.status !== 'active') return 0;
  if (s.billingUnit === 'cbm') return s.billingRate * (s.cbm || 0);
  if (s.billingType === 'weekly') return s.billingRate * 4.33;
  return s.billingRate;
}

function renderStorage() {
  var all = STORAGE_RECORDS;
  var shown = all.filter(function(s) {
    if (storageFilter === 'active')   return s.status === 'active';
    if (storageFilter === 'inout')    return s.type === 'inout';
    if (storageFilter === 'longterm') return s.type === 'longterm';
    return true;
  });

  var active    = all.filter(function(s){return s.status==='active';});
  var totalCBM  = active.reduce(function(a,s){return a+(s.cbm||0);},0);
  var monthlyRev= active.reduce(function(a,s){return a+calcStorageMonthly(s);},0);

  var h = '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:18px">';
  h += '<div class="fc"><div class="fc-body" style="padding:14px"><div class="fs-lbl">Active Records</div><div class="fs-num">'+active.length+'</div></div></div>';
  h += '<div class="fc"><div class="fc-body" style="padding:14px"><div class="fs-lbl">Total CBM In</div><div class="fs-num">'+totalCBM.toFixed(1)+'</div></div></div>';
  h += '<div class="fc"><div class="fc-body" style="padding:14px"><div class="fs-lbl">Est. Monthly Revenue</div><div class="fs-num">'+spv(fmt(monthlyRev))+'</div></div></div>';
  h += '<div class="fc"><div class="fc-body" style="padding:14px"><div class="fs-lbl">In/Out Jobs</div><div class="fs-num">'+all.filter(function(s){return s.type==='inout';}).length+'</div></div></div>';
  h += '</div>';

  if (!shown.length) {
    h += '<div style="text-align:center;padding:60px;color:var(--t3);font-size:14px">No storage records match this filter</div>';
    setH('storage-out', h);
    setBadge('storage-badge',active.length);
    return;
  }

  h += '<div class="fc"><div class="fc-head"><div class="fc-title">Storage Records</div></div>';
  h += '<div style="overflow-x:auto"><table class="sc-table"><thead><tr>';
  h += '<th>Ref</th><th>Client</th><th>Brand</th><th>Type</th><th>Containers</th><th>Vol In</th><th>Remaining</th><th>In</th><th>Out</th><th>Billing/period</th><th>Status</th><th></th>';
  h += '</tr></thead><tbody>';

  for (var i = 0; i < shown.length; i++) {
    var s = shown[i];
    var stCol = s.status==='active' ? 'var(--green)' : s.status==='out' ? 'var(--t3)' : 'var(--amber)';
    var effRate = s.billingUnit==='cbm' ? s.billingRate*(s.cbm||0) : s.billingRate;
    var bDesc = spv(fmt(effRate)) + '/' + s.billingType.replace('ly','');
    var sid = s.id;
    var ctrs = s.containers || [];
    var firstLocs = ctrs.slice(0,2).map(function(c){return c.containerNo;}).join(', ');
    var volRem = s.volRemaining !== undefined ? s.volRemaining : (s.volFt || 0);
    h += '<tr class="sr-row" data-sid="'+sid+'" style="cursor:pointer">';
    h += '<td style="font-weight:700;font-family:monospace">'+esc(sid)+'</td>';
    h += '<td style="font-weight:600">'+esc(s.client)+'</td>';
    h += '<td>'+bbadge(s.brand)+'</td>';
    h += '<td><span style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;padding:2px 6px;border-radius:3px;background:var(--s1);border:1px solid var(--b1)">'+(s.type==='inout'?'In/Out':'Long-term')+'</span></td>';
    h += '<td style="font-size:12px">'+(ctrs.length ? '<span style="font-family:monospace;font-weight:600">'+esc(firstLocs)+(ctrs.length>2?' +'+( ctrs.length-2)+'…':'')+'</span>' : '<span style="color:var(--t4)">TBA</span>')+'</td>';
    h += '<td>'+spv((s.volFt||0).toLocaleString()+' ft³')+'</td>';
    h += '<td style="font-weight:600;color:'+(volRem===0?'var(--t3)':'var(--green)')+'">'+volRem.toLocaleString()+' ft³</td>';
    h += '<td>'+fmtNice(s.dateIn)+'</td>';
    h += '<td>'+(s.dateOut ? fmtNice(s.dateOut) : '<span style="color:var(--green);font-size:11px;font-weight:600">In storage</span>')+'</td>';
    h += '<td style="font-size:12px">'+s.billingType+' &bull; '+bDesc+'</td>';
    h += '<td><span style="font-size:10.5px;font-weight:700;color:'+stCol+'">'+s.status.toUpperCase()+'</span></td>';
    h += '<td class="sr-edit-btn" data-sid="'+sid+'"><button class="btn btn-s btn-sm">Edit</button></td>';
    h += '</tr>';
  }
  h += '</tbody></table></div></div>';
  setH('storage-out', h);
  setBadge('storage-badge',active.length);

  // Attach row click events
  var rows = document.querySelectorAll('.sr-row');
  rows.forEach(function(row) {
    row.addEventListener('click', function(e) {
      if (e.target.closest && e.target.closest('.sr-edit-btn')) return;
      viewStorage(row.getAttribute('data-sid'));
    });
  });
  var editBtns = document.querySelectorAll('.sr-edit-btn');
  editBtns.forEach(function(cell) {
    cell.addEventListener('click', function(e) {
      e.stopPropagation();
      editStorage(cell.getAttribute('data-sid'));
    });
  });
}

function setStorageFilter(f, btn) {
  storageFilter = f;
  var tabs = document.querySelectorAll('#mod-storage .vt');
  tabs.forEach(function(t){ t.classList.remove('on'); });
  if (btn) btn.classList.add('on');
  renderStorage();
}

function viewStorage(id) {
  curStorageId = id;
  var s = null;
  for (var i=0;i<STORAGE_RECORDS.length;i++) if(STORAGE_RECORDS[i].id===id){s=STORAGE_RECORDS[i];break;}
  if (!s) return;

  var stCol = s.status==='active'?'var(--green)':s.status==='out'?'var(--t3)':'var(--amber)';
  var h = '<div class="fsec"><div class="fsec-t"><i>1</i>Details</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:11px">';
  h += '<div class="di"><div class="dlbl">Client</div><div class="dval" style="font-weight:600">'+esc(s.client)+'</div></div>';
  h += '<div class="di"><div class="dlbl">Brand</div><div class="dval">'+bbadge(s.brand)+'</div></div>';
  h += '<div class="di"><div class="dlbl">Type</div><div class="dval">'+(s.type==='inout'?'In/Out Job':'Long-term Storage')+'</div></div>';
  h += '<div class="di"><div class="dlbl">Status</div><div class="dval"><span style="font-weight:700;text-transform:uppercase;font-size:11px;color:'+stCol+'">'+s.status+'</span></div></div>';
  h += '<div class="di"><div class="dlbl">Volume In</div><div class="dval">'+spv((s.volFt||0).toLocaleString()+' ft³ / '+(s.cbm||0).toFixed(1)+' CBM')+'</div></div>';
  h += '<div class="di"><div class="dlbl">Volume Remaining</div><div class="dval" style="color:var(--green);font-weight:700">'+(s.volRemaining!==undefined?s.volRemaining:(s.volFt||0))+' ft³</div></div>';
  h += '<div class="di"><div class="dlbl">Date In</div><div class="dval" style="color:var(--blue);font-weight:700">'+fmtNice(s.dateIn)+'</div></div>';
  h += '<div class="di"><div class="dlbl">Date Out</div><div class="dval">'+(s.dateOut?('<span style="font-weight:700">'+fmtNice(s.dateOut)+'</span>'):'<span style="color:var(--green);font-weight:600">Still in storage</span>')+'</div></div>';
  if (s.eventualDest) h += '<div class="di" style="grid-column:span 2"><div class="dlbl">Eventual Destination</div><div class="dval" style="color:var(--blue);font-weight:600">📍 '+esc(s.eventualDest)+'</div></div>';
  h += '</div></div>';

  // Containers
  var containers = s.containers || [];
  h += '<div class="fsec"><div class="fsec-t"><i>2</i>Containers &amp; Locations</div>';
  if (containers.length) {
    h += '<div style="overflow-x:auto"><table class="sc-table" style="font-size:12px"><thead><tr><th>Container No.</th><th>Location</th><th>Type</th><th>Volume ft³</th><th>Date In</th></tr></thead><tbody>';
    for (var ci2=0;ci2<containers.length;ci2++) {
      var ct2 = containers[ci2];
      var ctDef = CONTAINER_TYPES.filter(function(x){return x.key===ct2.type;})[0];
      var ctLbl = ctDef ? ctDef.lbl : ct2.type;
      var overFill = ctDef && ctDef.maxFt && ct2.volFt > ctDef.maxFt;
      h += '<tr>';
      h += '<td style="font-family:monospace;font-weight:700">'+esc(ct2.containerNo)+'</td>';
      h += '<td style="font-family:monospace">'+esc(ct2.locNo)+'</td>';
      h += '<td>'+esc(ctLbl)+'</td>';
      h += '<td style="font-weight:600'+(overFill?';color:#E44258':'')+'">'+ct2.volFt+(overFill?' ⚠ over max ('+ctDef.maxFt+')':'')+'</td>';
      h += '<td>'+fmtNice(ct2.dateIn)+'</td>';
      h += '</tr>';
    }
    h += '</tbody></table></div>';
    h += '<button class="btn btn-s btn-sm" style="margin-top:8px" id="btn-add-container">+ Add Container</button>';
  } else {
    h += '<div style="color:#7A849E;font-size:12px;padding:8px 0">No containers assigned yet — will be assigned when goods arrive at warehouse.</div>';
    h += '<button class="btn btn-s btn-sm" id="btn-add-container">+ Add Container</button>';
  }
  h += '</div>';

  var effRate = s.billingUnit==='cbm' ? s.billingRate*(s.cbm||0) : s.billingRate;
  h += '<div class="fsec"><div class="fsec-t"><i>3</i>Billing</div>';
  h += '<div class="brow"><span class="blbl">Rate model</span><span class="bamt" style="font-size:12px">'+esc(s.billingType)+' &times; '+(s.billingUnit==='cbm'?'CBM':'flat')+'</span></div>';
  h += '<div class="brow"><span class="blbl">Unit rate</span><span class="bamt">'+spv('£'+s.billingRate+' per '+(s.billingUnit==='cbm'?'CBM/'+s.billingType:s.billingType))+'</span></div>';
  if (s.billingUnit==='cbm') h += '<div class="brow"><span class="blbl">Effective '+s.billingType+' charge</span><span class="bamt">'+spv(fmt(effRate))+'</span></div>';
  if (s.billingHistory && s.billingHistory.length) {
    h += '<div style="margin-top:10px"><div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--t3);margin-bottom:6px">Billing History</div>';
    for (var k=0;k<s.billingHistory.length;k++) {
      var bh = s.billingHistory[k];
      h += '<div class="brow"><span class="blbl">'+esc(bh.date)+' — '+esc(bh.desc)+'</span><span class="bamt">'+spv(fmt(bh.amt))+'</span></div>';
    }
    h += '</div>';
  }
  h += '</div>';

  // Access log — now with types and timestamps
  h += '<div class="fsec"><div class="fsec-t"><i>4</i>Movement &amp; Access Log</div>';
  if (s.accessLog && s.accessLog.length) {
    for (var k2=0;k2<s.accessLog.length;k2++) {
      var al = s.accessLog[k2];
      var alIcon = al.type==='inbound'?'⬇️':al.type==='outbound'?'⬆️':'📋';
      var alTime = al.ts ? ' <span style="font-size:10px;color:var(--t4)">'+al.ts.replace('T',' ').slice(0,16)+'</span>' : '';
      h += '<div class="brow" style="align-items:flex-start">';
      h += '<span class="blbl" style="font-size:11px">'+alIcon+' '+esc(al.date)+alTime+'</span>';
      h += '<span style="font-size:11.5px;color:var(--t2);max-width:55%;text-align:right">'+esc(al.note)+'</span>';
      h += '</div>';
    }
  } else {
    h += '<div style="color:var(--t3);font-size:12px;padding:6px 0">No movements recorded yet</div>';
  }
  h += '<div style="margin-top:8px"><button class="btn btn-s btn-sm" id="btn-access-log">+ Log Manual Entry</button></div>';
  h += '</div>';

  if (s.notes) h += '<div class="fsec"><div class="fsec-t">Notes</div><div style="background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:10px;font-size:12.5px;color:var(--t2);line-height:1.7">'+esc(s.notes)+'</div></div>';

  el('p-title').textContent = s.client;
  el('p-sub').textContent = s.brand + ' · ' + s.id;
  setH('p-body', h);

  var footHtml = '<button class="btn btn-s" onclick="closePanel()">Close</button>';
  if (s.status === 'active') {
    footHtml += '<button class="btn btn-p" id="btn-book-delivery" style="background:var(--green);border-color:var(--green)">📦 Book Delivery</button>';
  }
  footHtml += '<button class="btn btn-s" id="btn-edit-storage">Edit</button>';
  setH('p-foot', footHtml);
  openPanel();

  // Attach events after render
  var editBtn = document.getElementById('btn-edit-storage');
  if (editBtn) editBtn.addEventListener('click', function(){ editStorage(id); });
  var bookBtn = document.getElementById('btn-book-delivery');
  if (bookBtn) bookBtn.addEventListener('click', function(){ whBookDelivery(id); });
  var accessBtn = document.getElementById('btn-access-log');
  if (accessBtn) accessBtn.addEventListener('click', function(){ addStorageAccess(id); });
  var addCtnrBtn = document.getElementById('btn-add-container');
  if (addCtnrBtn) addCtnrBtn.addEventListener('click', function(){ addStorageContainer(id); });
}

function addStorageAccess(id) {
  var note = prompt('Manual access/note (e.g. "Client collected 3 boxes — approx 45ft³"):');
  if (!note) return;
  var rec = null;
  for (var i=0;i<STORAGE_RECORDS.length;i++) if(STORAGE_RECORDS[i].id===id){rec=STORAGE_RECORDS[i];break;}
  if (!rec) return;
  if (!rec.accessLog) rec.accessLog = [];
  var ts = new Date().toISOString();
  rec.accessLog.push({ts:ts, date:ts.slice(0,10), type:'manual', note:note, volChange:0});
  toast('Access entry logged');
  viewStorage(id);
}

function addStorageContainer(id) {
  var rec = null;
  for (var i=0;i<STORAGE_RECORDS.length;i++) if(STORAGE_RECORDS[i].id===id){rec=STORAGE_RECORDS[i];break;}
  if (!rec) return;
  if (!rec.containers) rec.containers = [];

  // Build a small inline form in the panel
  var ctTypeOpts = CONTAINER_TYPES.map(function(ct){
    return '<option value="'+ct.key+'">'+ct.lbl+'</option>';
  }).join('');
  var fh = '<div class="fsec"><div class="fsec-t">Add Container / Unit</div>';
  fh += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
  fh += '<div class="fg"><label class="lbl">Container No.</label><input class="fi" id="nctr-no" placeholder="e.g. C049"></div>';
  fh += '<div class="fg"><label class="lbl">Location No.</label><input class="fi" id="nctr-loc" placeholder="e.g. W03-B9"></div>';
  fh += '<div class="fg"><label class="lbl">Type</label><select class="fi" id="nctr-type">'+ctTypeOpts+'</select></div>';
  fh += '<div class="fg"><label class="lbl">Volume ft³</label><input class="fi" type="number" id="nctr-vol" placeholder="0" min="0"></div>';
  fh += '</div></div>';

  el('p-title').textContent = 'Add Container — ' + id;
  el('p-sub').textContent = rec.client;
  setH('p-body', fh);
  setH('p-foot', '<button class="btn btn-s" onclick="viewStorage(\''+id+'\')">Cancel</button><button class="btn btn-p" id="btn-save-container">Add Container</button>');
  var saveBtn = document.getElementById('btn-save-container');
  if (saveBtn) saveBtn.addEventListener('click', function(){
    var cno   = (el('nctr-no')||{}).value||'';
    var loc   = (el('nctr-loc')||{}).value||'';
    var ctype = (el('nctr-type')||{}).value||'standard';
    var vol   = parseFloat((el('nctr-vol')||{}).value)||0;
    if (!cno) { toast('Container number required'); return; }
    var ctDef = CONTAINER_TYPES.filter(function(x){return x.key===ctype;})[0];
    var maxFt = ctDef ? ctDef.maxFt : null;
    if (maxFt && vol > maxFt) {
      if (!confirm('Warning: ' + vol + ' ft³ exceeds max capacity of ' + maxFt + ' ft³ for a ' + ctDef.lbl + '. Add anyway?')) return;
    }
    rec.containers.push({containerNo:cno, locNo:loc, type:ctype, volFt:vol, maxFt:maxFt, dateIn:d2s(new Date())});
    // Log it
    var ts2 = new Date().toISOString();
    if (!rec.accessLog) rec.accessLog = [];
    rec.accessLog.push({ts:ts2, date:ts2.slice(0,10), type:'container-add',
      note:'Container '+cno+' added — Location '+loc+' ('+ctype+', '+vol+' ft³).',
      volChange:vol});
    // Update volRemaining if it was undefined
    if (rec.volRemaining === undefined) rec.volRemaining = rec.volFt || 0;
    toast('Container ' + cno + ' added'); saveData('storage', s.id, s);
    viewStorage(id);
  });
}

function newStorageRecord() {
  var id = 'S' + String(100+storageSeq++).slice(-3);
  STORAGE_RECORDS.push({
    id:id, type:'longterm', client:'', brand:BRANDS[0]||'',
    volFt:0, cbm:0, volRemaining:0,
    dateIn:d2s(new Date()), dateOut:'', status:'active',
    billingType:'monthly', billingRate:85, billingUnit:'cbm',
    inboundJobId:'', outboundJobId:'',
    containers:[], notes:'', billingHistory:[], accessLog:[]
  });
  editStorage(id);
}

function editStorage(id) {
  var s = null;
  for (var i=0;i<STORAGE_RECORDS.length;i++) if(STORAGE_RECORDS[i].id===id){s=STORAGE_RECORDS[i];break;}
  if (!s) return;

  var h = '<div class="fsec"><div class="fsec-t">Storage Details</div>';
  h += '<div class="fg2">';
  h += '<div class="fg"><label class="lbl">Client</label><input class="fi" id="st-cl" value="'+esc(s.client)+'"></div>';
  h += '<div class="fg"><label class="lbl">Brand</label><select class="fi" id="st-br">'+BRANDS.map(function(b){return '<option'+(b===s.brand?' selected':'')+'>'+b+'</option>';}).join('')+'</select></div>';
  h += '</div><div class="fg2">';
  h += '<div class="fg"><label class="lbl">Type</label><select class="fi" id="st-ty"><option value="longterm"'+(s.type==='longterm'?' selected':'')+'>Long-term</option><option value="inout"'+(s.type==='inout'?' selected':'')+'>In/Out</option></select></div>';
  h += '<div class="fg"><label class="lbl">Bay / Unit</label><input class="fi" id="st-bay" value="'+esc(s.bay||'')+'"></div>';
  h += '</div><div class="fg2">';
  h += '<div class="fg"><label class="lbl">Volume ft³</label><input class="fi" type="number" id="st-vft" value="'+(s.volFt||0)+'"></div>';
  h += '<div class="fg"><label class="lbl">CBM</label><input class="fi" type="number" id="st-cbm" value="'+(s.cbm||0)+'" step="0.01"></div>';
  h += '</div><div class="fg2">';
  h += '<div class="fg"><label class="lbl">Date In</label><input class="fi" type="date" id="st-in" value="'+esc(s.dateIn)+'"></div>';
  h += '<div class="fg"><label class="lbl">Date Out</label><input class="fi" type="date" id="st-out" value="'+esc(s.dateOut||'')+'"></div>';
  h += '</div><div class="fg2">';
  h += '<div class="fg"><label class="lbl">Billing Period</label><select class="fi" id="st-bty"><option'+(s.billingType==='monthly'?' selected':'')+'>monthly</option><option'+(s.billingType==='weekly'?' selected':'')+'>weekly</option><option'+(s.billingType==='flat'?' selected':'')+'>flat</option></select></div>';
  h += '<div class="fg"><label class="lbl">Rate Unit</label><select class="fi" id="st-bu"><option value="cbm"'+(s.billingUnit==='cbm'?' selected':'')+'>Rate × CBM</option><option value="flat"'+(s.billingUnit==='flat'?' selected':'')+'>Flat rate</option></select></div>';
  h += '</div><div class="fg2">';
  h += '<div class="fg"><label class="lbl">Rate £</label><input class="fi" type="number" id="st-rate" value="'+(s.billingRate||0)+'" step="0.01"></div>';
  h += '<div class="fg"><label class="lbl">Status</label><select class="fi" id="st-st"><option'+(s.status==='active'?' selected':'')+'>active</option><option'+(s.status==='pending'?' selected':'')+'>pending</option><option'+(s.status==='out'?' selected':'')+'>out</option></select></div>';
  h += '</div>';
  h += '<div class="fg"><label class="lbl">Notes</label><textarea class="fi" id="st-no" style="height:70px;resize:vertical">'+esc(s.notes||'')+'</textarea></div>';
  h += '</div>';

  el('p-title').textContent = id;
  el('p-sub').textContent = 'Storage Record';
  setH('p-body', h);
  setH('p-foot', '<button class="btn btn-del btn-sm" id="btn-del-storage">Delete</button><button class="btn btn-s" onclick="closePanel()">Cancel</button><button class="btn btn-p" id="btn-save-storage">Save</button>');
  openPanel();

  var saveBtn = document.getElementById('btn-save-storage');
  if (saveBtn) saveBtn.addEventListener('click', function(){ saveStorage(id); });
  var delBtn = document.getElementById('btn-del-storage');
  if (delBtn) delBtn.addEventListener('click', function(){ delStorage(id); });
}

function saveStorage(id) {
  for (var i=0;i<STORAGE_RECORDS.length;i++) {
    if (STORAGE_RECORDS[i].id !== id) continue;
    var s = STORAGE_RECORDS[i];
    s.client   = (el('st-cl')||{value:s.client}).value || s.client;
    s.brand    = (el('st-br')||{value:s.brand}).value || s.brand;
    s.type     = (el('st-ty')||{value:s.type}).value || s.type;
    s.bay      = (el('st-bay')||{value:''}).value || '';
    s.volFt    = parseFloat((el('st-vft')||{value:0}).value) || 0;
    s.cbm      = parseFloat((el('st-cbm')||{value:0}).value) || 0;
    s.dateIn   = (el('st-in')||{value:s.dateIn}).value || s.dateIn;
    s.dateOut  = (el('st-out')||{value:''}).value || '';
    s.billingType = (el('st-bty')||{value:s.billingType}).value || s.billingType;
    s.billingUnit = (el('st-bu')||{value:s.billingUnit}).value || s.billingUnit;
    s.billingRate = parseFloat((el('st-rate')||{value:0}).value) || 0;
    s.status   = (el('st-st')||{value:s.status}).value || s.status;
    s.notes    = (el('st-no')||{value:''}).value || '';
    break;
  }
  closePanel();
  renderStorage();
  toast('Storage saved'); saveData('storage', s.id, s);
}

function delStorage(id) {
  if (!confirm('Delete storage record ' + id + '?')) return;
  STORAGE_RECORDS = STORAGE_RECORDS.filter(function(r){ return r.id !== id; });
  closePanel();
  renderStorage();
  deleteData('storage', id);
}



// ── BOOKING MODULE ────────────────────────────────────────────────────
var bookings = [];
var SURVEYS  = [];   // standalone survey records
var bkSeq = 142; // next sequential number
var curBkId = null;
var bkMode = 'none'; // 'new' | 'edit' | 'view'

// SocketLabs config — user fills these in Settings
var SL_CONFIG = {
  serverId: '',
  apiKey: '',
  fromEmail: 'bookings@yourcompany.com',
  fromName: 'OPS Manager',
  companyName: 'Your Removals Company',
  companyPhone: '0800 000 0000',
  companyEmail: 'info@yourcompany.com',
  companyPostcode: 'WN73EQ',  // Origin postcode for mileage calculations
};

// ── App-wide cost of sale + maps settings ─────────────────────────────
var APP_SETTINGS = {
  googleMapsKey:    '',            // Google Maps Platform API key
  warehouseAddress: 'WN7 3EQ',    // Full address / postcode of warehouse
  cosPerCrewPerDay: 125,           // £ generic COS per crew member per day
  returnMileage:    true,          // Auto-add return-to-warehouse leg
  fuelPricePerLitre:1.49,         // Pence per litre (for reference / display)
};

// ── VEHICLES ──────────────────────────────────────────────────────────
var VEHICLES = [
  {id:'V001',name:'Luton 1',reg:'PO23 YDN',colour:'White',type:'Luton',length:4.2,width:2.1,height:2.2,volCapFt:850,mileRate:0.35,dayRate:120},
  {id:'V002',name:'Luton 2',reg:'PO23 YDM',colour:'White',type:'Luton',length:4.2,width:2.1,height:2.2,volCapFt:850,mileRate:0.35,dayRate:120},
  {id:'V003',name:'7.5T Lorry',reg:'PO23 YDP',colour:'White',type:'7.5T',length:6.5,width:2.4,height:2.6,volCapFt:1750,mileRate:0.52,dayRate:185},
];

// ── MATERIALS ─────────────────────────────────────────────────────────
var MATERIALS = [
  {id:'M001',name:'2 cu.ft Carton',type:'Carton',unitCost:0.95},
  {id:'M002',name:'4 cu.ft Carton',type:'Carton',unitCost:1.20},
  {id:'M003',name:'6 cu.ft Carton',type:'Carton',unitCost:1.95},
  {id:'M004',name:'Layflat Carton',type:'Carton',unitCost:2.20},
  {id:'M005',name:'Wardrobe Carton',type:'Carton',unitCost:6.00},
];

// ── CHARGES ───────────────────────────────────────────────────────────
var CHARGES = [
  {id:'C001',name:'Toll Road',defaultAmt:12,perUnit:false},
  {id:'C002',name:'Clean Air Zone',defaultAmt:150,perUnit:false},
  {id:'C003',name:'Permit Charge',defaultAmt:20,perUnit:false},
  {id:'C004',name:'Parking Charge',defaultAmt:6,perUnit:false},
];

function genRef() {
  var n = bkSeq++;
  return 'BOK-' + (n < 10 ? '0000' : n < 100 ? '000' : n < 1000 ? '00' : n < 10000 ? '0' : '') + n;
}

function bkStatusCls(s) {
  if (s === 'Confirmed') return 'bst-confirmed';
  if (s === 'Email Sent') return 'bst-sent';
  return 'bst-pending';
}


// ══════════════════════════════════════════════════════════════════════
// SURVEY MODULE
// ══════════════════════════════════════════════════════════════════════
var curSurveyId = null;

function openNewSurvey(prefill) {
  curSurveyId = null;
  el('survey-modal-title').textContent = 'New Survey';
  el('survey-modal-ref').textContent = '';
  renderSurveyForm(prefill || {});
  el('survey-backdrop').style.display = 'flex';
}

function openEditSurvey(id) {
  var sv = SURVEYS.filter(function(s){ return s.id === id; })[0];
  if (!sv) return;
  curSurveyId = id;
  el('survey-modal-title').textContent = 'Edit Survey';
  el('survey-modal-ref').textContent = sv.ref || '';
  renderSurveyForm(sv);
  el('survey-backdrop').style.display = 'flex';
}

function closeSurveyModal() {
  el('survey-backdrop').style.display = 'none';
}

function renderSurveyForm(sv) {
  sv = sv || {};
  var h = '';

  // Brand + channel
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">';
  h += '<div><label class="lbl">Brand / Partner</label><select class="fi" id="sv-brand">';
  BRANDS.forEach(function(b){ h += '<option'+(b===(sv.brand||BRANDS[0])?' selected':'')+'>'+b+'</option>'; });
  h += '</select></div>';
  h += '<div><label class="lbl">Job Type</label><select class="fi" id="sv-jobtype">';
  ['Door to Door','Domestic','European','Sea','Air','Storage','Other'].forEach(function(t){
    h += '<option'+(t===(sv.jobType||'Door to Door')?' selected':'')+'>'+t+'</option>';
  });
  h += '</select></div>';
  h += '</div>';

  // Client name
  h += '<div style="margin-bottom:12px"><label class="lbl">Client Name</label>';
  h += '<input class="fi" id="sv-client" value="'+esc(sv.clientName||'')+'" placeholder="Full name"></div>';

  // Address/postcode
  h += '<div style="margin-bottom:12px"><label class="lbl">Survey Address / Postcode</label>';
  h += '<input class="fi" id="sv-postcode" value="'+esc(sv.postcode||'')+'" placeholder="e.g. SW1A 1AA or full address" autocomplete="off"></div>';

  // Date + time
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">';
  h += '<div><label class="lbl">Survey Date</label><input type="date" class="fi" id="sv-date" value="'+esc(sv.surveyDate||'')+'"></div>';
  h += '<div><label class="lbl">Time</label><input type="time" class="fi" id="sv-time" value="'+esc(sv.surveyTime||'')+'"></div>';
  h += '</div>';

  // Surveyor (from crew list, or free text)
  h += '<div style="margin-bottom:12px"><label class="lbl">Surveyor</label><select class="fi" id="sv-surveyor">';
  h += '<option value="">— Unassigned —</option>';
  CREW.forEach(function(c){ h += '<option'+(c.name===(sv.surveyor||'')?' selected':'')+'>'+c.name+'</option>'; });
  h += '</select></div>';

  // Status
  h += '<div style="margin-bottom:12px"><label class="lbl">Status</label><select class="fi" id="sv-status">';
  ['Scheduled','Completed','No Show','Cancelled'].forEach(function(s){
    h += '<option'+(s===(sv.status||'Scheduled')?' selected':'')+'>'+s+'</option>';
  });
  h += '</select></div>';

  // Notes
  h += '<div><label class="lbl">Notes (access, contact, special instructions)</label>';
  h += '<textarea class="fi" id="sv-notes" rows="3" style="resize:vertical">'+esc(sv.notes||'')+'</textarea></div>';

  el('survey-form-body').innerHTML = h;

  // Bind address autocomplete to postcode field
  setTimeout(function(){
    var pcEl = document.getElementById('sv-postcode');
    if (pcEl && !pcEl._addrBound) bindAddressField(pcEl);
  }, 60);
}

function saveSurvey() {
  var client = (el('sv-client')||{}).value.trim();
  var date   = (el('sv-date')||{}).value;
  if (!client) { toast('Client name is required'); return; }
  if (!date)   { toast('Survey date is required'); return; }

  var sv = {
    id:         curSurveyId || ('SV' + Date.now()),
    ref:        'SV-' + String(SURVEYS.length + 1).padStart(4,'0'),
    brand:      (el('sv-brand')||{}).value || BRANDS[0],
    jobType:    (el('sv-jobtype')||{}).value || 'Door to Door',
    clientName: client,
    postcode:   (el('sv-postcode')||{}).value.trim(),
    surveyDate: date,
    surveyTime: (el('sv-time')||{}).value,
    surveyor:   (el('sv-surveyor')||{}).value,
    status:     (el('sv-status')||{}).value || 'Scheduled',
    notes:      (el('sv-notes')||{}).value.trim(),
    createdAt:  curSurveyId
                  ? (SURVEYS.filter(function(s){return s.id===curSurveyId;})[0]||{}).createdAt || new Date().toISOString()
                  : new Date().toISOString(),
    updatedAt:  new Date().toISOString(),
  };

  if (curSurveyId) {
    var idx = SURVEYS.findIndex ? SURVEYS.findIndex(function(s){return s.id===curSurveyId;})
                                : (function(){ for(var i=0;i<SURVEYS.length;i++) if(SURVEYS[i].id===curSurveyId) return i; return -1; })();
    if (idx >= 0) SURVEYS[idx] = sv; else SURVEYS.push(sv);
  } else {
    SURVEYS.push(sv);
  }

  saveData('survey', sv.id, sv);
  closeSurveyModal();
  toast('Survey saved — ' + sv.clientName + ' on ' + fmtNice(sv.surveyDate));
  renderBkSurveyList();
  // Refresh calendar if open
  if (curMod === 'calendar') renderActiveMod();
  if (curMod === 'dashboard') renderDashboard();
}

function deleteSurvey(id) {
  if (!confirm('Delete this survey?')) return;
  SURVEYS = SURVEYS.filter(function(s){ return s.id !== id; });
  // Note: no delete API yet, but save empty replacement
  saveData('settings'); // trigger save cycle
  renderBkSurveyList();
  toast('Survey deleted');
}

function renderBkSurveyList() {
  var container = el('bk-survey-list');
  if (!container) return;

  var sorted = SURVEYS.slice().sort(function(a,b){ return a.surveyDate < b.surveyDate ? -1 : 1; });
  var now = d2s(new Date());
  var upcoming = sorted.filter(function(s){ return s.surveyDate >= now; });
  var past     = sorted.filter(function(s){ return s.surveyDate < now; });

  var h = '';
  if (!sorted.length) {
    h = '<div style="padding:20px;text-align:center;color:var(--t3);font-size:12px">No surveys yet.<br>Click + New Survey to add one.</div>';
    container.innerHTML = h;
    return;
  }

  function renderSurveyRow(sv) {
    var stCol = {'Scheduled':'var(--blue)','Completed':'var(--green)','No Show':'var(--red)','Cancelled':'var(--t3)'}[sv.status]||'var(--t3)';
    var out = '<div style="padding:9px 12px;border-bottom:1px solid var(--s2);display:flex;gap:10px;align-items:flex-start;cursor:pointer" data-svid="'+sv.id+'" onclick="openEditSurvey(this.dataset.svid)">';
    out += '<div style="flex:1;min-width:0">';
    out += '<div style="font-weight:700;font-size:12.5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(sv.clientName)+'</div>';
    out += '<div style="font-size:11px;color:var(--t3);margin-top:1px">'+esc(sv.brand)+' &middot; '+esc(sv.jobType)+'</div>';
    out += '<div style="font-size:11px;color:var(--t2);margin-top:2px">'+esc(sv.postcode||'')+(sv.surveyor?' &middot; '+esc(sv.surveyor):'')+'</div>';
    out += '</div>';
    out += '<div style="text-align:right;flex-shrink:0">';
    out += '<div style="font-size:11.5px;font-weight:700;color:var(--t1)">'+fmtNice(sv.surveyDate)+'</div>';
    out += '<div style="font-size:10px;margin-top:2px">'+(sv.surveyTime||'')+'</div>';
    out += '<div style="font-size:10px;font-weight:700;color:'+stCol+';margin-top:3px">'+sv.status+'</div>';
    out += '</div>';
    out += '</div>';
    return out;
  }

  if (upcoming.length) {
    h += '<div style="padding:6px 12px 4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)">Upcoming</div>';
    upcoming.forEach(function(sv){ h += renderSurveyRow(sv); });
  }
  if (past.length) {
    h += '<div style="padding:6px 12px 4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3)">Past</div>';
    past.slice(0, 20).forEach(function(sv){ h += renderSurveyRow(sv); });
  }
  container.innerHTML = h;
}


function initBookingMod() {
  renderBkList();
  renderBkSurveyList();
}

function renderBkList() {
  var h = '';
  if (!bookings.length) {
    h = '<div style="padding:30px 16px;text-align:center;color:var(--t3);font-size:12px">No bookings yet.<br>Click + New Booking to start.</div>';
  } else {
    for (var i = bookings.length - 1; i >= 0; i--) {
      var b = bookings[i];
      var color = BC[b.brand] || '#888';
      h += '<div class="bk-item' + (b.id === curBkId ? ' on' : '') + '" onclick="viewBooking(\'' + b.id + '\')">';
      h += '<div class="bk-dot" style="background:' + color + '"></div>';
      h += '<div style="flex:1;min-width:0">';
      h += '<div class="bk-ref">' + b.ref + '</div>';
      h += '<div class="bk-client">' + esc(b.clientName) + '</div>';
      h += '<div class="bk-meta">' + b.startDate + ' &bull; ' + esc(b.origin) + '</div>';
      h += '<div style="margin-top:4px"><span class="bst ' + bkStatusCls(b.status) + '">' + b.status + '</span></div>';
      h += '</div></div>';
    }
  }
  setH('bk-list', h);
  setBadge('bk-badge',bookings.length);
}

function newBooking() {
  openConfigurator(null);
}

function viewBooking(id) {
  var b = bookings.filter(function(x) { return x.id === id; })[0];
  if (!b) return;
  curBkId = id;
  bkMode = 'view';
  renderBkList();
  el('bk-right-title').innerHTML = '<span class="ref-badge">' + b.ref + '</span> &nbsp;' + esc(b.clientName);
  setH('bk-right-actions',
    '<button class="btn btn-s btn-sm" onclick="editBooking(\'' + id + '\')">&#9998; Edit</button>' +
    '<button class="btn btn-p btn-sm" onclick="showEmailPreview(\'' + id + '\')">&#9993; Send Confirmation</button>'
  );
  renderBookingDetail(b);
}

function editBooking(id) {
  openConfigurator(id);
}

function renderBookingDetail(b) {
  var color = BC[b.brand] || '#888';
  var h = '<div class="fade-in">';

  // Header card
  h += '<div class="bf-section" style="border-left:4px solid ' + color + '">';
  h += '<div class="bf-body" style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px">';
  h += '<div class="di"><div class="dlbl">Brand</div><div class="dval">' + bbadge(b.brand) + '</div></div>';
  h += '<div class="di"><div class="dlbl">Status</div><div class="dval"><span class="bst ' + bkStatusCls(b.status) + '">' + b.status + '</span></div></div>';
  h += '<div class="di"><div class="dlbl">Ref</div><div class="dval"><span class="ref-badge">' + b.ref + '</span></div></div>';
  h += '<div class="di"><div class="dlbl">Client</div><div class="dval" style="font-weight:600">' + esc(b.clientName) + '</div></div>';
  h += '<div class="di"><div class="dlbl">Client Email</div><div class="dval" style="color:var(--blue)">' + esc(b.clientEmail) + '</div></div>';
  h += '<div class="di"><div class="dlbl">Client Phone</div><div class="dval">' + esc(b.clientPhone) + '</div></div>';
  h += '</div></div>';

  // Move details
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">2</div><div class="bf-sec-title">Move Details</div></div>';
  h += '<div class="bf-body" style="display:grid;grid-template-columns:1fr 1fr;gap:14px">';
  h += '<div class="di"><div class="dlbl">Start Date</div><div class="dval" style="color:var(--blue);font-weight:600">' + fmtNice(b.startDate) + '</div></div>';
  h += '<div class="di"><div class="dlbl">End Date</div><div class="dval" style="color:var(--blue);font-weight:600">' + (b.endDate !== b.startDate ? fmtNice(b.endDate) : 'Same day') + '</div></div>';
  h += '<div class="di"><div class="dlbl">Origin</div><div class="dval">' + esc(b.origin) + '</div></div>';
  h += '<div class="di"><div class="dlbl">Destination</div><div class="dval">' + esc(b.dest) + '</div></div>';
  h += '<div class="di"><div class="dlbl">Volume</div><div class="dval">' + (b.volume ? b.volume + ' ft³' : '&mdash;') + '</div></div>';
  h += '<div class="di"><div class="dlbl">CBM</div><div class="dval">' + (b.cbm ? b.cbm : '&mdash;') + '</div></div>';
  h += '</div></div>';

  // Billing
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">3</div><div class="bf-sec-title">Billing</div></div>';
  h += '<div class="bf-body">';
  if (b.billing && b.billing.length) {
    for (var k = 0; k < b.billing.length; k++) {
      h += '<div class="brow"><span class="blbl">' + esc(b.billing[k].item) + '</span><span class="bamt">' + (b.billing[k].amt > 0 ? fmt(b.billing[k].amt) : 'TBC') + '</span></div>';
    }
    var bTot = b.billing.reduce(function(s, x) { return s + x.amt; }, 0);
    h += '<div class="btotal"><span>Total Revenue</span><span style="color:var(--blue)">' + fmt(bTot) + '</span></div>';
  } else {
    h += '<span style="color:var(--t3);font-size:12px">No billing lines added</span>';
  }
  h += '</div></div>';

  // Cost & Margin
  var bkRev  = bkTotalRevenue(b);
  var bkCrew = bkCrewCost(b);
  var bkFuel = bkFuelCost(b);
  var bkRetF = bkReturnFuelCost(b);
  var bkVeh  = bkVehicleCost(b);
  var bkMat  = bkMaterialCost(b);
  var bkChg  = bkChargeCost(b);
  var bkOvhd = bkCosOverhead(b);
  var bkCOS  = bkCrew + bkFuel + bkRetF + bkVeh + bkMat + bkChg + bkOvhd;
  var bkMgn  = bkRev > 0 ? bkRev - bkCOS : null;
  var bkMpct = bkRev > 0 ? (bkMgn / bkRev) * 100 : null;
  var bkMcol = bkMpct === null ? 'var(--t3)' : bkMpct >= 30 ? 'var(--green)' : bkMpct >= 15 ? 'var(--amber)' : 'var(--red)';
  var bkDurD = Math.max(1, Math.round((s2d(b.endDate) - s2d(b.startDate)) / 864e5) + 1);
  var bkIsOvernight = bkDurD > 1;

  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">4</div>';
  h += '<div class="bf-sec-title">Cost &amp; Margin</div>';
  if (bkMpct !== null) h += '<span style="font-size:22px;font-weight:700;color:' + bkMcol + '">' + bkMpct.toFixed(1) + '%</span>';
  h += '</div><div class="bf-body">';
  h += '<div style="display:grid;grid-template-columns:1fr 190px;gap:16px">';

  // Left: itemised COS
  h += '<div>';
  var j2 = jobs.filter(function(x) { return x.id === b.id; })[0];
  var detCrew = j2 ? j2.drivers.concat(j2.porters).filter(function(x){return x;}) : [];

  // ── Human Resources ──
  if (detCrew.length) {
    h += '<div class="cos-section-head">👷 Human Resources</div>';
    for (var k = 0; k < detCrew.length; k++) {
      var cr2 = crewByName(detCrew[k]);
      if (cr2) {
        var bd2 = crewNotionalBreakdown(cr2, bkDurD);
        var pid2 = 'bk-'+b.id+'-cr-'+k;
        h += '<div class="cb-row"><span style="color:var(--t2)">' + esc(detCrew[k]) + ' &times; ' + bkDurD + 'd @ ' + spv('&pound;'+crewNotionalRate(cr2).toFixed(2)+'/day', 'bkrate-'+pid2) + '</span><span style="color:var(--red)">' + spv(fmt(bd2.total), 'bkcc-'+pid2) + '</span></div>';
        if (cr2.employed) {
          if (bd2.holAmt>0) h += '<div class="cb-row" style="padding-left:14px"><span style="color:var(--t3);font-size:11px">Holiday ('+cr2.holiday+'%)</span><span style="color:var(--t3);font-size:11px">' + spv(fmt(bd2.holAmt), 'bkhl-'+pid2) + '</span></div>';
          if (bd2.niAmt>0)  h += '<div class="cb-row" style="padding-left:14px"><span style="color:var(--t3);font-size:11px">Employer NI ('+cr2.ni+'%)</span><span style="color:var(--t3);font-size:11px">' + spv(fmt(bd2.niAmt), 'bkni-'+pid2) + '</span></div>';
          if (bd2.penAmt>0) h += '<div class="cb-row" style="padding-left:14px"><span style="color:var(--t3);font-size:11px">Pension ('+cr2.pension+'%)</span><span style="color:var(--t3);font-size:11px">' + spv(fmt(bd2.penAmt), 'bkpen-'+pid2) + '</span></div>';
        }
      }
    }
  }

  // ── Vehicles ──
  var detVehs = b.vehicles || (j2 ? (j2.veh||[]).map(function(r){var v=VEHICLES.filter(function(x){return x.reg===r||x.name===r;})[0]; return v?{id:v.id}:null;}).filter(Boolean) : []);
  if (detVehs.length) {
    h += '<div class="cos-section-head">🚛 Vehicles</div>';
    for (var k = 0; k < detVehs.length; k++) {
      var dv = VEHICLES.filter(function(x){return x.id===detVehs[k].id;})[0];
      if (dv) h += '<div class="cb-row"><span style="color:var(--t2)">' + esc(dv.name) + ' (' + esc(dv.reg) + ') &times; ' + bkDurD + 'd @ &pound;' + dv.dayRate + '/day</span><span style="color:var(--red)">' + spv(fmt(dv.dayRate * bkDurD)) + '</span></div>';
    }
  }

  // ── Mileage / Fuel ──
  if (bkFuel > 0 || bkRetF > 0) {
    h += '<div class="cos-section-head">⛽ Mileage &amp; Fuel</div>';
    var jobMiles = j2 ? (j2.mileage||0) : 0;
    if (bkFuel > 0) {
      h += '<div class="cb-row"><span style="color:var(--t2)">Outward journey' + (jobMiles ? ' ('+jobMiles+' mi)' : '') + '</span><span style="color:var(--red)">' + spv('&pound;' + bkFuel) + '</span></div>';
    }
    if (bkRetF > 0) {
      h += '<div class="cb-row"><span style="color:var(--t2)">Return to depot' + (jobMiles ? ' (~'+jobMiles+' mi)' : '') + ' <span style="font-size:10px;color:var(--t4)">(same-day)</span></span><span style="color:var(--red)">' + spv('&pound;' + bkRetF) + '</span></div>';
    }
    if (bkIsOvernight) {
      h += '<div style="font-size:10.5px;color:var(--t3);padding:2px 0">↳ Overnight job — no return leg</div>';
    }
  }

  // ── Materials ──
  var detMats = b.materials || [];
  if (detMats.length) {
    h += '<div class="cos-section-head">📦 Materials</div>';
    for (var k = 0; k < detMats.length; k++) {
      var dm = MATERIALS.filter(function(x){return x.id===detMats[k].id;})[0];
      if (dm) h += '<div class="cb-row"><span style="color:var(--t2)">' + esc(dm.name) + ' &times; ' + detMats[k].qty + ' @ &pound;' + dm.unitCost + ' each</span><span style="color:var(--red)">' + spv(fmt(dm.unitCost * detMats[k].qty)) + '</span></div>';
    }
  }

  // ── Other Charges ──
  var detChgs = b.charges || [];
  if (detChgs.length) {
    h += '<div class="cos-section-head">🏷 Charges</div>';
    for (var k = 0; k < detChgs.length; k++) {
      h += '<div class="cb-row"><span style="color:var(--t2)">' + esc(detChgs[k].name) + '</span><span style="color:var(--red)">' + spv(fmt(detChgs[k].amt)) + '</span></div>';
    }
  }

  // ── COS Overhead ──
  if (bkOvhd > 0) {
    h += '<div class="cos-section-head">📊 Daily Overhead (COS)</div>';
    var ovRate = APP_SETTINGS.cosPerCrewPerDay || 125;
    h += '<div class="cb-row"><span style="color:var(--t2)">'+detCrew.length+' crew &times; '+bkDurD+'d @ &pound;'+ovRate+'/crew/day</span><span style="color:var(--red)">' + spv(fmt(bkOvhd)) + '</span></div>';
    h += '<div style="font-size:10.5px;color:var(--t4);padding:1px 0">Configurable in Settings → Cost of Sale &amp; Maps</div>';
  }

  h += '<div class="cb-row" style="font-weight:700;border-top:2px solid var(--b1);margin-top:6px;padding-top:7px"><span>Total COS</span><span style="color:var(--red)">' + spv(fmt(bkCOS)) + '</span></div>';
  h += '</div>';

  // Right: summary panel
  h += '<div class="cost-breakdown">';
  h += '<div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);margin-bottom:8px">Summary</div>';
  h += '<div class="cb-row" style="font-size:12px"><span>Revenue</span><span style="color:var(--blue)">' + fmt(bkRev) + '</span></div>';
  h += '<div class="cb-row" style="font-size:12px"><span>Total COS</span><span style="color:var(--red)">' + spv(fmt(bkCOS), 'bksum-cos-'+b.id) + '</span></div>';
  if (bkCrew>0)  h += '<div class="cb-row" style="font-size:11px;padding:1px 0"><span style="color:var(--t3);padding-left:8px">Crew</span><span style="color:var(--t3)">' + spv(fmt(bkCrew), 'bksum-crew-'+b.id) + '</span></div>';
  if (bkFuel>0)  h += '<div class="cb-row" style="font-size:11px;padding:1px 0"><span style="color:var(--t3);padding-left:8px">Fuel (out)</span><span style="color:var(--t3)">' + spv('&pound;'+bkFuel) + '</span></div>';
  if (bkRetF>0)  h += '<div class="cb-row" style="font-size:11px;padding:1px 0"><span style="color:var(--t3);padding-left:8px">Fuel (return)</span><span style="color:var(--t3)">' + spv('&pound;'+bkRetF) + '</span></div>';
  if (bkVeh>0)   h += '<div class="cb-row" style="font-size:11px;padding:1px 0"><span style="color:var(--t3);padding-left:8px">Vehicles</span><span style="color:var(--t3)">' + spv(fmt(bkVeh)) + '</span></div>';
  if (bkMat>0)   h += '<div class="cb-row" style="font-size:11px;padding:1px 0"><span style="color:var(--t3);padding-left:8px">Materials</span><span style="color:var(--t3)">' + spv(fmt(bkMat)) + '</span></div>';
  if (bkChg>0)   h += '<div class="cb-row" style="font-size:11px;padding:1px 0"><span style="color:var(--t3);padding-left:8px">Charges</span><span style="color:var(--t3)">' + spv(fmt(bkChg)) + '</span></div>';
  if (bkOvhd>0)  h += '<div class="cb-row" style="font-size:11px;padding:1px 0"><span style="color:var(--t3);padding-left:8px">Overhead</span><span style="color:var(--t3)">' + spv(fmt(bkOvhd)) + '</span></div>';
  h += '<div class="cb-total" style="color:' + bkMcol + '"><span>Margin</span><span>' + spv((bkMgn !== null ? fmt(bkMgn) : 'TBC'), 'bksum-mgn-'+b.id) + '</span></div>';
  if (bkMpct !== null) h += '<div style="font-size:30px;font-weight:700;color:' + bkMcol + ';text-align:center;padding:6px 0;letter-spacing:-1px">' + bkMpct.toFixed(1) + '%</div>';
  if (bkMpct !== null && bkMpct < 15) h += '<div style="font-size:11px;background:#FFFBEB;border:1px solid #FFE97A;border-radius:4px;padding:5px 7px;color:#7A5200;">&#9888; Below 15% &mdash; review billing</div>';
  h += '</div></div></div></div>';

  // Notes
  if (b.notes) {
    h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">5</div><div class="bf-sec-title">Notes / Instructions</div></div>';
    h += '<div class="bf-body" style="font-size:12.5px;color:var(--t2);line-height:1.7;white-space:pre-wrap">' + esc(b.notes) + '</div></div>';
  }

  // Email log
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">&#9993;</div><div class="bf-sec-title">Communication Log</div></div>';
  h += '<div class="bf-body">';
  if (b.emailLog && b.emailLog.length) {
    for (var k = 0; k < b.emailLog.length; k++) {
      var log = b.emailLog[k];
      h += '<div class="fin-row"><div class="fin-lbl" style="display:flex;align-items:center;gap:7px">';
      h += '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,12 2,6"/></svg>';
      h += esc(log.subject) + '</div>';
      h += '<div class="fin-val" style="color:var(--t3);font-size:10.5px">' + log.sentAt + '</div></div>';
    }
  } else {
    h += '<span style="color:var(--t3);font-size:12px">No emails sent yet.</span>&nbsp;';
    h += '<button class="btn btn-p btn-sm" onclick="showEmailPreview(\'' + b.id + '\')">Send Confirmation</button>';
  }
  h += '</div></div>';

  h += '</div>';
  setH('bk-right-body', h);
}

function renderBookingForm(b, ref) {
  var j = b || {};
  var BRAND_LIST = ['SIRVA', 'BRITANNIA', 'MOVESQUAD', 'EMS', 'STERLING'];
  var STATUS_LIST = ['Scheduled', 'In Progress', 'Completed', 'Billed'];

  var h = '<div class="fade-in">';

  // AI email parser
  h += '<div class="ai-parse-box">';
  h += '<div class="ai-parse-title">';
  h += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>';
  h += 'AI Email Parser</div>';
  h += '<div class="ai-parse-sub">Paste a booking confirmation email, instruction sheet, or any message below. Claude will extract all the details and pre-fill the form instantly.</div>';
  h += '<textarea class="ai-parse-ta" id="email-paste" placeholder="Paste email text here...&#10;&#10;e.g. Dear team, please confirm the following move:&#10;Client: John Smith&#10;Move date: 20th March 2025&#10;Origin: 14 High Street, Manchester, M1 2AB&#10;Destination: 7 Oak Avenue, Leeds, LS1 3CD&#10;Volume: approx 1,200 cubic feet&#10;..."></textarea>';
  h += '<div style="display:flex;gap:7px;margin-top:8px">';
  h += '<button class="btn btn-p btn-sm" id="parse-btn" onclick="parseEmail()">&#10003; Extract Details</button>';
  h += '<button class="btn btn-s btn-sm" onclick="el(\'email-paste\').value=\'\'">Clear</button>';
  h += '</div></div>';

  // Section 1: Client
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">1</div><div class="bf-sec-title">Client Details</div></div>';
  h += '<div class="bf-body">';
  h += '<div class="bf-row col2"><div class="bf-field"><label class="bf-label">Client Name *</label><input class="bf-input" id="bk-client" value="' + esc(j.clientName || '') + '" placeholder="Full name or company"></div>';
  h += '<div class="bf-field"><label class="bf-label">Brand *</label><select class="bf-input bf-select" id="bk-brand">';
  for (var i = 0; i < BRAND_LIST.length; i++) h += '<option' + (j.brand === BRAND_LIST[i] ? ' selected' : '') + '>' + BRAND_LIST[i] + '</option>';
  h += '</select></div></div>';
  h += '<div class="bf-row col2"><div class="bf-field"><label class="bf-label">Client Email</label><input class="bf-input" id="bk-email" type="email" value="' + esc(j.clientEmail || '') + '" placeholder="client@example.com"></div>';
  h += '<div class="bf-field"><label class="bf-label">Client Phone</label><input class="bf-input" id="bk-phone" value="' + esc(j.clientPhone || '') + '" placeholder="07700 000000"></div></div>';
  h += '</div></div>';

  // Section 2: Move
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">2</div><div class="bf-sec-title">Move Details</div></div>';
  h += '<div class="bf-body">';
  h += '<div class="bf-row col2"><div class="bf-field"><label class="bf-label">Start Date *</label><input class="bf-input" id="bk-start" type="date" value="' + (j.startDate || '') + '"></div>';
  h += '<div class="bf-field"><label class="bf-label">End Date</label><input class="bf-input" id="bk-end" type="date" value="' + (j.endDate || '') + '"></div></div>';
  h += '<div class="bf-row col1"><div class="bf-field"><label class="bf-label">Origin Address *</label><input class="bf-input" id="bk-origin" value="' + esc(j.origin || '') + '" placeholder="Full address incl. postcode"></div></div>';
  h += '<div class="bf-row col1"><div class="bf-field"><label class="bf-label">Destination Address *</label><input class="bf-input" id="bk-dest" value="' + esc(j.dest || '') + '" placeholder="Full address incl. postcode"></div></div>';
  h += '<div class="bf-row col3"><div class="bf-field"><label class="bf-label">Volume ft³</label><input class="bf-input" id="bk-vol" type="number" value="' + (j.volume || '') + '" min="0" placeholder="0"></div>';
  h += '<div class="bf-field"><label class="bf-label">CBM</label><input class="bf-input" id="bk-cbm" type="number" step="0.01" value="' + (j.cbm || '') + '" min="0" placeholder="0.00"></div>';
  h += '<div class="bf-field"><label class="bf-label">Status</label><select class="bf-input bf-select" id="bk-status">';
  for (var i = 0; i < STATUS_LIST.length; i++) h += '<option' + (j.status === STATUS_LIST[i] ? ' selected' : '') + '>' + STATUS_LIST[i] + '</option>';
  h += '</select></div></div>';
  h += '</div></div>';

  // Section 3: Billing
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">3</div><div class="bf-sec-title">Billing Lines</div></div>';
  h += '<div class="bf-body"><div id="bk-blines">';
  var blines = j.billing || [];
  for (var i = 0; i < blines.length; i++) h += bkBline(blines[i].item, blines[i].amt, i);
  h += '</div>';
  h += '<button class="btn btn-s btn-sm" style="margin-top:6px" onclick="addBkBline()">+ Add line</button>';
  h += '</div></div>';

  // Section 4: Vehicles
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">4</div><div class="bf-sec-title">Vehicles</div>';
  h += '<span style="font-size:11px;color:var(--t3)">Day rate &times; booking duration added to COS</span></div>';
  h += '<div class="bf-body"><div class="res-grid" id="bk-vehs">';
  var selVehs = j.vehicles || [];
  var bkDur = j.startDate && j.endDate ? Math.max(1,Math.round((s2d(j.endDate)-s2d(j.startDate))/864e5)+1) : 1;
  if (!VEHICLES.length) {
    h += '<div style="color:var(--t3);font-size:12px">No vehicles configured. Add them in <strong>Settings &rarr; Vehicles</strong>.</div>';
  } else {
    for (var vi = 0; vi < VEHICLES.length; vi++) {
      var veh = VEHICLES[vi];
      var isSel = selVehs.some(function(sv){ return sv.id === veh.id; });
      h += '<div class="res-item' + (isSel?' sel':'') + '" onclick="toggleVeh(this,\''+veh.id+'\',\'bk-vehs\')">';
      h += '<div class="ri-check">'+(isSel?'&#10003;':'')+'</div>';
      h += '<div class="ri-name"><strong>'+esc(veh.name)+'</strong> <span style="color:var(--t3);font-size:10.5px">'+esc(veh.reg)+'</span>';
      h += ' &mdash; '+esc(veh.type)+', '+veh.volCapFt+'ft&sup3;</div>';
      h += '<div class="ri-price">&pound;'+veh.dayRate+'/day<br><span style="font-size:10px;color:var(--blue)">&pound;'+(veh.dayRate*bkDur).toFixed(2)+' total</span></div>';
      h += '</div>';
    }
  }
  h += '</div></div></div>';

  // Section 5: Materials
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">5</div><div class="bf-sec-title">Packing Materials</div>';
  h += '<span style="font-size:11px;color:var(--t3)">Select items &amp; set quantities</span></div>';
  h += '<div class="bf-body"><div id="bk-mats">';
  var selMats = j.materials || [];
  if (!MATERIALS.length) {
    h += '<div style="color:var(--t3);font-size:12px">No materials configured. Add them in <strong>Settings &rarr; Materials</strong>.</div>';
  } else {
    for (var mi = 0; mi < MATERIALS.length; mi++) {
      var mat = MATERIALS[mi];
      var selMat = selMats.filter(function(sm){ return sm.id === mat.id; })[0];
      var isSel = !!selMat;
      var qty = isSel ? (selMat.qty||1) : 0;
      h += '<div class="res-item' + (isSel?' sel':'') + '" id="matrow-'+mat.id+'">';
      h += '<div class="ri-check">'+(isSel?'&#10003;':'')+'</div>';
      h += '<div class="ri-name" onclick="toggleMat(this,\''+mat.id+'\')" style="cursor:pointer">'+esc(mat.name)+'</div>';
      h += '<div style="display:flex;align-items:center;gap:5px">';
      h += '<input type="number" class="bf-input ri-qty" id="mq-'+mat.id+'" value="'+qty+'" min="0" step="1" placeholder="Qty"';
      h += ' oninput="updateMatRow(\''+mat.id+'\','+mat.unitCost+',this.value)">';
      h += '<div class="ri-price" id="mp-'+mat.id+'">&pound;'+mat.unitCost+'ea<br><span style="font-size:10px;color:var(--blue)" id="mpt-'+mat.id+'">'+(isSel?'&pound;'+(mat.unitCost*qty).toFixed(2):'')+'</span></div>';
      h += '</div></div>';
    }
  }
  h += '</div></div></div>';

  // Section 6: Charges & Taxes
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">6</div><div class="bf-sec-title">Charges &amp; Taxes</div>';
  h += '<span style="font-size:11px;color:var(--t3)">Applied to this booking only — amounts editable</span></div>';
  h += '<div class="bf-body">';
  var selChgs = j.charges || [];
  h += '<div id="bk-chgs-list">';
  if (selChgs.length) {
    for (var ci = 0; ci < selChgs.length; ci++) {
      h += chgRow(selChgs[ci].name, selChgs[ci].amt, ci);
    }
  }
  h += '</div>';
  h += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">';
  for (var ci = 0; ci < CHARGES.length; ci++) {
    h += '<button class="btn btn-s btn-sm" onclick="addChgToBooking(\''+esc(CHARGES[ci].name)+'\','+CHARGES[ci].defaultAmt+')">+ '+esc(CHARGES[ci].name)+'</button>';
  }
  h += '</div></div></div>';

  // Section 7: Notes
  h += '<div class="bf-section"><div class="bf-sec-head"><div class="bf-sec-num">7</div><div class="bf-sec-title">Special Instructions / Notes</div></div>';
  h += '<div class="bf-body"><div class="bf-field"><textarea class="bf-input bf-textarea" id="bk-notes" placeholder="Parking restrictions, access notes, fragile items, crew instructions...">' + esc(j.notes || '') + '</textarea></div></div></div>';

  // Actions
  h += '<div style="display:flex;justify-content:flex-end;gap:8px;padding:4px 0 20px">';
  h += '<button class="btn btn-s" onclick="cancelBkForm()">Cancel</button>';
  h += '<button class="btn btn-p" onclick="saveBooking(\'' + ref + '\')">&#10003; Confirm Booking &mdash; ' + ref + '</button>';
  h += '</div>';
  h += '</div>';

  setH('bk-right-body', h);
}

// ── RESOURCE SELECTORS IN BOOKING FORM ────────────────────────────────
function toggleVeh(el_ref, vid, containerId) {
  el_ref.classList.toggle('sel');
  var isSel = el_ref.classList.contains('sel');
  var chk = el_ref.querySelector('.ri-check');
  if (chk) chk.innerHTML = isSel ? '&#10003;' : '';
}

function toggleMat(nameEl, mid) {
  var row = document.getElementById('matrow-' + mid);
  if (!row) return;
  row.classList.toggle('sel');
  var isSel = row.classList.contains('sel');
  var chk = row.querySelector('.ri-check');
  if (chk) chk.innerHTML = isSel ? '&#10003;' : '';
  var qtyEl = el('mq-' + mid);
  if (qtyEl && isSel && (!qtyEl.value || qtyEl.value === '0')) qtyEl.value = '1';
  var mat = MATERIALS.filter(function(m) { return m.id === mid; })[0];
  if (mat) updateMatRow(mid, mat.unitCost, qtyEl ? qtyEl.value : 0);
}

function updateMatRow(mid, unitCost, qty) {
  var row = document.getElementById('matrow-' + mid);
  if (!row) return;
  var q = parseInt(qty) || 0;
  var chk = row.querySelector('.ri-check');
  if (q > 0) {
    row.classList.add('sel');
    if (chk) chk.innerHTML = '&#10003;';
  } else {
    row.classList.remove('sel');
    if (chk) chk.innerHTML = '';
  }
  var tot = el('mpt-' + mid);
  if (tot) tot.innerHTML = q > 0 ? '&pound;' + (unitCost * q).toFixed(2) : '';
}

var chgRowCount = 0;
function chgRow(name, amt, idx) {
  return '<div style="display:flex;gap:6px;margin-bottom:5px;align-items:center">' +
    '<div style="flex:1;font-size:12.5px;font-weight:500">' + esc(name) + '</div>' +
    '<div style="display:flex;align-items:center;gap:3px"><span style="color:var(--t3)">£</span>' +
    '<input class="bf-input" style="width:90px;text-align:right" type="number" id="chga' + idx + '" value="' + amt + '" step="0.01" min="0"></div>' +
    '<button class="btn btn-g btn-sm" onclick="this.parentNode.remove()">&#10005;</button>' +
    '</div>';
}

function addChgToBooking(name, defaultAmt) {
  var list = el('bk-chgs-list');
  if (!list) return;
  chgRowCount++;
  list.insertAdjacentHTML('beforeend', chgRow(name, defaultAmt, chgRowCount));
}

function getSelectedVehicles() {
  var vehs = [];
  var rows = document.querySelectorAll('#bk-vehs .res-item.sel');
  rows.forEach(function(row) {
    var onclick = row.getAttribute('onclick') || '';
    var match = onclick.match(/toggleVeh\(this,'([^']+)'/);
    if (match) vehs.push({ id: match[1] });
  });
  return vehs;
}

function getSelectedMaterials() {
  var mats = [];
  for (var mi = 0; mi < MATERIALS.length; mi++) {
    var mat = MATERIALS[mi];
    var row = document.getElementById('matrow-' + mat.id);
    if (row && row.classList.contains('sel')) {
      var qtyEl = el('mq-' + mat.id);
      var qty = parseInt((qtyEl || {}).value) || 0;
      if (qty > 0) mats.push({ id: mat.id, qty: qty });
    }
  }
  return mats;
}

function getSelectedCharges() {
  var chgs = [];
  var list = el('bk-chgs-list');
  if (!list) return chgs;
  var rows = list.children;
  for (var i = 0; i < rows.length; i++) {
    var inputs = rows[i].querySelectorAll('input[type="number"]');
    var nameEl = rows[i].querySelector('div[style*="flex:1"]') || rows[i].querySelector('div');
    if (inputs.length && nameEl) {
      chgs.push({ name: nameEl.textContent.trim(), amt: parseFloat(inputs[0].value) || 0 });
    }
  }
  return chgs;
}

function bkBline(item, amt, i) {
  return '<div style="display:flex;gap:6px;margin-bottom:5px"><input class="bf-input" style="flex:2" placeholder="Item description" value="' + esc(item) + '" id="bkbi' + i + '"><input class="bf-input" style="flex:1;max-width:120px" type="number" placeholder="Amount" value="' + (amt || '') + '" id="bkba' + i + '" step="0.01" min="0"><button class="btn btn-g btn-sm" onclick="rmBkBline(' + i + ')">&#10005;</button></div>';
}

var bkBlineCount = 0;
function addBkBline() {
  var bl = el('bk-blines');
  bkBlineCount++;
  bl.insertAdjacentHTML('beforeend', bkBline('', '', bkBlineCount));
}
function rmBkBline(i) {
  var row = el('bkbi' + i);
  if (row) row.parentNode.remove();
}

function getBkBilling() {
  var lines = [];
  var i = 0;
  while (true) {
    var ii = el('bkbi' + i);
    if (!ii) { if (i > bkBlineCount + 20) break; i++; continue; }
    var item = ii.value.trim();
    var amt = parseFloat(el('bkba' + i).value) || 0;
    if (item) lines.push({ item: item, amt: amt });
    i++;
  }
  return lines;
}

function saveBooking(ref) {
  var client = el('bk-client').value.trim();
  var startDate = el('bk-start').value;
  var origin = el('bk-origin').value.trim();
  var dest = el('bk-dest').value.trim();
  if (!client) { toast('Client name is required'); return; }
  if (!startDate) { toast('Start date is required'); return; }
  if (!origin) { toast('Origin address is required'); return; }

  var bk = {
    id: bkMode === 'edit' ? curBkId : ('BK' + Date.now()),
    ref: ref,
    brand: el('bk-brand').value,
    clientName: client,
    clientEmail: el('bk-email').value.trim(),
    clientPhone: el('bk-phone').value.trim(),
    startDate: startDate,
    endDate: el('bk-end').value || startDate,
    origin: origin,
    dest: dest,
    volume: parseFloat(el('bk-vol').value) || 0,
    cbm: parseFloat(el('bk-cbm').value) || 0,
    status: el('bk-status').value,
    notes: el('bk-notes').value.trim(),
    billing: getBkBilling(),
    vehicles: getSelectedVehicles(),
    materials: getSelectedMaterials(),
    charges: getSelectedCharges(),
    emailLog: bkMode === 'edit' ? (bookings.filter(function(x){return x.id===curBkId;})[0]||{}).emailLog||[] : [],
    createdAt: bkMode === 'edit' ? (bookings.filter(function(x){return x.id===curBkId;})[0]||{}).createdAt||new Date().toISOString() : new Date().toISOString(),
  };

  // Also create/update a Job entry so it appears in the calendar
  var jb = {
    id: bk.id,
    ref: bk.ref,
    brand: bk.brand,
    client: bk.clientName,
    origin: bk.origin,
    dest: bk.dest,
    start: bk.startDate,
    end: bk.endDate,
    vol: bk.volume,
    cbm: bk.cbm,
    drivers: [],
    porters: [],
    fuel: 0,
    veh: [],
    status: bk.status,
    billing: bk.billing,
    notes: bk.notes,
  };

  if (bkMode === 'edit') {
    for (var i = 0; i < bookings.length; i++) if (bookings[i].id === curBkId) { bookings[i] = bk; break; }
    for (var i = 0; i < jobs.length; i++) if (jobs[i].id === curBkId) { jobs[i] = jb; break; }
    toast('Booking updated'); saveData('booking', bk.id, bk);
  } else {
    bookings.push(bk);
    jobs.push(jb);
    toast('Booking confirmed — ' + ref); saveData('booking', bk.id, bk);
  }

  curBkId = bk.id;
  bkMode = 'view';
  renderBkList();
  el('bk-right-title').innerHTML = '<span class="ref-badge">' + bk.ref + '</span> &nbsp;' + esc(bk.clientName);
  setH('bk-right-actions',
    '<button class="btn btn-s btn-sm" onclick="editBooking(\'' + bk.id + '\')">&#9998; Edit</button>' +
    '<button class="btn btn-p btn-sm" onclick="showEmailPreview(\'' + bk.id + '\')">&#9993; Send Confirmation</button>'
  );
  renderBookingDetail(bk);
  setBadge('job-badge',jobs.length);
}

function cancelBkForm() {
  if (curBkId) {
    viewBooking(curBkId);
  } else {
    curBkId = null;
    bkMode = 'none';
    el('bk-right-title').textContent = 'Select or create a booking';
    setH('bk-right-actions', '');
    setH('bk-right-body', '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--t3);text-align:center;padding:40px"><div style="font-weight:600;font-size:15px;color:var(--t2);margin-bottom:6px">No booking selected</div><div style="font-size:12.5px">Click + New Booking to start.</div></div>');
  }
}

// ── AI EMAIL PARSER ────────────────────────────────────────────────────
function parseEmail() {
  var text = el('email-paste').value.trim();
  if (!text) { toast('Paste an email first'); return; }
  var btn = el('parse-btn');
  btn.innerHTML = '<span class="ai-spin"></span> Parsing...';
  btn.disabled = true;

  var prompt = 'Extract the following fields from this booking/move email. Return ONLY valid JSON with these exact keys. Use null for missing fields.\n\n' +
    '{"clientName":string,"clientEmail":string,"clientPhone":string,"startDate":"YYYY-MM-DD or null","endDate":"YYYY-MM-DD or null","origin":string,"dest":string,"volume":number_or_null,"cbm":number_or_null,"notes":string,"billing":[{"item":string,"amt":number}]}\n\n' +
    'EMAIL:\n' + text;

  fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1000,
      messages: [{ role: 'user', content: prompt }]
    })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    btn.innerHTML = '&#10003; Extract Details';
    btn.disabled = false;
    var raw = (data.content && data.content[0] && data.content[0].text) || '';
    // Strip any markdown fences
    raw = raw.replace(/```json|```/g, '').trim();
    var parsed;
    try { parsed = JSON.parse(raw); } catch(e) { toast('Could not parse response — check email text'); return; }
    // Fill form fields
    if (parsed.clientName) el('bk-client').value = parsed.clientName;
    if (parsed.clientEmail) el('bk-email').value = parsed.clientEmail;
    if (parsed.clientPhone) el('bk-phone').value = parsed.clientPhone;
    if (parsed.startDate) el('bk-start').value = parsed.startDate;
    if (parsed.endDate) el('bk-end').value = parsed.endDate;
    if (parsed.origin) el('bk-origin').value = parsed.origin;
    if (parsed.dest) el('bk-dest').value = parsed.dest;
    if (parsed.volume) el('bk-vol').value = parsed.volume;
    if (parsed.cbm) el('bk-cbm').value = parsed.cbm;
    if (parsed.notes) el('bk-notes').value = parsed.notes;
    if (parsed.billing && parsed.billing.length) {
      var bl = el('bk-blines');
      bl.innerHTML = '';
      bkBlineCount = parsed.billing.length - 1;
      for (var i = 0; i < parsed.billing.length; i++) {
        bl.insertAdjacentHTML('beforeend', bkBline(parsed.billing[i].item, parsed.billing[i].amt, i));
      }
    }
    el('email-paste').value = '';
    toast('Details extracted — review and confirm');
  })
  .catch(function(e) {
    btn.innerHTML = '&#10003; Extract Details';
    btn.disabled = false;
    toast('API error — check console');
  });
}

// ── EMAIL PREVIEW + SEND ───────────────────────────────────────────────
function showEmailPreview(id) {
  var b = bookings.filter(function(x) { return x.id === id; })[0];
  if (!b) return;
  if (!b.clientEmail) { toast('No client email address on this booking'); return; }

  var body = buildEmailBody(b);
  var subject = 'Booking Confirmation — ' + b.ref;

  var h = '<div class="fade-in">';
  h += '<div style="margin-bottom:14px;display:flex;align-items:center;gap:10px">';
  h += '<button class="btn btn-s btn-sm" onclick="viewBooking(\'' + id + '\')">&#8592; Back</button>';
  h += '<span style="font-weight:700;font-size:14px">Email Preview</span>';
  h += '</div>';

  h += '<div class="email-preview">';
  h += '<div class="ep-bar">';
  h += '<div class="ep-dot" style="background:#FF5F56"></div>';
  h += '<div class="ep-dot" style="background:#FFBD2E"></div>';
  h += '<div class="ep-dot" style="background:#27C93F"></div>';
  h += '<span style="font-size:11px;color:var(--t3);margin-left:8px">Booking Confirmation Email</span>';
  h += '</div>';
  h += '<div class="ep-header">';
  h += '<div class="ep-field"><span class="ep-lbl">From:</span><span class="ep-val">' + esc(SL_CONFIG.fromName) + ' <' + esc(SL_CONFIG.fromEmail) + '></span></div>';
  h += '<div class="ep-field"><span class="ep-lbl">To:</span><span class="ep-val">' + esc(b.clientName) + ' <' + esc(b.clientEmail) + '></span></div>';
  h += '<div class="ep-field"><span class="ep-lbl">Subject:</span><span class="ep-val" style="font-weight:700">' + esc(subject) + '</span></div>';
  h += '</div>';
  h += '<div class="ep-body" style="white-space:pre-wrap;font-size:13px;line-height:1.8">' + esc(body) + '</div>';
  h += '</div>';

  // SocketLabs config check
  if (!SL_CONFIG.serverId || !SL_CONFIG.apiKey) {
    h += '<div style="margin-top:12px;background:#FFF5E0;border:1px solid #FFD580;border-radius:var(--r);padding:11px 14px;font-size:12.5px">';
    h += '<strong>SocketLabs not configured.</strong> Add your Server ID and API Key below to enable sending.';
    h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px">';
    h += '<div class="bf-field"><label class="bf-label">Server ID</label><input class="bf-input" id="sl-sid" placeholder="e.g. 10000" value="' + esc(SL_CONFIG.serverId) + '"></div>';
    h += '<div class="bf-field"><label class="bf-label">Injection API Key</label><input class="bf-input" id="sl-key" placeholder="Paste key" value="' + esc(SL_CONFIG.apiKey) + '"></div>';
    h += '<div class="bf-field"><label class="bf-label">From Email</label><input class="bf-input" id="sl-from" value="' + esc(SL_CONFIG.fromEmail) + '"></div>';
    h += '<div class="bf-field"><label class="bf-label">From Name</label><input class="bf-input" id="sl-fname" value="' + esc(SL_CONFIG.fromName) + '"></div>';
    h += '</div>';
    h += '<button class="btn btn-s btn-sm" style="margin-top:8px" onclick="saveSLConfig()">Save Config</button>';
    h += '</div>';
  }

  h += '<div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">';
  h += '<button class="btn btn-s" onclick="viewBooking(\'' + id + '\')">Cancel</button>';
  h += '<button class="btn btn-p" id="send-btn" onclick="sendEmail(\'' + id + '\',\'' + esc(subject).replace(/'/g,"\\'") + '\')">&#9993; Send Email</button>';
  h += '</div>';
  h += '</div>';

  setH('bk-right-body', h);
  el('bk-right-title').textContent = 'Send Confirmation';
  setH('bk-right-actions', '');
}

function buildEmailBody(b) {
  var vol = b.volume ? b.volume + ' ft\u00B3' : (b.cbm ? b.cbm + ' CBM' : 'TBC');
  var billing = '';
  if (b.billing && b.billing.length) {
    var tot = 0;
    for (var k = 0; k < b.billing.length; k++) {
      billing += '\n  ' + b.billing[k].item + ': ' + (b.billing[k].amt > 0 ? '\u00A3' + b.billing[k].amt.toFixed(2) : 'TBC');
      tot += b.billing[k].amt;
    }
    if (tot > 0) billing += '\n  Total: \u00A3' + tot.toFixed(2);
  }

  return 'Dear ' + b.clientName + ',\n\n' +
    'Thank you for choosing ' + SL_CONFIG.companyName + '. We are pleased to confirm your booking.\n\n' +
    '━━━ BOOKING CONFIRMATION ━━━\n\n' +
    'Booking Reference: ' + b.ref + '\n' +
    'Move Date:         ' + fmtNice(b.startDate) + (b.endDate && b.endDate !== b.startDate ? ' \u2013 ' + fmtNice(b.endDate) : '') + '\n' +
    'Origin:            ' + b.origin + '\n' +
    'Destination:       ' + b.dest + '\n' +
    'Volume:            ' + vol + '\n' +
    (billing ? '\nBilling Summary:' + billing + '\n' : '') +
    (b.notes ? '\nSpecial Instructions:\n' + b.notes + '\n' : '') +
    '\n━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n' +
    'If you have any questions or need to make changes, please contact us:\n' +
    SL_CONFIG.companyName + '\n' +
    'Phone: ' + SL_CONFIG.companyPhone + '\n' +
    'Email: ' + SL_CONFIG.companyEmail + '\n\n' +
    'Kind regards,\n' +
    SL_CONFIG.fromName;
}

function saveSLConfig() {
  SL_CONFIG.serverId = (el('sl-sid') || {}).value || SL_CONFIG.serverId;
  SL_CONFIG.apiKey = (el('sl-key') || {}).value || SL_CONFIG.apiKey;
  SL_CONFIG.fromEmail = (el('sl-from') || {}).value || SL_CONFIG.fromEmail;
  SL_CONFIG.fromName = (el('sl-fname') || {}).value || SL_CONFIG.fromName;
  toast('SocketLabs config saved'); saveData('settings');
}

function sendEmail(id, subject) {
  var b = bookings.filter(function(x) { return x.id === id; })[0];
  if (!b) return;
  if (!SL_CONFIG.serverId || !SL_CONFIG.apiKey) { toast('Configure SocketLabs first'); return; }

  var btn = el('send-btn');
  btn.innerHTML = '<span class="ai-spin"></span> Sending...';
  btn.disabled = true;

  var body = buildEmailBody(b);

  fetch('https://inject.socketlabs.com/api/v1/email', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      ServerId: parseInt(SL_CONFIG.serverId),
      APIKey: SL_CONFIG.apiKey,
      Messages: [{
        To: [{ emailAddress: b.clientEmail, friendlyName: b.clientName }],
        From: { emailAddress: SL_CONFIG.fromEmail, friendlyName: SL_CONFIG.fromName },
        Subject: subject,
        TextBody: body,
        MessageType: 'Bulk'
      }]
    })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.ErrorCode === '0' || data.ErrorCode === 0) {
      // Log it
      var now = new Date();
      var ts = now.toLocaleDateString('en-GB') + ' ' + now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
      b.emailLog = b.emailLog || [];
      b.emailLog.push({ subject: subject, sentAt: ts, to: b.clientEmail });
      b.status = 'Email Sent';
      // Update in bookings
      for (var i = 0; i < bookings.length; i++) if (bookings[i].id === id) { bookings[i] = b; break; }
      renderBkList();
      toast('Email sent to ' + b.clientEmail);
      viewBooking(id);
    } else {
      toast('Send failed: ' + (data.ErrorCode || 'Unknown error'));
      btn.innerHTML = '&#9993; Send Email';
      btn.disabled = false;
    }
  })
  .catch(function(e) {
    toast('Network error — check SocketLabs config');
    btn.innerHTML = '&#9993; Send Email';
    btn.disabled = false;
  });
}

// ── JOB CONFIGURATOR ─────────────────────────────────────────────────
// State object for the active configurator session
var CFG = null;
var cfgStage = 0;
var CFG_STAGES = 5;

function cfgEmpty() {
  return {
    id: null,
    ref: genRef(),
    brand: BRANDS[0] || '',
    channel: 'Partner',
    moveManager: '',
    clientName: '', clientEmail: '', clientPhone: '',
    clientRef: '',
    status: 'Draft', // Draft | Provisional | Confirmed
    // Array of job configs — each becomes a separate calendar job
    jobs: [cfgEmptyJob()],
    // Schedule
    startDate: '', endDate: '',
    selectedDates: [],   // array of chosen date strings (length = numDays for multi-day)
    isMultiDay: false, numDays: 1,
    hasOvernight: false, numNights: 0, overnightAllowance: 65,
    weekendWorking: false,
    linkJourney: false, journeyRef: '',
    // Resources
    crewAssigned: [],   // crew names
    vehAssigned: [],    // vehicle IDs
    // Billing
    billing: [],
    // Notes
    opsNotes: '', clientNotes: '',
    createdAt: new Date().toISOString(),
    // Source email raw text
    sourceEmail: '',
    // AI parse results (for chip display)
    aiParsed: null,
    // Change & cancellation history
    changeLog: [],
    cancelReason: '',
    cancelNotes: '',

  };
}

function cfgEmptyJob() {
  return {
    jid: 'J' + Date.now() + Math.random().toString(36).slice(2,5),
    jobType: '',
    shipMode: '',
    origin: '', dest: '',
    destType: '',
    volFt: '', volCbm: '',
    volUnit: 'ft',
    svcs: {
      casing: false, crating: false, handyman: false,
      electrician: false, gasEngineer: false, piano: false,
      packingMaterials: false, debris: false,
    },
    access: {
      smallVehicle: false, tightAccess: false, shuttle: false,
      parkingSuspension: false, permit: false, rdRestriction: false,
    },
    // Storage
    storageRequired: false,
    storageDirection: null,   // 'in' | 'out' | null
    storageId: '',             // linked STORAGE_RECORDS id
    storageIsNew: false,       // true = create new record on commit
    // New storage record fields (if storageIsNew)
    newStorageType: 'longterm',
    newStorageBillingType: 'monthly',
    newStorageBillingRate: 85,
    newStorageBillingUnit: 'cbm',
    // Outbound specific
    volToRemove: 0,            // ft³ being removed from store
    containersToRemove: [],    // container numbers being delivered out
    billing: [],
    ref: '',
  };
}

function openConfigurator(existingBkId) {
  if (existingBkId) {
    var b = bookings.filter(function(x){return x.id===existingBkId;})[0];
    if (!b) return;
    CFG = b.cfgData || cfgEmpty();
    CFG.ref = b.ref;
    CFG.id = existingBkId;
  } else {
    CFG = cfgEmpty();
  }
  cfgStage = 0;
  el('cfg-head-ref').textContent = CFG.ref;
  el('cfg-head-title').textContent = existingBkId ? 'Edit Booking' : 'New Job Configurator';
  el('cfg-backdrop').classList.add('on');
  el('cfg-panel').classList.add('on');
  cfgRenderStage();
  cfgUpdateNav();
}

function closeConfigurator() {
  el('cfg-backdrop').classList.remove('on');
  el('cfg-panel').classList.remove('on');
}

function cfgClickBackdrop(e) {
  if (e.target === el('cfg-backdrop')) closeConfigurator();
}

function cfgUpdateNav() {
  // Stage indicators
  for (var i = 0; i < CFG_STAGES; i++) {
    var s = el('cstage-' + i);
    if (!s) continue;
    s.className = 'cfg-stage' + (i === cfgStage ? ' active' : i < cfgStage ? ' done' : '');
    var num = s.querySelector('.cfg-stage-num');
    if (num) num.innerHTML = i < cfgStage ? '&#10003;' : (i + 1);
  }
  // Back button
  var back = el('cfg-btn-back');
  if (back) back.style.display = cfgStage > 0 ? '' : 'none';
  // Next button
  var nxt = el('cfg-btn-next');
  if (nxt) nxt.textContent = cfgStage === CFG_STAGES - 1 ? '&#10003; Create Jobs' : 'Next \u2192';
}

function cfgGoStage(n) {
  if (n > cfgStage) { cfgNext(); return; } // only allow going to done stages or current
  if (n >= cfgStage) return;
  cfgCollectStage();
  cfgStage = n;
  cfgRenderStage();
  cfgUpdateNav();
  el('cfg-body').scrollTop = 0;
}

function cfgNext() {
  cfgCollectStage();
  if (cfgStage === CFG_STAGES - 1) {
    cfgCommit();
    return;
  }
  cfgStage++;
  cfgRenderStage();
  cfgUpdateNav();
  el('cfg-body').scrollTop = 0;
}

function cfgBack() {
  cfgCollectStage();
  if (cfgStage > 0) {
    cfgStage--;
    cfgRenderStage();
    cfgUpdateNav();
    el('cfg-body').scrollTop = 0;
  }
}

function cfgCollectStage() {
  if (cfgStage === 0) cfgCollectClient();
  if (cfgStage === 1) cfgCollectJobs();
  if (cfgStage === 2) cfgCollectSchedule();
  if (cfgStage === 3) cfgCollectResources();
  if (cfgStage === 4) cfgCollectOps();
}

function cfgRenderStage() {
  var h = '';
  if (cfgStage === 0) h = cfgRenderClient();
  if (cfgStage === 1) h = cfgRenderJobs();
  if (cfgStage === 2) h = cfgRenderSchedule();
  if (cfgStage === 3) h = cfgRenderResources();
  if (cfgStage === 4) h = cfgRenderOps();
  el('cfg-body').innerHTML = h;
  cfgPostRender();
}

function cfgPostRender() {
  if (cfgStage === 2) cfgBuildMatrix();
}

// ── STAGE 1: CLIENT ───────────────────────────────────────────────────
function cfgRenderClient() {
  var h = '';
  // AI parse card
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">&#129302;</div>';
  h += '<div><div class="cs-card-title">AI Email Parser</div><div class="cs-card-sub">Paste any email or instruction — Claude extracts all details instantly</div></div></div>';
  h += '<div class="cs-body">';
  h += '<textarea class="cfg-input" id="cfg-email-paste" rows="4" placeholder="Paste booking email, instruction sheet, or any message here...\n\ne.g. Please confirm the following move:\nClient: John Smith\nOrigin: 14 High Street, Leeds, LS1 3CD..." style="resize:vertical;min-height:80px">' + esc(CFG.sourceEmail || '') + '</textarea>';
  h += '<div style="display:flex;gap:7px;margin-top:8px">';
  h += '<button class="btn btn-p btn-sm" id="cfg-parse-btn" onclick="cfgParseEmail()"><span id="cfg-parse-spin"></span>&#10003; Extract Details</button>';
  h += '<button class="btn btn-s btn-sm" onclick="el(\'cfg-email-paste\').value=\'\'">Clear</button>';
  h += '</div>';
  // AI parse results chips
  if (CFG.aiParsed) {
    h += '<div style="margin-top:14px;border-top:1px solid #ede9e0;padding-top:12px">';
    h += '<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#7A849E;margin-bottom:10px">&#10003; Extracted — Review &amp; confirm (amber = assumed, click to edit)</div>';
    var ap = CFG.aiParsed;
    var fields = [
      ['Client Name','clientName'],['Email','clientEmail'],['Phone','clientPhone'],
      ['Start Date','startDate'],['Origin','origin'],['Destination','dest'],
      ['Volume','volume'],['Notes','notes']
    ];
    for (var fi = 0; fi < fields.length; fi++) {
      var lbl = fields[fi][0], key = fields[fi][1];
      var val = ap[key];
      var conf = ap._conf && ap._conf[key] ? ap._conf[key] : (val ? 'assumed' : 'missing');
      h += '<div class="ai-field-row">';
      h += '<div class="ai-field-lbl">' + lbl + '</div>';
      if (val) {
        h += '<span class="ai-chip ' + conf + '" onclick="cfgChipEdit(this,\'' + key + '\')" title="Click to edit">';
        h += esc(String(val).substring(0, 40));
        h += ' <span style="opacity:.6;font-size:10px">&#9998;</span></span>';
        h += '<input class="ai-edit-input" id="aied-'+key+'" style="display:none" value="'+esc(String(val))+'" onblur="cfgChipConfirm(this,\''+key+'\')" onkeydown="if(event.key===\'Enter\')cfgChipConfirm(this,\''+key+'\')">';
      } else {
        h += '<span class="ai-chip missing">&#10005; Not found</span>';
        h += '<input class="ai-edit-input" id="aied-'+key+'" placeholder="Enter manually..." style="display:none" onblur="cfgChipConfirm(this,\''+key+'\')" onkeydown="if(event.key===\'Enter\')cfgChipConfirm(this,\''+key+'\')">';
      }
      h += '</div>';
    }
    h += '</div>';
  }
  h += '</div></div>';

  // Client details card
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#E6FFF5">&#128100;</div><div class="cs-card-title">Client Details</div></div>';
  h += '<div class="cs-body">';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  h += cfgField('Client Name *', 'cfg-client', CFG.clientName, 'text', 'Full name or company');
  h += cfgField('Client Email', 'cfg-cemail', CFG.clientEmail, 'email', 'client@example.com');
  h += cfgField('Client Phone', 'cfg-cphone', CFG.clientPhone, 'text', '07700 000 000');
  h += cfgField('Client Reference', 'cfg-cref', CFG.clientRef, 'text', 'e.g. GBH-12345 (optional)');
  h += '</div></div></div>';

  // Brand / Partner card
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#F5EEFF">&#127981;</div><div class="cs-card-title">Brand &amp; Partner</div></div>';
  h += '<div class="cs-body">';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  h += '<div class="cfg-field"><label class="cfg-label">Brand</label><select class="cfg-input cfg-select" id="cfg-brand">';
  for (var bi = 0; bi < BRANDS.length; bi++) h += '<option' + (CFG.brand === BRANDS[bi] ? ' selected' : '') + '>' + BRANDS[bi] + '</option>';
  h += '</select></div>';
  h += '<div class="cfg-field"><label class="cfg-label">Channel</label><select class="cfg-input cfg-select" id="cfg-channel">';
  ['Partner','Account','Domestic'].forEach(function(c){h+='<option'+(CFG.channel===c?' selected':'')+'>'+c+'</option>';});
  h += '</select></div>';
  h += '<div class="cfg-field"><label class="cfg-label">Move Manager</label><select class="cfg-input cfg-select" id="cfg-mm">';
  h += '<option value="">— None —</option>';
  for (var mi = 0; mi < MOVE_MANAGERS.length; mi++) h += '<option value="'+esc(MOVE_MANAGERS[mi].name)+'"'+(CFG.moveManager===MOVE_MANAGERS[mi].name?' selected':'')+'>'+esc(MOVE_MANAGERS[mi].name)+' ('+esc(MOVE_MANAGERS[mi].brand)+')</option>';
  h += '</select></div>';
  h += '<div class="cfg-field"><label class="cfg-label">Booking Status</label><select class="cfg-input cfg-select" id="cfg-bkstatus">';
  ['Draft','Provisional','Confirmed'].forEach(function(s){h+='<option'+(CFG.status===s?' selected':'')+'>'+s+'</option>';});
  h += '</select></div>';
  h += '</div></div></div>';

  return h;
}

function cfgField(label, id, val, type, ph) {
  return '<div class="cfg-field"><label class="cfg-label">' + label + '</label>' +
    '<input class="cfg-input" id="' + id + '" type="' + (type||'text') + '" value="' + esc(val||'') + '" placeholder="' + esc(ph||'') + '"></div>';
}

function cfgCollectClient() {
  CFG.clientName  = (el('cfg-client') || {}).value || CFG.clientName;
  CFG.clientEmail = (el('cfg-cemail') || {}).value || CFG.clientEmail;
  CFG.clientPhone = (el('cfg-cphone') || {}).value || CFG.clientPhone;
  CFG.clientRef   = (el('cfg-cref')   || {}).value || CFG.clientRef;
  CFG.brand       = (el('cfg-brand')  || {}).value || CFG.brand;
  CFG.channel     = (el('cfg-channel')|| {}).value || CFG.channel;
  CFG.moveManager = (el('cfg-mm')     || {}).value || CFG.moveManager;
  CFG.status      = (el('cfg-bkstatus')||{}).value || CFG.status;
  CFG.sourceEmail = (el('cfg-email-paste')||{}).value || CFG.sourceEmail;
}

function cfgParseEmail() {
  var text = (el('cfg-email-paste')||{}).value || '';
  if (!text.trim()) { toast('Paste an email first'); return; }
  var btn = el('cfg-parse-btn');
  btn.innerHTML = '<span class="ai-spin"></span> Parsing...';
  btn.disabled = true;

  var prompt = 'Extract booking details from this email. Return ONLY valid JSON with these keys (use null for missing). Be conservative — only mark a field as confirmed if it is explicit. Add a "_conf" object with confidence: "confirmed" (explicit in email) or "assumed" (inferred) for each found field.\n\n{"clientName":str,"clientEmail":str,"clientPhone":str,"startDate":"YYYY-MM-DD or null","endDate":"YYYY-MM-DD or null","origin":str,"dest":str,"volume":number,"cbm":number,"notes":str,"_conf":{"clientName":"confirmed|assumed",...}}\n\nEMAIL:\n' + text;

  fetch('https://api.anthropic.com/v1/messages', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,messages:[{role:'user',content:prompt}]})
  })
  .then(function(r){return r.json();})
  .then(function(data){
    btn.innerHTML = '&#10003; Extract Details';
    btn.disabled = false;
    var raw = ((data.content||[])[0]||{}).text || '';
    raw = raw.replace(/```json|```/g,'').trim();
    var parsed;
    try { parsed = JSON.parse(raw); } catch(e) { toast('Could not parse AI response'); return; }
    CFG.aiParsed = parsed;
    // Pre-fill CFG fields
    if (parsed.clientName) CFG.clientName = parsed.clientName;
    if (parsed.clientEmail) CFG.clientEmail = parsed.clientEmail;
    if (parsed.clientPhone) CFG.clientPhone = parsed.clientPhone;
    if (parsed.startDate) CFG.startDate = parsed.startDate;
    if (parsed.endDate) CFG.endDate = parsed.endDate;
    if (parsed.origin && CFG.jobs.length) CFG.jobs[0].origin = parsed.origin;
    if (parsed.dest && CFG.jobs.length) CFG.jobs[0].dest = parsed.dest;
    cfgRenderStage(); // re-render to show chips
    toast('Details extracted — review the highlighted fields');
  })
  .catch(function(){ btn.innerHTML='&#10003; Extract Details'; btn.disabled=false; toast('API error'); });
}

function cfgChipEdit(chipEl, key) {
  chipEl.style.display = 'none';
  var inp = el('aied-' + key);
  if (inp) { inp.style.display = 'inline-block'; inp.focus(); inp.select(); }
}

function cfgChipConfirm(inp, key) {
  var val = inp.value.trim();
  if (CFG.aiParsed) {
    CFG.aiParsed[key] = val;
    if (!CFG.aiParsed._conf) CFG.aiParsed._conf = {};
    CFG.aiParsed._conf[key] = 'confirmed';
  }
  // Pre-fill CFG
  if (key==='clientName') CFG.clientName=val;
  if (key==='clientEmail') CFG.clientEmail=val;
  if (key==='clientPhone') CFG.clientPhone=val;
  if (key==='startDate') CFG.startDate=val;
  if (key==='origin' && CFG.jobs.length) CFG.jobs[0].origin=val;
  if (key==='dest' && CFG.jobs.length) CFG.jobs[0].dest=val;
  inp.style.display = 'none';
  cfgRenderStage();
}

// ── STAGE 2: JOB CONFIGURATION ────────────────────────────────────────
var JOB_TYPES = [
  {type:'Origin Sea Pack', icon:'🚢', sub:'Sea shipment'},
  {type:'Origin Air Pack', icon:'✈️', sub:'Air shipment'},
  {type:'Origin Road Pack', icon:'🚛', sub:'Road/groupage'},
  {type:'Destination Services', icon:'📦', sub:'Unpack/place'},
  {type:'Ex Store Delivery', icon:'🏭', sub:'From storage'},
  {type:'Int Store Handling', icon:'🗄', sub:'Into storage'},
  {type:'Blanket Wrap', icon:'🛋', sub:'Wrap & protect'},
  {type:'Debris Removal', icon:'🗑', sub:'Collect debris'},
  {type:'Handling Only', icon:'🤲', sub:'No packing'},
  {type:'Consolidation', icon:'📫', sub:'Group shipment'},
  {type:'Door to Door', icon:'🏠', sub:'Full service'},
  {type:'Other', icon:'⚙️', sub:'Custom job'},
];
var DEST_TYPES = [
  {type:'Client Property', icon:'🏠'},
  {type:'Int Store', icon:'🗄'},
  {type:'Container at Property', icon:'🚢'},
  {type:'Port / Depot', icon:'⚓'},
  {type:'Warehouse', icon:'🏭'},
  {type:'Consolidation Hub', icon:'📫'},
];
var SERVICES = [
  {key:'casing',     icon:'📦', lbl:'Casing (Air export)'},
  {key:'crating',    icon:'🪵', lbl:'Crating / Wooden crate'},
  {key:'handyman',   icon:'🔧', lbl:'Handyman (assembly)'},
  {key:'electrician',icon:'⚡', lbl:'Electrician'},
  {key:'gasEngineer',icon:'🔥', lbl:'Gas Engineer'},
  {key:'piano',      icon:'🎹', lbl:'Piano Specialist'},
  {key:'packingMaterials', icon:'🗃', lbl:'Packing materials'},
  {key:'debris',     icon:'🗑', lbl:'Debris collection'},
];
var ACCESS_FLAGS = [
  {key:'smallVehicle',   icon:'🚐', lbl:'Small vehicle required'},
  {key:'tightAccess',    icon:'📐', lbl:'Tight access'},
  {key:'shuttle',        icon:'🔄', lbl:'Shuttle service'},
  {key:'parkingSuspension', icon:'🅿️', lbl:'Parking suspension'},
  {key:'permit',         icon:'📋', lbl:'Permit required'},
  {key:'rdRestriction',  icon:'🚫', lbl:'Road restriction'},
];

function cfgRenderJobs() {
  var h = '';
  // Each configured job is a card
  for (var ji = 0; ji < CFG.jobs.length; ji++) {
    h += cfgRenderJobCard(ji, CFG.jobs[ji]);
  }
  h += '<button class="btn btn-s" style="width:100%;margin-top:4px" onclick="cfgAddJob()">+ Add Another Job Component</button>';
  h += '<div class="cs-hint" style="margin-top:10px">&#128161; Each card below becomes a separate calendar entry, all linked to this booking. E.g. add one card for a 1000ft³ sea pack and a second for a 95ft³ air pack on the same day — they will be grouped together on the calendar.</div>';
  return h;
}

function cfgRenderJobCard(ji, jb) {
  var h = '<div class="jcfg-card" id="jcfg-' + ji + '">';
  h += '<div class="jcfg-head">';
  h += '<div class="jcfg-num">' + (ji + 1) + '</div>';
  h += '<div class="jcfg-label">' + (jb.jobType || 'Job ' + (ji+1) + ' — select type below') + '</div>';
  if (CFG.jobs.length > 1) h += '<button class="btn btn-g btn-sm" onclick="cfgRemoveJob(' + ji + ')">&#10005; Remove</button>';
  h += '</div>';
  h += '<div class="jcfg-body">';

  // Job type
  h += '<div class="cs-sub-label">Job Type</div>';
  h += '<div class="jtype-grid">';
  for (var ti = 0; ti < JOB_TYPES.length; ti++) {
    var jt = JOB_TYPES[ti];
    h += '<div class="jtype-tile' + (jb.jobType === jt.type ? ' sel' : '') + '" onclick="cfgSetJobType(' + ji + ',this,\'' + jt.type.replace(/'/g,"\\'") + '\')">';
    h += '<span class="jtype-icon">' + jt.icon + '</span>';
    h += '<div class="jtype-lbl">' + jt.type + '</div>';
    h += '<div class="jtype-sub">' + jt.sub + '</div>';
    h += '</div>';
  }
  h += '</div>';

  // Addresses
  h += '<hr style="border:none;border-top:1px solid #ede9e0;margin:12px 0">';
  h += '<div class="cs-sub-label">Route</div>';
  h += '<div class="jcfg-row col2">';
  h += cfgField('Origin Address *', 'jcfg-origin-'+ji, jb.origin, 'text', 'Full address or postcode');
  h += cfgField('Destination Address *', 'jcfg-dest-'+ji, jb.dest, 'text', 'Full address or postcode');
  h += '</div>';

  // Destination type
  h += '<div class="cs-sub-label">Where does this job\'s goods go?</div>';
  h += '<div class="dest-grid">';
  for (var di = 0; di < DEST_TYPES.length; di++) {
    var dt = DEST_TYPES[di];
    h += '<div class="dest-tile' + (jb.destType === dt.type ? ' sel' : '') + '" onclick="cfgSetDestType(' + ji + ',this,\'' + dt.type.replace(/'/g,"\\'") + '\')">';
    h += '<span class="dest-icon">' + dt.icon + '</span>';
    h += '<span style="font-size:11px;font-weight:600;color:#1A2035">' + dt.type + '</span>';
    h += '</div>';
  }
  h += '</div>';

  // Volume
  h += '<hr style="border:none;border-top:1px solid #ede9e0;margin:12px 0">';
  h += '<div class="cs-sub-label">Volume / Size</div>';
  h += '<div class="vol-row">';
  h += '<input class="cfg-input" id="jcfg-vol-'+ji+'" type="number" value="'+esc(jb.volFt||'')+'" min="0" placeholder="0" style="width:120px">';
  h += '<button class="vol-unit-btn'+(jb.volUnit!=='cbm'?' sel':'')+'" onclick="cfgSetVolUnit('+ji+',\'ft\',this)">ft³</button>';
  h += '<button class="vol-unit-btn'+(jb.volUnit==='cbm'?' sel':'')+'" onclick="cfgSetVolUnit('+ji+',\'cbm\',this)">CBM</button>';
  h += '</div>';

  // Storage
  h += '<hr style="border:none;border-top:1px solid #ede9e0;margin:12px 0">';
  h += cfgRenderStoragePanel(ji, jb);

  // Additional services
  h += '<hr style="border:none;border-top:1px solid #ede9e0;margin:12px 0">';
  h += '<div class="cs-sub-label">Additional Services</div>';
  h += '<div class="svc-grid">';
  for (var si = 0; si < SERVICES.length; si++) {
    var sv = SERVICES[si];
    h += '<div class="svc-toggle' + (jb.svcs[sv.key] ? ' on' : '') + '" onclick="cfgToggleSvc(' + ji + ',this,\'' + sv.key + '\')">';
    h += '<span style="font-size:14px">' + sv.icon + '</span>';
    h += '<span style="font-size:11.5px;font-weight:600;color:#1A2035;flex:1">' + sv.lbl + '</span>';
    h += '<div class="svc-check">' + (jb.svcs[sv.key] ? '&#10003;' : '') + '</div>';
    h += '</div>';
  }
  h += '</div>';

  // Access flags
  h += '<hr style="border:none;border-top:1px solid #ede9e0;margin:12px 0">';
  h += '<div class="cs-sub-label">Access &amp; Logistics</div>';
  h += '<div class="acc-grid">';
  for (var ai = 0; ai < ACCESS_FLAGS.length; ai++) {
    var af = ACCESS_FLAGS[ai];
    h += '<div class="acc-flag svc-toggle' + (jb.access[af.key] ? ' on' : '') + '" onclick="cfgToggleAccess(' + ji + ',this,\'' + af.key + '\')">';
    h += '<span style="font-size:14px">' + af.icon + '</span>';
    h += '<span style="font-size:11.5px;font-weight:600;color:#1A2035;flex:1">' + af.lbl + '</span>';
    h += '<div class="svc-check">' + (jb.access[af.key] ? '&#10003;' : '') + '</div>';
    h += '</div>';
  }
  h += '</div>';

  // Billing for this job
  h += '<hr style="border:none;border-top:1px solid #ede9e0;margin:12px 0">';
  h += '<div class="cs-sub-label">Billing Lines for this Job</div>';
  h += '<div id="jcfg-blines-'+ji+'">';
  var jblines = jb.billing || [];
  for (var bi = 0; bi < jblines.length; bi++) {
    h += cfgBline(ji, bi, jblines[bi].item, jblines[bi].amt);
  }
  if (!jblines.length) h += cfgBline(ji, 0, '', '');
  h += '</div>';
  h += '<button class="btn btn-s btn-sm" style="margin-top:4px" onclick="cfgAddBline('+ji+')">+ Add billing line</button>';

  h += '</div></div>'; // jcfg-body, jcfg-card
  return h;
}

function cfgBline(ji, bi, item, amt) {
  return '<div class="bline-compact" id="jbl-'+ji+'-'+bi+'">' +
    '<input style="flex:2" placeholder="e.g. Origin charge" value="'+esc(item||'')+'" id="jbli-'+ji+'-'+bi+'">' +
    '<input class="amt" style="flex:0 0 110px" type="number" placeholder="Amount" value="'+(amt||'')+'" step="0.01" min="0" id="jbla-'+ji+'-'+bi+'">' +
    '<div class="bline-rm" onclick="el(\'jbl-'+ji+'-'+bi+'\').remove()">&#10005;</div>' +
    '</div>';
}

// ── STORAGE PANEL (Stage 2 — per job card) ────────────────────────────

// Determine if a job type implies inbound or outbound storage
function cfgStorageDirection(jobType) {
  var inTypes  = ['Origin Sea Pack','Origin Air Pack','Origin Road Pack','Int Store Handling','Door to Door'];
  var outTypes = ['Ex Store Delivery','Destination Services'];
  if (inTypes.indexOf(jobType) >= 0) return 'in';
  if (outTypes.indexOf(jobType) >= 0) return 'out';
  return null;
}

function cfgRenderStoragePanel(ji, jb) {
  var h = '<div id="sto-panel-' + ji + '">';

  // Toggle row
  h += '<div class="mday-row" style="margin-bottom:' + (jb.storageRequired ? '10px' : '0') + '">';
  h += '<label class="mday-toggle"><input type="checkbox" id="jcfg-store-' + ji + '"' + (jb.storageRequired ? ' checked' : '') + ' onchange="cfgToggleStorage(' + ji + ',this)"><span class="mday-slider"></span></label>';
  h += '<div style="flex:1"><div class="mday-lbl">Warehouse Storage Involved</div><div class="mday-sub">Goods coming in to or going out from our warehouse</div></div>';
  h += '</div>';

  if (!jb.storageRequired) { h += '</div>'; return h; }

  // Direction tiles — auto-suggest based on job type
  var autoDir = cfgStorageDirection(jb.jobType);
  if (!jb.storageDirection && autoDir) jb.storageDirection = autoDir;

  h += '<div class="sto-dir-tiles">';
  var dirs = [
    {key:'in',  icon:'⬇️', lbl:'Goods IN to warehouse', sub:'Origin pack / packing job — goods arriving into storage'},
    {key:'out', icon:'⬆️', lbl:'Goods OUT from warehouse', sub:'Delivery / destination job — goods leaving storage'},
  ];
  for (var di = 0; di < dirs.length; di++) {
    var d = dirs[di];
    h += '<div class="sto-dir-tile' + (jb.storageDirection === d.key ? ' sel' : '') + '" onclick="cfgSetStorageDir(' + ji + ',\'' + d.key + '\')">';
    h += '<div class="sto-dir-icon">' + d.icon + '</div>';
    h += '<div><div class="sto-dir-lbl">' + d.lbl + '</div><div class="sto-dir-sub">' + d.sub + '</div></div>';
    h += '</div>';
  }
  h += '</div>';

  if (!jb.storageDirection) { h += '</div>'; return h; }

  if (jb.storageDirection === 'in') {
    h += cfgRenderStorageIn(ji, jb);
  } else {
    h += cfgRenderStorageOut(ji, jb);
  }

  h += '</div>';
  return h;
}

function cfgRenderStorageIn(ji, jb) {
  var h = '';
  h += '<div class="cs-sub-label">Storage Record — Incoming Goods</div>';

  // Option: existing or new
  h += '<div style="display:flex;gap:8px;margin-bottom:10px">';
  h += '<label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12.5px;font-weight:600">';
  h += '<input type="radio" name="sto-mode-' + ji + '" value="existing"' + (!jb.storageIsNew ? ' checked' : '') + ' onchange="cfgSetStorageMode(' + ji + ',\'existing\')"> Use existing record</label>';
  h += '<label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12.5px;font-weight:600">';
  h += '<input type="radio" name="sto-mode-' + ji + '" value="new"' + (jb.storageIsNew ? ' checked' : '') + ' onchange="cfgSetStorageMode(' + ji + ',\'new\')"> Create new record</label>';
  h += '</div>';

  if (!jb.storageIsNew) {
    // Search existing
    h += '<div class="cfg-field"><label class="cfg-label">Search by client name</label>';
    h += '<input class="cfg-input" id="sto-search-' + ji + '" type="text" placeholder="Start typing client name…" value="' + esc(jb.storageSearchTerm || '') + '" oninput="cfgStorageSearch(' + ji + ',this.value)" style="max-width:280px">';
    h += '</div>';
    h += '<div id="sto-results-' + ji + '">';
    h += cfgRenderStorageSearchResults(ji, jb.storageSearchTerm || '', jb.storageId);
    h += '</div>';
    if (jb.storageId) {
      var rec = STORAGE_RECORDS.filter(function(s){return s.id === jb.storageId;})[0];
      if (rec) {
        h += '<div class="cs-hint" style="margin-top:6px">&#128230; Volume provision: <strong>' + (parseFloat(jb.volFt)||0) + ' ft³</strong> noted against record ' + esc(rec.id) + ' — containers will be assigned when goods arrive at warehouse.</div>';
      }
    }
  } else {
    // New storage record fields
    h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;background:var(--s1);border:1px solid var(--b1);border-radius:7px;padding:12px">';
    h += '<div class="cfg-field"><label class="cfg-label">Storage Type</label><select class="cfg-input cfg-select" id="sto-type-' + ji + '">';
    h += '<option value="longterm"' + (jb.newStorageType === 'longterm' ? ' selected' : '') + '>Long-term</option>';
    h += '<option value="inout"' + (jb.newStorageType === 'inout' ? ' selected' : '') + '>In/Out</option>';
    h += '</select></div>';
    h += '<div class="cfg-field"><label class="cfg-label">Billing Period</label><select class="cfg-input cfg-select" id="sto-btype-' + ji + '">';
    ['monthly','weekly','flat'].forEach(function(b){ h += '<option' + (jb.newStorageBillingType === b ? ' selected' : '') + '>' + b + '</option>'; });
    h += '</select></div>';
    h += '<div class="cfg-field"><label class="cfg-label">Rate £</label><input class="cfg-input" id="sto-rate-' + ji + '" type="number" value="' + (jb.newStorageBillingRate || 85) + '" min="0" step="0.01"></div>';
    h += '<div class="cfg-field"><label class="cfg-label">Rate Unit</label><select class="cfg-input cfg-select" id="sto-bunit-' + ji + '">';
    h += '<option value="cbm"' + (jb.newStorageBillingUnit === 'cbm' ? ' selected' : '') + '>Rate × CBM</option>';
    h += '<option value="flat"' + (jb.newStorageBillingUnit === 'flat' ? ' selected' : '') + '>Flat rate</option>';
    h += '</select></div>';
    h += '</div>';
    h += '<div class="cs-hint" style="margin-top:8px">&#128221; A new storage record will be created on booking. Container numbers and warehouse locations are assigned when goods arrive.</div>';
  }
  return h;
}

function cfgRenderStorageOut(ji, jb) {
  var h = '';
  h += '<div class="cs-sub-label">Storage Record — Outgoing Delivery</div>';

  // Search by client name
  h += '<div class="cfg-field"><label class="cfg-label">Find client storage record</label>';
  h += '<input class="cfg-input" id="sto-search-' + ji + '" type="text" placeholder="Start typing client name…" value="' + esc(jb.storageSearchTerm || '') + '" oninput="cfgStorageSearch(' + ji + ',this.value)" style="max-width:280px">';
  h += '</div>';
  h += '<div id="sto-results-' + ji + '">';
  h += cfgRenderStorageSearchResults(ji, jb.storageSearchTerm || '', jb.storageId);
  h += '</div>';

  if (jb.storageId) {
    var rec = STORAGE_RECORDS.filter(function(s){return s.id === jb.storageId;})[0];
    if (rec) {
      h += '<hr style="border:none;border-top:1px solid #ede9e0;margin:10px 0">';
      h += '<div class="cs-sub-label">Select containers / items being delivered out</div>';
      var containers = rec.containers || [];
      if (containers.length) {
        for (var ci = 0; ci < containers.length; ci++) {
          var ct = containers[ci];
          var isSel = (jb.containersToRemove || []).indexOf(ct.containerNo) >= 0;
          var ctypeDef = CONTAINER_TYPES.filter(function(x){return x.key === ct.type;})[0];
          var ctypeLbl = ctypeDef ? ctypeDef.lbl.split('(')[0].trim() : ct.type;
          h += '<div class="sto-container-row' + (isSel ? ' sel' : '') + '" id="stoct-' + ji + '-' + ci + '" onclick="cfgToggleContainer(' + ji + ',\'' + ct.containerNo + '\',' + ci + ')">';
          h += '<input type="checkbox" class="sto-remove-cb" ' + (isSel ? 'checked' : '') + ' onclick="event.stopPropagation();cfgToggleContainer(' + ji + ',\'' + ct.containerNo + '\',' + ci + ')">';
          h += '<span class="sto-cno">' + esc(ct.containerNo) + '</span>';
          h += '<span class="sto-loc">📍 ' + esc(ct.locNo) + '</span>';
          h += '<span class="sto-ctype">' + esc(ctypeLbl) + '</span>';
          h += '<span class="sto-cvol">' + ct.volFt + ' ft³</span>';
          h += '</div>';
        }
      } else {
        h += '<div class="cs-hint">No containers assigned yet — containers will be confirmed at point of collection.</div>';
      }

      // Volume removal calculator
      h += '<div class="sto-vol-calc">';
      h += '<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#9A5600;margin-bottom:8px">📊 Volume & Delivery Calculator</div>';
      h += '<div class="sto-vol-row"><span class="sto-vol-lbl">Total volume in storage</span><span class="sto-vol-val">' + (rec.volRemaining || rec.volFt || 0) + ' ft³</span></div>';
      h += '<div class="sto-vol-row"><span class="sto-vol-lbl">Volume being removed today</span>';
      h += '<span class="sto-vol-val"><input class="cfg-input" id="sto-volremove-' + ji + '" type="number" min="0" max="' + (rec.volRemaining || rec.volFt || 9999) + '" value="' + (jb.volToRemove || '') + '" placeholder="ft³" style="width:90px;display:inline-block;text-align:right" oninput="cfgCalcVolRemaining(' + ji + ')"></span>';
      h += '</div>';
      var remaining = (rec.volRemaining || rec.volFt || 0) - (parseFloat(jb.volToRemove) || 0);
      var isPartial = remaining > 0;
      h += '<div class="sto-vol-row" style="border-top:1px solid #FFD580;margin-top:4px;padding-top:8px"><span class="sto-vol-lbl">Remaining after delivery</span><span class="sto-vol-val ' + (remaining < 0 ? 'red' : remaining === 0 ? 'green' : '') + '" id="sto-remaining-' + ji + '">' + (remaining >= 0 ? remaining : '<span style="color:#E44258">⚠ exceeds storage</span>') + ' ft³</span></div>';
      if (remaining < 0) h += '<div class="cs-hint" style="margin-top:6px;background:#FFECEF;border-color:#F5A0AA">⚠ Volume to remove exceeds what\'s recorded in storage. Please check and adjust.</div>';
      else if (remaining === 0) h += '<div class="cs-hint" style="margin-top:6px;background:#E6FFF5;border-color:#7DD9B0">✓ Full clearance — storage record will be marked as cleared on commit.</div>';
      else h += '<div class="cs-hint" style="margin-top:6px">Partial delivery — storage record will remain active with ' + remaining + ' ft³ remaining.</div>';
      h += '</div>'; // sto-vol-calc
    }
  }
  return h;
}

function cfgRenderStorageSearchResults(ji, term, selectedId) {
  var h = '';
  if (!term && !selectedId) return h;
  var active = STORAGE_RECORDS.filter(function(s){ return s.status === 'active' || s.status === 'pending'; });
  var results = term ? active.filter(function(s){
    return s.client.toLowerCase().indexOf(term.toLowerCase()) >= 0 ||
           s.id.toLowerCase().indexOf(term.toLowerCase()) >= 0;
  }) : (selectedId ? active.filter(function(s){return s.id === selectedId;}) : []);

  if (!results.length && term) {
    h += '<div style="font-size:12px;color:#7A849E;padding:6px 0">No active storage records found for "' + esc(term) + '"</div>';
    return h;
  }
  for (var ri = 0; ri < results.length; ri++) {
    var s = results[ri];
    var isSel = s.id === selectedId;
    var stLbl = s.status === 'active' ? 'Active' : 'Pending';
    var stCls = s.status === 'active' ? '' : ' pending';
    h += '<div class="sto-rec-card' + (isSel ? ' sel' : '') + '" onclick="cfgSelectStorageRec(' + ji + ',\'' + s.id + '\')">';
    h += '<div class="sto-rec-head">';
    h += '<span class="sto-rec-id">' + esc(s.id) + '</span>';
    h += '<span class="sto-rec-client">' + esc(s.client) + '</span>';
    h += '<span class="sto-status-badge' + stCls + '">' + stLbl + '</span>';
    h += '</div>';
    var containers = s.containers || [];
    var totalVol = containers.reduce(function(a, c){ return a + (c.volFt || 0); }, 0);
    h += '<div style="display:flex;gap:14px;font-size:11px;color:#7A849E">';
    h += '<span>📦 ' + containers.length + ' container' + (containers.length !== 1 ? 's' : '') + '</span>';
    h += '<span>📐 ' + (s.volRemaining || s.volFt || 0) + ' ft³ remaining</span>';
    if (containers.length) h += '<span>📍 ' + esc(containers.map(function(c){return c.locNo;}).join(', ').substring(0,40)) + '</span>';
    h += '</div>';
    h += '</div>';
  }
  return h;
}

// ── Storage panel event handlers ─────────────────────────────────────
function cfgToggleStorage(ji, inp) {
  CFG.jobs[ji].storageRequired = inp.checked;
  if (inp.checked && !CFG.jobs[ji].storageDirection) {
    CFG.jobs[ji].storageDirection = cfgStorageDirection(CFG.jobs[ji].jobType) || null;
  }
  cfgRenderStage();
}

function cfgSetStorageDir(ji, dir) {
  CFG.jobs[ji].storageDirection = dir;
  cfgRenderStage();
}

function cfgSetStorageMode(ji, mode) {
  CFG.jobs[ji].storageIsNew = (mode === 'new');
  CFG.jobs[ji].storageId = '';
  cfgRenderStage();
}

function cfgStorageSearch(ji, term) {
  CFG.jobs[ji].storageSearchTerm = term;
  var resultsEl = el('sto-results-' + ji);
  if (resultsEl) resultsEl.innerHTML = cfgRenderStorageSearchResults(ji, term, CFG.jobs[ji].storageId);
}

function cfgSelectStorageRec(ji, sid) {
  CFG.jobs[ji].storageId = CFG.jobs[ji].storageId === sid ? '' : sid;
  CFG.jobs[ji].containersToRemove = [];
  CFG.jobs[ji].volToRemove = 0;
  // Update search input value to the client name for clarity
  var rec = STORAGE_RECORDS.filter(function(s){return s.id === sid;})[0];
  if (rec) {
    CFG.jobs[ji].storageSearchTerm = rec.client;
    var inp = el('sto-search-' + ji);
    if (inp) inp.value = rec.client;
  }
  cfgRenderStage();
}

function cfgToggleContainer(ji, containerNo, ci) {
  if (!CFG.jobs[ji].containersToRemove) CFG.jobs[ji].containersToRemove = [];
  var idx = CFG.jobs[ji].containersToRemove.indexOf(containerNo);
  if (idx >= 0) {
    CFG.jobs[ji].containersToRemove.splice(idx, 1);
  } else {
    CFG.jobs[ji].containersToRemove.push(containerNo);
  }
  // Update checkbox and row visual directly without full re-render
  var row = el('stoct-' + ji + '-' + ci);
  if (row) {
    var isSel = CFG.jobs[ji].containersToRemove.indexOf(containerNo) >= 0;
    row.classList.toggle('sel', isSel);
    var cb = row.querySelector('.sto-remove-cb');
    if (cb) cb.checked = isSel;
  }
}

function cfgCalcVolRemaining(ji) {
  var inp = el('sto-volremove-' + ji);
  if (!inp) return;
  var volRemove = parseFloat(inp.value) || 0;
  CFG.jobs[ji].volToRemove = volRemove;
  var rec = STORAGE_RECORDS.filter(function(s){return s.id === CFG.jobs[ji].storageId;})[0];
  if (!rec) return;
  var remaining = (rec.volRemaining || rec.volFt || 0) - volRemove;
  var remEl = el('sto-remaining-' + ji);
  if (remEl) {
    remEl.textContent = remaining + ' ft³';
    remEl.className = 'sto-vol-val' + (remaining < 0 ? ' red' : remaining === 0 ? ' green' : '');
  }
}

var cfgBlineCounts = {};
function cfgAddBline(ji) {
  if (!cfgBlineCounts[ji]) cfgBlineCounts[ji] = 10;
  cfgBlineCounts[ji]++;
  var ct = cfgBlineCounts[ji];
  var cont = el('jcfg-blines-' + ji);
  if (cont) cont.insertAdjacentHTML('beforeend', cfgBline(ji, ct, '', ''));
}

function cfgCollectJobs() {
  for (var ji = 0; ji < CFG.jobs.length; ji++) {
    var jb = CFG.jobs[ji];
    jb.origin = (el('jcfg-origin-'+ji)||{}).value || jb.origin;
    jb.dest   = (el('jcfg-dest-'+ji)||{}).value   || jb.dest;
    var volEl = el('jcfg-vol-'+ji);
    if (volEl) { if (jb.volUnit === 'cbm') jb.volCbm = volEl.value; else jb.volFt = volEl.value; }
    var stEl = el('jcfg-store-'+ji); if (stEl) jb.storageRequired = stEl.checked;
    // Collect vol to remove (outbound)
    var vrEl = el('sto-volremove-'+ji); if (vrEl) jb.volToRemove = parseFloat(vrEl.value)||0;
    // Collect new storage billing fields
    var stTypeEl = el('sto-type-'+ji); if (stTypeEl) jb.newStorageType = stTypeEl.value;
    var stBTypeEl = el('sto-btype-'+ji); if (stBTypeEl) jb.newStorageBillingType = stBTypeEl.value;
    var stRateEl = el('sto-rate-'+ji); if (stRateEl) jb.newStorageBillingRate = parseFloat(stRateEl.value)||85;
    var stBUnitEl = el('sto-bunit-'+ji); if (stBUnitEl) jb.newStorageBillingUnit = stBUnitEl.value;
    // Collect billing lines
    var blines = [];
    var cont = el('jcfg-blines-'+ji);
    if (cont) {
      var rows = cont.querySelectorAll('[id^="jbl-'+ji+'-"]');
      rows.forEach(function(row) {
        var itemEl = row.querySelector('[id^="jbli"]'), amtEl = row.querySelector('[id^="jbla"]');
        var item = (itemEl||{}).value||''; var amt = parseFloat((amtEl||{}).value)||0;
        if (item) blines.push({item:item, amt:amt});
      });
    }
    jb.billing = blines;
  }
}

function cfgSetJobType(ji, tileEl, type) {
  CFG.jobs[ji].jobType = type;
  // Auto-suggest storage direction based on job type
  var autoDir = cfgStorageDirection(type);
  if (autoDir && CFG.jobs[ji].storageRequired) {
    CFG.jobs[ji].storageDirection = autoDir;
  }
  var card = el('jcfg-' + ji);
  if (card) {
    var tiles = card.querySelectorAll('.jtype-tile');
    tiles.forEach(function(t){t.classList.remove('sel');});
    tileEl.classList.add('sel');
    var lbl = card.querySelector('.jcfg-label');
    if (lbl) lbl.textContent = type;
  }
}

function cfgSetDestType(ji, tileEl, type) {
  CFG.jobs[ji].destType = type;
  var card = el('jcfg-' + ji);
  if (card) {
    card.querySelectorAll('.dest-tile').forEach(function(t){t.classList.remove('sel');});
    tileEl.classList.add('sel');
  }
}

function cfgToggleSvc(ji, el_ref, key) {
  CFG.jobs[ji].svcs[key] = !CFG.jobs[ji].svcs[key];
  el_ref.classList.toggle('on', CFG.jobs[ji].svcs[key]);
  var chk = el_ref.querySelector('.svc-check');
  if (chk) chk.innerHTML = CFG.jobs[ji].svcs[key] ? '&#10003;' : '';
}

function cfgToggleAccess(ji, el_ref, key) {
  CFG.jobs[ji].access[key] = !CFG.jobs[ji].access[key];
  el_ref.classList.toggle('on', CFG.jobs[ji].access[key]);
  var chk = el_ref.querySelector('.svc-check');
  if (chk) chk.innerHTML = CFG.jobs[ji].access[key] ? '&#10003;' : '';
  // Auto-suggest small vehicle if tight access or road restriction
  if ((key==='tightAccess'||key==='rdRestriction') && CFG.jobs[ji].access[key]) {
    CFG.jobs[ji].access.smallVehicle = true;
    toast('Small vehicle flagged for tight/restricted access');
  }
}

function cfgSetVolUnit(ji, unit, btnEl) {
  CFG.jobs[ji].volUnit = unit;
  var card = el('jcfg-' + ji);
  if (card) card.querySelectorAll('.vol-unit-btn').forEach(function(b){b.classList.remove('sel');});
  btnEl.classList.add('sel');
}

function cfgAddJob() {
  cfgCollectJobs();
  CFG.jobs.push(cfgEmptyJob());
  cfgRenderStage();
  // scroll to new card
  el('cfg-body').scrollTop = el('cfg-body').scrollHeight;
}

function cfgRemoveJob(ji) {
  if (CFG.jobs.length <= 1) { toast('At least one job required'); return; }
  cfgCollectJobs();
  CFG.jobs.splice(ji, 1);
  cfgRenderStage();
}

// ── STAGE 3: SCHEDULE ─────────────────────────────────────────────────
function cfgRenderSchedule() {
  var h = '';

  // ── Date mode card ───────────────────────────────────────────────────
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">📅</div>';
  h += '<div class="cs-card-title">Date Selection</div></div>';
  h += '<div class="cs-body">';

  // Radio: fix date vs no date yet
  h += '<div style="display:flex;gap:14px;margin-bottom:16px">';
  h += '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12.5px;font-weight:600;color:#1A2035">';
  h += '<input type="radio" name="cfg-dateoption" value="fix" '+((CFG.selectedDates&&CFG.selectedDates.length)||CFG.startDate?'checked':'')+' onchange="cfgToggleDateOption(\'fix\')">';
  h += 'Assign dates now</label>';
  h += '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12.5px;font-weight:600;color:#1A2035">';
  h += '<input type="radio" name="cfg-dateoption" value="nodate" '+((!CFG.selectedDates||!CFG.selectedDates.length)&&!CFG.startDate?'checked':'')+' onchange="cfgToggleDateOption(\'nodate\')">';
  h += 'No date yet (save as enquiry)</label>';
  h += '</div>';

  h += '<div id="cfg-date-section" style="'+((CFG.selectedDates&&CFG.selectedDates.length)||CFG.startDate?'':'display:none')+'">';

  if (!CFG.isMultiDay) {
    // Single day — one blank date picker, no pre-fill on new booking
    var singleVal = (CFG.selectedDates && CFG.selectedDates[0]) ? CFG.selectedDates[0] : (CFG.startDate || '');
    // Only show existing value if editing, not on brand new booking (id not set = new)
    if (!CFG.id) singleVal = '';
    h += '<div class="cfg-field"><label class="cfg-label">Select a date from the matrix below, or type manually</label>';
    h += '<input class="cfg-input" id="cfg-startdate" type="date" value="' + singleVal + '" onchange="cfgManualDateChange()" style="max-width:200px"></div>';
  } else {
    // Multi-day: show N day slots
    var n = CFG.numDays || 2;
    var chosen = CFG.selectedDates ? CFG.selectedDates.slice() : [];
    var filled = chosen.filter(function(d){return !!d;}).length;
    var done = filled >= n;

    // Progress bar
    h += '<div class="dayslot-progress">';
    h += '<div class="dp-label' + (done ? ' done' : '') + '">' + (done ? '✓ All ' + n + ' days selected' : filled + ' of ' + n + ' days selected') + '</div>';
    h += '<div class="dp-bar-wrap"><div class="dp-bar" style="width:' + Math.round((filled/n)*100) + '%"></div></div>';
    h += '</div>';

    // Day slots
    h += '<div style="margin-bottom:12px">';
    for (var si = 0; si < n; si++) {
      var slotDate = chosen[si] || '';
      var isFilled = !!slotDate;
      h += '<div class="dayslot-row">';
      h += '<div class="dayslot-num' + (isFilled ? ' filled' : '') + '">Day ' + (si+1) + '</div>';
      h += '<div class="dayslot-val' + (isFilled ? ' filled' : '') + '" id="ds-val-' + si + '">';
      if (isFilled) {
        h += '<span>📅 ' + fmtNice(slotDate) + ' (' + ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(slotDate).getDay()] + ')</span>';
        h += '<span class="ds-clear" onclick="cfgClearSlot(' + si + ')">✕ clear</span>';
      } else {
        h += '<span style="color:#B0B8CC">Click a date in the matrix below</span>';
      }
      h += '</div></div>';
    }
    h += '</div>';

    if (!done) {
      h += '<div class="cs-hint">Click any date in the availability matrix below to assign it to the next empty slot. Dates can be non-consecutive — e.g. pick Mon 24th then skip to Thu 27th.</div>';
    }
  }
  h += '</div>'; // cfg-date-section
  h += '</div></div>'; // cs-body, cs-card

  // ── Duration & Overnights card ───────────────────────────────────────
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#FFF5E0">🌙</div>';
  h += '<div class="cs-card-title">Duration &amp; Overnights</div></div>';
  h += '<div class="cs-body">';

  // Multi-day toggle
  h += '<div class="mday-row"><label class="mday-toggle"><input type="checkbox" id="cfg-multiday"' + (CFG.isMultiDay ? ' checked' : '') + ' onchange="cfgToggleMultiday(this)"><span class="mday-slider"></span></label>';
  h += '<div style="flex:1"><div class="mday-lbl">Multi-day job</div><div class="mday-sub">Job spans more than one calendar day — you\'ll select each day individually</div></div>';
  if (CFG.isMultiDay) {
    h += '<div style="display:flex;align-items:center;gap:6px;flex-shrink:0">';
    h += '<span style="font-size:12px;color:#7A849E">Total days:</span>';
    h += '<input class="cfg-input" id="cfg-numdays" type="number" min="2" max="30" value="' + (CFG.numDays || 2) + '" style="width:64px" onchange="cfgNumDaysChange(this)">';
    h += '</div>';
  }
  h += '</div>';

  // Overnight toggle
  h += '<div class="mday-row"><label class="mday-toggle"><input type="checkbox" id="cfg-overnight"' + (CFG.hasOvernight ? ' checked' : '') + ' onchange="cfgToggleOvernight(this)"><span class="mday-slider"></span></label>';
  h += '<div style="flex:1"><div class="mday-lbl">Overnight stays required</div><div class="mday-sub">Crew will need accommodation</div></div>';
  if (CFG.hasOvernight) {
    h += '<div style="display:flex;align-items:center;gap:6px;flex-shrink:0">';
    h += '<input class="cfg-input" id="cfg-numnights" type="number" min="1" max="14" value="' + (CFG.numNights || 1) + '" style="width:56px">';
    h += '<span style="font-size:12px;color:#7A849E">nights @&thinsp;£</span>';
    h += '<input class="cfg-input" id="cfg-nightallow" type="number" min="0" value="' + (CFG.overnightAllowance || 65) + '" style="width:68px">';
    h += '<span style="font-size:12px;color:#7A849E">/person</span>';
    h += '</div>';
  }
  h += '</div>';

  // Weekend
  h += '<div class="mday-row"><label class="mday-toggle"><input type="checkbox" id="cfg-weekend"' + (CFG.weekendWorking ? ' checked' : '') + '><span class="mday-slider"></span></label>';
  h += '<div><div class="mday-lbl">Weekend working</div><div class="mday-sub">Saturday or Sunday working required</div></div></div>';

  // Journey link
  h += '<div class="mday-row" style="margin-bottom:0"><label class="mday-toggle"><input type="checkbox" id="cfg-linkjourney"' + (CFG.linkJourney ? ' checked' : '') + ' onchange="cfgToggleLinkJourney(this)"><span class="mday-slider"></span></label>';
  h += '<div style="flex:1"><div class="mday-lbl">Part of a Journey / Run</div><div class="mday-sub">Link to existing journey or create new</div></div>';
  if (CFG.linkJourney) {
    h += '<select class="cfg-input cfg-select" id="cfg-journeysel" style="width:200px;flex-shrink:0">';
    h += '<option value="_new">+ Create new journey</option>';
    for (var jni = 0; jni < JOURNEYS.length; jni++) {
      h += '<option value="' + JOURNEYS[jni].id + '"' + (CFG.journeyId === JOURNEYS[jni].id ? ' selected' : '') + '>' + esc(JOURNEYS[jni].label) + '</option>';
    }
    h += '</select>';
  }
  h += '</div>';
  h += '</div></div>'; // cs-body, cs-card

  // ── Availability matrix card ─────────────────────────────────────────
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#E6FFF5">📊</div>';
  h += '<div class="cs-card-title">4-Week Availability</div>';
  var matHint = CFG.isMultiDay
    ? '<div class="cs-card-sub">Click to fill day slots in order — can be non-consecutive</div>'
    : '<div class="cs-card-sub">Click any date to select it</div>';
  h += matHint;
  h += '</div>';
  h += '<div class="cs-body" id="cfg-avail-body"><div style="text-align:center;color:#7A849E;padding:20px;font-size:12px">Building availability matrix...</div></div>';
  h += '</div>';

  return h;
}

function cfgToggleDateOption(val) {
  var sec = el('cfg-date-section');
  if (sec) sec.style.display = val === 'fix' ? '' : 'none';
}

function cfgToggleMultiday(inp) {
  cfgCollectSchedule();
  CFG.isMultiDay = inp.checked;
  // Reset selected dates when toggling
  CFG.selectedDates = [];
  CFG.startDate = '';
  CFG.endDate = '';
  cfgRenderStage();
}

function cfgNumDaysChange(inp) {
  var n = parseInt(inp.value) || 2;
  CFG.numDays = n;
  // Trim selectedDates if fewer days entered
  if (CFG.selectedDates && CFG.selectedDates.length > n) CFG.selectedDates = CFG.selectedDates.slice(0, n);
  cfgRenderStage();
}

function cfgToggleOvernight(inp) {
  CFG.hasOvernight = inp.checked;
  cfgRenderStage();
}

function cfgToggleLinkJourney(inp) {
  CFG.linkJourney = inp.checked;
  cfgRenderStage();
}

function cfgManualDateChange() {
  var inp = el('cfg-startdate');
  if (!inp || !inp.value) return;
  var ds = inp.value;
  if (!CFG.selectedDates) CFG.selectedDates = [];
  CFG.selectedDates[0] = ds;
  CFG.startDate = ds;
  // Re-highlight matrix without full re-render
  cfgHighlightMatrix();
  // Show date section
  var fixRadio = document.querySelector('input[name="cfg-dateoption"][value="fix"]');
  if (fixRadio) fixRadio.checked = true;
  var sec = el('cfg-date-section');
  if (sec) sec.style.display = '';
}

function cfgClearSlot(slotIdx) {
  if (!CFG.selectedDates) CFG.selectedDates = [];
  CFG.selectedDates[slotIdx] = '';
  // Compact: remove empty trailing slots
  while (CFG.selectedDates.length > 0 && !CFG.selectedDates[CFG.selectedDates.length - 1]) {
    CFG.selectedDates.pop();
  }
  CFG.startDate = CFG.selectedDates[0] || '';
  CFG.endDate   = CFG.selectedDates[CFG.selectedDates.length - 1] || '';
  cfgRenderStage();
}

function cfgBuildMatrix() {
  var body = el('cfg-avail-body');
  if (!body) return;

  var today = new Date();
  today.setHours(0, 0, 0, 0);

  var resources = [];
  for (var ci = 0; ci < CREW.length; ci++) resources.push({type:'crew', name:CREW[ci].name, col:CREW[ci].col});
  for (var vi = 0; vi < VEHICLES.length; vi++) resources.push({type:'veh', name:VEHICLES[vi].name + ' (' + VEHICLES[vi].reg + ')', col:'#7A849E'});
  var numCols = Math.min(resources.length, 6);

  var selectedSet = {};
  (CFG.selectedDates || []).forEach(function(d, i){ if (d) selectedSet[d] = i + 1; });

  var h = '<div class="avail-matrix">';

  h += '<div class="avail-head-row">';
  h += '<div class="avail-head-date">Date</div>';
  for (var ri = 0; ri < numCols; ri++) {
    h += '<div class="avail-head-res">' + esc(resources[ri].name.split(' ')[0]) + '</div>';
  }
  h += '</div>';

  var DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  var MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  for (var di = 1; di <= 28; di++) {
    var d = new Date(today);
    d.setDate(d.getDate() + di);
    var ds = d.toISOString().slice(0, 10);
    var dow = d.getDay();
    var isWknd = dow === 0 || dow === 6;

    // Highlight: single-select = 'chosen', multi-select = 'chosen-multi' with slot number badge
    var slotNum = selectedSet[ds];
    var rowCls = 'avail-row';
    if (!CFG.isMultiDay && CFG.startDate === ds) rowCls += ' chosen';
    if (CFG.isMultiDay && slotNum) rowCls += ' chosen-multi';

    h += '<div class="' + rowCls + '" id="avrow-' + ds + '" onclick="cfgSelectDate(\'' + ds + '\')">';
    h += '<div class="avail-date-cell">';
    h += '<span>' + d.getDate() + ' ' + MONTHS[d.getMonth()] + (slotNum ? ' <strong style="color:#0073EA;font-size:10px">Day ' + slotNum + '</strong>' : '') + '</span>';
    h += '<span class="avail-dow">' + DAYS[dow] + '</span>';
    h += '</div>';

    for (var ri = 0; ri < numCols; ri++) {
      var res = resources[ri];
      var status = cfgGetAvail(res, ds, isWknd);
      h += '<div class="avail-res-cell"><div class="avail-bar ' + status.cls + '">' + status.lbl + '</div></div>';
    }
    h += '</div>';
  }

  h += '<div class="avail-legend">';
  h += '<div class="avail-leg-i"><div class="avail-leg-dot" style="background:#D1FAE5"></div>Free</div>';
  h += '<div class="avail-leg-i"><div class="avail-leg-dot" style="background:#FEF3C7"></div>Partial</div>';
  h += '<div class="avail-leg-i"><div class="avail-leg-dot" style="background:#FEE2E2"></div>Busy</div>';
  h += '<div class="avail-leg-i"><div class="avail-leg-dot" style="background:#ede9e0"></div>Weekend</div>';
  h += '</div></div>';

  body.innerHTML = h;
}

function cfgHighlightMatrix() {
  // Update row highlighting without full re-render
  var rows = document.querySelectorAll('#cfg-avail-body .avail-row');
  var selectedSet = {};
  (CFG.selectedDates || []).forEach(function(d, i){ if (d) selectedSet[d] = i + 1; });

  rows.forEach(function(row) {
    var m = (row.getAttribute('onclick') || '').match(/'(\d{4}-\d{2}-\d{2})'/);
    if (!m) return;
    var ds = m[1];
    row.classList.remove('chosen', 'chosen-multi');
    if (!CFG.isMultiDay && CFG.startDate === ds) row.classList.add('chosen');
    if (CFG.isMultiDay && selectedSet[ds]) row.classList.add('chosen-multi');
  });
}

function cfgGetAvail(res, ds, isWknd) {
  if (isWknd) return {cls:'wknd', lbl:'Wknd'};
  for (var ji = 0; ji < jobs.length; ji++) {
    var jb = jobs[ji];
    if (ds < jb.start || ds > jb.end) continue;
    if (res.type === 'crew') {
      if ((jb.drivers||[]).indexOf(res.name) >= 0 || (jb.porters||[]).indexOf(res.name) >= 0) {
        // Check holidays
        if (res.type === 'crew' && HOL[res.name] && HOL[res.name].indexOf(ds) >= 0) return {cls:'busy', lbl:'Holiday'};
        return {cls:'busy', lbl:'Booked'};
      }
    } else {
      var veh = VEHICLES.filter(function(v){return v.name+'('+v.reg+')' === res.name.replace(' ','');})[0];
      if (!veh) { veh = VEHICLES.filter(function(v){return (v.name+' ('+v.reg+')')===res.name;})[0]; }
      if (veh && (jb.veh||[]).indexOf(veh.reg) >= 0) return {cls:'busy', lbl:'Booked'};
    }
  }
  if (res.type === 'crew' && HOL[res.name] && HOL[res.name].indexOf(ds) >= 0) return {cls:'busy', lbl:'Holiday'};
  return {cls:'free', lbl:'Free'};
}

function cfgSelectDate(ds) {
  // Show the date section and activate "fix" radio
  var fixRadio = document.querySelector('input[name="cfg-dateoption"][value="fix"]');
  if (fixRadio) fixRadio.checked = true;
  var sec = el('cfg-date-section');
  if (sec) sec.style.display = '';

  if (!CFG.isMultiDay) {
    // Single-day: just set startDate
    CFG.startDate = ds;
    if (!CFG.selectedDates) CFG.selectedDates = [];
    CFG.selectedDates[0] = ds;
    var inp = el('cfg-startdate');
    if (inp) inp.value = ds;
    cfgHighlightMatrix();
    // Update the slot row without full re-render
    toast('Date set: ' + fmtNice(ds));
    return;
  }

  // Multi-day: fill next empty slot
  if (!CFG.selectedDates) CFG.selectedDates = [];
  var n = CFG.numDays || 2;

  // If already selected, deselect
  var existIdx = CFG.selectedDates.indexOf(ds);
  if (existIdx >= 0) {
    CFG.selectedDates[existIdx] = '';
    // Compact
    while (CFG.selectedDates.length > 0 && !CFG.selectedDates[CFG.selectedDates.length - 1]) CFG.selectedDates.pop();
    CFG.startDate = CFG.selectedDates[0] || '';
    CFG.endDate   = CFG.selectedDates[CFG.selectedDates.length - 1] || '';
    cfgRenderStage();
    return;
  }

  // Count filled
  var filled = CFG.selectedDates.filter(function(d){return !!d;}).length;
  if (filled >= n) {
    toast('All ' + n + ' days already selected. Clear one first.');
    return;
  }

  // Fill next empty slot
  // Ensure array is long enough
  while (CFG.selectedDates.length < n) CFG.selectedDates.push('');
  for (var si = 0; si < n; si++) {
    if (!CFG.selectedDates[si]) {
      CFG.selectedDates[si] = ds;
      break;
    }
  }

  CFG.startDate = CFG.selectedDates[0] || '';
  var lastFilled = '';
  for (var si2 = CFG.selectedDates.length - 1; si2 >= 0; si2--) { if (CFG.selectedDates[si2]) { lastFilled = CFG.selectedDates[si2]; break; } }
  CFG.endDate = lastFilled;

  var newFilled = CFG.selectedDates.filter(function(d){return !!d;}).length;
  if (newFilled >= n) {
    toast('All ' + n + ' days selected!');
  } else {
    toast('Day ' + newFilled + ' of ' + n + ' selected: ' + fmtNice(ds));
  }

  // Re-render slots area and progress without full re-render
  cfgRenderStage();
}

function cfgCollectSchedule() {
  var fixRadio = document.querySelector('input[name="cfg-dateoption"][value="fix"]');
  var nodate = !fixRadio || !fixRadio.checked;
  if (nodate) {
    CFG.startDate = ''; CFG.endDate = ''; CFG.selectedDates = [];
  } else {
    if (!CFG.isMultiDay) {
      var sdEl = el('cfg-startdate');
      var sdVal = sdEl ? sdEl.value : '';
      if (sdVal) { CFG.startDate = sdVal; CFG.selectedDates = [sdVal]; }
    }
    // Multi-day selectedDates already kept live in CFG
  }
  var mdEl = el('cfg-multiday');      if (mdEl) CFG.isMultiDay = mdEl.checked;
  var ndEl = el('cfg-numdays');       if (ndEl) CFG.numDays = parseInt(ndEl.value) || 2;
  var onEl = el('cfg-overnight');     if (onEl) CFG.hasOvernight = onEl.checked;
  var nnEl = el('cfg-numnights');     if (nnEl) CFG.numNights = parseInt(nnEl.value) || 1;
  var naEl = el('cfg-nightallow');    if (naEl) CFG.overnightAllowance = parseFloat(naEl.value) || 65;
  var wkEl = el('cfg-weekend');       if (wkEl) CFG.weekendWorking = wkEl.checked;
  var ljEl = el('cfg-linkjourney');   if (ljEl) CFG.linkJourney = ljEl.checked;
  var jsEl = el('cfg-journeysel');    if (jsEl) CFG.journeyId = (jsEl.value === '_new' ? null : jsEl.value);
}

// ── STAGE 4: RESOURCES ────────────────────────────────────────────────
function cfgRenderResources() {
  var h = '';
  var ds = CFG.startDate || 'any date';

  // Crew
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">👷</div>';
  h += '<div class="cs-card-title">Crew Assignment</div>';
  if (ds !== 'any date') h += '<div class="cs-card-sub">' + fmtNice(ds) + '</div>';
  h += '</div><div class="cs-body">';
  for (var ci = 0; ci < CREW.length; ci++) {
    var cr = CREW[ci];
    var isSel = CFG.crewAssigned.indexOf(cr.name) >= 0;
    var avail = cfgCrewAvailStatus(cr.name, CFG.startDate);
    h += '<div class="res-person' + (isSel ? ' sel' : '') + '" onclick="cfgToggleCrew(this,\'' + cr.name + '\')">';
    h += '<div class="res-person-av" style="background:' + cr.col + '">' + cr.name.slice(0,2) + '</div>';
    h += '<div style="flex:1"><div class="res-person-name">' + esc(cr.name) + '</div><div class="res-person-role">' + esc(cr.role) + ' &mdash; £' + cr.chargeRate + '/day</div></div>';
    h += '<span class="res-person-status ' + avail.cls + '">' + avail.lbl + '</span>';
    h += '</div>';
  }
  h += '</div></div>';

  // Vehicles
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#FFF5E0">🚐</div>';
  h += '<div class="cs-card-title">Vehicle Assignment</div></div>';
  h += '<div class="cs-body">';

  // Check if any job flagged small vehicle
  var needsSmall = CFG.jobs.some(function(jb){return jb.access.smallVehicle||jb.access.tightAccess||jb.access.rdRestriction;});
  if (needsSmall) h += '<div class="cs-hint" style="margin-bottom:10px">&#9888; One or more jobs have access restrictions — a small vehicle may be required</div>';

  for (var vi = 0; vi < VEHICLES.length; vi++) {
    var veh = VEHICLES[vi];
    var isSel = CFG.vehAssigned.indexOf(veh.id) >= 0;
    var vAvail = cfgVehAvailStatus(veh.id, CFG.startDate);
    h += '<div class="res-person' + (isSel ? ' sel' : '') + '" onclick="cfgToggleVeh(this,\'' + veh.id + '\')">';
    h += '<div class="res-person-av" style="background:#4A5568;font-size:9px">🚐</div>';
    h += '<div style="flex:1"><div class="res-person-name">' + esc(veh.name) + ' <span style="font-size:10.5px;color:#7A849E">' + esc(veh.reg) + '</span></div>';
    h += '<div class="res-person-role">' + esc(veh.type) + ' &mdash; ' + veh.volCapFt + 'ft³ &mdash; £' + veh.dayRate + '/day</div></div>';
    h += '<span class="res-person-status ' + vAvail.cls + '">' + vAvail.lbl + '</span>';
    h += '</div>';
  }
  h += '</div></div>';

  // Materials (compact)
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#E6FFF5">📦</div>';
  h += '<div class="cs-card-title">Packing Materials</div></div>';
  h += '<div class="cs-body">';
  for (var mi = 0; mi < MATERIALS.length; mi++) {
    var mat = MATERIALS[mi];
    var selMat = (CFG.materials||[]).filter(function(m){return m.id===mat.id;})[0];
    var isSel = !!selMat; var qty = isSel ? (selMat.qty||0) : 0;
    h += '<div class="res-person" style="cursor:default">';
    h += '<div style="flex:1;font-size:12.5px;font-weight:500">'+esc(mat.name)+'</div>';
    h += '<div style="display:flex;align-items:center;gap:6px">';
    h += '<input type="number" class="cfg-input" id="cfgmat-'+mat.id+'" value="'+qty+'" min="0" style="width:70px;text-align:right" placeholder="Qty">';
    h += '<span style="font-size:11px;color:#7A849E">@ £'+mat.unitCost+' ea</span>';
    h += '</div></div>';
  }
  h += '</div></div>';

  // Charges
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#FFF0F0">💳</div>';
  h += '<div class="cs-card-title">Charges &amp; Taxes</div></div>';
  h += '<div class="cs-body">';
  h += '<div id="cfg-charges-list">';
  var selChgs = CFG.charges || [];
  for (var chgi = 0; chgi < selChgs.length; chgi++) {
    h += cfgChgRow(chgi, selChgs[chgi].name, selChgs[chgi].amt);
  }
  h += '</div>';
  // Auto-add parking if access flag set
  var needsParking = CFG.jobs.some(function(jb){return jb.access.parkingSuspension||jb.access.permit;});
  h += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">';
  for (var chgi = 0; chgi < CHARGES.length; chgi++) {
    h += '<button class="btn btn-s btn-sm" onclick="cfgAddCharge(\''+esc(CHARGES[chgi].name)+'\','+CHARGES[chgi].defaultAmt+')">+ '+esc(CHARGES[chgi].name)+'</button>';
  }
  h += '</div>';
  if (needsParking) h += '<div class="cs-hint" style="margin-top:8px">&#9888; Access flags suggest parking/permit charges may apply</div>';
  h += '</div></div>';

  return h;
}

function cfgChgRow(idx, name, amt) {
  return '<div style="display:flex;gap:6px;margin-bottom:5px;align-items:center" id="cfgchg-'+idx+'">' +
    '<div style="flex:1;font-size:12.5px;font-weight:500">'+esc(name)+'</div>' +
    '<div style="display:flex;align-items:center;gap:3px"><span style="color:#7A849E">£</span>' +
    '<input class="cfg-input" style="width:90px;text-align:right" type="number" id="cfgchga-'+idx+'" value="'+amt+'" step="0.01" min="0"></div>' +
    '<div class="bline-rm" onclick="el(\'cfgchg-'+idx+'\').remove()">&#10005;</div>' +
    '</div>';
}

var cfgChgCount = 0;
function cfgAddCharge(name, amt) {
  cfgChgCount++;
  var list = el('cfg-charges-list');
  if (list) list.insertAdjacentHTML('beforeend', cfgChgRow(cfgChgCount, name, amt));
}

function cfgCrewAvailStatus(name, ds) {
  if (!ds) return {cls:'rps-free', lbl:'No date'};
  if (HOL[name] && HOL[name].indexOf(ds) >= 0) return {cls:'rps-busy', lbl:'Holiday'};
  for (var ji = 0; ji < jobs.length; ji++) {
    var jb = jobs[ji];
    if (ds < jb.start || ds > jb.end) continue;
    if ((jb.drivers||[]).indexOf(name) >= 0 || (jb.porters||[]).indexOf(name) >= 0) return {cls:'rps-busy', lbl:'Booked'};
  }
  return {cls:'rps-free', lbl:'Free'};
}

function cfgVehAvailStatus(vid, ds) {
  if (!ds) return {cls:'rps-free', lbl:'No date'};
  var veh = VEHICLES.filter(function(v){return v.id===vid;})[0];
  if (!veh) return {cls:'rps-free', lbl:'?'};
  for (var ji = 0; ji < jobs.length; ji++) {
    var jb = jobs[ji];
    if (ds < jb.start || ds > jb.end) continue;
    if ((jb.veh||[]).indexOf(veh.reg) >= 0) return {cls:'rps-busy', lbl:'Booked'};
  }
  return {cls:'rps-free', lbl:'Free'};
}

function cfgToggleCrew(elRef, name) {
  var idx = CFG.crewAssigned.indexOf(name);
  if (idx >= 0) CFG.crewAssigned.splice(idx, 1);
  else CFG.crewAssigned.push(name);
  elRef.classList.toggle('sel', CFG.crewAssigned.indexOf(name) >= 0);
}

function cfgToggleVeh(elRef, vid) {
  var idx = CFG.vehAssigned.indexOf(vid);
  if (idx >= 0) CFG.vehAssigned.splice(idx, 1);
  else CFG.vehAssigned.push(vid);
  elRef.classList.toggle('sel', CFG.vehAssigned.indexOf(vid) >= 0);
}

function cfgCollectResources() {
  // Materials
  var mats = [];
  for (var mi = 0; mi < MATERIALS.length; mi++) {
    var qEl = el('cfgmat-' + MATERIALS[mi].id);
    var qty = parseInt((qEl||{}).value) || 0;
    if (qty > 0) mats.push({id:MATERIALS[mi].id, qty:qty});
  }
  CFG.materials = mats;
  // Charges
  var chgs = [];
  var list = el('cfg-charges-list');
  if (list) {
    var rows = list.children;
    for (var ci = 0; ci < rows.length; ci++) {
      var nameEl = rows[ci].querySelector('div[style*="flex:1"]');
      var amtEl = rows[ci].querySelector('input[type="number"]');
      if (nameEl && amtEl) chgs.push({name:nameEl.textContent.trim(), amt:parseFloat(amtEl.value)||0});
    }
  }
  CFG.charges = chgs;
}

// ── STAGE 5: OPS PLAN ─────────────────────────────────────────────────
function cfgRenderOps() {
  var h = '';

  // Summary header
  var totalVol = CFG.jobs.reduce(function(s,jb){return s+(parseFloat(jb.volFt)||0);},0);
  var totalRev = CFG.jobs.reduce(function(s,jb){return s+jb.billing.reduce(function(bs,bl){return bs+(bl.amt||0);},0);},0);

  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#E6FFF5">✅</div>';
  h += '<div class="cs-card-title">Ops Plan — Final Review</div>';
  var statusCls = CFG.status==='Confirmed'?'obs-confirmed':CFG.status==='Provisional'?'obs-provisional':'obs-draft';
  h += '<span class="' + statusCls + '">' + CFG.status + '</span>';
  h += '</div><div class="cs-body">';
  h += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">';
  h += '<div class="ops-di"><div class="ops-dl">Client</div><div class="ops-dv">' + esc(CFG.clientName||'—') + '</div></div>';
  h += '<div class="ops-di"><div class="ops-dl">Ref</div><div class="ops-dv" style="font-variant-numeric:tabular-nums">' + CFG.ref + '</div></div>';
  h += '<div class="ops-di"><div class="ops-dl">Brand</div><div class="ops-dv">' + bbadge(CFG.brand) + '</div></div>';
  h += '<div class="ops-di"><div class="ops-dl">Date</div><div class="ops-dv" style="color:#0073EA">' + (CFG.startDate ? fmtNice(CFG.startDate) : 'No date — Enquiry') + '</div></div>';
  h += '<div class="ops-di"><div class="ops-dl">Total Volume</div><div class="ops-dv">' + (totalVol?totalVol+'ft³':'TBC') + '</div></div>';
  h += '<div class="ops-di"><div class="ops-dl">Total Revenue</div><div class="ops-dv" style="color:#0073EA">' + spv(totalRev?fmt(totalRev):'TBC') + '</div></div>';
  h += '</div></div></div>';

  // Job-by-job cards
  h += '<div class="cs-sub-label" style="margin-top:4px">Job Components — each becomes a calendar entry</div>';
  for (var ji = 0; ji < CFG.jobs.length; ji++) {
    var jb = CFG.jobs[ji];
    var svcsOn = Object.keys(jb.svcs).filter(function(k){return jb.svcs[k];});
    var accsOn = Object.keys(jb.access).filter(function(k){return jb.access[k];});
    h += '<div class="ops-job-card">';
    h += '<div class="ops-job-head">';
    h += '<div class="jcfg-num">' + (ji+1) + '</div>';
    h += '<div style="font-size:13px;font-weight:700;flex:1">' + esc(jb.jobType||'Job '+(ji+1)) + '</div>';
    if (jb.volFt) h += '<span style="font-size:11px;color:#7A849E">' + jb.volFt + ' ft³</span>';
    h += '</div>';
    h += '<div class="ops-job-body">';
    h += '<div class="ops-di"><div class="ops-dl">Origin</div><div class="ops-dv">' + esc(jb.origin||'—') + '</div></div>';
    h += '<div class="ops-di"><div class="ops-dl">Destination</div><div class="ops-dv">' + esc(jb.destType||(jb.dest||'—')) + '</div></div>';
    if (jb.storageRequired && jb.storageDirection) {
      var stoLabel = jb.storageDirection === 'in' ? '⬇️ Goods IN to warehouse' : '⬆️ Goods OUT from warehouse';
      var stoRecDisp = '';
      if (jb.storageIsNew) {
        stoRecDisp = 'New record will be created';
      } else if (jb.storageId) {
        var sRec = STORAGE_RECORDS.filter(function(x){return x.id===jb.storageId;})[0];
        stoRecDisp = jb.storageId + (sRec ? ' — ' + sRec.client : '');
        if (jb.storageDirection === 'out' && jb.volToRemove) stoRecDisp += ' | Remove: ' + jb.volToRemove + ' ft³';
        if (jb.containersToRemove && jb.containersToRemove.length) stoRecDisp += ' | Containers: ' + jb.containersToRemove.join(', ');
      }
      h += '<div class="ops-di" style="grid-column:span 3"><div class="ops-dl">🏭 Storage</div><div class="ops-dv">' + stoLabel + (stoRecDisp ? ' — <span style="font-family:monospace">' + esc(stoRecDisp) + '</span>' : '') + '</div></div>';
    }
    if (svcsOn.length) h += '<div class="ops-di" style="grid-column:span 3"><div class="ops-dl">Services</div><div class="ops-dv">' + svcsOn.map(function(k){var s=SERVICES.filter(function(x){return x.key===k;})[0];return s?s.lbl:k;}).join(', ') + '</div></div>';
    if (accsOn.length) h += '<div class="ops-di" style="grid-column:span 3"><div class="ops-dl">Access</div><div class="ops-dv">' + accsOn.map(function(k){var a=ACCESS_FLAGS.filter(function(x){return x.key===k;})[0];return a?a.lbl:k;}).join(', ') + '</div></div>';
    if (jb.billing && jb.billing.length) {
      var jrev = jb.billing.reduce(function(s,b){return s+b.amt;},0);
      h += '<div class="ops-di" style="grid-column:span 3"><div class="ops-dl">Billing</div><div class="ops-dv">' + jb.billing.map(function(b){return esc(b.item)+(b.amt?' &mdash; '+fmt(b.amt):'');}).join(' | ') + '</div></div>';
    }
    h += '</div></div>';
  }

  // Crew & vehicles summary
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">👷</div><div class="cs-card-title">Crew &amp; Vehicles</div></div>';
  h += '<div class="cs-body">';
  if (CFG.crewAssigned.length) {
    h += '<div style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:10px">';
    CFG.crewAssigned.forEach(function(name) {
      var cr = crewByName(name);
      var col = cr ? cr.col : '#888';
      h += '<span style="background:'+col+'22;color:'+col+';border:1px solid '+col+'44;padding:3px 9px;border-radius:4px;font-size:11.5px;font-weight:700">'+esc(name)+'</span>';
    });
    h += '</div>';
  } else h += '<div style="color:#7A849E;font-size:12px">No crew assigned yet</div>';
  if (CFG.vehAssigned.length) {
    CFG.vehAssigned.forEach(function(vid) {
      var veh = VEHICLES.filter(function(v){return v.id===vid;})[0];
      if (veh) h += '<div style="font-size:12px;color:#1A2035;margin-top:4px">&#128653; '+esc(veh.name)+' ('+esc(veh.reg)+')</div>';
    });
  }
  h += '</div></div>';

  // Schedule summary
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#FFF5E0">🌙</div><div class="cs-card-title">Schedule</div></div>';
  h += '<div class="cs-body" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">';
  h += '<div class="ops-di"><div class="ops-dl">Multi-day</div><div class="ops-dv">' + (CFG.isMultiDay?CFG.numDays+' days':'Single day') + '</div></div>';
  h += '<div class="ops-di"><div class="ops-dl">Overnight</div><div class="ops-dv">' + (CFG.hasOvernight?CFG.numNights+' night(s) @ £'+CFG.overnightAllowance+'/person':'None') + '</div></div>';
  h += '<div class="ops-di"><div class="ops-dl">Weekend</div><div class="ops-dv">' + (CFG.weekendWorking?'Yes':'No') + '</div></div>';
  if (CFG.linkJourney) h += '<div class="ops-di"><div class="ops-dl">Journey</div><div class="ops-dv">' + (CFG.journeyId?'Linked':'New journey') + '</div></div>';
  h += '</div></div>';

  // Ops notes
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#F5EEFF">📝</div><div class="cs-card-title">Ops Notes &amp; Client Notes</div></div>';
  h += '<div class="cs-body">';
  h += '<div class="cfg-field"><label class="cfg-label">Internal Ops Notes (crew instructions, access details, special requirements)</label>';
  h += '<textarea class="cfg-input" id="cfg-opsnotes" rows="3" style="resize:vertical">'+esc(CFG.opsNotes||'')+'</textarea></div>';
  h += '<div class="cfg-field" style="margin-top:10px"><label class="cfg-label">Client-Facing Notes (for confirmation email)</label>';
  h += '<textarea class="cfg-input" id="cfg-clientnotes" rows="2" style="resize:vertical">'+esc(CFG.clientNotes||'')+'</textarea></div>';
  h += '</div></div>';


  // Cancellation (only show if already has a booking)
  if (CFG.id) {
    h += '<div class="cs-card">';
    h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#FFECEF">❌</div><div class="cs-card-title">Cancellation</div></div>';
    h += '<div class="cs-body">';
    h += '<div style="display:flex;gap:8px;margin-bottom:10px">';
    ['Date Changed','Date Postponed','Job Cancelled'].forEach(function(r){
      var sel = CFG.cancelReason === r;
      h += '<div onclick="CFG.cancelReason=\''+r+'\';renderActiveMod&&cfgRenderStage()" style="flex:1;border:2px solid '+(sel?'var(--red)':'var(--b1)')+';border-radius:7px;padding:8px;text-align:center;cursor:pointer;background:'+(sel?'#FFECEF':'var(--w)')+';font-size:12px;font-weight:600;color:'+(sel?'var(--red)':'var(--t2)')+'">';
      h += r + '</div>';
    });
    h += '</div>';
    h += '<div class="cfg-field"><label class="cfg-label">Cancellation Notes (reason, client message, etc.)</label>';
    h += '<textarea class="cfg-input" id="cfg-cancel-notes" rows="2" style="resize:vertical">'+esc(CFG.cancelNotes||'')+'</textarea></div>';
    h += '</div></div>';
  }

  // Change log (only if existing booking with history)
  if (CFG.changeLog && CFG.changeLog.length) {
    h += '<div class="cs-card">';
    h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#EBF4FF">📋</div><div class="cs-card-title">Change History</div></div>';
    h += '<div class="cs-body" style="padding:0">';
    var log = CFG.changeLog.slice().reverse();
    log.forEach(function(entry) {
      var d = new Date(entry.ts);
      var when = d.getDate()+'/'+(d.getMonth()+1)+'/'+d.getFullYear()+' '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
      var actionCol = entry.action==='Created'?'var(--green)':entry.action==='Cancelled'?'var(--red)':'var(--blue)';
      h += '<div style="padding:9px 16px;border-bottom:1px solid var(--s2);display:flex;gap:10px;align-items:flex-start">';
      h += '<div style="font-size:10px;font-weight:700;color:'+actionCol+';min-width:64px;padding-top:1px">'+entry.action+'</div>';
      h += '<div style="flex:1">';
      if (entry.changes && entry.changes.length) {
        h += '<div style="font-size:11.5px;color:var(--t2)">'+entry.changes.map(function(c){return esc(c);}).join(' &middot; ')+'</div>';
      }
      if (entry.note) h += '<div style="font-size:11px;color:var(--t3);margin-top:2px">'+esc(entry.note)+'</div>';
      h += '</div>';
      h += '<div style="font-size:10.5px;color:var(--t4);white-space:nowrap">'+when+'<br>'+esc(entry.user||'')+'</div>';
      h += '</div>';
    });
    h += '</div></div>';
  }

  // Confirm status
  h += '<div class="cs-card">';
  h += '<div class="cs-card-head"><div class="cs-card-icon" style="background:#D1FAE5">🚀</div><div class="cs-card-title">Confirm &amp; Publish</div></div>';
  h += '<div class="cs-body">';
  h += '<div style="display:flex;gap:10px">';
  ['Draft','Provisional','Confirmed'].forEach(function(s){
    h += '<div onclick="cfgSetStatus(this,\''+s+'\')" style="flex:1;border:2px solid '+(CFG.status===s?'#0073EA':'#E3E7F0')+';border-radius:8px;padding:10px;text-align:center;cursor:pointer;background:'+(CFG.status===s?'#EBF4FF':'#fff')+';transition:all .12s" class="cfg-status-opt">';
    h += '<div style="font-size:16px">'+(s==='Draft'?'📋':s==='Provisional'?'🕐':'✅')+'</div>';
    h += '<div style="font-size:12px;font-weight:700;margin-top:4px;color:#1A2035">'+s+'</div>';
    h += '<div style="font-size:10px;color:#7A849E;margin-top:2px">'+(s==='Draft'?'Save without calendar':s==='Provisional'?'Hold on calendar':'Fully confirmed')+'</div>';
    h += '</div>';
  });
  h += '</div>';
  if (CFG.status === 'Draft') h += '<div class="cs-hint" style="margin-top:10px">&#128221; Draft — jobs will NOT appear on the calendar until you change status to Provisional or Confirmed.</div>';
  h += '</div></div>';

  return h;
}

function cfgSetStatus(elRef, status) {
  CFG.status = status;
  document.querySelectorAll('.cfg-status-opt').forEach(function(opt){
    var isThis = opt.getAttribute('onclick') && opt.getAttribute('onclick').indexOf("'"+status+"'") >= 0;
    opt.style.borderColor = isThis ? '#0073EA' : '#E3E7F0';
    opt.style.background = isThis ? '#EBF4FF' : '#fff';
  });
}

function cfgCollectOps() {
  CFG.opsNotes      = (el('cfg-opsnotes')||{}).value      || CFG.opsNotes;
  CFG.clientNotes   = (el('cfg-clientnotes')||{}).value   || CFG.clientNotes;

  CFG.cancelNotes   = (el('cfg-cancel-notes')||{}).value   || CFG.cancelNotes;
}

function cfgSaveDraft() {
  cfgCollectStage();
  CFG.status = 'Draft';
  cfgWriteToBookings();
  toast('Draft saved — ' + CFG.ref);
  renderBkList();
}

// ── COMMIT: Write configurator state → jobs[] and bookings[] ──────────
function cfgCommit() {
  cfgCollectStage();
  if (!CFG.clientName.trim()) { toast('Client name is required'); cfgGoStage(0); return; }
  if (!CFG.jobs[0].jobType) { toast('Select a job type on the Jobs stage'); cfgGoStage(1); return; }

  // Create journey if needed
  var journeyId = null;
  if (CFG.linkJourney) {
    if (CFG.journeyId && CFG.journeyId !== '_new') {
      journeyId = CFG.journeyId;
    } else {
      journeyId = 'JRN' + (++journeySeq).toString().padStart(3,'0');
      var newJrn = {
        id: journeyId,
        ref: CFG.ref + '-RUN',
        label: toTitleCase(CFG.clientName) + ' Run',
        jobIds: [],
        crew: CFG.crewAssigned.slice(),
        veh: CFG.vehAssigned.slice(),
        overnights: {nights: CFG.numNights||0, allowancePerPerson: CFG.overnightAllowance||65, billingNights: CFG.numNights||0},
        notes: CFG.opsNotes,
      };
      JOURNEYS.push(newJrn);
    }
  }

  // Determine start/end date from selectedDates (multi-day) or startDate (single)
  var startDate = '';
  var endDate = '';
  if (CFG.isMultiDay && CFG.selectedDates && CFG.selectedDates.length) {
    var filledDates = CFG.selectedDates.filter(function(d){return !!d;});
    if (filledDates.length) {
      // Sort to get actual earliest/latest calendar dates
      var sorted = filledDates.slice().sort();
      startDate = sorted[0];
      endDate   = sorted[sorted.length - 1];
    }
  } else {
    startDate = CFG.startDate || '';
    endDate   = CFG.endDate   || startDate;
  }

  // Resolve vehicles (regs)
  var vehRegs = CFG.vehAssigned.map(function(vid){
    var v = VEHICLES.filter(function(x){return x.id===vid;})[0];
    return v ? v.reg : null;
  }).filter(Boolean);

  // Drivers & porters split
  var drivers = CFG.crewAssigned.filter(function(name){
    var cr = crewByName(name); return cr && cr.role === 'Driver';
  });
  var porters = CFG.crewAssigned.filter(function(name){
    var cr = crewByName(name); return cr && cr.role !== 'Driver';
  });

  // Build one job entry per configured job component
  var createdJobIds = [];
  for (var ji = 0; ji < CFG.jobs.length; ji++) {
    var jb = CFG.jobs[ji];
    var jobId = 'BK' + Date.now() + '_' + ji;

    // Combine services + access into notes
    var svcsOn = Object.keys(jb.svcs).filter(function(k){return jb.svcs[k];}).map(function(k){
      var s=SERVICES.filter(function(x){return x.key===k;})[0]; return s?s.lbl:k;
    });
    var accsOn = Object.keys(jb.access).filter(function(k){return jb.access[k];}).map(function(k){
      var a=ACCESS_FLAGS.filter(function(x){return x.key===k;})[0]; return a?a.lbl:k;
    });
    var noteParts = [];
    if (svcsOn.length) noteParts.push('Services: ' + svcsOn.join(', '));
    if (accsOn.length) noteParts.push('Access: ' + accsOn.join(', '));
    if (CFG.opsNotes) noteParts.push(CFG.opsNotes);

    var vol = parseFloat(jb.volFt) || 0;
    var cbm = parseFloat(jb.volCbm) || (vol ? parseFloat((vol / 35.315).toFixed(2)) : 0);

    var newJob = {
      id: jobId,
      ref: CFG.jobs.length > 1 ? CFG.ref + '-' + (ji+1).toString().padStart(2,'0') : CFG.ref,
      brand: CFG.brand,
      channel: CFG.channel,
      jobType: jb.jobType,
      clientRef: CFG.clientRef || '',
      moveManager: CFG.moveManager || '',
      client: CFG.clientName,
      origin: jb.origin || '',
      dest: jb.destType === 'Int Store' ? 'INT STORE' : (jb.dest || jb.destType || ''),
      start: startDate,
      end: endDate,
      vol: vol,
      cbm: cbm,
      drivers: drivers,
      porters: porters,
      mileage: 0,
      veh: vehRegs,
      status: CFG.status === 'Confirmed' ? 'Scheduled' : CFG.status === 'Provisional' ? 'Provisional' : 'Draft',
      billing: jb.billing || [],
      notes: noteParts.join('\n'),
      journeyId: journeyId || '',
      storageId: '',
      storageDirection: jb.storageDirection || null,
      containersToRemove: jb.containersToRemove || [],
      seqInDay: CFG.jobs.length > 1 ? (ji + 1) : 0,
      storageRequired: jb.storageRequired || false,
    };

    // ── Handle storage linkage ───────────────────────────────────────
    if (jb.storageRequired && jb.storageDirection) {
      var ts = new Date().toISOString();
      var dateStr = ts.slice(0, 10);

      if (jb.storageDirection === 'in') {
        if (jb.storageIsNew) {
          // Create brand new storage record
          var newStoId = 'S' + String(100 + storageSeq++).slice(-3);
          STORAGE_RECORDS.push({
            id: newStoId,
            type: jb.newStorageType || 'longterm',
            client: CFG.clientName,
            brand: CFG.brand,
            volFt: vol,
            cbm: cbm,
            volRemaining: vol,
            dateIn: startDate || dateStr,
            dateOut: '',
            status: CFG.status === 'Confirmed' ? 'active' : 'pending',
            billingType: jb.newStorageBillingType || 'monthly',
            billingRate: jb.newStorageBillingRate || 85,
            billingUnit: jb.newStorageBillingUnit || 'cbm',
            inboundJobId: jobId,
            outboundJobId: '',
            containers: [],
            notes: 'Created from booking ' + CFG.ref + '. Containers to be assigned on arrival.',
            billingHistory: [],
            accessLog: [{
              ts: ts, date: dateStr, type: 'inbound',
              note: 'Record created — inbound job ' + newJob.ref + ' (' + vol + ' ft\u00b3 provisioned). Containers TBA on arrival.',
              volChange: vol
            }]
          });
          newJob.storageId = newStoId;
          newJob.dest = 'INT STORE';
        } else if (jb.storageId) {
          // Link to existing — note volume provision
          var existRec = STORAGE_RECORDS.filter(function(s){return s.id === jb.storageId;})[0];
          if (existRec) {
            if (!existRec.accessLog) existRec.accessLog = [];
            existRec.accessLog.push({
              ts: ts, date: dateStr, type: 'inbound',
              note: 'Additional inbound — job ' + newJob.ref + ' (' + vol + ' ft\u00b3 provisioned). Containers TBA on arrival.',
              volChange: vol
            });
          }
          newJob.storageId = jb.storageId;
          newJob.dest = 'INT STORE';
        }

      } else if (jb.storageDirection === 'out' && jb.storageId) {
        var outRec = STORAGE_RECORDS.filter(function(s){return s.id === jb.storageId;})[0];
        if (outRec && CFG.status !== 'Draft') {
          var volRemoved = parseFloat(jb.volToRemove) || vol;
          var volAfter = Math.max(0, (outRec.volRemaining || outRec.volFt || 0) - volRemoved);
          var containerList = (jb.containersToRemove || []).join(', ') || 'TBC';
          var isFullClearance = volAfter === 0;
          outRec.volRemaining = volAfter;
          if (!outRec.accessLog) outRec.accessLog = [];
          outRec.accessLog.push({
            ts: ts, date: dateStr, type: 'outbound',
            note: 'Outbound delivery — job ' + newJob.ref + '. ' + volRemoved + ' ft\u00b3 removed. Containers: ' + containerList + '. Remaining: ' + volAfter + ' ft\u00b3.' + (isFullClearance ? ' FULL CLEARANCE.' : ''),
            volChange: -volRemoved,
            jobRef: newJob.ref,
            containers: jb.containersToRemove || []
          });
          if (isFullClearance) {
            outRec.status = 'out';
            outRec.dateOut = startDate || dateStr;
            outRec.outboundJobId = jobId;
          }
          newJob.storageId = jb.storageId;
          newJob.origin = jb.containersToRemove && jb.containersToRemove.length
            ? 'EX STORE [' + jb.containersToRemove.join(', ') + ']'
            : 'EX STORE';
        }
      }
    }

    // Only add to calendar if not draft
    if (CFG.status !== 'Draft') {
      jobs = jobs.filter(function(j){return j.id !== jobId;});
      jobs.push(newJob);
      createdJobIds.push(jobId);
      if (journeyId) {
        var jrn = journeyById(journeyId);
        if (jrn && jrn.jobIds.indexOf(jobId) < 0) jrn.jobIds.push(jobId);
      }
    }
  }

  // Write booking
  CFG.id = CFG.id || ('BK' + Date.now());
  cfgWriteToBookings(createdJobIds);

  closeConfigurator();
  renderBkList();
  if (CFG.status !== 'Draft') {
    renderCal();
    toast(createdJobIds.length + ' job(s) added to calendar — ' + CFG.ref); (function(){ for(var _ci=0;_ci<jobs.length;_ci++){ if(createdJobIds.indexOf(jobs[_ci].id)>=0) saveData('job',jobs[_ci].id,jobs[_ci]); } })();
  } else {
    toast('Draft saved — ' + CFG.ref + ' (not on calendar)');
  }
}

function cfgWriteToBookings(calJobIds) {
  var isNew = !CFG.id;
  var bkId = CFG.id || ('BK' + Date.now());
  var existing = bookings.filter(function(x){ return x.id === bkId; })[0] || {};

  // Build change log entry
  var logEntry = {
    ts: new Date().toISOString(),
    user: window._authUser || 'Unknown',
    action: isNew ? 'Created' : (CFG.status === 'Cancelled' ? 'Cancelled' : 'Updated'),
    status: CFG.status,
    note: CFG.status === 'Cancelled' ? (CFG.cancelReason || '') + (CFG.cancelNotes ? ' — ' + CFG.cancelNotes : '') : '',
  };
  // Detect field changes for non-new records
  if (!isNew && existing.cfgData) {
    var prev = existing.cfgData;
    var changes = [];
    if (prev.clientName !== CFG.clientName) changes.push('Client: ' + prev.clientName + ' → ' + CFG.clientName);
    if (prev.startDate !== CFG.startDate) changes.push('Start: ' + prev.startDate + ' → ' + CFG.startDate);
    if (prev.endDate !== CFG.endDate) changes.push('End: ' + prev.endDate + ' → ' + CFG.endDate);
    if (prev.status !== CFG.status) changes.push('Status: ' + prev.status + ' → ' + CFG.status);
    if ((prev.jobs[0]||{}).origin !== (CFG.jobs[0]||{}).origin) changes.push('Origin changed');
    if ((prev.jobs[0]||{}).dest !== (CFG.jobs[0]||{}).dest) changes.push('Destination changed');
    if (changes.length) logEntry.changes = changes;
  }

  var changeLog = (existing.cfgData && existing.cfgData.changeLog) || CFG.changeLog || [];
  changeLog = changeLog.concat([logEntry]);
  CFG.changeLog = changeLog;

  var bk = {
    id: bkId,
    ref: CFG.ref,
    brand: CFG.brand,
    clientName: CFG.clientName,
    clientEmail: CFG.clientEmail,
    clientPhone: CFG.clientPhone,
    clientRef: CFG.clientRef,
    startDate: CFG.startDate,
    endDate: CFG.endDate,
    origin: (CFG.jobs[0]||{}).origin || '',
    dest: (CFG.jobs[0]||{}).dest || '',
    volume: parseFloat((CFG.jobs[0]||{}).volFt) || 0,
    cbm: parseFloat((CFG.jobs[0]||{}).volCbm) || 0,
    status: CFG.status === 'Confirmed' ? 'Confirmed' : CFG.status === 'Provisional' ? 'Pending' : 'Pending',
    notes: CFG.opsNotes,
    billing: (CFG.jobs||[]).reduce(function(all,jb){return all.concat(jb.billing||[]);}, []),
    vehicles: (CFG.vehAssigned||[]).map(function(vid){return {id:vid};}),
    materials: CFG.materials || [],
    charges: CFG.charges || [],
    emailLog: existing.emailLog || [],
    createdAt: existing.createdAt || new Date().toISOString(),
    cfgData: CFG,
    calJobIds: calJobIds || [],
    changeLog: changeLog,
    surveyDate: CFG.surveyDate || '',
    surveyTime: CFG.surveyTime || '',
    surveyPostcode: CFG.surveyPostcode || '',
    surveyNotes: CFG.surveyNotes || '',
    cancelReason: CFG.cancelReason || '',
    cancelNotes: CFG.cancelNotes || '',
  };

  // Update or add
  var found = false;
  for (var bi = 0; bi < bookings.length; bi++) {
    if (bookings[bi].id === bk.id) { bookings[bi] = bk; found = true; break; }
  }
  if (!found) bookings.push(bk);
  CFG.id = bk.id;
}

// ══════════════════════════════════════════════════════════════════════
// WAREHOUSE MODULE
// ══════════════════════════════════════════════════════════════════════

// ── Seed data ─────────────────────────────────────────────────────────
// Warehouse layout: 4 rows × 15 cols Side A + runway + 4 rows × 15 cols Side B
// + 1 loose/air/lcl row spanning full width (30 cells + runway = 31)
// Containers 100–399 (300 total)
// Side A rows: A1–A4, Side B rows: B1–B4
// Each cell has locNo e.g. A1-01, A2-07, B3-15
// Loose/oversized row: L01–L31 (16th row, full width)

var WH_ROWS_PER_SIDE = 4;
var WH_COLS = 15;
var WH_LOOSE_CELLS = 31; // full width including across runway

// Build container registry: cno 100–399 mapped to location
// Side A: rows A1..A4, cols 01..15 → containers 100–159
// Side B: rows B1..B4, cols 01..15 → containers 160–219
// Additional containers 220–399 are unplaced / spare
function whBuildContainerRegistry() {
  var reg = {};
  var cno = 100;
  for (var r = 1; r <= WH_ROWS_PER_SIDE; r++) {
    for (var c = 1; c <= WH_COLS; c++) {
      var locNo = 'A' + r + '-' + String(c).padStart(2,'0');
      reg['C' + cno] = {containerNo:'C'+cno, locNo:locNo, side:'A', row:r, col:c, type:'standard'};
      cno++;
    }
  }
  for (var r2 = 1; r2 <= WH_ROWS_PER_SIDE; r2++) {
    for (var c2 = 1; c2 <= WH_COLS; c2++) {
      var locNo2 = 'B' + r2 + '-' + String(c2).padStart(2,'0');
      reg['C' + cno] = {containerNo:'C'+cno, locNo:locNo2, side:'B', row:r2, col:c2, type:'standard'};
      cno++;
    }
  }
  // Remaining 220–399 are spare / off-floor
  return reg;
}
var WH_CONTAINER_REG = whBuildContainerRegistry();

// Loose row locations L01–L31
var WH_LOOSE_LOCS = [];
for (var _i = 1; _i <= WH_LOOSE_CELLS; _i++) {
  WH_LOOSE_LOCS.push('L' + String(_i).padStart(2,'0'));
}

// Warehouse activities — non-job entries
var WH_ACTIVITIES = [
  {id:'WA001', date:'2026-03-02', type:'3rd-party-in', direction:'in', status:'completed',
   client:'Hamilton Associates', clientRef:'EXT-001', brand:'SIRVA',
   description:'3rd party goods delivered — awaiting storage assignment', vol:320, volUnit:'ft',
   eventualDest:'Manchester', storageId:'', containers:[], jobId:'', crew:[],
   notes:'Arrived 09:30. Fork lift required.', createdAt:'2026-03-02T08:00:00'},
  {id:'WA002', date:'2026-03-02', type:'3rd-party-out', direction:'out', status:'completed',
   client:'NAQVI', clientRef:'', brand:'SIRVA',
   description:'3rd party collection — LCL case direct pickup', vol:80, volUnit:'ft',
   eventualDest:'', storageId:'S001', containers:['C127'], jobId:'', crew:[],
   notes:'Collected by ABC Freight. No handling required.', createdAt:'2026-03-02T07:45:00'},
  {id:'WA003', date:'2026-03-04', type:'activity', direction:'in', status:'completed',
   client:'', clientRef:'', brand:'',
   description:'Container audit — checking all A-row positions', vol:0, volUnit:'ft',
   eventualDest:'', storageId:'', containers:[], jobId:'', crew:['DAVE'],
   notes:'Annual position audit.', createdAt:'2026-03-04T06:00:00'},
  {id:'WA004', date:'2026-03-06', type:'3rd-party-in', direction:'in', status:'pending',
   client:'Okafor Family', clientRef:'EXT-002', brand:'EMS',
   description:'Air LCL case delivered from airport — 2 cases', vol:95, volUnit:'ft',
   eventualDest:'Leeds, LS9', storageId:'', containers:[], jobId:'', crew:[],
   notes:'2× LCL cases ref OKA-220.', createdAt:'2026-03-06T10:00:00'},
  {id:'WA005', date:'2026-02-25', type:'3rd-party-in', direction:'in', status:'pending',
   client:'Sterling Client TBC', clientRef:'EXT-003', brand:'STERLING',
   description:'Inbound container expected — awaiting arrival confirmation', vol:480, volUnit:'ft',
   eventualDest:'York, YO30', storageId:'', containers:[], jobId:'', crew:[],
   notes:'ETA 25 Feb. Call driver on arrival.', createdAt:'2026-02-22T09:00:00'},
];
var whActivitySeq = 5;

// Non-client usage (amber) — warehouse spaces used for non-client purposes
var WH_NON_CLIENT = {
  'A1-01': {desc:'Workshop tools / racking', type:'facility'},
  'A1-02': {desc:'Workshop tools / racking', type:'facility'},
  'B4-14': {desc:'Staff storage / equipment', type:'facility'},
  'B4-15': {desc:'Staff storage / equipment', type:'facility'},
  'L08':   {desc:'Forklift parking', type:'facility'},
  'L09':   {desc:'Forklift parking', type:'facility'},
};

// ── State ──────────────────────────────────────────────────────────────
var whDate = new Date();
var whTab = 'movements';
var whCellDetail = null; // currently selected cell locNo
var whGridZoom = 1; // 0.75 | 1 | 1.25

// ── Utility ───────────────────────────────────────────────────────────
function whDateStr(d) {
  d = d || whDate;
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function whFmtDate(d) {
  var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  return days[d.getDay()] + ' ' + d.getDate() + ' ' + MS[d.getMonth()] + ' ' + d.getFullYear();
}

// Get all movement entries for a given date string
// Includes: jobs (IN to/FROM INT STORE), activities
function whGetEntriesForDate(ds) {
  var entries = [];

  // From jobs array — inbound (dest=INT STORE) or outbound (origin contains EX STORE)
  for (var ji=0; ji<jobs.length; ji++) {
    var j = jobs[ji];
    if (j.start > ds || j.end < ds) continue;
    if (j.dest === 'INT STORE') {
      entries.push({source:'job', dir:'in', job:j, id:j.id,
        client:j.client, detail:j.jobType + ' — ' + j.origin + ' → INT STORE',
        vol:j.vol, containers:[], badge:'job', crew:(j.drivers||[]).concat(j.porters||[]),
        storageId:j.storageId, containersInfo: whGetContainersForJob(j)});
    } else if (j.origin && j.origin.indexOf('EX STORE') === 0) {
      entries.push({source:'job', dir:'out', job:j, id:j.id,
        client:j.client, detail:j.jobType + ' — EX STORE → ' + j.dest,
        vol:j.vol, badge:'job', crew:(j.drivers||[]).concat(j.porters||[]),
        storageId:j.storageId, containersInfo: j.containersToRemove||[]});
    } else if (j.storageDirection === 'in') {
      entries.push({source:'job', dir:'in', job:j, id:j.id,
        client:j.client, detail:j.jobType + ' — ' + j.origin + ' (storage in)',
        vol:j.vol, badge:'job', crew:(j.drivers||[]).concat(j.porters||[]),
        storageId:j.storageId});
    }
  }

  // From WH_ACTIVITIES
  var acts = WH_ACTIVITIES.filter(function(a){ return a.date === ds; });
  for (var ai=0; ai<acts.length; ai++) {
    var a = acts[ai];
    entries.push({source:'activity', dir:a.direction, activity:a, id:a.id,
      client:a.client||'Warehouse Activity', detail:a.description,
      vol:a.vol, badge: a.type === '3rd-party-in' || a.type === '3rd-party-out' ? 'thirdparty' : 'manual',
      crew:a.crew||[], storageId:a.storageId, type:a.type, containers:a.containers||[]});
  }

  return entries;
}

function whGetContainersForJob(j) {
  if (!j.storageId) return [];
  var rec = STORAGE_RECORDS.filter(function(s){return s.id===j.storageId;})[0];
  if (!rec || !rec.containers) return [];
  return rec.containers.map(function(c){return c.containerNo;});
}

// ── Module entry ───────────────────────────────────────────────────────
function renderWarehouse() {
  whDate = whDate || new Date();
  var ds = whDateStr();
  el('wh-cn-lbl').textContent = whFmtDate(whDate);
  el('wh-cnav').style.display = whTab === 'movements' ? 'flex' : 'none';
  el('wh-tb-r').style.display = whTab === 'grid' ? 'none' : 'flex';

  // Refresh badge
  var todayActs = WH_ACTIVITIES.filter(function(a){return a.date===whDateStr();}).length;
  setBadge('wh-badge', todayActs);

  if (whTab === 'movements') renderWhMovements();
  else if (whTab === 'records')  renderWhRecords();
  else if (whTab === 'grid')     renderWhGrid();
}

function whSetTab(tab, btn) {
  whTab = tab;
  document.querySelectorAll('#wh-tabs .vt').forEach(function(b){b.classList.remove('on');});
  btn.classList.add('on');
  renderWarehouse();
}

function whNavPrev() { whDate = addDays(whDate, -1); renderWarehouse(); }
function whNavNext() { whDate = addDays(whDate,  1); renderWarehouse(); }
function whGoToday() { whDate = new Date(); renderWarehouse(); }

// ══ TAB 1: DAILY MOVEMENTS ═════════════════════════════════════════════
function renderWhMovements() {
  var ds = whDateStr();
  var entries = whGetEntriesForDate(ds);

  var inbound  = entries.filter(function(e){ return e.dir==='in'; });
  var outbound = entries.filter(function(e){ return e.dir==='out'; });
  var activity = entries.filter(function(e){ return e.dir==='activity'; });
  var tp3in    = entries.filter(function(e){ return e.badge==='thirdparty' && e.dir==='in'; });
  var tp3out   = entries.filter(function(e){ return e.badge==='thirdparty' && e.dir==='out'; });

  var h = '';

  // Day header
  h += '<div class="wh-day-header">';
  h += '<div class="wh-day-title">' + whFmtDate(whDate) + '</div>';
  var isToday = ds === whDateStr(new Date());
  if (isToday) h += '<span style="background:#EBF4FF;color:#004DA0;font-size:10.5px;font-weight:700;padding:2px 8px;border-radius:8px">Today</span>';
  h += '</div>';

  // Stats
  h += '<div class="wh-day-stats">';
  h += whStat('⬇️', inbound.length, 'Inbound');
  h += whStat('⬆️', outbound.length, 'Outbound');
  h += whStat('🚚', tp3in.length, '3rd Party In');
  h += whStat('🚛', tp3out.length, '3rd Party Out');
  h += whStat('📋', activity.length, 'Activities');
  h += '</div>';

  // Sections
  h += whSection('⬇️ Inbound to Warehouse', inbound, 'in', ds);
  h += whSection('⬆️ Outbound from Warehouse', outbound, 'out', ds);
  h += whSection('🚚 3rd Party Deliveries In', tp3in, 'thirdparty', ds);
  h += whSection('🚛 3rd Party Collections Out', tp3out, 'thirdparty', ds);
  h += whSection('📋 Other Warehouse Activities', activity, 'activity', ds);

  // Quick-add hint
  h += '<div class="cs-hint" style="margin-top:12px">💡 Use <strong>3rd Party In</strong> to log goods arriving from external carriers. Use <strong>+ Activity</strong> for container audits, maintenance, or any warehouse task not linked to a job booking.</div>';

  setH('wh-out', h);
}

function whStat(icon, num, lbl) {
  return '<div class="wh-stat"><div class="wh-stat-ico">'+icon+'</div><div class="wh-stat-num">'+num+'</div><div class="wh-stat-lbl">'+lbl+'</div></div>';
}

function whSection(title, entries, dir, ds) {
  var pendingCount = entries.filter(function(e){
    if (e.source==='activity') return e.activity && e.activity.status==='pending';
    if (e.source==='job') return e.job && e.job.status==='Scheduled' && e.job.start >= whDateStr(new Date());
    return false;
  }).length;

  var h = '<div class="wh-section">';
  h += '<div class="wh-section-head"><span class="wh-section-title">'+esc(title)+'</span>';
  if (entries.length) h += '<span class="wh-section-count">'+entries.length+'</span>';
  if (pendingCount) h += '<span style="margin-left:6px;font-size:10px;font-weight:700;padding:2px 8px;border-radius:9px;background:#FFF5E0;color:#9A5600;border:1px solid #FFD580">🕐 '+pendingCount+' pending</span>';
  h += '</div>';

  if (!entries.length) {
    h += '<div class="wh-section-empty">No entries</div>';
  } else {
    for (var i=0; i<entries.length; i++) {
      h += whEntryRow(entries[i]);
    }
  }
  h += '</div>';
  return h;
}

function whEntryRow(entry) {
  var dirCls = entry.dir==='in' ? 'in' : entry.dir==='out' ? 'out' : entry.badge==='thirdparty' ? 'thirdparty' : 'activity';
  var dirIcon = entry.dir==='in' ? '⬇️' : entry.dir==='out' ? '⬆️' : '📋';
  var badgeCls = 'wh-entry-badge whb-' + (entry.badge||'manual');
  var badgeLbl = entry.badge==='job' ? 'JOB' : entry.badge==='thirdparty' ? '3RD PARTY' : 'MANUAL';

  // Pending detection: activity with status=pending, or job scheduled in future
  var isPending = false;
  var todayStr = whDateStr(new Date());
  if (entry.source === 'activity') {
    isPending = (entry.activity && entry.activity.status === 'pending');
  } else if (entry.source === 'job') {
    isPending = (entry.job && entry.job.status === 'Scheduled' && (entry.job.start >= todayStr));
  }

  var rowStyle = isPending ? 'background:rgba(255,159,0,.05)' : '';
  var h = '<div class="wh-entry" style="'+rowStyle+'" onclick="whViewEntry(\''+esc(entry.id)+'\')">';
  h += '<div class="wh-entry-dir '+dirCls+'">'+dirIcon+'</div>';
  h += '<div class="wh-entry-main">';

  // Client row with pending pill
  h += '<div style="display:flex;align-items:center;gap:6px">';
  h += '<span class="wh-entry-client">'+esc(entry.client)+'</span>';
  if (isPending) h += '<span style="display:inline-flex;align-items:center;gap:3px;font-size:9.5px;font-weight:700;background:#FFF5E0;color:#9A5600;border:1px solid #FFD580;border-radius:8px;padding:1px 6px;letter-spacing:.2px">🕐 PENDING</span>';
  h += '</div>';

  h += '<div class="wh-entry-detail">'+esc(entry.detail)+'</div>';

  // Eventual destination (from activities)
  var dest = entry.activity && entry.activity.eventualDest;
  if (dest) h += '<div style="font-size:11px;color:var(--blue);margin-top:2px">📍 Dest: '+esc(dest)+'</div>';

  if (entry.crew && entry.crew.length) h += '<div class="wh-entry-crew">👷 '+esc(entry.crew.join(', '))+'</div>';
  h += '</div>';
  h += '<div class="wh-entry-meta">';
  if (entry.vol) h += '<div class="wh-entry-vol">'+entry.vol+' ft³</div>';
  if (entry.containersInfo && entry.containersInfo.length) h += '<div class="wh-entry-containers">'+esc(entry.containersInfo.slice(0,3).join(', '))+(entry.containersInfo.length>3?'…':'')+'</div>';
  h += '<span class="'+badgeCls+'">'+badgeLbl+'</span>';
  h += '</div>';
  h += '<div class="wh-entry-actions">';
  if (entry.storageId) h += '<button class="btn btn-s btn-sm" onclick="event.stopPropagation();viewStorage(\''+esc(entry.storageId)+'\')">Storage</button>';
  if (entry.source==='activity') {
    if (isPending) h += '<button class="btn btn-s btn-sm" onclick="event.stopPropagation();whMarkArrived(\''+esc(entry.id)+'\')" title="Mark as arrived / completed">✓ Arrived</button>';
    h += '<button class="btn btn-s btn-sm" onclick="event.stopPropagation();whEditActivity(\''+esc(entry.id)+'\')">Edit</button>';
  }
  if (entry.source==='job') h += '<button class="btn btn-s btn-sm" onclick="event.stopPropagation();openEdit(\''+esc(entry.id)+'\')">Job</button>';
  h += '</div>';
  h += '</div>';
  return h;
}

function whViewEntry(id) {
  // For jobs, open job detail panel; for activities, open activity detail
  var act = WH_ACTIVITIES.filter(function(a){return a.id===id;})[0];
  if (act) { whShowActivityDetail(act); return; }
  // check jobs
  var j = jobs.filter(function(x){return x.id===id;})[0];
  if (j) { openEdit(id); }
}

function whMarkArrived(id) {
  var act = WH_ACTIVITIES.filter(function(a){return a.id===id;})[0];
  if (!act) return;
  act.status = 'completed';
  // Set date to today if it was future
  var todayStr = whDateStr(new Date());
  if (act.date > todayStr) act.date = todayStr;
  toast('✓ Marked as arrived — ' + (act.client || id));
  renderWarehouse();
}

// ══ TAB 2: STORAGE RECORDS (reuse existing renderStorage logic) ═════════
function renderWhRecords() {
  // Delegate to existing storage module render
  var h = '<div style="background:var(--w);border:1px solid var(--b1);border-radius:var(--r);overflow:hidden">';
  h += '<div class="topbar" style="border-bottom:1px solid var(--b1);border-radius:0">';
  h += '<div style="font-weight:700;font-size:13px">Storage Records</div>';
  h += '<div style="display:flex;gap:4px;margin-left:10px">';
  h += '<button class="vt on" onclick="whStorageFilter(\'all\',this)">All</button>';
  h += '<button class="vt" onclick="whStorageFilter(\'active\',this)">Active</button>';
  h += '<button class="vt" onclick="whStorageFilter(\'inout\',this)">In/Out</button>';
  h += '<button class="vt" onclick="whStorageFilter(\'longterm\',this)">Long-term</button>';
  h += '</div><div class="tb-r"><button class="btn btn-p btn-sm" onclick="newStorageRecord()">+ New Storage</button></div>';
  h += '</div>';
  h += '</div>';
  h += '<div id="wh-records-inner" style="margin-top:14px"></div>';
  setH('wh-out', h);
  whRenderRecordsInner('all');
}

var whRecFilter = 'all';
function whStorageFilter(f, btn) {
  whRecFilter = f;
  document.querySelectorAll('#wh-out .vt').forEach(function(b){b.classList.remove('on');});
  if (btn) btn.classList.add('on');
  whRenderRecordsInner(f);
}

function whRenderRecordsInner(f) {
  var all = STORAGE_RECORDS;
  var shown = all.filter(function(s){
    if (f==='active')   return s.status==='active';
    if (f==='inout')    return s.type==='inout';
    if (f==='longterm') return s.type==='longterm';
    return true;
  });
  var h = '<div style="overflow-x:auto"><table class="sc-table"><thead><tr>';
  h += '<th>Ref</th><th>Client</th><th>Brand</th><th>Type</th><th>Containers</th><th>Vol In</th><th>Remaining</th><th>In</th><th>Out</th><th>Status</th><th></th>';
  h += '</tr></thead><tbody>';
  for (var i=0; i<shown.length; i++) {
    var s = shown[i];
    var stCol = s.status==='active'?'var(--green)':s.status==='out'?'var(--t3)':'var(--amber)';
    var ctrs = s.containers || [];
    var firstLocs = ctrs.slice(0,2).map(function(c){return c.containerNo;}).join(', ');
    var volRem = s.volRemaining !== undefined ? s.volRemaining : (s.volFt||0);
    h += '<tr style="cursor:pointer" onclick="viewStorage(\''+s.id+'\')">';
    h += '<td style="font-weight:700;font-family:monospace">'+esc(s.id)+'</td>';
    h += '<td style="font-weight:600">'+esc(s.client)+'</td>';
    h += '<td>'+bbadge(s.brand)+'</td>';
    h += '<td><span style="font-size:10px;font-weight:700;text-transform:uppercase;padding:2px 6px;border-radius:3px;background:var(--s1);border:1px solid var(--b1)">'+(s.type==='inout'?'In/Out':'Long-term')+'</span></td>';
    h += '<td style="font-size:11.5px">'+(ctrs.length?'<span style="font-family:monospace;font-weight:600">'+esc(firstLocs)+(ctrs.length>2?' +'+( ctrs.length-2)+'…':'')+'</span>':'<span style="color:var(--t4)">TBA</span>')+'</td>';
    h += '<td>'+spv((s.volFt||0).toLocaleString()+' ft³')+'</td>';
    h += '<td style="font-weight:600;color:'+(volRem===0?'var(--t3)':'var(--green)')+'">'+volRem.toLocaleString()+' ft³</td>';
    h += '<td>'+fmtNice(s.dateIn)+'</td>';
    h += '<td>'+(s.dateOut?fmtNice(s.dateOut):'<span style="color:var(--green);font-size:11px;font-weight:600">In storage</span>')+'</td>';
    h += '<td><span style="font-size:10.5px;font-weight:700;color:'+stCol+'">'+s.status.toUpperCase()+'</span></td>';
    h += '<td><button class="btn btn-s btn-sm" onclick="event.stopPropagation();editStorage(\''+s.id+'\')">Edit</button>';
    if (s.status === 'active') h += '<button class="btn btn-sm" style="margin-left:4px;background:var(--green);color:#fff;border-color:var(--green);border-radius:5px;padding:3px 9px;font-size:11px;font-weight:700;cursor:pointer" onclick="event.stopPropagation();whBookDelivery(\''+s.id+'\')">📦 Book</button>';
    h += '</td>';
    h += '</tr>';
  }
  h += '</tbody></table></div>';
  var inner = el('wh-records-inner');
  if (inner) inner.innerHTML = h;
}

// ══ TAB 3: WAREHOUSE GRID ══════════════════════════════════════════════
function renderWhGrid() {
  var h = '';

  // Legend
  h += '<div class="wh-grid-legend">';
  h += '<span style="font-size:12px;font-weight:700;color:var(--t2);margin-right:4px">Key:</span>';
  h += '<div class="wh-legend-item"><div class="wh-legend-dot client"></div> Client storage (occupied)</div>';
  h += '<div class="wh-legend-item"><div class="wh-legend-dot nonclient"></div> Non-client use (facility/staff)</div>';
  h += '<div class="wh-legend-item"><div class="wh-legend-dot empty"></div> Empty — available for assignment</div>';
  h += '<div class="wh-legend-item"><div class="wh-legend-dot pending"></div> Pending / provisioned (no containers yet)</div>';
  h += '<div style="margin-left:auto;display:flex;gap:6px">';
  h += '<button class="wh-zoom-btn" onclick="whZoom(-1)">&#8722;</button>';
  h += '<span style="font-size:11px;font-weight:600;color:var(--t3);width:34px;text-align:center" id="wh-zoom-lbl">100%</span>';
  h += '<button class="wh-zoom-btn" onclick="whZoom(1)">+</button>';
  h += '</div>';
  h += '</div>';

  // Build cell state map: locNo → {status, client, storageId, containerNo, desc}
  var cellMap = whBuildCellMap();

  h += '<div class="wh-grid-wrap"><div id="wh-grid-inner" style="transform-origin:top left;transform:scale('+whGridZoom+')">';

  // Column headers
  h += '<div style="display:flex;gap:2px;margin-left:38px;margin-bottom:4px">';
  for (var c=1; c<=WH_COLS; c++) h += '<div class="wh-col-hdr">'+String(c).padStart(2,'0')+'</div>';
  h += '</div>';

  // Side A
  h += '<div class="wh-side-label">◀ SIDE A</div>';
  for (var r=1; r<=WH_ROWS_PER_SIDE; r++) {
    h += '<div class="wh-grid-row">';
    h += '<div class="wh-grid-rowlbl">A'+r+'</div>';
    for (var c2=1; c2<=WH_COLS; c2++) {
      var loc = 'A'+r+'-'+String(c2).padStart(2,'0');
      h += whGridCell(loc, cellMap);
    }
    h += '</div>';
  }

  // Runway
  h += '<div style="display:flex;gap:2px;margin-left:38px;margin:6px 0">';
  for (var rc=1; rc<=WH_COLS; rc++) {
    h += '<div style="width:52px;height:18px;background:var(--s2);border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:7.5px;font-weight:700;color:var(--t4);letter-spacing:.6px;flex-shrink:0">';
    if (rc===7) h += '◀ FORKLIFT RUNWAY ▶';
    h += '</div>';
  }
  h += '</div>';

  // Side B
  h += '<div class="wh-side-label">◀ SIDE B</div>';
  for (var r3=1; r3<=WH_ROWS_PER_SIDE; r3++) {
    h += '<div class="wh-grid-row">';
    h += '<div class="wh-grid-rowlbl">B'+r3+'</div>';
    for (var c3=1; c3<=WH_COLS; c3++) {
      var loc3 = 'B'+r3+'-'+String(c3).padStart(2,'0');
      h += whGridCell(loc3, cellMap);
    }
    h += '</div>';
  }

  // Loose / Air / LCL row
  h += '<div style="border-top:2px dashed var(--b2);margin:10px 0 6px;padding-top:10px">';
  h += '<div class="wh-side-label">▼ LOOSE / OVERSIZED / AIR / LCL / PALLET ROW (L01–L31)</div>';
  h += '<div style="display:flex;gap:4px;flex-wrap:nowrap;overflow-x:auto;padding:4px 2px 8px;margin-left:38px">';
  for (var li=1; li<=WH_LOOSE_CELLS; li++) {
    var lloc = 'L'+String(li).padStart(2,'0');
    h += whLooseCell(lloc, cellMap);
  }
  h += '</div></div>';

  h += '</div></div>'; // wh-grid-inner, wh-grid-wrap

  // Cell detail panel (if selected)
  if (whCellDetail) {
    h += whRenderCellDetail(whCellDetail, cellMap);
  }

  setH('wh-out', h);
}

function whBuildCellMap() {
  var map = {};

  // Place containers from storage records
  for (var si=0; si<STORAGE_RECORDS.length; si++) {
    var s = STORAGE_RECORDS[si];
    var ctrs = s.containers || [];
    for (var ci=0; ci<ctrs.length; ci++) {
      var ct = ctrs[ci];
      var loc = ct.locNo;
      map[loc] = {
        status: s.status==='active' ? 'client' : s.status==='pending' ? 'pending' : 'client',
        client: s.client,
        storageId: s.id,
        containerNo: ct.containerNo,
        type: ct.type,
        volFt: ct.volFt,
        maxFt: ct.maxFt,
        desc: s.client + ' (' + ct.type + ', ' + ct.volFt + 'ft³)',
      };
    }
  }

  // Non-client (facility/staff)
  for (var loc2 in WH_NON_CLIENT) {
    if (!map[loc2]) {
      map[loc2] = {status:'nonclient', desc:WH_NON_CLIENT[loc2].desc, type:WH_NON_CLIENT[loc2].type};
    }
  }

  return map;
}

function whGridCell(loc, cellMap) {
  var info = cellMap[loc];
  var cno  = '';
  var status = 'empty';
  var icon = '🔴';
  var tipText = loc + ' — Empty';

  if (info) {
    status = info.status;
    cno = info.containerNo || '';
    if (status === 'client') { icon = '🟢'; tipText = loc + (cno?' ['+cno+']':'')+' — '+esc(info.client||'')+(info.volFt?' '+info.volFt+'ft³':''); }
    else if (status === 'nonclient') { icon = '🟡'; tipText = loc + ' — ' + esc(info.desc||'Non-client'); }
    else if (status === 'pending') { icon = '⬜'; tipText = loc + ' — Pending: ' + esc(info.client||''); }
    else { icon = '🔴'; tipText = loc + ' — Empty'; }
  }

  var h = '<div class="wh-cell '+status+'" onclick="whSelectCell(\''+loc+'\')" title="'+tipText+'">';
  h += '<div class="wh-cell-tooltip">'+tipText+'</div>';
  if (cno) h += '<div class="wh-cell-cno">'+esc(cno)+'</div>';
  h += '<div class="wh-cell-icon">'+icon+'</div>';
  if (!cno) h += '<div class="wh-cell-loc" style="font-size:7px;color:var(--t4)">'+esc(loc)+'</div>';
  h += '</div>';
  return h;
}

function whLooseCell(loc, cellMap) {
  var info = cellMap[loc];
  var occupied = !!info;
  var icon = info ? (info.type==='loose'?'🛋':info.type==='pallet'?'🪵':info.type==='lcl'?'✈️':'📦') : '+';
  var cls = occupied ? 'occupied' : 'empty';
  var h = '<div class="wh-loose-cell '+cls+'" onclick="whSelectCell(\''+loc+'\')" title="'+loc+(info?' — '+esc(info.desc||info.client||''):'— empty')+'">';
  h += '<div class="wh-loose-cell-icon">'+icon+'</div>';
  h += '<div class="wh-loose-cell-id">'+esc(loc)+'</div>';
  if (info) h += '<div class="wh-loose-cell-lbl" style="font-size:7px;max-width:76px;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc((info.client||info.desc||'').substring(0,14))+'</div>';
  h += '</div>';
  return h;
}

function whSelectCell(loc) {
  whCellDetail = (whCellDetail === loc) ? null : loc;
  renderWhGrid();
}

function whRenderCellDetail(loc, cellMap) {
  var info = cellMap[loc];
  var h = '<div class="wh-cell-detail" style="margin-top:18px">';
  h += '<div class="wh-cd-head">';
  h += '<div class="wh-cd-cno">'+esc(loc)+'</div>';
  if (info && info.containerNo) h += '<div class="wh-cd-loc">'+esc(info.containerNo)+'</div>';
  var stCls = !info?'background:#FFECEF;color:#E44258':info.status==='client'?'background:#E6FFF5;color:#007048':info.status==='nonclient'?'background:#FFF5E0;color:#9A5600':'background:#F5F4EF;color:#7A849E';
  h += '<span class="wh-cd-status" style="'+stCls+'">'+(!info?'Empty':info.status==='client'?'Client Storage':info.status==='nonclient'?'Non-Client Use':'Pending')+'</span>';
  h += '<button class="btn btn-g btn-sm" style="margin-left:auto" onclick="whCellDetail=null;renderWhGrid()">✕ Close</button>';
  h += '</div>';

  if (!info) {
    h += '<div style="font-size:12px;color:var(--t3);margin-bottom:12px">This location is empty and available for assignment.</div>';
    h += '<div style="display:flex;gap:8px">';
    h += '<button class="btn btn-p btn-sm" onclick="whAssignContainer(\''+loc+'\')">Assign Container Here</button>';
    h += '<button class="btn btn-s btn-sm" onclick="whMarkNonClient(\''+loc+'\')">Mark as Facility Use</button>';
    h += '</div>';
  } else if (info.status === 'client') {
    var rec = STORAGE_RECORDS.filter(function(s){return s.id===info.storageId;})[0];
    h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">';
    h += '<div class="di"><div class="dlbl">Client</div><div class="dval" style="font-weight:700">'+esc(info.client)+'</div></div>';
    h += '<div class="di"><div class="dlbl">Storage Ref</div><div class="dval" style="font-family:monospace;color:var(--blue)">'+esc(info.storageId)+'</div></div>';
    h += '<div class="di"><div class="dlbl">Container</div><div class="dval" style="font-family:monospace;font-weight:700">'+esc(info.containerNo||'—')+'</div></div>';
    h += '<div class="di"><div class="dlbl">Type</div><div class="dval">'+esc(info.type||'standard')+'</div></div>';
    h += '<div class="di"><div class="dlbl">Volume</div><div class="dval">'+esc(String(info.volFt||0))+' ft³'+(info.maxFt?' / max '+info.maxFt+' ft³':'')+'</div></div>';
    if (rec) h += '<div class="di"><div class="dlbl">Record Status</div><div class="dval" style="font-weight:700;color:var(--green)">'+rec.status.toUpperCase()+'</div></div>';
    h += '</div>';
    h += '<div style="display:flex;gap:8px">';
    if (rec) h += '<button class="btn btn-p btn-sm" onclick="viewStorage(\''+esc(info.storageId)+'\')">Open Storage Record</button>';
    h += '<button class="btn btn-s btn-sm" onclick="whMoveContainer(\''+loc+'\')">Move to Different Location</button>';
    h += '</div>';
  } else if (info.status === 'nonclient') {
    h += '<div style="font-size:12.5px;color:var(--t2);margin-bottom:12px">'+esc(info.desc||'Facility use')+'</div>';
    h += '<button class="btn btn-s btn-sm" onclick="whClearNonClient(\''+loc+'\')">Clear Facility Marking</button>';
  }
  h += '</div>';
  return h;
}

function whZoom(dir) {
  var steps = [0.65, 0.8, 1, 1.2, 1.5];
  var idx = steps.indexOf(whGridZoom);
  if (idx < 0) idx = 2;
  idx = Math.max(0, Math.min(steps.length-1, idx+dir));
  whGridZoom = steps[idx];
  var inner = el('wh-grid-inner');
  if (inner) inner.style.transform = 'scale('+whGridZoom+')';
  var lbl = el('wh-zoom-lbl');
  if (lbl) lbl.textContent = Math.round(whGridZoom*100)+'%';
}

function whAssignContainer(loc) {
  // Find unassigned containers from STORAGE_RECORDS that have no locNo yet
  var unassigned = [];
  for (var si=0; si<STORAGE_RECORDS.length; si++) {
    var s = STORAGE_RECORDS[si];
    var ctrs = s.containers || [];
    for (var ci=0; ci<ctrs.length; ci++) {
      if (!ctrs[ci].locNo) unassigned.push({cno:ctrs[ci].containerNo, client:s.client, sid:s.id, ci:ci});
    }
  }
  // Build a simple selector
  if (!unassigned.length) {
    alert('No unassigned containers found. Add containers via the Storage Record first.');
    return;
  }
  var opts = unassigned.map(function(u){return u.cno + ' — ' + u.client;}).join('\n');
  var pick = prompt('Enter container number to assign to location ' + loc + ':\n\nUnassigned containers:\n' + opts);
  if (!pick) return;
  pick = pick.trim().toUpperCase();
  for (var si2=0; si2<STORAGE_RECORDS.length; si2++) {
    var s2 = STORAGE_RECORDS[si2];
    var ctrs2 = s2.containers || [];
    for (var ci2=0; ci2<ctrs2.length; ci2++) {
      if (ctrs2[ci2].containerNo === pick) {
        ctrs2[ci2].locNo = loc;
        // Log it
        if (!s2.accessLog) s2.accessLog = [];
        s2.accessLog.push({ts:new Date().toISOString(), date:whDateStr(), type:'container-assign',
          note:'Container '+pick+' assigned to location '+loc+'.'});
        toast('Container ' + pick + ' assigned to ' + loc); saveData('storage', rec.id, rec);
        whCellDetail = loc;
        renderWhGrid();
        return;
      }
    }
  }
  toast('Container ' + pick + ' not found');
}

function whMoveContainer(fromLoc) {
  var toLoc = prompt('Move container from ' + fromLoc + ' to location (e.g. A2-05, L12):');
  if (!toLoc) return;
  toLoc = toLoc.trim().toUpperCase();
  var moved = false;
  for (var si=0; si<STORAGE_RECORDS.length; si++) {
    var s = STORAGE_RECORDS[si];
    var ctrs = s.containers || [];
    for (var ci=0; ci<ctrs.length; ci++) {
      if (ctrs[ci].locNo === fromLoc) {
        ctrs[ci].locNo = toLoc;
        if (!s.accessLog) s.accessLog = [];
        s.accessLog.push({ts:new Date().toISOString(), date:whDateStr(), type:'container-move',
          note:'Container '+ctrs[ci].containerNo+' moved from '+fromLoc+' to '+toLoc+'.'});
        toast('Moved ' + ctrs[ci].containerNo + ' → ' + toLoc);
        moved = true;
        break;
      }
    }
    if (moved) break;
  }
  whCellDetail = toLoc;
  renderWhGrid();
}

function whMarkNonClient(loc) {
  var desc = prompt('Description for this location (e.g. "Workshop tools", "Forklift parking"):');
  if (!desc) return;
  WH_NON_CLIENT[loc] = {desc:desc, type:'facility'};
  toast(loc + ' marked as facility use');
  renderWhGrid();
}

function whClearNonClient(loc) {
  delete WH_NON_CLIENT[loc];
  whCellDetail = null;
  toast(loc + ' cleared');
  renderWhGrid();
}

// ══ 3RD PARTY FLOWS ════════════════════════════════════════════════════

// Storage method state (persists while panel open)
var _tpStorageMethod = 'container'; // 'air'|'lcl'|'pallet'|'loose'|'container'

function wh3rdPartyIn(prefill) {
  prefill = prefill || {};
  _tpStorageMethod = prefill.storageMethod || 'container';
  var ds = whDateStr();

  el('p-title').textContent = '⬇️ Goods In — Warehouse Delivery';
  el('p-sub').textContent = 'Log incoming goods. Creates a storage record.';
  setH('p-body', whBuild3rdPartyInForm(prefill, ds));
  setH('p-foot', '<button class="btn btn-s" onclick="closePanel()">Cancel</button><button class="btn btn-p" id="tp-save-in">Confirm &amp; Create Record</button>');
  openPanel();
  whBind3rdPartyIn(ds);
}

function whBuild3rdPartyInForm(pf, ds) {
  pf = pf || {};
  var brandOpts = BRANDS.map(function(b){return '<option'+(b===(pf.brand||'')?' selected':'')+'>'+b+'</option>';}).join('');
  var channelOpts = ['Partner','Account','Domestic'].map(function(c){return '<option'+(c===(pf.channel||'')?' selected':'')+'>'+c+'</option>';}).join('');
  var mmOpts = '<option value="">— None —</option>' + MOVE_MANAGERS.map(function(m){return '<option value="'+esc(m.name)+'"'+(m.name===(pf.moveManager||'')?' selected':'')+'>'+esc(m.name)+' ('+esc(m.brand)+')</option>';}).join('');

  var h = '';

  // ── Section 1: Delivery Details ──────────────────────────────────────
  h += '<div class="fsec"><div class="fsec-t"><i>1</i>Delivery Details</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  h += '<div class="fg" style="grid-column:span 2"><label class="lbl">Client / Company *</label><input class="fi" id="tp-client" placeholder="Full name or company" value="'+esc(pf.client||'')+'"></div>';
  h += '<div class="fg"><label class="lbl">External Reference</label><input class="fi" id="tp-ref" placeholder="e.g. EXT-003" value="'+esc(pf.ref||'')+'"></div>';
  h += '<div class="fg"><label class="lbl">Date *</label><input class="fi" type="date" id="tp-date" value="'+(pf.date||ds)+'"></div>';
  h += '<div class="fg"><label class="lbl">Carrier / Sender</label><input class="fi" id="tp-carrier" placeholder="e.g. DHL, ABC Freight" value="'+esc(pf.carrier||'')+'"></div>';
  h += '<div class="fg"><label class="lbl">Volume ft³</label><input class="fi" type="number" id="tp-vol" min="0" placeholder="0" value="'+(pf.vol||'')+'"></div>';
  h += '<div class="fg" style="grid-column:span 2"><label class="lbl">Eventual Destination <span style="font-weight:400;color:var(--t3)">(town / address — for future delivery planning)</span></label><input class="fi" id="tp-dest" placeholder="e.g. Manchester, M1 or 14 High Street, Leeds" value="'+esc(pf.eventualDest||'')+'"></div>';
  h += '</div>';
  h += '<div class="fg" style="margin-top:8px"><label class="lbl">Notes / Description</label><textarea class="fi" id="tp-notes" rows="2" style="resize:vertical">'+esc(pf.notes||'')+'</textarea></div>';
  h += '</div>';

  // ── Section 2: Account / Partner ─────────────────────────────────────
  h += '<div class="fsec"><div class="fsec-t"><i>2</i>Account &amp; Partner</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  h += '<div class="fg"><label class="lbl">Brand / Account</label><select class="fi" id="tp-brand" onchange="whTPInBrandChange()">'+brandOpts+'</select></div>';
  h += '<div class="fg"><label class="lbl">Channel</label><select class="fi" id="tp-channel" onchange="whTPInBrandChange()">'+channelOpts+'</select></div>';
  h += '<div class="fg" style="grid-column:span 2" id="tp-mm-wrap">';
  h += '<label class="lbl">Move Manager</label><select class="fi" id="tp-mm">'+mmOpts+'</select>';
  h += '</div>';
  h += '</div></div>';

  // ── Section 3: Storage Method ─────────────────────────────────────────
  h += '<div class="fsec"><div class="fsec-t"><i>3</i>Storage Method</div>';
  var methods = [
    {key:'container', icon:'🏗️', lbl:'Containers', sub:'Loaded into wooden containers'},
    {key:'air',       icon:'✈️', lbl:'Air / Cases', sub:'Air shipment cases'},
    {key:'lcl',       icon:'📦', lbl:'LCL Cases',   sub:'Less-container-load cases'},
    {key:'pallet',    icon:'🪵', lbl:'Pallets',     sub:'Palletised goods'},
    {key:'loose',     icon:'🛋',  lbl:'Loose',       sub:'Oversized / loose items'},
  ];
  h += '<div class="stm-grid">';
  methods.forEach(function(m){
    h += '<div class="stm-tile'+(m.key===_tpStorageMethod?' sel':'')+'" id="stm-'+m.key+'" onclick="whSelectStorageMethod(\''+m.key+'\')">';
    h += '<div class="stm-tile-icon">'+m.icon+'</div>';
    h += '<div class="stm-tile-lbl">'+m.lbl+'</div>';
    h += '<div class="stm-tile-sub">'+m.sub+'</div>';
    h += '</div>';
  });
  h += '</div>';

  // Container-specific section (conditionally shown)
  h += '<div id="tp-container-section" style="display:'+(_tpStorageMethod==='container'?'block':'none')+';margin-top:10px;background:var(--s1);border:1px solid var(--b1);border-radius:7px;padding:12px">';
  h += '<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--t3);margin-bottom:10px">Container Assignment</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">';
  h += '<div class="fg"><label class="lbl">Number of Containers</label><input class="fi" type="number" id="tp-ctr-qty" min="1" placeholder="0" value="'+(pf.containerQty||'')+'" oninput="whTPInBuildContainerRows()"></div>';
  h += '<div class="fg"><label class="lbl">Container Size</label><select class="fi" id="tp-ctr-size"><option value="standard">Standard (max 250 ft³)</option><option value="small">Small (max 150 ft³)</option></select></div>';
  h += '<div class="fg"><label class="lbl">Vol per Container ft³</label><input class="fi" type="number" id="tp-ctr-vol" min="0" placeholder="auto" oninput="whTPInBuildContainerRows()"></div>';
  h += '</div>';
  h += '<div id="tp-container-rows" style="margin-top:8px"></div>';
  h += '<div class="cs-hint" style="margin-top:8px">Container numbers and warehouse locations are assigned here or can be set later from the Warehouse Grid.</div>';
  h += '</div>';

  // Loose area note for non-container methods
  h += '<div id="tp-loose-note" style="display:'+(_tpStorageMethod!=='container'?'block':'none')+';margin-top:10px">';
  var methodLabels = {air:'Air/Cases',lcl:'LCL Cases',pallet:'Pallets',loose:'Loose items'};
  h += '<div class="cs-hint">📍 '+( methodLabels[_tpStorageMethod]||'Items')+' will be stored in the <strong>loose area (L01–L31)</strong>. Location can be assigned from the Warehouse Grid.</div>';
  h += '</div>';
  h += '</div>'; // fsec

  // ── Section 4: Storage Record Setup ──────────────────────────────────
  h += '<div class="fsec"><div class="fsec-t"><i>4</i>Storage Record &amp; Billing</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  h += '<div class="fg"><label class="lbl">Storage Type</label><select class="fi" id="tp-stype"><option value="longterm">Long-term</option><option value="inout">In/Out</option></select></div>';
  h += '<div class="fg"><label class="lbl">Billing Period</label><select class="fi" id="tp-sbtype"><option>monthly</option><option>weekly</option><option>flat</option></select></div>';
  h += '<div class="fg"><label class="lbl">Rate £</label><input class="fi" type="number" id="tp-srate" value="85" min="0" step="0.01"></div>';
  h += '<div class="fg"><label class="lbl">Rate Unit</label><select class="fi" id="tp-sbunit"><option value="cbm">Rate × CBM</option><option value="flat">Flat</option></select></div>';
  h += '</div></div>';

  return h;
}

function whBind3rdPartyIn(ds) {
  // Init container rows and MM visibility
  whTPInBuildContainerRows();
  whTPInBrandChange();

  var saveBtn = el('tp-save-in');
  if (!saveBtn) return;
  saveBtn.addEventListener('click', function(){
    var client = (el('tp-client')||{}).value||'';
    if (!client.trim()) { toast('Client name required'); return; }
    var ref      = (el('tp-ref')||{}).value||'';
    var brand    = (el('tp-brand')||{}).value||BRANDS[0];
    var channel  = (el('tp-channel')||{}).value||'';
    var mm       = (el('tp-mm')||{}).value||'';
    var carrier  = (el('tp-carrier')||{}).value||'';
    var date     = (el('tp-date')||{}).value||ds;
    var vol      = parseFloat((el('tp-vol')||{}).value)||0;
    var notes    = (el('tp-notes')||{}).value||'';
    var eventualDest = (el('tp-dest')||{}).value||'';
    var stype    = (el('tp-stype')||{}).value||'longterm';
    var sbtype   = (el('tp-sbtype')||{}).value||'monthly';
    var srate    = parseFloat((el('tp-srate')||{}).value)||85;
    var sbunit   = (el('tp-sbunit')||{}).value||'cbm';
    var cbm      = parseFloat((vol/35.315).toFixed(2));
    var method   = _tpStorageMethod;
    var ts       = new Date().toISOString();

    // Build container list if method=container
    var containers = [];
    if (method === 'container') {
      var qty = parseInt((el('tp-ctr-qty')||{}).value)||0;
      var ctrSize = (el('tp-ctr-size')||{}).value||'standard';
      var maxFt = ctrSize === 'small' ? 150 : 250;
      var perVol = parseFloat((el('tp-ctr-vol')||{}).value)||0;
      for (var ci=0; ci<qty; ci++) {
        var cnoEl = el('tp-cno-'+ci);
        var clocEl = el('tp-cloc-'+ci);
        var cvolEl = el('tp-cvol-'+ci);
        containers.push({
          containerNo: (cnoEl?cnoEl.value:'').trim().toUpperCase() || ('C-TBA-'+ci),
          locNo: (clocEl?clocEl.value:'').trim().toUpperCase() || '',
          type: ctrSize,
          volFt: parseFloat(cvolEl?cvolEl.value:0)||perVol||0,
          maxFt: maxFt,
          dateIn: date
        });
      }
    }

    // Build method description
    var methodDesc = {container:'Container storage',air:'Air shipment / cases',lcl:'LCL cases',pallet:'Pallets',loose:'Loose / oversized'}[method]||method;
    var inboundNote = methodDesc+' delivery in — '+vol+' ft³'+(carrier?' via '+carrier:'')+'. Ref: '+(ref||'N/A')+'.';

    // Create storage record
    var stoId = 'S' + String(100+storageSeq++).slice(-3);
    STORAGE_RECORDS.push({
      id:stoId, type:stype, client:client, brand:brand, channel:channel,
      moveManager:mm,
      volFt:vol, cbm:cbm, volRemaining:vol,
      storageMethod: method,
      eventualDest: eventualDest,
      dateIn:date, dateOut:'', status:'active',
      billingType:sbtype, billingRate:srate, billingUnit:sbunit,
      inboundJobId:'', outboundJobId:'',
      containers: containers,
      notes: notes,
      billingHistory:[],
      accessLog:[{ts:ts, date:ts.slice(0,10), type:'inbound',
        note:inboundNote+(notes?' '+notes:''), volChange:vol}]
    });

    // Create WH activity
    var actId = 'WA' + String(100+whActivitySeq++).slice(-3);
    WH_ACTIVITIES.push({
      id:actId, date:date, type:'3rd-party-in', direction:'in', status:'completed',
      client:client, clientRef:ref, brand:brand, moveManager:mm,
      description:methodDesc+' delivery — '+vol+' ft³'+(notes?' — '+notes:''),
      vol:vol, volUnit:'ft', storageId:stoId, eventualDest:eventualDest,
      containers:containers.map(function(c){return c.containerNo;}),
      storageMethod:method, jobId:'', crew:[], notes:notes, createdAt:ts
    });

    setBadge('storage-badge', STORAGE_RECORDS.filter(function(s){return s.status==='active';}).length);
    setBadge('wh-badge', WH_ACTIVITIES.filter(function(a){return a.date===whDateStr();}).length);
    closePanel();
    toast('✓ Storage record ' + stoId + ' created — ' + client); saveData('storage', stoId, STORAGE_RECORDS[STORAGE_RECORDS.length-1]);
    renderWarehouse();
  });
}

function whSelectStorageMethod(method) {
  _tpStorageMethod = method;
  // Toggle tile highlights
  ['container','air','lcl','pallet','loose'].forEach(function(m){
    var t = el('stm-'+m);
    if (t) t.classList.toggle('sel', m === method);
  });
  // Show/hide sections
  var cs = el('tp-container-section');
  var ln = el('tp-loose-note');
  if (cs) cs.style.display = method === 'container' ? 'block' : 'none';
  if (ln) {
    ln.style.display = method !== 'container' ? 'block' : 'none';
    if (method !== 'container') {
      var labels = {air:'Air/Cases',lcl:'LCL Cases',pallet:'Pallets',loose:'Loose items'};
      ln.innerHTML = '<div class="cs-hint">📍 '+(labels[method]||'Items')+' will be stored in the <strong>loose area (L01–L31)</strong>. Location can be assigned from the Warehouse Grid.</div>';
    }
  }
}

function whTPInBrandChange() {
  var brand   = (el('tp-brand')||{}).value||'';
  var channel = (el('tp-channel')||{}).value||'';
  var mmWrap  = el('tp-mm-wrap');
  if (!mmWrap) return;
  // Show MM selector for Partner or Account channels
  var show = channel === 'Partner' || channel === 'Account';
  mmWrap.style.display = show ? '' : 'none';
  // Filter move managers by brand
  var mmSel = el('tp-mm');
  if (mmSel && brand) {
    var matching = MOVE_MANAGERS.filter(function(m){return m.brand === brand;});
    var prev = mmSel.value;
    mmSel.innerHTML = '<option value="">— None —</option>' +
      MOVE_MANAGERS.map(function(m){
        var isBrand = m.brand === brand;
        return '<option value="'+esc(m.name)+'"'+(m.name===prev?' selected':'')+
          (isBrand?'':' style="color:var(--t3)"')+'>'+esc(m.name)+' ('+esc(m.brand)+')</option>';
      }).join('');
    // Auto-select if only one matching
    if (matching.length === 1 && !prev) mmSel.value = matching[0].name;
  }
}

function whTPInBuildContainerRows() {
  var rowsDiv = el('tp-container-rows');
  if (!rowsDiv) return;
  var qty = parseInt((el('tp-ctr-qty')||{}).value)||0;
  var perVol = (el('tp-ctr-vol')||{}).value||'';
  var h = '';
  if (qty > 0) {
    h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:4px">';
    h += '<div style="font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.4px">Container No.</div>';
    h += '<div style="font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.4px">Location</div>';
    h += '<div style="font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.4px">Vol ft³</div>';
    h += '</div>';
    for (var ci=0; ci<Math.min(qty,20); ci++) {
      h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:5px">';
      h += '<input class="fi" id="tp-cno-'+ci+'" placeholder="e.g. C250" style="font-family:monospace;font-size:11.5px">';
      h += '<input class="fi" id="tp-cloc-'+ci+'" placeholder="e.g. A2-05" style="font-family:monospace;font-size:11.5px">';
      h += '<input class="fi" type="number" id="tp-cvol-'+ci+'" placeholder="'+(perVol||'0')+'" min="0" style="font-size:11.5px">';
      h += '</div>';
    }
    if (qty > 20) h += '<div class="cs-hint">Showing first 20 rows — enter remaining containers after saving via the Storage Record.</div>';
  }
  rowsDiv.innerHTML = h;
}

function wh3rdPartyOut(prefillClient, prefillDate) {
  var ds = whDateStr();
  el('p-title').textContent = '⬆️ Goods Out — Collection';
  el('p-sub').textContent = 'Log external carrier collecting goods. No crew handling required.';

  var h = '<div class="fsec"><div class="fsec-t"><i>1</i>Find Storage Record</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  h += '<div class="fg"><label class="lbl">Search Client *</label><input class="fi" id="tpo-search" placeholder="Client name…" value="'+esc(prefillClient||'')+'" oninput="whTPOSearch(this.value)"></div>';
  h += '<div class="fg"><label class="lbl">Date</label><input class="fi" type="date" id="tpo-date" value="'+(prefillDate||ds)+'"></div>';
  h += '</div>';
  h += '<div id="tpo-results" style="margin-top:8px"></div>';
  h += '<div id="tpo-detail" style="margin-top:10px"></div>';
  h += '</div>';
  h += '<div class="fsec"><div class="fsec-t"><i>2</i>Carrier / Reference</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  h += '<div class="fg"><label class="lbl">Carrier Name</label><input class="fi" id="tpo-carrier" placeholder="e.g. ABC Freight"></div>';
  h += '<div class="fg"><label class="lbl">Notes</label><input class="fi" id="tpo-notes" placeholder="e.g. Ref OKA-220"></div>';
  h += '<div class="fg" style="grid-column:span 2"><label class="lbl">Eventual Destination <span style="font-weight:400;color:var(--t3)">(town / address)</span></label><input class="fi" id="tpo-dest" placeholder="e.g. Manchester M1 or 14 High Street, Leeds"></div>';
  h += '</div></div>';

  setH('p-body', h);
  setH('p-foot', '<button class="btn btn-s" onclick="closePanel()">Cancel</button><button class="btn btn-p" id="tpo-save">Confirm Collection</button>');
  openPanel();

  el('tpo-save').addEventListener('click', function(){
    var stoId = el('tpo-save').getAttribute('data-stoid')||'';
    if (!stoId) { toast('Select a storage record first'); return; }
    var carrier = (el('tpo-carrier')||{}).value||'';
    var notes   = (el('tpo-notes')||{}).value||'';
    var dest    = (el('tpo-dest')||{}).value||'';
    var date    = (el('tpo-date')||{}).value||ds;
    var rec = STORAGE_RECORDS.filter(function(s){return s.id===stoId;})[0];
    if (!rec) { toast('Storage record not found'); return; }
    var ts = new Date().toISOString();

    // Log access
    if (!rec.accessLog) rec.accessLog = [];
    rec.accessLog.push({ts:ts, date:ts.slice(0,10), type:'outbound',
      note:'3rd party collection — carrier: '+(carrier||'unknown')+(dest?' → '+dest:'')+(notes?'. '+notes:''),
      volChange:-(rec.volRemaining||0)});
    rec.status = 'out';
    rec.dateOut = date;
    if (dest && !rec.eventualDest) rec.eventualDest = dest;

    // WH activity
    var actId2 = 'WA' + String(100+whActivitySeq++).slice(-3);
    WH_ACTIVITIES.push({
      id:actId2, date:date, type:'3rd-party-out', direction:'out', status:'completed',
      client:rec.client, clientRef:'', brand:rec.brand,
      description:'3rd party collection — carrier: '+(carrier||'unknown')+(dest?' → '+dest:'')+(notes?'. '+notes:''),
      vol:rec.volRemaining||rec.volFt||0, volUnit:'ft', storageId:stoId, eventualDest:dest,
      containers:(rec.containers||[]).map(function(c){return c.containerNo;}),
      jobId:'', crew:[], notes:notes, createdAt:ts
    });

    setBadge('storage-badge', STORAGE_RECORDS.filter(function(s){return s.status==='active';}).length);
    closePanel();
    toast('Collection logged — ' + rec.client + ' (' + stoId + ')');
    renderWarehouse();
  });
}

var whTPOSelectedId = '';
function whTPOSearch(term) {
  var results = el('tpo-results');
  if (!results) return;
  if (!term.trim()) { results.innerHTML = ''; return; }
  var matches = STORAGE_RECORDS.filter(function(s){
    return (s.status==='active') && s.client.toLowerCase().indexOf(term.toLowerCase()) >= 0;
  });
  if (!matches.length) { results.innerHTML = '<div style="font-size:12px;color:var(--t3)">No active records found</div>'; return; }
  var h = '';
  for (var i=0; i<matches.length; i++) {
    var s = matches[i];
    h += '<div class="sto-rec-card" onclick="whTPOSelect(\''+s.id+'\')">';
    h += '<div class="sto-rec-head"><span class="sto-rec-id">'+esc(s.id)+'</span><span class="sto-rec-client">'+esc(s.client)+'</span></div>';
    h += '<div style="font-size:11px;color:var(--t3)">'+esc((s.containers||[]).map(function(c){return c.containerNo;}).join(', '))+' &bull; '+(s.volRemaining||s.volFt||0)+' ft³</div>';
    h += '</div>';
  }
  results.innerHTML = h;
}

function whTPOSelect(sid) {
  var rec = STORAGE_RECORDS.filter(function(s){return s.id===sid;})[0];
  if (!rec) return;
  var savBtn = el('tpo-save');
  if (savBtn) savBtn.setAttribute('data-stoid', sid);
  var det = el('tpo-detail');
  if (det) {
    det.innerHTML = '<div class="sto-rec-card sel"><div class="sto-rec-head"><span class="sto-rec-id">'+esc(rec.id)+'</span><span class="sto-rec-client">'+esc(rec.client)+'</span></div><div style="font-size:11px;color:var(--t3)">'+esc((rec.containers||[]).map(function(c){return c.containerNo;}).join(', '))+' &bull; '+(rec.volRemaining||rec.volFt||0)+' ft³ &bull; '+(rec.containers||[]).length+' containers</div></div>';
  }
  // Collapse results
  var res = el('tpo-results');
  if (res) res.innerHTML = '';
}

// ══ MANUAL ACTIVITY ════════════════════════════════════════════════════
function whAddActivity() {
  var ds = whDateStr();
  el('p-title').textContent = 'Add Warehouse Activity';
  el('p-sub').textContent = 'Log a non-job warehouse task or event for this date.';
  var crewOpts = CREW.map(function(c){return '<option value="'+esc(c.name)+'">'+esc(c.name)+'</option>';}).join('');
  var h = '<div class="fsec"><div class="fsec-t">Activity Details</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  h += '<div class="fg"><label class="lbl">Type</label><select class="fi" id="wa-type">';
  h += '<option value="activity">General Activity</option>';
  h += '<option value="3rd-party-in">3rd Party Delivery In</option>';
  h += '<option value="3rd-party-out">3rd Party Collection Out</option>';
  h += '<option value="audit">Container Audit</option>';
  h += '<option value="maintenance">Warehouse Maintenance</option>';
  h += '</select></div>';
  h += '<div class="fg"><label class="lbl">Date</label><input class="fi" type="date" id="wa-date" value="'+ds+'"></div>';
  h += '<div class="fg" style="grid-column:span 2"><label class="lbl">Description *</label><input class="fi" id="wa-desc" placeholder="What is happening?"></div>';
  h += '<div class="fg"><label class="lbl">Client (if applicable)</label><input class="fi" id="wa-client" placeholder="Optional"></div>';
  h += '<div class="fg"><label class="lbl">Volume ft³</label><input class="fi" type="number" id="wa-vol" min="0" placeholder="0"></div>';
  h += '<div class="fg" style="grid-column:span 2"><label class="lbl">Assign Crew</label><select class="fi" id="wa-crew" multiple style="height:80px">'+crewOpts+'</select></div>';
  h += '</div>';
  h += '<div class="fg" style="margin-top:8px"><label class="lbl">Notes</label><textarea class="fi" id="wa-notes" rows="2" style="resize:vertical"></textarea></div>';
  h += '</div>';
  setH('p-body', h);
  setH('p-foot', '<button class="btn btn-s" onclick="closePanel()">Cancel</button><button class="btn btn-p" id="wa-save">Save Activity</button>');
  openPanel();
  el('wa-save').addEventListener('click', function(){
    var desc = (el('wa-desc')||{}).value||'';
    if (!desc.trim()) { toast('Description required'); return; }
    var type   = (el('wa-type')||{}).value||'activity';
    var date   = (el('wa-date')||{}).value||ds;
    var client = (el('wa-client')||{}).value||'';
    var vol    = parseFloat((el('wa-vol')||{}).value)||0;
    var notes  = (el('wa-notes')||{}).value||'';
    var dir    = (type==='3rd-party-in')?'in':(type==='3rd-party-out')?'out':'activity';
    var crewSel = el('wa-crew');
    var crew = [];
    if (crewSel) { for (var oi=0; oi<crewSel.options.length; oi++) { if (crewSel.options[oi].selected) crew.push(crewSel.options[oi].value); } }
    var actId = 'WA' + String(100+whActivitySeq++).slice(-3);
    WH_ACTIVITIES.push({
      id:actId, date:date, type:type, direction:dir,
      client:client, clientRef:'', brand:'',
      description:desc, vol:vol, volUnit:'ft',
      storageId:'', containers:[], jobId:'', crew:crew,
      notes:notes, createdAt:new Date().toISOString()
    });
    setBadge('wh-badge', WH_ACTIVITIES.filter(function(a){return a.date===whDateStr();}).length);
    closePanel();
    toast('Activity logged'); saveData('wh', actId, WH_ACTIVITIES[WH_ACTIVITIES.length-1]);
    renderWarehouse();
  });
}

function whEditActivity(id) {
  var act = WH_ACTIVITIES.filter(function(a){return a.id===id;})[0];
  if (!act) return;
  el('p-title').textContent = 'Edit Activity — ' + id;
  el('p-sub').textContent = act.date;
  var h = '<div class="fsec"><div class="fsec-t">Edit Details</div>';
  h += '<div class="fg"><label class="lbl">Description</label><input class="fi" id="wae-desc" value="'+esc(act.description)+'"></div>';
  h += '<div class="fg" style="margin-top:8px"><label class="lbl">Notes</label><textarea class="fi" id="wae-notes" rows="2">'+esc(act.notes||'')+'</textarea></div>';
  h += '</div>';
  setH('p-body', h);
  setH('p-foot', '<button class="btn btn-del btn-sm" id="wae-del">Delete</button><button class="btn btn-s" onclick="closePanel()">Cancel</button><button class="btn btn-p" id="wae-save">Save</button>');
  openPanel();
  el('wae-save').addEventListener('click', function(){
    act.description = (el('wae-desc')||{}).value || act.description;
    act.notes = (el('wae-notes')||{}).value || '';
    closePanel(); toast('Activity updated'); renderWarehouse(); saveData('wh', act.id, act);
  });
  el('wae-del').addEventListener('click', function(){
    if (!confirm('Delete this activity?')) return;
    WH_ACTIVITIES = WH_ACTIVITIES.filter(function(a){return a.id!==id;});
    closePanel(); toast('Activity deleted'); renderWarehouse(); deleteData('wh', id);
  });
}

function whShowActivityDetail(act) {
  var isPending = act.status === 'pending';
  var typeTitle = act.type.replace(/-/g,' ').replace(/\b\w/g,function(c){return c.toUpperCase();});
  el('p-title').textContent = typeTitle + (isPending ? ' 🕐' : '');
  el('p-sub').textContent = act.date + (act.client ? ' — ' + act.client : '');

  var dirIcon = act.direction==='in'?'⬇️':act.direction==='out'?'⬆️':'📋';

  var h = '';

  // Pending banner
  if (isPending) {
    h += '<div style="display:flex;align-items:center;gap:10px;background:#FFF5E0;border:1px solid #FFD580;border-radius:7px;padding:10px 14px;margin-bottom:14px">';
    h += '<span style="font-size:18px">🕐</span>';
    h += '<div><div style="font-weight:700;font-size:12.5px;color:#9A5600">Awaiting Arrival</div>';
    h += '<div style="font-size:11.5px;color:#B87300;margin-top:2px">This movement has been scheduled but not yet confirmed as arrived.</div></div>';
    h += '<button class="btn btn-p btn-sm" style="margin-left:auto" id="wad-arrived">✓ Mark Arrived</button>';
    h += '</div>';
  }

  h += '<div class="fsec"><div class="fsec-t">Details</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  h += '<div class="di"><div class="dlbl">Type</div><div class="dval">'+dirIcon+' '+esc(act.type.replace(/-/g,' '))+'</div></div>';
  h += '<div class="di"><div class="dlbl">Date</div><div class="dval" style="color:var(--blue);font-weight:700">'+fmtNice(act.date)+'</div></div>';
  h += '<div class="di"><div class="dlbl">Status</div><div class="dval"><span style="font-size:10.5px;font-weight:700;padding:2px 8px;border-radius:8px;'+(isPending?'background:#FFF5E0;color:#9A5600;border:1px solid #FFD580':'background:#E6FFF5;color:#007048;border:1px solid #B8EDD9')+'">'+( isPending?'🕐 Pending':'✓ Completed')+'</span></div></div>';
  if (act.client) h += '<div class="di"><div class="dlbl">Client</div><div class="dval" style="font-weight:700">'+esc(act.client)+'</div></div>';
  if (act.clientRef) h += '<div class="di"><div class="dlbl">Ref</div><div class="dval" style="font-family:monospace">'+esc(act.clientRef)+'</div></div>';
  if (act.vol) h += '<div class="di"><div class="dlbl">Volume</div><div class="dval">'+act.vol+' ft³</div></div>';
  if (act.eventualDest) h += '<div class="di" style="grid-column:span 2"><div class="dlbl">Eventual Destination</div><div class="dval" style="font-weight:600;color:var(--blue)">📍 '+esc(act.eventualDest)+'</div></div>';
  if (act.crew && act.crew.length) h += '<div class="di"><div class="dlbl">Crew</div><div class="dval">'+esc(act.crew.join(', '))+'</div></div>';
  h += '</div>';
  h += '<div class="fg" style="margin-top:10px"><div class="dlbl">Description</div><div class="dval" style="background:var(--s1);border:1px solid var(--b1);border-radius:4px;padding:8px;margin-top:4px;font-size:12.5px">'+esc(act.description)+'</div></div>';
  if (act.notes) h += '<div class="fg" style="margin-top:8px"><div class="dlbl">Notes</div><div class="dval" style="background:var(--s1);border:1px solid var(--b1);border-radius:4px;padding:8px;margin-top:4px;font-size:12.5px;color:var(--t2)">'+esc(act.notes)+'</div></div>';
  h += '</div>';

  var footBtns = '<button class="btn btn-s" onclick="closePanel()">Close</button><button class="btn btn-s btn-sm" id="wad-edit">Edit</button>';
  if (act.storageId) footBtns += '<button class="btn btn-p btn-sm" onclick="closePanel();viewStorage(\''+esc(act.storageId)+'\')">Open Storage</button>';

  setH('p-body', h);
  setH('p-foot', footBtns);
  openPanel();

  var arrivedBtn = el('wad-arrived');
  if (arrivedBtn) arrivedBtn.addEventListener('click', function(){ whMarkArrived(act.id); closePanel(); });
  var editBtn = el('wad-edit');
  if (editBtn) editBtn.addEventListener('click', function(){ whEditActivity(act.id); });
}

// ══ EMAIL PARSER ═══════════════════════════════════════════════════════

var _whParsed = null; // holds last parsed result

function whParseEmail() {
  el('p-title').textContent = '📧 Parse Warehouse Email';
  el('p-sub').textContent = 'Paste any notification email — Claude extracts all movement details instantly';

  var h = '<div class="fsec"><div class="fsec-t">Paste Email</div>';
  h += '<textarea class="fi" id="wh-email-text" rows="7" style="resize:vertical;min-height:120px;font-size:12px;line-height:1.6" placeholder="Paste the email here…\n\ne.g.:\nPlease be advised that the following shipment will arrive at your warehouse on 24th Feb:\nClient: Hamilton Associates\nRef: HA-2026-041\nContent: Household goods — 4 LCL cases\nApprox volume: 280ft³\nCarrier: DB Schenker\nExpected: 24 Feb 2026"></textarea>';
  h += '<div style="display:flex;gap:8px;margin-top:8px">';
  h += '<button class="btn btn-p btn-sm" id="wh-parse-btn">✦ Extract Details</button>';
  h += '<button class="btn btn-s btn-sm" onclick="el(\'wh-email-text\').value=\'\'">Clear</button>';
  h += '</div></div>';
  h += '<div id="wh-parse-result"></div>';

  setH('p-body', h);
  setH('p-foot', '<button class="btn btn-s" onclick="closePanel()">Cancel</button>');
  openPanel();

  el('wh-parse-btn').addEventListener('click', function() {
    var text = (el('wh-email-text')||{}).value||'';
    if (!text.trim()) { toast('Paste an email first'); return; }
    var btn = el('wh-parse-btn');
    btn.innerHTML = '<span class="ai-spin"></span> Parsing…';
    btn.disabled = true;

    var brandList = BRANDS.join(', ');
    var prompt = 'You are a warehouse operations assistant. Extract movement details from this email.\n\nReturn ONLY valid JSON, no markdown, no explanation:\n{\n  "direction": "in" | "out" | "unknown",\n  "client": string | null,\n  "date": "YYYY-MM-DD" | null,\n  "volume": number | null,\n  "storageMethod": "container" | "air" | "lcl" | "pallet" | "loose" | null,\n  "containerQty": number | null,\n  "carrier": string | null,\n  "ref": string | null,\n  "brand": one of [' + brandList + '] | null,\n  "eventualDest": string | null,\n  "notes": string | null,\n  "_conf": { "<key>": "confirmed" | "assumed" }\n}\n\nRules:\n- storageMethod: "container" if it says wooden containers or just containers; "air" if air shipment or air cases; "lcl" if LCL or less-container-load; "pallet" if pallets; "loose" if loose/oversized/furniture.\n- direction: "in" if arriving/delivering/inbound; "out" if collecting/outbound/delivery.\n- eventualDest: extract any final destination address, town, city, or postcode mentioned (where the goods will ultimately be delivered). Set null if not mentioned.\n- Only mark confirmed if explicit, assumed if inferred.\n\nEMAIL:\n' + text;

    fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 800,
        messages: [{role:'user', content: prompt}]
      })
    })
    .then(function(r){ return r.json(); })
    .then(function(data) {
      btn.innerHTML = '✦ Extract Details';
      btn.disabled = false;
      var raw = ((data.content||[])[0]||{}).text || '';
      raw = raw.replace(/```json|```/g,'').trim();
      var parsed;
      try { parsed = JSON.parse(raw); } catch(e) { toast('Could not parse AI response — try again'); return; }
      _whParsed = parsed;
      whRenderParseResult(parsed);
    })
    .catch(function(err) {
      btn.innerHTML = '✦ Extract Details';
      btn.disabled = false;
      toast('API error — check connection');
    });
  });
}

function whRenderParseResult(p) {
  var conf = p._conf || {};
  var h = '<div class="fsec"><div class="fsec-t" style="display:flex;align-items:center;gap:8px">Extracted Details <span style="font-size:10px;font-weight:600;color:var(--t3)">(amber = assumed · click to edit)</span></div>';

  // Direction selector
  h += '<div style="margin-bottom:12px">';
  h += '<div style="font-size:10.5px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px">Direction</div>';
  h += '<div style="display:flex;gap:8px">';
  ['in','out','unknown'].forEach(function(d) {
    var icons = {in:'⬇️ Goods IN', out:'⬆️ Goods OUT', unknown:'❓ Unknown'};
    var isSel = (p.direction||'unknown') === d;
    h += '<div class="wh-parse-dir-btn'+(isSel?' sel':'')+'" onclick="whParseSetDir(\''+d+'\')" id="wh-pdir-'+d+'">'+icons[d]+'</div>';
  });
  h += '</div></div>';

  // Field chips
  var fields = [
    {key:'client',        lbl:'Client'},
    {key:'date',          lbl:'Date'},
    {key:'volume',        lbl:'Volume ft³'},
    {key:'storageMethod', lbl:'Storage Method'},
    {key:'containerQty',  lbl:'Containers'},
    {key:'carrier',       lbl:'Carrier'},
    {key:'ref',           lbl:'Reference'},
    {key:'brand',         lbl:'Brand'},
    {key:'eventualDest',  lbl:'Destination'},
    {key:'notes',         lbl:'Notes'},
  ];

  h += '<div class="wh-parse-chips">';
  fields.forEach(function(f) {
    var val = p[f.key];
    var c = conf[f.key] || (val ? 'assumed' : 'missing');
    h += '<div class="wh-parse-row">';
    h += '<span class="wh-parse-lbl">'+f.lbl+'</span>';
    if (val !== null && val !== undefined) {
      var display = String(val);
      if (f.key === 'storageMethod') {
        var smlbls = {container:'🏗️ Containers', air:'✈️ Air/Cases', lcl:'📦 LCL', pallet:'🪵 Pallets', loose:'🛋 Loose'};
        display = smlbls[val] || val;
      }
      h += '<span class="wh-chip '+c+'" onclick="whParseChipEdit(this,\''+f.key+'\')" title="Click to edit">';
      h += esc(display.length > 45 ? display.substring(0,45)+'…' : display);
      h += ' <span class="wh-chip-edit">✎</span></span>';
      h += '<input class="wh-parse-edit-inp" id="whpe-'+f.key+'" value="'+esc(String(val))+'" onblur="whParseChipSave(this,\''+f.key+'\')" onkeydown="if(event.key===\'Enter\')whParseChipSave(this,\''+f.key+'\')">';
    } else {
      h += '<span class="wh-chip missing">✕ Not found — click to add</span>';
      h += '<input class="wh-parse-edit-inp" id="whpe-'+f.key+'" placeholder="Enter manually…" onblur="whParseChipSave(this,\''+f.key+'\')" onkeydown="if(event.key===\'Enter\')whParseChipSave(this,\''+f.key+'\')">';
    }
    h += '</div>';
  });
  h += '</div></div>';

  // Action buttons
  var dir = p.direction || 'unknown';
  h += '<div style="display:flex;gap:8px;margin-top:14px">';
  if (dir === 'in' || dir === 'unknown') {
    h += '<button class="btn btn-p" id="wh-parse-goto-in" onclick="whParseOpenIn()">⬇️ Open as Goods In</button>';
  }
  if (dir === 'out' || dir === 'unknown') {
    h += '<button class="btn btn-s" id="wh-parse-goto-out" onclick="whParseOpenOut()">⬆️ Open as Goods Out</button>';
  }
  h += '</div>';

  var result = el('wh-parse-result');
  if (result) result.innerHTML = h;

  // Update footer
  setH('p-foot', '<button class="btn btn-s" onclick="closePanel()">Cancel</button>');
}

function whParseSetDir(d) {
  if (!_whParsed) return;
  _whParsed.direction = d;
  ['in','out','unknown'].forEach(function(x) {
    var b = el('wh-pdir-'+x);
    if (b) b.classList.toggle('sel', x === d);
  });
  // Update action buttons visibility
  var btnIn  = el('wh-parse-goto-in');
  var btnOut = el('wh-parse-goto-out');
  if (btnIn)  btnIn.style.display  = (d==='in'  || d==='unknown') ? '' : 'none';
  if (btnOut) btnOut.style.display = (d==='out' || d==='unknown') ? '' : 'none';
}

function whParseChipEdit(chip, key) {
  chip.style.display = 'none';
  var inp = el('whpe-'+key);
  if (inp) { inp.style.display = 'inline-block'; inp.focus(); inp.select(); }
}

function whParseChipSave(inp, key) {
  var val = inp.value.trim();
  if (_whParsed) {
    _whParsed[key] = val || null;
    if (!_whParsed._conf) _whParsed._conf = {};
    _whParsed._conf[key] = 'confirmed';
  }
  // Re-render chips only
  whRenderParseResult(_whParsed);
}

function whParseOpenIn() {
  if (!_whParsed) return;
  var p = _whParsed;
  // Build prefill object for wh3rdPartyIn
  var prefill = {
    client:        p.client || '',
    ref:           p.ref || '',
    brand:         p.brand || '',
    date:          p.date || whDateStr(),
    vol:           p.volume || '',
    carrier:       p.carrier || '',
    notes:         p.notes || '',
    eventualDest:  p.eventualDest || '',
    storageMethod: p.storageMethod || 'container',
    containerQty:  p.containerQty || '',
  };
  closePanel();
  wh3rdPartyIn(prefill);
}

function whParseOpenOut() {
  if (!_whParsed) return;
  var p = _whParsed;
  closePanel();
  // Open Goods Out panel, pre-fill the search with client name
  wh3rdPartyOut(p.client || '', p.date || '');
}

// ══ BOOK DELIVERY FROM STORAGE ════════════════════════════════════════
function whBookDelivery(storageId) {
  var s = STORAGE_RECORDS.filter(function(r){return r.id===storageId;})[0];
  if (!s) { toast('Storage record not found'); return; }
  if (s.status !== 'active') { toast('Storage record is not active'); return; }

  // Pre-build the panel for selecting containers + confirming dest before launching job form
  el('p-title').textContent = '📦 Book Delivery from Storage';
  el('p-sub').textContent = s.client + ' · ' + storageId;

  var ctrs = s.containers || [];
  var volRem = s.volRemaining !== undefined ? s.volRemaining : (s.volFt||0);

  var h = '';

  // Storage summary banner
  h += '<div style="background:#E6FFF5;border:1px solid #B8EDD9;border-radius:7px;padding:12px 14px;margin-bottom:14px;display:flex;align-items:center;gap:14px">';
  h += '<span style="font-size:24px">🏭</span>';
  h += '<div style="flex:1"><div style="font-weight:700;font-size:14px;color:var(--t1)">'+esc(s.client)+'</div>';
  h += '<div style="font-size:12px;color:var(--t3);margin-top:2px">'+esc(storageId)+' &bull; '+volRem+' ft³ remaining &bull; '+ctrs.length+' container'+(ctrs.length!==1?'s':'')+'</div>';
  if (s.eventualDest) h += '<div style="font-size:11.5px;color:var(--blue);margin-top:3px;font-weight:600">📍 Known destination: '+esc(s.eventualDest)+'</div>';
  h += '</div></div>';

  // Delivery details
  h += '<div class="fsec"><div class="fsec-t"><i>1</i>Delivery Details</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  h += '<div class="fg" style="grid-column:span 2"><label class="lbl">Delivery Address / Destination *</label><input class="fi" id="wbd-dest" placeholder="Full address or town" value="'+esc(s.eventualDest||'')+'"></div>';
  h += '<div class="fg"><label class="lbl">Job Date</label><input class="fi" type="date" id="wbd-date" value="'+whDateStr(new Date())+'"></div>';
  h += '<div class="fg"><label class="lbl">Job Type</label><select class="fi" id="wbd-jtype">';
  ['Ex Store Delivery','Door to Door','European','Sea','Air'].forEach(function(t){
    h += '<option'+(t==='Ex Store Delivery'?' selected':'')+'>'+t+'</option>';
  });
  h += '</select></div>';
  h += '</div></div>';

  // Container selection
  h += '<div class="fsec"><div class="fsec-t"><i>2</i>Select Containers for Delivery';
  h += ' <span style="font-weight:400;font-size:11px;color:var(--t3)">— choose which items leave storage</span></div>';

  if (ctrs.length) {
    h += '<div style="margin-bottom:8px">';
    h += '<label style="font-size:11px;color:var(--t3);cursor:pointer"><input type="checkbox" id="wbd-select-all" onchange="whBDSelectAll(this.checked)" style="margin-right:5px">Select all</label>';
    h += '</div>';
    for (var ci=0; ci<ctrs.length; ci++) {
      var ct = ctrs[ci];
      h += '<div class="sto-container-row" id="wbd-ctr-row-'+ci+'" onclick="whBDToggleContainer('+ci+')" style="cursor:pointer">';
      h += '<input type="checkbox" id="wbd-ctr-'+ci+'" checked style="flex-shrink:0">';
      h += '<span style="font-family:monospace;font-weight:800;font-size:13px;color:var(--t1)">'+esc(ct.containerNo)+'</span>';
      if (ct.locNo) h += '<span style="font-size:10.5px;color:var(--t3)">📍 '+esc(ct.locNo)+'</span>';
      h += '<span style="font-size:10.5px;padding:2px 6px;border-radius:4px;background:var(--s1);border:1px solid var(--b1)">'+esc(ct.type||'standard')+'</span>';
      h += '<span style="font-size:11px;font-weight:600;color:var(--t2)">'+esc(String(ct.volFt||0))+' ft³</span>';
      h += '</div>';
    }
  } else {
    h += '<div class="cs-hint" style="margin-bottom:4px">⚠ No containers assigned to this record yet — the job will be created with EX STORE as origin and no specific container list.</div>';
  }

  // Volume to remove
  h += '<div style="margin-top:12px;background:var(--alt);border:1px solid #FFD580;border-radius:7px;padding:10px 14px">';
  h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
  h += '<span style="font-size:11.5px;font-weight:700;color:var(--t2)">Volume being removed</span>';
  h += '<span style="font-size:11px;color:var(--t3)">Remaining in storage: <strong id="wbd-vol-remaining">'+volRem+'</strong> ft³</span>';
  h += '</div>';
  h += '<input class="fi" type="number" id="wbd-vol" min="0" step="1" value="'+volRem+'" placeholder="ft³" oninput="whBDCalcRemaining('+volRem+')">';
  h += '<div style="margin-top:6px;font-size:11.5px" id="wbd-vol-note"></div>';
  h += '</div>';
  h += '</div>';

  // Brand/ref pre-fill info
  h += '<div class="fsec"><div class="fsec-t"><i>3</i>Job Notes</div>';
  h += '<textarea class="fi" id="wbd-notes" rows="2" placeholder="Any additional delivery notes…" style="resize:vertical"></textarea></div>';

  setH('p-body', h);
  setH('p-foot', '<button class="btn btn-s" onclick="closePanel()">Cancel</button><button class="btn btn-p" id="wbd-confirm">Create Delivery Job →</button>');
  openPanel();

  // Initial volume note
  whBDCalcRemaining(volRem);

  el('wbd-confirm').addEventListener('click', function(){
    var dest = (el('wbd-dest')||{}).value||'';
    if (!dest.trim()) { toast('Destination address required'); return; }
    var date   = (el('wbd-date')||{}).value || whDateStr(new Date());
    var jtype  = (el('wbd-jtype')||{}).value || 'Ex Store Delivery';
    var vol    = parseFloat((el('wbd-vol')||{}).value)||volRem;
    var notes  = (el('wbd-notes')||{}).value||'';

    // Collect selected containers
    var selCtrs = [];
    for (var ci2=0; ci2<ctrs.length; ci2++) {
      var cb = el('wbd-ctr-'+ci2);
      if (cb && cb.checked) selCtrs.push(ctrs[ci2].containerNo);
    }

    // Build EX STORE origin string
    var originStr = selCtrs.length ? 'EX STORE [' + selCtrs.join(', ') + ']' : 'EX STORE';

    // Pre-seed eJob and open job form
    pMode = 'new';
    eJob = {
      id: 'J' + pad(jobs.length+1),
      ref: '',
      brand: s.brand || (BRANDS[0]||''),
      channel: s.channel || 'Partner',
      jobType: jtype,
      clientRef: s.id, // pre-fill with storage ref
      moveManager: s.moveManager || '',
      client: s.client,
      origin: originStr,
      dest: dest,
      start: date, end: date,
      vol: vol,
      cbm: parseFloat((vol/35.315).toFixed(2)),
      drivers: [], porters: [], mileage: 0, fuel: 0, veh: [],
      status: 'Scheduled',
      billing: [],
      notes: 'Delivery from storage ' + storageId + (selCtrs.length ? ' — containers: ' + selCtrs.join(', ') : '') + (notes ? '. ' + notes : ''),
      storageId: storageId,
      storageDirection: 'out',
      containersToRemove: selCtrs,
      volToRemove: vol,
    };

    closePanel();
    el('p-title').textContent = 'New Delivery Job';
    el('p-sub').textContent = s.client + ' · from ' + storageId;
    renderForm();
    openPanel();

    // Show a contextual hint at top of form
    var formBody = el('p-body');
    if (formBody) {
      var hint = document.createElement('div');
      hint.className = 'cs-hint';
      hint.style.cssText = 'background:#E6FFF5;border-color:#B8EDD9;color:#007048;margin-bottom:12px';
      hint.innerHTML = '🏭 Linked to storage record <strong>' + storageId + '</strong> — ' + s.client + '. Origin pre-set to EX STORE' + (selCtrs.length ? ' ['+selCtrs.join(', ')+']' : '') + '. Complete and confirm job details below.';
      formBody.insertBefore(hint, formBody.firstChild);
    }
  });
}

function whBDSelectAll(checked) {
  var i = 0;
  while (el('wbd-ctr-'+i)) {
    el('wbd-ctr-'+i).checked = checked;
    var row = el('wbd-ctr-row-'+i);
    if (row) row.classList.toggle('sel', checked);
    i++;
  }
}

function whBDToggleContainer(ci) {
  var cb = el('wbd-ctr-'+ci);
  if (!cb) return;
  cb.checked = !cb.checked;
  var row = el('wbd-ctr-row-'+ci);
  if (row) row.classList.toggle('sel', cb.checked);
}

function whBDCalcRemaining(totalVol) {
  var vol = parseFloat((el('wbd-vol')||{}).value)||0;
  var rem = totalVol - vol;
  var noteEl = el('wbd-vol-note');
  var remEl = el('wbd-vol-remaining');
  if (remEl) remEl.textContent = Math.max(0,rem);
  if (noteEl) {
    if (vol > totalVol) {
      noteEl.innerHTML = '<span style="color:var(--red);font-weight:600">⚠ Volume exceeds storage record remaining ('+totalVol+' ft³)</span>';
    } else if (rem === 0) {
      noteEl.innerHTML = '<span style="color:var(--green);font-weight:600">✓ Full clearance — storage record will be marked complete on job confirm</span>';
    } else {
      noteEl.innerHTML = '<span style="color:var(--amber);font-weight:600">Partial delivery — '+rem+' ft³ will remain in storage</span>';
    }
  }
}

// ── Wire into showMod ──────────────────────────────────────────────────
// Patch showMod to also handle warehouse
(function() {
  var _origShowMod = showMod;
  showMod = function(mod, btn) {
    if (mod === 'warehouse') {
      curMod = mod;
      document.querySelectorAll('.page').forEach(function(p){p.classList.remove('on');});
      document.querySelectorAll('.nb').forEach(function(b){b.classList.remove('on');});
      el('mod-warehouse').classList.add('on');
      btn.classList.add('on');
      el('tb-title').textContent = 'Warehouse';
      el('vtabs').style.display = 'none';
      renderWarehouse();
    } else {
      _origShowMod(mod, btn);
    }
  };
})();

// ══════════════════════════════════════════════════════════════════════════
// GOOGLE MAPS — ADDRESS LOOKUP, MAP MODAL, DISTANCE CALCULATION
// ══════════════════════════════════════════════════════════════════════════

var _mapsLoaded = false;
var _mapsLoading = false;
var _mapsCallbacks = [];

function mapsApiLoaded() {
  return _mapsLoaded && typeof google !== 'undefined' && google.maps && google.maps.places;
}

function loadGoogleMapsAPI(cb) {
  if (mapsApiLoaded()) { if (cb) cb(); return; }
  if (cb) _mapsCallbacks.push(cb);
  if (_mapsLoading) return;
  var key = APP_SETTINGS.googleMapsKey;
  if (!key) return;
  _mapsLoading = true;
  var s = document.createElement('script');
  s.src = 'https://maps.googleapis.com/maps/api/js?key='+key+'&libraries=places&callback=_gmapsReady';
  s.async = true; s.defer = true;
  document.head.appendChild(s);
}

window._gmapsReady = function() {
  _mapsLoaded = true; _mapsLoading = false;
  _mapsCallbacks.forEach(function(fn){ try{fn();}catch(e){} });
  _mapsCallbacks = [];
};

// ── Address autocomplete dropdown ──────────────────────────────────────
// Wraps an existing <input> in .addr-wrap and attaches autocomplete + map btn
function bindAddressField(inp, opts) {
  if (!inp || inp._addrBound) return;
  inp._addrBound = true;
  opts = opts || {};

  // Build wrapper
  var wrap = document.createElement('div');
  wrap.className = 'addr-wrap';
  inp.parentNode.insertBefore(wrap, inp);
  wrap.appendChild(inp);

  // Map button
  var mapBtn = document.createElement('button');
  mapBtn.type = 'button';
  mapBtn.className = 'addr-map-btn';
  mapBtn.title = 'View satellite / street view';
  mapBtn.innerHTML = '🗺';
  mapBtn.addEventListener('click', function(e) {
    e.preventDefault();
    var addr = inp.value.trim();
    if (!addr) { toast('Enter an address first'); return; }
    openMapModal(addr);
  });
  wrap.appendChild(mapBtn);

  // Distance calc button
  if (opts.showDist) {
    var distBtn = document.createElement('button');
    distBtn.type = 'button';
    distBtn.className = 'addr-calc-btn';
    distBtn.title = 'Calculate route distance';
    distBtn.innerHTML = '↔';
    distBtn.addEventListener('click', function(e) {
      e.preventDefault();
      var from = opts.fromFn ? opts.fromFn() : (APP_SETTINGS.warehouseAddress || SL_CONFIG.companyPostcode || '');
      var to = inp.value.trim();
      if (!from || !to) { toast('Need both origin and destination'); return; }
      distBtn.style.background = 'var(--alt)';
      calcRouteDistance(from, to, APP_SETTINGS.returnMileage, function(res) {
        distBtn.style.background = '';
        if (!res) { toast('Distance lookup failed — check API key'); return; }
        // Remove old result
        var old = wrap.nextSibling;
        if (old && old.className === 'miles-calc-result') old.parentNode.removeChild(old);
        var div = document.createElement('div');
        div.className = 'miles-calc-result';
        var legs = '<span class="leg">'+res.outMiles+'mi out</span>';
        if (res.retMiles) legs += ' <span style="color:var(--t4)">+</span> <span class="leg">'+res.retMiles+'mi return</span>';
        legs += ' <span class="total">= '+res.totalMiles+' mi total</span>';
        div.innerHTML = legs;
        if (opts.onCalc) {
          var usebtn = document.createElement('button');
          usebtn.className = 'btn btn-s btn-sm';
          usebtn.style.marginLeft = 'auto';
          usebtn.textContent = 'Use '+res.totalMiles+' mi';
          usebtn.addEventListener('click', function(){ opts.onCalc(res.totalMiles); div.parentNode && div.parentNode.removeChild(div); });
          div.appendChild(usebtn);
        }
        wrap.parentNode.insertBefore(div, wrap.nextSibling);
      });
    });
    wrap.appendChild(distBtn);
  }

  // Keep map btn colour updated + sync country flag
  function syncBtn() { mapBtn.classList.toggle('has-addr', !!(inp.value.trim())); }
  inp.addEventListener('input', syncBtn);
  inp.addEventListener('change', function(){ syncAddrFlag(inp); });
  syncBtn();
  // Sync flag for pre-filled values
  if (inp.value) setTimeout(function(){ syncAddrFlag(inp); }, 50);

  // Places autocomplete (only when Maps is loaded)
  var _ddTimer = null;
  inp.addEventListener('input', function() {
    clearTimeout(_ddTimer);
    var q = inp.value.trim();
    removeAddrDropdown(inp);
    if (q.length < 3 || !mapsApiLoaded()) return;
    _ddTimer = setTimeout(function() { showAddrSuggestions(inp, q); }, 280);
  });
  inp.addEventListener('blur', function() {
    setTimeout(function(){ removeAddrDropdown(inp); syncBtn(); }, 200);
  });
}

function removeAddrDropdown(inp) {
  var wrap = inp.parentNode;
  if (!wrap) return;
  var dd = wrap.querySelector('.addr-dropdown');
  if (dd) dd.parentNode.removeChild(dd);
}

// Country name → flag emoji lookup
var COUNTRY_FLAGS = {
  'united kingdom':'🇬🇧','uk':'🇬🇧','england':'🇬🇧','scotland':'🏴󠁧󠁢󠁳󠁣󠁴󠁿','wales':'🏴󠁧󠁢󠁷󠁬󠁳󠁿',
  'france':'🇫🇷','germany':'🇩🇪','spain':'🇪🇸','italy':'🇮🇹','portugal':'🇵🇹',
  'netherlands':'🇳🇱','holland':'🇳🇱','belgium':'🇧🇪','switzerland':'🇨🇭',
  'austria':'🇦🇹','denmark':'🇩🇰','sweden':'🇸🇪','norway':'🇳🇴','finland':'🇫🇮',
  'ireland':'🇮🇪','luxembourg':'🇱🇺','poland':'🇵🇱','czech republic':'🇨🇿',
  'hungary':'🇭🇺','romania':'🇷🇴','bulgaria':'🇧🇬','greece':'🇬🇷','turkey':'🇹🇷',
  'russia':'🇷🇺','ukraine':'🇺🇦','usa':'🇺🇸','united states':'🇺🇸','canada':'🇨🇦',
  'australia':'🇦🇺','new zealand':'🇳🇿','south africa':'🇿🇦','uae':'🇦🇪',
  'dubai':'🇦🇪','singapore':'🇸🇬','hong kong':'🇭🇰','japan':'🇯🇵','china':'🇨🇳',
  'india':'🇮🇳','brazil':'🇧🇷','mexico':'🇲🇽','nigeria':'🇳🇬','kenya':'🇰🇪',
  'ghana':'🇬🇭','tanzania':'🇹🇿','zimbabwe':'🇿🇼','qatar':'🇶🇦','saudi arabia':'🇸🇦',
  'israel':'🇮🇱','cyprus':'🇨🇾','malta':'🇲🇹','iceland':'🇮🇸','croatia':'🇭🇷',
  'slovakia':'🇸🇰','slovenia':'🇸🇮','serbia':'🇷🇸','bosnia':'🇧🇦','albania':'🇦🇱',
};
var COUNTRY_NAMES = Object.keys(COUNTRY_FLAGS);

function getFlagForAddress(addr) {
  if (!addr) return '🇬🇧';
  var lower = addr.toLowerCase();
  // Check last part of address for country
  var parts = addr.split(',');
  var last = (parts[parts.length-1]||'').trim().toLowerCase();
  if (COUNTRY_FLAGS[last]) return COUNTRY_FLAGS[last];
  // Check full string
  for (var i = 0; i < COUNTRY_NAMES.length; i++) {
    if (lower.indexOf(COUNTRY_NAMES[i]) >= 0) return COUNTRY_FLAGS[COUNTRY_NAMES[i]];
  }
  // UK postcodes (letters+numbers pattern)
  if (/^[A-Z]{1,2}[0-9]/.test(addr.trim().toUpperCase())) return '🇬🇧';
  return '🌍';
}

function showAddrSuggestions(inp, q) {
  removeAddrDropdown(inp);
  var wrap = inp.parentNode;
  if (!wrap) return;
  var dd = document.createElement('div');
  dd.className = 'addr-dropdown';

  // Country-only suggestions first (if query matches a country name)
  var qLow = q.toLowerCase().trim();
  var countryMatches = COUNTRY_NAMES.filter(function(c){ return c.indexOf(qLow) === 0 && qLow.length >= 2; }).slice(0, 3);
  countryMatches.forEach(function(c) {
    var flag = COUNTRY_FLAGS[c];
    var row = document.createElement('div');
    row.className = 'addr-option';
    row.innerHTML = '<span class="addr-option-icon">'+flag+'</span>'
      + '<div><div class="addr-option-main">'+c.replace(/\w/g, function(l){ return l.toUpperCase(); })+'</div>'
      + '<div class="addr-option-sub" style="color:var(--blue)">Country only</div></div>';
    row.addEventListener('mousedown', function(e) {
      e.preventDefault();
      var displayName = c.replace(/\w/g, function(l){ return l.toUpperCase(); });
      inp.value = displayName;
      inp.dataset.flag = flag;
      updateAddrFlag(inp, flag);
      inp.dispatchEvent(new Event('change'));
      removeAddrDropdown(inp);
    });
    dd.appendChild(row);
  });

  if (!mapsApiLoaded()) {
    if (dd.children.length) { wrap.style.position='relative'; wrap.appendChild(dd); }
    return;
  }

  // Google Places predictions — no country restriction for international
  var svc = new google.maps.places.AutocompleteService();
  svc.getPlacePredictions({ input: q }, function(preds, status) {
    if (status === 'OK' && preds && preds.length) {
      preds.slice(0, 6 - countryMatches.length).forEach(function(pred) {
        var parts = pred.description.split(',');
        var main = parts[0] || pred.description;
        var sub  = parts.slice(1).join(',').trim();
        var flag = getFlagForAddress(pred.description);
        var row  = document.createElement('div');
        row.className = 'addr-option';
        row.innerHTML = '<span class="addr-option-icon">'+flag+'</span>'
          + '<div><div class="addr-option-main">'+esc(main)+'</div>'
          + (sub ? '<div class="addr-option-sub">'+esc(sub)+'</div>' : '')
          + '</div>';
        row.addEventListener('mousedown', function(e) {
          e.preventDefault();
          inp.value = pred.description;
          inp.dataset.flag = flag;
          updateAddrFlag(inp, flag);
          inp.dispatchEvent(new Event('change'));
          removeAddrDropdown(inp);
          inp.parentNode && inp.parentNode.querySelector('.addr-map-btn') &&
            inp.parentNode.querySelector('.addr-map-btn').classList.add('has-addr');
        });
        dd.appendChild(row);
      });
    }
    if (dd.children.length) { wrap.style.position='relative'; wrap.appendChild(dd); }
  });
}

function updateAddrFlag(inp, flag) {
  var wrap = inp.closest ? inp.closest('.addr-wrap') : inp.parentNode;
  if (!wrap) return;
  var existing = wrap.querySelector('.addr-flag');
  if (flag) {
    if (!existing) {
      existing = document.createElement('span');
      existing.className = 'addr-flag';
      wrap.insertBefore(existing, inp);
    }
    existing.textContent = flag;
    inp.style.paddingLeft = '30px';
  } else if (existing) {
    existing.parentNode.removeChild(existing);
    inp.style.paddingLeft = '';
  }
}

function syncAddrFlag(inp) {
  if (!inp || !inp.value) return;
  var flag = getFlagForAddress(inp.value);
  updateAddrFlag(inp, flag);
}

// ── Map Modal (satellite + street view) ────────────────────────────────
var _mapAddr = '';

function openMapModal(address) {
  closeMapModal();
  _mapAddr = address;

  var overlay = document.createElement('div');
  overlay.className = 'map-modal-overlay';
  overlay.id = 'map-modal-overlay';
  overlay.addEventListener('click', function(e){ if(e.target===overlay) closeMapModal(); });

  var modal = document.createElement('div');
  modal.className = 'map-modal';

  var head = document.createElement('div');
  head.className = 'map-modal-head';
  head.innerHTML =
    '<div style="flex:1"><div class="map-modal-title">📍 '+esc(address)+'</div></div>'
    + '<div class="map-modal-tabs">'
    + '<button class="map-modal-tab on" id="mmt-sat" onclick="setMapView(\'satellite\')">🛰 Satellite</button>'
    + '<button class="map-modal-tab" id="mmt-str" onclick="setMapView(\'street\')">🚶 Street View</button>'
    + '</div>'
    + '<button class="map-modal-close" onclick="closeMapModal()" title="Close">✕</button>';

  var body = document.createElement('div');
  body.className = 'map-modal-body';
  body.id = 'map-modal-body';

  modal.appendChild(head); modal.appendChild(body);
  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  setMapView('satellite');
}

function setMapView(mode) {
  var body = el('map-modal-body');
  if (!body) return;
  var key = APP_SETTINGS.googleMapsKey;
  var q   = encodeURIComponent(_mapAddr);
  var src;

  if (!key) {
    // Fallback: Google Maps search embed (no key — limited but functional)
    src = 'https://www.google.com/maps?q='+q+'&output=embed'+(mode==='street'?'&layer=t':'');
  } else if (mode === 'street') {
    src = 'https://www.google.com/maps/embed/v1/streetview?key='+key+'&location='+q+'&heading=0&pitch=10&fov=90';
  } else {
    src = 'https://www.google.com/maps/embed/v1/place?key='+key+'&q='+q+'&maptype=satellite';
  }

  body.innerHTML = '<iframe src="'+src+'" style="width:100%;height:100%;min-height:480px;border:none" allowfullscreen loading="lazy"></iframe>';

  var satTab = el('mmt-sat'), strTab = el('mmt-str');
  if (satTab) satTab.classList.toggle('on', mode==='satellite');
  if (strTab) strTab.classList.toggle('on', mode==='street');
}

function closeMapModal() {
  var o = el('map-modal-overlay');
  if (o) o.parentNode.removeChild(o);
}

document.addEventListener('keydown', function(e){
  if (e.key === 'Escape') closeMapModal();
});

// ── Route distance via Distance Matrix API ────────────────────────────
// Returns {outMiles, retMiles, totalMiles} via callback
function calcRouteDistance(origin, destination, addReturn, cb) {
  // Fallback: try postcode distance estimate if Maps not loaded
  if (!mapsApiLoaded()) {
    var est = postcodeDistanceMiles ? postcodeDistanceMiles(origin, destination) : 0;
    if (est) {
      var ret = addReturn ? Math.round(est) : 0;
      cb({ outMiles: Math.round(est), retMiles: ret, totalMiles: Math.round(est) + ret });
    } else {
      cb(null);
    }
    return;
  }

  var wh = APP_SETTINGS.warehouseAddress || SL_CONFIG.companyPostcode || origin;
  var svc = new google.maps.DistanceMatrixService();

  // Build origins/destinations: outward always; return leg if requested
  var origs = [origin];
  var dests = [destination];
  if (addReturn) { origs.push(destination); dests.push(wh); }

  svc.getDistanceMatrix({
    origins: origs, destinations: dests,
    travelMode: google.maps.TravelMode.DRIVING,
    unitSystem: google.maps.UnitSystem.IMPERIAL,
  }, function(resp, status) {
    if (status !== 'OK') { cb(null); return; }
    try {
      var outM = resp.rows[0].elements[0].distance.value; // metres
      var outMiles = Math.round(outM / 1609.34);
      var retMiles = 0;
      if (addReturn && resp.rows.length > 1 && resp.rows[1].elements[1]) {
        retMiles = Math.round(resp.rows[1].elements[1].distance.value / 1609.34);
      }
      cb({ outMiles: outMiles, retMiles: retMiles, totalMiles: outMiles + retMiles });
    } catch(e) { cb(null); }
  });
}

// Multi-stop journey distance (array of addresses)
function calcJourneyDistance(stops, addReturn, cb) {
  if (stops.length < 2) { cb(null); return; }
  if (!mapsApiLoaded()) { cb(null); return; }

  var wh = APP_SETTINGS.warehouseAddress || SL_CONFIG.companyPostcode;
  var allStops = stops.slice();
  if (addReturn && wh) allStops.push(wh);

  var svc = new google.maps.DistanceMatrixService();
  // Build pairwise: stops[0]→stops[1], stops[1]→stops[2], etc.
  var origs = allStops.slice(0, allStops.length - 1);
  var dests2 = allStops.slice(1);

  svc.getDistanceMatrix({
    origins: origs, destinations: dests2,
    travelMode: google.maps.TravelMode.DRIVING,
    unitSystem: google.maps.UnitSystem.IMPERIAL,
  }, function(resp, status) {
    if (status !== 'OK') { cb(null); return; }
    try {
      var legs = [];
      var total = 0;
      for (var i = 0; i < origs.length; i++) {
        // diagonal: row i, element i
        var el2 = resp.rows[i] && resp.rows[i].elements[i];
        var m = el2 ? Math.round(el2.distance.value / 1609.34) : 0;
        legs.push({ from: origs[i], to: dests2[i], miles: m });
        total += m;
      }
      cb({ legs: legs, totalMiles: total });
    } catch(e) { cb(null); }
  });
}

// ── Auto-bind address fields whenever a panel opens ────────────────────
function bindPanelAddressFields() {
  var pb = el('p-body');
  if (!pb) return;

  // Job form: origin
  var forEl = pb.querySelector('#for');
  var fdeEl = pb.querySelector('#fde');
  var fmiEl = pb.querySelector('#fmi');

  if (forEl && !forEl._addrBound) {
    bindAddressField(forEl, {
      showDist: true,
      fromFn: function(){ return APP_SETTINGS.warehouseAddress || SL_CONFIG.companyPostcode || ''; },
      onCalc: function(miles){ if(fmiEl){ fmiEl.value=miles; } }
    });
  }
  if (fdeEl && !fdeEl._addrBound) {
    bindAddressField(fdeEl, {
      showDist: true,
      fromFn: function(){ return (forEl ? forEl.value.trim() : '') || APP_SETTINGS.warehouseAddress || ''; },
      onCalc: function(miles){ if(fmiEl){ fmiEl.value=miles; } }
    });
  }

  // Booking configurator origin/dest
  var bkOrig = pb.querySelector('#bk-origin');
  var bkDest = pb.querySelector('#bk-dest');
  if (bkOrig && !bkOrig._addrBound) bindAddressField(bkOrig);
  if (bkDest && !bkDest._addrBound) {
    bindAddressField(bkDest, {
      showDist: true,
      fromFn: function(){ return (bkOrig ? bkOrig.value.trim() : '') || APP_SETTINGS.warehouseAddress || ''; }
    });
  }

  // Warehouse goods-in dest, goods-out dest, book-delivery dest
  ['tp-dest','tpo-dest','wbd-dest'].forEach(function(id) {
    var el3 = pb.querySelector('#'+id);
    if (el3 && !el3._addrBound) bindAddressField(el3);
  });

  // Warehouse address field in settings
  var cosWh = pb.querySelector('#cos-wh-addr');
  if (cosWh && !cosWh._addrBound) bindAddressField(cosWh);
}

// Patch openPanel to wire address fields after render
(function(){
  var _orig = openPanel;
  openPanel = function(){
    _orig();
    setTimeout(bindPanelAddressFields, 80);
  };
})();

// Also wire settings page address fields on render
(function(){
  var _orig = renderSettings;
  renderSettings = function(){
    _orig();
    setTimeout(function(){
      var sb = el('settings-body');
      if (!sb) return;
      var cosWh = sb.querySelector('#cos-wh-addr');
      if (cosWh && !cosWh._addrBound) bindAddressField(cosWh);
    }, 80);
  };
})();

// Init Maps if key already set at page load
if (APP_SETTINGS.googleMapsKey) loadGoogleMapsAPI();
// Restore dismissed alerts
if (APP_SETTINGS.dismissedAlerts) dismissedAlerts = APP_SETTINGS.dismissedAlerts;

// ══════════════════════════════════════════════════════════════════════════
// ENHANCED COS — per-crew overhead + return mileage helpers
// ══════════════════════════════════════════════════════════════════════════

// COS overhead: crew_count × days × rate per day
function bkCosOverhead(bk) {
  var j = jobs.filter(function(x){return x.id===bk.id;})[0];
  if (!j) return 0;
  var crewCount = (j.drivers||[]).concat(j.porters||[]).filter(Boolean).length;
  var dur = Math.max(1, Math.round((s2d(bk.endDate)-s2d(bk.startDate))/864e5)+1);
  return crewCount * dur * (APP_SETTINGS.cosPerCrewPerDay||125);
}

// Return mileage fuel cost: only for same-day jobs (no overnight)
// Uses the same vehicle mileage rate as the outward journey
function bkReturnFuelCost(bk) {
  if (!APP_SETTINGS.returnMileage) return 0;
  var j = jobs.filter(function(x){return x.id===bk.id;})[0];
  if (!j) return 0;
  // Multi-day = overnight, crew stays — no return leg
  var dur = Math.max(1, Math.round((s2d(bk.endDate)-s2d(bk.startDate))/864e5)+1);
  if (dur > 1) return 0;
  var miles = j.mileage || 0;
  if (!miles) return 0;
  // Best vehicle mileage rate
  var rate = 0;
  var vids = j.veh || [];
  for (var i=0; i<vids.length; i++) {
    for (var v=0; v<VEHICLES.length; v++) {
      if (VEHICLES[v].reg===vids[i] || VEHICLES[v].name===vids[i]) {
        rate = Math.max(rate, VEHICLES[v].mileRate||0);
        break;
      }
    }
  }
  if (!rate && VEHICLES.length) rate = VEHICLES[0].mileRate || 0;
  return Math.round(rate * miles * 100) / 100;
}

// Updated bkTotalCOS to include overhead + return fuel
function bkTotalCOSFull(bk) {
  return bkCrewCost(bk) + bkFuelCost(bk) + bkReturnFuelCost(bk)
       + bkVehicleCost(bk) + bkMaterialCost(bk) + bkChargeCost(bk)
       + bkCosOverhead(bk);
}

// ══════════════════════════════════════════════════════════════════════════
// AZURE TABLE STORAGE DATA LAYER
// All data persisted via /api/data Azure Function → Azure Table Storage
// ══════════════════════════════════════════════════════════════════════════

var API_BASE   = '/api/data';
var DB_READY   = false;
var DB_OFFLINE = false;

// ── LOCAL STORAGE FALLBACK ───────────────────────────────────────────────
var STORAGE_KEY = 'opsmanager_v1';

function lsSave() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      jobs:jobs, JOURNEYS:JOURNEYS, STORAGE_RECORDS:STORAGE_RECORDS,
      WH_ACTIVITIES:WH_ACTIVITIES, bookings:bookings,
      CREW:CREW, HOL:HOL, VEHICLES:VEHICLES, MATERIALS:MATERIALS,
      CHARGES:CHARGES, MOVE_MANAGERS:MOVE_MANAGERS, BRAND_DATA:BRAND_DATA,
      SL_CONFIG:SL_CONFIG, APP_SETTINGS:APP_SETTINGS,
      _saved: new Date().toISOString()
    }));
  } catch(e) {}
}

function lsLoad() {
  try {
    var raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    var d = JSON.parse(raw);
    if (d.jobs)            jobs            = d.jobs;
    if (d.JOURNEYS)        JOURNEYS        = d.JOURNEYS;
    if (d.STORAGE_RECORDS) STORAGE_RECORDS = d.STORAGE_RECORDS;
    if (d.WH_ACTIVITIES)   WH_ACTIVITIES   = d.WH_ACTIVITIES;
    if (d.bookings)        bookings        = d.bookings;
    if (d.CREW)            CREW            = d.CREW;
    if (d.HOL)             HOL             = d.HOL;
    if (d.VEHICLES)        VEHICLES        = d.VEHICLES;
    if (d.MATERIALS)       MATERIALS       = d.MATERIALS;
    if (d.CHARGES)         CHARGES         = d.CHARGES;
    if (d.MOVE_MANAGERS)   MOVE_MANAGERS   = d.MOVE_MANAGERS;
    if (d.BRAND_DATA)      { BRAND_DATA = d.BRAND_DATA; BC = {}; BRAND_DATA.forEach(function(b){ BC[b.name]=b.color; }); }
    if (d.SL_CONFIG)       SL_CONFIG       = d.SL_CONFIG;
    if (d.APP_SETTINGS)    APP_SETTINGS    = d.APP_SETTINGS;
    return true;
  } catch(e) { return false; }
}

// ── AZURE TABLE STORAGE API HELPERS ─────────────────────────────────────

function apiGet(table, cb) {
  fetch(API_BASE + '?table=' + table, {
    credentials: 'include'
  })
  .then(function(r) {
    if (!r.ok) throw new Error('API error: ' + r.status);
    return r.json();
  })
  .then(function(items) { cb(null, items); })
  .catch(function(e) { cb(e, []); });
}

function apiPost(table, item, cb) {
  fetch(API_BASE + '?table=' + table, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify(item)
  })
  .then(function(r) {
    if (!r.ok) throw new Error('API error: ' + r.status);
    return r.json();
  })
  .then(function(d) { if(cb) cb(null, d); })
  .catch(function(e) { if(cb) cb(e); });
}

function apiDelete(table, id, cb) {
  fetch(API_BASE + '?table=' + table + '&id=' + encodeURIComponent(id), {
    method: 'DELETE',
    credentials: 'include'
  })
  .then(function(r) {
    if (!r.ok) throw new Error('API error: ' + r.status);
    return r.json();
  })
  .then(function(d) { if(cb) cb(null, d); })
  .catch(function(e) { if(cb) cb(e); });
}

// ── TABLE NAME MAP ───────────────────────────────────────────────────────
var TABLE_MAP = {
  job:      'OpsJobs',
  journey:  'OpsJourneys',
  storage:  'OpsStorage',
  booking:  'OpsBookings',
  survey:   'OpsSurveys',
  wh:       'OpsWHActivities',
  settings: 'OpsSettings'
};

// ── LOAD ALL DATA FROM AZURE ─────────────────────────────────────────────
function dbInit(cb) {
  // Check API is reachable
  fetch(API_BASE + '?table=OpsJobs', { credentials: 'include' })
  .then(function(r) {
    if (!r.ok) throw new Error('API unreachable: ' + r.status);
    return r.json();
  })
  .then(function(items) {
    DB_READY = true;

    // Parse items helper
    function parse(items) {
      return items.map(function(item) {
        try { return JSON.parse(item.data); } catch(e) { return null; }
      }).filter(Boolean);
    }

    // Load all tables in parallel
    var loaded = 0;
    var total  = 7;

    function done() {
      if (++loaded < total) return;
      lsSave(); // mirror to localStorage as offline backup
      if(cb) cb(null);
    }

    // Jobs
    if (items.length) jobs = parse(items);
    done(); // jobs already loaded from first check

    apiGet('OpsJourneys', function(err, r) {
      if (!err && r.length) JOURNEYS = parse(r);
      done();
    });
    apiGet('OpsStorage', function(err, r) {
      if (!err && r.length) STORAGE_RECORDS = parse(r);
      done();
    });
    apiGet('OpsBookings', function(err, r) {
      if (!err && r.length) bookings = parse(r);
      done();
    });
    apiGet('OpsWHActivities', function(err, r) {
      if (!err && r.length) WH_ACTIVITIES = parse(r);
      done();
    });
    apiGet('OpsSurveys', function(err, r) {
      if (!err && r.length) SURVEYS = parse(r);
      done();
    });
    apiGet('OpsSettings', function(err, r) {
      if (!err && r.length) {
        var s = parse(r)[0];
        if (s) {
          if (s.CREW)         CREW         = s.CREW;
          if (s.HOL)          HOL          = s.HOL;
          if (s.VEHICLES)     VEHICLES     = s.VEHICLES;
          if (s.MATERIALS)    MATERIALS    = s.MATERIALS;
          if (s.CHARGES)      CHARGES      = s.CHARGES;
          if (s.MOVE_MANAGERS) MOVE_MANAGERS = s.MOVE_MANAGERS;
          if (s.BRAND_DATA)   { BRAND_DATA = s.BRAND_DATA; BC = {}; BRAND_DATA.forEach(function(b){ BC[b.name]=b.color; }); }
          if (s.SL_CONFIG)    SL_CONFIG    = s.SL_CONFIG;
          if (s.APP_SETTINGS) {
            APP_SETTINGS = s.APP_SETTINGS;
            if (APP_SETTINGS.dismissedAlerts) dismissedAlerts = APP_SETTINGS.dismissedAlerts;
            if (APP_SETTINGS.googleMapsKey) loadGoogleMapsAPI();
          }
        }
      }
      done();
    });
  })
  .catch(function(e) {
    DB_OFFLINE = true;
    console.warn('Azure API unreachable, using localStorage:', e.message);
    lsLoad();
    if(cb) cb(null);
  });
}

// ── UNIFIED SAVE ─────────────────────────────────────────────────────────
function saveData(type, id, obj) {
  lsSave(); // always mirror to localStorage instantly

  if (DB_OFFLINE || !DB_READY) return;
  if (!type) return;

  if (type === 'settings') {
    var settings = {
      id: 'APP_SETTINGS_V1',
      CREW:CREW, HOL:HOL, VEHICLES:VEHICLES, MATERIALS:MATERIALS,
      CHARGES:CHARGES, MOVE_MANAGERS:MOVE_MANAGERS, BRAND_DATA:BRAND_DATA,
      SL_CONFIG:SL_CONFIG, APP_SETTINGS:APP_SETTINGS
    };
    apiPost(TABLE_MAP.settings, settings);
    return;
  }

  var table = TABLE_MAP[type];
  if (!table || !id || !obj) return;
  apiPost(table, obj);
}

function deleteData(type, id) {
  lsSave();
  if (DB_OFFLINE || !DB_READY || !type || !id) return;
  var table = TABLE_MAP[type];
  if (!table) return;
  apiDelete(table, id);
}

// ── EXPORT / IMPORT BACKUP ───────────────────────────────────────────────
function exportDataBackup() {
  try {
    var payload = {
      jobs:jobs, JOURNEYS:JOURNEYS, STORAGE_RECORDS:STORAGE_RECORDS,
      WH_ACTIVITIES:WH_ACTIVITIES, bookings:bookings, CREW:CREW, HOL:HOL,
      VEHICLES:VEHICLES, MATERIALS:MATERIALS, CHARGES:CHARGES,
      MOVE_MANAGERS:MOVE_MANAGERS, BRAND_DATA:BRAND_DATA,
      SL_CONFIG:SL_CONFIG, APP_SETTINGS:APP_SETTINGS,
      _exported: new Date().toISOString(), _version: 'v1'
    };
    var blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'opsmanager-backup-' + new Date().toISOString().substring(0,10) + '.json';
    a.click();
    toast('Backup exported');
  } catch(e) { toast('Export failed: ' + e.message); }
}

function importDataBackup() {
  var inp = document.createElement('input');
  inp.type = 'file'; inp.accept = '.json,application/json';
  inp.onchange = function() {
    var file = inp.files[0]; if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
      try {
        var d = JSON.parse(ev.target.result);
        if (!d.jobs) { toast('Invalid backup file'); return; }
        if (!confirm('Import will replace ALL current data. Continue?')) return;
        if (d.jobs)            jobs            = d.jobs;
        if (d.JOURNEYS)        JOURNEYS        = d.JOURNEYS;
        if (d.STORAGE_RECORDS) STORAGE_RECORDS = d.STORAGE_RECORDS;
        if (d.WH_ACTIVITIES)   WH_ACTIVITIES   = d.WH_ACTIVITIES;
        if (d.bookings)        bookings        = d.bookings;
        if (d.CREW)            CREW            = d.CREW;
        if (d.HOL)             HOL             = d.HOL;
        if (d.VEHICLES)        VEHICLES        = d.VEHICLES;
        if (d.MATERIALS)       MATERIALS       = d.MATERIALS;
        if (d.CHARGES)         CHARGES         = d.CHARGES;
        if (d.MOVE_MANAGERS)   MOVE_MANAGERS   = d.MOVE_MANAGERS;
        if (d.BRAND_DATA)      { BRAND_DATA = d.BRAND_DATA; BC = {}; BRAND_DATA.forEach(function(b){ BC[b.name]=b.color; }); }
        if (d.SL_CONFIG)       SL_CONFIG       = d.SL_CONFIG;
        if (d.APP_SETTINGS)    APP_SETTINGS    = d.APP_SETTINGS;
        lsSave();
        if (DB_READY && !DB_OFFLINE) {
          toast('Importing to Azure...');
          var all = jobs.concat(JOURNEYS).concat(STORAGE_RECORDS).concat(bookings).concat(WH_ACTIVITIES);
          var typeMap = {};
          jobs.forEach(function(x){ typeMap[x.id]='job'; });
          JOURNEYS.forEach(function(x){ typeMap[x.id]='journey'; });
          STORAGE_RECORDS.forEach(function(x){ typeMap[x.id]='storage'; });
          bookings.forEach(function(x){ typeMap[x.id]='booking'; });
          WH_ACTIVITIES.forEach(function(x){ typeMap[x.id]='wh'; });
          all.forEach(function(item){ saveData(typeMap[item.id], item.id, item); });
          saveData('settings');
          setTimeout(function(){ toast('Import complete ✓'); renderCal(); }, 1500);
        } else {
          toast('Import complete ✓ (offline mode)');
          renderCal();
        }
      } catch(e) { toast('Import failed: ' + e.message); }
    };
    reader.readAsText(file);
  };
  inp.click();
}

function importOPSPlan() {
  var inp = document.createElement('input');
  inp.type = 'file'; inp.accept = '.csv,text/csv';
  inp.onchange = function() {
    var file = inp.files[0]; if (!file) return;
    var status = document.getElementById('csv-import-status');
    if (status) status.textContent = 'Reading file...';
    var reader = new FileReader();
    reader.onload = function(ev) {
      try {
        var text = ev.target.result;
        var parsed = parseOPSPlanCSV(text);
        if (!parsed.length) { toast('No jobs found in file'); if(status) status.textContent = 'No jobs found.'; return; }
        if (!confirm('Import ' + parsed.length + ' jobs from OPS Plan?\n\nExisting jobs with matching refs will be skipped.')) return;

        // Check for duplicates
        var existingRefs = {};
        for (var i = 0; i < jobs.length; i++) existingRefs[jobs[i].ref] = true;

        var added = 0, skipped = 0;
        for (var j = 0; j < parsed.length; j++) {
          var job = parsed[j];
          if (existingRefs[job.ref]) { skipped++; continue; }
          // Generate unique ID
          job.id = 'IMP' + Date.now() + '_' + j;
          jobs.push(job);
          saveData('job', job.id, job);
          added++;
        }

        setBadge('job-badge', jobs.length);
        renderCal();
        var msg = added + ' jobs imported' + (skipped ? ', ' + skipped + ' skipped (duplicate refs)' : '') + ' ✓';
        toast(msg);
        if (status) status.textContent = msg;
      } catch(e) {
        toast('Import failed: ' + e.message);
        if (status) status.textContent = 'Error: ' + e.message;
      }
    };
    reader.readAsText(file, 'latin1');
  };
  inp.click();
}

function parseOPSPlanCSV(text) {
  // Parse the weekly OPS Plan CSV format
  var lines = text.split('\n');
  var jobs = [];
  var currentDate = null;
  var seqOnDay = {};

  function cleanMoney(v) {
    if (!v) return 0;
    v = String(v).replace(/[£,"]/g,'').trim();
    return parseFloat(v) || 0;
  }

  function parseDate(header) {
    var months = {JANUARY:'01',FEBRUARY:'02',MARCH:'03',APRIL:'04',MAY:'05',JUNE:'06',
                  JULY:'07',AUGUST:'08',SEPTEMBER:'09',OCTOBER:'10',NOVEMBER:'11',DECEMBER:'12'};
    var m = header.toUpperCase().match(/(\d+)(?:ST|ND|RD|TH)?\s+(\w+)(?:\s+(\d{4}))?/);
    if (!m) return null;
    var day = m[1].padStart(2,'0');
    var mon = months[m[2]] || '01';
    var yr  = m[3] || '2025';
    return yr + '-' + mon + '-' + day;
  }

  function parseCSVLine(line) {
    var result = [], current = '', inQuotes = false;
    for (var i = 0; i < line.length; i++) {
      var c = line[i];
      if (c === '"') { inQuotes = !inQuotes; }
      else if (c === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
      else { current += c; }
    }
    result.push(current.trim());
    return result;
  }

  function parseCrew(s) {
    if (!s) return [];
    return s.split(/[,\/&]/).map(function(x){ return x.replace(/£\d+/,'').trim().toUpperCase(); }).filter(Boolean);
  }

  for (var li = 0; li < lines.length; li++) {
    var row = parseCSVLine(lines[li]);
    while (row.length < 65) row.push('');

    // Day header
    if (row[1] && row[1].toUpperCase().indexOf('OPS PLAN') >= 0) {
      currentDate = parseDate(row[1]);
      continue;
    }
    // Skip header/summary/empty rows
    if (!row[1] || !row[2]) continue;
    if (row[0] === 'SERVICE' || row[0] === 'TOTALS') continue;

    var brand  = row[1].trim();
    var client = row[2].trim();
    if (!brand || !client) continue;

    // Skip non-job rows
    var skip = ['WAREHOUSE','DAYLE OFF','MARTYN 2PM','SKYPE','OCVS DROP','ANYVAN','DAYLE OFF'];
    var isSkip = false;
    for (var si = 0; si < skip.length; si++) {
      if (client.toUpperCase().indexOf(skip[si]) >= 0) { isSkip = true; break; }
    }
    if (isSkip) continue;

    var origin   = row[3].trim();
    var dest     = row[4].trim();
    var volCbft  = parseFloat(row[5]) || 0;
    var vehicles = row[9].trim();
    var drivers  = parseCrew(row[10]);
    var porters  = parseCrew(row[11]);
    var ref      = row[14].trim();
    var cbm      = parseFloat(row[15]) || Math.round(volCbft * 0.02832 * 100) / 100;
    var moveMgr  = row[16].trim();
    var miles    = parseFloat(row[17]) || 0;

    // Billing pairs cols 29-50
    var billing = [];
    for (var bc = 29; bc <= 49; bc += 2) {
      var item = row[bc] ? row[bc].trim() : '';
      var amt  = cleanMoney(row[bc+1]);
      if (item && amt > 0) billing.push({ item: item, amt: amt });
    }

    var total  = cleanMoney(row[52]) || cleanMoney(row[62]) || billing.reduce(function(s,b){ return s+b.amt; }, 0);
    var margin = row[63] ? row[63].replace('%','').trim() : '';

    var status = 'Completed';
    if (total > 0 && margin === '100') status = 'Billed';
    else if (total > 0) status = 'Billed';

    var channel  = (brand==='MOVESQUAD'||brand==='BTR'||brand==='ECKERSLEYS') ? 'Account' : 'Partner';
    var jobType  = 'Door to Door';
    if (origin.toUpperCase().indexOf('STORE') >= 0 && dest.toUpperCase().indexOf('STORE') < 0) jobType = 'Delivery';
    else if (dest.toUpperCase().indexOf('STORE') >= 0) jobType = 'Collection';
    if (origin.toUpperCase().indexOf('CONTAINER') >= 0 || origin.toUpperCase().indexOf('ACCESSING') >= 0) jobType = 'Other';

    var ds = currentDate || '2025-01-01';
    seqOnDay[ds] = (seqOnDay[ds] || 0) + 1;

    jobs.push({
      id:          '', // set on import
      ref:         ref || ('IMP-' + brand + '-' + client.substring(0,10)).replace(/\s+/g,'-'),
      brand:       brand,
      channel:     channel,
      jobType:     jobType,
      clientRef:   '',
      moveManager: moveMgr,
      client:      client,
      origin:      origin,
      dest:        dest,
      start:       ds,
      end:         ds,
      vol:         volCbft,
      cbm:         cbm,
      drivers:     drivers,
      porters:     porters,
      mileage:     miles,
      veh:         vehicles ? vehicles.split(',').map(function(v){ return v.trim(); }).filter(Boolean) : [],
      status:      status,
      billing:     billing,
      notes:       '',
      journeyId:   '',
      storageId:   '',
      seqInDay:    seqOnDay[ds],
      materials:   []
    });
  }
  return jobs;
}

function quickStatusMenu(e, jobId) {
  e.preventDefault();
  e.stopPropagation();
  // Remove any existing menu
  var ex = document.getElementById('ctx-menu');
  if (ex) ex.parentNode.removeChild(ex);

  var statuses = [
    {label:'Pending',     col:'#FF9F00'},
    {label:'Confirmed',   col:'#0073EA'},
    {label:'In Progress', col:'#A25DDC'},
    {label:'Completed',   col:'#00C875'},
    {label:'Billed',      col:'#00C875'},
    {label:'Cancelled',   col:'#E44258'},
  ];

  var menu = document.createElement('div');
  menu.id = 'ctx-menu';
  menu.className = 'ctx-menu';
  menu.style.left = Math.min(e.clientX, window.innerWidth - 180) + 'px';
  menu.style.top  = Math.min(e.clientY, window.innerHeight - 220) + 'px';

  var j = jobs.filter(function(x){ return x.id === jobId; })[0];
  if (!j) return;

  // Header
  var hdr = document.createElement('div');
  hdr.style.cssText = 'padding:6px 14px 4px;font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--b1);margin-bottom:4px';
  hdr.textContent = 'Set Status';
  menu.appendChild(hdr);

  statuses.forEach(function(s) {
    var item = document.createElement('div');
    item.className = 'ctx-item';
    if (j.status === s.label) item.style.fontWeight = '700';
    item.innerHTML = '<div class="ctx-dot" style="background:'+s.col+'"></div>' + s.label +
      (j.status === s.label ? ' <span style="margin-left:auto;color:var(--green)">✓</span>' : '');
    item.onclick = function() {
      j.status = s.label;
      saveData('job', j.id, j);
      closeCtxMenu();
      renderActiveMod();
      toast(j.client + ' → ' + s.label);
    };
    menu.appendChild(item);
  });

  document.body.appendChild(menu);
  setTimeout(function(){ document.addEventListener('click', closeCtxMenu, {once:true}); }, 10);
}

function closeCtxMenu() {
  var m = document.getElementById('ctx-menu');
  if (m) m.parentNode.removeChild(m);
}

function clearData() {
  if (!confirm('Reset ALL data to factory defaults?\n\nThis will clear local storage AND Azure database. Cannot be undone.')) return;
  localStorage.removeItem(STORAGE_KEY);
  if (DB_READY && !DB_OFFLINE) {
    toast('Clearing database...');
    var tables = ['OpsJobs','OpsJourneys','OpsStorage','OpsBookings','OpsWHActivities','OpsSettings'];
    tables.forEach(function(table) {
      apiGet(table, function(err, items) {
        if (err || !items.length) return;
        items.forEach(function(item) { apiDelete(table, item.rowKey || item.id); });
      });
    });
    setTimeout(function(){ location.reload(); }, 2000);
  } else {
    location.reload();
  }
}

// ── STARTUP ──────────────────────────────────────────────────────────────
(function() {
  var overlay = document.createElement('div');
  overlay.id = 'db-loading';
  overlay.innerHTML = '<div style="text-align:center"><div style="font-size:32px;margin-bottom:12px">📦</div><div style="font-weight:700;font-size:15px;color:#1C2333;margin-bottom:6px">Loading OPS Manager</div><div style="font-size:12px;color:#7A849E">Connecting to database...</div></div>';
  overlay.style.cssText = 'position:fixed;inset:0;background:#f9ecec;display:flex;align-items:center;justify-content:center;z-index:99999;font-family:Inter,sans-serif';
  document.body.appendChild(overlay);

  dbInit(function() {
    var el2 = document.getElementById('db-loading');
    if (el2) el2.parentNode.removeChild(el2);

    renderDashboard();
    renderBkList();
    setBadge('job-badge', jobs.length);

    if (DB_READY && !DB_OFFLINE) {
      setTimeout(function(){ toast('Connected ✓'); }, 400);
    } else {
      setTimeout(function(){ toast('Offline mode — local data only'); }, 400);
    }
  });
})();

// Belt-and-suspenders: save to localStorage on unload
window.addEventListener('beforeunload', lsSave);



</script>

  <!-- Survey Modal -->
  <div id="survey-backdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:600;align-items:center;justify-content:center">
    <div id="survey-modal" style="background:var(--w);border-radius:12px;width:520px;max-width:95vw;max-height:90vh;overflow:auto;box-shadow:0 8px 40px rgba(0,0,0,.22)">
      <div style="padding:18px 20px 14px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-weight:700;font-size:15px" id="survey-modal-title">New Survey</div>
          <div style="font-size:11.5px;color:var(--t3);margin-top:2px" id="survey-modal-ref"></div>
        </div>
        <button onclick="closeSurveyModal()" style="background:none;border:none;font-size:20px;color:var(--t3);cursor:pointer;line-height:1">&#10005;</button>
      </div>
      <div style="padding:18px 20px" id="survey-form-body"></div>
      <div style="padding:12px 20px 18px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--b1)">
        <button class="btn btn-s btn-sm" onclick="closeSurveyModal()">Cancel</button>
        <button class="btn btn-p btn-sm" onclick="saveSurvey()">Save Survey</button>
      </div>
    </div>
  </div>
</body>
</html><div class="page" id="mod-dashboard">
      <div style="flex:1;overflow:auto;padding:20px" id="dashboard-body"></div>
    </div>
    
